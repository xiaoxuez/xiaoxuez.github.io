<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="以太坊智能合约从智能合约的代码到使用智能合约，大概包含以下步骤  编写智能合约的代码(一般是用Solidity) 编译智能合约的代码变成可在EVM上执行的bytecode(binary code)，同时可以通过编译取得智能合约的ABI 部署智能合约，实际上是吧bytecode存储在链上(通过一个transaction)，并取得一个专属于这个合约的地址 要调用合约，需要把信息发送到这个合约的地址，一">
<meta property="og:type" content="article">
<meta property="og:title" content="eth_contract">
<meta property="og:url" content="https://github.com/xiaoxuez/2019/10/14/eth-contract/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="以太坊智能合约从智能合约的代码到使用智能合约，大概包含以下步骤  编写智能合约的代码(一般是用Solidity) 编译智能合约的代码变成可在EVM上执行的bytecode(binary code)，同时可以通过编译取得智能合约的ABI 部署智能合约，实际上是吧bytecode存储在链上(通过一个transaction)，并取得一个专属于这个合约的地址 要调用合约，需要把信息发送到这个合约的地址，一">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-12-17T07:30:11.820Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="eth_contract">
<meta name="twitter:description" content="以太坊智能合约从智能合约的代码到使用智能合约，大概包含以下步骤  编写智能合约的代码(一般是用Solidity) 编译智能合约的代码变成可在EVM上执行的bytecode(binary code)，同时可以通过编译取得智能合约的ABI 部署智能合约，实际上是吧bytecode存储在链上(通过一个transaction)，并取得一个专属于这个合约的地址 要调用合约，需要把信息发送到这个合约的地址，一">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>eth_contract</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/10/14/eth-casper/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/10/14/eth/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://github.com/xiaoxuez/2019/10/14/eth-contract/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&text=eth_contract"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&is_video=false&description=eth_contract"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=eth_contract&body=Check out this article: https://github.com/xiaoxuez/2019/10/14/eth-contract/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&name=eth_contract&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#以太坊智能合约"><span class="toc-number">1.</span> <span class="toc-text">以太坊智能合约</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码编写及编译部署"><span class="toc-number">1.0.1.</span> <span class="toc-text">代码编写及编译部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#智能合约ABI"><span class="toc-number">1.0.2.</span> <span class="toc-text">智能合约ABI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Function"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">Function</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Event"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">Event</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#示例"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3"><span class="toc-number">1.1.</span> <span class="toc-text">web3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Event-1"><span class="toc-number">1.1.1.</span> <span class="toc-text">Event</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Remix"><span class="toc-number">1.1.2.</span> <span class="toc-text">Remix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bytes32、string"><span class="toc-number">1.1.3.</span> <span class="toc-text">bytes32、string</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#钱💰💰💰💰"><span class="toc-number">1.1.4.</span> <span class="toc-text">钱💰💰💰💰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#合约交互"><span class="toc-number">1.1.5.</span> <span class="toc-text">合约交互</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapping"><span class="toc-number">1.1.6.</span> <span class="toc-text">mapping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#以太坊虚拟机-EVM"><span class="toc-number">1.1.7.</span> <span class="toc-text">以太坊虚拟机(EVM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#账户"><span class="toc-number">1.1.8.</span> <span class="toc-text">账户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#交易"><span class="toc-number">1.1.9.</span> <span class="toc-text">交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gas"><span class="toc-number">1.1.10.</span> <span class="toc-text">gas</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storage-memory-stack"><span class="toc-number">1.1.11.</span> <span class="toc-text">storage,memory,stack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#指令集合"><span class="toc-number">1.1.12.</span> <span class="toc-text">指令集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消息调用"><span class="toc-number">1.1.13.</span> <span class="toc-text">消息调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代理调用-调用代码和库"><span class="toc-number">1.1.14.</span> <span class="toc-text">代理调用/调用代码和库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#日志"><span class="toc-number">1.1.15.</span> <span class="toc-text">日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Create"><span class="toc-number">1.1.16.</span> <span class="toc-text">Create</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        eth_contract
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-10-14T14:51:05.000Z" itemprop="datePublished">2019-10-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/eth/">eth</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="以太坊智能合约"><a href="#以太坊智能合约" class="headerlink" title="以太坊智能合约"></a>以太坊智能合约</h2><p>从智能合约的代码到使用智能合约，大概包含以下步骤</p>
<ul>
<li>编写智能合约的代码(一般是用Solidity)</li>
<li>编译智能合约的代码变成可在EVM上执行的bytecode(binary code)，同时可以通过编译取得智能合约的ABI</li>
<li>部署智能合约，实际上是吧bytecode存储在链上(通过一个transaction)，并取得一个专属于这个合约的地址</li>
<li>要调用合约，需要把信息发送到这个合约的地址，一样也是通过transaction，以太坊节点会根据输入的信息，选择要执行合约中的哪一个function和要输入的参数</li>
</ul>
<p>以下，将详细介绍以上步骤。</p>
<h4 id="代码编写及编译部署"><a href="#代码编写及编译部署" class="headerlink" title="代码编写及编译部署"></a>代码编写及编译部署</h4><h4 id="智能合约ABI"><a href="#智能合约ABI" class="headerlink" title="智能合约ABI"></a>智能合约ABI</h4><p>如果说api，想必都知道是什么，对应的，ABI，application binary interface，顾名思义，同样是接口，但传递的是binary格式的信息。</p>
<p>ABI理解如下</p>
<h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><ul>
<li><code>name</code>：a string, 方法名</li>
<li><code>type</code>:  a string，”function”, “constructor”, or “fallback”，方法类型</li>
<li><code>inputs</code>:  an array，方法参数，每个参数的格式为<ul>
<li><code>name</code>：a string，参数名</li>
<li><code>type</code>：a string，参数的 data type(e.g. uint256)</li>
<li><code>components</code>：an array，如果输入的参数是 tuple(struct) type 才会有这个参数。描述 struct 中包含的参数类型</li>
</ul>
</li>
<li><code>outputs</code>：an array， 方法返回值，和 <code>inputs</code> 使用相同表示方式。如果沒有返回值可忽略，值为 <code>[]</code></li>
<li><code>payable</code>：<code>true</code>，function 是否可收 Ether，预设为 <code>false</code></li>
<li><code>constant</code>：<code>true</code>，function 是否会改写区块链状态，反之为 <code>false</code></li>
<li><code>stateMutability</code>：a string，其值可能为以下其中之一：”pure”（不会读写区块链状态）、”view”（只读不写区块链状态）、”payable” and “nonpayable”（会改区块链状态，且如可收 Ether 为 “payable”，反之为 “nonpayable”）</li>
</ul>
<p>仔细看会发现 <code>payable</code> 和 <code>constant</code> 这两个参数所描述的內容，似乎已包含在 <code>stateMutability</code> 中。</p>
<h5 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h5><ul>
<li><code>name</code>: a string，event 的名称</li>
<li><code>type</code>: a string，always “event”</li>
<li><code>inputs</code>: an array，输入参数，包含：<ul>
<li><code>name</code>: a string，参数名称</li>
<li><code>type</code>: a string，参数的 data type(e.g. uint256)</li>
<li><code>components</code>: an array，如果输入参数是 tuple(struct) type 才会有这个参数。描述 struct 中包含的信息类型</li>
<li><code>indexed</code>: <code>true</code>，如果这个参数被定义为 indexed ，反之为 <code>false</code></li>
</ul>
</li>
<li><code>anonymous</code>: <code>true</code>，如果 event 被定义为 anonymous</li>
</ul>
<p>更新智能合约状态需要发送 transaction，transaction 需要等待验证，所以更新合约状态是非同步的，无法马上取得返回值。使用 Event 可以在状态更新成功后，将相关信息记录到 Log，并让监听这个 Event 的 DApp 或任何应用这个接口的程序收到通知。每笔 transaction 都有对应的 Log。</p>
<p>所以简单来说，Event 可用來：1. 取得 function 更新合约状态的返回值 2. 也可作为合约另外的存储空间。</p>
<p>Event 的参数分为：有 <code>indexed</code>，和其他没有 <code>indexed</code> 的。有 <code>indexed</code> 的参数可以使用 filter，例如同一个 Event，我可以选择只监听从特定 address 发出来的交易。每笔 Log 的信息同样分为两个部分：Topics（长度最多为 4 的 array） 和 Data。有 <code>anonymous</code> 的参数会存储存在 Log 的 Topics，其他的存在 Data。</p>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.20;</span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line">    uint public data;</span><br><span class="line">    event Set(address indexed _from, uint value);</span><br><span class="line">    function set(uint x) public &#123;</span><br><span class="line">        data = x;</span><br><span class="line">        Set(msg.sender, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的ABI接口为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[&#123;		//自动生成的方法名为data的只读方法，返回data值,&quot;stateMutabTility&quot;: &quot;view&quot;代表只读</span><br><span class="line">        &quot;constant&quot;: true,  </span><br><span class="line">        &quot;inputs&quot;: [],</span><br><span class="line">        &quot;name&quot;: &quot;data&quot;,</span><br><span class="line">        &quot;outputs&quot;: [&#123;&quot;name&quot;: &quot;&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class="line">        &quot;payable&quot;: false,</span><br><span class="line">        &quot;stateMutabTility&quot;: &quot;view&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;function&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;  //set方法， &quot;stateMutability&quot;: &quot;nonpayable&quot;,可写方法，但不可收Ether,方法参数为uint256类型</span><br><span class="line">        &quot;constant&quot;: false,</span><br><span class="line">        &quot;inputs&quot;: [&#123;&quot;name&quot;: &quot;x&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class="line">        &quot;name&quot;: &quot;set&quot;,</span><br><span class="line">        &quot;outputs&quot;: [],</span><br><span class="line">        &quot;payable&quot;: false,</span><br><span class="line">        &quot;stateMutability&quot;: &quot;nonpayable&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;function&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;anonymous&quot;: false,</span><br><span class="line">        &quot;inputs&quot;: [&#123;&quot;indexed&quot;: true,&quot;name&quot;: &quot;_from&quot;,&quot;type&quot;: &quot;address&quot;&#125;,&#123;&quot;indexed&quot;: false,&quot;name&quot;: &quot;value&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class="line">        &quot;name&quot;: &quot;Set&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;event&quot;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>event时间可监听，在web3使用时会有示例</p>
<h3 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h3><p>关于智能合约的调用，通过命令行也是可以的，但binary的拼凑有点繁琐，web3封装的接口调用起来就方便很多。</p>
<p>直接看例子吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract hello &#123;</span><br><span class="line">    function say() constant public returns (string) &#123;</span><br><span class="line">        return &quot;Hello World&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后部署到了服务器上，返回合约的地址为0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51</p>
<p>abi为编译产生的abi数组，直接复制粘贴即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var contract = web3.eth.contract(info.abi).at(&quot;0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51&quot;);</span><br><span class="line">var account_one = web3.eth.accounts[0];</span><br><span class="line">var result = contract.say(&#123;from: account_one&#125;)</span><br><span class="line">console.log(result); //Hello World</span><br></pre></td></tr></table></figure>

<p>一个简单的调用就成功了，然后再看contract提供的接口的具体情况。</p>
<p>智能合约方法调用方式有四种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//根据方法类型自动决定是使用call方式进行调用还是sendTransaction方式进行调用，call和sendTransaction的区别呢，如果方法是只读的，则不需要入链，直接调用即可，方法是可写的，则需要以交易的方法进行提交入链。参数中，param则是传入给方法的参数，后面添加别的参数</span><br><span class="line">myContractInstance.myMethod(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class="line"></span><br><span class="line">//精确使用call方式进行调用</span><br><span class="line">myContractInstance.myMethod.call(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class="line"></span><br><span class="line">//精确使用发送交易形式进行调用</span><br><span class="line">myContractInstance.myMethod.sendTransaction(param1 [, param2, ...] [, transactionObject] [, callback]);</span><br><span class="line"></span><br><span class="line">//没看明白</span><br><span class="line">// Get the call data, so you can call the contract through some other means</span><br><span class="line">// var myCallData = myContractInstance.myMethod.request(param1 [, param2, ...]);</span><br><span class="line">var myCallData = myContractInstance.myMethod.getData(param1 [, param2, ...]);</span><br><span class="line">// myCallData = &apos;0x45ff3ff6000000000004545345345345..&apos;</span><br></pre></td></tr></table></figure>

<p>然后，顺便玩一下event。</p>
<p>合约修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line">contract hello &#123;</span><br><span class="line">    string public greeting;</span><br><span class="line">    event Set(address indexed _from, string value);</span><br><span class="line"></span><br><span class="line">    function set(string g) public &#123;</span><br><span class="line">        greeting = g;</span><br><span class="line">        Set(msg.sender, g);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get() constant public returns (string) &#123;</span><br><span class="line">        return greeting;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后完整的调用脚本为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">var Web3 = require(&quot;web3&quot;);</span><br><span class="line">var web3 = new Web3();</span><br><span class="line">web3.setProvider(new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;));</span><br><span class="line">if (web3.isConnected()) &#123;</span><br><span class="line">  console.log(&quot;connection success!&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  console.log(&quot;fail to connection!&quot;);</span><br><span class="line">  return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var contract = web3.eth.contract(abi).at(address);</span><br><span class="line">var account_one = web3.eth.accounts[0];</span><br><span class="line">var my_event = contract.Set();</span><br><span class="line">var getStr = function() &#123;</span><br><span class="line">  var str = contract.greeting(&#123;from: account_one&#125;)</span><br><span class="line">  console.log(&quot;the str is: &quot; + str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getStr()</span><br><span class="line">my_event.watch(function(err, result) &#123;</span><br><span class="line">    if (!err) &#123;</span><br><span class="line">        console.log(result);</span><br><span class="line">        getStr()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    my_event.stopWatching();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">contract.set(&quot;I am Changed!&quot;,&#123;from: account_one&#125;)</span><br></pre></td></tr></table></figure>

<p>查看输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// connection success!</span><br><span class="line">// the str is:</span><br><span class="line">// &#123; address: &apos;0x8321a32f8b7bbc00a65c9e21df64948cf40bbeba&apos;,</span><br><span class="line">//   blockNumber: 785,</span><br><span class="line">//   transactionHash: &apos;0xa90e35845cd844907f251660bce78f5cde2c968876f3a6321fbf38589d7fb476&apos;,</span><br><span class="line">//   transactionIndex: 0,</span><br><span class="line">//   blockHash: &apos;0x742eecc3ae508b33ca5dde2ae2a32b8c0c87d321c6ab13a0cc8ad3909e579275&apos;,</span><br><span class="line">//   logIndex: 0,</span><br><span class="line">//   removed: false,</span><br><span class="line">//   event: &apos;Set&apos;,</span><br><span class="line">//   args:</span><br><span class="line">//    &#123; _from: &apos;0xc6e1feafcc44ebb1a7b0ecc06770566845eac7ac&apos;,</span><br><span class="line">//      value: &apos;I am Changed!&apos; &#125; &#125;</span><br><span class="line">// the str is: I am Changed!</span><br></pre></td></tr></table></figure>

<p>可以看到返回的结果中包括区块哈希等信息，还有参数</p>
<h4 id="Event-1"><a href="#Event-1" class="headerlink" title="Event"></a>Event</h4><p>在合约中定义事件，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event SendMsg(string sender, string receiver, string detail, address indexed reth);</span><br></pre></td></tr></table></figure>

<p>注意到indexed关键字。跟event订阅有一定的关系。</p>
<p>大致理解是，event事件犹如日志，在订阅的时候，需要确定要订阅的关键字，这个关键字可以是事件本身，也可以是某个可索引的值，如address值。如订阅某确定address值时，会取得所有含有可索引的这个地址相关的event事件。订阅事件本身的话，就只能取得这个事件的值。</p>
<p>顺便粘贴一段在web3j中event的使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public static void test() &#123;</span><br><span class="line">     Web3j web3j = Web3j.build(new HttpService(&quot;http://localhost:8545&quot;));</span><br><span class="line">     Event event = new Event(&quot;SendMsg&quot;,</span><br><span class="line">             Arrays.&lt;TypeReference&lt;?&gt;&gt;asList(</span><br><span class="line">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class="line">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class="line">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class="line">                     new TypeReference&lt;Address&gt;(true)&#123;&#125;</span><br><span class="line">             ));</span><br><span class="line">     EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST,</span><br><span class="line">             DefaultBlockParameterName.LATEST, &quot;0x495feebd99f645a43aa63edb32d46e057e44e286&quot;);</span><br><span class="line">     //订阅的是event事件本身</span><br><span class="line">     filter.addSingleTopic(EventEncoder.encode(event));</span><br><span class="line"></span><br><span class="line">     web3j.ethLogObservable(filter).subscribe(log -&gt; &#123;</span><br><span class="line">         System.out.println(log);</span><br><span class="line">         //data参数值，需要进行解码。</span><br><span class="line">         List&lt;Type&gt; results = FunctionReturnDecoder.decode(log.getData(), event.getNonIndexedParameters());</span><br><span class="line">         for (Type type : results) &#123;</span><br><span class="line">             System.out.println(type);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125;);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> //输出，例如，当前事件有 SendMsg(&quot;susan&quot;, &quot;tom&quot;, &quot;hi&quot;, &quot;0x11a857e4d069d963c0676c53b68e9d571a3e2b26&quot;)</span><br><span class="line"> //log输出为Log&#123;removed=false, logIndex=&apos;0x0&apos;, transactionIndex=&apos;0x0&apos;, transactionHash=&apos;0x31aa0a485f5595fb5b5c959e94dfb511c3512e94589dfd51205c5bd07c6ba4e2&apos;, blockHash=&apos;0xc68dcd25600857642199f9ebb354b62532f8468191a85ca923c0e03e958c6398&apos;, blockNumber=&apos;0x157c&apos;, address=&apos;0x495feebd99f645a43aa63edb32d46e057e44e286&apos;, data=&apos;...&apos;, type=&apos;null&apos;, topics=[0x444f124b164dc796e3a81a1d90ea60c96a815eac0a67ad1d3d550d30afda9e1f, 0x00000000000000000000000011a857e4d069d963c0676c53b68e9d571a3e2b26]</span><br><span class="line"> //topic为两个，第一个为SendMsg事件本身，第二个为SendMsg事件定义中含有可索引值address,</span><br><span class="line"> //data解码非索引项结果为susan、tom、hi</span><br></pre></td></tr></table></figure>

<h4 id="Remix"><a href="#Remix" class="headerlink" title="Remix"></a>Remix</h4><p>remix是基于浏览器开发的ide</p>
<ul>
<li><p>加载本地文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g remixd</span><br><span class="line">remixd -s &lt;absolute-path-to-the-shared-folder&gt;</span><br><span class="line">//会开启共享文件夹服务，通过ws</span><br></pre></td></tr></table></figure>

<p>然后在remix上点击类似于超链接的那个按钮</p>
</li>
</ul>
<h4 id="bytes32、string"><a href="#bytes32、string" class="headerlink" title="bytes32、string"></a>bytes32、string</h4><p>文档上是这么说的，bytes1 ~bytes32是长度特定的类型，故花费比string和bytes小。</p>
<p>然后记一下一般存pubkey(pubkey除掉0x长度为64，可以用两个bytes32来存)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bytes32 pubkey_half_pre;</span><br><span class="line">bytes32 pubkey_half_after;</span><br></pre></td></tr></table></figure>

<h4 id="钱💰💰💰💰"><a href="#钱💰💰💰💰" class="headerlink" title="钱💰💰💰💰"></a>钱💰💰💰💰</h4><p>合约部署之后生成合约地址，地址同样可以作为普通地址使用，即转账系列。可以给合约地址转账，见<a href="https://solidity-cn.readthedocs.io/zh/develop/contracts.html#fallback" target="_blank" rel="noopener">文档</a></p>
<p>需定义一个未命名、没有参数也没有返回值函数,且为payable。如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function () payable &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在ico中，转账给到合约地址，合约返回一定数量token给到转账者，就可以利用这个函数进行。</p>
<p>或者呢，合约的某方法如果使用了payable修饰的话，也代表这个方法可以接受ether, 即msg.value，钱会存到合约地址中，通过this.balance即可获取余额。</p>
<p>在合约中，向某地址发送ether, 使用address.transfer、address.send即可。</p>
<h4 id="合约交互"><a href="#合约交互" class="headerlink" title="合约交互"></a>合约交互</h4><p>现有一合约</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract UserTest &#123;</span><br><span class="line">    struct User &#123;</span><br><span class="line">        string name;</span><br><span class="line">        address addr;</span><br><span class="line">        string pubkey;</span><br><span class="line">        bool isValue;</span><br><span class="line">    &#125;</span><br><span class="line">    mapping(string =&gt; User)  users;</span><br><span class="line">    event UserChange(string uname, address addr, uint value);</span><br><span class="line"></span><br><span class="line">    function addUser(string uname, address addr, string pubkey)  public &#123;</span><br><span class="line">         require(</span><br><span class="line">           !users[uname].isValue,</span><br><span class="line">           &quot;name already exist&quot;</span><br><span class="line">       );</span><br><span class="line">       users[uname] = User(&#123;</span><br><span class="line">           name: uname,</span><br><span class="line">           addr: addr,</span><br><span class="line">           pubkey: pubkey,</span><br><span class="line">           isValue: true</span><br><span class="line">       &#125;);</span><br><span class="line">       UserChange(uname, addr, msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function userExist(string uname) constant external returns (bool) &#123;</span><br><span class="line">        return users[uname].isValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在另一合约中调用userExist方法,首先部署上述合约，合约地址如0x123456789</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract UserTest &#123;</span><br><span class="line">	//要调用的方法声明需要跟原来一样</span><br><span class="line">    function userExist(string uname) constant external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line">contract ExternalTest &#123;</span><br><span class="line"></span><br><span class="line">    address userInstance = 0x123456789;</span><br><span class="line">    UserTest user = UserTest(userInstance); //强制类型转换</span><br><span class="line"></span><br><span class="line">    function userCheck(string uname) public returns (bool)&#123;</span><br><span class="line">        return user.userExist(uname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="mapping"><a href="#mapping" class="headerlink" title="mapping"></a>mapping</h4><p>mapping是不能遍历的，需要借助别的数据结构。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">library IterableMapping</span><br><span class="line">&#123;</span><br><span class="line">  struct itmap</span><br><span class="line">  &#123;</span><br><span class="line">    mapping(uint =&gt; IndexValue) data;</span><br><span class="line">    KeyFlag[] keys;</span><br><span class="line">    uint size;</span><br><span class="line">  &#125;</span><br><span class="line">  struct IndexValue &#123; uint keyIndex; uint value; &#125;</span><br><span class="line">  struct KeyFlag &#123; uint key; bool deleted; &#125;</span><br><span class="line">  function insert(itmap storage self, uint key, uint value) returns (bool replaced)</span><br><span class="line">  &#123;</span><br><span class="line">    uint keyIndex = self.data[key].keyIndex;</span><br><span class="line">    self.data[key].value = value;</span><br><span class="line">    if (keyIndex &gt; 0)</span><br><span class="line">      return true;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      keyIndex = self.keys.length++;</span><br><span class="line">      self.data[key].keyIndex = keyIndex + 1;</span><br><span class="line">      self.keys[keyIndex].key = key;</span><br><span class="line">      self.size++;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  function remove(itmap storage self, uint key) returns (bool success)</span><br><span class="line">  &#123;</span><br><span class="line">    uint keyIndex = self.data[key].keyIndex;</span><br><span class="line">    if (keyIndex == 0)</span><br><span class="line">      return false;</span><br><span class="line">    delete self.data[key];</span><br><span class="line">    self.keys[keyIndex - 1].deleted = true;</span><br><span class="line">    self.size --;</span><br><span class="line">  &#125;</span><br><span class="line">  function contains(itmap storage self, uint key) returns (bool)</span><br><span class="line">  &#123;</span><br><span class="line">    return self.data[key].keyIndex &gt; 0;</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_start(itmap storage self) returns (uint keyIndex)</span><br><span class="line">  &#123;</span><br><span class="line">    return iterate_next(self, uint(-1));</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_valid(itmap storage self, uint keyIndex) returns (bool)</span><br><span class="line">  &#123;</span><br><span class="line">    return keyIndex &lt; self.keys.length;</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_next(itmap storage self, uint keyIndex) returns (uint r_keyIndex)</span><br><span class="line">  &#123;</span><br><span class="line">    keyIndex++;</span><br><span class="line">    while (keyIndex &lt; self.keys.length &amp;&amp; self.keys[keyIndex].deleted)</span><br><span class="line">      keyIndex++;</span><br><span class="line">    return keyIndex;</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_get(itmap storage self, uint keyIndex) returns (uint key, uint value)</span><br><span class="line">  &#123;</span><br><span class="line">    key = self.keys[keyIndex].key;</span><br><span class="line">    value = self.data[key].value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// How to use it:</span><br><span class="line">contract User</span><br><span class="line">&#123;</span><br><span class="line">  // Just a struct holding our data.</span><br><span class="line">  IterableMapping.itmap data;</span><br><span class="line">  // Insert something</span><br><span class="line">  function insert(uint k, uint v) returns (uint size)</span><br><span class="line">  &#123;</span><br><span class="line">    // Actually calls itmap_impl.insert, auto-supplying the first parameter for us.</span><br><span class="line">    IterableMapping.insert(data, k, v);</span><br><span class="line">    // We can still access members of the struct - but we should take care not to mess with them.</span><br><span class="line">    return data.size;</span><br><span class="line">  &#125;</span><br><span class="line">  // Computes the sum of all stored data.</span><br><span class="line">  function sum() returns (uint s)</span><br><span class="line">  &#123;</span><br><span class="line">    for (var i = IterableMapping.iterate_start(data); IterableMapping.iterate_valid(data, i); i = IterableMapping.iterate_next(data, i))</span><br><span class="line">    &#123;</span><br><span class="line">        var (key, value) = IterableMapping.iterate_get(data, i);</span><br><span class="line">        s += value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="以太坊虚拟机-EVM"><a href="#以太坊虚拟机-EVM" class="headerlink" title="以太坊虚拟机(EVM)"></a>以太坊虚拟机(EVM)</h4><p>以太坊虚拟机(EVM)是智能合约的运行环境。它是一个完全独立的沙盒，合约代码在EVM内部运行，对外是完全隔离的，甚至不同合约之间也只有有限的访问权限</p>
<h4 id="账户"><a href="#账户" class="headerlink" title="账户"></a>账户</h4><ul>
<li>以太坊中有两种不同类型但是共享同一地址空间的账户：<code>外部账户</code>由一对公私钥控制，<code>合约账户</code>由账户内部的合约代码控制。</li>
<li>外部账户的地址是由公钥（经过hash运算）决定的，而合约账户的地址在此合约被创建的时候决定的（由合约创建者的地址和发送到此合约地址的交易数决定，这就是所谓的“nonce”）</li>
<li>不管是哪种类型的账户，EVM的处理方式是一样的</li>
<li>每个账户都有一个持久的key-value类型的存储，把256字节的key映射到256字节的value</li>
<li>此外，每个账户都有以“Wei”为单位，在交易过程中会被修改的资产(balance)信息</li>
</ul>
<h4 id="交易"><a href="#交易" class="headerlink" title="交易"></a>交易</h4><ul>
<li>交易是一个从账户发往另一个账户（可以是同一个账户或者是special zero-account）的消息。它包含二进制数据（交易相关的数据）和 Ether。</li>
<li>如果目标账户包含代码，代码会被执行，交易相关的数据将作为参数</li>
<li>如果目标账户是地址为0的账户<code>zero-account</code>, 交易会创建一个新的合约。如上文提到的，合约地址不是一个地址为0的地址，而是一个由交易发送者和交易数来决定的地址。这样的一笔（到zero-account）交易的相关参数会被转化为EVM字节码<br>然后被执行，输出结果就是被永久存储的合约代码。这意味着为了创建一个合约，并不需要发送真实的合约代码，代码可以被自动创建</li>
</ul>
<h4 id="gas"><a href="#gas" class="headerlink" title="gas"></a>gas</h4><ul>
<li>创建之后，每笔交易都需要一定数量的gas，用于限制交易所消耗的工作量，即交易是需要付出代价的（避免DDoS攻击）。EVM执行交易的过程中，gas会按一个特殊规则逐渐减少</li>
<li>费用的多少是由交易发起者设置，至少需要从发起账户支付<code>gas_price * gas</code>用费。如果交易执行完毕费用还有剩余的，将退回到发起账户。</li>
<li>如果交易完成之前费用耗尽，将会抛出一个<code>out-of-gas</code>的异常，所有的修改都会被回滚</li>
</ul>
<p>更多关于gas的理解和讨论可以<a href="http://bitshuo.com/topic/5857774a2a482b0d339aab99/" target="_blank" rel="noopener">戳这里</a></p>
<h4 id="storage-memory-stack"><a href="#storage-memory-stack" class="headerlink" title="storage,memory,stack"></a>storage,memory,stack</h4><ul>
<li>每个账户都有一个持久的内存空间，称之为<code>storage</code>,<code>storage</code>以key-value形式存储，256字节的key映射到256字节value，合约内部不可能枚举<code>storage</code>(内部元素)，读取或者修改<code>storage</code>操作消耗都很大(原文是 It is not possible to enumerate storage from within a contract and it is comparatively costly to read and even more so, to modify storage. )。 合约只能读取和修改自己的<code>storage</code>里的数据。</li>
<li>第二种内存空间称之为<code>memory</code>,里面存储着每个消息调用时合约创建的实例。<code>memory</code>是线型的，可以以字节级别来处理，但是限制为256字节宽度，写入可以是8或256字节宽度。当读取或写入一个预先未触发的指令的时候会消耗<code>memory</code>的空间，消耗空间的同时，必须支付gas。<code>memory</code>消耗的越多，需要的gas越多（按平方级增长）</li>
<li>EVM不是一个注册的机器而是一个堆栈机器，所以所有的计算指令都在<code>stack</code>空间里面执行。<code>stack</code>最多只能容纳1024个长度不超过256字节的指令元素。只能用下述方法，从顶部访问<code>stack</code>：可以拷贝最顶部的16个元素中的一个到<code>stack</code>的最顶部，或者将最顶部的那个元素与其下面的16个元素之一互换。所有其它操作从<code>stack</code>最顶部取出两个（或一个，或更多，取决于操作）元素，然后把结果push到<code>stack</code>顶端。当然将<code>stack</code>中的元素移到<code>memory</code>或者<code>storage</code>也是可以的，但是不能直接访问<code>stack</code>中间的元素（必须从头部开始访问）</li>
</ul>
<h4 id="指令集合"><a href="#指令集合" class="headerlink" title="指令集合"></a>指令集合</h4><ul>
<li>EVM的指令集合控制的很小，这样可以避免错误的执行引发问题。所有的指令都是操作最基本的数据类型，256字节。而且都是最常见的逻辑，算法，字节和比较运算。有条件或无条件的跳转都可以。此外，合约可以访问当前区块的属性，比如区块编号和时间戳。</li>
</ul>
<h4 id="消息调用"><a href="#消息调用" class="headerlink" title="消息调用"></a>消息调用</h4><ul>
<li>合约之间可以通过消息调用的方式进行相互调用或者另一个给另一个无合约账户（外部账户）转币。消息调用很像交易，两者都有源账户，目标账户，数据（data payload），<code>Ether</code>,费用和返回数据。实际上每笔交易都由一个可创建更多调用的顶级调用组成。</li>
<li>合约可以决定内部消息调用的时候发送多少手续费，保留多少。如果在内部消息调用的时候抛出<code>out-of-gas</code>异常（或者其它异常），这个会被一个错误值标记，放到<code>stack</code>顶部。如此，只有和消息一起发出的手续费才会被消耗。在<code>Solidity</code>中这种情形默认会引发一个异常，以便异常“冒泡”到<code>stack</code>最顶端</li>
<li>如上所述，被调用的合约会接收到一个刚创建的<code>memory</code>实例，并且可以访问调用参数，调用参数被存储在一个被为<code>calldata</code>的隔离的区域。执行完毕后，被调用的合约将返回数据存储在调用合约预先创建的内存中。</li>
<li>调用被限制在1024深度，这意味着复杂的操作应尽量使用循环代替递归调用。</li>
</ul>
<h4 id="代理调用-调用代码和库"><a href="#代理调用-调用代码和库" class="headerlink" title="代理调用/调用代码和库"></a>代理调用/调用代码和库</h4><ul>
<li>存在一种称为<code>delegatecall</code>的特殊的多样性的消息调用，which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.</li>
<li>这意味着合约可以在运行的时候动态的从另一个地址加载代码。存储、当前地址和资产仍然和调用的合约相关联，只有代码来自被调用的地址。</li>
<li>这样可以实现Solidity库的特性:反复使用的库代码可以被应用到合约的<code>storage</code>来实现复杂的数据结构。</li>
</ul>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>It is possible to store data in a specially indexed data structure that maps all the way up to the block level. This feature called logs is used by Solidity in order to implement events. Contracts cannot access log data after it has been created, but they can be efficiently accessed from outside the blockchain. Since some part of the log data is stored in bloom filters, it is possible to search for this data in an efficient and cryptographically secure way, so network peers that do not download the whole blockchain (“light clients”) can still find these logs.</p>
<h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><ul>
<li>合约甚至可以使用特殊的<code>opcode</code>创建其它的合约,<code>create</code>消息调用和普通的消息调用区别在于，<code>create</code>消息调用的data字段会被执行，执行结果以代码的形式存储，调用者可在stack上接接到新合约账户的地址</li>
</ul>
<ul>
<li>示例一</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract ClassifyStorage &#123;</span><br><span class="line">    mapping(address =&gt; string) details;</span><br><span class="line">    event AddDetailEvent(address classify, string detail);</span><br><span class="line"></span><br><span class="line">    function addDetail(address classify, string detail) public &#123;</span><br><span class="line">        details[classify] = strConcat(details[classify], detail);</span><br><span class="line">        AddDetailEvent(classify, detail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSpecificDetails(address classify) constant public returns (string) &#123;</span><br><span class="line">        return details[classify];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function strConcat(string _a, string _b) internal returns (string)&#123;</span><br><span class="line">        bytes memory _ba = bytes(_a);</span><br><span class="line">        if(_ba.length == 0) &#123;</span><br><span class="line">            return _b;</span><br><span class="line">        &#125;</span><br><span class="line">        bytes memory _bb = bytes(_b);</span><br><span class="line">        string memory ret = new string(_ba.length + _bb.length + 1);</span><br><span class="line">        bytes memory bret = bytes(ret);</span><br><span class="line">        uint k = 0;</span><br><span class="line">        for (uint i = 0; i &lt; _ba.length; i++)bret[k++] = _ba[i];</span><br><span class="line">        bret[k++] = &quot;,&quot;;</span><br><span class="line">        for (i = 0; i &lt; _bb.length; i++) bret[k++] = _bb[i];</span><br><span class="line">        return string(ret);</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#以太坊智能合约"><span class="toc-number">1.</span> <span class="toc-text">以太坊智能合约</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码编写及编译部署"><span class="toc-number">1.0.1.</span> <span class="toc-text">代码编写及编译部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#智能合约ABI"><span class="toc-number">1.0.2.</span> <span class="toc-text">智能合约ABI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Function"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">Function</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Event"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">Event</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#示例"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3"><span class="toc-number">1.1.</span> <span class="toc-text">web3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Event-1"><span class="toc-number">1.1.1.</span> <span class="toc-text">Event</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Remix"><span class="toc-number">1.1.2.</span> <span class="toc-text">Remix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bytes32、string"><span class="toc-number">1.1.3.</span> <span class="toc-text">bytes32、string</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#钱💰💰💰💰"><span class="toc-number">1.1.4.</span> <span class="toc-text">钱💰💰💰💰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#合约交互"><span class="toc-number">1.1.5.</span> <span class="toc-text">合约交互</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapping"><span class="toc-number">1.1.6.</span> <span class="toc-text">mapping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#以太坊虚拟机-EVM"><span class="toc-number">1.1.7.</span> <span class="toc-text">以太坊虚拟机(EVM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#账户"><span class="toc-number">1.1.8.</span> <span class="toc-text">账户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#交易"><span class="toc-number">1.1.9.</span> <span class="toc-text">交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gas"><span class="toc-number">1.1.10.</span> <span class="toc-text">gas</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storage-memory-stack"><span class="toc-number">1.1.11.</span> <span class="toc-text">storage,memory,stack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#指令集合"><span class="toc-number">1.1.12.</span> <span class="toc-text">指令集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消息调用"><span class="toc-number">1.1.13.</span> <span class="toc-text">消息调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代理调用-调用代码和库"><span class="toc-number">1.1.14.</span> <span class="toc-text">代理调用/调用代码和库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#日志"><span class="toc-number">1.1.15.</span> <span class="toc-text">日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Create"><span class="toc-number">1.1.16.</span> <span class="toc-text">Create</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://github.com/xiaoxuez/2019/10/14/eth-contract/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&text=eth_contract"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&is_video=false&description=eth_contract"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=eth_contract&body=Check out this article: https://github.com/xiaoxuez/2019/10/14/eth-contract/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&title=eth_contract"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://github.com/xiaoxuez/2019/10/14/eth-contract/&name=eth_contract&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 zoie
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
