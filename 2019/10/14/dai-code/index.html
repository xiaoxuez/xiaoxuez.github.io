<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="dai结构及源码解析 结构图如上所示，vat左边的主要是管理控制修改vat及vat右边各合约各参数的合约，红线file为调用各合约中file方法，也就是修改各合约中相应参数。如vat中file为P427L-9Y552-5433E-8DSR3-58Z68 12345678910function file(bytes32 what, uint data) external note auth &amp;#12">
<meta property="og:type" content="article">
<meta property="og:title" content="dai_code">
<meta property="og:url" content="https://github.com/xiaoxuez/2019/10/14/dai-code/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="dai结构及源码解析 结构图如上所示，vat左边的主要是管理控制修改vat及vat右边各合约各参数的合约，红线file为调用各合约中file方法，也就是修改各合约中相应参数。如vat中file为P427L-9Y552-5433E-8DSR3-58Z68 12345678910function file(bytes32 what, uint data) external note auth &amp;#12">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png">
<meta property="og:updated_time" content="2020-11-12T06:54:00.956Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dai_code">
<meta name="twitter:description" content="dai结构及源码解析 结构图如上所示，vat左边的主要是管理控制修改vat及vat右边各合约各参数的合约，红线file为调用各合约中file方法，也就是修改各合约中相应参数。如vat中file为P427L-9Y552-5433E-8DSR3-58Z68 12345678910function file(bytes32 what, uint data) external note auth &amp;#12">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>dai_code</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/10/14/eth-erc/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/10/14/dai/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://github.com/xiaoxuez/2019/10/14/dai-code/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&text=dai_code"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&is_video=false&description=dai_code"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=dai_code&body=Check out this article: https://github.com/xiaoxuez/2019/10/14/dai-code/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&name=dai_code&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#dai结构及源码解析"><span class="toc-number">1.</span> <span class="toc-text">dai结构及源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vat"><span class="toc-number">1.1.</span> <span class="toc-text">vat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cat"><span class="toc-number">1.2.</span> <span class="toc-text">cat</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#example"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">example</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        dai_code
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-10-14T14:52:07.000Z" itemprop="datePublished">2019-10-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/eth/">eth</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="dai结构及源码解析"><a href="#dai结构及源码解析" class="headerlink" title="dai结构及源码解析"></a>dai结构及源码解析</h2><p><img src="https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png" alt="合约调用图"></p>
<p>结构图如上所示，vat左边的主要是<strong>管理控制修改</strong>vat及vat右边各合约各<strong>参数</strong>的合约，红线file为调用各合约中file方法，也就是修改各合约中相应参数。如vat中file为P427L-9Y552-5433E-8DSR3-58Z68</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function file(bytes32 what, uint data) external note auth &#123;</span><br><span class="line">    if (what == &quot;Line&quot;) Line = data;</span><br><span class="line">    else revert();</span><br><span class="line">&#125;</span><br><span class="line">function file(bytes32 ilk, bytes32 what, uint data) external note auth &#123;</span><br><span class="line">    if (what == &quot;spot&quot;) ilks[ilk].spot = data;</span><br><span class="line">    else if (what == &quot;line&quot;) ilks[ilk].line = data;</span><br><span class="line">    else if (what == &quot;dust&quot;) ilks[ilk].dust = data;</span><br><span class="line">    else revert();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vat是CDP的主要逻辑合约。</p>
<p>cat为清算触发合约，通过调用cat.bite方法，当满足清算条件就会触发清算。具体逻辑稍后提及。</p>
<p>vow为结算合约，通过vow的结算条件可触发flop和flap。</p>
<p>flip为抵押物拍卖合约，拍卖由cat触发，拍卖逻辑稍后提及。</p>
<p>flop和flap分别为债务拍卖和盈余拍卖，由vow触发。</p>
<h3 id="vat"><a href="#vat" class="headerlink" title="vat"></a>vat</h3><p>变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//抵押物id对应的参数</span><br><span class="line">mapping (bytes32 =&gt; Ilk)                       public ilks;  </span><br><span class="line">//抵押物id =&gt; 个人地址 =&gt; 个人债务</span><br><span class="line">mapping (bytes32 =&gt; mapping (address =&gt; Urn )) public urns;  </span><br><span class="line">//抵押物id =&gt; 个人地址 =&gt; 个人抵押物总值</span><br><span class="line">mapping (bytes32 =&gt; mapping (address =&gt; uint)) public gem;  </span><br><span class="line">//个人地址 =&gt; 含有的dai，统计作用</span><br><span class="line">mapping (address =&gt; uint256)                   public dai;  </span><br><span class="line">//清算地址 =&gt; 清算总值， 统计作用</span><br><span class="line">mapping (address =&gt; uint256)                   public sin;</span><br><span class="line"></span><br><span class="line"> struct Urn &#123;</span><br><span class="line">        uint256 ink;   // 锁定的抵押物值</span><br><span class="line">        uint256 art;   // 借贷的dai</span><br><span class="line"> &#125;</span><br><span class="line"> //以抵押物id为个体</span><br><span class="line"> struct Ilk &#123;</span><br><span class="line">        uint256 Art;   // 总借贷dai</span><br><span class="line">        uint256 rate;  // 可借贷比率</span><br><span class="line">        uint256 spot;  // 价格安全线</span><br><span class="line">        uint256 line;  // 总借贷上线</span><br><span class="line">        uint256 dust;  // 总借贷下限</span><br><span class="line"> &#125; //rate和spot的作用主要是满足ink * spot &gt;= art * rate可借贷，不然就不能借贷或者需要清算了。</span><br></pre></td></tr></table></figure>

<p>主要讲讲frob方法吧，这个方法可谓是精短又强悍！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//bytes32 i ilk标识， address u cdp所有者，v 抵押物所有者，w 获得dai的所有者，dink 参与的抵押物，dart参与的债务</span><br><span class="line">function frob(bytes32 i, address u, address v, address w, int dink, int dart) external note &#123;</span><br><span class="line">    // system is live</span><br><span class="line">    require(live == 1);</span><br><span class="line"></span><br><span class="line">    Urn memory urn = urns[i][u];</span><br><span class="line">    Ilk memory ilk = ilks[i];</span><br><span class="line">    // ilk has been initialised</span><br><span class="line">    require(ilk.rate != 0);</span><br><span class="line"></span><br><span class="line">    urn.ink = add(urn.ink, dink);</span><br><span class="line">    urn.art = add(urn.art, dart);</span><br><span class="line">    ilk.Art = add(ilk.Art, dart);</span><br><span class="line"></span><br><span class="line">    int dtab = mul(ilk.rate, dart);</span><br><span class="line">    uint tab = mul(urn.art, ilk.rate);</span><br><span class="line">    debt     = add(debt, dtab); //dai总量</span><br><span class="line"></span><br><span class="line">    //dart &lt;=0, 赎回抵押物？ dart &gt;0, 借贷</span><br><span class="line"></span><br><span class="line">    // either debt has decreased, or debt ceilings are not exceeded</span><br><span class="line">    require(either(dart &lt;= 0, both(mul(ilk.Art, ilk.rate) &lt;= ilk.line, debt &lt;= Line)));</span><br><span class="line">    // urn is either less risky than before, or it is safe</span><br><span class="line">    require(either(both(dart &lt;= 0, dink &gt;= 0), tab &lt;= mul(urn.ink, ilk.spot)));</span><br><span class="line">    // urn is either more safe, or the owner consents</span><br><span class="line">    require(either(both(dart &lt;= 0, dink &gt;= 0), wish(u, msg.sender)));</span><br><span class="line">    // collateral src consents</span><br><span class="line">    require(either(dink &lt;= 0, wish(v, msg.sender)));</span><br><span class="line">    // debt dst consents</span><br><span class="line">    require(either(dart &gt;= 0, wish(w, msg.sender)));</span><br><span class="line">    // urn has no debt, or a non-dusty amount</span><br><span class="line">    require(either(urn.art == 0, tab &gt;= ilk.dust));</span><br><span class="line"></span><br><span class="line">    gem[i][v] = sub(gem[i][v], dink);</span><br><span class="line">    dai[w]    = add(dai[w],    dtab);</span><br><span class="line">    urns[i][u] = urn;</span><br><span class="line">    ilks[i]    = ilk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在以上这个方法中，包含了很多种用法，包括新增cdp、偿还等等，例如当dart&gt;0的时候，就是借贷，当dart&lt;0的时候，偿还。</p>
<p>首先，当借贷/增加抵押物时，抵押物为dink &gt;=0, 贷款dart &gt;0。贷款价值为dart * rate，抵押物价值为dink * spot。借贷需要满足的条件如下</p>
<ul>
<li><p>贷款价值 &lt; 债务上限line, 且该抵押物的总贷款价值&lt;Line上限</p>
</li>
<li><p>贷款价值 &lt;= 抵押物价值，这里理解一下rate，当rate &gt; 1，其实就是说可贷的dart其实是小于真正抵押物价值的，用来调控风险。</p>
</li>
<li><p>u为调用者，或者调用者是u的下层授权管理（u授权x以操作其cdp）</p>
</li>
<li><p>贷款价值 &gt; 债务下限 dust</p>
</li>
</ul>
<p>当条件判断完毕后，进行扣除/赎回抵押物(gem)，借出/偿还dai。</p>
<h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function bite(bytes32 ilk, address urn) external returns (uint id) &#123;</span><br><span class="line">       VatLike.Ilk memory i = vat.ilks(ilk);</span><br><span class="line">       VatLike.Urn memory u = vat.urns(ilk, urn);</span><br><span class="line"></span><br><span class="line">       require(live == 1);</span><br><span class="line">       //触发清算要求，个人抵押品 * 具有安全边际的抵押品价格 &lt; 个人债务 * 稳定债务乘数(稳定债务)</span><br><span class="line">       //即抵押品价格下降到一定程度后，触发清算</span><br><span class="line">       require(mul(u.ink, i.spot) &lt; mul(u.art, i.rate));</span><br><span class="line">       //取个人抵押品和任何一次清算事件所涵盖的固定债务数量的小值</span><br><span class="line">       uint lot = min(u.ink, ilks[ilk].lump);</span><br><span class="line">       //取个人债务 和 抵押品 * 债务 / 抵押品的 小值</span><br><span class="line">       uint art = min(u.art, mul(lot, u.art) / u.ink);</span><br><span class="line">       //债务 * 稳定债务乘数(稳定债务)</span><br><span class="line">       uint tab = mul(art, i.rate);</span><br><span class="line"></span><br><span class="line">       require(lot &lt;= 2**255 &amp;&amp; art &lt;= 2**255);</span><br><span class="line">       //清算，将个人抵押品减掉，个人债务也减掉,将减掉的抵押品转移到本地址下(gem)</span><br><span class="line">       vat.grab(ilk, urn, address(this), address(vow), -int(lot), -int(art));</span><br><span class="line">       //结算？</span><br><span class="line">       vow.fess(tab);</span><br><span class="line">       //触发拍卖</span><br><span class="line">       id = Kicker(ilks[ilk].flip).kick(&#123; urn: urn</span><br><span class="line">                                        , gal: address(vow)</span><br><span class="line">                                        , tab: rmul(tab, ilks[ilk].chop) //所需债务: dai债务 * 清算罚款 / 10 ** 27</span><br><span class="line">                                        , lot: lot //抵押品</span><br><span class="line">                                        , bid: 0</span><br><span class="line">                                        &#125;);</span><br><span class="line"></span><br><span class="line">       emit Bite(ilk, urn, lot, art, tab, ilks[ilk].flip, id);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="example"><a href="#example" class="headerlink" title="example"></a>example</h5><p>补充，借贷的第一步，会有一个join合约，就是帮忙保管币/代币。调用join方法，会将币/代币转移到本合约地址下，然后本合约会调用vat.slip方法，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function join(address usr, uint wad) external note &#123;</span><br><span class="line">    require(int(wad) &gt;= 0);</span><br><span class="line">    vat.slip(ilk, usr, int(wad)); //gem[ilk][usr] = wad</span><br><span class="line">    require(gem.transferFrom(msg.sender, address(this), wad));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vat.init(&quot;gold&quot;);</span><br><span class="line">gemA = new GemJoin(address(vat), &quot;gold&quot;, address(gold));</span><br><span class="line">vat.file(&quot;gold&quot;, &quot;spot&quot;, ray(1 ether)); //ray: 10 ** 9</span><br><span class="line">vat.file(&quot;gold&quot;, &quot;line&quot;, rad(1000 ether)); //rad: 10 ** 27</span><br><span class="line">vat.file(&quot;Line&quot;,         rad(1000 ether));</span><br><span class="line">cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1 ether));</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">address urn = address(this);</span><br><span class="line">//转移币</span><br><span class="line">gemA.join(urn,                             500 ether);</span><br><span class="line">vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2.5 ether));</span><br><span class="line">vat.frob(&quot;gold&quot;, me, me, me, 40 ether, 100 ether);</span><br><span class="line">//假设rate为 (10 ** 9)</span><br><span class="line">//借贷判断， 40 * (10 ** 18) * 2.5 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9),满足条件，可借贷</span><br><span class="line">//vat.urn[gold][me]= ink(40)， art(100)</span><br><span class="line"></span><br><span class="line"> vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2 ether));  //抵押物价格下降</span><br><span class="line"> cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1.1 ether));</span><br><span class="line"> cat.file(&quot;gold&quot;, &quot;lump&quot;, 30 ether);</span><br><span class="line"></span><br><span class="line"> //清算判断</span><br><span class="line"> uint auction = cat.bite(&quot;gold&quot;, address(this));</span><br><span class="line"> //40 * (10 ** 18) * 2 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9) 很明显，不满足条件，触发清算</span><br><span class="line"> //清算lot=min(u.ink, ilks[ilk].lump) = 30 ether</span><br><span class="line"> // art = min(u.art, mul(lot, u.art) / u.ink); = 75 ether</span><br><span class="line"> //此时vat.urn[gold][me] = ink(10 ether), art(25 ether)</span><br><span class="line"> //						tab = art * rate</span><br><span class="line"> //触发拍卖kick中tab为rmul(tab, ilks[ilk].chop)， (75 * (10 ** 18) * (10 ** 9)) * 1.1 * (10 ** 18) / 10 ** 27 = 82.5 * (10 ** 18) 即85 ether</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#dai结构及源码解析"><span class="toc-number">1.</span> <span class="toc-text">dai结构及源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vat"><span class="toc-number">1.1.</span> <span class="toc-text">vat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cat"><span class="toc-number">1.2.</span> <span class="toc-text">cat</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#example"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">example</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://github.com/xiaoxuez/2019/10/14/dai-code/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&text=dai_code"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&is_video=false&description=dai_code"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=dai_code&body=Check out this article: https://github.com/xiaoxuez/2019/10/14/dai-code/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&title=dai_code"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://github.com/xiaoxuez/2019/10/14/dai-code/&name=dai_code&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 zoie
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
