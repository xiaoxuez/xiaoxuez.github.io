<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>defi-aragon</title>
      <link href="/2020/11/12/defi-aragon/"/>
      <url>/2020/11/12/defi-aragon/</url>
      
        <content type="html"><![CDATA[<h3 id="aragon"><a href="#aragon" class="headerlink" title="aragon"></a>aragon</h3><p>è¿™ä¸ªDAOçš„å·¥å…·æ¥è¯´ï¼Œè¿˜æ˜¯å¾ˆå¥½ç”¨çš„ã€‚å„æ–¹é¢éƒ½å°è£…å¾—å¾ˆå¥½ï¼›</p><p>ä¸»è¦ç”±kernel + acl + appsç»„æˆï¼›</p><h4 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h4><p>ç®€å•æ¥è¯´ï¼Œ kernelè´Ÿè´£å­˜å‚¨å„ä¸ªappçš„åœ°å€ï¼ˆapp-id =&gt; addressï¼‰ï¼Œappçš„éƒ¨ç½²æ–¹å¼ä¸º(proxy delegatecall), appçš„proxyä¸­çš„<code>delegatecall(implement, msg.data)</code>ä¸­çš„implementå°†ä¼šåˆ°kernelä¸­è¯»å–å¯¹åº”app-idçš„baseé€»è¾‘çš„åˆçº¦åœ°å€ã€‚</p><h3 id="acl"><a href="#acl" class="headerlink" title="acl"></a>acl</h3><p>aclè´Ÿè´£å®Œæˆæƒé™ç®¡ç†ã€‚appçš„ä¸€åˆ‡ä¿®æ”¹æ•°æ®çš„æ“ä½œéƒ½éœ€è¦å…·æœ‰å¯¹åº”çš„æƒé™æ‰å¯ä»¥ã€‚å¦‚ä¸€ä¸ªtransferæ–¹æ³•çš„ç­¾åä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function transfer(address _token, address _to, uint256 _value)</span><br><span class="line">        external</span><br><span class="line">        authP(TRANSFER_ROLE, arr(_token, _to, _value))</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure><p><code>authP</code>ä¾¿æ˜¯æƒé™æŸ¥è¯¢ã€‚</p><p>ä¸€ä¸ªæƒé™ Permission ä¸»è¦ç”±ä¸‹é¢å‡ ä¸ªæ¦‚å¿µæ¥ç»„æˆ</p><ul><li><code>manager</code>ç®¡ç†è€…ï¼Œç®¡ç†è€…å¯å°†è¯¥æƒé™æˆäºˆæŸå®ä½“åœ°å€ï¼Œä»¥åŠå–æ¶ˆæŸå®ä½“åœ°å€çš„è¯¥æƒé™</li><li><code>role</code> æƒé™åç§°ï¼Œå¦‚<code>TRANSFER_ROLE</code></li><li><code>app</code>ï¼Œè¯¥æƒé™ä½œç”¨çš„app</li><li><code>entity</code>,æ‹¥æœ‰è¯¥æƒé™çš„å®ä½“</li></ul><p>åˆ›å»ºä¸€ä¸ªpermissionæ—¶ï¼Œå°±éœ€è¦åŒ…å«è¿™å‡ ä¸ªä¿¡æ¯ï¼›å¦‚ <code>app = vault, role = TRANSFER_ROLE</code>ï¼Œåˆ™ä»£è¡¨è¯¥æƒé™æ˜¯è¦ä½¿ç”¨(transfer)vaultä¸­çš„èµ„äº§æƒé™ï¼›åˆ›å»º(create)å®Œæˆä¸€ä¸ªpermissionåï¼Œmanagerå¯é€šè¿‡<code>grant</code>æ¥å¯¹æƒé™è¿›è¡Œæˆäºˆæˆ–å–æ¶ˆï¼›</p><h4 id="app"><a href="#app" class="headerlink" title="app"></a>app</h4><p>æ›´è¯¦ç»†çš„<a href="https://hack.aragon.org/docs/guides-custom-deploy#adding-a-vault-and-finance-instance" target="_blank" rel="noopener">æ–‡æ¡£</a>ğŸ‘ˆã€‚è¿™é‡Œåˆ—å‡ºåŸºæœ¬çš„å‡ ä¸ª</p><ul><li><p>Token Manager</p><p>å¯ä½¿ç”¨tokenæ¥åˆ†ç»„ï¼Œé…ç½®ä¸åŒä¼šæœ‰3ç§åœºæ™¯</p><ul><li><p><code>Membership</code>ï¼Œ tokenä¸å¯è½¬è®©ï¼Œæ¯åœ°å€åªèƒ½æ‹¥æœ‰1æš</p></li><li><p><code>Reputation</code> ï¼Œtokenä¸å¯è½¬è®©ï¼Œæ¯åœ°å€æ²¡æœ‰æ•°é‡é™åˆ¶</p></li><li><p><code>Equity</code>ï¼Œtokenå¯è½¬è®©ï¼Œæ¯åœ°å€æ²¡æœ‰æ•°é‡é™åˆ¶</p><p>Token manager ä½¿ç”¨çš„tokenæ˜¯<a href="https://github.com/Giveth/minime">minime</a>, è¿™ä¸ªæ˜¯å…·æœ‰é¢å¤–åŠŸèƒ½çš„erc20, é¢å¤–åŠŸèƒ½åŒ…æ‹¬ï¼Œå…‹éš†æ–¹ä¾¿ï¼Œä¿å­˜ç€åœ°å€èµ„äº§å†å²ï¼Œå¯æ ¹æ®åŒºå—é«˜åº¦æ¥æŸ¥è¯¢ä½™é¢ï¼›</p></li></ul></li><li><p>Voting</p><p>é€šè¿‡tokenè¿›è¡ŒæŠ•ç¥¨ã€‚</p><p>åˆ›å»ºvoting appå¯ä»¥è®¾ç½®çš„å‚æ•°åŒ…æ‹¬</p><ul><li><code>minime token</code></li><li>æŠ•ç¥¨é€šè¿‡çš„ç™¾åˆ†æ¯”</li><li>æœ€å°å‚ä¸æŠ•ç¥¨çš„ç™¾åˆ†æ¯”</li><li>æŠ•ç¥¨æœŸæ—¶é•¿</li></ul></li><li><p>Vault ä»¥åŠ Finance</p><p>vaultä¿ç®¡ç€ä¸€äº›èµ„äº§ï¼Œä½†vaultæ²¡æä¾›ç”¨æˆ·æ¥å£ï¼Œéœ€è¦é€šè¿‡Financeçš„ç”¨æˆ·æ¥å£æ¥äº¤äº’æ“ä½œï¼ŒFinanceä¸­è´Ÿè´£æä¾›é¢„ç®—ï¼Œåœ¨ä¸€ä¸ªé˜¶æ®µå¯æä¾›ä¸€ç¬”é¢„ç®—ï¼Œé€šè¿‡æŠ•ç¥¨å¯ä½¿ç”¨è¿™ç¬”é¢„ç®—ï¼Œé¢„ç®—ä¸­çš„èµ„äº§å°†ç”±Vaultæ”¯ä»˜</p></li><li><p>Agent</p><p>è¿™æ˜¯Vaultçš„å­ç±»ï¼Œä¿ç®¡ç€èµ„äº§ï¼Œå¹¶ä¸”æä¾›ä¸å…¶ä»–åˆçº¦äº¤äº’çš„æ¥å£ï¼Œæ¯”å¦‚å¯ä»¥å°†è¿™äº›èµ„äº§æ”¾åˆ°å…¶ä»–çš„defiåˆçº¦é‡Œèµšå–æ”¶ç›Šä»€ä¹ˆçš„ã€‚</p></li></ul><h3 id="åŸºæœ¬çš„éƒ¨ç½²ç¤ºä¾‹"><a href="#åŸºæœ¬çš„éƒ¨ç½²ç¤ºä¾‹" class="headerlink" title="åŸºæœ¬çš„éƒ¨ç½²ç¤ºä¾‹"></a>åŸºæœ¬çš„éƒ¨ç½²ç¤ºä¾‹</h3><p>è¿™é‡Œå°†éƒ¨ç½²ä¸€ä¸ªæŠ•ç¥¨appï¼Œå½“æŠ•ç¥¨é€šè¿‡åï¼Œä½¿ç”¨vaultä¸­èµ„äº§çš„ä¾‹å­ã€‚</p><ol><li><p>éƒ¨ç½²Kernelå’ŒACL</p></li><li><p>æ‰§è¡Œ<code>kernel.initialize(acl, rootAddress)</code>æ¥é…ç½®kernelä¸­çš„aclå®ä¾‹å’Œæ“ä½œåœ°å€ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>acl.initialize(rootAddress)</code>ä»¥åŠ<code>createPermission(rootAddress, aclAddress, CREATE_PERMISSIONS_ROLE, rootAddress)</code>åˆ›å»ºæƒé™ç®¡ç†ï¼›</p><p>åˆå§‹åŒ–æ—¶çš„rootAddresså°†ä¼šå…·æœ‰ä»¥åŠç®¡ç†createPermissionçš„æƒé™ã€‚</p></li><li><p>éƒ¨ç½²Voting appï¼ŒæŠ•ç¥¨é€šè¿‡åï¼Œå°†ä¼šè°ƒç”¨vaultä¸­çš„transferæ–¹æ³•ï¼Œæ‰€ä»¥votingè¦å…·æœ‰å¯¹åº”çš„æƒé™ã€‚</p></li><li><p>ä¸Šé¢æåˆ°rootAddressæœ‰ç®¡ç†createPermissionçš„æƒé™ï¼Œæ‰€ä»¥é¦–å…ˆä½¿ç”¨rootAddresså°†createPermissionæˆæƒç»™votingï¼Œä¹‹åvotingå†åˆ›å»ºtransferæƒé™ã€‚</p><blockquote><p>Grant the Voting app the ability to call <code>createPermission()</code>: <code>grantPermission(votingAppAddress, aclAddress, CREATE_PERMISSIONS_ROLE)</code> (must be executed by <code>rootAddress</code>)</p></blockquote></li><li><p>éƒ¨ç½²Vault åˆçº¦ï¼Œè¯¥åˆçº¦å…·æœ‰transferæ–¹æ³•</p></li><li><p>æ‰€ä»¥ç°åœ¨votingå°±è¦åˆ›å»ºè‡ªå·±å»æ‰§è¡Œvaultçš„transferæ–¹æ³•çš„æƒé™</p><blockquote><p>Create a new vote via the Voting app to create the <code>TRANSFER_ROLE</code> permission: <code>createPermission(votingAppAddress, vaultAppAddress, TRANSFER_ROLE, votingAppAddress)</code></p></blockquote></li><li><p>å½“æŠ•ç¥¨é€šè¿‡åï¼Œvotingå°±å¯ä»¥è°ƒç”¨vaultä¸­ä»»ä½•ç”± TRANSFER_ROLE æƒé™ä¿®é¥°çš„æ–¹æ³•äº†ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰<code>transfer</code>æ–¹æ³•</p></li><li><p>Vaultä¸­çš„èµ„äº§å°±è¢«Votingæ§åˆ¶äº†ï¼Œå½“ç”¨æˆ·æƒ³ä½¿ç”¨Vaultçš„èµ„äº§æ—¶ï¼Œåœ¨Voting appä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æ‰§è¡ŒVaultçš„transferçš„voteï¼Œå½“æŠ•ç¥¨é€šè¿‡æ—¶ï¼Œtransferå°†ä¼šè¢«æ‰§è¡Œ</p></li><li><p>voting appå¯ä»¥å–æ¶ˆtransferçš„æƒé™</p></li></ol><h4 id="è¯¦ç»†çš„éƒ¨ç½²ç¤ºä¾‹"><a href="#è¯¦ç»†çš„éƒ¨ç½²ç¤ºä¾‹" class="headerlink" title="è¯¦ç»†çš„éƒ¨ç½²ç¤ºä¾‹"></a>è¯¦ç»†çš„éƒ¨ç½²ç¤ºä¾‹</h4><p>æ¨¡æ¿Reputationéƒ¨ç½²è¿‡ç¨‹(in templates)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//create token =&gt; in MiniMeTokenFactory.createCloneToken</span><br><span class="line">MiniMeToken newToken = new MiniMeToken(...)    </span><br><span class="line">newToken.changeController(msg.sender);        </span><br><span class="line"></span><br><span class="line">//create dao kernal acl..</span><br><span class="line">Kernel dao = Kernel(new KernelProxy(baseKernel));</span><br><span class="line">dao.initialize(baseACL, _root); //kernelçš„initialize,ä¸Šè¿°2æ­¥éª¤</span><br><span class="line"></span><br><span class="line">//åˆå§‹åŒ–Vaultèµ„é‡‘æ± ï¼Œå¦‚æœä½¿ç”¨äº†Agentå°±ä½¿ç”¨æ”¯æŒAgentçš„åˆçº¦</span><br><span class="line">Vault agentOrVault = _useAgentAsVault ? _installDefaultAgentApp(_dao) : _installVaultApp(_dao);</span><br><span class="line"></span><br><span class="line">//åˆ›å»ºFinance app</span><br><span class="line">Finance finance = _installFinanceApp(_dao, agentOrVault, _financePeriod == 0 ? DEFAULT_FINANCE_PERIOD : _financePeriod);</span><br><span class="line"></span><br><span class="line">//åˆ›å»ºToken Manager app</span><br><span class="line">TokenManager tokenManager = _installTokenManagerApp(_dao, token, TOKEN_TRANSFERABLE, TOKEN_MAX_PER_ACCOUNT);</span><br><span class="line"></span><br><span class="line">//åˆ›å»ºVoting app</span><br><span class="line">Voting voting = _installVotingApp(_dao, token, _votingSettings);</span><br><span class="line"></span><br><span class="line">//ç»™åˆå§‹åŒ–æ—¶çš„åœ°å€mintå¸ï¼Œå› ä¸ºæ•´ä¸ªç³»ç»Ÿéƒ½æ˜¯åŸºäºæƒé™ï¼Œæ‰€ä»¥ä¼šå…ˆåˆ›å»ºmintæƒé™ç»™å½“å‰ï¼ŒæŒ–å®Œå†å–æ¶ˆæ‰æƒé™</span><br><span class="line">_mintTokens(_acl, tokenManager, _holders, _stakes);</span><br><span class="line"></span><br><span class="line">//åˆ›å»ºç›¸å…³çš„æƒé™</span><br><span class="line">_setupPermissions(_acl, agentOrVault, voting, finance, tokenManager, _useAgentAsVault);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åˆ›å»ºç›¸å…³çš„æƒé™çš„ç»†èŠ‚åœ¨è¿™é‡ŒğŸ‘‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">function _setupPermissions(</span><br><span class="line">    ACL _acl,</span><br><span class="line">    Vault _agentOrVault,</span><br><span class="line">    Voting _voting,</span><br><span class="line">    Finance _finance,</span><br><span class="line">    TokenManager _tokenManager,</span><br><span class="line">    bool _useAgentAsVault</span><br><span class="line">)</span><br><span class="line">    internal</span><br><span class="line">&#123;</span><br><span class="line">    if (_useAgentAsVault) &#123;</span><br><span class="line">    //åˆ›å»ºvoting appå…·æœ‰transfer vault èµ„äº§çš„æƒé™</span><br><span class="line">        _createAgentPermissions(_acl, Agent(_agentOrVault), _voting, _voting);</span><br><span class="line">    &#125;</span><br><span class="line">    //è®¾ç½®financeå…·æœ‰transfer vault èµ„äº§çš„æƒé™</span><br><span class="line">    _createVaultPermissions(_acl, _agentOrVault, _finance, _voting);</span><br><span class="line">    </span><br><span class="line">    //è®¾ç½®ç”±votingæ¥è§¦å‘financeä¸­EXECUTE_PAYMENTS_ROLEã€MANAGE_PAYMENTS_ROLEæƒé™</span><br><span class="line">    _createFinancePermissions(_acl, _finance, _voting, _voting);</span><br><span class="line">    </span><br><span class="line">    //è®¾ç½®votingå…·æœ‰åœ¨financeä¸­åˆ›å»ºpaymentçš„æƒé™ï¼ŒCREATE_PAYMENTS_ROLEæƒé™</span><br><span class="line">    _createFinanceCreatePaymentsPermission(_acl, _finance, _voting, address(this));</span><br><span class="line">    </span><br><span class="line">    //è®¾ç½®voting å…·æœ‰evmscriptsregisteryä¸­çš„REGISTRY_MANAGER_ROLEã€REGISTRY_ADD_EXECUTOR_ROLEæƒé™</span><br><span class="line">    _createEvmScriptsRegistryPermissions(_acl, _voting, _voting);</span><br><span class="line">    </span><br><span class="line">    //è®¾ç½®votingå…·æœ‰votingçš„MODIFY_QUORUM_ROLEã€MODIFY_SUPPORT_ROLEæƒé™</span><br><span class="line">    //ä»¥åŠ_tokenManagerå…·æœ‰votingçš„CREATE_VOTES_ROLEæƒé™</span><br><span class="line">    _createVotingPermissions(_acl, _voting, _voting, _tokenManager, _voting);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    //åˆ›å»ºvoting app å…·æœ‰mintå’Œburn tokençš„æƒé™,ä¹Ÿå°±æ˜¯æŠ•ç¥¨é€šè¿‡åå¯ä»¥mint å’Œburn token</span><br><span class="line">    _createTokenManagerPermissions(_acl, _tokenManager, _voting, _voting);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="scriptåˆ†æ"><a href="#scriptåˆ†æ" class="headerlink" title="scriptåˆ†æ"></a>scriptåˆ†æ</h3><ul><li><p>exampleæ¥è‡ªä¸€ä¸ªç”±voteå‘èµ·çš„æ™®é€šnew vote<a href="https://rinkeby.etherscan.io/tx/0xd707800483616e85adabe969a675b1e8833148f6505d05c3c3b1e398e1b9ef71" target="_blank" rel="noopener">äº¤æ˜“</a>ï¼›è¿™æ˜¯é€šè¿‡aragonç½‘é¡µåˆ›å»ºçš„ä¸€ä¸ªæ™®é€šæŠ•ç¥¨ï¼Œå†…å®¹å¡«å†™çš„æ˜¯â€mintâ€</p><p>ä½¿ç”¨forwardè¿›è¡Œnew voteæ—¶ï¼Œé¦–å…ˆè¦ç¼–ç è¦è°ƒç”¨çš„scriptä¸ºnew voteï¼Œå…¶æ¬¡ï¼Œnew voteçš„ç­¾åä¸º<code>function _newVote(bytes _executionScript, string _metadata)</code>, éœ€è¦ä¼ å…¥voteé€šè¿‡åçš„æ‰§è¡Œscript</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//å¯¹dataæ•°æ®è¿›è¡Œè§£æ</span><br><span class="line"></span><br><span class="line">0x</span><br><span class="line">d948d468 //forward</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000020</span><br><span class="line">00000000000000000000000000000000000000000000000000000000000000e0</span><br><span class="line">//script</span><br><span class="line">00000001 //executorId ï¼Œrinkebyæµ‹è¯•ç½‘ä¸Šçš„idå¥½åƒåªæœ‰1</span><br><span class="line">dcc728ad010792caef6b73ab04633a22c4a9eef4 //execute  contract addressï¼Œè¿™é‡Œæ˜¯voteçš„åˆçº¦åœ°å€</span><br><span class="line">000000c4 // call data length, åé¢çš„æ•°æ®çš„é•¿åº¦</span><br><span class="line">d5db2c80 //execute method signatureï¼Œ voteä¸­è¦è°ƒç”¨æ–¹æ³•çš„ç­¾åï¼Œè¿™é‡Œå¯¹åº”æ˜¯newVoteæ–¹æ³•</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000040</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000080</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000004</span><br><span class="line">//script</span><br><span class="line">00000001 //executorId</span><br><span class="line">0000000000000000000000000000000000000000</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">46d696e74 //new voteçš„ç¬¬äºŒä¸ªå‚æ•°,asciiä¸ºmint(å­—ç¬¦)</span><br><span class="line">00000000000000000000000000000000000000000000000000000000</span><br></pre></td></tr></table></figure></li><li><p>exampleå†çœ‹ä¸€ä¸ªé€šè¿‡token manageråˆ›å»ºçš„new voteï¼Œå½“æŠ•ç¥¨é€šè¿‡åï¼Œå°†ä¼šç»™åœ°å€è½¬è´¦, <a href="https://rinkeby.etherscan.io/tx/0xf9678d1697a5310e57431fe554dbbf613c1f5a7646107831891fffbe0278bb5f" target="_blank" rel="noopener">äº¤æ˜“</a> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x</span><br><span class="line">d948d468 //forward</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000020</span><br><span class="line">00000000000000000000000000000000000000000000000000000000000000c0</span><br><span class="line">00000001 //executorId</span><br><span class="line">dcc728ad010792caef6b73ab04633a22c4a9eef4 //voteçš„åˆçº¦åœ°å€</span><br><span class="line">000000a4 //call data length</span><br><span class="line">d948d468 //newVoteæ–¹æ³•</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000020</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000060</span><br><span class="line">//new vote æ–¹æ³•å‚æ•°1ï¼Œæ‰§è¡Œè„šæœ¬</span><br><span class="line">00000001  //executorId</span><br><span class="line">ab3eca07408b8aa4db5915b2a12b193b25716c8c //execute contract address token managerçš„proxy</span><br><span class="line">00000044 //call data length</span><br><span class="line">40c10f19 //æ–¹æ³•ç­¾å mint(address,uint256)</span><br><span class="line">000000000000000000000000</span><br><span class="line">b7e84ea36c789dd576ffe46419245ea28a1e0e88 //åœ°å€</span><br><span class="line">0000000000000000000000000000000000000000000000000000000000000001  //æ•°é‡1</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>defi-compond</title>
      <link href="/2020/08/05/defi-compond/"/>
      <url>/2020/08/05/defi-compond/</url>
      
        <content type="html"><![CDATA[<h2 id="Defi-Compound"><a href="#Defi-Compound" class="headerlink" title="Defi Compound"></a>Defi Compound</h2><p>å°±CToken.solå®ç°çš„å€Ÿè´·åˆçº¦çš„ä¸­åŸºæœ¬è¿ç®—è¿›è¡Œç®€å•æºç åˆ†æã€‚</p><p>æ­¤å¤„ä¸åŒ…æ‹¬Comptrollerç›¸å…³é€»è¾‘ï¼ŒComptrolleråˆçº¦ä¸»è¦æ˜¯ç”¨äºæ ¡éªŒç”¨æˆ·çš„æ“ä½œï¼Œæ¯”å¦‚æ˜¯å¦æœ‰è¶³å¤Ÿçš„æŠµæŠ¼å“è¿›è¡Œå€Ÿè´·ç­‰ç­‰ï¼Œï¼ˆå€Ÿè´·å³æŒ–çŸ¿çš„å®ç°ä¸­ï¼Œåˆ†å‘compä»£å¸ä¹Ÿåœ¨Comptrolleråˆçº¦é‡Œï¼‰</p><h3 id="ç®€å•å‚æ•°"><a href="#ç®€å•å‚æ•°" class="headerlink" title="ç®€å•å‚æ•°"></a>ç®€å•å‚æ•°</h3><ul><li><code>reserveFactor</code>, å€¼åœ¨[0, 1]ä¹‹é—´ï¼Œæä¾›æµåŠ¨æ€§å¯è·å¾—åˆ©ç‡=è¿˜æ¬¾åˆ©ç‡ * <code>reserveFactor</code></li></ul><h3 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h3><ul><li><code>borrowIndex</code>,  å½“å‰åŒºå—é«˜åº¦çš„å€Ÿæ¬¾åˆ©ç‡</li><li><code>totalBorrows</code>, æ‰€æœ‰å€Ÿæ¬¾(å«å€Ÿæ¬¾åˆ©æ¯)</li><li><code>totalReserves</code>, æ‰€æœ‰æµåŠ¨æ€§å­˜æ¬¾è·å¾—çš„åˆ©æ¯å—ï¼Ÿ</li><li><code>accrualBlockNumber</code>,  æ›´æ–°åˆ°åŒºå—é«˜åº¦</li></ul><p>åœ¨è¿›è¡Œå­˜å‚¨/èµå›/å€Ÿæ¬¾/è¿˜æ¬¾/æ¸…ç®—â€¦çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯æ›´æ–°è¿™å‡ ä¸ªå˜é‡ï¼Œè¿™å‡ ä¸ªå˜é‡çš„å€¼å°†ä¼šå½±å“åˆ°åˆ©æ¯ç­‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//æ›´æ–°çš„ç®—æ³•</span><br><span class="line"> blockDelta = currentBlockNumber - accrualBlockNumber</span><br><span class="line"></span><br><span class="line">//(åŒºå—é—´éš”å†…)æ€»å€Ÿæ¬¾åˆ©ç‡ = åŒºå—é—´éš” * å½“å‰å€Ÿæ¬¾åˆ©ç‡ï¼›ç›¸å½“äºæ˜¯æ¯ä¸ªåŒºå—æ”¶å–åˆ©ç‡ã€‚è¿™é‡Œå°±æ˜¯è¿™æ®µåŒºå—å†…æ”¶å–çš„æ€»åˆ©ç‡</span><br><span class="line"> simpleInterestFactor = borrowRate * blockDelta</span><br><span class="line"></span><br><span class="line">//åŒºå—é—´éš”å†…ç´¯è®¡å€Ÿæ¬¾åˆ©æ¯ = (åŒºå—é—´éš”å†…)æ€»å€Ÿæ¬¾åˆ©ç‡ * æ€»å…±å€Ÿæ¬¾ï¼›è¿™æ®µåŒºå—å†…æ”¶å–çš„æ€»åˆ©æ¯</span><br><span class="line"> interestAccumulated = simpleInterestFactor * totalBorrows</span><br><span class="line"> </span><br><span class="line"> //æ€»å…±å€Ÿæ¬¾ += åŒºå—é—´éš”å†…ç´¯è®¡å€Ÿæ¬¾åˆ©æ¯</span><br><span class="line"> totalBorrows = interestAccumulated + totalBorrows</span><br><span class="line"> </span><br><span class="line"> //æ€»å…±å­˜å‚¨åˆ©æ¯ += åŒºå—é—´éš”å†…ç´¯è®¡å€Ÿæ¬¾åˆ©æ¯ * å­˜å‚¨åˆ©ç‡ </span><br><span class="line"> totalReserves = interestAccumulated * reserveFactor + totalReserves</span><br><span class="line"> </span><br><span class="line"> //å€Ÿæ¬¾åˆ©ç‡ += (åŒºå—é—´éš”å†…)æ€»å€Ÿæ¬¾åˆ©ç‡ * borrowIndex</span><br><span class="line"> borrowIndex = simpleInterestFactor * borrowIndex + borrowIndex</span><br><span class="line"> </span><br><span class="line"> //æ›´æ–°åŒºå—é«˜åº¦</span><br><span class="line"> accrualBlockNumber = currentBlockNumber</span><br></pre></td></tr></table></figure><h5 id="å­˜æ¬¾-é“¸å¸"><a href="#å­˜æ¬¾-é“¸å¸" class="headerlink" title="å­˜æ¬¾/é“¸å¸"></a>å­˜æ¬¾/é“¸å¸</h5><ul><li><p>æ›´æ–°å…¨å±€å˜é‡</p></li><li><p>å…‘æ¢ç‡è®¡ç®—(å…‘æ¢ç‡çš„ç†è§£å¯è§ä¸‹æ–¹å­˜å‚¨åˆ©æ¯çš„ç†è§£å¤„)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exchangeRate = (totalCash + totalBorrows - totalReserves) / totalSupply</span><br><span class="line">//totalCashï¼Œèµ„é‡‘æ± åˆçº¦æ‹¥æœ‰çš„åŸå¸ç§æ•°é‡</span><br><span class="line">//totalSupply,èµ„é‡‘æ± åˆçº¦å‘è¡Œçš„å¸ç§æ•°é‡</span><br></pre></td></tr></table></figure></li><li><p>å‡è®¾å­˜æ¬¾/é“¸å¸æ•°é‡ä¸ºx,  è°ƒç”¨å¯¹åº”çš„æ–¹æ³•å°†xå¯¹åº”çš„èµ„äº§è½¬ç§»åˆ°æœ¬åˆçº¦ï¼Œ</p></li><li><p>å…¶æ¬¡é“¸å¸ç»™åˆ°å¯¹åº”çš„ç”¨æˆ·åœ°å€ï¼Œé“¸å¸çš„æ•°é‡ä¸º<code>x / exchangeRate</code></p></li><li><p>æ›´æ–°<code>totalSupply</code> +=  é“¸å¸çš„æ•°é‡</p></li></ul><h5 id="èµå›"><a href="#èµå›" class="headerlink" title="èµå›"></a>èµå›</h5><ul><li>æ›´æ–°å…¨å±€å˜é‡</li><li>å…‘æ¢ç‡è®¡ç®—<code>exchangeRate = (totalCash + totalBorrows - totalReserves) / totalSupply</code></li><li>å‡è®¾ä¼ å…¥çš„æ˜¯æœ¬èµ„é‡‘æ± çš„ä»£å¸æ•°é‡<code>redeemTokensIn</code>ï¼Œé‚£ä¹ˆè¦èµå›çš„åŸèµ„äº§æ•°é‡ä¸º<code>redeemAmount = redeemTokensIn * exchangeRateCurrent</code></li><li>è°ƒç”¨ç›¸å…³æ–¹æ³•åŸèµ„äº§ä»æœ¬åˆçº¦è½¬ç§»åˆ°ç”¨æˆ·åœ°å€</li><li>å‡è®¾ä¼ å…¥çš„æ˜¯åŸèµ„äº§æ•°é‡<code>redeemAmountIn</code>ï¼Œè¦ä¹ˆå¯¹åº”åˆ°æœ¬åˆçº¦èµ„äº§ä»£å¸æ•°é‡ä¸º<code>redeemTokensIn = redeemAmountIn / exchangeRate</code>;è¦è®¡ç®—æœ¬åˆçº¦èµ„äº§ä»£å¸æ•°é‡ï¼Œæ˜¯ä¸ºäº†ä¿®æ”¹<code>totalSupply</code>ç­‰</li><li>æ›´æ–°<code>totalSupply</code> -= èµå›çš„æœ¬åˆçº¦ä»£å¸æ•°é‡(<code>redeemTokensIn</code>); æ›´æ–°ç”¨æˆ·è´¦æˆ·ä½™é¢ -= èµå›çš„æœ¬åˆçº¦ä»£å¸æ•°é‡(<code>redeemTokensIn</code>);</li></ul><p>é€šè¿‡å…‘æ¢ç‡çš„è®¡ç®—æ–¹å¼ï¼Œå¯ä»¥ç®€å•æ¨æµ‹ï¼Œ</p><ul><li>å½“å­˜å…¥åï¼Œå‡è®¾èµ„é‡‘æ± æ€»å­˜å…¥ä¸å˜ï¼ŒtotalBorrowså¢å¤šï¼Œé‚£ä¹ˆèµå›æ—¶æ”¶è·çš„åˆ©æ¯å°±ä¼šå¢å¤š</li></ul><h5 id="å€Ÿæ¬¾"><a href="#å€Ÿæ¬¾" class="headerlink" title="å€Ÿæ¬¾"></a>å€Ÿæ¬¾</h5><ul><li><p>æ›´æ–°å…¨å±€å˜é‡</p></li><li><p>æ›´æ–°å€Ÿæ¬¾äººçš„æ€»æ¬ æ¬¾=ï¼ˆå¦‚å·²æœ‰æ¬ æ¬¾ï¼Œæ¬ æ¬¾+åˆ©æ¯ï¼‰ + æ–°å€Ÿæ¬¾æ•°é‡</p></li><li><p>æ›´æ–°å€Ÿæ¬¾äººçš„<code>interestIndex</code>ä¸º<code>borrowIndex</code></p></li><li><p>æ›´æ–°å…¨å±€æ€»å€Ÿæ¬¾<code>totalBorrows</code> +=  æ–°å€Ÿæ¬¾æ•°é‡</p></li><li><p>è°ƒç”¨ç›¸å…³æ–¹æ³•å°†å€Ÿæ¬¾æ•°é‡èµ„äº§ä»æœ¬åˆçº¦è½¬å‡ºåˆ°ç”¨æˆ·åœ°å€</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢å€Ÿæ¬¾äººæ€»å…±åº”è¿˜æ¬¾æ•°é‡å¦‚ä¸‹</span><br><span class="line">//update BorrowIndex to current index</span><br><span class="line">recentBorrowBalance = borrower.borrowBalance * market.borrowIndex / borrower.borrowIndex</span><br><span class="line">//æ¬ æ¬¾æ€»é¢ * å…¨å±€borrowIndex / å€Ÿæ¬¾æ—¶çš„borrowIndex</span><br><span class="line">//å½“å…¨å±€borrowIndexç›¸å¯¹å€Ÿæ—¶æ¶¨äº†ï¼Œé‚£ä¹ˆæ¬ æ¬¾ä¹Ÿä¼šå¢åŠ ï¼›å¦‚æœè·Œäº†ï¼Œé‚£ä¹ˆæ¬ æ¬¾ä¹Ÿä¼šå‡å°‘</span><br></pre></td></tr></table></figure><h5 id="è¿˜æ¬¾"><a href="#è¿˜æ¬¾" class="headerlink" title="è¿˜æ¬¾"></a>è¿˜æ¬¾</h5><ul><li>æ›´æ–°å…¨å±€å˜é‡</li><li>æ€»æ¬ æ¬¾æ•°é‡ä¸º<code>borrower.borrowBalance * market.borrowIndex / borrower.borrowIndex</code></li><li>è°ƒç”¨ç›¸å…³æ–¹æ³•å°†è¿˜æ¬¾æ•°é‡èµ„äº§ä»ç”¨æˆ·åœ°å€è½¬å…¥åˆ°æœ¬åˆçº¦</li><li>æ›´æ–°ç”¨æˆ·å‰©ä½™æ¬ æ¬¾ï¼Œæ›´æ–°<code>totalBorrows</code> -= è¿˜æ¬¾æ•°é‡</li></ul><h5 id="æ¸…ç®—"><a href="#æ¸…ç®—" class="headerlink" title="æ¸…ç®—"></a>æ¸…ç®—</h5><p>ç”±æ¸…ç®—äººè§¦å‘æ¸…ç®—</p><ul><li>æ›´æ–°å…¨å±€å˜é‡</li><li>æ¸…ç®—äººå°†ä»è‡ªå·±çš„è´¦æˆ·ä¸­å¿è¿˜æ¸…ç®—å€Ÿæ¬¾äººçš„æ‰€æœ‰å€ºåŠ¡</li><li>å°†å€ºåŠ¡å¯¹åº”çš„å€Ÿæ¬¾äººæŠµæŠ¼å“ï¼Œè½¬ç§»åˆ°æ¸…ç®—äººè´¦æˆ·ä¸­</li></ul><p>â€»æ¸…ç®—æ¡ä»¶</p><p>è¿™é‡Œå‡è®¾ç”¨æˆ·åœ¨ethèµ„é‡‘æ± ä¸­å­˜æ¬¾xä¸ªcethï¼ˆå­˜æ¬¾å¯ç›´æ¥ä½œä¸ºæŠµæŠ¼å“ï¼‰ï¼Œåœ¨daièµ„é‡‘æ± ä¸­å€Ÿå‡ºyä¸ªdaiï¼›</p><p>è¿™é‡Œæåˆ°<code>æŠµæŠ¼å› å­</code>ä¸ºå¯è´·ä»·å€¼ä¸º<code>åŸæŠµæŠ¼ä»·å€¼ * æŠµæŠ¼å› å­</code>, <code>æŠµæŠ¼å› å­</code>çš„å€¼åœ¨0åˆ°1ä¹‹é—´ï¼›</p><ul><li><p>éå†ç”¨æˆ·å‚ä¸compoundçš„æ‰€æœ‰èµ„äº§ï¼Œä¾‹å­ä¸­ä¸ºethå’Œdaiä¸¤ç§</p></li><li><p>åˆ†åˆ«ç»Ÿè®¡å­˜æ¬¾å¯è´·ä»·å€¼æ€»å’Œï¼Œå’Œæ¬ æ¬¾(åŒ…æ‹¬åˆ©æ¯)ä»·å€¼æ€»å’Œ</p><ul><li>å­˜æ¬¾å¯è´·ä»·å€¼çš„è®¡ç®—æ–¹å¼ä¸º<code>price * æŠµæŠ¼å› å­ * å…‘æ¢ç‡ * ç”¨æˆ·æ‹¥æœ‰çš„ctoken</code></li><li>æ¬ æ¬¾ä»·å€¼çš„è®¡ç®—æ–¹å¼ä¸º<code>price *  æ¬ æ¬¾</code></li></ul></li><li><p>æ‰€ä»¥ç”¨æˆ·çš„å­˜æ¬¾å¯è´·ä»·å€¼æ€»å’Œä¸º <code>ethä»·æ ¼ * æŠµæŠ¼å› å­ * cethå…‘æ¢ç‡ * x</code>; æ¬ æ¬¾ä»·å€¼æ€»å’Œä¸º<code>daiä»·æ ¼ * (y+åˆ©æ¯)</code></p></li><li><p>å½“ç”¨æˆ·çš„å­˜æ¬¾å¯è´·ä»·å€¼æ€»å’Œ &lt; æ¬ æ¬¾ä»·å€¼æ€»å’Œæ—¶ï¼Œå°†æ¸…ç®—ç”¨æˆ·çš„æŠµæŠ¼å“(å­˜æ¬¾) (ä¸€ä¸ªäº¤æ˜“åªèƒ½æ¸…ç®—ä¸€ç§æŠµæŠ¼å“)</p></li></ul><h3 id="è®¡ç®—ç¤ºä¾‹"><a href="#è®¡ç®—ç¤ºä¾‹" class="headerlink" title="è®¡ç®—ç¤ºä¾‹"></a>è®¡ç®—ç¤ºä¾‹</h3><p>å‡è®¾å½“å‰ä¸ºä¸–ç•Œæœ€åˆçŠ¶æ€ï¼Œä¸€åˆ‡éƒ½è¿˜æ²¡å¼€å§‹ï¼Œæ²¡æœ‰å­˜æ¬¾ï¼Œæ²¡æœ‰å€Ÿæ¬¾ï¼Œé‚£ä¹ˆç›¸å…³å‚æ•°çš„å€¼å¦‚ä¸‹</p><ul><li><code>exchangeRate</code> ï¼Œå‡è®¾å…‘æ¢ç‡åˆå§‹å€¼ä¸º2(å½“<code>totalSupply</code>=0æ—¶ï¼Œä½¿ç”¨åˆå§‹å€¼)</li><li><code>borrowIndex</code>ï¼Œåˆå§‹å€¼ä¸º1 (ä»£ç è®¾ç½®)</li><li><code>totalBorrows</code>ï¼Œæ‰€æœ‰å€Ÿæ¬¾ä¸º0ï¼Œ<code>totalReserves</code>ä¹Ÿä¸º0 </li><li><code>borrowRate</code>ï¼Œå‡è®¾å€Ÿè´·ç‡ä¸º0.05(æŒ‰å—è®¡ç®—)</li><li><code>reserveFactor</code>ï¼ŒæŒ‰ç…§ä¹‹å‰çš„å‡è®¾ï¼Œreverseä¸ºå¹³å°æ”¶å–çš„è´¹ç”¨ï¼Œå‡è®¾<code>reserveFactor</code>åˆ©ç‡ä¸º0.1</li></ul><ol><li>ç°åœ¨ï¼Œç”¨æˆ·Aå­˜å…¥100eth, å¯è·å¾—xethçš„æ•°é‡ä¸º<code>100 / å…‘æ¢ç‡</code>ï¼Œåœ¨ç”¨æˆ·Aå­˜å…¥ä¹‹å‰ï¼Œå½“å‰æ˜¯åˆå§‹çŠ¶æ€ï¼Œ<code>totalSupply</code>=0ï¼Œæ‰€ä»¥å…‘æ¢ç‡ä¸º2ã€‚é‚£ä¹ˆç”¨æˆ·Aå­˜å…¥100ethæ—¶å¯è·å¾—<code>100 / 2 = 50xeth</code>;  åŒæ—¶ï¼Œ<code>totalSupply</code>å°†ä¸º <code>0 + 50 = 50</code>ï¼Œ<code>totalCash</code>æ›´æ–°ä¸º100</li></ol><p>æ ¹æ®å…‘æ¢ç‡çš„è®¡ç®—å…¬å¼ä¸º<code>(totalCash + totalBorrows - totalReserves) / totalSupply</code>ï¼Œï¼ˆ<code>totalCash</code>ä¸ºå­˜å‚¨åŸèµ„äº§ethçš„æ€»å’Œï¼Œ<code>totalSupply</code>ä¸ºæ­¤åˆçº¦å¸xethé“¸å¸æ€»å’Œï¼‰ã€‚å‡è®¾æ²¡æœ‰å€Ÿæ¬¾æ—¶ï¼Œ<code>totalBorrows</code> ,<code>totalReserves</code>éƒ½ä¸º0ï¼Œ å‡è®¾ç”¨æˆ·Aèµå›50xethå°†è·å¾—çš„ethä¸º<code>50 * å…‘æ¢ç‡</code>, è€Œå…‘æ¢ç‡<code>ï¼ˆ100 + 0 - 0) / 50= 2</code>, æ‰€ä»¥Aå°†è·å¾—100ethï¼›ç”¨æˆ·Aå‘ç°æ²¡æœ‰å‘ç”Ÿå€Ÿæ¬¾ï¼Œå°±æ²¡å¾—åˆ©æ¯ï¼Œç”¨æˆ·Aæ­¤æ—¶å¹¶ä¸æ‰“ç®—èµå›ï¼Œä»–æƒ³ç­‰èµšåˆ°åˆ©æ¯äº†å†èµå›ã€‚</p><p>â€‹        å‡è®¾å½“å‰åŒºå—é«˜åº¦ä¸º10ï¼Œ<code>borrowIndex</code>æŒ‰ç…§å…¬å¼<code>borrowRate * blockDelta * borrowIndex + borrowIndex</code>å°†æ›´æ–°ä¸º<code>ï¼ˆ10 * 0.05ï¼‰ * 1 + 1 = 1.5</code></p><ol start="2"><li><p>ç”¨æˆ·Båœ¨åŒºå—é«˜åº¦100å¤„ï¼Œå€Ÿèµ°äº†50ä¸ªeth; åœ¨æ­¤ä¹‹å‰æ²¡æœ‰å¦å¤–çš„å€Ÿæ¬¾ï¼Œæ‰€ä»¥æ ¹æ®å…¬å¼ï¼Œ<code>totalBorrows</code>,<code>totalReserves</code>ç»´æŒä¸å˜ï¼Œåˆ†åˆ«ä¸º0,0; <code>borrowIndex</code>æŒ‰ç…§å…¬å¼<code>borrowRate * blockDelta * borrowIndex + borrowIndex</code>å°†æ›´æ–°ä¸º<code>90 * 0.05 * 1.5 + 1.5 = 8.25</code>, ç„¶ååœ¨Bå€Ÿèµ°50çš„æ—¶ï¼ŒBå€Ÿ50æ—¶çš„<code>borrowIndex</code>ä¸º8.25, <code>totalBorrows</code>å°†æ›´æ–°ä¸º<code>50</code>ã€‚</p></li><li><p>åœ¨åŒºå—é«˜åº¦200å¤„ï¼Œæˆ‘ä»¬æ¥è®¡ç®—æ‰€æœ‰çš„åˆ©æ¯ï¼›å‡è®¾åœ¨æ­¤æœŸé—´ä¹Ÿå¹¶æ²¡æœ‰å‘ç”Ÿä»»ä½•å€Ÿæ¬¾/è¿˜æ¬¾/å­˜æ¬¾/èµå›ç­‰æ“ä½œã€‚</p><p>é¦–å…ˆå°†æ›´æ–°å…¨å±€å˜é‡ä»¬ï¼›è·ç¦»åŒºå—é«˜åº¦100åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œç»å†äº†100ä¸ªåŒºå—ï¼›</p><p>è¿™100ä¸ªåŒºå—çš„æ¯è´§å¸å€Ÿè´·çš„åˆ©ç‡ä¸º<code>100 * borrowRate = 100 * 0.05= 5</code></p><p>æ€»å…±æœ‰50ä¸ªå€Ÿè´·çš„è´§å¸ï¼Œé‚£ä¹ˆ50ä¸ªè´§å¸äº§ç”Ÿçš„åˆ©æ¯ä¸º<code>50 * 5 = 250</code></p><p><code>totalBorrows = totalBorrows + åˆ©æ¯</code>ï¼Œ<code>totalBorrows</code>å°†æ›´æ–°ä¸º<code>50 + 250 = 300</code></p><p><code>totalReserves = totalReserves + reserveFactor * åˆ©æ¯</code>ï¼Œ  <code>totalReserves</code>å°†æ›´æ–°ä¸º<code>0 + 250 * 0.1 = 25</code></p><p><code>borrowIndex</code>æŒ‰ç…§å…¬å¼å°†æ›´æ–°ä¸º<code>5 * 8.25 + 8.25 = 49.5</code>ï¼ˆå¤åˆ©ï¼Ÿï¼‰</p></li></ol><p>   ç”¨æˆ·Båœ¨æ­¤æ—¶è¦å¿è¿˜å€ºåŠ¡ï¼Œä»–æ¬ æ¬¾æ€»é¢ä¸º<code>æ¬ æ¬¾æ€»é¢ * å…¨å±€borrowIndex / å€Ÿæ¬¾æ—¶çš„borrowIndex</code>ï¼ŒæŒ‰ç…§å…¬å¼å¥—å…¥è®¡ç®—ä¸º<code>50 * 49.5 / 8.25 = 300</code>ã€‚ä¹Ÿå°±æ˜¯è¯´Bå°†å¿è¿˜<code>300eth</code>æ‰èƒ½è¿˜æ¸…å€ºåŠ¡ã€‚</p><pre><code>ç”¨æˆ·Aåœ¨æ­¤æ—¶é€‰æ‹©èµå›ï¼Œæ­¤æ—¶çš„å…‘æ¢ç‡ä¸º`(50 + 300 - 25)/50=6.5`; é‚£ä¹ˆAå°†è·å¾—`50xeth * 6.5= 325eth`</code></pre><p>   ç„¶åæˆ‘ä»¬å†æ¥çœ‹çœ‹ç»“è®ºï¼Œåœ¨Bè¿˜æ¸…å€ºåŠ¡åï¼Œæ± å­é‡Œæ€»å…±æœ‰<code>50 + 300 = 350</code>ä¸ªethï¼ŒAèµå›æ—¶æ‹¿èµ°<code>325</code>ä¸ª<code>eth</code>; <code>xeth</code>å®Œå…¨é”€æ¯ï¼Œæ± å­é‡Œå‰©ä½™<code>350 - 325 = 25</code>eth, åˆšå¥½å°±æ˜¯<code>totalReserves</code>çš„æ•°é‡ã€‚å®Œå…¨å»åˆã€‚</p><p>   è™½ç„¶è®¡ç®—è¿‡ç¨‹å¾ˆå¤æ‚ï¼Œç”šè‡³æœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œä½†æ„Ÿè§‰å·¨ç¥å¥‡ã€‚</p><h3 id="ç†è§£å…¬å¼"><a href="#ç†è§£å…¬å¼" class="headerlink" title="ç†è§£å…¬å¼"></a>ç†è§£å…¬å¼</h3><h5 id="å­˜å‚¨åˆ©æ¯çš„ç†è§£"><a href="#å­˜å‚¨åˆ©æ¯çš„ç†è§£" class="headerlink" title="å­˜å‚¨åˆ©æ¯çš„ç†è§£"></a>å­˜å‚¨åˆ©æ¯çš„ç†è§£</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exchangeRate = (totalCash + totalBorrows - totalReserves) / totalSupply</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼Œæˆ‘ä»¬å‡è®¾è¿™æ˜¯ä¾›åº”ethèµ„é‡‘æ± ï¼Œä¾›åº”eth, äº§ç”Ÿcethã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//å­˜å…¥eth nä¸ªï¼Œå¯è·å¾—mä¸ªcethï¼Œå…¶ä¸­</span><br><span class="line">m = n / exchangeRate</span><br><span class="line"></span><br><span class="line">//èµå›æ—¶ï¼Œå¯è·å¾—çš„eth = m * exchangeRate</span><br></pre></td></tr></table></figure><ol><li><p>é¦–å…ˆ</p><p>å‡è®¾åˆå§‹exchangeRate=2ï¼Œé‚£ä¹ˆAå­˜å…¥100eth,å°†è·å¾—50ceth(100 / 2);æ­¤åï¼Œ<code>exchangeRate =100/50</code></p><p>å‡è®¾Cå†å­˜å…¥100ethï¼Œé‚£ä¹ˆCå°†è·å¾—çš„cethä¸º50(100 / 2),æ­¤åï¼Œ<code>exchangeRate = (100 + 100)/ (50 + 50)</code></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“<code>x / y = z;</code>æ—¶ï¼Œ<code>(x + nz)/(y + n)</code>è¿˜æ˜¯ç­‰äºz; å¯ä»¥é€šè¿‡ç®€å•çš„æ•°å­¦å…¬å¼æ¥éªŒç®—ï¼›</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x / y = z;</span><br><span class="line">x = y * z;</span><br><span class="line">x + m = (y + n)*z //å½“åˆ†å­åˆ†æ¯åˆ†åˆ«åŠ ä¸Š m nï¼Œè¦è¾¾åˆ°å·¦å³ä¾æ—§ç›¸ç­‰ï¼Œé‚£ä¹ˆm = nz</span><br></pre></td></tr></table></figure><p><strong>ç»“è®ºï¼š</strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œå­˜å…¥ethåï¼Œ<code>exchangeRate</code>å°†ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåªæœ‰å€Ÿè´·äº§ç”Ÿåˆ©æ¯ï¼Œæ‰ä¼šå½±å“<code>exchangeRate</code>çš„å€¼</p><p>å…¶ä¸­ï¼Œ<code>totalCash</code> + <code>totalBorrows</code>  = <code>èµ„é‡‘æ± ä¸­å­˜å…¥çš„æ€»ä¾›åº”</code> + <code>å€Ÿè´·äº§ç”Ÿçš„åˆ©æ¯</code></p><p>é‚£ä¹ˆ<code>(totalCash + totalBorrows - totalReserves)</code>ä¸ºé™¤äº†å¸‚åœº(åˆçº¦æœ¬èº«/ä¸­é—´å•†)æ”¶å–çš„<code>Reserves</code>ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ethæ€»é‡(åŒ…æ‹¬å€Ÿå‡ºå»çš„å’Œå€Ÿåˆ©æ¯)ï¼›</p><ol start="2"><li><p>å…¶æ¬¡ </p><p>å‡è®¾ï¼Œå½“å­˜å…¥nä¸ªethæ—¶<code>exchangeRate = (ethæ€»ä¾›åº” + åˆ©æ¯ï¼‰/ cethæ€»é‡</code>; è·å¾—mä¸ªceth</p><p>å½“èµå›<code>exchangeRate1 = (ethæ€»ä¾›åº”1 + åˆ©æ¯1ï¼‰/ cethæ€»é‡1</code>ï¼Œç°åœ¨è¦èµå›mä¸ªceth,å¯è·å¾—çš„ethä¸ºï¼Ÿ      </p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//å¯è·å¾—çš„ethä¸º</span><br><span class="line">m * exchangeRate1 = m *  (ethæ€»ä¾›åº”1 + åˆ©æ¯1ï¼‰/ cethæ€»é‡1</span><br><span class="line">= n / [(ethæ€»ä¾›åº” + åˆ©æ¯ï¼‰/ cethæ€»é‡] * [(ethæ€»ä¾›åº”1 + åˆ©æ¯1ï¼‰/ cethæ€»é‡1]</span><br><span class="line">= n * [cethæ€»é‡ / (ethæ€»ä¾›åº” + åˆ©æ¯)] * [(ethæ€»ä¾›åº”1 + åˆ©æ¯1ï¼‰/ cethæ€»é‡1]</span><br><span class="line">//æ ¹æ®1çš„ç»“è®ºï¼Œå¯å˜å¼ä¸º</span><br><span class="line">= n * [cethæ€»é‡ / (ethæ€»ä¾›åº” + åˆ©æ¯)] * &#123;[(ethæ€»ä¾›åº” + åˆ©æ¯) / cethæ€»é‡] + [(åˆ©æ¯1 - åˆ©æ¯) / cethæ€»é‡1]&#125;</span><br><span class="line">  = n + n * [cethæ€»é‡ / (ethæ€»ä¾›åº” + åˆ©æ¯)] * [(åˆ©æ¯1 - åˆ©æ¯) / cethæ€»é‡1]</span><br><span class="line">  = n + m * [(åˆ©æ¯1 - åˆ©æ¯) / cethæ€»é‡1</span><br></pre></td></tr></table></figure><p><strong>ç»“è®ºï¼š</strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“èµå›æ—¶ï¼Œ<font color="red">è‡³å°‘å¯è·å¾—å½“æ—¶å­˜å…¥çš„nä¸ªethï¼Œä»¥åŠè·å¾—ä»å­˜å…¥æ—¶åˆ°èµå›è¿™æœŸé—´äº§ç”Ÿçš„åˆ©æ¯ï¼Œåˆ©æ¯çš„åˆ†é…æ–¹å¼ä¹˜ä»¥æ‹¥æœ‰çš„mä¸ªcethå cethæ€»é‡çš„æ¯”ä¾‹</font>ï¼›</p>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>binance-tss</title>
      <link href="/2020/07/27/binance-tss/"/>
      <url>/2020/07/27/binance-tss/</url>
      
        <content type="html"><![CDATA[<h2 id="Tssæºç åˆ†æ"><a href="#Tssæºç åˆ†æ" class="headerlink" title="Tssæºç åˆ†æ"></a>Tssæºç åˆ†æ</h2><p><a href="https://github.com/binance-chain/tss-lib">Binance tssåº“</a>æ˜¯æä¾›å¤šç­¾çš„åº“ã€‚è¿™é‡Œå°†ç®€å•è¿‡ä¸‹æºç ã€‚</p><p>åœ¨<code>ecdsa</code>åŒ…ä¸‹çš„ç»“æ„ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ keygen</span><br><span class="line">â”œâ”€â”€ resharing</span><br><span class="line">â””â”€â”€ signing</span><br></pre></td></tr></table></figure><p><code>keygen</code>ä¸ºåˆ›å»ºå¤šç­¾ç§é’¥æä¾›æ”¯æŒï¼›</p><p><code>resharding</code>ä¸ºä¿®æ”¹å¤šç­¾ä¸­çš„å‚ä¸è€…ï¼Œé‡æ–°åˆ†é…è®¡ç®—ç§é’¥(å…±äº«å…¬é’¥ä¸ä¼šå‘ç”Ÿæ”¹å˜)æä¾›æ”¯æŒï¼›</p><p><code>signing</code> ä¸ºå¤šç­¾æä¾›æ”¯æŒï¼›</p><p>å†æ‰“å¼€è¿™ä¸‰ä¸ªåŒ…ä¸‹çš„æ–‡ä»¶ç»“æ„è¿˜è›®æ¸…æ™°çš„ï¼Œç»“æ„éƒ½ç±»ä¼¼ï¼›åˆ†åˆ«éƒ½åŒ…å«<code>message.go</code>ã€<code>local_party.go</code>ã€<code>round_*</code>ç­‰æ–‡ä»¶ã€‚</p><h3 id="å¤§ä½“ç»“æ„"><a href="#å¤§ä½“ç»“æ„" class="headerlink" title="å¤§ä½“ç»“æ„"></a>å¤§ä½“ç»“æ„</h3><p>å…ˆè¯´ç»“è®º</p><ul><li>æ¯ä¸ªå‚ä¸è€…éƒ½éœ€è¦ä¸€ä¸ªpartyIDæ¥æ ‡è¯†èº«ä»½ï¼Œå¹¶ä¸”ï¼Œç®—æ³•å¼€å§‹å‰ï¼Œéœ€è¦æ‹¿åˆ°æ‰€æœ‰å‚ä¸è€…çš„partyIDï¼Œå¹¶æŒ‰Keyè¿›è¡Œæ’åº</li><li>å®ç°ç”±partyå’Œroundå®šä¹‰ï¼Œpartyç»Ÿè®¡æ•°æ®ï¼Œå¹¶è°ƒç”¨roundã€‚roundå‘å‡ºå»ä¿¡æ¯å¹¶æ ¹æ®æ”¶åˆ°åˆ«çš„å‚ä¸è€…çš„æ¶ˆæ¯è¿›è¡Œè®¡ç®—å˜æ¢çŠ¶æ€</li></ul><p>åŒæ ·ï¼Œä»¥æµ‹è¯•<code>Keygen.local_party_test.go</code>ä¸¾ä¾‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">func TestStartRound1Paillier(t *testing.T) &#123;</span><br><span class="line">setUp(&quot;debug&quot;)</span><br><span class="line"></span><br><span class="line">pIDs := tss.GenerateTestPartyIDs(1)</span><br><span class="line">p2pCtx := tss.NewPeerContext(pIDs)</span><br><span class="line">threshold := 1</span><br><span class="line">params := tss.NewParameters(p2pCtx, pIDs[0], len(pIDs), threshold)</span><br><span class="line"></span><br><span class="line">out := make(chan tss.Message, len(pIDs))</span><br><span class="line">lp := NewLocalParty(params, out, nil).(*LocalParty)</span><br><span class="line">if err := lp.Start(); err != nil &#123;</span><br><span class="line">assert.FailNow(t, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&lt;-out</span><br><span class="line"></span><br><span class="line">// Paillier modulus 2048 (two 1024-bit primes)</span><br><span class="line">// round up to 256, it was used to be flaky, sometimes comes back with 1 byte less</span><br><span class="line">len1 := len(lp.data.PaillierSK.LambdaN.Bytes())</span><br><span class="line">len2 := len(lp.data.PaillierSK.PublicKey.N.Bytes())</span><br><span class="line">if len1%2 != 0 &#123;</span><br><span class="line">len1 = len1 + (256 - (len1 % 256))</span><br><span class="line">&#125;</span><br><span class="line">if len2%2 != 0 &#123;</span><br><span class="line">len2 = len2 + (256 - (len2 % 256))</span><br><span class="line">&#125;</span><br><span class="line">assert.Equal(t, 2048/8, len1)</span><br><span class="line">assert.Equal(t, 2048/8, len2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå‚ä¸è€…ä¸º1ï¼Œé˜ˆå€¼ä¸º1çš„ç”Ÿæˆç§é’¥æ•°æ®æµ‹è¯•ï¼›</p><h5 id="é¦–å…ˆtss-GenerateTestPartyIDs"><a href="#é¦–å…ˆtss-GenerateTestPartyIDs" class="headerlink" title="é¦–å…ˆtss.GenerateTestPartyIDs"></a>é¦–å…ˆ<code>tss.GenerateTestPartyIDs</code></h5><p>å¤šä¸ªäººå‚ä¸çš„å¤šé‡ç­¾åï¼Œä¹‹å‰çœ‹åˆ°çš„åˆ«çš„å¤šç­¾ç®€å•ç‚¹æ¥è¯´å°±æ˜¯å°†ä¸€ä¸ªç§é’¥åˆ†ç»™å¤šä¸ªäººï¼Œæ¯ä¸ªäººæ‹¥æœ‰ä¸€éƒ¨åˆ†å‚æ•°ï¼Œé‚£ä¹ˆå°±åƒç©æ‹¼å›¾ä¸€æ ·ï¼Œè¿™äº›äººåº”è¯¥æ˜¯æœ‰åºçš„ï¼Œæ‹†åˆ†çš„æ—¶å€™å°±æŒ‰é¡ºåºåˆ†ç»™æ¯ä¸ªäººï¼Œç»„è£…çš„æ—¶å€™åŒæ ·æŒ‰ç…§é¡ºåºè¿›è¡Œç»„è£…ï¼›æ‰€ä»¥è¿™é‡Œä¹Ÿç±»ä¼¼ï¼Œå‚ä¸è€…ä»¬éƒ½æ˜¯æœ‰é¡ºåºçš„ã€‚</p><p><code>GenerateTestPartyIDs</code>æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">func GenerateTestPartyIDs(count int, startAt ...int) SortedPartyIDs &#123;</span><br><span class="line">ids := make(UnSortedPartyIDs, 0, count)</span><br><span class="line">key := common.MustGetRandomInt(256)</span><br><span class="line">frm := 0</span><br><span class="line">i := 0 // default `i`</span><br><span class="line">if len(startAt) &gt; 0 &#123;</span><br><span class="line">frm = startAt[0]</span><br><span class="line">i = startAt[0]</span><br><span class="line">&#125;</span><br><span class="line">for ; i &lt; count+frm; i++ &#123;</span><br><span class="line">ids = append(ids, &amp;PartyID&#123;</span><br><span class="line">MessageWrapper_PartyID: &amp;MessageWrapper_PartyID&#123;</span><br><span class="line">Id:      fmt.Sprintf(&quot;%d&quot;, i+1),  </span><br><span class="line">Moniker: fmt.Sprintf(&quot;P[%d]&quot;, i+1), //ä¸ºäº†è¾…åŠ©äººä¸ºè¯†åˆ«æ˜¯å“ªä¸ªå‚ä¸è€…</span><br><span class="line">Key:     new(big.Int).Sub(key, big.NewInt(int64(count)-int64(i))).Bytes(),</span><br><span class="line">&#125;,</span><br><span class="line">Index: i,</span><br><span class="line">// this key makes tests more deterministic</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">return SortPartyIDs(ids, startAt...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•è¿”å›çš„<code>SortedPartyIDs</code>æ˜¯PartyIDæœ‰åºæ•°ç»„(æŒ‰ç…§Keyçš„å¤§å°è¿›è¡Œæ’åº)ï¼Œ{PartyIDå®ä¾‹}.Indexå…¶å®å°±æ˜¯è¯¥å®ä¾‹æ‰€åœ¨çš„é¡ºåºï¼›</p><h5 id="å…¶æ¬¡"><a href="#å…¶æ¬¡" class="headerlink" title="å…¶æ¬¡"></a>å…¶æ¬¡</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//å‰é¢ç»„è£…äº†å¤šä¸ªå‚ä¸è€…pIDsï¼Œå¹¶ç”±pIDsç»„è£…contextï¼Œå†ç”±contextç»„è£…params, paramsè¿˜åŒ…æ‹¬må‚ä¸è€…né˜ˆå€¼çš„å‚æ•°ï¼Œoutä¸ºè¾“å‡ºchannel</span><br><span class="line">lp := NewLocalParty(params, out, nil).(*LocalParty)</span><br><span class="line">if err := lp.Start(); err != nil &#123;</span><br><span class="line">assert.FailNow(t, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&lt;-out</span><br></pre></td></tr></table></figure><p><code>Start()</code>æ–¹æ³•ï¼Œä¸º<code>tss/Party</code>çš„å®ç°,ä¸»è¦é‡å†™çš„æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">type Party interface &#123;</span><br><span class="line">Start() *Error</span><br><span class="line">//æ›´æ–°æ¥æ”¶åˆ°çš„æ¥è‡ªå‚ä¸è€…çš„æ¶ˆæ¯</span><br><span class="line">UpdateFromBytes(wireBytes []byte, from *PartyID, isBroadcast bool) (ok bool, err *Error)</span><br><span class="line">//æ›´æ–°æ¥æ”¶åˆ°çš„æ¥è‡ªå‚ä¸è€…çš„æ¶ˆæ¯</span><br><span class="line">Update(msg ParsedMessage) (ok bool, err *Error)</span><br><span class="line">Running() bool</span><br><span class="line">WaitingFor() []*PartyID</span><br><span class="line">ValidateMessage(msg ParsedMessage) (bool, *Error)</span><br><span class="line">StoreMessage(msg ParsedMessage) (bool, *Error)</span><br><span class="line">FirstRound() Round </span><br><span class="line">WrapError(err error, culprits ...*PartyID) *Error</span><br><span class="line">PartyID() *PartyID</span><br><span class="line">String() string</span><br><span class="line"></span><br><span class="line">// Private lifecycle methods</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>tss</code>åŒ…ä¸‹<code>Party</code>å®šä¹‰çš„åŒæ–‡ä»¶ï¼Œå®šä¹‰äº†<code>BaseStart</code>æ–¹æ³•ï¼Œå¤§å®¶å®ç°çš„Partyçš„<code>Start</code>æ–¹æ³•éƒ½æ˜¯è°ƒç”¨çš„<code>BaseStart</code>æ–¹æ³•ï¼Œåœ¨<code>BaseStart</code>æ–¹æ³•ä¸­ï¼Œè®¾ç½®äº†åˆå§‹è¿è¡Œçš„ä¸º<code>FirstRound</code>è¿”å›çš„Roundï¼›</p><p>RoundåŒæ ·ä¸ºæ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type Round interface &#123;</span><br><span class="line">Params() *Parameters</span><br><span class="line">Start() *Error</span><br><span class="line">Update() (bool, *Error)</span><br><span class="line">RoundNumber() int</span><br><span class="line">CanAccept(msg ParsedMessage) bool</span><br><span class="line">CanProceed() bool</span><br><span class="line">NextRound() Round </span><br><span class="line">WaitingFor() []*PartyID</span><br><span class="line">WrapError(err error, culprits ...*PartyID) *Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç±»ä¼¼äºçŠ¶æ€æœºï¼Œä¸€ä¸ªæ¥ä¸€ä¸ª..<code>Start</code>æ–¹æ³•è®¡ç®—å‡ºæŸäº›æ•°æ®ï¼Œå‘å‘åˆ«çš„å‚ä¸è€…ï¼Œç„¶åç­‰å¾…æ¥æ”¶åˆ°è¶³å¤Ÿçš„æ¥è‡ªåˆ«çš„å‚ä¸è€…çš„ä¿¡æ¯åï¼Œä¾¿è¿›å…¥<code>NextRound</code>ã€‚åœ¨<code>keygen</code>çš„round4ä¸­ï¼Œå®ç°çš„NextRoundå¦‚ä¸‹ï¼Œå½“NextRoundè¿”å›çš„å€¼==nil æ—¶ï¼Œä¾¿å°±ç»“æŸäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func (round *round4) NextRound() tss.Round &#123;</span><br><span class="line">return nil // finished!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šä¸ªå‚ä¸è€…"><a href="#å¤šä¸ªå‚ä¸è€…" class="headerlink" title="å¤šä¸ªå‚ä¸è€…"></a>å¤šä¸ªå‚ä¸è€…</h3><p>çœ‹ä¸€ä¸‹å¤šä¸ªå‚ä¸è€…å¦‚ä½•è¿›è¡Œã€‚è¿™é‡Œä»¥signingåŒ…ä¸‹çš„local_party_testä¸­çš„æµ‹è¯•æ¥ä¸¾ä¾‹ã€‚</p><p>ä»£ç è¾ƒå¤šï¼Œå°±ç›´æ¥å°†è¯´æ˜æ³¨é‡Šåœ¨ä»£ç é‡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">func TestE2EConcurrent(t *testing.T) &#123;</span><br><span class="line">setUp(&quot;info&quot;)</span><br><span class="line">threshold := testThreshold</span><br><span class="line"></span><br><span class="line">//ä»å…ˆå‰äº§ç”Ÿçš„testParticipantsä¸ªç§é’¥æ–‡ä»¶ä¸­è¯»å‡ºtestThreshold+1ä¸ªç§é’¥æ¥å‚ä¸</span><br><span class="line">//å‚ä¸å¤šç­¾çš„ç§é’¥å­˜å‚¨äºæ•°ç»„keysä¸­ï¼Œå‚ä¸å¤šç­¾çš„partiyIdå­˜å‚¨äºsignPIDSä¸­</span><br><span class="line">keys, signPIDs, err := keygen.LoadKeygenTestFixturesRandomSet(testThreshold+1, testParticipants)</span><br><span class="line">assert.NoError(t, err, &quot;should load keygen fixtures&quot;)</span><br><span class="line">assert.Equal(t, testThreshold+1, len(keys))</span><br><span class="line">assert.Equal(t, testThreshold+1, len(signPIDs))</span><br><span class="line"></span><br><span class="line">// PHASE: signing</span><br><span class="line">// use a shuffled selection of the list of parties for this test</span><br><span class="line">p2pCtx := tss.NewPeerContext(signPIDs)</span><br><span class="line">parties := make([]*LocalParty, 0, len(signPIDs))</span><br><span class="line"></span><br><span class="line">errCh := make(chan *tss.Error, len(signPIDs))</span><br><span class="line">//æ¶ˆæ¯é€šé“</span><br><span class="line">outCh := make(chan tss.Message, len(signPIDs))</span><br><span class="line">//å¤šç­¾ç»“æŸé€šé“</span><br><span class="line">endCh := make(chan SignatureData, len(signPIDs))</span><br><span class="line">//æ¥æ”¶æ¶ˆæ¯çš„Update</span><br><span class="line">updater := test.SharedPartyUpdater</span><br><span class="line">//è¦ç­¾åçš„æ•°æ®</span><br><span class="line">hash, _ := hex.DecodeString(msg)</span><br><span class="line"></span><br><span class="line">//å¯åŠ¨testThreshold+1çš„å‚ä¸è€…</span><br><span class="line">for i := 0; i &lt; len(signPIDs); i++ &#123;</span><br><span class="line">fmt.Println(&quot;parameters party id: &quot;, signPIDs[i])</span><br><span class="line">params := tss.NewParameters(p2pCtx, signPIDs[i], len(signPIDs), threshold)</span><br><span class="line">P := NewLocalParty(new(big.Int).SetBytes(hash), params, keys[i], outCh, endCh).(*LocalParty)</span><br><span class="line">//å°†å‚ä¸è€…çš„partyå­˜å‚¨ï¼Œåç»­æ¥æ”¶åˆ°ä¿¡æ¯æ—¶ï¼Œéœ€ä¼ é€’ç»™å¯¹åº”çš„party</span><br><span class="line">parties = append(parties, P)</span><br><span class="line">go func(P *LocalParty) &#123;</span><br><span class="line">if err := P.Start(); err != nil &#123;</span><br><span class="line">errCh &lt;- err</span><br><span class="line">&#125;</span><br><span class="line">&#125;(P)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var ended int32</span><br><span class="line">signing:</span><br><span class="line">for &#123;</span><br><span class="line">// fmt.Printf(&quot;ACTIVE GOROUTINES: %d\n&quot;, runtime.NumGoroutine())</span><br><span class="line">select &#123;</span><br><span class="line">case err := &lt;-errCh:</span><br><span class="line">common.Logger.Errorf(&quot;Error: %s&quot;, err)</span><br><span class="line">assert.FailNow(t, err.Error())</span><br><span class="line">break signing</span><br><span class="line"></span><br><span class="line">case msg := &lt;-outCh:</span><br><span class="line">  //æœ‰æ¶ˆæ¯å‘å‡ºï¼Œè¿™é‡Œæ¶ˆæ¯æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¹¿æ’­ï¼Œéœ€å°†æ¶ˆæ¯ä¼ é€’ç»™å‡ºè‡ªå·±ä¹‹å¤–çš„å‚ä¸è€…ï¼›ä¸€ç§æ˜¯å®šå‘ï¼Œéœ€å°†æ¶ˆæ¯ä¼ é€’ç»™å®šå‘çš„é‚£ä¸ªå‚ä¸è€…</span><br><span class="line">dest := msg.GetTo()</span><br><span class="line">fmt.Println(msg.Type(), &quot; from &quot;,  msg.GetFrom(), &quot; to &quot;, msg.GetTo())</span><br><span class="line">//å¦‚æœto == nill,å°±è¯´æ˜æ˜¯å¹¿æ’­æ¶ˆæ¯</span><br><span class="line">if dest == nil &#123;</span><br><span class="line">for _, P := range parties &#123;</span><br><span class="line">if P.PartyID().Index == msg.GetFrom().Index &#123;</span><br><span class="line">continue</span><br><span class="line">&#125;</span><br><span class="line">//å°†æ¶ˆæ¯ä¼ é€’ç»™å¯¹åº”party</span><br><span class="line">go updater(P, msg, errCh)</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">if dest[0].Index == msg.GetFrom().Index &#123;</span><br><span class="line">t.Fatalf(&quot;party %d tried to send a message to itself (%d)&quot;, dest[0].Index, msg.GetFrom().Index)</span><br><span class="line">&#125;</span><br><span class="line">//å®šå‘å°†æ¶ˆæ¯ä¼ é€’ç»™å¯¹åº”çš„party</span><br><span class="line">go updater(parties[dest[0].Index], msg, errCh)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case sig := &lt;-endCh:</span><br><span class="line">//åˆ°è¿™é‡Œç­¾åæœ‰ç»“æœäº†ï¼Œå¤šç­¾å°±å®Œæˆäº†ï¼Œç­¾åçš„æ•°æ®åˆ†åˆ«æ˜¯Rã€S</span><br><span class="line">fmt.Println(&quot;R=&gt;&quot;,new(big.Int).SetBytes(sig.R))</span><br><span class="line">fmt.Println(&quot;S=&gt;&quot;, new(big.Int).SetBytes(sig.S))</span><br><span class="line">// fmt.Println(&quot;sig=&gt;&quot;, hex.EncodeToString(sig.Signature))</span><br><span class="line">//åé¢å°±æ˜¯æ ¡éªŒäº†</span><br><span class="line">//å› ä¸ºæ˜¯æœ¬åœ°å¯åŠ¨äº†å¤šä¸ªåç¨‹ä½œä¸ºå‚ä¸è€…ï¼Œä¸”æ˜¯ä½¿ç”¨çš„ç›¸åŒçš„channelï¼Œæ‰€ä»¥endChä¼šæ”¶åˆ°æ¯ä¸€ä¸ªå‚ä¸è€…çš„å¤šç­¾ç»“æœ</span><br><span class="line">atomic.AddInt32(&amp;ended, 1)</span><br><span class="line">fmt.Println(&quot;==&gt; end&quot;)</span><br><span class="line">//å½“æ‰€ä»¥çš„å‚ä¸è€…éƒ½å®Œæˆäº†ç­¾å</span><br><span class="line"> if atomic.LoadInt32(&amp;ended) == int32(len(signPIDs)) &#123;</span><br><span class="line">t.Logf(&quot;Done. Received save data from %d participants&quot;, ended)</span><br><span class="line">R := parties[0].temp.bigR</span><br><span class="line">r := parties[0].temp.rx</span><br><span class="line">fmt.Printf(&quot;sign result: R(%s, %s), r=%s\n&quot;, R.X().String(), R.Y().String(), r.String())</span><br><span class="line"></span><br><span class="line">modN := common.ModInt(tss.EC().Params().N)</span><br><span class="line"></span><br><span class="line">// BEGIN check s correctness</span><br><span class="line">sumS := big.NewInt(0)</span><br><span class="line">for _, p := range parties &#123;</span><br><span class="line">sumS = modN.Add(sumS, p.temp.si)</span><br><span class="line">&#125;</span><br><span class="line">//è¿™é‡Œè®¡ç®—å‡ºæ¥çš„sumSå’Œsig.Sæ˜¯ç›¸åŒçš„å€¼ï¼Œ</span><br><span class="line">fmt.Printf(&quot;S: %s\n&quot;, sumS.String())</span><br><span class="line">fmt.Println(&quot;pub&quot;, keys[0].ECDSAPub.X(), keys[0].ECDSAPub.Y())</span><br><span class="line"></span><br><span class="line">// END check s correctness</span><br><span class="line"></span><br><span class="line">// ä»¥ecdsaæ¥æ ¡éªŒç­¾åçš„æ­£ç¡®æ€§</span><br><span class="line">pkX, pkY := keys[0].ECDSAPub.X(), keys[0].ECDSAPub.Y()</span><br><span class="line">pk := ecdsa.PublicKey&#123;</span><br><span class="line">Curve: tss.EC(),</span><br><span class="line">X:     pkX,</span><br><span class="line">Y:     pkY,</span><br><span class="line">&#125;</span><br><span class="line">ok := ecdsa.Verify(&amp;pk, hash, R.X(), sumS)</span><br><span class="line">assert.True(t, ok, &quot;ecdsa verify must pass&quot;)</span><br><span class="line">t.Log(&quot;ECDSA signing test done.&quot;)</span><br><span class="line">// END ECDSA verify</span><br><span class="line">if atomic.LoadInt32(&amp;ended) == int32(len(signPIDs)) &#123;</span><br><span class="line">break signing</span><br><span class="line">&#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç¤ºä¾‹ä¸­äº§ç”Ÿçš„Sï¼Œæœ‰æ—¶å€™éœ€è¦ç¨å¾®å¤„ç†ä¸€ä¸‹æ‰èƒ½é€‚ç”¨äºå¸å®‰é“¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r := new(big.Int).SetBytes(msg.R)</span><br><span class="line">s := new(big.Int).SetBytes(msg.S)</span><br><span class="line">if s.Cmp(HalfN) == 1 &#123;</span><br><span class="line">s = s.Sub(btcec.S256().N, s)</span><br><span class="line">&#125;</span><br><span class="line">signature := btcec.Signature&#123;R: r, S: s&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œåœ¨<code>tss.LocalPartySaveData</code>ç»“æ„ä¸­çš„å…¬é’¥è½¬<code>secp256k1</code> å…¬é’¥çš„æ–¹å¼å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//key keygen.LocalPartySaveData</span><br><span class="line">y := key.ECDSAPub.Y()</span><br><span class="line">x := key.ECDSAPub.X()</span><br><span class="line">var pubkey [33]byte</span><br><span class="line">copy(pubkey[1:], x.Bytes())</span><br><span class="line">if y.And(y, big.NewInt(1)).Cmp(big.NewInt(0)) &gt; 1 &#123;</span><br><span class="line">pubkey[0] = 2</span><br><span class="line">&#125; else &#123;</span><br><span class="line">pubkey[0] = 3</span><br><span class="line">&#125;</span><br><span class="line">//secp256k1.PubKeySecp256k1(pubkey)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> binance </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-multisig</title>
      <link href="/2020/01/02/cosmos-multisig/"/>
      <url>/2020/01/02/cosmos-multisig/</url>
      
        <content type="html"><![CDATA[<h2 id="Cosmos-å¤šé‡ç­¾å"><a href="#Cosmos-å¤šé‡ç­¾å" class="headerlink" title="Cosmos å¤šé‡ç­¾å"></a>Cosmos å¤šé‡ç­¾å</h2><h3 id="åˆ›å»ºå¤šç­¾è´¦æˆ·"><a href="#åˆ›å»ºå¤šç­¾è´¦æˆ·" class="headerlink" title="åˆ›å»ºå¤šç­¾è´¦æˆ·"></a>åˆ›å»ºå¤šç­¾è´¦æˆ·</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gaiacli keys add \</span><br><span class="line">  p1p2p3 \</span><br><span class="line">  --multisig-threshold=2 \</span><br><span class="line">  --multisig=p1,p2,p3</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">var pks []crypto.PubKey</span><br><span class="line">//å‚ä¸å¤šç­¾çš„å…¬é’¥</span><br><span class="line">multisigThreshold := viper.GetInt(flagMultiSigThreshold)</span><br><span class="line">if err := validateMultisigThreshold(multisigThreshold, len(multisigKeys)); err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for _, keyname := range multisigKeys &#123;</span><br><span class="line">k, err := kb.Get(keyname)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line">pks = append(pks, k.GetPubKey())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Handle --nosort</span><br><span class="line">//æŒ‰åœ°å€è¿›è¡Œæ’åº</span><br><span class="line">if !viper.GetBool(flagNoSort) &#123;</span><br><span class="line">sort.Slice(pks, func(i, j int) bool &#123;</span><br><span class="line">return bytes.Compare(pks[i].Address(), pks[j].Address()) &lt; 0</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pk := multisig.NewPubKeyMultisigThreshold(multisigThreshold, pks)</span><br><span class="line">if _, err := kb.CreateMulti(name, pk); err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®æ˜¯å¢åŠ äº†å…¬é’¥ç±»å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type PubKeyMultisigThreshold struct &#123;</span><br><span class="line">K       uint            `json:&quot;threshold&quot;`</span><br><span class="line">PubKeys []crypto.PubKey `json:&quot;pubkeys&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var _ crypto.PubKey = PubKeyMultisigThreshold&#123;&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éªŒç­¾çš„æ—¶å€™ï¼Œæ˜¯è°ƒç”¨å…¬é’¥çš„æ–¹æ³•è¿›è¡ŒéªŒç­¾ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">func (pk PubKeyMultisigThreshold) VerifyBytes(msg []byte, marshalledSig []byte) bool &#123;</span><br><span class="line">var sig Multisignature</span><br><span class="line">err := cdc.UnmarshalBinaryBare(marshalledSig, &amp;sig)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">size := sig.BitArray.Size()</span><br><span class="line">// ensure bit array is the correct size</span><br><span class="line">if len(pk.PubKeys) != size &#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">// ensure size of signature list</span><br><span class="line">if len(sig.Sigs) &lt; int(pk.K) || len(sig.Sigs) &gt; size &#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">// ensure at least k signatures are set</span><br><span class="line">if sig.BitArray.NumTrueBitsBefore(size) &lt; int(pk.K) &#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">// index in the list of signatures which we are concerned with.</span><br><span class="line">sigIndex := 0</span><br><span class="line">for i := 0; i &lt; size; i++ &#123;</span><br><span class="line">if sig.BitArray.GetIndex(i) &#123;</span><br><span class="line">if !pk.PubKeys[i].VerifyBytes(msg, sig.Sigs[sigIndex]) &#123;</span><br><span class="line">return false</span><br><span class="line">&#125;</span><br><span class="line">sigIndex++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¤šç­¾æ˜¯çº¿ä¸‹å®Œæˆçš„ã€‚</p><p>å°†å¤šä¸ªäººçš„ç­¾åä¼šæ•´åˆåˆ°ä¸€ä¸ªç­¾åä¸­ã€‚</p><p>ä½¿ç”¨å¤šç­¾ç­¾ç½²äº¤æ˜“æ—¶ï¼Œå‘½ä»¤è¡Œå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gaiacli tx send cosmos1570v2fq3twt0f0x02vhxpuzc9jc4yl30q2qned 1000000uatom \</span><br><span class="line">  --from=&lt;multisig_address&gt; \</span><br><span class="line">  --generate-only &gt; unsignedTx.json</span><br></pre></td></tr></table></figure><p>å…ˆäº§ç”Ÿäº¤æ˜“å­˜äºæ–‡ä»¶ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gaiacli tx sign \</span><br><span class="line">  unsignedTx.json \</span><br><span class="line">  --multisig=&lt;multisig_address&gt; \</span><br><span class="line">  --from=p1 \</span><br><span class="line">  --output-document=p1signature.json</span><br></pre></td></tr></table></figure><p>p1å•ç‹¬ç­¾ç½²äº¤æ˜“ï¼Œç­¾åä¿¡æ¯ä¿å­˜äºæ–‡ä»¶ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gaiacli tx sign \</span><br><span class="line">  unsignedTx.json \</span><br><span class="line">  --multisig=&lt;multisig_address&gt; \</span><br><span class="line">  --from=p2 \</span><br><span class="line">  --output-document=p2signature.json</span><br></pre></td></tr></table></figure><p>p2å•ç‹¬ç­¾ç½²äº¤æ˜“ï¼Œç­¾åä¿¡æ¯ä¿å­˜äºæ–‡ä»¶ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gaiacli tx multisign \</span><br><span class="line">  unsignedTx.json \</span><br><span class="line">  p1p2p3 \</span><br><span class="line">  p1signature.json p2signature.json &gt; signedTx.json</span><br></pre></td></tr></table></figure><p>å°†p1çš„ç­¾åä¸p2çš„ç­¾åè¿›è¡Œæ•´åˆï¼Œæ•´åˆå®Œæˆåçš„ç­¾åæ•°æ®ä¿å­˜äºæ–‡ä»¶ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gaiacli tx broadcast signedTx.json</span><br></pre></td></tr></table></figure><p>æœ€åå‘é€äº¤æ˜“ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-proposer</title>
      <link href="/2019/12/19/cosmos-proposer/"/>
      <url>/2019/12/19/cosmos-proposer/</url>
      
        <content type="html"><![CDATA[<h2 id="Tendermint-Proposer"><a href="#Tendermint-Proposer" class="headerlink" title="Tendermint Proposer"></a>Tendermint Proposer</h2><p>ä¹‹å‰æœ‰æåˆ°<code>cosmos-staking</code>æ˜¯å†³å®šæ›´æ–°éªŒè¯è€…ã€‚</p><p>è¿™é‡Œè®²åˆ°çš„æ˜¯è¿™äº›éªŒè¯è€…ä»¬å¦‚ä½•é€‰æ‹©å‡ºproposerã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">func (vals *ValidatorSet) incrementProposerPriority() *Validator &#123;</span><br><span class="line">for _, val := range vals.Validators &#123;</span><br><span class="line">//è®¡ç®—æ¯ä¸ªéªŒè¯è€…çš„ProposerPriority = ProposerPriority + VotingPower</span><br><span class="line">newPrio := safeAddClip(val.ProposerPriority, val.VotingPower)</span><br><span class="line">val.ProposerPriority = newPrio</span><br><span class="line">&#125;</span><br><span class="line">//å–å‡ºProposerPriorityæœ€å¤§çš„éªŒè¯è€…æ¥ä½œä¸ºproposer</span><br><span class="line">// Decrement the validator with most ProposerPriority.</span><br><span class="line">mostest := vals.getValWithMostPriority()</span><br><span class="line">//é€‰æ‹©å‡ºproposeråï¼Œå…¶ProposerPriorityä¼šè¿›è¡Œå†æ›´æ–°ä¸ºProposerPriority - TotalVotingPower</span><br><span class="line">// Mind the underflow.</span><br><span class="line">mostest.ProposerPriority = safeSubClip(mostest.ProposerPriority, vals.TotalVotingPower())</span><br><span class="line"></span><br><span class="line">return mostest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚è¯´æ¥ï¼Œå°±æ˜¯Priority = Priority + VotingPowerï¼Œmax(Priority)çš„éªŒè¯è€…ä½œä¸ºproposerï¼Œä¸”æ›´æ–°å…¶Priority = Priority - TotalVotingPowerã€‚</p><p>æµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">func TestProposerSelection1(t *testing.T) &#123;</span><br><span class="line">vset := NewValidatorSet([]*Validator&#123;</span><br><span class="line">newValidator([]byte(&quot;foo&quot;), 1000),</span><br><span class="line">newValidator([]byte(&quot;bar&quot;), 300),</span><br><span class="line">newValidator([]byte(&quot;baz&quot;), 330),</span><br><span class="line">&#125;)</span><br><span class="line">for _, v :=range vset.Validators  &#123;</span><br><span class="line">fmt.Println(string(v.Address), v.ProposerPriority)</span><br><span class="line">&#125;</span><br><span class="line">var proposers []string</span><br><span class="line">for i := 0; i &lt; 20; i++ &#123;</span><br><span class="line">val := vset.GetProposer()</span><br><span class="line">proposers = append(proposers, string(val.Address))</span><br><span class="line">fmt.Print(&quot;[&quot;, string(val.Address), &quot;]&quot;,)</span><br><span class="line">for _, v :=range vset.Validators  &#123;</span><br><span class="line">fmt.Print(string(v.Address),&quot;:&quot;, v.ProposerPriority, &quot; / &quot;)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line">vset.IncrementProposerPriority(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[foo]bar:300 / baz:330 / foo:-630 / </span><br><span class="line">[baz]bar:600 / baz:-970 / foo:370 / </span><br><span class="line">[foo]bar:900 / baz:-640 / foo:-260 / </span><br><span class="line">[bar]bar:-430 / baz:-310 / foo:740 / </span><br><span class="line">[foo]bar:-130 / baz:20 / foo:110 / </span><br><span class="line">[foo]bar:170 / baz:350 / foo:-520 / </span><br><span class="line">[baz]bar:470 / baz:-950 / foo:480 / </span><br><span class="line">[foo]bar:770 / baz:-620 / foo:-150 / </span><br><span class="line">[bar]bar:-560 / baz:-290 / foo:850 / </span><br><span class="line">[foo]bar:-260 / baz:40 / foo:220 / </span><br><span class="line">[foo]bar:40 / baz:370 / foo:-410 / </span><br><span class="line">[baz]bar:340 / baz:-930 / foo:590 / </span><br><span class="line">[foo]bar:640 / baz:-600 / foo:-40 / </span><br><span class="line">[foo]bar:940 / baz:-270 / foo:-670 / </span><br><span class="line">[bar]bar:-390 / baz:60 / foo:330 / </span><br><span class="line">[foo]bar:-90 / baz:390 / foo:-300 / </span><br><span class="line">[baz]bar:210 / baz:-910 / foo:700 / </span><br><span class="line">[foo]bar:510 / baz:-580 / foo:70 / </span><br><span class="line">[foo]bar:810 / baz:-250 / foo:-560 / </span><br><span class="line">[bar]bar:-520 / baz:80 / foo:440 /</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ï¼Œä¸Šé¢çš„è®¡ç®—å¹¶ä¸å®Œæ•´ï¼Œè¿˜æœ‰å…¶ä»–è½¬æ¢ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">func (vals *ValidatorSet) IncrementProposerPriority(times int) &#123;</span><br><span class="line">if vals.IsNilOrEmpty() &#123;</span><br><span class="line">panic(&quot;empty validator set&quot;)</span><br><span class="line">&#125;</span><br><span class="line">if times &lt;= 0 &#123;</span><br><span class="line">panic(&quot;Cannot call IncrementProposerPriority with non-positive times&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Cap the difference between priorities to be proportional to 2*totalPower by</span><br><span class="line">// re-normalizing priorities, i.e., rescale all priorities by multiplying with:</span><br><span class="line">//  2*totalVotingPower/(maxPriority - minPriority)</span><br><span class="line">diffMax := PriorityWindowSizeFactor * vals.TotalVotingPower()</span><br><span class="line">vals.RescalePriorities(diffMax)</span><br><span class="line">vals.shiftByAvgProposerPriority()</span><br><span class="line"></span><br><span class="line">var proposer *Validator</span><br><span class="line">// Call IncrementProposerPriority(1) times times.</span><br><span class="line">for i := 0; i &lt; times; i++ &#123;</span><br><span class="line">proposer = vals.incrementProposerPriority()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vals.Proposer = proposer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func (vals *ValidatorSet) RescalePriorities(diffMax int64) &#123;</span><br><span class="line">if vals.IsNilOrEmpty() &#123;</span><br><span class="line">panic(&quot;empty validator set&quot;)</span><br><span class="line">&#125;</span><br><span class="line">// NOTE: This check is merely a sanity check which could be</span><br><span class="line">// removed if all tests would init. voting power appropriately;</span><br><span class="line">// i.e. diffMax should always be &gt; 0</span><br><span class="line">if diffMax &lt;= 0 &#123;</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Calculating ceil(diff/diffMax):</span><br><span class="line">// Re-normalization is performed by dividing by an integer for simplicity.</span><br><span class="line">// NOTE: This may make debugging priority issues easier as well.</span><br><span class="line">diff := computeMaxMinPriorityDiff(vals)</span><br><span class="line">ratio := (diff + diffMax - 1) / diffMax</span><br><span class="line">if diff &gt; diffMax &#123;</span><br><span class="line">for _, val := range vals.Validators &#123;</span><br><span class="line">val.ProposerPriority /= ratio</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func (vals *ValidatorSet) shiftByAvgProposerPriority() &#123;</span><br><span class="line">if vals.IsNilOrEmpty() &#123;</span><br><span class="line">panic(&quot;empty validator set&quot;)</span><br><span class="line">&#125;</span><br><span class="line">avgProposerPriority := vals.computeAvgProposerPriority()</span><br><span class="line">for _, val := range vals.Validators &#123;</span><br><span class="line">val.ProposerPriority = safeSubClip(val.ProposerPriority, avgProposerPriority)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>tendermint-node</title>
      <link href="/2019/12/18/tendermint-node/"/>
      <url>/2019/12/18/tendermint-node/</url>
      
        <content type="html"><![CDATA[<ul><li>Transport èŠ‚ç‚¹çš„tcpè¿æ¥</li><li>Switch p2pè¿æ¥</li></ul><p>Transportä½œä¸ºSwitchçš„åº•å±‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">func (sw *Switch) acceptRoutine() &#123;</span><br><span class="line">for &#123;</span><br><span class="line">//ç­‰å¾…æœ‰èŠ‚ç‚¹æ¥å…¥ï¼Œæ¥å…¥åä¼šè¿”å›pï¼Œå¦åˆ™ä¼šä¸€ç›´ç­‰ç€</span><br><span class="line">p, err := sw.transport.Accept(peerConfig&#123;</span><br><span class="line">chDescs:      sw.chDescs,</span><br><span class="line">onPeerError:  sw.StopPeerForError,</span><br><span class="line">reactorsByCh: sw.reactorsByCh,</span><br><span class="line">metrics:      sw.metrics,</span><br><span class="line">isPersistent: sw.isPeerPersistentFn(),</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br><span class="line">if err := sw.addPeer(p); err != nil &#123;</span><br><span class="line">//æ–­å¼€è¿æ¥</span><br><span class="line">sw.transport.Cleanup(p)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>node.Start</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//start rpc</span><br><span class="line">n.startRPC()</span><br><span class="line"></span><br><span class="line">//transportå¼€å¯ç›‘å¬ç«¯å£ç­‰å¾…èŠ‚ç‚¹tcpæ¥å…¥</span><br><span class="line">n.transport.Listen(*addr)</span><br><span class="line"></span><br><span class="line">//p2pæœåŠ¡å¼€å¯ï¼Œå½“transportæœ‰èŠ‚ç‚¹æ¥å…¥æ—¶ï¼Œä¼šè¿›å…¥switchå¤„ç†</span><br><span class="line">n.sw.Start()</span><br><span class="line"></span><br><span class="line">//sw.Start()å†…å®¹æ˜¯</span><br><span class="line">// OnStart implements BaseService. It starts all the reactors and peers.</span><br><span class="line">func (sw *Switch) OnStart() error &#123;</span><br><span class="line">// Start reactors</span><br><span class="line">for _, reactor := range sw.reactors &#123;</span><br><span class="line">err := reactor.Start()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return errors.Wrapf(err, &quot;failed to start %v&quot;, reactor)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Start accepting Peers.</span><br><span class="line">go sw.acceptRoutine()</span><br><span class="line"></span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>//swçš„reactoråŒ…æ‹¬</p><ul><li>mempoolReactor  //for gossipping transactionsï¼Œå¹¿æ’­äº¤æ˜“</li><li>brReactor   //for fast-syncing</li><li>consensusReactor //for participating in the consensus, å…±è¯†</li><li>evidenceReactor</li></ul><h3 id="consensusReactor"><a href="#consensusReactor" class="headerlink" title="consensusReactor"></a>consensusReactor</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// OnStart implements BaseService by subscribing to events, which later will be</span><br><span class="line">// broadcasted to other peers and starting state if we&apos;re not in fast sync.</span><br><span class="line">func (conR *ConsensusReactor) OnStart() error &#123;</span><br><span class="line">conR.Logger.Info(&quot;ConsensusReactor &quot;, &quot;fastSync&quot;, conR.FastSync())</span><br><span class="line"></span><br><span class="line">// start routine that computes peer statistics for evaluating peer quality</span><br><span class="line">go conR.peerStatsRoutine()</span><br><span class="line"></span><br><span class="line">conR.subscribeToBroadcastEvents()</span><br><span class="line"></span><br><span class="line">if !conR.FastSync() &#123;</span><br><span class="line">err := conR.conS.Start()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-anteHandler</title>
      <link href="/2019/12/16/cosmos-anteHandler/"/>
      <url>/2019/12/16/cosmos-anteHandler/</url>
      
        <content type="html"><![CDATA[<h3 id="Cosmos-anteHandler"><a href="#Cosmos-anteHandler" class="headerlink" title="Cosmos-anteHandler"></a>Cosmos-anteHandler</h3><p><img src="./cosmos-anteHandler.png" alt="æµç¨‹å›¾"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// NewAnteHandler returns an AnteHandler that checks and increments sequence</span><br><span class="line">// numbers, checks signatures &amp; account numbers, and deducts fees from the first</span><br><span class="line">// signer.</span><br><span class="line">func NewAnteHandler(ak keeper.AccountKeeper, supplyKeeper types.SupplyKeeper, sigGasConsumer SignatureVerificationGasConsumer) sdk.AnteHandler &#123;</span><br><span class="line">return sdk.ChainAnteDecorators(</span><br><span class="line">NewSetUpContextDecorator(), // outermost AnteDecorator. SetUpContext must be called first</span><br><span class="line">NewMempoolFeeDecorator(),</span><br><span class="line">NewValidateBasicDecorator(),</span><br><span class="line">NewValidateMemoDecorator(ak),</span><br><span class="line">NewConsumeGasForTxSizeDecorator(ak),</span><br><span class="line">NewSetPubKeyDecorator(ak), // SetPubKeyDecorator must be called before all signature verification decorators</span><br><span class="line">NewValidateSigCountDecorator(ak),</span><br><span class="line">NewDeductFeeDecorator(ak, supplyKeeper),</span><br><span class="line">NewSigGasConsumeDecorator(ak, sigGasConsumer),</span><br><span class="line">NewSigVerificationDecorator(ak),</span><br><span class="line">NewIncrementSequenceDecorator(ak), // innermost AnteDecorator</span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>anteHandler</code>æ˜¯æµå¼å¤„ç†çš„handlerï¼Œä½œç”¨åœ¨checkTx/DeliverTx</p><p>æ¥çœ‹çœ‹ä¸»è¦è´Ÿè´£äº›ä»€ä¹ˆã€‚</p><ul><li><p><code>NewSetUpContextDecorator</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return ctx.WithGasMeter</span><br><span class="line">//è®¾ç½®åç»­ä½¿ç”¨çš„ctx</span><br></pre></td></tr></table></figure></li><li><p><code>NewMempoolFeeDecorator</code></p><p>æ£€æŸ¥feeä¸­çš„gasPriceæ˜¯å¦å¤§äºè®¾ç½®çš„æœ€å°gasprice</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">minGasPrices := ctx.MinGasPrices()</span><br><span class="line">//requiredFeesä¸ºminGasPricesçš„å°è£…</span><br><span class="line">if !feeCoins.IsAnyGTE(requiredFees) &#123;</span><br><span class="line">return ctx, sdkerrors.Wrapf(sdkerrors.ErrInsufficientFee, &quot;insufficient fees; got: %s required: %s&quot;, feeCoins, requiredFees)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>NewValidateBasicDecorator</code></p><p>æ£€æŸ¥Txçš„feeæ˜¯ä¸æ˜¯éƒ½å°äºæœ€å¤§å€¼ã€ç­¾åæœ‰æ²¡æœ‰ä¹‹ç±»çš„ã€‚</p></li><li><p><code>NewValidateMemoDecorator</code></p><p>æ£€æŸ¥memoæ˜¯å¦è¶…è¿‡æœ€å¤§é•¿åº¦</p></li><li><p><code>NewConsumeGasForTxSizeDecorator</code></p><p>æ ¹æ®TxBytes * per byte priceè®¡ç®—gas</p><p><code>simulate</code>ä¸º<code>true</code>æ—¶ï¼Œå†åŠ ä¸ŠéªŒç­¾çš„gas</p></li><li><p><code>NewSetPubKeyDecorator</code></p><p>ä»ç­¾åä¸­å–å‡ºå…¬é’¥ï¼Œä»Msg.GetSignerså–å‡ºåœ°å€ï¼ŒéªŒè¯å…¬é’¥å¯¹åº”çš„åœ°å€æ˜¯å¦ä¸msgä¸­åœ°å€ç›¸åŒï¼Œä¸åŒåˆ™æŠ¥é”™ã€‚(ç”¨äºéªŒè¯å¦‚è½¬è´¦ç­¾åè€…å¿…é¡»æ˜¯FromAddress)</p><p>ä»ç­¾åä¸­å–å‡ºå…¬é’¥åœ°å€ï¼Œæ ¹æ®åœ°å€è¯»å–accountï¼Œè‹¥æ²¡æœ‰accountï¼ŒæŠ¥é”™ã€‚</p><p>å‡å¦‚è¯»å‡ºaccountçš„å…¬é’¥æœªæ›¾èµ‹å€¼ï¼Œåˆ™èµ‹å€¼å…¬é’¥å¹¶å­˜å‚¨</p></li><li><p><code>NewValidateSigCountDecorator</code></p><p>æ£€æŸ¥ç­¾åï¼Œå¦‚æœå…¬é’¥æ˜¯å¤šé‡ç­¾åçš„å…¬é’¥ï¼Œåˆ™æ£€æŸ¥å¤šé‡çš„ä¸ªæ•°æ˜¯å¦å¤§äºæœ€å¤§é™åˆ¶å€¼</p></li><li><p><code>NewDeductFeeDecorator</code></p><p>æ‰£é™¤feeï¼Œç›®å‰çš„ç‰ˆæœ¬æ˜¯é€‰æ‹©ä»sigç­¾åæ•°ç»„é‡Œçš„ç¬¬0ä¸ªäººçš„è´¦æˆ·æ¥æ‰£é™¤è¿™ç¬”æ‰‹ç»­è´¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func (tx StdTx) FeePayer() sdk.AccAddress &#123;</span><br><span class="line">if tx.GetSigners() != nil &#123;</span><br><span class="line">return tx.GetSigners()[0]</span><br><span class="line">&#125;</span><br><span class="line">return sdk.AccAddress&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæ‰£é™¤çš„æ‰‹ç»­è´¹æ˜¯åˆ°moduleä¸­å»äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := supplyKeeper.SendCoinsFromAccountToModule(ctx, acc.GetAddress(), types.FeeCollectorName, fees)</span><br></pre></td></tr></table></figure></li><li><p><code>NewSigGasConsumeDecorator</code></p><p>è®¡ç®—éªŒç­¾æ—¶çš„gas</p></li><li><p><code>NewSigVerificationDecorator</code></p><p>ç­¾åéªŒè¯ï¼Œä½¿ç”¨txä¸­çš„MsgåŠfeeå’Œæ•°æ®åº“é‡Œçš„account numberåŠsequenceè¿›è¡Œå°è£…ç­¾åç”¨çš„æ¶ˆæ¯</p></li><li><p><code>NewIncrementSequenceDecorator</code></p><p>å¢åŠ accountçš„sequence</p></li></ul><hr><p>æ‰€ä»¥CheckTxæ˜¯ä¸ä¿®æ”¹ä»»ä½•çŠ¶æ€çš„ï¼Œç›´åˆ°å‡ºå—åæ–¹æ‰ä¿®æ”¹ã€‚é‚£ä¹ˆï¼Œå¦‚æœåœ¨å‡ºå—å‰ï¼ŒåŒä¸€ä¸ªåœ°å€è¿å‘ä¸¤ç¬”äº¤æ˜“ï¼Œè¦é€šè¿‡CheckTxï¼Œé‚£ä¹ˆsequenceå¿…é¡»è¦ä¸€æ ·ï¼Œå› ä¸ºæ£€æŸ¥éªŒç­¾æ—¶ä½¿ç”¨çš„sequenceæ˜¯ä¸€æ ·çš„(æ•°æ®åº“ä¸­çš„sequence)ï¼Œå¦‚æœäº¤æ˜“å†…å®¹ä¸åŒï¼Œhashä¸åŒçš„æƒ…å†µä¸‹ï¼Œå°±èƒ½é€šè¿‡CheckTxï¼ŒåŠ å…¥åˆ°äº¤æ˜“æ± ä¸­ï¼Œç›´åˆ°è¢«æ‰“åŒ…è¿›å—ï¼Œåªæ˜¯ä¸¤ç¬”äº¤æ˜“å¿…ç„¶æœ‰ä¸€ç¬”ä¼šæ‰§è¡Œå¤±è´¥ï¼Œæˆä¸º<code>invalidTx</code>.</p>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-struct</title>
      <link href="/2019/12/09/cosmos-struct/"/>
      <url>/2019/12/09/cosmos-struct/</url>
      
        <content type="html"><![CDATA[<h3 id="Cosmosç»“æ„æ¢³ç†"><a href="#Cosmosç»“æ„æ¢³ç†" class="headerlink" title="Cosmosç»“æ„æ¢³ç†"></a>Cosmosç»“æ„æ¢³ç†</h3><p>ä»ç¼–å†™xæ¨¡å—å¼€å§‹å§ï¼</p><ul><li><p>ç¼–å†™<code>Keeper</code>ï¼Œkeeperå®ç°ä¸æ•°æ®åº“å±‚äº¤äº’</p></li><li><p>å®ç°<code>AppModule</code>æ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// AppModule is the standard form for an application module</span><br><span class="line">type AppModule interface &#123;</span><br><span class="line">AppModuleGenesis</span><br><span class="line"></span><br><span class="line">// registers</span><br><span class="line">RegisterInvariants(sdk.InvariantRegistry)</span><br><span class="line"></span><br><span class="line">// routes</span><br><span class="line">Route() string</span><br><span class="line">NewHandler() sdk.Handler</span><br><span class="line">QuerierRoute() string</span><br><span class="line">NewQuerierHandler() sdk.Querier</span><br><span class="line"></span><br><span class="line">// ABCI</span><br><span class="line">BeginBlock(sdk.Context, abci.RequestBeginBlock)</span><br><span class="line">EndBlock(sdk.Context, abci.RequestEndBlock) []abci.ValidatorUpdate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AppModule</code>ä¸»è¦æ˜¯è´Ÿè´£<code>abci</code>å›è°ƒï¼ŒåŒ…æ‹¬åŸºæœ¬çš„<code>BeginBlock</code>/<code>EndBlock</code>å›è°ƒã€ä»¥åŠ<code>CheckTx</code>çš„å›è°ƒå®ç°(Msgå®ç°çš„<code>ValidateBasic</code>æ–¹æ³•)ã€<code>DeliverTx</code>çš„å›è°ƒ(Route + Handlerç»„æˆçš„è·¯ç”±å®ç°)ã€<code>Query</code>çš„å›è°ƒï¼ŒåŒç†æ˜¯(Route + Handlerç»„æˆçš„è·¯ç”±å®ç°)ã€‚</p><p>è¿˜æœ‰æ˜¯<code>AppModuleGenesis</code>çš„å®ç°ï¼ŒåŒ…æ‹¬Genesisçš„ä¸€äº›å¤„ç†ï¼Œå¦‚é…ç½®ä»Genesisä¸­è¯»å‡ºçš„åˆå§‹è®¾ç½®ã€‚</p></li><li><p>å®ç°<code>AppModuleBasic</code>æ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type AppModuleBasic interface &#123;</span><br><span class="line">Name() string</span><br><span class="line">RegisterCodec(*codec.Codec)</span><br><span class="line"></span><br><span class="line">// genesis</span><br><span class="line">DefaultGenesis() json.RawMessage</span><br><span class="line">ValidateGenesis(json.RawMessage) error</span><br><span class="line"></span><br><span class="line">// client functionality</span><br><span class="line">RegisterRESTRoutes(context.CLIContext, *mux.Router)</span><br><span class="line">GetTxCmd(*codec.Codec) *cobra.Command</span><br><span class="line">GetQueryCmd(*codec.Codec) *cobra.Command</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°è¯¥æ¥å£çš„ä½¿ç”¨ï¼Œæ˜¯ç‹¬ç«‹ä½¿ç”¨ï¼Œä¸åƒè´Ÿè´£<code>abci</code>å›è°ƒçš„<code>AppModule</code>ä½¿ç”¨æ˜¯ä¸Tendermintä¸€èµ·çš„ã€‚</p><p><code>AppModuleBasic</code>æ¥å£ä¸»è¦ä½¿ç”¨åœ¨å‘½ä»¤è¡Œå·¥å…·ã€RestApiç­‰åœ°æ–¹ã€‚</p></li></ul><h4 id="ç¼–å†™å¥½äº†xæ¨¡å—ï¼Œå°±å¼€å§‹åˆå§‹åŒ–app"><a href="#ç¼–å†™å¥½äº†xæ¨¡å—ï¼Œå°±å¼€å§‹åˆå§‹åŒ–app" class="headerlink" title="ç¼–å†™å¥½äº†xæ¨¡å—ï¼Œå°±å¼€å§‹åˆå§‹åŒ–app"></a>ç¼–å†™å¥½äº†xæ¨¡å—ï¼Œå°±å¼€å§‹åˆå§‹åŒ–app</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">var (</span><br><span class="line">// default home directories for hub</span><br><span class="line">DefaultNodeHome = os.ExpandEnv(&quot;$HOME/.hub&quot;)</span><br><span class="line"></span><br><span class="line">// The module BasicManager is in charge of setting up basic,</span><br><span class="line">// non-dependant module elements, such as codec registration</span><br><span class="line">// and genesis verification.</span><br><span class="line">ModuleBasics = module.NewBasicManager(</span><br><span class="line">genutil.AppModuleBasic&#123;&#125;,</span><br><span class="line">auth.AppModuleBasic&#123;&#125;,</span><br><span class="line">bank.AppModuleBasic&#123;&#125;,</span><br><span class="line">staking.AppModuleBasic&#123;&#125;,</span><br><span class="line">mint.AppModuleBasic&#123;&#125;,</span><br><span class="line">distr.AppModuleBasic&#123;&#125;,</span><br><span class="line">gov.NewAppModuleBasic(paramsclient.ProposalHandler, distr.ProposalHandler),</span><br><span class="line">params.AppModuleBasic&#123;&#125;,</span><br><span class="line">crisis.AppModuleBasic&#123;&#125;,</span><br><span class="line">slashing.AppModuleBasic&#123;&#125;,</span><br><span class="line">supply.AppModuleBasic&#123;&#125;,</span><br><span class="line">ibc.AppModuleBasic&#123;&#125;,</span><br><span class="line">user.NewAppModuleBasic(),</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NewApp()&#123;</span><br><span class="line">  // NOTE: Any module instantiated in the module manager that is later modified must be passed by reference here.</span><br><span class="line">app.manager = module.NewManager(</span><br><span class="line">genutil.NewAppModule(app.accountKeeper, app.stakingKeeper, app.BaseApp.DeliverTx),</span><br><span class="line">auth.NewAppModule(app.accountKeeper),</span><br><span class="line">bank.NewAppModule(app.bankKeeper, app.accountKeeper),</span><br><span class="line">crisis.NewAppModule(&amp;app.crisisKeeper),</span><br><span class="line">supply.NewAppModule(app.supplyKeeper, app.accountKeeper),</span><br><span class="line">distr.NewAppModule(app.distrKeeper, app.supplyKeeper),</span><br><span class="line">gov.NewAppModule(app.govKeeper, app.supplyKeeper),</span><br><span class="line">mint.NewAppModule(app.mintKeeper),</span><br><span class="line">slashing.NewAppModule(app.slashingKeeper, app.stakingKeeper),</span><br><span class="line">staking.NewAppModule(app.stakingKeeper, app.accountKeeper, app.supplyKeeper),</span><br><span class="line">ibc.NewAppModule(app.ibcKeeper),</span><br><span class="line">user.NewAppModule(app.userKeeper),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">//...</span><br><span class="line">//é…ç½®è·¯ç”±å’Œhandlerï¼ˆåŒ…æ‹¬Txå’ŒæŸ¥è¯¢ï¼‰</span><br><span class="line">app.manager.RegisterRoutes(app.Router(), app.QueryRouter())</span><br><span class="line"></span><br><span class="line">// é…ç½®EndBlock\BeginBlockç­‰å›è°ƒ</span><br><span class="line">app.SetInitChainer(app.InitChainer)</span><br><span class="line">app.SetBeginBlocker(app.BeginBlocker)</span><br><span class="line">//AnteHandleræ˜¯ç‰¹æ®Šçš„å®ç°ï¼ŒCheckTxå’ŒDeliverTxä¸€èˆ¬åªä¼šæ‰§è¡Œåˆ°å¯¹åº”çš„æ¨¡å—ä¸­ï¼ŒAnteHandlerä¼šåœ¨è¿›å…¥å¯¹åº”æ¨¡å—å‰æ‰§è¡Œï¼Œå¦‚éªŒç­¾ç­‰æ“ä½œ..</span><br><span class="line">app.SetAnteHandler(auth.NewAnteHandler(app.accountKeeper, app.supplyKeeper, auth.DefaultSigVerificationGasConsumer))</span><br><span class="line">app.SetEndBlocker(app.EndBlocker)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ModuleBasicså®šä¹‰åœ¨ä¸Šé¢ï¼Œä½¿ç”¨åœ¨mainä¸­</span><br><span class="line">//main</span><br><span class="line">rootCmd := &amp;cobra.Command&#123;</span><br><span class="line">Use:               &quot;hub&quot;,</span><br><span class="line">Short:             &quot;Hub Daemon (server)&quot;,</span><br><span class="line">PersistentPreRunE: server.PersistentPreRunEFn(ctx),</span><br><span class="line">&#125;</span><br><span class="line">rootCmd.AddCommand(server.StartCmd(ctx, newApp))</span><br><span class="line">rootCmd.AddCommand(cmd.InitCmd(ctx, cdc, app.ModuleBasics, app.DefaultNodeHome))</span><br><span class="line">rootCmd.AddCommand(cmd.AddGenesisAccountCmd(ctx, cdc, app.DefaultNodeHome))</span><br><span class="line">rootCmd.AddCommand(cmd.GenerateTxCmd(ctx, cdc, app.ModuleBasics, app.DefaultNodeHome))</span><br><span class="line">rootCmd.AddCommand(cmd.CollectGenTxsCmd(ctx, cdc, app.DefaultNodeHome))</span><br><span class="line">rootCmd.AddCommand(cmd.ValidateGenesisCmd(ctx, cdc, app.ModuleBasics))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-staking</title>
      <link href="/2019/12/05/cosmos-staking/"/>
      <url>/2019/12/05/cosmos-staking/</url>
      
        <content type="html"><![CDATA[<h3 id="cosmos-staking"><a href="#cosmos-staking" class="headerlink" title="cosmos-staking"></a>cosmos-staking</h3><p><code>staking</code>æ˜¯cosmoså®ç°ç”¨æ¥é€‰æ‹©éªŒè¯è€…é›†åˆã€‚åœ¨<code>staking</code>çš„<code>handler.go</code>ä¸­å¯ä»¥æŸ¥çœ‹ç›¸å…³æ“ä½œã€‚</p><p>å…¶ä¸­é€šè¿‡å‘é€<code>CreateValidator</code>äº¤æ˜“ï¼Œæ–°å»ºéªŒè¯è€…ï¼Œå¹¶è®¾ç½®ç›¸å…³å‚æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> //handleMsgCreateValidator</span><br><span class="line">validator := NewValidator(msg.ValidatorAddress, msg.PubKey, msg.Description)</span><br><span class="line">commission := NewCommissionWithTime(</span><br><span class="line">msg.Commission.Rate, msg.Commission.MaxRate,</span><br><span class="line">msg.Commission.MaxChangeRate, ctx.BlockHeader().Time,</span><br><span class="line">)</span><br><span class="line">//è®¾ç½®ä½£é‡‘</span><br><span class="line">validator, err := validator.SetInitialCommission(commission)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err.Result()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">validator.MinSelfDelegation = msg.MinSelfDelegation</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæ›´æ–°éªŒè¯è€…æ˜¯<code>abci.EndBlock</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// Called every block, update validator set</span><br><span class="line">func EndBlocker(ctx sdk.Context, k keeper.Keeper) []abci.ValidatorUpdate &#123;</span><br><span class="line">validatorUpdates := k.ApplyAndReturnValidatorSetUpdates(ctx)</span><br><span class="line">return validatorUpdates</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (k Keeper) ApplyAndReturnValidatorSetUpdates(ctx sdk.Context) (updates []abci.ValidatorUpdate) &#123;</span><br><span class="line">//æ ¹æ®powerIndexé€†åºæ’åï¼Œpowerè¶Šå¤§ï¼Œæ’åè¶Šé å‰ï¼Œä¹Ÿå°±æ˜¯å–å‰maxValidatorsä½ä½œä¸ºéªŒè¯è€…</span><br><span class="line">iterator := sdk.KVStoreReversePrefixIterator(store, types.ValidatorsByPowerIndexKey)</span><br><span class="line">defer iterator.Close()</span><br><span class="line">for count := 0; iterator.Valid() &amp;&amp; count &lt; int(maxValidators); iterator.Next() &#123;</span><br><span class="line">..</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¿€åŠ±"><a href="#æ¿€åŠ±" class="headerlink" title="æ¿€åŠ±"></a>æ¿€åŠ±</h3><ul><li><p>Proposalå‡ºå—æ¦‚ç‡ï¼Œå‡è®¾æ‰€æœ‰éªŒè¯è€…çš„æ€»æƒç›Šæ˜¯100ï¼Œè‡ªå·±æ˜¯10ï¼Œåˆ™è‡ªå·±çš„å‡ºå—æ¦‚ç‡ä¸º10%</p></li><li><p>å‡ºå—å¥–åŠ±</p><p>å‡è®¾ç°åœ¨éªŒè¯äººçš„ä¸ªæ•°æ˜¯10ä¸ªï¼Œproposalçš„ä½£é‡‘ç‡æ˜¯1%ï¼Œè¿™ä¸ªåŒºå—çš„æŠ•ç¥¨ç‡æ˜¯100%ã€‚å‡è®¾å‡ºå—æ€»å¥–åŠ±æ—¶1025.51020408</p><ul><li><p>æ‰£ç¨ï¼Œ2%ï¼Œ å‰©ä½™1005</p></li><li><p>proposalæ ¹æ®åŒºå—çš„æŠ•ç¥¨ç‡è·å¾—é™„å±å¥–åŠ±(1% ~ 5%)ã€‚è¿™æ˜¯çš„æŠ•ç¥¨ç‡æ˜¯100%ï¼Œæ‰€ä»¥é™„å±å¥–åŠ±æ—¶5%ï¼Œæ‰€ä»¥è®¡ç®—æ¯ä¸ªéªŒè¯è€…åº”è¯¥è·å¾—ä¸º<code>9x + x + x *5% = 10005</code>ã€‚ç®—å¾—<code>x=100</code></p></li><li><p>é‚£ä¹ˆproposaléªŒè¯è€…æ‰€å¾—å¥–åŠ±ä¸º<code>100 + 100 *5%</code> = 105ã€‚105ä¸ºproposaléªŒè¯è€…åŠå…¶å§”æ‰˜äººæ€»å¾—å¥–åŠ±ï¼ŒéªŒè¯è€…è·å¾—æŒ‰å§”æ‰˜èµ„é‡‘æ¯”ä¾‹çš„å¥–åŠ± + ä½£é‡‘ã€‚å‡è®¾proposalå’Œå§”æ‰˜äººç»„æˆçš„å§”æ‰˜æ€»é‡‘é¢ä¸­æ¯”ä¾‹ä¸º2ï¼š8ï¼Œï¼Œå¹¶ä¸”ä½£é‡‘ç‡ä¸º1%ï¼Œé‚£ä¹ˆproposalæ‰€è·å¾—çš„å¥–åŠ±ä¸º105 * 80% *1% + 105 * 20 % = 21.84ã€‚å…¨éƒ¨å§”æ‰˜äººæ‰€è·å¾—çš„ä½£é‡‘ä¸º105 -  21.84 = 83.16ï¼Œå§”æ‰˜äººæŒ‰ç…§å§”æ‰˜é‡‘æ¯”ä¾‹è·å¾—å¥–åŠ±</p></li><li><p>å¯¹äºéproposalçš„å¥–åŠ±ä¸º100ï¼Œå‡è®¾å§”æ‰˜é‡‘é¢æ¯”ä¾‹ä¸º2ï¼š8ï¼ŒåŒæ ·ï¼ŒéªŒè¯è€…è·å¾—å¥–åŠ±ä¸º100 * 80% * 1% + 100 * 20% = 20.8ï¼Œå…¨éƒ¨å§”æ‰˜äººè·å¾—å¥–åŠ±ä¸º79.2</p></li><li><p>å¦å¤–ï¼Œå½“éªŒè¯è€…è¡Œä¸ºå‡ºç°ä¸åˆè§„æ—¶ï¼Œä¼šè¿›è¡Œæ‰£é’±ï¼Œä¾‹å¦‚éªŒè¯è€…å‡ºç°åŒé‡ç­¾åä¼šæ‰£é™¤5%æ€»å§”æ‰˜é‡‘ï¼Œå½“éªŒè¯è€…ä¸æŠ•ç¥¨æ—¶ï¼Œä¹Ÿä¼šæ‰£é™¤</p><blockquote><p>If a validator misses more than 95% of the last 10.000 blocks, they will get slashed by 0.01%</p></blockquote></li></ul></li></ul><p>å¦å¤–ï¼Œç›®å‰hubçš„éªŒè¯è€…æ€»å…±æ˜¯100ä¸ªï¼Œæ‰“ç®—æ ¹æ®æ—¶é—´æœ€åæ‰©å±•è‡³300ã€‚å§”æ‰˜äººè¦æç°æ—¶ï¼Œéœ€è¦ç­‰å¾…3å‘¨ï¼Œä»éªŒè¯è€…åˆ‡æ¢åˆ°å¦ä¸€éªŒè¯è€…ï¼Œä¸éœ€è¦ç­‰å¾…3å‘¨</p><h3 id="State"><a href="#State" class="headerlink" title="State"></a>State</h3><h4 id="Params"><a href="#Params" class="headerlink" title="Params"></a>Params</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type Params struct &#123;</span><br><span class="line">    UnbondingTime time.Duration // time duration of unbonding</span><br><span class="line">    MaxValidators uint16        // maximum number of validators</span><br><span class="line">    MaxEntries    uint16        // max entries for either unbonding delegation or redelegation (per pair/trio)</span><br><span class="line">    BondDenom     string        // bondable coin denomination</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Validator"><a href="#Validator" class="headerlink" title="Validator"></a>Validator</h4><p>validatorså¯ä»¥æœ‰ä»¥ä¸‹ä¸‰ç§çŠ¶æ€</p><ul><li>æœªç»‘å®š<code>Unbonded</code>,éªŒè¯äººå°šä¸åœ¨activeé›†åˆä¸­ï¼Œä¸èƒ½ç­¾ç½²åŒºå—ä»¥åŠè·å¾—å¥–åŠ±ï¼Œä»–ä»¬å¯ä»¥æ”¶åˆ°å§”æ‰˜</li><li>ç»‘å®š<code>Bonded</code>ï¼Œä¸€æ—¦éªŒè¯è€…æ”¶åˆ°äº†è¶³å¤Ÿçš„ç»‘å®štokenï¼Œä»–ä»¬å°±ä¼šåœ¨<code>EndBlock</code>æ—¶è‡ªåŠ¨åŠ å…¥activeé›†åˆï¼Œå¹¶ä¸”ä»–ä»¬çš„çŠ¶æ€ä¼šæ›´æ–°ä¸º<code>Binded</code>ã€‚è¿™ä¸ªæ˜¯å°±å¯ä»¥ç­¾ç½²åŒºå—å’Œæ”¶åˆ°å¥–åŠ±äº†ï¼Œä»–ä»¬å¯ä»¥ç»§ç»­è¢«å§”æ‰˜ï¼Œå½“ä»–ä»¬çŠ¯é”™æ—¶ä¹Ÿä¼šè¢«æ‰£é’±ã€‚å§”æ‰˜äººè¦è§£ç»‘ä»£ç†(æç°)æ—¶ï¼Œéœ€è¦ç­‰åˆ°è§£ç»‘æ—¶é—´<code>UnbondingTime</code>(é“¾çš„ç‰¹å®šå‚æ•°)åï¼Œåœ¨è§£ç»‘æ—¶é—´æ®µå†…ï¼Œå¦‚æœéªŒè¯äººçŠ¯é”™åŒæ ·ä¼šè¢«æ‰£é™¤ç›¸åº”ç»‘å®šçš„token</li><li>æœªç»‘å®š<code>Unbonding</code>ï¼Œå½“éªŒè¯è€…ç¦»å¼€activeé›†åˆçš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å› ä¸ºè‡ªåŠ¨é€€å‡ºè¿˜æ˜¯è¢«æ‰£é’±ç­‰ï¼Œæ‰€æœ‰å§”æ‰˜äººçš„<code>Unbonding</code>çš„å¼€å§‹äº†ï¼Œä»–ä»¬å¿…é¡»ç­‰å¾…è§£ç»‘æ—¶é—´<code>UnbondingTime</code>æ‰èƒ½ä»<code>BondedPool</code>ä¸­æ”¶åˆ°ä»–ä»¬çš„token</li></ul><p>Validatorså¯¹è±¡åº”é¦–å…ˆç”±OperatorAddrå­˜å‚¨å’Œè®¿é—®ï¼Œè¯¥ç¨‹åºæ˜¯éªŒè¯ç¨‹åºæ“ä½œå‘˜çš„SDKéªŒè¯ç¨‹åºåœ°å€ã€‚ æ¯ä¸ªValidatorså¯¹è±¡éƒ½ç»´æŠ¤ä¸¤ä¸ªé™„åŠ ç´¢å¼•ï¼Œä»¥ä¾¿æ»¡è¶³slashingå’Œvalidator-set æ›´æ–°çš„æ‰€éœ€æŸ¥æ‰¾ã€‚ è¿˜ä¿ç•™äº†ç¬¬ä¸‰ä¸ªç‰¹æ®Šç´¢å¼•ï¼ˆLastValidatorPowerï¼‰ï¼Œè¯¥ç´¢å¼•åœ¨æ•´ä¸ªæ¯ä¸ªå—ä¸­ä¿æŒä¸å˜ï¼Œè¿™ä¸å‰ä¸¤ä¸ªç´¢å¼•ä¸åŒï¼Œåè€…åæ˜ äº†å—ä¸­çš„éªŒè¯ç¨‹åºè®°å½•ã€‚</p><ul><li>Validators: <code>0x21 | OperatorAddr -&gt; amino(validator)</code></li><li>ValidatorsByConsAddr: <code>0x22 | ConsAddr -&gt; OperatorAddr</code></li><li>ValidatorsByPower: <code>0x23 | BigEndian(ConsensusPower) | OperatorAddr -&gt; OperatorAddr</code></li><li>LastValidatorsPower: <code>0x11 OperatorAddr -&gt; amino(ConsensusPower)</code></li></ul><p><code>Validators</code>æ˜¯ä¸»è¦ç´¢å¼•-å®ƒç¡®ä¿æ¯ä¸ªæ“ä½œå‘˜åªèƒ½æœ‰ä¸€ä¸ªå…³è”çš„éªŒè¯è€…ï¼Œè¯¥éªŒè¯ç¨‹åºçš„å…¬é’¥å°†æ¥å¯ä»¥æ›´æ”¹ã€‚ å§”æ‰˜äººå¯ä»¥å¼•ç”¨éªŒè¯ç¨‹åºçš„ä¸å˜è¿ç®—ç¬¦ï¼Œè€Œä¸å¿…æ‹…å¿ƒæ›´æ”¹å…¬é’¥ã€‚</p><p><code>ValidatorByConsAddr</code>æ˜¯ä¸€ä¸ªé™„åŠ ç´¢å¼•ï¼Œè¯¥ç´¢å¼•å¯ç”¨ç”¨äºslashingçš„æŸ¥æ‰¾ã€‚ å½“TendermintæŠ¥å‘Šè¯æ®æ—¶ï¼Œå®ƒå°†æä¾›éªŒè¯è€…åœ°å€ï¼Œå› æ­¤éœ€è¦æ­¤mapæ¥æŸ¥æ‰¾æ“ä½œã€‚ è¯·æ³¨æ„ï¼Œ<code>ConsAddr</code>å¯¹åº”äºå¯ä»¥ä»éªŒè¯è€…çš„<code>ConsPubKey</code>æ´¾ç”Ÿçš„åœ°å€ã€‚</p><p><code>ValidatorsByPower</code>æ˜¯ä¸€ä¸ªé™„åŠ ç´¢å¼•ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ’åºåˆ—è¡¨æˆ–æ½œåœ¨çš„éªŒè¯è€…ï¼Œä»¥å¿«é€Ÿç¡®å®šå½“å‰activeé›†ã€‚ è¿™é‡Œ<code>ConsensusPower</code>æ˜¯<code>validator.Tokens</code> / 10 ^ 6ã€‚ è¯·æ³¨æ„ï¼ŒJailedä¸ºtrueçš„æ‰€æœ‰éªŒè¯å™¨å‡æœªå­˜å‚¨åœ¨è¯¥ç´¢å¼•ä¸­ã€‚</p><p><code>LastValidatorsPower</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç´¢å¼•ï¼Œå®ƒæä¾›äº†æœ€åä¸€ä¸ªå—çš„ç»‘å®šéªŒè¯å™¨çš„å†å²åˆ—è¡¨ã€‚ è¯¥ç´¢å¼•åœ¨å—ä¸­ä¿æŒä¸å˜ï¼Œä½†åœ¨EndBlockä¸­è¿›è¡Œçš„éªŒè¯å™¨é›†æ›´æ–°è¿‡ç¨‹ä¸­è¿›è¡Œæ›´æ–°ã€‚</p><p>æ¯ä¸ªéªŒè¯è€…çš„çŠ¶æ€éƒ½ä¼šä¿å­˜å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">type Validator struct &#123;</span><br><span class="line">    OperatorAddress         sdk.ValAddress  // address of the validator&apos;s operator; bech encoded in JSON</span><br><span class="line">    ConsPubKey              crypto.PubKey   // the consensus public key of the validator; bech encoded in JSON</span><br><span class="line">    Jailed                  bool            // has the validator been jailed from bonded status?</span><br><span class="line">    Status                  sdk.BondStatus  // validator status (bonded/unbonding/unbonded)</span><br><span class="line">    Tokens                  sdk.Int         // delegated tokens (incl. self-delegation)</span><br><span class="line">    DelegatorShares         sdk.Dec         // total shares issued to a validator&apos;s delegators</span><br><span class="line">    Description             Description     // description terms for the validator</span><br><span class="line">    UnbondingHeight         int64           // if unbonding, height at which this validator has begun unbonding</span><br><span class="line">    UnbondingCompletionTime time.Time       // if unbonding, min time for the validator to complete unbonding</span><br><span class="line">    Commission              Commission      // commission parameters</span><br><span class="line">    MinSelfDelegation       sdk.Int         // validator&apos;s self declared minimum self delegation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Commission struct &#123;</span><br><span class="line">    CommissionRates</span><br><span class="line">    UpdateTime time.Time // the last time the commission rate was changed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CommissionRates struct &#123;</span><br><span class="line">    Rate          sdk.Dec // the commission rate charged to delegators, as a fraction</span><br><span class="line">    MaxRate       sdk.Dec // maximum commission rate which validator can ever charge, as a fraction</span><br><span class="line">    MaxChangeRate sdk.Dec // maximum daily increase of the validator commission, as a fraction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Description struct &#123;</span><br><span class="line">    Moniker          string // name</span><br><span class="line">    Identity         string // optional identity signature (ex. UPort or Keybase)</span><br><span class="line">    Website          string // optional website link</span><br><span class="line">    SecurityContact  string // optional email for security contact</span><br><span class="line">    Details          string // optional details</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h4><p>é€šè¿‡å°†DelegatorAddrï¼ˆå§”æ‰˜äººçš„åœ°å€ï¼‰ä¸ValidatorAddrç»„åˆåœ¨ä¸€èµ·æ¥æ ‡è¯†å§”æ‰˜ï¼Œè¿™äº›å§”æ‰˜äººåœ¨storeä¸­çš„ç´¢å¼•å¦‚ä¸‹ï¼š</p><ul><li>Delegation: <code>0x31 | DelegatorAddr | ValidatorAddr -&gt; amino(delegation)</code></li></ul><p>åˆ©ç›Šç›¸å…³è€…å¯ä»¥å°†Coinså§”æ‰˜ç»™éªŒè¯è€…ï¼› åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»–ä»¬çš„èµ„é‡‘å­˜æ”¾åœ¨â€œå§”æ‰˜â€æ•°æ®ç»“æ„ä¸­ã€‚ å®ƒç”±ä¸€ä½å§”æ‰˜äººæ‹¥æœ‰ï¼Œå¹¶ä¸ä¸€ä½éªŒè¯äººçš„è‚¡ä»½ï¼ˆSharesï¼‰ç›¸å…³è”ã€‚ äº¤æ˜“çš„å‘é€è€…æ˜¯å§”æ‰˜è€…ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type Delegation struct &#123;</span><br><span class="line">    DelegatorAddr sdk.AccAddress</span><br><span class="line">    ValidatorAddr sdk.ValAddress</span><br><span class="line">    Shares        sdk.Dec        // delegation shares received</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Delegator-Shares"><a href="#Delegator-Shares" class="headerlink" title="Delegator Shares"></a>Delegator Shares</h4><p>å½“ä¸€ä¸ªå§”æ‰˜Tokenåˆ†é…ç»™éªŒè¯è€…æ—¶ï¼Œå°†æ ¹æ®åŠ¨æ€æ±‡ç‡å‘ä»–ä»¬åˆ†é…ä¸€å®šæ•°é‡çš„ä»£ç†è‚¡ä»½<code>Delegator Shares</code>ï¼Œè¯¥ä»½é¢æ˜¯æ ¹æ®å§”æ‰˜ç»™éªŒè¯è€…çš„ä»£å¸æ€»æ•°å’Œè¿„ä»Šä¸ºæ­¢å‘è¡Œçš„è‚¡ç¥¨æ•°é‡è®¡ç®—å¾—å‡ºçš„</p><p><code>Shares per Token = validator.TotalShares() / validator.Tokens()</code></p><p>åªæœ‰æ”¶åˆ°çš„è‚¡ä»½æ•°é‡å­˜å‚¨åœ¨å§”æ‰˜å®ä¾‹ä¸­ã€‚ å½“å§”æ‰˜äººç„¶åå–æ¶ˆæˆæƒæ—¶ï¼Œæ ¹æ®ä»–ä»¬å½“å‰æŒæœ‰çš„è‚¡ä»½æ•°é‡å’Œé€†æ±‡ç‡è®¡ç®—æ”¶åˆ°çš„ä»£å¸æ•°é‡ï¼š</p><p><code>Tokens per Share = validator.Tokens() / validatorShares()</code></p><p>è¿™äº›è‚¡ä»½åªæ˜¯ä¸€ç§ä¼šè®¡æœºåˆ¶ã€‚ å®ƒä»¬ä¸æ˜¯å¯æ›¿ä»£çš„èµ„äº§ã€‚ è¿™ç§æœºåˆ¶çš„åŸå› æ˜¯ç®€åŒ–äº†å›´ç»•slashingçš„è®°å¸ã€‚ å¯ä»¥è¿­ä»£åœ°å‰Šå‡Validatorsçš„æ€»ç»‘å®šä»¤ç‰Œï¼Œè€Œä¸æ˜¯è¿­ä»£åœ°å‰Šå‡æ¯ä¸ªå§”æ‰˜æ¡ç›®çš„ä»¤ç‰Œï¼Œä»è€Œæœ‰æ•ˆåœ°å‡å°‘äº†æ¯ä¸ªå·²å‘è¡Œå§”æ‰˜äººä»½é¢çš„ä»·å€¼ã€‚</p><h4 id="UnbondingDelegation"><a href="#UnbondingDelegation" class="headerlink" title="UnbondingDelegation"></a>UnbondingDelegation</h4><p>å§”æ‰˜ä¸­çš„sharedå¯ä»¥è§£é™¤ç»‘å®šï¼Œä½†æ˜¯å¿…é¡»åœ¨ä¸€æ®µæ—¶é—´å†…ä»¥UnbondingDelegationçš„å½¢å¼å­˜åœ¨ï¼Œå¦‚æœæ£€æµ‹åˆ°æ‹œå åº­è¡Œä¸ºï¼Œåˆ™å¯ä»¥å‡å°‘å…±äº«ã€‚</p><p><code>UnbondingDelegation</code> are indexed in the store as:</p><ul><li>UnbondingDelegation: <code>0x32 | DelegatorAddr | ValidatorAddr -&gt;amino(unbondingDelegation)</code></li><li>UnbondingDelegationsFromValidator: <code>0x33 | ValidatorAddr | DelegatorAddr -&gt;nil</code></li></ul><p>æ­¤å¤„çš„ç¬¬ä¸€ä¸ªmapç”¨äºæŸ¥è¯¢ï¼Œä»¥æŸ¥æ‰¾ç»™å®šå§”æ‰˜äººçš„æ‰€æœ‰æœªç»‘å®šçš„å§”æ‰˜ï¼Œè€Œç¬¬äºŒä¸ªæ˜ å°„ç”¨äºslashingæŸ¥æ‰¾ï¼Œä»¥æŸ¥æ‰¾ä¸éœ€è¦å‰Šå‡çš„ç»™å®šéªŒè¯å™¨å…³è”çš„æ‰€æœ‰æ— çº¦æŸçš„å§”æ‰˜ã€‚ æ¯æ¬¡å¯åŠ¨å–æ¶ˆç»‘å®šæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªUnbondingDelegationå¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">type UnbondingDelegation struct &#123;</span><br><span class="line">    DelegatorAddr sdk.AccAddress             // delegator</span><br><span class="line">    ValidatorAddr sdk.ValAddress             // validator unbonding from operator addr</span><br><span class="line">    Entries       []UnbondingDelegationEntry // unbonding delegation entries</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type UnbondingDelegationEntry struct &#123;</span><br><span class="line">    CreationHeight int64     // height which the unbonding took place</span><br><span class="line">    CompletionTime time.Time // unix time for unbonding completion</span><br><span class="line">    InitialBalance sdk.Coin  // atoms initially scheduled to receive at completion</span><br><span class="line">    Balance        sdk.Coin  // atoms to receive at completion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Redelegation"><a href="#Redelegation" class="headerlink" title="Redelegation"></a>Redelegation</h4><p>å§”æ‰˜çš„ç»‘å®šä»£å¸ä»·å€¼å¯ä»¥ç«‹å³ä»æºéªŒè¯è€…é‡æ–°å§”æ´¾ç»™å…¶ä»–éªŒè¯è€…ï¼ˆç›®æ ‡éªŒè¯å™¨ï¼‰ã€‚ ä½†æ˜¯ï¼Œå½“å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œå¿…é¡»åœ¨â€œé‡æ–°æˆæƒâ€å¯¹è±¡ä¸­å¯¹å…¶è¿›è¡Œè·Ÿè¸ªï¼Œå¦‚æœå®ƒä»¬çš„ä»¤ç‰Œå¯¼è‡´æºéªŒè¯è€…æäº¤çš„æ‹œå åº­å¼é”™è¯¯ï¼Œåˆ™å¯ä»¥å‰Šå‡å…¶ä»½é¢ã€‚</p><p><code>Redelegation</code> are indexed in the store as:</p><ul><li>Redelegations: <code>0x34 | DelegatorAddr | ValidatorSrcAddr | ValidatorDstAddr -&gt; amino(redelegation)</code></li><li>RedelegationsBySrc: <code>0x35 | ValidatorSrcAddr | ValidatorDstAddr | DelegatorAddr -&gt; nil</code></li><li>RedelegationsByDst: <code>0x36 | ValidatorDstAddr | ValidatorSrcAddr | DelegatorAddr -&gt; nil</code></li></ul><p>ç¬¬ä¸€ä¸ªmapç”¨äºæŸ¥è¯¢ï¼Œä»¥æŸ¥æ‰¾ç»™å®šå§”æ‰˜äººçš„æ‰€æœ‰é‡æ–°æˆæƒã€‚ ç¬¬äºŒä¸ªmapç”¨äºåŸºäºValidatorSrcAddrçš„slashingï¼Œè€Œç¬¬ä¸‰ä¸ªmapç”¨äºåŸºäºValidatorDstAddrçš„slashingã€‚</p><p>æ¯æ¬¡é‡æ–°æˆæƒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªé‡æ–°æˆæƒå¯¹è±¡ã€‚ ä¸ºé˜²æ­¢â€œé‡æ–°æˆæƒè·³è·ƒâ€ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¯èƒ½ä¸ä¼šå‘ç”Ÿé‡æ–°æˆæƒï¼š</p><ul><li>ï¼ˆé‡æ–°ï¼‰å§”æ‰˜äººå·²ç»è¿›è¡Œäº†å¦ä¸€ä¸ªä¸æˆç†Ÿçš„é‡æ–°å§”æ‰˜ï¼Œå…¶ç›®çš„æ˜¯éªŒè¯è€…çš„ç›®çš„åœ°ï¼ˆæˆ‘ä»¬ç§°å…¶ä¸ºValidator Xï¼‰</li><li>å¹¶ä¸”ï¼Œï¼ˆé‡æ–°ï¼‰å§”æ‰˜äººæ­£åœ¨å°è¯•åˆ›å»ºæ–°çš„å§”æ‰˜äººï¼Œå…¶ä¸­æ­¤æ–°å§”æ‰˜äººçš„æºéªŒè¯äººæ˜¯Validator-Xã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Redelegation <span class="keyword">struct</span> &#123;</span><br><span class="line">    DelegatorAddr    sdk.AccAddress      <span class="comment">// delegator</span></span><br><span class="line">    ValidatorSrcAddr sdk.ValAddress      <span class="comment">// validator redelegation source operator addr</span></span><br><span class="line">    ValidatorDstAddr sdk.ValAddress      <span class="comment">// validator redelegation destination operator addr</span></span><br><span class="line">    Entries          []RedelegationEntry <span class="comment">// redelegation entries</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RedelegationEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">    CreationHeight <span class="keyword">int64</span>     <span class="comment">// height which the redelegation took place</span></span><br><span class="line">    CompletionTime time.Time <span class="comment">// unix time for redelegation completion</span></span><br><span class="line">    InitialBalance sdk.Coin  <span class="comment">// initial balance when redelegation started</span></span><br><span class="line">    Balance        sdk.Coin  <span class="comment">// current balance (current value held in destination validator)</span></span><br><span class="line">    SharesDst      sdk.Dec   <span class="comment">// amount of destination-validator shares created by redelegation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Queues"><a href="#Queues" class="headerlink" title="Queues"></a>Queues</h4><p>æ‰€æœ‰çš„é˜Ÿåˆ—å¯¹è±¡éƒ½æ ¹æ®æ—¶é—´æˆ³è¿›è¡Œæ’åºï¼Œé¦–å…ˆå°†ä»»ä½•é˜Ÿåˆ—ä¸­ä½¿ç”¨çš„æ—¶é—´å››èˆäº”å…¥åˆ°æœ€æ¥è¿‘çš„çº³ç§’ï¼Œç„¶åè¿›è¡Œæ’åºã€‚ ä½¿ç”¨çš„å¯æ’åºæ—¶é—´æ ¼å¼æ˜¯å¯¹RFC3339Nanoçš„ç•¥å¾®ä¿®æ”¹ï¼Œå¹¶ä½¿ç”¨æ ¼å¼å­—ç¬¦ä¸²â€œ 2006-01-02T15ï¼š04ï¼š05.000000000â€ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ªå½¢å¼</p><ul><li>right pads all zeros</li><li>drops the time zone info (uses UTC)</li></ul><p>åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œå­˜å‚¨çš„æ—¶é—´æˆ³éƒ½è¡¨ç¤ºé˜Ÿåˆ—å…ƒç´ çš„æˆç†Ÿæ—¶é—´ã€‚</p><h5 id="UnbondingDelegationQueue"><a href="#UnbondingDelegationQueue" class="headerlink" title="UnbondingDelegationQueue"></a>UnbondingDelegationQueue</h5><p>For the purpose of tracking progress of unbonding delegations the unbonding<br>delegations queue is kept.</p><ul><li>UnbondingDelegation: <code>0x41 | format(time) -&gt; []DVPair</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DVPair <span class="keyword">struct</span> &#123;</span><br><span class="line">    DelegatorAddr sdk.AccAddress</span><br><span class="line">    ValidatorAddr sdk.ValAddress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="RedelegationQueue"><a href="#RedelegationQueue" class="headerlink" title="RedelegationQueue"></a>RedelegationQueue</h5><p>For the purpose of tracking progress of redelegations the redelegation queue is<br>kept.</p><ul><li>UnbondingDelegation: <code>0x42 | format(time) -&gt; []DVVTriplet</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DVVTriplet <span class="keyword">struct</span> &#123;</span><br><span class="line">    DelegatorAddr    sdk.AccAddress</span><br><span class="line">    ValidatorSrcAddr sdk.ValAddress</span><br><span class="line">    ValidatorDstAddr sdk.ValAddress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ValidatorQueue"><a href="#ValidatorQueue" class="headerlink" title="ValidatorQueue"></a>ValidatorQueue</h5><p>For the purpose of tracking progress of unbonding validators the validator<br>queue is kept.</p><ul><li>ValidatorQueueTime: <code>0x43 | format(time) -&gt; []sdk.ValAddress</code></li></ul><p>The stored object as each key is an array of validator operator addresses from<br>which the validator object can be accessed.  Typically it is expected that only<br>a single validator record will be associated with a given timestamp however it is possible<br>that multiple validators exist in the queue at the same location.</p>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-abci</title>
      <link href="/2019/11/27/cosmos-abci/"/>
      <url>/2019/11/27/cosmos-abci/</url>
      
        <content type="html"><![CDATA[<h3 id="Cosmos-abci"><a href="#Cosmos-abci" class="headerlink" title="Cosmos abci"></a>Cosmos abci</h3><p>è®°å½•ä¸€ä¸‹cosmos-sdkä¸tendermint-abciçš„è¡”æ¥ã€‚</p><h4 id="tendermint"><a href="#tendermint" class="headerlink" title="tendermint"></a>tendermint</h4><ul><li><p>rpcè¯·æ±‚çš„è·¯ç”±åœ¨<code>rpc/core/routes.go</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var Routes = map[string]*rpc.RPCFunc&#123;</span><br><span class="line">// subscribe/unsubscribe are reserved for websocket events.</span><br><span class="line">&quot;subscribe&quot;:       rpc.NewWSRPCFunc(Subscribe, &quot;query&quot;),</span><br><span class="line">&quot;unsubscribe&quot;:     rpc.NewWSRPCFunc(Unsubscribe, &quot;query&quot;),</span><br><span class="line">&quot;unsubscribe_all&quot;: rpc.NewWSRPCFunc(UnsubscribeAll, &quot;&quot;),</span><br><span class="line"></span><br><span class="line">// info API</span><br><span class="line">&quot;health&quot;:               rpc.NewRPCFunc(Health, &quot;&quot;),</span><br><span class="line">&quot;status&quot;:               rpc.NewRPCFunc(Status, &quot;&quot;),</span><br><span class="line">&quot;net_info&quot;:             rpc.NewRPCFunc(NetInfo, &quot;&quot;),</span><br><span class="line">&quot;blockchain&quot;:           rpc.NewRPCFunc(BlockchainInfo, &quot;minHeight,maxHeight&quot;),</span><br><span class="line">&quot;genesis&quot;:              rpc.NewRPCFunc(Genesis, &quot;&quot;),</span><br><span class="line">&quot;block&quot;:                rpc.NewRPCFunc(Block, &quot;height&quot;),</span><br><span class="line">&quot;block_results&quot;:        rpc.NewRPCFunc(BlockResults, &quot;height&quot;),</span><br><span class="line">&quot;commit&quot;:               rpc.NewRPCFunc(Commit, &quot;height&quot;),</span><br><span class="line">&quot;tx&quot;:                   rpc.NewRPCFunc(Tx, &quot;hash,prove&quot;),</span><br><span class="line">&quot;tx_search&quot;:            rpc.NewRPCFunc(TxSearch, &quot;query,prove,page,per_page&quot;),</span><br><span class="line">&quot;validators&quot;:           rpc.NewRPCFunc(Validators, &quot;height&quot;),</span><br><span class="line">&quot;dump_consensus_state&quot;: rpc.NewRPCFunc(DumpConsensusState, &quot;&quot;),</span><br><span class="line">&quot;consensus_state&quot;:      rpc.NewRPCFunc(ConsensusState, &quot;&quot;),</span><br><span class="line">&quot;consensus_params&quot;:     rpc.NewRPCFunc(ConsensusParams, &quot;height&quot;),</span><br><span class="line">&quot;unconfirmed_txs&quot;:      rpc.NewRPCFunc(UnconfirmedTxs, &quot;limit&quot;),</span><br><span class="line">&quot;num_unconfirmed_txs&quot;:  rpc.NewRPCFunc(NumUnconfirmedTxs, &quot;&quot;),</span><br><span class="line"></span><br><span class="line">// tx broadcast API</span><br><span class="line">&quot;broadcast_tx_commit&quot;: rpc.NewRPCFunc(BroadcastTxCommit, &quot;tx&quot;),</span><br><span class="line">&quot;broadcast_tx_sync&quot;:   rpc.NewRPCFunc(BroadcastTxSync, &quot;tx&quot;),</span><br><span class="line">&quot;broadcast_tx_async&quot;:  rpc.NewRPCFunc(BroadcastTxAsync, &quot;tx&quot;),</span><br><span class="line">//...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥æ”¶åˆ°äº¤æ˜“ä¼šé€šè¿‡<code>CheckTx</code>è¿›å…¥äº¤æ˜“æ± ï¼Œåœ¨<code>mempool.clist_mempool.go</code></p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">func (mem *CListMempool) CheckTx(tx types.Tx, cb func(*abci.Response)) (err error) &#123;</span><br><span class="line">return mem.CheckTxWithInfo(tx, cb, TxInfo&#123;SenderID: UnknownPeerID&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (mem *CListMempool) CheckTxWithInfo(tx types.Tx, cb func(*abci.Response), txInfo TxInfo) (err error) &#123;</span><br><span class="line">mem.proxyMtx.Lock()</span><br><span class="line">// use defer to unlock mutex because application (*local client*) might panic</span><br><span class="line">defer mem.proxyMtx.Unlock()</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">memSize  = mem.Size()</span><br><span class="line">txsBytes = mem.TxsBytes()</span><br><span class="line">txSize   = len(tx)</span><br><span class="line">)</span><br><span class="line">  //...çœç•¥å¤šè¡Œä»£ç </span><br><span class="line">  //CheckTxAsyncæœ€ç»ˆè°ƒç”¨çš„æ˜¯abci.CheckTx</span><br><span class="line">reqRes := mem.proxyAppConn.CheckTxAsync(abci.RequestCheckTx&#123;Tx: tx&#125;)</span><br><span class="line">//è®¾ç½®å›è°ƒæ¥å†³å®šè¦ä¸è¦æ·»åŠ åˆ°äº¤æ˜“æ± ä¸­</span><br><span class="line">reqRes.SetCallback(mem.reqResCb(tx, txInfo.SenderID, txInfo.SenderP2PID, cb))</span><br><span class="line"></span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//è®¾ç½®çš„å›è°ƒï¼Œå³å½“abci.CheckTxè¿”å›æ—¶ï¼Œä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œé‡è¦çš„æ˜¯è°ƒç”¨resCbFirstTime</span><br><span class="line">func (mem *CListMempool) reqResCb(</span><br><span class="line">tx []byte,peerID uint16,peerP2PID p2p.ID,externalCb func(*abci.Response),</span><br><span class="line">) func(res *abci.Response) &#123;</span><br><span class="line">return func(res *abci.Response) &#123;</span><br><span class="line"> //...</span><br><span class="line">mem.resCbFirstTime(tx, peerID, peerP2PID, res)</span><br><span class="line">//..</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//resCbFirstTimeä¼šå†³å®šäº¤æ˜“ä¼šä¸ä¼šè¿›å…¥åˆ°äº¤æ˜“æ± ä¸­</span><br><span class="line">func (mem *CListMempool) resCbFirstTime(</span><br><span class="line">tx []byte, peerID uint16, peerP2PID p2p.ID, res *abci.Response) &#123;</span><br><span class="line">switch r := res.Value.(type) &#123;</span><br><span class="line">case *abci.Response_CheckTx:</span><br><span class="line">var postCheckErr error</span><br><span class="line">if mem.postCheck != nil &#123;</span><br><span class="line">postCheckErr = mem.postCheck(tx, r.CheckTx)</span><br><span class="line">&#125;</span><br><span class="line">//abci.CheckTxæ–¹æ³•è¿”å›é”™è¯¯å°±ä¸ä¼šæ·»åŠ åˆ°äº¤æ˜“æ± ä¸­</span><br><span class="line">if (r.CheckTx.Code == abci.CodeTypeOK) &amp;&amp; postCheckErr == nil &#123;</span><br><span class="line">memTx := &amp;mempoolTx&#123;</span><br><span class="line">height:    mem.height,</span><br><span class="line">gasWanted: r.CheckTx.GasWanted,</span><br><span class="line">tx:        tx,</span><br><span class="line">&#125;</span><br><span class="line">memTx.senders.Store(peerID, true)</span><br><span class="line">mem.addTx(memTx)</span><br><span class="line">    &#125;</span><br><span class="line">    //...</span><br><span class="line">default:</span><br><span class="line">// ignore other messages</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>state/execution.go</code>ä¸­çš„<code>CreateProposal</code>æ–¹æ³•ä¼šå°†äº¤æ˜“æ± ä¸­çš„äº¤æ˜“å–å‡ºæ¥è¿›è¡Œæ‰“åŒ…ç»„æˆåŒºå—</p></li><li><p><code>state/execution.go</code>ä¸­åŒºå—ç»„æˆåï¼Œæ‰§è¡Œäº¤æ˜“åœ¨è¿™é‡Œ<code>execBlockOnProxyApp</code>æ–¹æ³•é‡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">func execBlockOnProxyApp(logger log.Logger, proxyAppConn proxy.AppConnConsensus, block *types.Block, stateDB dbm.DB) (*ABCIResponses, error) &#123;</span><br><span class="line">var validTxs, invalidTxs = 0, 0</span><br><span class="line"></span><br><span class="line">txIndex := 0</span><br><span class="line">abciResponses := NewABCIResponses(block)</span><br><span class="line"></span><br><span class="line">//è®¾ç½®å›è°ƒï¼Œå½“abci.DeliverTxæ‰§è¡Œå®Œåï¼Œç»Ÿè®¡äº¤æ˜“æˆåŠŸå’Œå¤±è´¥</span><br><span class="line">// Execute transactions and get hash.</span><br><span class="line">proxyCb := func(req *abci.Request, res *abci.Response) &#123;</span><br><span class="line">if r, ok := res.Value.(*abci.Response_DeliverTx); ok &#123;</span><br><span class="line">// TODO: make use of res.Log</span><br><span class="line">// TODO: make use of this info</span><br><span class="line">// Blocks may include invalid txs.</span><br><span class="line">txRes := r.DeliverTx</span><br><span class="line">if txRes.Code == abci.CodeTypeOK &#123;</span><br><span class="line">validTxs++</span><br><span class="line">&#125; else &#123;</span><br><span class="line">logger.Debug(&quot;Invalid tx&quot;, &quot;code&quot;, txRes.Code, &quot;log&quot;, txRes.Log)</span><br><span class="line">invalidTxs++</span><br><span class="line">&#125;</span><br><span class="line">abciResponses.DeliverTx[txIndex] = txRes</span><br><span class="line">txIndex++</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">proxyAppConn.SetResponseCallback(proxyCb)</span><br><span class="line"></span><br><span class="line">commitInfo, byzVals := getBeginBlockValidatorInfo(block, stateDB)</span><br><span class="line"></span><br><span class="line">  //abci.BeginBlockåœ¨è¿™é‡Œä¼šè¢«è°ƒç”¨</span><br><span class="line">// Begin block</span><br><span class="line">var err error</span><br><span class="line">abciResponses.BeginBlock, err = proxyAppConn.BeginBlockSync(abci.RequestBeginBlock&#123;</span><br><span class="line">Hash:                block.Hash(),</span><br><span class="line">Header:              types.TM2PB.Header(&amp;block.Header),</span><br><span class="line">LastCommitInfo:      commitInfo,</span><br><span class="line">ByzantineValidators: byzVals,</span><br><span class="line">&#125;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">logger.Error(&quot;Error in proxyAppConn.BeginBlock&quot;, &quot;err&quot;, err)</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  //abci.DeliverTxåœ¨è¿™é‡Œä¼šè¢«è°ƒç”¨ï¼Œä½†æ³¨æ„çš„æ˜¯ï¼Œå°±ç®—DeliverTxç»“æœè¿”å›é”™è¯¯ï¼Œè¿™é‡Œä¹Ÿä¸ä¼šå½±å“äº¤æ˜“å…¥å—ï¼Œè®°å½•åœ¨é“¾ä¸Šçš„äº¤æ˜“ä¼šåŒ…å«å¤±è´¥çš„ç»“æœ</span><br><span class="line">// Run txs of block.</span><br><span class="line">for _, tx := range block.Txs &#123;</span><br><span class="line">proxyAppConn.DeliverTxAsync(abci.RequestDeliverTx&#123;Tx: tx&#125;)</span><br><span class="line">if err := proxyAppConn.Error(); err != nil &#123;</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//abci.EndBlockåœ¨è¿™é‡Œä¼šè¢«è°ƒç”¨</span><br><span class="line">// End block.</span><br><span class="line">abciResponses.EndBlock, err = proxyAppConn.EndBlockSync(abci.RequestEndBlock&#123;Height: block.Height&#125;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">logger.Error(&quot;Error in proxyAppConn.EndBlock&quot;, &quot;err&quot;, err)</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logger.Info(&quot;Executed block&quot;, &quot;height&quot;, block.Height, &quot;validTxs&quot;, validTxs, &quot;invalidTxs&quot;, invalidTxs)</span><br><span class="line"></span><br><span class="line">return abciResponses, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä»¥ä¸Šä»£ç <code>proxyAppConn</code>çš„å®ç°ä¹‹ä¸€ä¸º<code>abci/client/local_client.go</code>ã€‚</p><p><code>local_client</code>ä¸­ä¸»è¦æ˜¯ä½¿ç”¨ä»¥ä¸‹è¿™ä¸ªæ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">type Application interface &#123;</span><br><span class="line">// Info/Query Connection</span><br><span class="line">Info(RequestInfo) ResponseInfo                // Return application info</span><br><span class="line">SetOption(RequestSetOption) ResponseSetOption // Set application option</span><br><span class="line">Query(RequestQuery) ResponseQuery             // Query for state</span><br><span class="line"></span><br><span class="line">// Mempool Connection</span><br><span class="line">CheckTx(RequestCheckTx) ResponseCheckTx // Validate a tx for the mempool</span><br><span class="line"></span><br><span class="line">// Consensus Connection</span><br><span class="line">InitChain(RequestInitChain) ResponseInitChain    // Initialize blockchain w validators/other info from TendermintCore</span><br><span class="line">BeginBlock(RequestBeginBlock) ResponseBeginBlock // Signals the beginning of a block</span><br><span class="line">DeliverTx(RequestDeliverTx) ResponseDeliverTx    // Deliver a tx for full processing</span><br><span class="line">EndBlock(RequestEndBlock) ResponseEndBlock       // Signals the end of a block, returns changes to the validator set</span><br><span class="line">Commit() ResponseCommit                          // Commit the state and return the application Merkle root hash</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯abciçš„æ¥å£äº†ã€‚<code>cosmos-sdk</code>å®ç°çš„å°±å®ç°è¿™ä¸ªæ¥å£</p></li></ul><h4 id="cosmos-sdk"><a href="#cosmos-sdk" class="headerlink" title="cosmos-sdk"></a><code>cosmos-sdk</code></h4><p>  åœ¨<code>baseapp/abci.go</code>é‡Œæ˜¯å¯¹<code>Application</code>çš„å®ç°ã€‚</p><p>  ç„¶åäº¤æ˜“çš„å¤„ç†éƒ½åœ¨<code>baseapp/baseapp.go</code>é‡Œã€‚</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">func (app *BaseApp) runTx(mode runTxMode, txBytes []byte, tx sdk.Tx) (result sdk.Result) &#123;</span><br><span class="line">//..çœç•¥ä»£ç nè¡Œ</span><br><span class="line"></span><br><span class="line">var msgs = tx.GetMsgs()</span><br><span class="line">// x/xx/types/msgä¼šå®ç°è¿™ä¸ªæ–¹æ³•</span><br><span class="line">if err := validateBasicTxMsgs(msgs); err != nil &#123;</span><br><span class="line">return err.Result()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if app.anteHandler != nil &#123;</span><br><span class="line">var anteCtx sdk.Context</span><br><span class="line">var msCache sdk.CacheMultiStore</span><br><span class="line"></span><br><span class="line">// Cache wrap context before anteHandler call in case it aborts.</span><br><span class="line">// This is required for both CheckTx and DeliverTx.</span><br><span class="line">// Ref: https://github.com/cosmos/cosmos-sdk/issues/2772</span><br><span class="line">//</span><br><span class="line">// NOTE: Alternatively, we could require that anteHandler ensures that</span><br><span class="line">// writes do not happen if aborted/failed.  This may have some</span><br><span class="line">// performance benefits, but it&apos;ll be more difficult to get right.</span><br><span class="line">anteCtx, msCache = app.cacheTxContext(ctx, txBytes)</span><br><span class="line"></span><br><span class="line">   //è¿™ä¸ªæ–¹æ³•ä¹Ÿåœ¨å¤–é¢å®šä¹‰</span><br><span class="line">newCtx, err := app.anteHandler(anteCtx, tx, mode == runTxModeSimulate)</span><br><span class="line">if !newCtx.IsZero() &#123;</span><br><span class="line">// At this point, newCtx.MultiStore() is cache-wrapped, or something else</span><br><span class="line">// replaced by the ante handler. We want the original multistore, not one</span><br><span class="line">// which was cache-wrapped for the ante handler.</span><br><span class="line">//</span><br><span class="line">// Also, in the case of the tx aborting, we need to track gas consumed via</span><br><span class="line">// the instantiated gas meter in the ante handler, so we update the context</span><br><span class="line">// prior to returning.</span><br><span class="line">ctx = newCtx.WithMultiStore(ms)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// GasMeter expected to be set in AnteHandler</span><br><span class="line">gasWanted = ctx.GasMeter().Limit()</span><br><span class="line"></span><br><span class="line">if err != nil &#123;</span><br><span class="line">res := sdk.ResultFromError(err)</span><br><span class="line">res.GasWanted = gasWanted</span><br><span class="line">res.GasUsed = ctx.GasMeter().GasConsumed()</span><br><span class="line">return res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msCache.Write()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Create a new Context based off of the existing Context with a cache-wrapped</span><br><span class="line">// MultiStore in case message processing fails. At this point, the MultiStore</span><br><span class="line">// is doubly cached-wrapped.</span><br><span class="line">runMsgCtx, msCache := app.cacheTxContext(ctx, txBytes)</span><br><span class="line">//æœ€åæ˜¯è¿™ä¸ªæ–¹æ³•</span><br><span class="line">result = app.runMsgs(runMsgCtx, msgs, mode)</span><br><span class="line">result.GasWanted = gasWanted</span><br><span class="line"></span><br><span class="line">// Safety check: don&apos;t write the cache state unless we&apos;re in DeliverTx.</span><br><span class="line">if mode != runTxModeDeliver &#123;</span><br><span class="line">return result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// only update state if all messages pass</span><br><span class="line">if result.IsOK() &#123;</span><br><span class="line">msCache.Write()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ’ä»¶åŒ–é‡Œï¼Œä¸Šé¢ç‰µæ¶‰åˆ°3ä¸ªä¼šè°ƒæ’ä»¶çš„åœ°æ–¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">type Msg interface &#123;</span><br><span class="line"></span><br><span class="line">// Return the message type.</span><br><span class="line">// Must be alphanumeric or empty.</span><br><span class="line">Route() string</span><br><span class="line"></span><br><span class="line">// Returns a human-readable string for the message, intended for utilization</span><br><span class="line">// within tags</span><br><span class="line">Type() string</span><br><span class="line"></span><br><span class="line">// ValidateBasic does a simple validation check that</span><br><span class="line">// doesn&apos;t require access to any other information.</span><br><span class="line">ValidateBasic() Error</span><br><span class="line"></span><br><span class="line">// Get the canonical byte representation of the Msg.</span><br><span class="line">GetSignBytes() []byte</span><br><span class="line"></span><br><span class="line">// Signers returns the addrs of signers that must sign.</span><br><span class="line">// CONTRACT: All signatures must be present to be valid.</span><br><span class="line">// CONTRACT: Returns addrs in some deterministic order.</span><br><span class="line">GetSigners() []AccAddress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨x/xx/types/msg.goä¸‹ä¼šå®ç°è¿™ä¸ªæ¥å£ï¼Œåœ¨CheckTxæˆ–è€…DeliverTxçš„æ—¶å€™éƒ½ä¼šè°ƒç”¨<code>ValidateBasic</code>æ–¹æ³•</p><p> å…¶æ¬¡æ˜¯ï¼ŒanteHandlerï¼Œå¦‚æœå¤–é¢åˆå§‹åŒ–æ—¶èµ‹å€¼äº†ï¼ŒCheckTxæˆ–è€…DeliverTxæ—¶å°±ä¼šæ‰§è¡Œ</p><p>æœ€åæ˜¯ï¼ŒrunMsgsï¼ŒrunMsgé‡Œå…¶å®æ˜¯æ ¹æ®Txæ¶ˆæ¯çš„è·¯ç”±ï¼Œæ‰¾åˆ°å¯¹åº”çš„Handlerè¿›è¡Œå¤„ç†ï¼Œåœ¨x/xx/Handler.goä¼šæœ‰å…·ä½“å¤„ç†ï¼Œè·¯ç”±æ˜¯åœ¨å®ä¾‹åŒ–appæ—¶è¿›è¡Œapp.AddRouterè¿›è¡Œæ·»åŠ è¿›å»çš„ã€‚å¦‚ä¸‹gaiaä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// RegisterRoutes registers all module routes and module querier routes</span><br><span class="line">func (m *Manager) RegisterRoutes(router sdk.Router, queryRouter sdk.QueryRouter) &#123;</span><br><span class="line">for _, module := range m.Modules &#123;</span><br><span class="line">if module.Route() != &quot;&quot; &#123;</span><br><span class="line">router.AddRoute(module.Route(), module.NewHandler())</span><br><span class="line">&#125;</span><br><span class="line">if module.QuerierRoute() != &quot;&quot; &#123;</span><br><span class="line">queryRouter.AddRoute(module.QuerierRoute(), module.NewQuerierHandler())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åä¸€å¥ï¼ŒæŸ¥è¯¢è·¯ç”±ä¹Ÿæ˜¯åœ¨è¿™é‡Œæ·»åŠ çš„ã€‚æ‰€ä»¥åœ¨æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>Query</code>çš„æ—¶å€™ï¼Œå°±ä¼šèµ°å¯¹åº”çš„è·¯ç”±ã€‚</p><h2 id="å¦èµ·ä¸€è¡Œ"><a href="#å¦èµ·ä¸€è¡Œ" class="headerlink" title="å¦èµ·ä¸€è¡Œ"></a>å¦èµ·ä¸€è¡Œ</h2><h3 id="è¿™é‡Œç”±æ›´æ–°éªŒè¯è€…ä¸ºå¥‘æœºï¼ŒæŸ¥çœ‹ç›¸å…³çš„ä»£ç ï¼Œæ‹ä¸‹ç»“æ„ã€‚"><a href="#è¿™é‡Œç”±æ›´æ–°éªŒè¯è€…ä¸ºå¥‘æœºï¼ŒæŸ¥çœ‹ç›¸å…³çš„ä»£ç ï¼Œæ‹ä¸‹ç»“æ„ã€‚" class="headerlink" title="è¿™é‡Œç”±æ›´æ–°éªŒè¯è€…ä¸ºå¥‘æœºï¼ŒæŸ¥çœ‹ç›¸å…³çš„ä»£ç ï¼Œæ‹ä¸‹ç»“æ„ã€‚"></a>è¿™é‡Œç”±æ›´æ–°éªŒè¯è€…ä¸ºå¥‘æœºï¼ŒæŸ¥çœ‹ç›¸å…³çš„ä»£ç ï¼Œæ‹ä¸‹ç»“æ„ã€‚</h3><h4 id="æ›´æ–°è®¾ç½®éªŒè¯è€…çš„æ–¹å¼"><a href="#æ›´æ–°è®¾ç½®éªŒè¯è€…çš„æ–¹å¼" class="headerlink" title="æ›´æ–°è®¾ç½®éªŒè¯è€…çš„æ–¹å¼"></a>æ›´æ–°è®¾ç½®éªŒè¯è€…çš„æ–¹å¼</h4><ul><li>genesisé‡Œè¿›è¡Œé…ç½®</li><li>å‘é€CreateValidatoräº¤æ˜“æ·»åŠ éªŒè¯è€…ï¼Œ<code>staking</code>æ¨¡å—ä¼šå¤„ç†è¿™ä¸ªäº¤æ˜“ï¼Œå¹¶ä¸”åœ¨<code>abci.EndBlock</code>è°ƒç”¨æ—¶ï¼Œ<code>staking</code>æ¨¡å—è¿”å›éœ€è¦æ›´æ–°çš„éªŒè¯è€…é›†åˆã€‚</li></ul><h5 id="genesisé‡Œé…ç½®éªŒè¯è€…çš„ä¼ é€’"><a href="#genesisé‡Œé…ç½®éªŒè¯è€…çš„ä¼ é€’" class="headerlink" title="genesisé‡Œé…ç½®éªŒè¯è€…çš„ä¼ é€’"></a>genesisé‡Œé…ç½®éªŒè¯è€…çš„ä¼ é€’</h5><p><code>cosmos</code>å¯åŠ¨æ—¶è°ƒç”¨<code>tendermint</code>çš„nodeä»£ç ï¼Œä¼ å…¥ç›¸å…³é…ç½®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//cosmos/server/start.go</span><br><span class="line">func startInProcess(ctx *Context, appCreator AppCreator) (*node.Node, error) &#123;</span><br><span class="line">// create &amp; start tendermint node</span><br><span class="line">tmNode, err := node.NewNode(</span><br><span class="line">cfg,</span><br><span class="line">pvm.LoadOrGenFilePV(cfg.PrivValidatorKeyFile(), cfg.PrivValidatorStateFile()),</span><br><span class="line">nodeKey,</span><br><span class="line">proxy.NewLocalClientCreator(app),</span><br><span class="line">node.DefaultGenesisDocProviderFunc(cfg),</span><br><span class="line">node.DefaultDBProvider,</span><br><span class="line">node.DefaultMetricsProvider(cfg.Instrumentation),</span><br><span class="line">ctx.Logger.With(&quot;module&quot;, &quot;node&quot;),</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//tendermint/node/node.go</span><br><span class="line">func NewNode(config *cfg.Config, privValidator types.PrivValidator,</span><br><span class="line">nodeKey *p2p.NodeKey, clientCreator proxy.ClientCreator,</span><br><span class="line">genesisDocProvider GenesisDocProvider, dbProvider DBProvider, metricsProvider MetricsProvider, logger log.Logger, options ...Option) (*Node, error) &#123;</span><br><span class="line"></span><br><span class="line">blockStore, stateDB, err := initDBs(config, dbProvider)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//stateæ˜¯é“¾çš„ç›¸å…³çŠ¶æ€ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ï¼Œä¸Šä¸€ä¸ªåŒºå—iDï¼Œå½“å‰éªŒè¯è€…é›†åˆï¼Œä¸‹ä¸€ä¸ªéªŒè¯è€…é›†åˆç­‰</span><br><span class="line">//genDocæ˜¯genesisä¸­åŒ…å«çš„é“¾çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬éªŒè¯è€…é›†åˆç­‰</span><br><span class="line">//stateå’ŒgenDocéƒ½ä¸dbäº¤äº’</span><br><span class="line">state, genDoc, err := LoadStateFromDBOrGenesisDocProvider(stateDB, genesisDocProvider)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line"> //...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>tendermint</code>ä¸­ï¼Œ<code>state</code>å­˜å‚¨åœ¨dbä¸­çš„keyä¸º<code>stateKey</code>ï¼Œä¿å­˜äº†é“¾çš„å½“å‰ç›¸å…³çŠ¶æ€ã€‚</p><p>åœ¨<code>cosmos</code>çš„<code>staking</code>ä¸­ä¹Ÿåº”è¯¥å­˜å‚¨äº†éªŒè¯è€…é›†åˆï¼Œä¸€ä¼šæƒ³å¾—èµ·æ¥æˆ‘å°±å»çœ‹çœ‹æ€ä¹ˆæŸ¥è¯¢ã€‚</p><h5 id="staking"><a href="#staking" class="headerlink" title="staking"></a>staking</h5><p><code>staking</code>æ˜¯cosmoså®ç°ç”¨æ¥é€‰æ‹©éªŒè¯è€…é›†åˆã€‚åœ¨<code>staking</code>çš„<code>handler.go</code>ä¸­å¯ä»¥æŸ¥çœ‹ç›¸å…³æ“ä½œã€‚</p><p>å…¶ä¸­é€šè¿‡å‘é€<code>CreateValidator</code>äº¤æ˜“ï¼Œæ–°å»ºéªŒè¯è€…ï¼Œå¹¶è®¾ç½®ç›¸å…³å‚æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> //handleMsgCreateValidator</span><br><span class="line">validator := NewValidator(msg.ValidatorAddress, msg.PubKey, msg.Description)</span><br><span class="line">commission := NewCommissionWithTime(</span><br><span class="line">msg.Commission.Rate, msg.Commission.MaxRate,</span><br><span class="line">msg.Commission.MaxChangeRate, ctx.BlockHeader().Time,</span><br><span class="line">)</span><br><span class="line">//è®¾ç½®ä½£é‡‘</span><br><span class="line">validator, err := validator.SetInitialCommission(commission)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err.Result()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">validator.MinSelfDelegation = msg.MinSelfDelegation</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæ›´æ–°éªŒè¯è€…æ˜¯<code>abci.EndBlock</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// Called every block, update validator set</span><br><span class="line">func EndBlocker(ctx sdk.Context, k keeper.Keeper) []abci.ValidatorUpdate &#123;</span><br><span class="line">validatorUpdates := k.ApplyAndReturnValidatorSetUpdates(ctx)</span><br><span class="line">return validatorUpdates</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (k Keeper) ApplyAndReturnValidatorSetUpdates(ctx sdk.Context) (updates []abci.ValidatorUpdate) &#123;</span><br><span class="line">//æ ¹æ®powerIndexé€†åºæ’åï¼Œpowerè¶Šå¤§ï¼Œæ’åè¶Šé å‰ï¼Œä¹Ÿå°±æ˜¯å–å‰maxValidatorsä½ä½œä¸ºéªŒè¯è€…</span><br><span class="line">iterator := sdk.KVStoreReversePrefixIterator(store, types.ValidatorsByPowerIndexKey)</span><br><span class="line">defer iterator.Close()</span><br><span class="line">for count := 0; iterator.Valid() &amp;&amp; count &lt; int(maxValidators); iterator.Next() &#123;</span><br><span class="line">..</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-store</title>
      <link href="/2019/11/26/cosmos-store/"/>
      <url>/2019/11/26/cosmos-store/</url>
      
        <content type="html"><![CDATA[<h3 id="Cosmos-state"><a href="#Cosmos-state" class="headerlink" title="Cosmos state"></a>Cosmos state</h3><p> åœ¨ä½¿ç”¨æ—¶æœ‰ç”¨åˆ°æŸ¥è¯¢å­˜å‚¨çš„å€¼çš„apiï¼Œè¿™ä¸ªapiä¸ä»…è¿”å›äº†keyå¯¹åº”çš„valueï¼Œè¿˜è¿”å›äº†proofã€‚ä½¿ç”¨proofå¯è¯æ˜è¿™ä¸ªvalueçš„ç¡®å­˜å‚¨åœ¨é“¾ä¸Šã€‚è¿™æ˜¯æ€ä¹ˆè¯æ˜çš„å‘¢ï¼Ÿ</p><p>ç¿»äº†ä¸‹æºç ï¼Œå¤§æ¦‚äº†è§£åˆ°æ˜¯æ€ä¹ˆè¯æ˜çš„äº†ã€‚éšæ‰‹ä¹Ÿè®°å½•ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆï¼Œåœ¨cosms-sdkä¸­çš„è®¾è®¡æ˜¯æ’ä»¶å¼ï¼Œå¯ä»¥æ®æƒ…å†µä½¿ç”¨<code>x/</code>åŒ…ä¸‹çš„æ’ä»¶ã€‚</p><p>åœ¨å­˜å‚¨ä¸Šçš„è¯ï¼Œä½¿ç”¨çš„æ˜¯<code>store/rootmulti/store.go</code>..  ï¼Œæ ¹æ®åŒ…åçŒœæµ‹ä¸‹æ˜¯ä¼šæœ‰å¤šé¢—æ ‘ï¼Œç„¶åæ¯é¢—ä¸€ä¸ªrootï¼Œå¤šä¸ªrootåˆç»„æˆä¸€é¢—æ ‘ã€‚æ ¹æ®ä¸Šé¢çš„æ’ä»¶ï¼Œæ‰€ä»¥å°±æ˜¯æ®æƒ…å†µå¤šä¸ªæ’ä»¶ï¼Œå¤šé¢—æ ‘å§ã€‚</p><h4 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p><code>store/rootmulti/store.go</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">type Store struct &#123;</span><br><span class="line">db           dbm.DB  //ç”¨äºæŒä¹…åŒ–å­˜å‚¨çš„db</span><br><span class="line">lastCommitID types.CommitID</span><br><span class="line">pruningOpts  types.PruningOptions</span><br><span class="line">storesParams map[types.StoreKey]storeParams //1</span><br><span class="line">stores       map[types.StoreKey]types.CommitKVStore //2</span><br><span class="line">keysByName   map[string]types.StoreKey  //3</span><br><span class="line">lazyLoading  bool</span><br><span class="line"></span><br><span class="line">traceWriter  io.Writer</span><br><span class="line">traceContext types.TraceContext</span><br><span class="line"></span><br><span class="line">interBlockCache types.MultiStorePersistentCache</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çœ‹åˆ°1ã€2ã€3å¤„ä¸ºmapç»“æ„ã€‚3çš„è¯æ¯”è¾ƒæ˜æ˜¾æ˜¯keyæ˜¯stringç±»å‹ï¼Œvalueæ˜¯å°è£…çš„æŸKeyç±»å‹ï¼Œè¿™ä¸ªæŸKeyç±»å‹åˆšå¥½æ˜¯1å’Œ2çš„ keyï¼Œæ³¨æ„åˆ°1çš„valueç±»å‹æ˜¯storeParamsï¼Œå¥½åƒåªæ˜¯å‚æ•°ï¼Œä¸æ˜¯æˆ‘æƒ³è¦çš„æ ‘ç»“æ„ã€‚ä½†æ˜¯2çš„ç±»å‹<code>types.CommitKVStore</code>ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹åƒã€‚<code>types.CommitKVStore</code>æ˜¯æ¥å£ç±»å‹ï¼Œå®ç°æœ‰<code>store/transient/store.go</code>å’Œ<code>store/iavl/store.go</code>ï¼Œè¿™é‡Œiavlå¥½åƒå¾ˆç†Ÿæ‚‰â€¦gaiaä¸­å¯¹storeå®ä¾‹åŒ–é»˜è®¤é€‰æ‹©çš„æ˜¯iavlã€‚é‚£ä¹ˆ<code>ival</code>å°±æ˜¯æˆ‘æƒ³æ‰¾çš„ç­”æ¡ˆå•¦ã€‚</p><h5 id="ival"><a href="#ival" class="headerlink" title="ival"></a>ival</h5><p><code>store/iavl/store.go</code>é‡Œæœ‰æˆ‘æƒ³æ‰¾çš„treeç»“æ„ï¼Œä½†â€¦æ—¶é—´é™åˆ¶..æˆ‘æ²¡çœ‹å®ç°ğŸ¤¦â€â™€ï¸</p><p>ç®€å•è€Œè¨€ï¼Œæˆ‘é€‰æ‹©ä»æµ‹è¯•å…¥æ‰‹â€¦ é¦–å…ˆæ˜¯è¿™é‡Œé¢çš„treeçš„å­˜å‚¨æ˜¯å¸¦æœ‰ç‰ˆæœ¬çš„..ç›¸å½“äºä¼šæ ¹æ®ç‰ˆæœ¬å­˜å‚¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">//store/iavl/store_test.go</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">treeData = map[string]string&#123;</span><br><span class="line">&quot;hello&quot;: &quot;goodbye&quot;,</span><br><span class="line">&quot;aloha&quot;: &quot;shalom&quot;,</span><br><span class="line">&#125;</span><br><span class="line">nMoreData = 0</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func newAlohaTree(t *testing.T, db dbm.DB) (*iavl.MutableTree, types.CommitID) &#123;</span><br><span class="line">tree := iavl.NewMutableTree(db, cacheSize)</span><br><span class="line">for k, v := range treeData &#123;</span><br><span class="line">tree.Set([]byte(k), []byte(v))  //&quot;hello&quot; =&gt; &quot;goodbye&quot;; &quot;aloha&quot; =&gt;&quot;shalom&quot;</span><br><span class="line">&#125;</span><br><span class="line">for i := 0; i &lt; nMoreData; i++ &#123;</span><br><span class="line">key := cmn.RandBytes(12)</span><br><span class="line">value := cmn.RandBytes(50)</span><br><span class="line">tree.Set(key, value)</span><br><span class="line">&#125;</span><br><span class="line">hash, ver, err := tree.SaveVersion()</span><br><span class="line">require.Nil(t, err)</span><br><span class="line">return tree, types.CommitID&#123;Version: ver, Hash: hash&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func TestGetImmutable(t *testing.T) &#123;</span><br><span class="line">db := dbm.NewMemDB()</span><br><span class="line">tree, cID := newAlohaTree(t, db)   //åˆå§‹åŒ–treeå¹¶ä¸”æ”¾å…¥ä¸€äº›key-valueå¯¹ï¼Œå¹¶ä¸”saveVersionä¸€æ¬¡</span><br><span class="line">//version=1</span><br><span class="line">store := UnsafeNewStore(tree, 10, 10)</span><br><span class="line">//å°†treeä¸­çš„key=&quot;hello&quot;çš„valueç”±&quot;goodbye&quot;æ›´æ”¹ä¸º&quot;adios&quot;</span><br><span class="line">require.True(t, tree.Set([]byte(&quot;hello&quot;), []byte(&quot;adios&quot;)))  </span><br><span class="line">hash, ver, err := tree.SaveVersion()  //verå†æ¬¡æ›´æ–°ï¼Œæ­¤æ—¶version=2</span><br><span class="line">cID = types.CommitID&#123;Version: ver, Hash: hash&#125;  //hash =&gt; root</span><br><span class="line">require.Nil(t, err)</span><br><span class="line">_, err = store.GetImmutable(cID.Version + 1)</span><br><span class="line">require.Error(t, err)   //æŸ¥è¯¢version=3çš„å­˜å‚¨æ ‘ï¼Œå½“ç„¶æ˜¯æ²¡æœ‰çš„å•¦ï¼Œerrä¿¡æ¯ä¸ºæ‰¾ä¸åˆ°</span><br><span class="line"></span><br><span class="line">newStore, err := store.GetImmutable(cID.Version - 1)  //æŸ¥è¯¢version=1çš„å­˜å‚¨æ ‘ï¼Œ</span><br><span class="line">require.NoError(t, err)                           //æ­¤æ—¶helloçš„valueä¸ºgoodbye</span><br><span class="line">require.Equal(t, newStore.Get([]byte(&quot;hello&quot;)), []byte(&quot;goodbye&quot;))</span><br><span class="line"></span><br><span class="line">newStore, err = store.GetImmutable(cID.Version)   //æŸ¥è¯¢version=2çš„å­˜å‚¨æ ‘</span><br><span class="line">require.NoError(t, err)//æ­¤æ—¶helloçš„valueå·²æ›´æ–°ä¸ºadios</span><br><span class="line">require.Equal(t, newStore.Get([]byte(&quot;hello&quot;)), []byte(&quot;adios&quot;))</span><br><span class="line"></span><br><span class="line">  //abci Queryæ¥å£å®ç°ï¼ŒæŸ¥è¯¢key=helloï¼Œversion=2çš„valueï¼Œå¹¶ä¸”è¿”å›è¯æ®</span><br><span class="line">res := newStore.Query(abci.RequestQuery&#123;Data: []byte(&quot;hello&quot;), Height: cID.Version, Path: &quot;/key&quot;, Prove: true&#125;)</span><br><span class="line">require.Equal(t, res.Value, []byte(&quot;adios&quot;))</span><br><span class="line">require.NotNil(t, res.Proof)</span><br><span class="line"></span><br><span class="line">require.Panics(t, func() &#123; newStore.Set(nil, nil) &#125;)</span><br><span class="line">require.Panics(t, func() &#123; newStore.Delete(nil) &#125;)</span><br><span class="line">require.Panics(t, func() &#123; newStore.Commit() &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="rootmulti"><a href="#rootmulti" class="headerlink" title="rootmulti"></a>rootmulti</h5><p>ç„¶åå†å›æ¥çœ‹<code>rootmulti/store</code></p><p>åŒæ ·ï¼Œè¿˜æ˜¯çœ‹æµ‹è¯•<code>store/rootmulti/store_test.go</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">func TestHashStableWithEmptyCommit(t *testing.T) &#123;</span><br><span class="line">var db dbm.DB = dbm.NewMemDB()</span><br><span class="line">ms := newMultiStoreWithMounts(db)</span><br><span class="line">err := ms.LoadLatestVersion()</span><br><span class="line">require.Nil(t, err)</span><br><span class="line"></span><br><span class="line">commitID := types.CommitID&#123;&#125;</span><br><span class="line">checkStore(t, ms, commitID, commitID)</span><br><span class="line"></span><br><span class="line">k, v := []byte(&quot;wind&quot;), []byte(&quot;blows&quot;)</span><br><span class="line">  //key=store1ä¸‹çš„ä¸€æ£µæ ‘store1</span><br><span class="line">store1 := ms.getStoreByName(&quot;store1&quot;).(types.KVStore)</span><br><span class="line">//store1è®¾ç½®k-v</span><br><span class="line">store1.Set(k, v)</span><br><span class="line"></span><br><span class="line"> //ms.Commit, ä¼šè°ƒç”¨store1.SaveVersionæ–¹æ³•</span><br><span class="line">cID := ms.Commit()</span><br><span class="line">require.Equal(t, int64(1), cID.Version)</span><br><span class="line">hash := cID.Hash</span><br><span class="line">// make an empty commit, it should update version, but not affect hash</span><br><span class="line">cID = ms.Commit()</span><br><span class="line">require.Equal(t, int64(2), cID.Version)</span><br><span class="line">require.Equal(t, hash, cID.Hash)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šæµ‹è¯•å¯åœ¨``store/rootmulti/store_test.go`ä¸­ã€‚</p><p>ç»“è®ºæ˜¯ï¼Œé¦–å…ˆä¼šæ·»åŠ å¤šä¸ªkeyå€¼ï¼Œæ¯ä¸ªkeyä¸€ä¸ªæ ‘ï¼Œç„¶åè¿™äº›æ ‘çš„roothashä½œä¸ºrootmultiæ ‘çš„å¶å­èŠ‚ç‚¹ï¼Œç»„æˆæ ‘ï¼Œè®¡ç®—å‡ºæ¥çš„root-hashä¼šä½œä¸ºapphashå­˜å‚¨åœ¨åŒºå—å¤´ä¸­ã€‚é‚£äº›å°æ ‘çš„å¶å­èŠ‚ç‚¹çš„å€¼å°±æ˜¯å­˜å‚¨çš„å…·ä½“çš„å†…å®¹å•¦ã€‚</p><p>è¯æ˜key-valueç¡®å®åœ¨åŒºå—å¤´çš„æ–¹å¼æ˜¯ï¼Œé¦–å…ˆè¯æ˜key-valueåœ¨æŸé¢—å°æ ‘ä¸Š(store-keyä¸‹)ï¼Œå…¶æ¬¡è®¡ç®—å‡ºå°æ ‘çš„roothashï¼Œå†ä½¿ç”¨roothashè®¡ç®—å‡ºapphashï¼Œä¸åŒºå—å¤´çš„apphashå¯¹æ¯”å³å¯è¯æ˜ã€‚</p><p>åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œé€‰æ‹©çš„åŒºå—é«˜åº¦ï¼Œè¯æ˜ä¸ºåˆ°è¿™ä¸ªåŒºå—ä¸ºæ­¢ï¼Œè¿™ä¸ªæ•°æ®æ˜¯å­˜åœ¨çš„ã€‚</p><p>æœ€åç»“è®ºè‰è‰ç»“å°¾ï¼Œæœ‰æ—¶é—´å†ç»†åŒ–ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cosmos-ibc-store</title>
      <link href="/2019/11/25/cosmos-ibc-store/"/>
      <url>/2019/11/25/cosmos-ibc-store/</url>
      
        <content type="html"><![CDATA[<h2 id="Cosmos-ibcå­˜å‚¨"><a href="#Cosmos-ibcå­˜å‚¨" class="headerlink" title="Cosmos-ibcå­˜å‚¨"></a>Cosmos-ibcå­˜å‚¨</h2><p>cosmos ibcæ˜¯å®ç°è·¨é“¾çš„åè®®ã€‚å…¶ä¸­ä¼šæ¶‰åŠåˆ°ä¸€äº›æ•°æ®å­˜å‚¨ï¼Œè¿™é‡Œå¯¹ç›¸å…³å­˜å‚¨è¿›è¡Œå½’çº³ã€‚</p><p>å­˜å‚¨ä½¿ç”¨key-valueå½¢å¼ã€‚</p><p>cosmos-sdkç‰ˆæœ¬ä¸ºfedekunze/ibc - 94ffaeb9f746d13b68678423d4aee0828f652fd4</p><ul><li>Clientã€‚</li></ul><table><thead><tr><th>Key</th><th>Value</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>client/<code>clientID</code>/roots/<code>height</code></td><td>Hash-root</td><td>ç”¨äºmerkleæ ‘éªŒè¯çš„æ•°æ®ç»“æ„</td></tr><tr><td>client/<code>clientID</code>/consensusState</td><td>consensusState</td><td>å¦ä¸€æ¡é“¾çš„å…±è¯†çŠ¶æ€ï¼ŒåŒ…å«rootã€éªŒè¯èŠ‚ç‚¹ã€åŒºå—é«˜åº¦ç­‰ä¿¡æ¯</td></tr><tr><td>clients/<code>clientID</code>/state</td><td>bool</td><td>clientIDæ˜¯å¦ç”±äºæ¶æ„è€Œè¢«å†»ç»“(ä¸å¯ç”¨)</td></tr><tr><td>clients/<code>clientID</code>/type</td><td>[]byte</td><td>å¦ä¸€æ¡é“¾çš„å…±è¯†ç®—æ³•(tendermint)</td></tr></tbody></table><p>clientç”¨äºéªŒè¯/å­˜å‚¨/æ›´æ–°å¦ä¸€æ¡é“¾çš„ä¿¡æ¯çŠ¶æ€</p><ul><li>Connection</li></ul><table><thead><tr><th>Key</th><th>Value</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>connections/<code>connectionID</code></td><td>Connection(state/clientID/counterParty)</td><td>è¿æ¥ä¿¡æ¯</td></tr><tr><td>clients/<code>clientID</code>/connections</td><td>[]connectionIDs</td><td>clientIDä¸‹çš„è¿æ¥ä»¬</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><ul><li>Channel</li></ul><p>Path = ports/<code>portID</code>/channel/<code>channelID</code></p><table><thead><tr><th>Key</th><th align="left">Value</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>Path</td><td align="left">Channel(state/ordering/counterParty/connHops)</td><td>é€šé“ä¿¡æ¯</td></tr><tr><td>Path/nextSequenceSend</td><td align="left">Sequenceï¼ˆuint64ï¼‰</td><td></td></tr><tr><td>Path/nextSequenceRecv</td><td align="left">Sequenceï¼ˆuint64ï¼‰</td><td></td></tr></tbody></table><ul><li>Packet</li></ul>]]></content>
      
      
      <categories>
          
          <category> cosmos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>fabric_performance</title>
      <link href="/2019/10/14/fabric-performance/"/>
      <url>/2019/10/14/fabric-performance/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€å•æ€§èƒ½æµ‹è¯•"><a href="#ç®€å•æ€§èƒ½æµ‹è¯•" class="headerlink" title="ç®€å•æ€§èƒ½æµ‹è¯•"></a>ç®€å•æ€§èƒ½æµ‹è¯•</h2><h5 id="æœåŠ¡"><a href="#æœåŠ¡" class="headerlink" title="æœåŠ¡"></a>æœåŠ¡</h5><ul><li>orderæœåŠ¡: è´Ÿè´£æ¥æ”¶èƒŒä¹¦åçš„äº¤æ˜“æ”¾å…¥kafkaä¸­ï¼Œå¹¶ä»kafkaä¸­è¯»å‡ºäº¤æ˜“å‡ºå—</li><li>peeræœåŠ¡ï¼š è´Ÿè´£èƒŒä¹¦äº¤æ˜“</li><li>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ï¼š å‘peerå‘é€äº¤æ˜“èƒŒä¹¦åå‘é€åˆ°order</li><li>1ä¸ªé€šé“ï¼Œ2ä¸ªç»„ç»‡</li></ul><h5 id="æœºå™¨"><a href="#æœºå™¨" class="headerlink" title="æœºå™¨"></a>æœºå™¨</h5><ul><li>1å·æœºï¼Œ4æ ¸8g</li><li>2å·æœºï¼Œ4æ ¸8g</li><li>3å·æœºï¼Œ4æ ¸8g</li><li>äº‘æœåŠ¡kafka</li></ul><p>åŒºå—é…ç½®:  æ¯åŒºå—512KBï¼Œæ¯æ¡äº¤æ˜“2.9KBï¼Œæ¯ä¸ªåŒºå—å¹³å‡åŒ…å«173ä¸ªäº¤æ˜“</p><h5 id="æœºå™¨ä½¿ç”¨"><a href="#æœºå™¨ä½¿ç”¨" class="headerlink" title="æœºå™¨ä½¿ç”¨"></a>æœºå™¨ä½¿ç”¨</h5><table><thead><tr><th>1å·æœº</th><th>2å·æœº</th><th>3å·æœº</th></tr></thead><tbody><tr><td>orderæœåŠ¡ * 3</td><td>peeræœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 1</td></tr></tbody></table><p>æ€§èƒ½æƒ…å†µ</p><table><thead><tr><th>å®æ—¶å‡ºå—é€Ÿåº¦</th><th>åªè¯»å‡ºå—é€Ÿåº¦</th></tr></thead><tbody><tr><td>1400</td><td>-</td></tr></tbody></table><p><strong>åªè¯»å‡ºå—é€Ÿåº¦</strong>ï¼š http å®¢æˆ·ç«¯å‘é€äº¤æ˜“ï¼Œé¦–å…ˆå‘é€åˆ°peerèƒŒä¹¦ï¼Œéšåå‘é€åˆ°orderèŠ‚ç‚¹ï¼ŒorderèŠ‚ç‚¹æ”¶åˆ°äº¤æ˜“åæ”¾å…¥åˆ°kafkaå­˜å‚¨(æ¶ˆæ¯ç”Ÿäº§è¿‡ç¨‹)ï¼Œéšåorderå‡ºå—(æ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹)ã€‚å½“æ¶ˆæ¯ç”Ÿäº§é€Ÿåº¦é«˜äºæ¶ˆè´¹é€Ÿåº¦ï¼Œå°±ä¼šé€ æˆæ¶ˆæ¯å †ç§¯ï¼Œ<strong>å½“æ¶ˆæ¯ç”Ÿäº§é€Ÿåº¦ä¸º0ï¼Œåªæ¶ˆè´¹å †ç§¯çš„æ¶ˆæ¯çš„é€Ÿåº¦ï¼Œç§°ä¸ºåªè¯»å‡ºå—é€Ÿåº¦</strong>ã€‚</p><h4 id="ç¬¬ä¸€æ¬¡æ›´æ–°"><a href="#ç¬¬ä¸€æ¬¡æ›´æ–°" class="headerlink" title="ç¬¬ä¸€æ¬¡æ›´æ–°"></a>ç¬¬ä¸€æ¬¡æ›´æ–°</h4><p>å¢åŠ åŒºå—å¤§å°</p><p>æ¯åŒºå—1500KBï¼Œæ¯æ¡äº¤æ˜“2ï¼Œ9KBï¼Œæ¯ä¸ªåŒºå—å¹³å‡åŒ…å«500ä¸ªäº¤æ˜“</p><p>æ€§èƒ½æƒ…å†µ</p><table><thead><tr><th>å®æ—¶å‡ºå—é€Ÿåº¦</th><th>èƒŒä¹¦é€Ÿåº¦</th><th>åªè¯»å‡ºå—é€Ÿåº¦</th></tr></thead><tbody><tr><td>1500</td><td>1500</td><td>-</td></tr></tbody></table><h4 id="ç¬¬äºŒæ¬¡æ›´æ–°"><a href="#ç¬¬äºŒæ¬¡æ›´æ–°" class="headerlink" title="ç¬¬äºŒæ¬¡æ›´æ–°"></a>ç¬¬äºŒæ¬¡æ›´æ–°</h4><p>å¢åŠ peeræ•°é‡</p><h5 id="æœºå™¨ä½¿ç”¨-1"><a href="#æœºå™¨ä½¿ç”¨-1" class="headerlink" title="æœºå™¨ä½¿ç”¨"></a>æœºå™¨ä½¿ç”¨</h5><table><thead><tr><th>1å·æœº</th><th>2å·æœº</th><th>3å·æœº</th></tr></thead><tbody><tr><td>orderæœåŠ¡ * 3</td><td>peeræœåŠ¡ * 1ï¼›peeræœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 2</td></tr></tbody></table><p>æ€§èƒ½æƒ…å†µ</p><table><thead><tr><th>å®æ—¶å‡ºå—é€Ÿåº¦</th><th>èƒŒä¹¦é€Ÿåº¦</th><th>åªè¯»å‡ºå—é€Ÿåº¦</th></tr></thead><tbody><tr><td>1000</td><td>8000*2</td><td>1800</td></tr></tbody></table><p><strong>è§‚å¯Ÿ</strong></p><p>å¢åŠ peerï¼Œpeerçš„èƒŒä¹¦é€Ÿåº¦ç¨æœ‰æå‡ï¼Œä½†å‡ºå—é€Ÿåº¦ç«Ÿç„¶é™ä½äº†..</p><p>å‡ºå—çš„é€Ÿåº¦å°äºäº¤æ˜“äº§ç”Ÿé€Ÿåº¦ï¼Œå½“http å®¢æˆ·ç«¯åœæ‰ä¹‹åï¼Œå‡ºå—çš„é€Ÿåº¦å¾—åˆ°æå‡å¹¶ä¸”ç¨å¤§äºå•ä¸ªpeerçš„æƒ…å†µã€‚</p><h4 id="ç¬¬ä¸‰æ¬¡æ›´æ–°"><a href="#ç¬¬ä¸‰æ¬¡æ›´æ–°" class="headerlink" title="ç¬¬ä¸‰æ¬¡æ›´æ–°"></a>ç¬¬ä¸‰æ¬¡æ›´æ–°</h4><p>è¿½åŠ æœåŠ¡å™¨ï¼Œè´Ÿè½½å‡è¡¡</p><ul><li>4å·æœºï¼Œ4æ ¸8g</li><li>5å·æœºï¼Œ4æ ¸8g</li></ul><h5 id="æœºå™¨ä½¿ç”¨-2"><a href="#æœºå™¨ä½¿ç”¨-2" class="headerlink" title="æœºå™¨ä½¿ç”¨"></a>æœºå™¨ä½¿ç”¨</h5><table><thead><tr><th>1å·æœº</th><th>2å·æœº</th><th>3å·æœº</th><th>4å·æœº</th><th>5å·æœº</th></tr></thead><tbody><tr><td>orderæœåŠ¡ * 3</td><td>peeræœåŠ¡ * 1</td><td>peeræœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 1</td></tr></tbody></table><p>æ€§èƒ½æƒ…å†µ</p><table><thead><tr><th>å®æ—¶å‡ºå—é€Ÿåº¦</th><th>èƒŒä¹¦é€Ÿåº¦</th><th>åªè¯»å‡ºå—é€Ÿåº¦</th></tr></thead><tbody><tr><td>1300</td><td>1400 * 2</td><td>2200</td></tr></tbody></table><p><strong>è§‚å¯Ÿ</strong></p><p>è´Ÿè½½å‡è¡¡åï¼ŒèƒŒä¹¦çš„é€Ÿåº¦å¾—åˆ°æ˜¾è‘—æå‡ï¼å®æ—¶å‡ºå—å’Œåªè¯»å‡ºå—çš„é€Ÿåº¦ä¹Ÿç¨æœ‰æå‡ã€‚</p><p>ä½†å®æ—¶å‡ºå—çš„é€Ÿåº¦è¿˜æ˜¯æ²¡æœ‰åªæœ‰1ä¸ªpeerçš„é€Ÿåº¦â€¦</p><h4 id="ç¬¬å››ã€äº”æ¬¡æ›´æ–°"><a href="#ç¬¬å››ã€äº”æ¬¡æ›´æ–°" class="headerlink" title="ç¬¬å››ã€äº”æ¬¡æ›´æ–°"></a>ç¬¬å››ã€äº”æ¬¡æ›´æ–°</h4><p>æå‡æœåŠ¡å™¨æ€§èƒ½ï¼Œé¦–å…ˆå°†orderæœåŠ¡æ‰€åœ¨çš„1å·æœºå‡çº§ä¸º8æ ¸16gï¼Œå®æ—¶å‡ºå—çš„é€Ÿåº¦å¢åŠ åˆ°1700ï¼Œä½†2ä¸ªpeerçš„é€Ÿåº¦è¿˜æ˜¯æ²¡æœ‰1ä¸ªpeerçš„é€Ÿåº¦å¿«..</p><p>å…¶æ¬¡ï¼Œæå‡äº†kafkaæœåŠ¡å™¨çš„æ€§èƒ½.. ç»“æœæ²¡å•¥å˜åŒ–</p><h4 id="ç¬¬å…­æ¬¡æ›´æ–°"><a href="#ç¬¬å…­æ¬¡æ›´æ–°" class="headerlink" title="ç¬¬å…­æ¬¡æ›´æ–°"></a>ç¬¬å…­æ¬¡æ›´æ–°</h4><p>å†æ¬¡æå‡æœåŠ¡å™¨æ€§èƒ½ï¼Œè¿™æ¬¡æå‡çš„æ˜¯peerèŠ‚ç‚¹çš„æ€§èƒ½ï¼Œå°†peerèŠ‚ç‚¹çš„2å·æœºå’Œ3å·æœºå‡çº§ä¸º8æ ¸16g</p><h5 id="æœºå™¨ä½¿ç”¨-3"><a href="#æœºå™¨ä½¿ç”¨-3" class="headerlink" title="æœºå™¨ä½¿ç”¨"></a>æœºå™¨ä½¿ç”¨</h5><table><thead><tr><th>1å·æœº8æ ¸16g</th><th>2å·æœº8æ ¸16g</th><th>4å·æœº</th></tr></thead><tbody><tr><td>orderæœåŠ¡ * 3</td><td>peeræœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 1</td></tr></tbody></table><p>æ€§èƒ½æƒ…å†µ</p><table><thead><tr><th>å®æ—¶å‡ºå—é€Ÿåº¦</th><th>èƒŒä¹¦é€Ÿåº¦</th><th>åªè¯»å‡ºå—é€Ÿåº¦</th></tr></thead><tbody><tr><td>1800</td><td>1800</td><td>-</td></tr></tbody></table><h5 id="æœºå™¨ä½¿ç”¨-4"><a href="#æœºå™¨ä½¿ç”¨-4" class="headerlink" title="æœºå™¨ä½¿ç”¨"></a>æœºå™¨ä½¿ç”¨</h5><table><thead><tr><th>1å·æœº8æ ¸16g</th><th>2å·æœº8æ ¸16g</th><th>3å·æœº8æ ¸16g</th><th>4å·æœº</th><th>5å·æœº</th></tr></thead><tbody><tr><td>orderæœåŠ¡ * 3</td><td>peeræœåŠ¡ * 1</td><td>peeræœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 1</td><td>http å®¢æˆ·ç«¯æµ‹è¯•æœåŠ¡ * 1</td></tr></tbody></table><p>æ€§èƒ½æƒ…å†µ</p><table><thead><tr><th>å®æ—¶å‡ºå—é€Ÿåº¦</th><th>èƒŒä¹¦é€Ÿåº¦</th><th>åªè¯»å‡ºå—é€Ÿåº¦</th></tr></thead><tbody><tr><td>2600</td><td>1700 * 2</td><td>3500</td></tr></tbody></table><p><strong>è§‚å¯Ÿ</strong></p><p>1ä¸ªpeeræ—¶é€Ÿåº¦ä¸ºå‡ºå—é€Ÿåº¦ä¸º1800</p><p>å¢åŠ 1ä¸ªpeerï¼ŒèƒŒä¹¦é€Ÿåº¦æå‡æ¥è¿‘2å€ï¼Œå‡ºå—é€Ÿåº¦å¢åŠ è‡³2600ï¼Œå½“åœæ‰httpå®¢æˆ·ç«¯åï¼Œåªè¯»å‡ºå—é€Ÿåº¦å¢åŠ è‡³3500</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>(åœ¨ä¸€å®šæ¡ä»¶ä¸‹)å¢åŠ peerçš„æ•°é‡ï¼Œèƒ½å¢åŠ tpsã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ8æ ¸16gçš„peerä¸‹ï¼Œå¢åŠ ä¸€ä¸ªpeerçš„tpsç”±1800å¢åŠ è‡³2600ã€‚</p><p>æ‰€è°“ä¸€å®šæ¡ä»¶ï¼Œä¾‹å¦‚peeræœåŠ¡å¯¹äºæœåŠ¡å™¨æ€§èƒ½(å†…å­˜ç­‰)è¦æ±‚æŒºé«˜çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> fabric </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>fabric</title>
      <link href="/2019/10/14/fabric/"/>
      <url>/2019/10/14/fabric/</url>
      
        <content type="html"><![CDATA[<h2 id="FabricåŸºæœ¬è®¤è¯†"><a href="#FabricåŸºæœ¬è®¤è¯†" class="headerlink" title="FabricåŸºæœ¬è®¤è¯†"></a>FabricåŸºæœ¬è®¤è¯†</h2><h3 id="åŸºæœ¬æ¶æ„"><a href="#åŸºæœ¬æ¶æ„" class="headerlink" title="åŸºæœ¬æ¶æ„"></a>åŸºæœ¬æ¶æ„</h3><p><a href="http://hyperledger-fabric.readthedocs.io/en/master/arch-deep-dive.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p><img src="./fabric_macro.jpg" alt="å®è§‚å›¾"></p><p>ä¸Šå›¾ä¸ºfabricçš„åŸºæœ¬ç»“æ„å›¾ï¼Œä»¥ä¸‹è§£é‡Šå„åè¯å«ä¹‰ã€‚</p><ul><li>application: æä¾›å„ç§è¯­è¨€çš„SDKæ¥å£</li><li>membershipï¼š ä¹Ÿå°±æ˜¯fabric-caï¼Œæä¾›æˆå‘˜æœåŠ¡ï¼Œç”¨æ¥ç®¡ç†èº«ä»½ï¼Œæä¾›æˆæƒå’Œè®¤è¯</li><li>peer: è´Ÿè´£æ¨¡æ‹Ÿäº¤æ˜“å’Œè®°è´¦<ul><li>Endorser(èƒŒä¹¦)ï¼Œpeeræ‰§è¡Œäº¤æ˜“å¹¶è¿”å›yes/no</li><li>Committerï¼Œå°†éªŒè¯è¿‡çš„åŒºå—è¿½åŠ åˆ°é€šé“ä¸Šå„ä¸ªè´¦æœ¬çš„å‰¯æœ¬</li><li>Ledgerï¼Œè´¦æœ¬</li><li>chaincodeï¼Œç”¨æ¥ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œäº¤æ˜“æŒ‡ä»¤ç”¨æ¥ä¿®æ”¹èµ„äº§ï¼Œå¯ä»¥ç†è§£ä¸ºfabricç½‘ç»œå¯¹å¤–æä¾›çš„ä¸€ä¸ªäº¤æ˜“æ¥å£ï¼ˆæ™ºèƒ½åˆçº¦ï¼‰</li><li>Eventæ˜¯fabricæä¾›çš„ä¸€ä¸ªäº‹ä»¶æ¡†æ¶ï¼Œæ¯”å¦‚é“¾ä»£ç äº‹ä»¶ï¼Œæ‹’ç»äº‹ä»¶ï¼Œæ³¨å†Œäº‹ä»¶ç­‰ï¼Œåœ¨ç¼–å†™ä»£ç çš„æ—¶å€™å¯ä»¥è®¢é˜…è¿™äº›äº‹ä»¶æ¥å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚</li></ul></li><li>o-serviceç”¨æ¥å®ç°å…±è¯†</li></ul><p>åŒºå—é“¾è¿è¡Œç§°ä¹‹ä¸ºé“¾ç ï¼ˆchaincodeï¼‰çš„ç¨‹åºï¼Œä¿å­˜çŠ¶æ€ã€è´¦æœ¬æ•°æ®ï¼Œå¹¶æ‰§è¡Œäº¤æ˜“ã€‚é“¾ç æ˜¯ä¸­å¤®å…ƒç´ ï¼Œå› ä¸ºäº¤æ˜“æ˜¯åœ¨é“¾ç ä¸Šè°ƒç”¨çš„æ“ä½œã€‚äº¤æ˜“å¿…é¡»è¢«â€œendorsedâ€ï¼Œè€Œä¸”åªæœ‰è¢«â€œendorsedâ€åçš„äº¤æ˜“æ‰èƒ½è¢«æäº¤ã€‚ç®¡ç†æ–¹æ³•å’Œå‚æ•°å¯èƒ½å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹æ®Šé“¾ç ï¼Œç»Ÿç§°ä¸ºç³»ç»Ÿé“¾ç ã€‚</p><p><strong>äº¤æ˜“</strong>å¯èƒ½æœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li>éƒ¨ç½²äº‹åŠ¡ï¼Œåˆ›å»ºæ–°çš„é“¾æ¥ä»£ç å¹¶å°†ç¨‹åºä½œä¸ºå‚æ•°ã€‚å½“éƒ¨ç½²äº‹åŠ¡æˆåŠŸæ‰§è¡Œæ—¶ï¼Œé“¾ä»£ç å·²ç»å®‰è£…åœ¨åŒºå—é“¾ä¸Šã€‚</li><li>è°ƒç”¨äº‹åŠ¡ï¼Œåœ¨å…ˆå‰éƒ¨ç½²çš„é“¾å¼ä»£ç çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œã€‚ä¸€ä¸ªinvokeäº‹åŠ¡å¼•ç”¨äº†ä¸€ä¸ªchaincodeå’Œå®ƒæä¾›çš„å‡½æ•°ä¹‹ä¸€ã€‚æˆåŠŸæ—¶ï¼Œchaincodeæ‰§è¡ŒæŒ‡å®šçš„åŠŸèƒ½ - å¯èƒ½æ¶‰åŠä¿®æ”¹ç›¸åº”çš„çŠ¶æ€å¹¶è¿”å›è¾“å‡ºã€‚</li></ul><p>å¦‚åé¢æ‰€è¿°ï¼Œéƒ¨ç½²äº‹åŠ¡æ˜¯è°ƒç”¨äº‹åŠ¡çš„ç‰¹ä¾‹ï¼Œå…¶ä¸­åˆ›å»ºæ–°é“¾ä»£ç çš„éƒ¨ç½²äº‹åŠ¡å¯¹åº”äºç³»ç»Ÿé“¾ä»£ç ä¸Šçš„è°ƒç”¨äº‹åŠ¡ã€‚</p><p><strong>State</strong>ï¼ŒåŒºå—é“¾çš„æœ€æ–°stateè¢«å»ºæ¨¡ä¸ºç‰ˆæœ¬åŒ–çš„é”®å€¼å­˜å‚¨ï¼ˆKVSï¼‰ï¼Œä¿®æ”¹ç”±è¿è¡Œåœ¨åŒºå—é“¾ä¸Šçš„é“¾ç ï¼ˆapplicationsï¼‰è°ƒç”¨KVSçš„put,getæ“ä½œã€‚è¯¦ç»†çš„æ“ä½œä¸ç‰ˆæœ¬åŒ–æš‚æ—¶ç•¥ï¼Œçœ‹æ–‡æ¡£æœ‰ç‚¹æ²¡çœ‹æ‡‚..Stateç”±peersè¿›è¡Œç»´æŠ¤ï¼Œè€Œä¸æ˜¯orderså’Œclientsã€‚KVSä¸­çš„Keyså¯ä»¥ä»å®ƒä»¬çš„åç§°ä¸­è¯†åˆ«å‡ºå±äºç‰¹å®šçš„é“¾ç ï¼Œå› æ­¤åªæœ‰ç‰¹å®šé“¾ç çš„äº¤æ˜“å¯ä»¥ä¿®æ”¹è¿™ä¸ªé“¾ç ä¸Šçš„keysï¼Œä½†åŸåˆ™ä¸Šï¼Œä»»ä½•é“¾ç éƒ½å¯è¯»åˆ«çš„é“¾ç çš„keysï¼Œå³è¯»å–æ–¹ä¾¿ï¼Œä½†ä¿®æ”¹éœ€ç‰¹æƒã€‚</p><p><strong>Ledger, è´¦æœ¬</strong>ï¼Œè´¦æœ¬æä¾›äº†å‘ç”Ÿåœ¨ç³»ç»Ÿè¿è¡Œæ—¶çš„æ‰€æœ‰æˆåŠŸå’Œä¸æˆåŠŸäº¤æ˜“çš„å†å²ã€‚è´¦æœ¬ï¼Œä½œä¸ºæ€»çš„åŒºå—æ€»çš„å“ˆå¸Œé“¾ï¼ˆæˆåŠŸæˆ–ä¸æˆåŠŸï¼‰ï¼Œç”±è®¢é˜…æœåŠ¡æ„é€ ã€‚å“ˆå¸Œé“¾å¼ºåˆ¶è¦æ±‚åœ¨è´¦æœ¬ä¸­æ‰€æœ‰çš„æœ‰åºåŒºå—ä»¥åŠæ¯ä¸ªå—åŒ…å«1ä¸ªå®Œå…¨æœ‰åºçš„äº¤æ˜“ï¼Œè¿™åœ¨æ‰€æœ‰äº¤æ˜“ä¸­å¼ºåˆ¶è¦æ±‚æ‰€æœ‰çš„è®¢é˜…ã€‚è´¦æœ¬ä¿å­˜åœ¨æ‰€æœ‰çš„peerä¸­ï¼Œå¹¶å¯é€‰æ‹©æ€§çš„å­˜æ”¾åœ¨ordersä¸­ã€‚åœ¨ordersä¸­ï¼Œæˆ‘ä»¬æŒ‡çš„è´¦æœ¬æ˜¯OrdererLedger(æ€»è´¦)ï¼›åœ¨peersä¸­ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯PeerLedgerï¼ˆåˆ†è´¦ï¼‰ï¼Œåˆ†è´¦å’Œæ€»è´¦çš„åŒºåˆ«åœ¨äºpeersæœ¬åœ°ä¼šç»´æŠ¤ä¸€ä¸ªä½æ©ç ï¼Œè¿™ä¸ªä½æ©ç ä¼šå°†æœ‰æ•ˆçš„äº‹åŠ¡ä»æ— æ•ˆçš„å½“ä¸­åˆ†ç¦»å‡ºæ¥ã€‚peerså¯èƒ½ä¼šå¯¹åˆ†è´¦è¿›è¡Œä¿®å‰ªï¼Œordersè´Ÿè´£ç»´æŠ¤æ€»è´¦çš„å®¹é”™æ€§å’Œå¯ç”¨æ€§å¹¶ä¸”å¯ä»¥éšæ—¶ä¿®å‰ªï¼Œå‰ææ˜¯orderingæœåŠ¡çš„å±æ€§å¾—åˆ°ç»´æŠ¤ã€‚è´¦æœ¬å…è®¸peersé‡æ’­æ‰€æœ‰äº¤æ˜“çš„å†å²ä»¥åŠé‡å»ºstate,æ‰€ä»¥stateæ˜¯ä¸€ä¸ªå¯é€‰çš„æ•°æ®ç»“æ„ã€‚</p><p><strong>èŠ‚ç‚¹</strong>ï¼ŒèŠ‚ç‚¹æ˜¯åŒºå—é“¾ä¸­çš„é€šä¿¡å®ä½“ï¼ŒèŠ‚ç‚¹åªæ˜¯ä¸€ä¸ªé€»è¾‘åŠŸèƒ½ï¼Œå› ä¸ºä¸åŒç±»å‹çš„å¤šä¸ªèŠ‚ç‚¹å¯ä»¥åœ¨åŒä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œé‡è¦çš„æ˜¯èŠ‚ç‚¹åœ¨â€œä¿¡ä»»åŸŸâ€ä¸­å¦‚ä½•åˆ†ç»„å¹¶ä¸æ§åˆ¶å®ƒä»¬çš„é€»è¾‘å®ä½“ç›¸å…³è”ã€‚èŠ‚ç‚¹åˆ†ä¸º3ç§ç±»å‹ï¼š</p><ul><li>Client æˆ– submitting-client: æäº¤çœŸæ­£äº¤æ˜“ç»™endorsersçš„å®¢æˆ·ï¼Œå¹¶ä¸”å¹¿æ’­äº¤æ˜“ç”³è¯·ç»™orderingæœåŠ¡</li><li>Peerï¼šæäº¤äº¤æ˜“å¹¶ç»´æŠ¤stateå’Œè´¦æœ¬çš„å¤‡ä»½ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œpeersè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„endorserè§’è‰²</li><li>Ordering-service-nodeæˆ–è€…orderï¼šé€šä¿¡æœåŠ¡ -&gt; å®ç°ä¼ é€’ä¿è¯ï¼Œä¾‹å¦‚åŸå­æ€§æˆ–è€…æ‰€æœ‰çš„orderå¹¿æ’­</li></ul><p>è®¢é˜…æœåŠ¡æä¾›äº†ä¸€ä¸ªå…±äº«çš„é€šä¿¡é€šé“ç»™clientså’Œpeers, æä¾›çš„æ˜¯ä¸€ä¸ªåŒ…å«äº¤æ˜“ä¿¡æ¯çš„å¹¿æ’­æœåŠ¡ã€‚clientè¿æ¥åˆ°é€šé“ï¼Œåœ¨é€šé“ä¸­å¹¿æ’­æ¶ˆæ¯ï¼Œæ¶ˆæ¯å°†ä¼šé€è¾¾ç»™æ‰€æœ‰çš„peersã€‚é€šé“æ”¯æŒæ‰€æœ‰æ¶ˆæ¯çš„åŸå­æ€§ä¼ é€’ï¼Œå³ï¼Œæ¶ˆæ¯é€šä¿¡æ˜¯æŒ‰åºä¼ é€’å’Œå¯é çš„ã€‚æ¢å¥è¯è¯´ï¼Œé€šé“ç»™æ‰€æœ‰è¿æ¥çš„peersè¾“å‡ºçš„æ˜¯ç›¸åŒæ¶ˆæ¯ï¼Œä¸”æ˜¯ç›¸åŒçš„é€»è¾‘é¡ºåºã€‚è¿™ç§åŸå­æ€§çš„é€šä¿¡ä¿è¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¹Ÿè¢«ç§°ä¸ºå…¨åºå¹¿æ’­ï¼ŒåŸå­å¹¿æ’­ï¼Œæˆ–è€…æ˜¯å…±è¯†ã€‚ä¼ é€’çš„æ¶ˆæ¯æ˜¯åŒ…å«åœ¨åŒºå—é“¾çŠ¶æ€ä¸­çš„å€™é€‰äº¤æ˜“ã€‚</p><h4 id="äº¤æ˜“æµç¨‹"><a href="#äº¤æ˜“æµç¨‹" class="headerlink" title="äº¤æ˜“æµç¨‹"></a>äº¤æ˜“æµç¨‹</h4><p>äº¤æ˜“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>Applicationå‘ä¸€ä¸ªæˆ–å¤šä¸ªpeerèŠ‚ç‚¹å‘é€å¯¹äº¤æ˜“çš„èƒŒä¹¦è¯·æ±‚ã€‚</li><li>Peerçš„endorseæ‰§è¡ŒèƒŒä¹¦ï¼Œä½†å¹¶ä¸å°†ç»“æœæäº¤åˆ°æœ¬åœ°è´¦æœ¬ï¼Œåªæ˜¯å°†ç»“æœè¿”å›ç»™åº”ç”¨ã€‚</li><li>åº”ç”¨æ”¶é›†æ‰€æœ‰èƒŒä¹¦èŠ‚ç‚¹çš„ç»“æœåï¼Œå°†ç»“æœå¹¿æ’­ç»™orderersï¼Œorderersæ‰§è¡Œå…±è¯†ï¼Œç”Ÿæˆblockï¼Œé€šè¿‡æ¶ˆæ¯é€šé“æ‰¹é‡çš„å°†blockå‘å¸ƒç»™peerèŠ‚ç‚¹ï¼Œæ›´æ–°lerdgerã€‚</li></ol><p>äº¤æ˜“è¿‡ç¨‹å¯å¦‚ä¸‹å›¾</p><p><img src="./fabric_peer.jpg" alt="äº¤æ˜“è¿‡ç¨‹"></p><h4 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h4><p>channelæ˜¯æ„å»ºåœ¨Fabricç½‘ç»œä¸Šçš„ç§æœ‰åŒºå—é“¾ï¼Œå®ç°äº†æ•°æ®çš„éš”ç¦»å’Œä¿å¯†ã€‚channelæ˜¯ç”±ç‰¹å®šçš„peeræ‰€å…±äº«çš„ï¼Œå¹¶ä¸”äº¤æ˜“æ–¹å¿…é¡»é€šè¿‡è¯¥é€šé“çš„æ­£ç¡®éªŒè¯æ‰èƒ½ä¸è´¦æœ¬è¿›è¡Œäº¤äº’ã€‚</p><p>å¯ä»¥çœ‹åˆ°ä¸åŒé¢œè‰²çš„channeléš”ç¦»äº†ä¸åŒçš„peerä¹‹é—´çš„é€šä¿¡ã€‚</p><p>Fabricæä¾›äº†ä¸€ä¸ªfirst-networkçš„<u>demo</u>æ¥å­¦ä¹ æ•´ä¸ªæµç¨‹ã€‚è¦å­¦å“¦! å…¥æ‰‹åšä¸€ä¸ª<del>ç­‰ç†è®ºæå®šï¼Œæ˜å¤©èƒ½ä¸èƒ½æå®šç†è®º fabricçš„</del></p><p>ä»Šå¤©ç†è®ºåˆ°ä¸€åŠäº†å§.. ç„¶è€Œåˆè¯»ä¸ä¸‹å»äº†ï¼ŒçœŸçš„è¶…æ¯ç‡¥â€¦æˆ‘å…ˆæä¸€ä¸‹åˆ«çš„ã€‚</p><p>first-networkæœ‰ä¸¤ä¸ªç»„ç»‡ï¼Œæ¯ä¸ªç»„ç»‡å„æœ‰ä¸¤ä¸ªä¸ªpeerèŠ‚ç‚¹ï¼Œä»¥åŠä¸€ä¸ªæ’åºæœåŠ¡ã€‚ä¸¤ä¸ªpeerèŠ‚ç‚¹æ— æ³•è¾¾æˆå…±è¯†ï¼Œä¸‰ä¸ªpeerèŠ‚ç‚¹æ— æ³•å®¹é”™ï¼Œå››ä¸ªpeerèŠ‚ç‚¹åˆšå¥½å®Œæˆæ¼”ç¤ºã€‚</p><h3 id="fabric-ç†è§£"><a href="#fabric-ç†è§£" class="headerlink" title="fabric ç†è§£"></a>fabric ç†è§£</h3><h4 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Policy for [Groups] /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required [Admins]...</span><br></pre></td></tr></table></figure><p>åˆ›å»ºé€šé“æ—¶ï¼ŒæŠ¥é”™ã€‚</p><p>åˆ›å»ºé€šé“ï¼Œæ ¹æ®é€šé“å®šä¹‰çš„ç­–ç•¥ï¼Œä¼ å…¥ç›¸å…³æˆå‘˜ç­¾å/è¯ä¹¦ã€‚å¦‚æœç­–ç•¥æ˜¯or1.adminå’Œorg2.adminï¼Œå°±éœ€è¦ä¸¤ä¸ªä¸€èµ·æˆæƒ(æ•°ç»„..)</p><p>é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ä¼ å…¥äº†ç›¸å…³ç”¨æˆ·ï¼Œç„¶åæ£€æŸ¥SigningIdentityæ˜¯å¦æ­£ç¡®ï¼Œå¯æ‰“å°å‡ºæ¥å¯¹æ¯”<code>fmt.Println(string(identity.EnrollmentCertificate()))</code></p><p>ä½¿ç”¨go-sdkçš„è¯ä¼šåœ¨tmpç›®å½•ä¸‹æœ‰ç›¸å…³çš„æ•°æ®ç›®å½•ï¼Œæˆ‘çš„æƒ…å†µæ˜¯å…ˆä½¿ç”¨caæ³¨å†Œäº†ä¸€ä¸ªadmin..å°±ä¼šç”Ÿæˆä¸€ä¸ªç”±caç­¾åçš„adminè¯ä¹¦ï¼Œä½†è¿™ä¸ªadminå¹¶ä¸æ˜¯org1.adminï¼Œæ‰€ä»¥æˆ‘(âŠ™xâŠ™;)â€¦åˆ é™¤äº†ç›®å½•..  å°±è¿˜æ˜¯ä¸è¦æ³¨å†Œadminè¿™ç§æ•æ„Ÿåå­—çš„ç”¨æˆ·äº†å§â€¦</p><p><code>peer chaincode instantiate -p git.wokoworks.com/blockchain/fabric-thread/multipeer/chaincode/go/test  -n mytest -v 0</code></p><p>ä¹‹åï¼Œåœ¨peerçš„<code>/var/hyperledger/production/chaincodes</code>ç›®å½•ä¸‹ä¼šæœ‰<code>mycc.0</code>çš„äºŒè¿›åˆ¶ï¼Ÿä¸æ™“å¾—</p><p>?å¥½å¥‡æ€ª  è¿™ä¸ªæ˜¯è¦peerå®‰è£…çš„æ„æ€ï¼Ÿ</p><p>å®‰è£…å’Œéƒ¨ç½²çš„åŒºåˆ«</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  cli:</span><br><span class="line">    container_name: cli</span><br><span class="line">    image: hyperledger/fabric-tools</span><br><span class="line">    tty: true</span><br><span class="line">    environment:</span><br><span class="line">      - GOPATH=/opt/gopath</span><br><span class="line">      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br><span class="line">      - FABRIC_LOGGING_SPEC=DEBUG</span><br><span class="line">      - CORE_PEER_ID=cli</span><br><span class="line">      - CORE_PEER_ADDRESS=peer:7051</span><br><span class="line">      - CORE_PEER_LOCALMSPID=DEFAULT</span><br><span class="line">      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp</span><br><span class="line">    working_dir: /opt/gopath/src/chaincodedev</span><br><span class="line">#    command: /bin/bash -c &apos;./script.sh&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - /var/run/:/host/var/run/</span><br><span class="line">      - ./nodes/peer1/msp:/etc/hyperledger/msp</span><br><span class="line">      - /Users/xiaoxuez/go/src/github.com/hyperledger/fabric/examples/chaincode/go:/opt/gopath/src/chaincodedev/chaincode</span><br><span class="line">      - ./:/opt/gopath/src/chaincodedev/</span><br><span class="line">    depends_on:</span><br><span class="line">      - orderer</span><br><span class="line">      - peer1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure.sh &quot;mychannel&quot; &quot;channel.tx anchor.tx&quot; &quot;peer1 peer2 peer3 peer4&quot; false</span><br></pre></td></tr></table></figure><hr><h4 id="1-ç”Ÿæˆå…¬ç§é’¥å’Œè¯ä¹¦"><a href="#1-ç”Ÿæˆå…¬ç§é’¥å’Œè¯ä¹¦" class="headerlink" title="1. ç”Ÿæˆå…¬ç§é’¥å’Œè¯ä¹¦"></a>1. ç”Ÿæˆå…¬ç§é’¥å’Œè¯ä¹¦</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cryptogen generate  --config ./crypto-config.yaml --output crypto-config</span><br></pre></td></tr></table></figure><p>â€”output ä¸ºç”Ÿæˆåçš„æ–‡ä»¶å¤¹</p><p>crypto-config.yamlä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">OrdererOrgs:</span><br><span class="line">  - Name: Orderer</span><br><span class="line">    Domain: orderer.net</span><br><span class="line">    CA:</span><br><span class="line">      Country: US</span><br><span class="line">      Province: California</span><br><span class="line">      Locality: San Francisco</span><br><span class="line">    Specs:</span><br><span class="line">      - Hostname: orderer</span><br><span class="line"></span><br><span class="line">PeerOrgs:</span><br><span class="line">  - Name: Org1</span><br><span class="line">    Domain: org1.net</span><br><span class="line">    CA:</span><br><span class="line">      Country: US</span><br><span class="line">      Province: California</span><br><span class="line">      Locality: San Francisco</span><br><span class="line">    Template:</span><br><span class="line">      Count: 4</span><br><span class="line">      Start: 1</span><br><span class="line">    Users:</span><br><span class="line">      Count: 1</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªç»„ç»‡ï¼Œä¸ºOrdererå’ŒOrg1ã€‚ä½¿ç”¨å‘½ä»¤åç”Ÿæˆæ–‡ä»¶ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">crypto-config</span><br><span class="line">â”œâ”€â”€ ordererOrganizations</span><br><span class="line">â”‚Â Â  â””â”€â”€ orderer.net</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ca</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ msp</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ orderers</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ tlsca</span><br><span class="line">â”‚Â Â      â””â”€â”€ users</span><br><span class="line">â””â”€â”€ peerOrganizations</span><br><span class="line">    â””â”€â”€ org1.net</span><br><span class="line">        â”œâ”€â”€ ca</span><br><span class="line">        â”œâ”€â”€ msp</span><br><span class="line">        â”œâ”€â”€ peers //countä¸º4æ‰€ä»¥peersä¸‹é¢ä¼šæœ‰4ä¸ª</span><br><span class="line">        â”œâ”€â”€ tlsca</span><br><span class="line">        â””â”€â”€ users</span><br></pre></td></tr></table></figure><p>å…³äºè¯ä¹¦ï¼Œç¨å¾®è¯´æ˜ä¸€ä¸‹çœ‹åˆ°çš„æºç ã€‚</p><p>é¦–å…ˆï¼Œæ˜¯ä¸¤ä¸ªç»„ç»‡ï¼Œä»cryptogençš„è§’åº¦ä¸Šæ¥è®²ï¼Œè¿™ä¸¤ä¸ªç»„ç»‡çš„ä¸€åˆ‡è¯ä¹¦å’Œå…¬ç§é’¥ç”Ÿæˆæ–¹å¼æ˜¯ä¸€æ ·çš„ã€‚åªæ˜¯åå­—ä»€ä¹ˆçš„æ˜¯ç”±é…ç½®æ–‡ä»¶å†³å®šçš„ã€‚</p><p>å…¶æ¬¡ï¼Œä¸€ç»„è¯ä¹¦å’Œå…¬ç§é’¥çš„ç”Ÿæˆæ–¹å¼å‘¢ï¼Œåˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p><ol><li>ç”Ÿæˆå…¬ç§é’¥ï¼Œç”±ç§é’¥å¯¹åŒ…å«å…¬é’¥çš„ç­‰ä¿¡æ¯è¿›è¡Œç­¾åå¯å¾—è¯ä¹¦ã€‚</li><li>ä¸€ä¸ªç»„ç»‡çš„è¯ä¹¦é“¾ï¼ŒåŒ…å«ä¸€ä¸ªroot caï¼Œå¯å…¶ç­¾å‘çš„ä¸€ç³»åˆ—è¯ä¹¦ã€‚é¦–å…ˆï¼Œä¼šäº§ç”Ÿä¸€å¯¹å…¬ç§é’¥ï¼Œè¿™ä¸ªç§é’¥ä¼šä½œä¸ºroot caçš„ç§é’¥ï¼Œconfigä¸­å®šä¹‰çš„caçš„å…¶ä»–å±æ€§ä¼šä½œä¸ºroot caçš„å…ƒæ•°æ®(ç­¾åæ—¶åº”è¯¥ä¼šç”¨åˆ°)ï¼Œç„¶åå°±ä¼šç”Ÿæˆä¸€ä¸ªç§é’¥æ–‡ä»¶ï¼Œå’Œä¸€ä¸ªroot caçš„è¯ä¹¦(è¯ä¹¦é“¾ä¸­çš„é¡¶çº§è¯ä¹¦)ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶ä½äºcaæ–‡ä»¶å¤¹ã€‚</li><li>å¦å¤–ï¼Œå› ä¸ºfabricä¸­éœ€è¦ä¸¤å¥—è¯ä¹¦ï¼Œå¦å¤–ä¸€å¥—ä¸ºtlsï¼Œç”¨äºé€šä¿¡ä¼ è¾“.. æ‰€ä»¥ä¼šç”Ÿæˆä¸¤å¥—(ç”Ÿæˆé€»è¾‘æ˜¯ä¸€æ¯›ä¸€æ ·çš„)ï¼Œä¸€å¥—ä½äºcaæ–‡ä»¶å¤¹ï¼Œä¸€å¥—ä½äºtlscaæ–‡ä»¶å¤¹ã€‚</li><li>mspæ–‡ä»¶å¤¹å†…çš„å†…å®¹ä¸»è¦æ˜¯caå’Œtlscaä¸­çš„è¯ä¹¦çš„æ‹·è´(ä¸åŒ…å«ç§é’¥)ï¼Œå¦å¤–æ˜¯æœ‰ä¸€ä¸ªadminçš„ç”¨æˆ·è¯ä¹¦(æ‹·è´è‡ªç”¨æˆ·ç›®å½•)</li><li>usersç›®å½•å’Œpeersç›®å½•ä¸­ï¼Œæ¯ä¸ªpeerå’Œuserçš„é€»è¾‘éƒ½æ˜¯ç”Ÿæˆäº†ä¸€å¯¹å…¬ç§é’¥ï¼Œéšåï¼Œä½¿ç”¨root caå’Œtlscaå¯¹å…¬é’¥dç­‰ä¿¡æ¯è¿›è¡Œç­¾åé¢å‘è¯ä¹¦ï¼ŒåŒæ ·ä¹ŸåŒ…å«ä¸¤å¥—è¯ä¹¦ï¼ŒåŒæ—¶ï¼Œè¿˜åŒ…æ‹¬root caå’Œtlscaçš„è‡ªå¸¦è¯ä¹¦</li></ol><p>å…³äºè¯ä¹¦éªŒè¯çš„é—®é¢˜ï¼Œå¯åŠ¨caæœåŠ¡ç«¯æ—¶ä¼šå°†root caä½œä¸ºå…¶ç­¾å‘è¯ä¹¦çš„ç§é’¥ï¼Œå½“ç”¨æˆ·æ³¨å†Œå¹¶ç”³è¯·è¯ä¹¦åè·å¾—è¯ä¹¦ï¼Œå…¶å®ca serverè¿”å›çš„x509æ ¼å¼çš„è¯ä¹¦ç”³è¯·ç»“æœä¸­æ˜¯å«æœ‰è¯ä¹¦å’Œç­¾å‘è€…çš„å…¬é’¥ä¿¡æ¯çš„ï¼Œä½†åœ¨fabric-sdk-goçš„ä½¿ç”¨ä¸­ï¼Œenrollçš„ç»“æœè¿”å›åªæœ‰è¯ä¹¦ï¼Œåœ¨å°è£…çš„å†…å±‚ä»£ç ä¸­å°†ç­¾å‘è€…çš„å…¬é’¥ä¿¡æ¯ç›´æ¥å¿½ç•¥äº†ã€‚å½“ç”¨æˆ·æ‹¿åˆ°è¯ä¹¦ï¼Œè¿›è¡Œäº¤æ˜“å‘é€åˆ°peerï¼Œpeerå¦‚ä½•éªŒè¯è¯ä¹¦å‘¢.. peerç›®å‰åªæœ‰ä¸¤ä¸ªç­¾å‘è€…ï¼Œä¸€ä¸ªæ˜¯è‡ªå·±ï¼Œä¸€ä¸ªæ˜¯root ca(å…·æœ‰root caçš„è¯ä¹¦ï¼Œæ‰€ä»¥å°±å¯ä»¥ä½¿ç”¨å…¬é’¥éªŒè¯)ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ä½¿ç”¨è¿™ä¸¤è€…è¿›è¡ŒéªŒè¯å§ã€‚ä½†æ˜¯ï¼Œå†æƒ³æƒ³ï¼Œå…¶å®æ­£å¸¸çš„æƒ…å†µï¼Œæ„æˆäº†è¯ä¹¦é“¾çš„è¯ï¼Œå¦‚æœa -&gt; b -&gt; cçš„è¯ä¹¦é“¾çš„è¯ï¼Œåº”è¯¥æ˜¯ç”¨æˆ·æäº¤çš„è¯ä¹¦ä¸­ï¼Œå°±ä¼šåŒ…å«æ•´ä¸ªè¯ä¹¦é“¾ï¼Œä»¥åå¾…è€ƒè¯ï¼Ÿ</p><h4 id="2-ç”Ÿæˆåˆå§‹å—å’Œé…ç½®çš„äº¤æ˜“"><a href="#2-ç”Ÿæˆåˆå§‹å—å’Œé…ç½®çš„äº¤æ˜“" class="headerlink" title="2. ç”Ÿæˆåˆå§‹å—å’Œé…ç½®çš„äº¤æ˜“"></a>2. ç”Ÿæˆåˆå§‹å—å’Œé…ç½®çš„äº¤æ˜“</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configtxgen -profile SampleOrg -outputBlock ./channel-artifacts/genesis.block</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ä¼šè‡ªåŠ¨åŠ è½½å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„<code>configtx.yaml</code>é…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶é…ç½®äº†å“ªäº›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0</span><br><span class="line">//-p  Path to chaincode,</span><br><span class="line">//  é»˜è®¤è·¯å¾„æ˜¯ä»gopathä¸‹è¿›è¡Œæœç´¢ï¼Œå³ä¸Šä¾‹ä¸­çš„è·¯å¾„ä¸ºgopath/chaincodedev/chaincode/sacc, saccä¸ºæ–‡ä»¶å¤¹åç§°ï¼Œåªé…ç½®åˆ°æ–‡ä»¶å¤¹å³å¯</span><br><span class="line">//-n, --name string                    Name of the chaincode</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C $CHANNEL_NAME -n mycc -v 1.0 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&apos; -P &quot;OR (&apos;Org1MSP.admin&apos;,&apos;Org1MSP.member&apos;)&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode instantiate -o orderer.example.com:7050  --tls true --cafile  /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n marbles02 -v 0 -c &apos;&#123;&quot;Args&quot;:[&quot;&quot;]&#125;&apos; -P &quot;OR (&apos;Org1MSP.admin&apos;,&apos;Org1MSP.member&apos;)&quot;</span><br><span class="line">//æ²¡æœ‰é…tslçš„è¯å°±ä¸è™šè¦--tls true --cafile  -oä¹Ÿæœ‰é»˜è®¤å€¼orderer.example.com:7050  -Pé»˜è®¤å€¼ï¼Ÿ</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚çœ‹äº†ä¸‹ï¼Œæ²¡æ€ä¹ˆçœ‹é€ã€‚åŸºæœ¬çš„è¯´ä¸€ä¸‹ï¼Œåœ¨configtx.yamlä¸­ï¼Œå®šä¹‰äº†åˆå§‹ç»„ç»‡çš„åŸºæœ¬ä¿¡æ¯ã€‚å…¶ä¸­Profilesæä¾›äº†ä¸€äº›ç»„åˆï¼Œè¿™äº›ç»„åˆå¯ä»¥æä¾›ç”Ÿæˆgenesiså—(åŒ…å«orderä¿¡æ¯ç»„ç»‡å’Œè´¢å›¢(Consortiums = =åº”è¯¥å°±æ˜¯æƒé™æœ€å¤§çš„ç»„ç»‡))ï¼Œå¯ä»¥ç”Ÿæˆæ–°å»ºchannelçš„äº¤æ˜“(åŒ…å«ä¸€ä¸ªConsortiumå’ŒApplicationå®šä¹‰)ã€‚</p><p>é¦–å…ˆï¼Œä¼šä½¿ç”¨configtx.yamlç”Ÿæˆåˆ›ä¸–å—ï¼ŒOneOrgOrdererGenesisä¸ºProfilesä¸­çš„å®šä¹‰çš„ç»„åˆæ®µè½ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configtxgen -profile OneOrgOrdererGenesis -outputBlock ./config/genesis.block</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œç”Ÿæˆç›¸åº”çš„é€šé“ï¼ŒåŒç†OneOrgChannelä¹Ÿæ˜¯Profilesä¸­çš„å®šä¹‰çš„ç»„åˆæ®µè½ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configtxgen -profile  OneOrgChannel -outputCreateChannelTx ./config/channel.tx -channelID $CHANNEL_NAME</span><br></pre></td></tr></table></figure><p>è¦æ–°å»ºé€šé“çš„è¯ï¼Œå°±è¦å…ˆä½¿ç”¨ä¸Šè¿°ç”Ÿæˆé€šé“çš„å‘½ä»¤ç”Ÿæˆä¸€ä¸ª.txçš„æ–‡ä»¶ï¼Œç„¶åå†è°ƒç”¨æ–°å»ºé€šé“çš„å‘½ä»¤ä¼ å…¥è¿™ä¸ªæ–‡ä»¶ã€‚</p><h3 id="go-sdk"><a href="#go-sdk" class="headerlink" title="go-sdk"></a>go-sdk</h3><h4 id="config-yaml"><a href="#config-yaml" class="headerlink" title="config.yaml"></a>config.yaml</h4><p>åˆå§‹åŒ–sdkçš„æ—¶å€™éœ€è¦ä¼ å…¥config.yamlï¼Œæ‰€ä»¥è¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯æœ€å…³é”®çš„ã€‚</p><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸»è¦åŒ…å«å‡ ä¸ªå¤§å—ã€‚</p><ul><li>clientï¼Œå®¢æˆ·ç«¯é…ç½®ï¼Œå³å¯¹è‡ªå·±çš„ä¸€äº›é…ç½®ï¼ŒåŒ…æ‹¬è‡ªå·±æ‰€å±ç»„ç»‡ï¼Œè‡ªå·±çš„mspæ–‡ä»¶(keyså’Œcerts)ã€‚BCCSPå®šä¹‰äº†åŠ å¯†çš„ç›¸å…³ç®—æ³•ï¼Œè¿˜æœ‰å°±æ˜¯tlsè¯ä¹¦é…ç½®</li><li>channel, é…ç½®é€šé“ï¼Œå³å½“è®¿é—®æŸé€šé“æ—¶é€šè¿‡å“ªäº›peer(peer_name)ï¼Œä»¥åŠè¿™ä¸ªpeerå…·æœ‰çš„æƒé™ï¼Œè¿˜æœ‰å°±æ˜¯æ€§èƒ½ç›¸å…³çš„é…ç½®ã€‚ç¨‹åºè¦è®¿é—®ä¸åŒçš„é€šé“ï¼Œè¿™ä¸ªå°±éœ€è¦æœ‰ç›¸åº”çš„é…ç½®é¡¹ã€‚ä¸ç„¶å°±ä¼šæŠ¥<code>could not get chConfig reference</code></li><li>organizations,é…ç½®ç½‘ç»œä¸­çš„å‚ä¸è€…(org -&gt; peer_name å’Œ orderorg)</li><li>orderers, é…ç½®ordererçš„nameå’Œç›¸å…³rpcçš„é…ç½®ï¼Œtlsé…ç½®</li><li>peersï¼Œé…ç½®peersçš„nameå’Œç›¸å…³rpcçš„é…ç½®ï¼Œtlsé…ç½®</li><li>certificateAuthoritiesï¼Œ é…ç½®caçš„nameå’Œç›¸å…³rpcçš„é…ç½®ï¼Œtlsé…ç½®</li><li>entityMatchersï¼Œè¿™ä¸ªæ˜¯åŒ¹é…æ›¿æ¢ï¼Œç”¨äºé›†ä¸­æ›¿æ¢ï¼Œå¯åŒ¹é…æ­£åˆ™çš„nameï¼Œæ»¡è¶³çš„å®ä½“(peerã€ordererã€ca)éƒ½ä¼šè¿›è¡Œç›¸åº”çš„æ›¿æ¢ï¼Œå¯ç”¨äºæ›¿æ¢url..</li></ul><h4 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><ul><li><p>fabsdk.New(config)</p><ul><li>defPkgSuiteï¼ŒåŒ…ç®¡ç†å·¥å…·ï¼Œæ ¹æ®configæä¾›ç›¸åº”çš„åŒ…ï¼ŒdefaultPkgSuiteæä¾›çš„æ¯ä¸ªåŒ…éƒ½æ˜¯å·¥å‚æ¨¡å¼ï¼Œæ ¹æ®configå¯æä¾›å¯¹åº”çš„å…·ä½“çš„åŒ…ã€‚<ul><li>Core(corefactory)ï¼Œæä¾›äº†BCCSPã€signing managerå’Œfabric primitivesçš„å®ç°åŒ…ã€‚<ul><li>BCCSPå³åŒºå—é“¾åŠ å¯†æœåŠ¡æä¾›è€…ï¼Œæä¾›åŠ å¯†æ ‡å‡†å’Œç®—æ³•çš„å®ç°ã€‚ç›®å‰æ”¯æŒä¸¤ç§å®ç°ï¼Œswå’Œpkcs11ã€‚<ul><li>swå³software-basedï¼ŒåŸºäºè½¯ä»¶å®ç°çš„BCCSPï¼Œé€šè¿‡è°ƒç”¨goåŸç”Ÿæ”¯æŒçš„å¯†ç ç®—æ³•å®ç°ï¼Œå¹¶æä¾›keystoreæ¥ä¿å­˜å¯†é’¥</li><li>pkcs11ï¼Œé€šè¿‡è°ƒç”¨pkcs11æ¥å£å®ç°ç›¸å…³åŠ å¯†æ“ä½œï¼Œä»…æ”¯æŒecdsaã€rsaä»¥åŠaesç®—æ³•ï¼Œå¯†ç ä¿å­˜åœ¨pkcs11é€šè¿‡pinå£ä»¤ä¿æŠ¤çš„æ•°æ®åº“æˆ–è€…ç¡¬ä»¶è®¾å¤‡ä¸­ã€‚</li></ul></li></ul></li><li>MSPï¼Œæˆå‘˜ç®¡ç†æä¾›å®ç°ï¼Œå¦‚æœ¬åœ°æˆå‘˜ç®¡ç†(ä»é…ç½®æ–‡ä»¶è¯»å…¥ç”¨æˆ·..æœ¬åœ°å­˜å‚¨ç”¨æˆ·ç­‰)ï¼Œä¸»è¦å®ç°ä½äºmsppvdråŒ…ä¸‹ã€‚</li><li>Serviceï¼ŒæœåŠ¡æä¾›å®ç°ï¼Œå¦‚channelæœåŠ¡ã€discoveryæœåŠ¡ç­‰..</li><li>Logger</li></ul></li></ul><p>æ‰€ä»¥ï¼Œå…¶å®fabsdk.newå°±æ˜¯æä¾›äº†ä¸€å¤§å †çš„provideã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//update sdk providers list since all required providers are initialized</span><br><span class="line">sdk.provider = context.NewProvider(context.WithCryptoSuiteConfig(cfg.cryptoSuiteConfig),</span><br><span class="line">context.WithEndpointConfig(cfg.endpointConfig),</span><br><span class="line">context.WithIdentityConfig(cfg.identityConfig),</span><br><span class="line">context.WithCryptoSuite(sdk.cryptoSuite),</span><br><span class="line">context.WithSigningManager(signingManager),</span><br><span class="line">context.WithUserStore(userStore),</span><br><span class="line">context.WithLocalDiscoveryProvider(localDiscoveryProvider),</span><br><span class="line">context.WithIdentityManagerProvider(identityManagerProvider),</span><br><span class="line">context.WithInfraProvider(infraProvider),</span><br><span class="line">context.WithChannelProvider(channelProvider),</span><br><span class="line">context.WithClientMetrics(sdk.clientMetrics),</span><br><span class="line">)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li></ul><p>æ€»çš„æ¥è¯´ï¼Œgo-sdkæ˜¯å°è£…çš„rpcã€‚æ‰€ä»¥æœ‰äº†sdkçš„ç›¸å…³ä¸Šä¸‹æ–‡ï¼Œå°±å¯ä»¥è¿›è¡Œå®ä¾‹åŒ–ç›¸å…³çš„rpc clientäº†ã€‚åœ¨pkgåŒ…ä¸‹çš„clienté‡Œï¼Œç›®å½•å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ channel   //é€šé“ç›¸å…³çš„rpc</span><br><span class="line">â”œâ”€â”€ common</span><br><span class="line">â”œâ”€â”€ event//äº‹ä»¶ç›‘å¬ï¼Œå¦‚åŒºå—ã€é“¾ç ã€æˆ–äº¤æ˜“çŠ¶æ€</span><br><span class="line">â”œâ”€â”€ ledger//è´¦æœ¬ç›¸å…³rpc,å¦‚æŸ¥è¯¢åŒºå—ã€äº¤æ˜“ç­‰</span><br><span class="line">â”œâ”€â”€ msp//æˆå‘˜ç›¸å…³rpc,ä¸caäº¤äº’ï¼Œæä¾›æ³¨å†ŒæŸ¥è¯¢ç­‰api</span><br><span class="line">â””â”€â”€ resmgmt//resouce manager clinet</span><br></pre></td></tr></table></figure><h4 id="msp"><a href="#msp" class="headerlink" title="msp"></a>msp</h4><p>mspåŒ…æä¾›äº†ä¸caç›¸å…³çš„rpcè°ƒç”¨ï¼Œå¦‚æ³¨å†Œç­‰ã€‚åŒæ—¶ä¹Ÿæä¾›äº†æŸ¥è¯¢æœ¬åœ°identifyåŠŸèƒ½ï¼Œå³è®¿é—®æœ¬åœ°æ–‡ä»¶ï¼ŒæŸ¥è¯¢å‡ºå…·ä½“çš„ç§é’¥å’Œç›¸å…³è¯ä¹¦(msppvdråŒ…)ã€‚</p><p>rpcç›¸å…³è°ƒç”¨åŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. èº«ä»½æ³¨å†Œï¼›</span><br><span class="line">2. é¢å‘ç™»å½•è¯ä¹¦(ECerts)ï¼›</span><br><span class="line">3. é¢å‘äº¤æ˜“è¯ä¹¦(TCerts)ï¼Œä¿è¯é“¾ä¸Šäº¤æ˜“çš„åŒ¿åæ€§ä¸ä¸å¯è¿æ¥æ€§ï¼›</span><br><span class="line">4. è¯ä¹¦ç»­æœŸä¸æ’¤é”€</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œåªæœ‰å·²ç»ç™»å½•äº†çš„èº«ä»½æ‰èƒ½å‘èµ·æ³¨å†Œçš„è¯·æ±‚ï¼Œè€Œä¸”å¿…é¡»æœ‰ç›¸åº”çš„æƒé™æ¥æ³¨å†Œæƒ³è¦æ³¨å†Œçš„èº«ä»½ç±»å‹ã€‚æ‰€ä»¥è¦æ³¨å†Œç”¨æˆ·ï¼Œé¦–å…ˆè¦ä½¿ç”¨ä¸€ä¸ªå·²æœ‰çš„èº«ä»½ï¼Œç„¶åå†è¿›è¡Œæ³¨å†Œæ–°ç”¨æˆ·å’Œå¯†ç ã€‚</p><ul><li>Enrollæ–¹æ³•ï¼Œå†…å®¹åŒ…æ‹¬ï¼Œç”Ÿæˆæ–°çš„ç§é’¥(å­˜äºconfig.credentialStore.cryptoStore/)ï¼Œç„¶åå°†å…¬é’¥ç­‰ä¿¡æ¯ä½œä¸ºå‚æ•°ï¼Œè¿›è¡Œhttpè¯·æ±‚caæœåŠ¡å™¨ï¼ŒcaæœåŠ¡å™¨å°†è¿”å›å¯¹å…¬é’¥ç­‰ä¿¡æ¯è¿›è¡Œç­¾åå®Œçš„è¯ä¹¦(å­˜äºconfig.credentialStore.path/)ã€‚<ul><li>æåˆ°è¿™é‡Œï¼Œå¤šå˜´ä¸€å¥ï¼Œè¯ä¹¦çš„å­˜å‚¨æ–‡ä»¶åä¸º<a href="mailto:name@Org1MSP-cert.pem" target="_blank" rel="noopener">name@Org1MSP-cert.pem</a>ï¼Œåœ¨è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå¯ä½¿ç”¨nameæˆ–Org1MSPçš†å¯æŸ¥è¯¢åˆ°è¯ä¹¦ï¼Œç„¶åé€šè¿‡å¯¹è¯ä¹¦è¿›è¡Œè§£æå‡ºå…¬é’¥pubKeyï¼Œnameå’ŒpubKey.SKI()ç»„æˆäº†ç§é’¥çš„æ–‡ä»¶åï¼Œä»è€Œå¯ç´¢å¼•åˆ°ç§é’¥ã€‚</li></ul></li></ul><p>â€‹        æ€»çš„æ¥è¯´å°±æ˜¯ä¸€æ¬¡Enrollï¼Œå°±ä¼šæ›´æ–°ä¸€æ¬¡ç§é’¥å’Œè¯ä¹¦ã€‚</p><ul><li><p>Registeræ–¹æ³•ï¼Œè¿›è¡Œæ³¨å†Œï¼Œä¸Šæ–‡æåˆ°ï¼Œè¦æ³¨å†Œï¼Œé¦–å…ˆè¦ç™»å½•ä¸€ä¸ªå·²æœ‰çš„èº«ä»½(ç”¨æˆ·å)ï¼Œè·å–è¯ä¹¦ï¼Œç„¶åå†ä½¿ç”¨è¯ä¹¦è¿›è¡Œæ³¨å†Œåˆ«çš„èº«ä»½ã€‚</p><ul><li><p>æ³¨å†Œæ—¶å¯ä¼ å±æ€§ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">attributes:</span><br><span class="line">        - name: hf.Revoker</span><br><span class="line">        value: true</span><br><span class="line">        ECert: true</span><br><span class="line">        - name: anotherAttrName</span><br><span class="line">        value: anotherAttrValue</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåº”è¯¥æ˜¯è·ŸLDAPâ€¦ç›¸å…³çš„å§..æš‚æ—¶ä¸çŸ¥é“æ˜¯å•¥</p></li></ul></li></ul><h4 id="channel-1"><a href="#channel-1" class="headerlink" title="channel"></a>channel</h4><p>é€šé“ç›¸å…³apiï¼Œå¦‚é“¾ç çš„è°ƒç”¨ã€‚</p><p>è¿™é‡Œå…ˆå¯¹é“¾ç çš„è°ƒç”¨ç®€å•åˆ†æä¸€ä¸‹ã€‚</p><p>channelçš„å®¢æˆ·ç«¯æä¾›äº†ä¸¤ä¸ªæ–¹æ³•<code>Query</code>å’Œ<code>Execute</code></p><p>å…ˆè¯´äºŒè€…çš„å…±åŒæµç¨‹ã€‚ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯è´Ÿè´£ç»„è£…å‚æ•°(handlersâ€¦opts..)åè°ƒç”¨<code>chclinet.InvokeHandler</code>ã€‚åœ¨<code>InvokeHandler</code>é‡Œå¯ä»¥çœ‹åˆ°æµç¨‹æ˜¯å‡†å¤‡å‚æ•°ï¼Œå‡†å¤‡ä¸Šä¸‹æ–‡ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªåç¨‹è¿è¡Œhandlersï¼Œæœ¬æ–¹æ³•å µå¡ç›´åˆ°completeæˆ–reqCtx.Done()é€šé“è¯»å‡ºæ¶ˆæ¯ï¼Œå½“handlersè¿è¡Œå®Œæ¯•åä¼šå‘é€šé“completeå†™å…¥æ¶ˆæ¯(æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šå†™å…¥)ï¼ŒreqCtx.Done()åˆ™æ˜¯è¶…æ—¶ã€‚æ‰€ä»¥é‡ç‚¹æ˜¯è¿è¡ŒHandlerã€‚Handlerçš„ç»„è£…ç±»ä¼¼äºç”Ÿäº§çº¿ï¼Œå¦‚a -&gt; b -&gt;cæŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸”å°†ä¸Šä¸€ä¸ªæ‰§è¡Œçš„ç»“æœä¹Ÿä¼ é€’ç»™ä¸‹ä¸€ä½ã€‚</p><ul><li><p>Query</p><ul><li><p>ProposalProcessorHandler</p><p>é¦–å…ˆï¼Œæ£€æŸ¥targetså‚æ•°é•¿åº¦æ˜¯å¦ä¸º0ï¼Œtargetsä¸ºè¿›è¡ŒèƒŒä¹¦çš„èŠ‚ç‚¹ä»¬ã€‚å¦‚æœæ²¡æœ‰æä¾›targetsï¼Œå°†ä¼šæŸ¥è¯¢èƒŒä¹¦çš„èŠ‚ç‚¹ï¼Œoptså‚æ•°ä¸­çš„filterå°†ä¼šåœ¨è¿™é‡Œä½¿ç”¨åˆ°ï¼Œå°±æ˜¯æŒ‰éœ€æ±‚ç­›é€‰èŠ‚ç‚¹(å¦‚æ˜¯æŸ¥è¯¢è¿˜æ˜¯èƒŒä¹¦â€¦)</p></li><li><p>EndorsementHandler</p><p>å…¶æ¬¡ï¼Œä¼šå°†proposalå‘é€åˆ°å„ä¸ªtargetsï¼Œè¿”å›çš„responsesä¼šä¼ é€’ä¸‹å»</p></li><li><p>EndorsementValidationHandler</p><p>å†æ¬¡ï¼ŒéªŒè¯å„ä¸ªtargetè¿”å›çš„ç»“æœï¼ŒçŠ¶æ€ç æ˜¯å¦æ­£å¸¸ï¼Œreponseæ˜¯å¦ä¸€æ ·</p></li><li><p>SignatureValidationHandler</p><p>æœ€åï¼ŒéªŒè¯å„ä¸ªèŠ‚ç‚¹è¿”å›çš„responseçš„ç­¾å/è¯ä¹¦æ˜¯å¦æ­£ç¡®</p></li></ul><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œqueryè¯·æ±‚å°±å®Œæˆäº†ï¼Œæœ€åå°†reponseè¿”å›ç»™ä¸Šå±‚</p></li><li><p>Execute</p><ul><li><p>SelectAndEndorseHandler</p><p>é¦–å…ˆæ£€æŸ¥targetsï¼Œå…¶æ¬¡è°ƒç”¨EndorsementHandlerå‘é€proposalï¼Œç„¶åæ ¹æ®é“¾ç ç­–ç•¥å‘å¦å¤–çš„peerå‘èµ·proposalï¼Œè¿”å›çš„responsesä¸€èµ·ä¼ é€’ä¸‹å»</p></li><li><p>EndorsementValidationHandler</p><p>åŒä¸Š</p></li><li><p>SignatureValidationHandler</p><p>åŒä¸Š</p></li><li><p>CommitHandler</p><p>æ‹¿åˆ°æ‰€æœ‰peerçš„èƒŒä¹¦åï¼Œé¦–å…ˆå‘orderå‘é€äº¤æ˜“ã€‚ç„¶åè®¢é˜…è¿™ç¬”äº¤æ˜“çŠ¶æ€ï¼Œæ¥æ”¶åˆ°æ–°çŠ¶æ€ï¼Œæ–¹æ³•æ‰§è¡Œç»“æŸï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œ</p></li></ul></li></ul><p>responseç»“æ„ä½“ä¸­åŒ…å«æœ‰Payloadï¼ŒChaincodeStatusï¼ŒTxValidationCodeã€‚</p><p>åœ¨github.com/hyperledger/fabric/protos/peerä¸‹æœ‰TxValidationCodeçš„æ‰€æœ‰ç ï¼Œå¯åˆ¤æ–­å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">switch pb.TxValidationCode(response.TxValidationCode) &#123;</span><br><span class="line">case pb.TxValidationCode_VALID:</span><br><span class="line">cliconfig.Config().Logger().Debugf(&quot;(%s) - Successfully committed transaction [%s] ...\n&quot;, t.id, response.TransactionID)</span><br><span class="line">return nil</span><br><span class="line">case pb.TxValidationCode_DUPLICATE_TXID, pb.TxValidationCode_MVCC_READ_CONFLICT, pb.TxValidationCode_PHANTOM_READ_CONFLICT:</span><br><span class="line">cliconfig.Config().Logger().Debugf(&quot;(%s) - Transaction commit failed for [%s] with code [%s]. This is most likely a transient error.\n&quot;, t.id, response.TransactionID, response.TxValidationCode)</span><br><span class="line">return invokeerror.Wrapf(invokeerror.TransientError, errors.New(&quot;Duplicate TxID&quot;), &quot;invoke Error received from eventhub for TxID [%s]. Code: %s&quot;, response.TransactionID, response.TxValidationCode)</span><br><span class="line">default:</span><br><span class="line">cliconfig.Config().Logger().Debugf(&quot;(%s) - Transaction commit failed for [%s] with code [%s].\n&quot;, t.id, response.TransactionID, response.TxValidationCode)</span><br><span class="line">return invokeerror.Wrapf(invokeerror.PersistentError, errors.New(&quot;error&quot;), &quot;invoke Error received from eventhub for TxID [%s]. Code: %s&quot;, response.TransactionID, response.TxValidationCode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="sdk-example"><a href="#sdk-example" class="headerlink" title="sdk example"></a>sdk example</h4><p><a href="https://github.com/securekey/fabric-examples/tree/master/fabric-cli">Sdk example </a></p><h2 id="couchdb"><a href="#couchdb" class="headerlink" title="couchdb"></a>couchdb</h2><h4 id="æŸ¥è¯¢ç´¢å¼•"><a href="#æŸ¥è¯¢ç´¢å¼•" class="headerlink" title="æŸ¥è¯¢ç´¢å¼•"></a>æŸ¥è¯¢ç´¢å¼•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5984/mychannel_mycc/_index</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;total_rows&quot;:2,</span><br><span class="line">    &quot;indexes&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;ddoc&quot;:null,</span><br><span class="line">            &quot;name&quot;:&quot;_all_docs&quot;,</span><br><span class="line">            &quot;type&quot;:&quot;special&quot;,</span><br><span class="line">            &quot;def&quot;:&#123;</span><br><span class="line">                &quot;fields&quot;:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;_id&quot;:&quot;asc&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;ddoc&quot;:&quot;_design/indexOwnerDoc&quot;,</span><br><span class="line">            &quot;name&quot;:&quot;indexOwner&quot;,</span><br><span class="line">            &quot;type&quot;:&quot;json&quot;,</span><br><span class="line">            &quot;def&quot;:&#123;</span><br><span class="line">                &quot;fields&quot;:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;docType&quot;:&quot;asc&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;owner&quot;:&quot;asc&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯åœ¨æˆ‘åˆšå¯åŠ¨å¥½é“¾ç å®¹å™¨æ—¶ï¼Œä»€ä¹ˆæ“ä½œéƒ½æ²¡åšã€‚ä¸ºä»€ä¹ˆä¼šå»ºäº†ä¸€ä¸ªç´¢å¼•å‘¢.</p><p>å¦å¤–ï¼Œåœ¨è¿™ä¸ªæ–‡æ¡£ä¸‹ï¼Œå‘ç°å­˜åœ¨ä¸€æ¡è®°å½•(ä¸€æ‰“å¼€å°±æœ‰ä¸€æ¡è®°å½•)ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot;:&quot;_design/indexOwnerDoc&quot;,</span><br><span class="line">    &quot;_rev&quot;:&quot;1-56c3e9386cb19531f6731afa88281caa&quot;,</span><br><span class="line">    &quot;language&quot;:&quot;query&quot;,</span><br><span class="line">    &quot;views&quot;:&#123;</span><br><span class="line">        &quot;indexOwner&quot;:&#123;</span><br><span class="line">            &quot;map&quot;:&#123;</span><br><span class="line">                &quot;fields&quot;:&#123;</span><br><span class="line">                    &quot;docType&quot;:&quot;asc&quot;,</span><br><span class="line">                    &quot;owner&quot;:&quot;asc&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;partial_filter_selector&quot;:&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;reduce&quot;:&quot;_count&quot;,</span><br><span class="line">            &quot;options&quot;:&#123;</span><br><span class="line">                &quot;def&quot;:&#123;</span><br><span class="line">                    &quot;fields&quot;:[</span><br><span class="line">                        &quot;docType&quot;,</span><br><span class="line">                        &quot;owner&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çŒœæµ‹ï¼Œç´¢å¼•åº”è¯¥æ˜¯ç”±è¿™æ¡è®°å½•å¼•èµ·çš„ï¼Œä¼¼ä¹æ˜¯åˆ›å»ºæ—¶çš„è‡ªåŠ¨çš„ç´¢å¼•ï¼Ÿä¸å¯¹ï¼æ˜¯åœ¨æˆ‘çš„é“¾ç é‡Œï¼Œæœ‰ä¸ªæ–‡ä»¶å¤¹å«META-INFä¸‹å®šä¹‰çš„ã€‚</p><p>æœç„¶ï¼Œè¿™ä¸‹é¢æœ‰ä¸ªjsonæ–‡ä»¶ï¼Œå†…å®¹ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;index&quot;:&#123;&quot;fields&quot;:[&quot;docType&quot;,&quot;owner&quot;]&#125;,</span><br><span class="line">&quot;ddoc&quot;:&quot;indexOwnerDoc&quot;,</span><br><span class="line">&quot;name&quot;:&quot;indexOwner&quot;,</span><br><span class="line">&quot;type&quot;:&quot;json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œå…¨å»åˆã€‚æ‰€ä»¥å®šä¹‰ç´¢å¼•æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼</p><p>å®šä¹‰çš„ç´¢å¼•å¯¹äºæŸ¥è¯¢çš„æ„ä¹‰ï¼Œä¼¼ä¹æ˜¯å¦‚æœè¦æŸ¥è¯¢ç›¸åº”çš„å­—æ®µ(å­—æ®µç›¸å…³ï¼Œå¦‚å¤§äºå•¥å°äºå•¥)ï¼Œå°±è¦å®šä¹‰åŒ…å«å…¶ä¸­çš„å­—æ®µçš„ç´¢å¼•</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šå»ºç«‹ä¸€ä¸ªidçš„ç´¢å¼•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;type&quot;: &quot;special&quot;,</span><br><span class="line"> &quot;def&quot;: &#123;</span><br><span class="line">  &quot;fields&quot;: [</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;_id&quot;: &quot;asc&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  ]</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æ–°å»ºä¸€ä¸ªç´¢å¼•è§†å›¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d &quot;&#123;\&quot;index\&quot;:&#123;\&quot;fields\&quot;:[\&quot;size\&quot;,\&quot;docType\&quot;,\&quot;owner\&quot;]&#125;,\&quot;ddoc\&quot;:\&quot;indexSizeSortDoc1\&quot;, \&quot;name\&quot;:\&quot;indexSizeSortDesc1\&quot;,\&quot;type\&quot;:\&quot;json\&quot;&#125;&quot; http://localhost:5984/mychannel_mycc/_index</span><br></pre></td></tr></table></figure><p>é‡æ–°æŸ¥è¯¢ç´¢å¼•ï¼Œå¤šäº†ä¸€ä¸ª</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;total_rows&quot;:3,</span><br><span class="line">    &quot;indexes&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">         ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">         ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;ddoc&quot;:&quot;_design/indexSizeSortDoc&quot;,</span><br><span class="line">            &quot;name&quot;:&quot;indexSizeSortDesc&quot;,</span><br><span class="line">            &quot;type&quot;:&quot;json&quot;,</span><br><span class="line">            &quot;def&quot;:&#123;</span><br><span class="line">                &quot;fields&quot;:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;size&quot;:&quot;desc&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;docType&quot;:&quot;desc&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;owner&quot;:&quot;desc&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»ºç«‹äº†è¿™ä¸ªç´¢å¼•åï¼Œå°±å¯ä»¥è¿›è¡Œsizeç›¸å…³çš„æŸ¥è¯¢ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#123;\&quot;selector\&quot;:&#123;\&quot;docType\&quot;:&#123;\&quot;$eq\&quot;:\&quot;marble\&quot;&#125;,\&quot;owner\&quot;:&#123;\&quot;$eq\&quot;:\&quot;tom\&quot;&#125;,\&quot;size\&quot;:&#123;\&quot;$gt\&quot;:0&#125;&#125;,\&quot;fields\&quot;:[\&quot;docType\&quot;,\&quot;owner\&quot;,\&quot;size\&quot;],\&quot;sort\&quot;:[&#123;\&quot;size\&quot;:\&quot;desc\&quot;&#125;],\&quot;use_index\&quot;:\&quot;_design/indexSizeSortDoc\&quot;&#125;&quot;</span><br></pre></td></tr></table></figure><p><strong>å•Šï¼ï¼</strong>å°±æ˜¯å»ºç«‹çš„è¿™ä¸ªç´¢å¼•è§†å›¾æ˜¯åŒ…æ‹¬sizeã€docTypeã€ownerè¿™ä¸‰ä¸ªçš„ï¼Œç„¶åæˆ‘ä½¿ç”¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¦‚æœå°‘ä¼ ä¸€ä¸ªï¼Œå°±æ˜¯æˆ‘åªæŸ¥è¯¢docTypeå’Œsizeï¼Œå°±ä¼šæŠ¥é”™<code>Error running query. Reason: (no_usable_index) No index exists for this sort, try indexing by the sort fields.</code></p><p>å‡ ç»æŒ£æ‰å’Œå°è¯•ï¼Œç¡®å®šä¸‹æ¥å‡ ä¸ªç»“è®ºã€‚</p><ol><li>å¦‚æœä¸é€‚ç”¨sortï¼Œselectorä¸­çš„fieldéƒ½éšæ„æŸ¥è¯¢ï¼Œä½¿ç”¨çš„é»˜è®¤index(id ascæ’åº)</li><li>å¦‚æœä½¿ç”¨äº†sortï¼Œé‚£ä¹ˆéœ€è¦ä¸€ä¸ªindexåŒ…å« åœ¨selectorä¸­çš„field + sortä¸­çš„fieldç»„æˆçš„field ï¼Œå¹¶ä¸”indexä¸­å®šä¹‰çš„fieldé›†åˆå¿…é¡»æ˜¯selectorä¸­çš„field + sortä¸­çš„fieldç»„æˆçš„fieldçš„å­é›†ï¼Œå³indexä¸­å‡ºç°è¿‡çš„ï¼Œåœ¨æŸ¥è¯¢æ—¶ä¸€å®šè¦å‡ºç°ï¼Œåœ¨selectorå’Œåœ¨sortä¸­éƒ½æ— æ‰€è°“ï¼Œä½†sortä¸­çš„ä¸€å®šè¦å‡ºç°åœ¨indexä¸­</li></ol>]]></content>
      
      
      <categories>
          
          <category> fabric </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>web3j</title>
      <link href="/2019/10/14/web3j/"/>
      <url>/2019/10/14/web3j/</url>
      
        <content type="html"><![CDATA[<h2 id="web3jçš„ä½¿ç”¨"><a href="#web3jçš„ä½¿ç”¨" class="headerlink" title="web3jçš„ä½¿ç”¨"></a>web3jçš„ä½¿ç”¨</h2><h4 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h4><ul><li>é€šè¿‡Javaç±»å‹çš„JSON-RPCä¸Ethereumå®¢æˆ·ç«¯è¿›è¡Œäº¤äº’</li><li>æ”¯æŒæ‰€æœ‰çš„JSON-RPCæ–¹æ³•ç±»å‹</li><li>æ”¯æŒæ‰€æœ‰Gethå’ŒParityæ–¹æ³•ï¼Œç”¨äºç®¡ç†è´¦æˆ·å’Œç­¾ç½²äº¤æ˜“</li><li>åŒæ­¥æˆ–å¼‚æ­¥çš„å‘é€å®¢æˆ·ç«¯è¯·æ±‚</li><li>å¯ä»Solidity ABIæ–‡ä»¶è‡ªåŠ¨ç”ŸæˆJavaåªèƒ½åˆçº¦åŠŸèƒ½åŒ…</li></ul><p>é‡ç‚¹æ˜¯äº¤äº’çš„æ‰‹æ®µæ˜¯JSON-RPCï¼</p><p>web3jå¯ä»¥ç›‘å¬äº‹ä»¶ã€å‘é€äº¤æ˜“ç­‰ç­‰ï¼Œå‘é€äº¤æ˜“æ—¶ä¸Šé“¾åæ–¹æ‰è¿”å›ç»“æœã€‚å³å†…éƒ¨ä¹Ÿæœ‰ç›‘å¬äº‹ä»¶ã€‚ä¸€ç›´å¾ˆå¥½å¥‡ç›‘å¬äº‹ä»¶æ˜¯æ€ä¹ˆåšçš„ï¼Œå®æ—¶æ¨é€ï¼Ÿ</p><p>ç®€å•ç¿»äº†ä¸‹æºç ï¼Œå¹¶ä¸æ˜¯æ¨é€ï¼Œè€Œæ˜¯è½®è¯¢ã€‚</p><p>å› ä¸ºæ˜¯ä»æ™ºèƒ½åˆçº¦æ¥æ‰‹å…¥web3jï¼Œæ•…ä»åˆçº¦ç”Ÿæˆçš„javaç±»å…¥æ‰‹ï¼Œå‘ç°éœ€è¦ä¸Šé“¾çš„æ–¹æ³•è¿”å›çš„éƒ½æ˜¯TransactionReceiptç±»å‹ï¼Œä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public RemoteCall&lt;TransactionReceipt&gt; addUser(byte[] name, String addr, byte[] pk_pre, byte[] pk_bk) &#123;</span><br><span class="line">    final Function function = new Function(</span><br><span class="line">            FUNC_ADDUSER,</span><br><span class="line">            Arrays.&lt;Type&gt;asList(new org.web3j.abi.datatypes.generated.Bytes32(name),</span><br><span class="line">                    new org.web3j.abi.datatypes.Address(addr),</span><br><span class="line">                    new org.web3j.abi.datatypes.generated.Bytes32(pk_pre),</span><br><span class="line">                    new org.web3j.abi.datatypes.generated.Bytes32(pk_bk)),</span><br><span class="line">            Collections.&lt;TypeReference&lt;?&gt;&gt;emptyList());</span><br><span class="line">    return executeRemoteCallTransaction(function);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»executeRemoteCallTransactionå…¥æ‰‹ï¼Œè·Ÿè¸ªè¿›å»ã€‚çœ‹åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TransactionReceipt executeTransaction(String data, BigInteger weiValue, String funcName) throws TransactionException, IOException &#123;</span><br><span class="line">    TransactionReceipt receipt = this.send(this.contractAddress, data, weiValue, this.gasProvider.getGasPrice(funcName), this.gasProvider.getGasLimit(funcName));</span><br><span class="line">    if (!receipt.isStatusOK()) &#123;</span><br><span class="line">        throw new TransactionException(String.format(&quot;Transaction has failed with status: %s. Gas used: %d. (not-enough gas?)&quot;, receipt.getStatus(), receipt.getGasUsed()));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return receipt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸæ¥äº¤æ˜“å¤±è´¥ï¼Œæ€»æ˜¯æŠ›å‡ºnot-enough gaså¼‚å¸¸æ˜¯åœ¨è¿™é‡ŒæŠ›å‡ºçš„ï¼Œæ ¹æ®è¿”å›receiptçš„statusåˆ¤æ–­ã€‚</p><p>å†è·Ÿç€sendæ–¹æ³•è¿›å»ï¼Œç»ˆäºè¿›å…¥åˆ°transactionManagerï¼Œç¦»çœŸç›¸å¾ˆè¿‘äº†ã€‚</p><p>ç„¶åæ‰¾åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected TransactionReceipt executeTransaction(BigInteger gasPrice, BigInteger gasLimit, String to, String data, BigInteger value) throws IOException, TransactionException &#123;</span><br><span class="line">     EthSendTransaction ethSendTransaction = this.sendTransaction(gasPrice, gasLimit, to, data, value);</span><br><span class="line">     return this.processResponse(ethSendTransaction);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>processResponseè‚¯å®šå°±æ˜¯ç­‰å¾…è¿”å›ç»“æœçš„åœ°æ–¹äº†ã€‚ç„¶åå†…éƒ¨æ˜¯è°ƒç”¨this.transactionReceiptProcessor.waitForTransactionReceiptï¼Œå†è¿›å»å°±æ˜¯ä¸ªæŠ½è±¡ç±»äº†ã€‚æ‰¾äº†ä¸€ä¸‹ï¼Œåœ¨TransactionManagerä¸­ï¼Œå®ç°çš„å…·ä½“ç±»æ˜¯PollingTransactionReceiptProcessorã€‚æ‰€ä»¥..ç­”æ¡ˆå°±åœ¨è¿™é‡Œäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private TransactionReceipt getTransactionReceipt(String transactionHash, long sleepDuration, int attempts) throws IOException, TransactionException &#123;</span><br><span class="line">       Optional&lt;TransactionReceipt&gt; receiptOptional = this.sendTransactionReceiptRequest(transactionHash);</span><br><span class="line"></span><br><span class="line">       for(int i = 0; i &lt; attempts; ++i) &#123;</span><br><span class="line">           if (receiptOptional.isPresent()) &#123;</span><br><span class="line">               return (TransactionReceipt)receiptOptional.get();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           try &#123;</span><br><span class="line">               Thread.sleep(sleepDuration);</span><br><span class="line">           &#125; catch (InterruptedException var8) &#123;</span><br><span class="line">               throw new TransactionException(var8);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           receiptOptional = this.sendTransactionReceiptRequest(transactionHash);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       throw new TransactionException(&quot;Transaction receipt was not generated after &quot; + sleepDuration * (long)attempts / 1000L + &quot; seconds for transaction: &quot; + transactionHash);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯æ¯éš”sleepDurationå°±è½®è¯¢æŸ¥è¯¢ä¸€æ¬¡ã€‚sleepDurationçš„å€¼é»˜è®¤ä¸º15s, æŸ¥è¯¢æ¬¡æ•°é»˜è®¤æœ€å¤šä¸º40ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_state</title>
      <link href="/2019/10/14/eth-state/"/>
      <url>/2019/10/14/eth-state/</url>
      
        <content type="html"><![CDATA[<h4 id="state-trieçš„å­˜å‚¨æ¨¡å‹"><a href="#state-trieçš„å­˜å‚¨æ¨¡å‹" class="headerlink" title="state trieçš„å­˜å‚¨æ¨¡å‹"></a>state trieçš„å­˜å‚¨æ¨¡å‹</h4><p>state/Trieæ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Trie is a Ethereum Merkle Trie.</span><br><span class="line">type Trie interface &#123;</span><br><span class="line">TryGet(key []byte) ([]byte, error)</span><br><span class="line">TryUpdate(key, value []byte) error</span><br><span class="line">TryDelete(key []byte) error</span><br><span class="line">Commit(onleaf trie.LeafCallback) (common.Hash, error)</span><br><span class="line">Hash() common.Hash</span><br><span class="line">NodeIterator(startKey []byte) trie.NodeIterator</span><br><span class="line">GetKey([]byte) []byte // TODO(fjl): remove this when SecureTrie is removed</span><br><span class="line">Prove(key []byte, fromLevel uint, proofDb ethdb.Putter) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Trieæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•æœ‰Getã€Putç­‰æ“ä½œ/æŸ¥è¯¢æ•°æ®çš„æ–¹æ³•ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒTrieä½œä¸ºæ•°æ®ç»“æ„ï¼Œåœ¨è¿›è¡ŒæŒä¹…åŒ–æ—¶éœ€è¦è‡ªå®šä¹‰æŒä¹…åŒ–çš„æ•°æ®ç»“æ„ï¼ŒCommitæ–¹æ³•åˆ™ä¸ºè¿›è¡ŒæŒä¹…åŒ–æ—¶çš„æ“ä½œã€‚</p><p>Trieæ¥å£çš„å®ç°ä¸»è¦æ˜¯SecureTrieã€‚cachedTrieç»“æ„ä¸­åŒ…å«äº†åŒ¿åæˆå‘˜SecureTrieï¼Œæ‰€ä»¥cachedTrieä¹Ÿç®—Trieæ¥å£çš„å®ç°ã€‚SecureTrieä½äºtrieåŒ…ä¸‹ï¼Œå†…éƒ¨æ˜¯trie/Trieç»“æ„ä½“(éæ¥å£)çš„å°è£…ï¼Œtrie/Trieç»“æ„ä½“æ˜¯Trieæ•°æ®ç»“æ„çš„å…·ä½“å®ç°ã€‚</p><p>state/Databaseæ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Database wraps access to tries and contract code.</span><br><span class="line">type Database interface &#123;</span><br><span class="line">// OpenTrie opens the main account trie.</span><br><span class="line">OpenTrie(root common.Hash) (Trie, error)</span><br><span class="line"></span><br><span class="line">// OpenStorageTrie opens the storage trie of an account.</span><br><span class="line">OpenStorageTrie(addrHash, root common.Hash) (Trie, error)</span><br><span class="line"></span><br><span class="line">// CopyTrie returns an independent copy of the given trie.</span><br><span class="line">CopyTrie(Trie) Trie</span><br><span class="line"></span><br><span class="line">// ContractCode retrieves a particular contract&apos;s code.</span><br><span class="line">ContractCode(addrHash, codeHash common.Hash) ([]byte, error)</span><br><span class="line"></span><br><span class="line">// ContractCodeSize retrieves a particular contracts code&apos;s size.</span><br><span class="line">ContractCodeSize(addrHash, codeHash common.Hash) (int, error)</span><br><span class="line"></span><br><span class="line">// TrieDB retrieves the low level trie database used for data storage.</span><br><span class="line">TrieDB() *trie.Database</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>state/Databaseæ¥å£ï¼Œæä¾›äº†ä»æ•°æ®åº“è¯»å‡ºæ•°æ®ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¸»è¦æ˜¯è¯»å‡ºæ•°æ®å¹¶ç»„æˆTrieæ ‘æ•°æ®ç»“æ„ã€‚åŒæ—¶è¿˜æä¾›äº†è·å–dbçš„æ¥å£ä»¥ä¾›ç›´æ¥æ“ä½œdbã€‚</p><p>trie.Databaseæ˜¯åº•å±‚æ•°æ®åº“çš„ç›´æ¥å°è£…å®ç°ï¼Œå¢åˆ æ”¹æŸ¥ä¸€ç³»åˆ—æ–¹æ³•ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯leveldbï¼Œleveldbé‡‡ç”¨key-valueçš„å½¢å¼ï¼Œç›¸å…³çŸ¥è¯†æš‚æ—¶ä¸å±•å¼€äº†ã€‚</p><p>trieåŒ…ä¸‹çš„Trieæ˜¯æ ‘çš„å…·ä½“å®ç°ï¼ŒDatabaseæ˜¯æ•°æ®åº“çš„å…·ä½“å®ç°ã€‚</p><p>stateåŒ…ä¸‹çš„Trieæ¥å£æ˜¯æ¥å£(= =)..  Databaseä¸»è¦æ˜¯å›´ç»•stateè¿›è¡Œçš„è¯»å–æ¥å£ã€‚å…¶å…·ä½“å®ç°ä¹Ÿæ˜¯å¯¹trie/Trieå’Œtrie/Databaseçš„å°è£…ã€‚cachingDBå¦å¤–æœ‰ä¸€å±‚ç¼“å­˜å®ç°ã€‚</p><h4 id="ç»„ç»‡æ¨¡å‹"><a href="#ç»„ç»‡æ¨¡å‹" class="headerlink" title="ç»„ç»‡æ¨¡å‹"></a>ç»„ç»‡æ¨¡å‹</h4><p>statedbæ˜¯key-valueç»“æ„ï¼Œvalueç±»å‹ä¸ºstateObjectï¼Œæœ€åæŒä¹…åŒ–åˆ°æ•°æ®åº“çš„åªæœ‰stateObjectä¸­çš„dataï¼Œstatedbå°è£…äº†Databaseå’ŒTrieï¼Œå¯ç›´æ¥è¿›è¡Œæ•°æ®æ“ä½œã€‚ä»æ•°æ®åº“çš„key-valueæ¥çœ‹ï¼Œå­˜å‚¨çš„valueä¸ºstateObjectä¸­çš„data(Accountç±»å‹)ï¼Œç»„ç»‡trieæ ‘çš„keyä¸ºaddrï¼Œä»æ•°æ®æ“ä½œä¸Šæ¥çœ‹ï¼Œstateå¯ç›´æ¥è¿›è¡Œè´¦æˆ·çš„æ“ä½œ(setBalanceã€getBalanceç­‰ç­‰)ï¼Œå…¶å®æ“ä½œçš„éƒ½æ˜¯å¯¹åº”stateObjectä¸­çš„dataï¼Œæœ€åCommitçš„æ—¶å€™æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚ä¸­é—´è¿˜æ¶‰åŠåˆ«çš„å¾ˆå¤šä¸œè¥¿ï¼Œä¾‹å¦‚ç¼“å­˜ã€å¿«ç…§ç­‰ï¼Œä»¥ä¾›äº‹åŠ¡å¤„ç†ã€‚</p><p>statedbå†…éƒ¨å°è£…çš„æ“ä½œæ˜¯å¯ä»¥ç›´æ¥å­˜å‚¨æ•°æ®åº“çš„ï¼ŒstateObjectä¸­dataç±»å‹ä¸ºaccountï¼Œå†…éƒ¨ç›´æ¥å°è£…äº†valueçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚å¦‚æœæƒ³å­˜å‚¨éaccountç±»å‹çš„æ•°æ®å‘¢ï¼Œstatedbä¹Ÿæä¾›äº†ç›¸å…³æ–¹æ³•<code>SetState</code>å’Œ<code>GetState</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var (</span><br><span class="line">stateAddr = common.BytesToAddress([]byte&#123;1, 1, 1, 1, 2&#125;)</span><br><span class="line">key  = common.BytesToHash([]byte(&quot;names_service&quot;))</span><br><span class="line">)</span><br><span class="line">func TestSingleTrie(t *testing.T) &#123;</span><br><span class="line">db := ethdb.NewMemDatabase()</span><br><span class="line">state, _ := state.New(common.Hash&#123;&#125;, state.NewDatabase(db))</span><br><span class="line">state.SetState(stateAddr, key, common.BytesToHash([]byte&#123;0, 0, 0&#125;))</span><br><span class="line">state.IntermediateRoot(false)</span><br><span class="line">hash := state.GetState(stateAddr, key)</span><br><span class="line">if hash != common.BytesToHash([]byte&#123;0, 0, 0&#125;) &#123;</span><br><span class="line">t.Error(&quot;unexpected err&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>setStateçš„valueçš„ç±»å‹ä¸ºhashã€‚ä¹Ÿå°±æ˜¯è¯´setStateåªèƒ½å­˜å‚¨ä¸€ä¸ªå“ˆå¸Œå€¼ã€‚å¦‚æœæƒ³å­˜å‚¨åˆ«çš„ä¸œè¥¿ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨trie/databaseç›¸å…³æ¥å£è¿›è¡Œå­˜å‚¨ï¼Œç„¶åå°†å­˜å‚¨çš„keyä½œä¸ºsetStateçš„valueï¼ŒæŸ¥è¯¢æ—¶å…ˆgetStateè·å–keyï¼Œç„¶åå†æŸ¥è¯¢valueï¼Œè¿™æ ·å°±å¯ä»¥è¿›è¡Œç´¢å¼•åˆ°å­˜å‚¨çš„valueäº†ã€‚å¦‚æ™ºèƒ½åˆçº¦ä»£ç çš„å­˜å‚¨ï¼ŒstateObject.dataä¸­åªå­˜å‚¨äº†åˆçº¦ä»£ç çš„hashï¼Œåˆçº¦ä»£ç å­˜æ”¾åœ¨å¦å¤–çš„åœ°æ–¹ã€‚</p><p>trie/Databaseä¸‹æä¾›çš„ç›´æ¥å­˜å‚¨/æŸ¥è¯¢æ¥å£ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢</span><br><span class="line">func (db *Database) Node(hash common.Hash) ([]byte, error)</span><br><span class="line">//å­˜å‚¨</span><br><span class="line">func (db *Database) InsertBlob(hash common.Hash, blob []byte)</span><br></pre></td></tr></table></figure><p>æ™ºèƒ½åˆçº¦ä»£ç çš„å­˜å‚¨/è¯»å–å°±é‡‡ç”¨äº†ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// ContractCode retrieves a particular contract&apos;s code.</span><br><span class="line">func (db *cachingDB) ContractCode(addrHash, codeHash common.Hash) ([]byte, error) &#123;</span><br><span class="line">code, err := db.db.Node(codeHash)</span><br><span class="line">if err == nil &#123;</span><br><span class="line">db.codeSizeCache.Add(codeHash, len(code))</span><br><span class="line">&#125;</span><br><span class="line">return code, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (s *StateDB) Commit(deleteEmptyObjects bool) (root common.Hash, err error) &#123;</span><br><span class="line">  ...</span><br><span class="line">     // Write any contract code associated with the state object</span><br><span class="line">     if stateObject.code != nil &amp;&amp; stateObject.dirtyCode &#123;</span><br><span class="line">  s.db.TrieDB().InsertBlob(common.BytesToHash(stateObject.CodeHash()), stateObject.code)</span><br><span class="line">  stateObject.dirtyCode = false</span><br><span class="line">  &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹ä¸ºå­˜å‚¨é¢å¤–çš„Trie</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">func TestSingleTrie(t *testing.T) &#123;</span><br><span class="line">db := ethdb.NewMemDatabase()</span><br><span class="line">state, _ := state.New(common.Hash&#123;&#125;, state.NewDatabase(db))</span><br><span class="line">state.SetState(stateAddr, key, common.BytesToHash([]byte&#123;0, 0, 0&#125;))</span><br><span class="line">state.IntermediateRoot(false)</span><br><span class="line">hash := state.GetState(stateAddr, key)</span><br><span class="line">if hash != common.BytesToHash([]byte&#123;0, 0, 0&#125;) &#123;</span><br><span class="line">t.Error(&quot;unexpected err&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">err = trie.TryUpdate([]byte(&quot;anny&quot;), []byte(&quot;0xccccc&quot;))</span><br><span class="line">if err != nil &#123;</span><br><span class="line">t.Error(&quot;update err, &quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">t.Log(trie.Hash())</span><br><span class="line">trie.Commit(nil)</span><br><span class="line">t.Log(trie.Hash())</span><br><span class="line">err = trie.TryUpdate([]byte(&quot;anny&quot;), []byte(&quot;0xccccb&quot;))</span><br><span class="line">if err != nil &#123;</span><br><span class="line">t.Error(&quot;update err, &quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">err = trie.TryUpdate([]byte(&quot;jim&quot;), []byte(&quot;0xbbbbbc&quot;))</span><br><span class="line">if err != nil &#123;</span><br><span class="line">t.Error(&quot;update err, &quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">trie.Commit(nil)</span><br><span class="line">t.Log(trie.Hash())</span><br><span class="line">state.SetState(stateAddr, key, trie.Hash())</span><br><span class="line">hash = state.GetState(stateAddr, key)</span><br><span class="line">if hash != trie.Hash() &#123;</span><br><span class="line">t.Error(&quot;unexpected err&quot;)</span><br><span class="line">&#125;</span><br><span class="line">trie1, err := state.Database().OpenStorageTrie(common.Hash&#123;&#125;, hash)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">t.Error(&quot;unexpected err&quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">value, err := trie1.TryGet([]byte(&quot;anny&quot;))</span><br><span class="line">if err != nil &#123;</span><br><span class="line">t.Error(&quot;unexpected err&quot;, err)</span><br><span class="line">&#125;</span><br><span class="line">if string(value) != &quot;0xccccb&quot; &#123;</span><br><span class="line">t.Error(&quot;unexpected err&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_p2p_udp</title>
      <link href="/2019/10/14/eth-p2p-udp/"/>
      <url>/2019/10/14/eth-p2p-udp/</url>
      
        <content type="html"><![CDATA[<h2 id="p2p-udp"><a href="#p2p-udp" class="headerlink" title="p2p-udp"></a>p2p-udp</h2><p>åœ¨ä»¥å¤ªåŠçš„p2påŒ…ä¸‹ï¼ŒdiscoveråŒ…ä¸‹çš„udpä¸»è¦è´Ÿè´£èŠ‚ç‚¹å‘ç°ã€‚ä»¥å¤ªåŠçš„èŠ‚ç‚¹å‘ç°åˆæ˜¯åŸºäºkademliaåè®®ã€‚</p><h4 id="kademlia"><a href="#kademlia" class="headerlink" title="kademlia"></a>kademlia</h4><p><a href="http://www.yeolar.com/note/2010/03/21/kademlia/" target="_blank" rel="noopener">kadè¯¦ç»†è§£è¯»</a></p><p>ç®€å•è¯´æ¥ï¼Œkadä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±ç‰¹å®šIDä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ã€‚å¹¶ä¸”ç”±IDå†³å®šKæ¡¶å’Œä¸¤èŠ‚ç‚¹ä¹‹é—´çš„é€»è¾‘è·ç¦»ã€‚</p><p>IDç”±äºŒè¿›åˆ¶è¡¨ç¤ºï¼ŒIDé•¿åº¦æœ‰å‡ ä½ï¼ŒKæ¡¶æ•°é‡å°±ä¸ºå‡ ã€‚Kæ¡¶çš„åˆ’åˆ†æ»¡è¶³ï¼Œç¬¬nä¸ªKæ¡¶çš„èŠ‚ç‚¹å‰n-1ä½ä¸è‡ªå·±IDçš„å‰n-1ä½æ˜¯ç›¸åŒçš„ã€‚å¦‚IDé•¿åº¦ä¸º3ï¼Œé‚£ä¹ˆKæ¡¶æ•°é‡ä¸º3ï¼Œè‡ªå·±çš„IDä¸º110ï¼Œé‚£ä¹ˆè‡ªå·±çš„Kæ¡¶åˆ’åˆ†ä¸ºå‰0ä½ç›¸åŒ(0xxï¼‰ã€å‰1ä½ç›¸åŒ(10x),å‰2ä½ç›¸åŒ(11x)è¿™æ ·çš„ä¸‰ä¸ªKæ¡¶ã€‚æ˜¾ç„¶ï¼Œåœ¨è¿™æ ·çš„åˆ†å¸ƒä¸­ï¼Œæ»¡è¶³0xxçš„èŠ‚ç‚¹å°±ä¼šæœ‰å¾ˆå¤šï¼Œä½†æ»¡è¶³11xçš„èŠ‚ç‚¹åªæœ‰111ã€‚ç„¶åä¸¤ä¸ªèŠ‚ç‚¹ä¹‹å‰çš„é€»è¾‘è·ç¦»ä¸ºIDçš„å¼‚æˆ–å€¼ï¼Œè¶Šç›¸è¿‘çš„èŠ‚ç‚¹ï¼Œå¼‚æˆ–å€¼è¶Šå°ï¼Œè¶Šè¿œçš„èŠ‚ç‚¹ï¼Œå¼‚æˆ–å€¼è¶Šå¤§ã€‚</p><p>å¦å¤–ï¼ŒKademlia åè®®åŒ…æ‹¬å››ç§è¿œç¨‹ RPC æ“ä½œï¼šPINGã€STOREã€FIND_NODEã€FIND_VALUEã€‚è¿™äº›åœ¨ä¸Šé¢çš„é“¾æ¥ä¸­éƒ½æœ‰ä¹Ÿæ›´è¯¦ç»†ã€‚å°¤å…¶æ˜¯æ•°æ®å­˜æ”¾éœ€è¦çš„åŸºæœ¬æ­¥éª¤ï¼Œéƒ½æœ‰ç›¸åº”æåˆ°ã€‚</p><h4 id="ä»¥å¤ªåŠçš„kad"><a href="#ä»¥å¤ªåŠçš„kad" class="headerlink" title="ä»¥å¤ªåŠçš„kad"></a>ä»¥å¤ªåŠçš„kad</h4><p>ä»¥å¤ªåŠçš„kadä¸ä¸Šé¢æ ‡å‡†çš„kadç•¥æœ‰ä¸åŒã€‚</p><p>å…ˆæ’¸ä»£ç å§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bucketSize      = 16 // Kademlia bucket size</span><br><span class="line">// We keep buckets for the upper 1/15 of distances because</span><br><span class="line">// it&apos;s very unlikely we&apos;ll ever encounter a node that&apos;s closer.</span><br><span class="line">hashBits          = len(common.Hash&#123;&#125;) * 8</span><br><span class="line">nBuckets          = hashBits / 15       // Number of buckets</span><br><span class="line">bucketMinDistance = hashBits - nBuckets // Log distance of closest bucket</span><br></pre></td></tr></table></figure><p>kæ¡¶æ•°é‡nBucketsï¼Œï¼ˆå®šä¸ºIDé•¿åº¦256(hashé•¿åº¦32byte * 8bit/byte)ï¼‰/ 15ã€‚</p><p>kæ¡¶å¤§å°bucketSizeï¼Œå³æ¯ä¸ªkæ¡¶ä¸­çš„èŠ‚ç‚¹æœ€å¤§æ•°é‡ã€‚</p><p>èŠ‚ç‚¹IDçš„è®¡ç®—æ–¹å¼(ç”±å…¬é’¥ç”Ÿæˆ)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//encPubkeyå–hash</span><br><span class="line">func (e encPubkey) id() enode.ID &#123;</span><br><span class="line">return enode.ID(crypto.Keccak256Hash(e[:]))</span><br><span class="line">&#125;</span><br><span class="line">//pubkey -&gt; encpubkey</span><br><span class="line">func encodePubkey(key *ecdsa.PublicKey) encPubkey &#123;</span><br><span class="line">var e encPubkey</span><br><span class="line">math.ReadBits(key.X, e[:len(e)/2])</span><br><span class="line">math.ReadBits(key.Y, e[len(e)/2:])</span><br><span class="line">return e</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¡¶çš„åŸºæœ¬ç»“æ„</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type Table struct &#123;</span><br><span class="line">mutex   sync.Mutex        // protects buckets, bucket content, nursery, rand</span><br><span class="line">buckets [nBuckets]*bucket // index of known nodes by distance</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// bucket contains nodes, ordered by their last activity. the entry</span><br><span class="line">// that was most recently active is the first element in entries.</span><br><span class="line">type bucket struct &#123;</span><br><span class="line">   entries      []*node // live entries, sorted by time of last contact</span><br><span class="line">   replacements []*node // recently seen nodes to be used if revalidation fails</span><br><span class="line">   ips          netutil.DistinctNetSet</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bucketsæ˜¯æ‰€æœ‰æ¡¶ï¼Œæ˜¯ä¸€ä¸ªå®šé•¿æ•°ç»„ï¼Œå…¶ä¸­ï¼Œ(0&lt;index&lt;nBuckets)çš„indexä»£è¡¨indexæ¡¶ã€‚ç„¶åèŠ‚ç‚¹çš„idç»è¿‡è®¡ç®—æ˜ å°„åˆ°æŸä¸ªæ¡¶ã€‚æ¡¶é‡Œçš„èŠ‚ç‚¹ä»¬åˆæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œentriesæ•°ç»„ä¸­ä¸ºä¼˜å…ˆå¯ç”¨çš„èŠ‚ç‚¹ï¼Œä»–ä»¬æŒ‰ä¸Šä¸€æ¬¡è”ç³»çš„æ—¶é—´æ’åºï¼Œæœ€æœ€è¿‘è”ç³»çš„èŠ‚ç‚¹æ’åœ¨æ•°ç»„çš„æœ€å‰é¢ã€‚å¦‚æœentriesä¸­æŸèŠ‚ç‚¹åœ¨revalidationæ—¶å¤±è´¥äº†ï¼Œä¼šä»replacementsä¸­æ‰¾å‡ºæŸä¸ªæ¥ä»£æ›¿..</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//å¢ã€‚å¦‚æœå¯¹åº”çš„æ¡¶b, b.entriesçš„é•¿åº¦æ²¡è¶…è¿‡æœ€å¤§æ•°é‡çš„è¯ï¼Œå°±å¢åŠ åˆ°entriesä¸­ï¼Œå¦åˆ™å¢åŠ åˆ°replacementsä¸­</span><br><span class="line">func (tab *Table) add(n *node) &#123;</span><br><span class="line">   if n.ID() == tab.self.ID() &#123;</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   tab.mutex.Lock()</span><br><span class="line">   defer tab.mutex.Unlock()</span><br><span class="line">   b := tab.bucket(n.ID())</span><br><span class="line">   if !tab.bumpOrAdd(b, n) &#123;</span><br><span class="line">      // Node is not in table. Add it to the replacement list.</span><br><span class="line">      tab.addReplacement(b, n)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//åˆ ï¼Œæ‰¾åˆ°nodeå¯¹åº”çš„æ¡¶ï¼Œç„¶åä»æ¡¶ä¸­æŠŠèŠ‚ç‚¹åˆ é™¤äº†</span><br><span class="line">func (tab *Table) delete(node *node) &#123;</span><br><span class="line">tab.mutex.Lock()</span><br><span class="line">defer tab.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">tab.deleteInBucket(tab.bucket(node.ID()), node)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//æŸ¥ï¼ŒæŸ¥å‘¢æ˜¯è¿”å›æ‰€æœ‰æ¡¶ä¸­è·ç¦»targetæœ€è¿‘çš„nresultsä¸ªèŠ‚ç‚¹</span><br><span class="line">func (tab *Table) closest(target enode.ID, nresults int) *nodesByDistance &#123;</span><br><span class="line">// This is a very wasteful way to find the closest nodes but</span><br><span class="line">// obviously correct. I believe that tree-based buckets would make</span><br><span class="line">// this easier to implement efficiently.</span><br><span class="line">close := &amp;nodesByDistance&#123;target: target&#125;</span><br><span class="line">for _, b := range &amp;tab.buckets &#123;</span><br><span class="line">for _, n := range b.entries &#123;</span><br><span class="line">close.push(n, nresults)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return close</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸»çº¿é€»è¾‘æ“ä½œ</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">func (tab *Table) loop() &#123;</span><br><span class="line">  ...</span><br><span class="line">  loop:</span><br><span class="line">for &#123;</span><br><span class="line">select &#123;</span><br><span class="line">case &lt;-refresh.C:  //å®šæ—¶åˆ·æ–°ï¼Œ</span><br><span class="line">tab.seedRand() //æ›´æ–°éšæœºç§å­</span><br><span class="line">if refreshDone == nil &#123;</span><br><span class="line">refreshDone = make(chan struct&#123;&#125;)</span><br><span class="line">go tab.doRefresh(refreshDone)  //è¿›è¡Œåˆ·æ–°ï¼Œåˆ·æ–°å®Œæˆå¾€refreshDoneé€šé“ä¸­é€šçŸ¥</span><br><span class="line">&#125;</span><br><span class="line">case req := &lt;-tab.refreshReq: //ä¸Šå±‚è¯·æ±‚åˆ·æ–°ï¼Œä¸Šå±‚æœ‰å¯èƒ½éœ€è¦çŸ¥é“åˆ·æ–°å®Œæˆæ—¶é—´ï¼Œæ•…reqé€šé“ç”¨äºé€šçŸ¥åˆ·æ–°å®Œæˆ</span><br><span class="line">waiting = append(waiting, req)  //è®°å½•ä¸‹æ‰€æœ‰çš„åˆ·æ–°è¯·æ±‚é€šé“</span><br><span class="line">if refreshDone == nil &#123;</span><br><span class="line">refreshDone = make(chan struct&#123;&#125;)</span><br><span class="line">go tab.doRefresh(refreshDone)</span><br><span class="line">&#125;</span><br><span class="line">case &lt;-refreshDone:  //åˆ·æ–°å®Œæˆåï¼Œå…³é—­æ‰€æœ‰è¯·æ±‚é€šé“ï¼Œé€šçŸ¥ä¸Šå±‚å·²åˆ·æ–°å®Œæˆ</span><br><span class="line">for _, ch := range waiting &#123;</span><br><span class="line">close(ch)</span><br><span class="line">&#125;</span><br><span class="line">waiting, refreshDone = nil, nil //æ¸…ç©ºwaitingæ•°ç»„ï¼Œå’ŒrefreshDoneé€šé“</span><br><span class="line">case &lt;-revalidate.C:</span><br><span class="line">go tab.doRevalidate(revalidateDone)</span><br><span class="line">case &lt;-revalidateDone:</span><br><span class="line">revalidate.Reset(tab.nextRevalidateTime())</span><br><span class="line">case &lt;-copyNodes.C:</span><br><span class="line">go tab.copyLiveNodes()</span><br><span class="line">case &lt;-tab.closeReq:</span><br><span class="line">break loop</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//åˆ·æ–°æ–¹æ³•</span><br><span class="line">func (tab *Table) doRefresh(done chan struct&#123;&#125;) &#123;</span><br><span class="line">  defer close(done)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  //é€šè¿‡è‡ªå·±ä¸ºtargetå»æ‰¾neighborï¼Œå‰ææ˜¯éœ€è¦è‡ªå·±æœ‰secp256k1å­—æ®µï¼Œv4ç‰ˆæœ¬çš„nodeé‡Œæ˜¯å«æœ‰secp256k1çš„ï¼Œå³v4ç‰ˆæœ¬æ˜¯æ»¡è¶³è¿™ä¸ªifæ¡ä»¶ã€‚loadåkeyä¸­çš„å€¼ä¸ºnodeçš„å…¬é’¥</span><br><span class="line">  var key ecdsa.PublicKey</span><br><span class="line">  if err := tab.self.Load((*enode.Secp256k1)(&amp;key)); err == nil &#123;</span><br><span class="line">tab.lookup(encodePubkey(&amp;key), false)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  //â­ï¸é€šè¿‡éšæœºtargetå»æ‰¾neighborã€‚è¿™é‡Œçš„ç–‘é—®æ˜¯æ³¨é‡Šä¸­æåˆ°ä¸ºä»€ä¹ˆä¸ä½¿ç”¨kadæœ¬æ¥åˆ·æ–°çš„æ–¹å¼æ˜¯å› ä¸ºfindnode tagetæ˜¯512bit,è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯512bit? (æ˜¯å› ä¸ºfindnode targetæ˜¯å…¬é’¥ï¼Œå…¬é’¥é•¿åº¦æ˜¯64byte/512bit) ååŠå¥è¯´ä¸å®¹æ˜“ç”Ÿæˆä¸€ä¸ªå±äºæ‰€é€‰æ¡¶çš„sha3å‰é•œåƒï¼Œkadæœ¬æ¥åˆ·æ–°çš„æ–¹å¼æ˜¯é€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ¡¶ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ„æ€æ˜¯çŸ¥é“æ¡¶äº†ï¼Œä½†æ˜¯nodeçš„IDæ˜¯ç»è¿‡hashç”Ÿæˆçš„ï¼Œhashçš„èŒƒå›´ç¡®å®šï¼Œä½†å€’å›å»æ‰¾IDå°±å¾ˆå¤æ‚çš„æ„æ€å—</span><br><span class="line">// The Kademlia paper specifies that the bucket refresh should</span><br><span class="line">// perform a lookup in the least recently used bucket. We cannot</span><br><span class="line">// adhere to this because the findnode target is a 512bit value</span><br><span class="line">// (not hash-sized) and it is not easily possible to generate a</span><br><span class="line">// sha3 preimage that falls into a chosen bucket.</span><br><span class="line">// We perform a few lookups with a random target instead.</span><br><span class="line">  for i := 0; i &lt; 3; i++ &#123;</span><br><span class="line"> var target encPubkey</span><br><span class="line"> crand.Read(target[:])</span><br><span class="line"> tab.lookup(target, false)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">//ä¸‹é¢çœ‹ä¸€ä¸‹å…³é”®æ–¹æ³•lookup</span><br><span class="line">func (tab *Table) lookup(targetKey encPubkey, refreshIfEmpty bool) []*node &#123;</span><br><span class="line">var (</span><br><span class="line">target         = enode.ID(crypto.Keccak256Hash(targetKey[:]))  //targetidï¼šç”±å…¬é’¥è¿›è¡Œhashå¾—æ¥</span><br><span class="line">asked          = make(map[enode.ID]bool)  //ä¿å­˜è¯¢é—®è¿‡çš„èŠ‚ç‚¹ï¼Œä»¥å…é‡å¤è¯¢é—®</span><br><span class="line">seen           = make(map[enode.ID]bool)  //ä¿å­˜å›å¤è¿‡çš„èŠ‚ç‚¹ï¼Œé˜²æ­¢è¯¢é—®çš„èŠ‚ç‚¹å¤šæ¬¡å›å¤</span><br><span class="line">reply          = make(chan []*node, alpha) //èŠ‚ç‚¹å›å¤çš„é€šé“ï¼Œalphaä¸ºå¹¶å‘é‡ï¼Œæ¯æ¬¡ä¸‰ä¸ª</span><br><span class="line">pendingQueries = 0   //å¾…å®šçš„æŸ¥è¯¢æ•°é‡ï¼Œå³è¯¢é—®äº† ä½†æ²¡å›å¤çš„æ•°é‡</span><br><span class="line">result         *nodesByDistance  //æŸ¥è¯¢ç»“æœ</span><br><span class="line">)</span><br><span class="line">//å°†è‡ªå·±åˆ—ä¸ºè¯¢é—®è¿‡çš„èŠ‚ç‚¹</span><br><span class="line">asked[tab.self.ID()] = true</span><br><span class="line"></span><br><span class="line">    //å°†ç°æœ‰çš„kæ¡¶èŠ‚ç‚¹ä»¬å¡«å……åˆ°resultä¸­</span><br><span class="line">for &#123;</span><br><span class="line">tab.mutex.Lock()</span><br><span class="line">//ä»è‡ªå·±çš„æ‰€æœ‰æ¡¶ä¸­æ‰¾å‡ºç¦»targetæœ€è¿‘çš„bucketSizeä¸ªèŠ‚ç‚¹</span><br><span class="line">result = tab.closest(target, bucketSize)</span><br><span class="line">tab.mutex.Unlock()</span><br><span class="line">//å¦‚æœæ¡¶ä¸­æœ‰èŠ‚ç‚¹æˆ–è€…refreshIfEmptyä¸ºfalseï¼Œè·³å‡ºå¾ªç¯</span><br><span class="line">if len(result.entries) &gt; 0 || !refreshIfEmpty &#123;</span><br><span class="line">break</span><br><span class="line">&#125;</span><br><span class="line">//å¦‚æœkæ¡¶ä¸­æ— èŠ‚ç‚¹ï¼Œåˆ™è¯·æ±‚åˆ·æ–°(doRefresh -&gt; ä»ç§å­èŠ‚ç‚¹ä¸­å‡ºå‘..)</span><br><span class="line">&lt;-tab.refresh()</span><br><span class="line">//è¯·æ±‚ä¸€æ¬¡åˆ·æ–°ï¼Œå°†refreshIfEmptyç½®ä¸ºfalse,é˜²æ­¢ä¸€ç›´æ— èŠ‚ç‚¹ï¼Œä¸€ç›´åœ¨è¿™é‡Œå¾ªç¯ï¼Œç›¸å½“äºè¿™ä¸ªforå¾ªç¯æœ€å¤šåªæ‰§è¡Œä¸¤æ¬¡</span><br><span class="line">refreshIfEmpty = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for &#123;</span><br><span class="line">//å‘è¿‘çš„èŠ‚ç‚¹è¯¢é—®èŠ‚ç‚¹ï¼Œè¯¢é—®è¿‡çš„å°±ä¸å†è¯¢é—®ï¼Œå¹¶ä¸”æ¯æ¬¡è¯¢é—®çš„èŠ‚ç‚¹æ•°&lt;alpha,å³æ¯æ¬¡åªè¯¢é—®æœ€è¿‘çš„alphaä¸ªèŠ‚ç‚¹ã€‚ä¹‹å‰ä¸€ç›´å¡åœ¨ä¸ºä»€ä¹ˆå¤–å±‚è¦forå¾ªç¯ï¼Œéš¾é“ä¸æ˜¯æ¯æ¬¡é—®çš„éƒ½æ˜¯ç›¸åŒçš„å—ï¼Ÿè¿˜çœŸçš„ä¸æ˜¯..è¦æ˜¯ç›¸åŒçš„è¯ï¼ŒpendingQueriesçš„å€¼å°±ä¸ä¼š++ï¼Œè¿™ä¸ªè¯¢é—®forå¾ªç¯å°±ä¸ä¼šå†è¿›è¡Œäº†ï¼Œç„¶åç­‰å›ç­”å®Œæ¯•è¿™ä¸ªæ–¹æ³•å°±å®Œæ¯•äº†ã€‚ä¹‹æ‰€ä»¥æ¡¶é‡Œçš„å‰alphaä¸ªä¼šä¸ä¸€æ ·ï¼Œæ˜¯å› ä¸ºåœ¨åé¢ä»replyä¸­è¯»å‡ºçš„ä¸ºé—®åˆ°çš„èŠ‚ç‚¹ä»¬ï¼Œç„¶åæ·»åŠ åˆ°æœ¬æ¡¶é‡Œçš„æ—¶å€™ä¼šå½±å“æ•´ä¸ªæ’åºï¼Œresultä¸­çš„åº”è¯¥æ˜¯æœ€è¿‘çš„å°±åœ¨å‰é¢ã€‚æ‰€ä»¥è¿™ä¸ªå°±æ˜¯ä¸æ–­é—®åˆ°æ–°çš„èŠ‚ç‚¹åï¼Œä¸æ–­æŸ¥è¯¢åˆ°ç¦»è‡ªå·±æ¯”è¾ƒè¿‘çš„èŠ‚ç‚¹ã€‚åˆ°æ²¡æœ‰æœ€è¿‘çš„èŠ‚ç‚¹åï¼Œå°±ä¸å†è¯¢é—®ã€‚</span><br><span class="line">for i := 0; i &lt; len(result.entries) &amp;&amp; pendingQueries &lt; alpha; i++ &#123;</span><br><span class="line">n := result.entries[i]</span><br><span class="line">if !asked[n.ID()] &#123;</span><br><span class="line">asked[n.ID()] = true</span><br><span class="line">pendingQueries++</span><br><span class="line">//å‘èŠ‚ç‚¹nè¯¢é—®targetKeyçš„èŠ‚ç‚¹ä»¬</span><br><span class="line">go tab.findnode(n, targetKey, reply)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">//æ‰€æœ‰äººéƒ½å›å¤äº†ï¼Œå°±ä¸å†è¯¢é—®äº†</span><br><span class="line">if pendingQueries == 0 &#123;</span><br><span class="line">// we have asked all closest nodes, stop the search</span><br><span class="line">break</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//&lt;-replyæ˜¯æœ€è¿·æƒ‘çš„ï¼Œè¿™ä¸ªæ˜¯æ¯æ¬¡ä»replyä¸­è¯»å‡ºä¸€ä¸ªå›å¤ï¼Œä¸€ä¸ªå›å¤ä¸ºä¸€ä¸ªèŠ‚ç‚¹å›å¤çš„ä»–çš„æ¡¶èŠ‚ç‚¹ä»¬ï¼Œç„¶årangeå®ƒçš„æ¡¶èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°æœ¬æ¡¶ä¸­</span><br><span class="line">// wait for the next reply</span><br><span class="line">for _, n := range &lt;-reply &#123;</span><br><span class="line">if n != nil &amp;&amp; !seen[n.ID()] &#123;</span><br><span class="line">seen[n.ID()] = true</span><br><span class="line">//result.pushæ–¹æ³•ï¼Œresultä¸­æ•°ç»„çš„é•¿åº¦ä¸ºbucketSizeï¼Œä¸”æŒ‰ç¦»targetçš„è·ç¦»æ’åºï¼Œæœ‰ç‚¹åƒè·ç¦»æœ€â€œè¿‘â€å †æ’åº..</span><br><span class="line">result.push(n, bucketSize)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">//æœ‰è¿‡ä¸€æ¬¡å›å¤ï¼ŒpendingQueriesé€’å‡</span><br><span class="line">pendingQueries--</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return result.entries</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//findnodeæ–¹æ³•</span><br><span class="line">func (tab *Table) findnode(n *node, targetKey encPubkey, reply chan&lt;- []*node) &#123;</span><br><span class="line">//ä»dbä¸­è¯»å‡ºå‘nèŠ‚ç‚¹æŸ¥è¯¢å‡ºé”™çš„æ¬¡æ•°(è¿™ä¸ªå‡ºé”™æ¬¡æ•°åº”è¯¥ä¼šå½±å“nèŠ‚ç‚¹çš„åèª‰å§)</span><br><span class="line">fails := tab.db.FindFails(n.ID())</span><br><span class="line">//è°ƒç”¨ä¸Šå±‚é€šä¿¡å‘nèŠ‚ç‚¹å‘å‡ºæŸ¥è¯¢æ¶ˆæ¯</span><br><span class="line">r, err := tab.net.findnode(n.ID(), n.addr(), targetKey)</span><br><span class="line"></span><br><span class="line">//è¿™é‡Œçœ‹ç€æ˜¯ç›´æ¥å°±è¿”å›äº†æ¶ˆæ¯å’Œé”™è¯¯..çœ‹æ ·å­tab.net.findnodeæ˜¯åŒæ­¥çš„..</span><br><span class="line">//å¦‚æœè¿”å›é”™è¯¯æˆ–è€…èŠ‚ç‚¹æ•°é‡ä¸º0ï¼Œéƒ½è§†ä¸ºå¤±è´¥ï¼Œå‡ºé”™æ¬¡æ•°fails++å¹¶æ›´æ–°dbã€‚å¦‚æœfailsæ¬¡æ•°è¾¾åˆ°ä¸€å®šï¼Œåˆ™ä¼šä»tabä¸­åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹</span><br><span class="line">if err != nil || len(r) == 0 &#123;</span><br><span class="line">fails++</span><br><span class="line">tab.db.UpdateFindFails(n.ID(), fails)</span><br><span class="line">log.Trace(&quot;Findnode failed&quot;, &quot;id&quot;, n.ID(), &quot;failcount&quot;, fails, &quot;err&quot;, err)</span><br><span class="line">if fails &gt;= maxFindnodeFailures &#123;</span><br><span class="line">log.Trace(&quot;Too many findnode failures, dropping&quot;, &quot;id&quot;, n.ID(), &quot;failcount&quot;, fails)</span><br><span class="line">tab.delete(n)</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if fails &gt; 0 &#123;</span><br><span class="line">//å¦‚æœè¿™æ¬¡æˆåŠŸäº†ï¼Œä»¥å‰å¤±è´¥è¿‡ï¼Œåˆ™å¯æŠµæ¶ˆä»¥å‰çš„å‡ºé”™æ¬¡æ•°</span><br><span class="line">tab.db.UpdateFindFails(n.ID(), fails-1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å°½å¯èƒ½æ·»åŠ å¤šä¸ªnode,å°½ç®¡ä»–ä»¬ä¹‹ä¸­å¯èƒ½æœ‰äº›ä¸åœ¨çº¿ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šåœ¨revalidationæ—¶åˆ é™¤ä»–ä»¬</span><br><span class="line">for _, n := range r &#123;</span><br><span class="line">tab.add(n)</span><br><span class="line">&#125;</span><br><span class="line">//å›å¤æˆåŠŸ</span><br><span class="line">reply &lt;- r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>revalidationçš„ä»£ç å°±ä¸ç²˜è´´äº†ï¼Œåšçš„äº‹æƒ…æ˜¯ï¼Œéšæœºä¸€ä¸ªæ¡¶ï¼Œæ‰¾å‡ºè¿™ä¸ªæ¡¶é‡Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå‘è¿™ä¸ªèŠ‚ç‚¹å‘å‡ºpingï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹å›å¤äº†ï¼Œå°±æŠŠä»–ç§»åˆ°æ¡¶çš„æœ€å‰æ–¹ã€‚å¦‚æœæ²¡å›å¤ï¼Œå°±è¿™ä¸ªæ¡¶é‡Œçš„å½“å‰æƒ…å†µè¦ä¹ˆåˆ é™¤å®ƒè¦ä¹ˆæ›¿æ¢å®ƒã€‚</p><p>â­ï¸å…¶å®è¿˜æ˜¯æœ‰ç–‘é—®çš„ï¼Œå°±æ˜¯è™½ç„¶æ¡¶çš„indexæ˜¯ç¡®å®šçš„ï¼Œä½†targetæ˜¯éšæœºçš„ï¼Œé‚£ä¹ˆæ¯æ¬¡targetéšæœºï¼Œå„ä¸ªæ¡¶é‡ŒèŠ‚ç‚¹è·Ÿtargetçš„è·ç¦»å°±ä¼šä¸ä¸€æ ·ï¼Œå„ä¸ªæ¡¶é‡Œçš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯ä¼šå˜åŒ–å¾ˆå¤§ã€‚</p><p>è§£: å› ä¸ºæ¡¶é‡Œå­˜æ”¾çš„èŠ‚ç‚¹çš„é€»è¾‘è·ç¦»æ˜¯å›ºå®šçš„ï¼Œåˆå› ä¸ºæ¯ä¸ªæ¡¶çš„å¤§å°ï¼ˆ16ï¼‰æ˜¯å›ºå®šçš„ï¼Œåªæœ‰å½“æ¡¶ä¸­æœ‰ç©ºä½æ—¶ï¼ŒèŠ‚ç‚¹æ‰ä¼šè¢«æ·»åŠ è¿›æ¡¶ã€‚æ‰€ä»¥æˆ‘çš„ç»“è®ºæ˜¯ï¼Œæ¡¶é‡ŒèŠ‚ç‚¹çš„å˜åŒ–ä¸ä¼šå¾ˆå¤§ï¼Œé¡ºåºå¯èƒ½ä¼šç»å¸¸å˜ï¼Œéšæœºç›®æ ‡æ˜¯ä¸ºäº†æŸ¥æ‰¾æ–°çš„è·ç¦»è‡ªèº«è¿‘çš„èŠ‚ç‚¹ï¼ˆå³ä¸ºäº†æŸ¥æ‰¾å‰å¤§åŠéƒ¨åˆ†æ¡¶ä¸­çš„èŠ‚ç‚¹ï¼‰ï¼Œå†å°±æ˜¯ä¸ºäº†ä¿æŒæ¡¶çš„æ´»æ€§ï¼ˆå³æ¡¶åå°åŠéƒ¨åˆ†æ¡¶ä¸­çš„èŠ‚ç‚¹ï¼‰ã€‚</p><h5 id="udp"><a href="#udp" class="headerlink" title="udp"></a>udp</h5><p>kadä½¿ç”¨udpè¿›è¡Œé€šä¿¡ã€‚ä½œä¸ºtab.netã€‚å¥½ç©çš„æ˜¯ä¸Šé¢çš„tab.net.findnodeå¦‚ä½•å®ç°åŒæ­¥çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">func (t *udp) findnode(toid enode.ID, toaddr *net.UDPAddr, target encPubkey) ([]*node, error) &#123;</span><br><span class="line">   // If we haven&apos;t seen a ping from the destination node for a while, it won&apos;t remember</span><br><span class="line">   // our endpoint proof and reject findnode. Solicit a ping first.</span><br><span class="line">   if time.Since(t.db.LastPingReceived(toid)) &gt; bondExpiration &#123;</span><br><span class="line">      t.ping(toid, toaddr)</span><br><span class="line">      t.waitping(toid)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   nodes := make([]*node, 0, bucketSize)</span><br><span class="line">   nreceived := 0</span><br><span class="line">   errc := t.pending(toid, neighborsPacket, func(r interface&#123;&#125;) bool &#123;</span><br><span class="line">      reply := r.(*neighbors)</span><br><span class="line">      for _, rn := range reply.Nodes &#123;</span><br><span class="line">         nreceived++</span><br><span class="line">         n, err := t.nodeFromRPC(toaddr, rn)</span><br><span class="line">         if err != nil &#123;</span><br><span class="line">            log.Trace(&quot;Invalid neighbor node received&quot;, &quot;ip&quot;, rn.IP, &quot;addr&quot;, toaddr, &quot;err&quot;, err)</span><br><span class="line">            continue</span><br><span class="line">         &#125;</span><br><span class="line">         nodes = append(nodes, n)</span><br><span class="line">      &#125;</span><br><span class="line">      return nreceived &gt;= bucketSize</span><br><span class="line">   &#125;)</span><br><span class="line">   t.send(toaddr, findnodePacket, &amp;findnode&#123;</span><br><span class="line">      Target:     target,</span><br><span class="line">      Expiration: uint64(time.Now().Add(expiration).Unix()),</span><br><span class="line">   &#125;)</span><br><span class="line">   return nodes, &lt;-errc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°findnodeæ˜¯å‘å‡ºäº†ä¸€ä¸ªfindnodeåŒ…ï¼Œç„¶åç­‰å›å¤ä¼šå›è°ƒpendingçš„callbackã€‚ä½†è¿™ä¸ªæ–¹æ³•ç¡®å®æ˜¯åŒæ­¥çš„ï¼Œå°±æ˜¯è¯´è¿”å›çš„è¯ï¼Œå°±è¯´æ˜æ”¶åˆ°äº†å›å¤ï¼Œcallbackä¹Ÿå›è°ƒäº†ã€‚æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ã€‚çœŸçš„å¾ˆå¥½ç©ï¼Œåˆ©ç”¨äº†errcé€šé“ã€‚å°±æ˜¯æœ€åä¸€å¥<code>return nodes, &lt;-errc</code>ï¼Œåªæœ‰errcé€šé“è¯»å‡ºæ¶ˆæ¯æ¥ï¼Œæ‰ä¼šè¿”å›æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯callbackè®¾è®¡çš„ç²¾å¦™ä¹‹å¤„å§ã€‚è¿™ä¹ˆè®¾è®¡çœŸçš„æ˜¯ç²¾å¦™ï¼Œgetåˆ°äº†ã€‚</p><p>udpå¤„ç†çš„å·¥ä½œä¸»è¦æ˜¯è¿›è¡Œé€šä¿¡ã€‚é€šä¿¡ç±»å‹æœ‰ä¸¤ç»„ï¼Œ(å‘ping - å›pong)ã€(å‘findnode - å›neighbors)</p>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_jsre_api</title>
      <link href="/2019/10/14/eth-jsre-api/"/>
      <url>/2019/10/14/eth-jsre-api/</url>
      
        <content type="html"><![CDATA[<h2 id="jsreä¸­æ·»åŠ api"><a href="#jsreä¸­æ·»åŠ api" class="headerlink" title="jsreä¸­æ·»åŠ api"></a>jsreä¸­æ·»åŠ api</h2><p>ottoåŒ…ï¼Œå¯ä»¥ç›´æ¥åœ¨goè¯­è¨€ä¸­å®ç°jså‘½ä»¤ã€‚å¯ä»¥åœ¨consoleè¿™ç§äº¤äº’æ¨¡å¼æˆ–è€…scriptè¿™ç§éäº¤äº’æ¨¡å¼ä¸­ä½¿ç”¨</p><p>ç›¸å…³çš„æºç åˆ†æå°±çœç•¥äº†ã€‚</p><p>è¦æ·»åŠ æ–°çš„api,é¦–å…ˆéœ€è¦åœ¨åˆé€‚çš„åœ°æ–¹å®šä¹‰å…·ä½“æ–¹æ³•ã€‚åˆé€‚åœ°æ–¹..ä¾‹å¦‚backend.goçš„GetAPIs()ä¸ºapié›†åˆï¼Œå¯åœ¨ç›¸åº”çš„namespaceå¯¹åº”çš„Serviceä¸­å®šä¹‰ï¼Œä¾‹å¦‚åœ¨PublicEthereumAPIä¸­æ·»åŠ æ–¹æ³•testï¼Œè®¿é—®è·¯å¾„ä¸º<code>eth.test()</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func (s *PublicBlockChainAPI) Test(ctx context.Context) error &#123;</span><br><span class="line">   fmt.Println(&quot;test&quot;)</span><br><span class="line">   return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯è¦åœ¨jsä¸­è¿›è¡Œæ³¨å†Œï¼Œæ‰èƒ½å®šå‘åˆ°ä¸Šé¢çš„æ–¹æ³•ä¸­ã€‚</p><p>jsä¸­æ³¨å†Œæœ‰ä¸¤ç§æ–¹å¼ã€‚</p><p>ç¬¬ä¸€ç§æ˜¯ç›´æ¥åœ¨goæ–‡ä»¶ä¸­æ·»åŠ jsé™æ€ä»£ç ã€‚åœ¨web3ext.goä¸­å¯¹åº”ä½ç½®æ·»åŠ ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const Eth_JS = `</span><br><span class="line">web3._extend(&#123;</span><br><span class="line">property: &apos;eth&apos;,</span><br><span class="line">methods: [</span><br><span class="line">new web3._extend.Method(&#123;</span><br><span class="line">name: &apos;test&apos;,</span><br><span class="line">call: &apos;eth_test&apos;,</span><br><span class="line">params: 0</span><br><span class="line">&#125;),</span><br><span class="line">]</span><br><span class="line">...</span><br><span class="line">`</span><br></pre></td></tr></table></figure><p>è¿™æ ·æ·»åŠ åï¼Œç›´æ¥é‡æ–°ç¼–è¯‘å³å¯<code>make all</code></p><p>ç¬¬äºŒç§æ˜¯åœ¨jsæ–‡ä»¶ä¸­æ·»åŠ ä»£ç ï¼Œåœ¨web3.jsä¸­å¯¹åº”ä½ç½®æ·»åŠ ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var methods = function () &#123;</span><br><span class="line">    var test = new Method(&#123;</span><br><span class="line">        name: &apos;test&apos;,</span><br><span class="line">        call: &apos;eth_test&apos;,</span><br><span class="line">        params: 0</span><br><span class="line">    &#125;);</span><br><span class="line">    var getStorageAt = new Method(&#123;</span><br><span class="line">        name: &apos;getStorageAt&apos;,</span><br><span class="line">        call: &apos;eth_getStorageAt&apos;,</span><br><span class="line">        params: 3,</span><br><span class="line">        inputFormatter: [null, utils.toHex, formatters.inputDefaultBlockNumberFormatter]</span><br><span class="line">    &#125;);</span><br><span class="line">...</span><br><span class="line"> return [</span><br><span class="line"> test</span><br><span class="line"> ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹jsæ–‡ä»¶ï¼Œè¦è¿›è¡Œç¼–è¯‘æˆgoï¼ˆbindata.goï¼‰æ–‡ä»¶æ‰èƒ½ç”Ÿæ•ˆã€‚</p><p>ç¼–è¯‘deps.goä¸­æœ‰go:generateè¯­å¥ï¼Œç”¨æ¥é‡æ–°ç”Ÿæˆbindata.goæ–‡ä»¶.</p><p>ç”Ÿæˆbindata.goæ–‡ä»¶ï¼Œéœ€è¦å®‰è£…go-bindataã€‚å®‰è£…æ–¹æ³•å¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/jteeuwen/go-bindata</span><br><span class="line">go install github.com/jteeuwen/go-bindata/go-bindata</span><br></pre></td></tr></table></figure><p>å®‰è£…åç”Ÿæˆbindata.goæ–‡ä»¶ï¼Œå¯ä»¥åœ¨IDEä¸­ç‚¹å‡»ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå‘½ä»¤ç”Ÿæˆã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd $GOPATH/src/github.com/ethereum/go-ethereum/internal/jsre/deps</span><br><span class="line">go-bindata -nometadata -pkg deps -o bindata.go bignumber.js web3.js</span><br><span class="line">gofmt -w -s bindata.go</span><br></pre></td></tr></table></figure><p>æœ€åå†è¿›è¡Œç¼–è¯‘å³å¯<code>make all</code></p><p>å…³äºè¾“å…¥å‚æ•°å’Œè¾“å‡ºå‚æ•°ï¼Œå¯åœ¨jså±‚å°±è¾“å…¥çš„å‚æ•°è¿›è¡Œå‚æ•°çš„æ•°æ®ç±»å‹è½¬æ¢ï¼Œå¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„getStorageAtçš„inputFormatterï¼Œå‚æ•°ä¸ºnullçš„ä¸ä¼šè¿›è¡Œæ“ä½œï¼Œutils.toHexåº”è¯¥æ˜¯æŠŠå‚æ•°encodeæˆhexã€‚formatteråº”è¯¥æ˜¯æ„é€ ç»“æ„ä½“å®ä¾‹ï¼Œä¸‹é¢æ”¾2ä¸ªå…·ä½“çš„formatterçš„æ„é€ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var inputDefaultBlockNumberFormatter = function (blockNumber) &#123;</span><br><span class="line">    if (blockNumber === undefined) &#123;</span><br><span class="line">        return config.defaultBlock;</span><br><span class="line">    &#125;</span><br><span class="line">    return inputBlockNumberFormatter(blockNumber);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var inputTransactionFormatter = function (options)&#123;</span><br><span class="line"></span><br><span class="line">    options.from = options.from || config.defaultAccount;</span><br><span class="line">    options.from = inputAddressFormatter(options.from);</span><br><span class="line"></span><br><span class="line">    if (options.to) &#123; // it might be contract creation</span><br><span class="line">        options.to = inputAddressFormatter(options.to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [&apos;gasPrice&apos;, &apos;gas&apos;, &apos;value&apos;, &apos;nonce&apos;].filter(function (key) &#123;</span><br><span class="line">        return options[key] !== undefined;</span><br><span class="line">    &#125;).forEach(function(key)&#123;</span><br><span class="line">        options[key] = utils.fromDecimal(options[key]);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return options;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_erc</title>
      <link href="/2019/10/14/eth-erc/"/>
      <url>/2019/10/14/eth-erc/</url>
      
        <content type="html"><![CDATA[<h4 id="ERC"><a href="#ERC" class="headerlink" title="ERC"></a>ERC</h4><p>ERCï¼ŒEtuereum Request for Commentã€‚ä¸ºäº†åˆ›å»ºä¸€ä¸ªä»¥å¤ªåŠå¹³å°çš„æ ‡å‡†ï¼Œå¼€å‘äººå‘˜åº”å½“æäº¤äº†ä¸€ä¸ªä»¥å¤ªåŠæ”¹è¿›æ–¹æ¡ˆ(EIP)ï¼Œæ”¹è¿›æ–¹æ¡ˆä¸­åŒ…æ‹¬åè®®è§„èŒƒå’Œåˆçº¦æ ‡å‡†ï¼Œä¸€æ—¦EIPè¢«å§”å‘˜ä¼šæ‰¹å‡†å¹¶æœ€ç»ˆç¡®å®šï¼Œå®ƒå°±æˆä¸ºERC/Core</p><p>å‚è€ƒè‡ª<a href="https://eips.ethereum.org/erc" target="_blank" rel="noopener">è¿æ¥</a></p><h4 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h4><ul><li><p>ERC20</p><p>ä»£å¸æ ‡å‡†åŒ–çš„ä¸€ä¸ªèµ·ç‚¹ã€‚åœ¨Ethereumå¹³å°ä¹‹ä¸Šå‘å¸ƒçš„å¤§å¤šæ•°é€šè¯ï¼ˆ<code>token</code>ï¼‰éƒ½ä½¿ç”¨å®ƒã€‚å®ƒå®šä¹‰äº†ä»¥ä¸‹å‡½æ•°æ¥å£</p><ul><li>totalSupply()ï¼šè¿”å›ä»£å¸ä¾›ç»™æ€»é‡</li><li>balanceOf(address _owner)ï¼šè¿”å›_ownerçš„å¸æˆ·ä½™é¢</li><li>transfer(address _to,uint256 _value)ï¼šå¹¶å°†æ•°é‡ä¸º_valueçš„ä»£å¸è½¬å…¥åœ°å€_toå¹¶è§¦å‘transferäº‹ä»¶</li><li>transferFrom(address _from,address _to,uint256_value)ï¼šå°†åœ°å€_fromä¸­çš„_valueæ•°é‡çš„ä»£å¸è½¬å…¥åœ°å€_to ï¼Œå¹¶è§¦å‘transferäº‹ä»¶</li><li>approve(address _spender,uint256 _value)ï¼šå…è®¸_spenderæå–é™é¢_valueçš„ä»£å¸</li><li>allowance(address _owner,address _spenderï¼‰ï¼šè¿”å›_spenderå¯ä»_ownerææ¬¾çš„ä»£å¸æ•°é‡ä¸Šé™</li></ul><p>ä»¥ä¸Šå‡½æ•°å°†è§¦å‘ä»¥ä¸‹äº‹ä»¶ï¼š</p><ul><li>transfer(address indexed _from,address indexed _to,uint256 _value)ï¼šæ¯æ¬¡è¿›è¡Œä»£å¸è½¬è´¦æ—¶éƒ½ä¼šè§¦å‘</li><li>approval(address indexed _owner,address indexed _spender,uint256 _value)ï¼šè°ƒç”¨approve()æ–¹æ³•å°†è§¦å‘è¯¥äº‹ä»¶</li></ul></li></ul><ul><li><p>ERC20çš„è¡¥å……:</p><ul><li>ERC223</li><li>ERC62, åŠ äº†ä¸¤ä¸ªé¢å¤–çš„åŠŸèƒ½ï¼Œ increaseSupplyå’ŒdecreaseSupply, è¿™å¯ä»¥å¢åŠ å’Œå‡å°‘æµé€šä¸­çš„ä»¤ç‰Œä¾›åº”</li><li>ERC827ï¼Œå®ƒå…è®¸è½¬è®©Tokenå¹¶å…è®¸æŒæœ‰äººå…è®¸ç¬¬ä¸‰æ–¹ä½¿ç”¨Tokenã€‚ ä»¥å¤ªåŠä¸Šçš„Tokenå¯ä»¥è¢«å…¶ä»–åº”ç”¨ç¨‹åºé‡å¤ä½¿ç”¨ï¼Œè¿™å…¶ä¸­ä¹ŸåŒ…æ‹¬é’±åŒ…å’Œäº¤æ˜“æ‰€ã€‚ å½“éœ€è¦æ”¯æŒç¬¬ä¸‰æ–¹åŠ¨æ€æ¶ˆè´¹é™é¢è°ƒæ•´æ—¶è¿™ä¸€ç‚¹éå¸¸æœ‰ç”¨ã€‚ERC827ä¸ERC-20å…¼å®¹ã€‚</li></ul></li><li><p>ERC721</p><p>æè¿°äº†ä¸€ä¸ªä¸å¯äº’æ¢çš„Tokenï¼Œå³æ¯ä¸ªTokenæ˜¯ä¸åŒçš„ï¼Œå¹¶ä¸”æ¯ä¸ªTokenå¯¹ä¸åŒçš„ç”¨æˆ·éƒ½æœ‰ä¸åŒçš„ä»·å€¼ã€‚</p><p>ä¾‹å­ï¼šCryptoKittesï¼Œæ¯ä¸€ä¸ªæ•°å­—çŒ«éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå…¶ä»·å€¼å–å†³äºå…¶ç¨€ç¼ºæ€§å’Œç”¨æˆ·çš„è´­ä¹°æ¬²ã€‚</p></li><li><p>ERC55</p><p>å¤§å°å†™æ··ç”¨çš„åœ°å€è¡¨ç¤ºæ–¹æ³•ï¼Œé€šè¿‡è¿™ç§è¡¨ç¤ºæ–¹æ³•è¡¨ç¤ºçš„åœ°å€éšå«äº†ä¸€ä¸ª<strong>æ ¡éªŒå’Œ</strong>(checksum)èƒ½å¤ŸéªŒè¯è¯¥åœ°å€çš„æœ‰æ•ˆæ€§ã€‚åœ¨æ­¤ä¹‹å‰åœ°å€çš„è¡¨ç¤ºä¸ºå°å†™ï¼ŒåŠ å…¥è¿™ä¸ªä¹‹ååœ°å€å¯ç”¨å¤§å°å†™æ··åˆè¡¨ç¤º</p></li><li><p>ERC137</p><p>Ethereum Domain Name Service (ENS)</p><p>åŸŸåæœåŠ¡ã€‚åœ°å€-åŸŸåå¯¹åº”</p></li><li><p>ERC162</p><p>Initial ENS Hash Registrar(ENS: ä»¥å¤ªåŠåç§°æœåŠ¡)ã€‚æœåŠ¡äº137</p><blockquote><p>æ³¨å†Œå•†è´Ÿè´£ä¸ºç³»ç»Ÿç”¨æˆ·åˆ†é…åŸŸåï¼Œå¹¶ä¸”æ˜¯å”¯ä¸€èƒ½å¤Ÿæ›´æ–°ENSçš„å®ä½“; ENSæ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹çš„æ‰€æœ‰è€…æ˜¯å…¶æ³¨å†Œå•†ã€‚æ³¨å†Œå•†å¯èƒ½æ˜¯åˆåŒæˆ–å¤–éƒ¨æ‹¥æœ‰çš„è´¦æˆ·ï¼Œä½†é¢„è®¡æ ¹å’Œæœ€é«˜çº§æ³¨å†Œå•†è‡³å°‘å°†ä½œä¸ºåˆåŒå®æ–½ã€‚</p><p>- EIP 137</p></blockquote><p>ç²¾å¿ƒè®¾è®¡å’Œç®¡ç†çš„æ³¨å†Œå•†å¯¹äºEIP 137ä¸­æè¿°çš„ENSçš„æˆåŠŸè‡³å…³é‡è¦ã€‚æ•…162åˆ™å¯¹æ³¨å†Œå•†çš„ç®¡ç†åè®®</p></li><li><p>ERC165</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æ¥éªŒè¯è¿™ä¸ªåˆçº¦æ˜¯å¦å®ç°äº†ç‰¹å®šçš„æ¥å£ã€‚</span><br></pre></td></tr></table></figure><p>ERC165å®šä¹‰ä»¥ä¸‹åŠŸèƒ½ï¼š<br> 1ï¼‰ å¦‚ä½•è¯†åˆ«æ¥å£ï¼›<br> 2ï¼‰ ä¸€ä¸ªæ™ºèƒ½åˆçº¦å¦‚ä½•å‘å¸ƒå®ƒæ‰§è¡Œçš„æ¥å£ï¼›<br> 3ï¼‰ å¦‚ä½•æ£€æµ‹ä¸€ä¸ªæ™ºèƒ½åˆçº¦æ˜¯å¦æ‰§è¡Œäº†ERC-165åè®®ï¼›<br> 4ï¼‰ å¦‚ä½•æ£€æµ‹ä¸€ä¸ªæ™ºèƒ½åˆçº¦æ˜¯å¦æ‰§è¡Œäº†ä¸€ä¸ªç»™å®šçš„æ¥å£ï¼›</p></li><li><p>ERC181</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENS support for reverse resolution of Ethereum addresses</span><br></pre></td></tr></table></figure><p>ENSæ”¯æŒä»¥å¤ªåŠåœ°å€çš„åå‘è§£æ</p></li><li><p>ERC190</p><p>æ™ºèƒ½åˆçº¦åŒ…ç®¡ç†æ ‡å‡†, æä¾›åŒ…ç®¡ç†å·¥å…·ï¼Œæé«˜ä»£ç çš„å¯é‡ç”¨æ€§å’Œå®‰å…¨æ€§</p></li><li><p>ERC1167</p><p>æœ€å°ä»£ç†åˆçº¦</p><p>ä¸ºäº†ä»¥ä¸å¯å˜çš„æ–¹å¼ç®€å•ä¸”å»‰ä»·åœ°å…‹éš†åˆåŒåŠŸèƒ½ï¼Œè¯¥æ ‡å‡†è§„å®šäº†ä¸€ä¸ªæœ€å°å­—èŠ‚ç å®ç°ï¼Œå®ƒå°†æ‰€æœ‰è°ƒç”¨å§”æ‰˜ç»™å·²çŸ¥çš„å›ºå®šåœ°å€</p></li><li><p>681</p><p>äº¤æ˜“è¯·æ±‚URLæ ¼å¼</p><p>è¡¨ç¤ºå„ç§äº¤æ˜“çš„æ ‡å‡†æ–¹å¼ï¼Œå°¤å…¶æ˜¯Etherså’ŒERCï¼ƒ20ä»¤ç‰Œä¸­çš„ä»˜æ¬¾è¯·æ±‚ä½œä¸ºURLã€‚</p></li></ul><h4 id="Draft"><a href="#Draft" class="headerlink" title="Draft"></a>Draft</h4><ul><li><p>1046</p><p>æ‰©å±•ERC20ä»¤ç‰Œæ¥å£ä»¥æ”¯æŒä¸ERC721ä»¤ç‰Œç›¸åŒçš„å…ƒæ•°æ®æ ‡å‡†ã€‚</p></li><li><p>1062</p><p>å°†IPFSå“ˆå¸Œå½¢å¼åŒ–ä¸ºENSï¼ˆä»¥å¤ªåŠåç§°æœåŠ¡ï¼‰è§£æå™¨</p><blockquote><p>å°†IPFS base58å­—ç¬¦ä¸²æ˜ å°„åˆ°ENSè§£æå™¨æ—¶ï¼Œé¦–å…ˆæˆ‘ä»¬å°†Base58è½¬æ¢ä¸ºäºŒè¿›åˆ¶ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºè½¬æ¢ä¸ºåå…­è¿›åˆ¶åŠ å¯†æ ¼å¼ï¼Œç„¶åä¿å­˜åˆ°åˆåŒä¸­ã€‚ä¸€æ—¦æˆ‘ä»¬æƒ³è¦è·å–ç”±ç‰¹å®šENSè¡¨ç¤ºçš„IPFSèµ„æºåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ‰¾åˆ°ä»¥åå…­è¿›åˆ¶æ ¼å¼å­˜å‚¨çš„æ˜ å°„ä¿¡æ¯ï¼Œå°†åå…­è¿›åˆ¶æ ¼å¼æå–åˆ°äºŒè¿›åˆ¶ç¼“å†²åŒºï¼Œæœ€åå°†å…¶è½¬æ¢ä¸ºIPFS Base58åœ°å€å­—ç¬¦ä¸²</p></blockquote></li><li><p>1066</p><p>çŠ¶æ€ç ã€‚å®šä¹‰äº†é€‚ç”¨äºä»¥å¤ªåŠæ™ºèƒ½åˆçº¦çš„å¹¿æ³›é€‚ç”¨çš„çŠ¶æ€ä»£ç ã€‚ç›®å‰è°ƒç”¨ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦ï¼Œè¿”å›çŠ¶æ€è¦ä¹ˆ<code>revert</code>éœ€è¦äººä¸ºå¹²é¢„ï¼Œè¦ä¹ˆè¿”å›å¸ƒå°”é€šè¿‡/å¤±è´¥çŠ¶æ€ã€‚è¯¥æ ‡å‡†æ¦‚è¿°äº†ä¸HTTPçŠ¶æ€ç›¸åŒçš„ä¸€ç»„å…±åŒçš„ä»¥å¤ªåŠçŠ¶æ€ä»£ç ï¼ˆESCï¼‰ã€‚è¿™æä¾›äº†ä¸€ç»„å…±äº«ä¿¡å·ï¼Œå…è®¸æ™ºèƒ½åˆçº¦è‡ªåŠ¨å“åº”æƒ…å†µï¼Œå‘ç”¨æˆ·å…¬å¼€æœ¬åœ°åŒ–é”™è¯¯æ¶ˆæ¯ç­‰ã€‚</p></li><li><p>1077</p><p>Executable Signed Messages refunded by the contract</p><p>æ²¡æ€ä¹ˆçœ‹æ‡‚..å¥½åƒæ˜¯å…è®¸ç¬¬ä¸‰æ–¹å¸®å¿™æäº¤äº¤æ˜“ã€‚å¦‚åœ¨ç°æœ‰çš„æ”¯ä»˜(å¦‚apple pay)ä¸Šè¿›è¡Œæ”¯ä»˜ä»¥å¤ªåŠ</p></li><li><p>1078</p><p>ä½¿ç”¨ENSå­åŸŸåè¿›è¡Œç™»å½•/æ³¨å†Œ</p><p>ä½¿ç”¨è¿™ç§æ–¹å¼çš„è¯ï¼Œä¸authä»¤ç‰Œæœ‰ç‚¹ç›¸ä¼¼ã€‚å­èº«ä»½è¿æ¥åˆ°ç°æœ‰èº«ä»½</p></li><li><p>1080</p><p>å…è®¸å®ç°æ‰©å±•ERC-20æˆ–ERC-791çš„ä»¤ç‰Œçš„æ ‡å‡†APIã€‚è¯¥æ ‡å‡†æä¾›äº†æ¢å¤è¢«ç›—æˆ–ä¸¢å¤±å¸æˆ·çš„åŸºæœ¬åŠŸèƒ½ï¼Œä»¥åŠæä¾›ä»¤ç‰Œçš„é€€æ¬¾ã€‚</p></li><li><p>1081</p><p>ç”¨äºåœ¨ä»¥å¤ªåŠä¸Šå‘è¡Œå¥–åŠ±çš„æ ‡å‡†åˆåŒå’Œç•Œé¢ï¼Œå¯ç”¨äºä»»ä½•ç±»å‹çš„ä»»åŠ¡ï¼Œåœ¨ä»»ä½•ERC20ä»¤ç‰Œæˆ–ETHä¸­æ”¯ä»˜ã€‚</p><p>ä¸ºäº†é¼“åŠ±ä»¥å¤ªåŠå¥–é‡‘çš„è·¨å¹³å°äº’æ“ä½œæ€§ï¼Œä»¥åŠæ›´å®¹æ˜“çš„å£°èª‰è·Ÿè¸ªï¼ŒStandardBounties(1081)å¯ä»¥ä»¥å…¬å¼€å¯å®¡è®¡å’Œä¸å¯å˜çš„æ–¹å¼ä¿ƒè¿›èµ„é‡‘ç®¡ç†ï¼Œä»¥æ¢å–ä¸å®Œæˆä»»åŠ¡ç›¸å¯¹åº”çš„å¯äº¤ä»˜æˆæœã€‚</p></li><li><p>1123</p><p>190(åŒ…ç®¡ç†)çš„ä¿®è®¢ç‰ˆ</p></li><li><p>1129</p><p>ä»¥å¤ªåŠç½‘ç»œä¸ŠDAPPå’ŒæœåŠ¡çš„å…¬å‘Šæ ‡å‡†åŒ–</p></li><li><p>1132</p><p>é€šè¿‡Tokené”å®šåŠŸèƒ½æ‰©å±•ERC20</p><p>ERC20æ ‡å‡†çš„æ‰©å±•ï¼Œå…·æœ‰åœ¨åˆåŒä¸­å¯¹Tokenè¿›è¡Œæ—¶é—´é”å®šçš„æ–¹æ³•ã€‚</p></li><li><p>1154</p><p>oracleæ¥å£</p></li><li><p>1155</p><p>ç”¨äºç®¡ç†å¤šä¸ªtokenç±»å‹çš„æ ‡å‡†æ¥å£ã€‚å•ä¸ªéƒ¨ç½²çš„åˆçº¦å¯ä»¥åŒ…æ‹¬å¯æ›¿æ¢tokenã€ä¸å¯æ›¿æ¢tokenæˆ–å…¶ä»–é…ç½®(å¦‚ï¼ŒåŠå¯æ›¿æ¢çš„token)ã€‚20æ˜¯è¦æ±‚æ¯ä¸ªtokenå•ç‹¬éƒ¨ç½²åˆçº¦ï¼Œ721æ˜¯ä¸å¯æ›¿æ¢çš„tokenç»„åˆå•ç‹¬éƒ¨ç½²ã€‚1155åˆ™ç›¸å½“äº20+721</p></li><li><p>1175</p><p>æ‰€æœ‰ä»£å¸çš„é’±åŒ…å’Œå•†åº—æ ‡å‡†ï¼ˆerc20ï¼‰</p><p>é’±åŒ…ä¸ç»è¿‡éªŒè¯çš„åˆåŒåˆ›å»ºçš„å•†åº—ä¹‹é—´çš„ç›¸äº’ä¿¡ä»»å…è®¸æ‚¨é€šè¿‡ç®€å•çš„æµç¨‹æ”¯ä»˜å’Œè´­ä¹°ç‰©å“ã€‚</p></li><li><p>1178</p><p>å¤šç±»ä»¤ç‰Œæ ‡å‡†</p></li><li><p>1185</p><p>åœ¨ENSä¸­å­˜å‚¨DNSè®°å½•</p><p>æ­¤EIPå®šä¹‰äº†ENSçš„è§£æç¨‹åºé…ç½®æ–‡ä»¶ï¼Œè¯¥é…ç½®æ–‡ä»¶æä¾›ç”¨äºå­˜å‚¨å’ŒæŸ¥æ‰¾DNSè®°å½•çš„åŠŸèƒ½ã€‚è¿™å…è®¸ENSç”¨ä½œæƒå¨DNSä¿¡æ¯çš„å­˜å‚¨ã€‚</p></li><li><p>1191</p><p>å°†é“¾IDæ·»åŠ åˆ°æ··åˆå¤§å°å†™æ ¡éªŒå’Œåœ°å€ç¼–ç </p><p>è¯¥EIPé€šè¿‡å¯é€‰åœ°å°†EIP-155å®šä¹‰çš„é“¾IDæ·»åŠ åˆ°æ ¡éªŒå’Œè®¡ç®—æ¥æ‰©å±•EIP-55ã€‚</p></li><li><p>1202</p><p>æŠ•ç¥¨æ ‡å‡†</p></li><li><p>1271</p><p>åœ¨åˆçº¦ä¸­éªŒè¯ç­¾åæ–¹æ³•</p></li><li><p>1261</p><p>ä¼šå‘˜éªŒè¯Token</p><p>åœ¨æ™ºèƒ½åˆçº¦ä¸­å®ç°ä¼šå‘˜éªŒè¯Token</p></li><li><p>1207</p><p>DAuthè®¿é—®å§”æ´¾æ ‡å‡†ã€‚æ™ºèƒ½åˆçº¦ä¹‹é—´çš„â€OAuthâ€</p></li><li><p>1203</p><p>å¤šçº§Tokenæ ‡å‡†</p><p>äº1178æœ‰ç‚¹ç±»å‹ï¼Œä½†ä¼¼ä¹æ›´æœ‰ä¼˜åŠ¿</p></li><li><p>1319</p><p>åŒ…æ³¨å†Œè¡¨ç•Œé¢ï¼Œ1123çš„ä¼´éšè€…ï¼Œå®šä¹‰äº†æ™ºèƒ½åˆçº¦åŒ…æ¸…å•çš„æ ‡å‡†ã€‚</p></li><li><p>1328</p><p>WalletConnectæ ‡å‡†URIæ ¼å¼ã€‚éµå¾ª831 URIæ ¼å¼</p></li><li><p>1386</p><p>è®¤è¯ç®¡ç†åˆçº¦</p><p>ç®¡ç†å…¶è¯æ˜ç­¾åå¯†é’¥ä»¥åŠé’ˆå¯¹è¯¸å¦‚åŠé”€å’ŒéªŒè¯ç­‰æ“ä½œçš„é“¾å¤–å‘å¸ƒçš„è¯æ˜ã€‚(æœ‰ç‚¹åƒæˆæƒ/å–æ¶ˆæˆæƒ)</p></li><li><p>1387</p><p>å¯ç”¨éšç§çš„Merkle Treeè®¤è¯</p></li><li><p>1388</p><p>è¯æ˜å‘è¡Œäººç®¡ç†æ¸…å•</p><p>1386ã€1387ã€1388éƒ½æ˜¯å·®ä¸å¤šçš„è®¤è¯ç›¸å…³ï¼Œä½œè€…ä¹Ÿæ˜¯ä¸€æ ·</p></li><li><p>1417</p><p>æŠ•ç¥¨æ ‡å‡†ã€‚</p><p>äº1261(ä¼šå‘˜) ä¸€èµ·ä½¿ç”¨çš„æŠ•ç¥¨æ ‡å‡†</p></li><li><p>1438</p><p>dappç»„å»º(å¤´åƒ)å’Œé€šç”¨é’±åŒ…</p><p>ä»£ç çš„é‡ç”¨æ€§æ–¹å‘</p></li><li><p>1444</p><p>å…·æœ‰ä¿¡å·åˆ°æ–‡æœ¬çš„æœ¬åœ°åŒ–æ¶ˆæ¯ä¼ é€’ã€‚æœ¬åœ°æ¶ˆæ¯çš„å¯è¯»æ–‡æœ¬ã€‚æœ‰å‡ ç§æœºå™¨æœ‰æ•ˆçš„æ–¹å¼æ¥è¡¨ç¤ºæ„å›¾ï¼ŒçŠ¶æ€ï¼ŒçŠ¶æ€è½¬æ¢å’Œå…¶ä»–è¯­ä¹‰ä¿¡å·ï¼ŒåŒ…æ‹¬å¸ƒå°”å€¼ï¼Œæšä¸¾å’ŒERC-1066ä»£ç </p></li><li><p>1450</p><p>ç”¨äºå‘è¡Œå’Œäº¤æ˜“ç¬¦åˆSECæ ‡å‡†çš„è¯åˆ¸çš„å…¼å®¹å®‰å…¨ä»¤ç‰Œ</p></li><li><p>1462</p><p>åŸºæœ¬å®‰å…¨Tokenï¼Œæä¾›ç¬¦åˆè¯åˆ¸æ³•è§„å’Œæ³•å¾‹å¯æ‰§è¡Œæ€§çš„è¦æ±‚ã€‚</p></li><li><p>1484</p><p>æ•°å­—èº«ä»½èšåˆ</p><p>ç”¨äºèšåˆæ•°å­—èº«ä»½ä¿¡æ¯çš„åè®®ï¼Œè¯¥åè®®å¯ä¸ç°æœ‰çš„ï¼Œæè®®çš„å’Œå‡è®¾çš„æœªæ¥æ•°å­—èº«ä»½æ ‡å‡†å¹¿æ³›äº’æ“ä½œã€‚åœ¨åŒºå—é“¾ä¸Šæå‡ºäº†èº«ä»½ç®¡ç†å’Œèšåˆæ¡†æ¶</p></li><li><p>173</p><p>åˆçº¦æ‰€æœ‰æƒæ ‡å‡†</p><p>å…è®¸è·å–åˆåŒçš„æ‰€æœ‰è€…åœ°å€å¹¶å°†åˆåŒæ‰€æœ‰æƒè½¬ç§»åˆ°ä¸åŒçš„åœ°å€</p></li><li><p>191</p><p>æå‡ºäº†å…³äºå¦‚ä½•å¤„ç†ä»¥å¤ªåŠåˆåŒä¸­çš„ç­¾åæ•°æ®çš„è§„èŒƒ</p></li><li><p>205</p><p>ENSæ”¯æŒåˆçº¦abi</p><p>åœ¨ENSä¸­å­˜å‚¨ABIå®šä¹‰çš„æœºåˆ¶ï¼Œä»¥ä¾¿å‘¼å«è€…è½»æ¾æŸ¥æ‰¾åˆåŒæ¥å£</p></li><li><p>725</p><p>ä»£ç†èº«ä»½</p><p>å¯†é’¥ç®¡ç†å’Œæ‰§è¡Œçš„ä»£ç†åˆåŒï¼Œç”¨äºå»ºç«‹åŒºå—é“¾èº«ä»½ã€‚</p></li><li><p>777</p><p>Tokenåˆçº¦çš„æ ‡å‡†æ¥å£å’Œè¡Œä¸º</p></li><li><p>801</p><p>A standard interface for canary contracts.å®Œå…¨æ²¡æ‡‚</p></li><li><p><strong>820</strong></p><p>ä¼ªå†…çœæ³¨å†Œåˆçº¦</p><p>è¯¥æ ‡å‡†å®šä¹‰äº†ä¸€ä¸ªé€šç”¨æ³¨å†Œè¡¨æ™ºèƒ½åˆçº¦ï¼Œå…¶ä¸­ä»»ä½•åœ°å€ï¼ˆåˆåŒæˆ–å¸¸è§„å¸æˆ·ï¼‰éƒ½å¯ä»¥æ³¨å†Œå®ƒæ”¯æŒçš„æ¥å£ä»¥åŠå“ªä¸ªæ™ºèƒ½åˆçº¦è´Ÿè´£å…¶å®æ–½ã€‚</p><p>äº165ä¿æŒå‘åå…¼å®¹</p></li><li><p>823</p><p>tokenäº¤æ¢æ ‡å‡†</p><p>TokenåˆåŒçš„æ ‡å‡†ï¼Œæä¾›tokenäº¤æ¢æœåŠ¡ï¼Œä»è€Œä¿ƒè¿›äº¤å‰tokenæ”¯ä»˜ã€‚</p></li><li><p>831</p><p>ä»¥å¤ªåŠçš„URIæ ¼å¼</p></li></ul><p>-</p><hr><h3 id="Core"><a href="#Core" class="headerlink" title="Core"></a>Core</h3><ul><li><p>158</p><p>state clearï¼ŒçŠ¶æ€æ¸…é™¤ã€‚å®šä¹‰äº†è´¦æˆ·è¢«åˆ é™¤çš„æƒ…å†µ</p></li><li><p>155</p><p>ç®€å•çš„é‡æ”¾æ”»å‡»ä¿æŠ¤ã€‚å…·ä½“æ˜¯ä¿®æ”¹ç­¾åæˆ–æ¢å¤æ—¶è®¡ç®—hashæ—¶çš„ä¸€äº›ä¿®æ”¹(åŠ å…¥é“¾ID)</p></li><li><p>150</p><p>gasèŠ±è´¹æ›´æ”¹ã€‚</p></li></ul><p>åŒ…ç®¡ç†</p><p>Token</p><ul><li>å¯/ä¸å¯ç½®æ¢</li><li>ç¬¦åˆç‰¹å®šè¦æ±‚ï¼Œå¦‚è¯åˆ¸æ³•è§„ã€åœ°æ–¹æ³•å¾‹..</li><li>å¤šç§Tokenäº¤å‰æ”¯ä»˜</li></ul><p>Auth</p><p>ENS</p>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>dai_code</title>
      <link href="/2019/10/14/dai-code/"/>
      <url>/2019/10/14/dai-code/</url>
      
        <content type="html"><![CDATA[<h2 id="daiç»“æ„åŠæºç è§£æ"><a href="#daiç»“æ„åŠæºç è§£æ" class="headerlink" title="daiç»“æ„åŠæºç è§£æ"></a>daiç»“æ„åŠæºç è§£æ</h2><p><img src="https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png" alt="åˆçº¦è°ƒç”¨å›¾"></p><p>ç»“æ„å›¾å¦‚ä¸Šæ‰€ç¤ºï¼Œvatå·¦è¾¹çš„ä¸»è¦æ˜¯<strong>ç®¡ç†æ§åˆ¶ä¿®æ”¹</strong>vatåŠvatå³è¾¹å„åˆçº¦å„<strong>å‚æ•°</strong>çš„åˆçº¦ï¼Œçº¢çº¿fileä¸ºè°ƒç”¨å„åˆçº¦ä¸­fileæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹å„åˆçº¦ä¸­ç›¸åº”å‚æ•°ã€‚å¦‚vatä¸­fileä¸ºP427L-9Y552-5433E-8DSR3-58Z68</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function file(bytes32 what, uint data) external note auth &#123;</span><br><span class="line">    if (what == &quot;Line&quot;) Line = data;</span><br><span class="line">    else revert();</span><br><span class="line">&#125;</span><br><span class="line">function file(bytes32 ilk, bytes32 what, uint data) external note auth &#123;</span><br><span class="line">    if (what == &quot;spot&quot;) ilks[ilk].spot = data;</span><br><span class="line">    else if (what == &quot;line&quot;) ilks[ilk].line = data;</span><br><span class="line">    else if (what == &quot;dust&quot;) ilks[ilk].dust = data;</span><br><span class="line">    else revert();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vatæ˜¯CDPçš„ä¸»è¦é€»è¾‘åˆçº¦ã€‚</p><p>catä¸ºæ¸…ç®—è§¦å‘åˆçº¦ï¼Œé€šè¿‡è°ƒç”¨cat.biteæ–¹æ³•ï¼Œå½“æ»¡è¶³æ¸…ç®—æ¡ä»¶å°±ä¼šè§¦å‘æ¸…ç®—ã€‚å…·ä½“é€»è¾‘ç¨åæåŠã€‚</p><p>vowä¸ºç»“ç®—åˆçº¦ï¼Œé€šè¿‡vowçš„ç»“ç®—æ¡ä»¶å¯è§¦å‘flopå’Œflapã€‚</p><p>flipä¸ºæŠµæŠ¼ç‰©æ‹å–åˆçº¦ï¼Œæ‹å–ç”±catè§¦å‘ï¼Œæ‹å–é€»è¾‘ç¨åæåŠã€‚</p><p>flopå’Œflapåˆ†åˆ«ä¸ºå€ºåŠ¡æ‹å–å’Œç›ˆä½™æ‹å–ï¼Œç”±vowè§¦å‘ã€‚</p><h3 id="vat"><a href="#vat" class="headerlink" title="vat"></a>vat</h3><p>å˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//æŠµæŠ¼ç‰©idå¯¹åº”çš„å‚æ•°</span><br><span class="line">mapping (bytes32 =&gt; Ilk)                       public ilks;  </span><br><span class="line">//æŠµæŠ¼ç‰©id =&gt; ä¸ªäººåœ°å€ =&gt; ä¸ªäººå€ºåŠ¡</span><br><span class="line">mapping (bytes32 =&gt; mapping (address =&gt; Urn )) public urns;  </span><br><span class="line">//æŠµæŠ¼ç‰©id =&gt; ä¸ªäººåœ°å€ =&gt; ä¸ªäººæŠµæŠ¼ç‰©æ€»å€¼</span><br><span class="line">mapping (bytes32 =&gt; mapping (address =&gt; uint)) public gem;  </span><br><span class="line">//ä¸ªäººåœ°å€ =&gt; å«æœ‰çš„daiï¼Œç»Ÿè®¡ä½œç”¨</span><br><span class="line">mapping (address =&gt; uint256)                   public dai;  </span><br><span class="line">//æ¸…ç®—åœ°å€ =&gt; æ¸…ç®—æ€»å€¼ï¼Œ ç»Ÿè®¡ä½œç”¨</span><br><span class="line">mapping (address =&gt; uint256)                   public sin;</span><br><span class="line"></span><br><span class="line"> struct Urn &#123;</span><br><span class="line">        uint256 ink;   // é”å®šçš„æŠµæŠ¼ç‰©å€¼</span><br><span class="line">        uint256 art;   // å€Ÿè´·çš„dai</span><br><span class="line"> &#125;</span><br><span class="line"> //ä»¥æŠµæŠ¼ç‰©idä¸ºä¸ªä½“</span><br><span class="line"> struct Ilk &#123;</span><br><span class="line">        uint256 Art;   // æ€»å€Ÿè´·dai</span><br><span class="line">        uint256 rate;  // å¯å€Ÿè´·æ¯”ç‡</span><br><span class="line">        uint256 spot;  // ä»·æ ¼å®‰å…¨çº¿</span><br><span class="line">        uint256 line;  // æ€»å€Ÿè´·ä¸Šçº¿</span><br><span class="line">        uint256 dust;  // æ€»å€Ÿè´·ä¸‹é™</span><br><span class="line"> &#125; //rateå’Œspotçš„ä½œç”¨ä¸»è¦æ˜¯æ»¡è¶³ink * spot &gt;= art * rateå¯å€Ÿè´·ï¼Œä¸ç„¶å°±ä¸èƒ½å€Ÿè´·æˆ–è€…éœ€è¦æ¸…ç®—äº†ã€‚</span><br></pre></td></tr></table></figure><p>ä¸»è¦è®²è®²frobæ–¹æ³•å§ï¼Œè¿™ä¸ªæ–¹æ³•å¯è°“æ˜¯ç²¾çŸ­åˆå¼ºæ‚ï¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//bytes32 i ilkæ ‡è¯†ï¼Œ address u cdpæ‰€æœ‰è€…ï¼Œv æŠµæŠ¼ç‰©æ‰€æœ‰è€…ï¼Œw è·å¾—daiçš„æ‰€æœ‰è€…ï¼Œdink å‚ä¸çš„æŠµæŠ¼ç‰©ï¼Œdartå‚ä¸çš„å€ºåŠ¡</span><br><span class="line">function frob(bytes32 i, address u, address v, address w, int dink, int dart) external note &#123;</span><br><span class="line">    // system is live</span><br><span class="line">    require(live == 1);</span><br><span class="line"></span><br><span class="line">    Urn memory urn = urns[i][u];</span><br><span class="line">    Ilk memory ilk = ilks[i];</span><br><span class="line">    // ilk has been initialised</span><br><span class="line">    require(ilk.rate != 0);</span><br><span class="line"></span><br><span class="line">    urn.ink = add(urn.ink, dink);</span><br><span class="line">    urn.art = add(urn.art, dart);</span><br><span class="line">    ilk.Art = add(ilk.Art, dart);</span><br><span class="line"></span><br><span class="line">    int dtab = mul(ilk.rate, dart);</span><br><span class="line">    uint tab = mul(urn.art, ilk.rate);</span><br><span class="line">    debt     = add(debt, dtab); //daiæ€»é‡</span><br><span class="line"></span><br><span class="line">    //dart &lt;=0, èµå›æŠµæŠ¼ç‰©ï¼Ÿ dart &gt;0, å€Ÿè´·</span><br><span class="line"></span><br><span class="line">    // either debt has decreased, or debt ceilings are not exceeded</span><br><span class="line">    require(either(dart &lt;= 0, both(mul(ilk.Art, ilk.rate) &lt;= ilk.line, debt &lt;= Line)));</span><br><span class="line">    // urn is either less risky than before, or it is safe</span><br><span class="line">    require(either(both(dart &lt;= 0, dink &gt;= 0), tab &lt;= mul(urn.ink, ilk.spot)));</span><br><span class="line">    // urn is either more safe, or the owner consents</span><br><span class="line">    require(either(both(dart &lt;= 0, dink &gt;= 0), wish(u, msg.sender)));</span><br><span class="line">    // collateral src consents</span><br><span class="line">    require(either(dink &lt;= 0, wish(v, msg.sender)));</span><br><span class="line">    // debt dst consents</span><br><span class="line">    require(either(dart &gt;= 0, wish(w, msg.sender)));</span><br><span class="line">    // urn has no debt, or a non-dusty amount</span><br><span class="line">    require(either(urn.art == 0, tab &gt;= ilk.dust));</span><br><span class="line"></span><br><span class="line">    gem[i][v] = sub(gem[i][v], dink);</span><br><span class="line">    dai[w]    = add(dai[w],    dtab);</span><br><span class="line">    urns[i][u] = urn;</span><br><span class="line">    ilks[i]    = ilk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»¥ä¸Šè¿™ä¸ªæ–¹æ³•ä¸­ï¼ŒåŒ…å«äº†å¾ˆå¤šç§ç”¨æ³•ï¼ŒåŒ…æ‹¬æ–°å¢cdpã€å¿è¿˜ç­‰ç­‰ï¼Œä¾‹å¦‚å½“dart&gt;0çš„æ—¶å€™ï¼Œå°±æ˜¯å€Ÿè´·ï¼Œå½“dart&lt;0çš„æ—¶å€™ï¼Œå¿è¿˜ã€‚</p><p>é¦–å…ˆï¼Œå½“å€Ÿè´·/å¢åŠ æŠµæŠ¼ç‰©æ—¶ï¼ŒæŠµæŠ¼ç‰©ä¸ºdink &gt;=0, è´·æ¬¾dart &gt;0ã€‚è´·æ¬¾ä»·å€¼ä¸ºdart * rateï¼ŒæŠµæŠ¼ç‰©ä»·å€¼ä¸ºdink * spotã€‚å€Ÿè´·éœ€è¦æ»¡è¶³çš„æ¡ä»¶å¦‚ä¸‹</p><ul><li><p>è´·æ¬¾ä»·å€¼ &lt; å€ºåŠ¡ä¸Šé™line, ä¸”è¯¥æŠµæŠ¼ç‰©çš„æ€»è´·æ¬¾ä»·å€¼&lt;Lineä¸Šé™</p></li><li><p>è´·æ¬¾ä»·å€¼ &lt;= æŠµæŠ¼ç‰©ä»·å€¼ï¼Œè¿™é‡Œç†è§£ä¸€ä¸‹rateï¼Œå½“rate &gt; 1ï¼Œå…¶å®å°±æ˜¯è¯´å¯è´·çš„dartå…¶å®æ˜¯å°äºçœŸæ­£æŠµæŠ¼ç‰©ä»·å€¼çš„ï¼Œç”¨æ¥è°ƒæ§é£é™©ã€‚</p></li><li><p>uä¸ºè°ƒç”¨è€…ï¼Œæˆ–è€…è°ƒç”¨è€…æ˜¯uçš„ä¸‹å±‚æˆæƒç®¡ç†ï¼ˆuæˆæƒxä»¥æ“ä½œå…¶cdpï¼‰</p></li><li><p>è´·æ¬¾ä»·å€¼ &gt; å€ºåŠ¡ä¸‹é™ dust</p></li></ul><p>å½“æ¡ä»¶åˆ¤æ–­å®Œæ¯•åï¼Œè¿›è¡Œæ‰£é™¤/èµå›æŠµæŠ¼ç‰©(gem)ï¼Œå€Ÿå‡º/å¿è¿˜daiã€‚</p><h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function bite(bytes32 ilk, address urn) external returns (uint id) &#123;</span><br><span class="line">       VatLike.Ilk memory i = vat.ilks(ilk);</span><br><span class="line">       VatLike.Urn memory u = vat.urns(ilk, urn);</span><br><span class="line"></span><br><span class="line">       require(live == 1);</span><br><span class="line">       //è§¦å‘æ¸…ç®—è¦æ±‚ï¼Œä¸ªäººæŠµæŠ¼å“ * å…·æœ‰å®‰å…¨è¾¹é™…çš„æŠµæŠ¼å“ä»·æ ¼ &lt; ä¸ªäººå€ºåŠ¡ * ç¨³å®šå€ºåŠ¡ä¹˜æ•°(ç¨³å®šå€ºåŠ¡)</span><br><span class="line">       //å³æŠµæŠ¼å“ä»·æ ¼ä¸‹é™åˆ°ä¸€å®šç¨‹åº¦åï¼Œè§¦å‘æ¸…ç®—</span><br><span class="line">       require(mul(u.ink, i.spot) &lt; mul(u.art, i.rate));</span><br><span class="line">       //å–ä¸ªäººæŠµæŠ¼å“å’Œä»»ä½•ä¸€æ¬¡æ¸…ç®—äº‹ä»¶æ‰€æ¶µç›–çš„å›ºå®šå€ºåŠ¡æ•°é‡çš„å°å€¼</span><br><span class="line">       uint lot = min(u.ink, ilks[ilk].lump);</span><br><span class="line">       //å–ä¸ªäººå€ºåŠ¡ å’Œ æŠµæŠ¼å“ * å€ºåŠ¡ / æŠµæŠ¼å“çš„ å°å€¼</span><br><span class="line">       uint art = min(u.art, mul(lot, u.art) / u.ink);</span><br><span class="line">       //å€ºåŠ¡ * ç¨³å®šå€ºåŠ¡ä¹˜æ•°(ç¨³å®šå€ºåŠ¡)</span><br><span class="line">       uint tab = mul(art, i.rate);</span><br><span class="line"></span><br><span class="line">       require(lot &lt;= 2**255 &amp;&amp; art &lt;= 2**255);</span><br><span class="line">       //æ¸…ç®—ï¼Œå°†ä¸ªäººæŠµæŠ¼å“å‡æ‰ï¼Œä¸ªäººå€ºåŠ¡ä¹Ÿå‡æ‰,å°†å‡æ‰çš„æŠµæŠ¼å“è½¬ç§»åˆ°æœ¬åœ°å€ä¸‹(gem)</span><br><span class="line">       vat.grab(ilk, urn, address(this), address(vow), -int(lot), -int(art));</span><br><span class="line">       //ç»“ç®—ï¼Ÿ</span><br><span class="line">       vow.fess(tab);</span><br><span class="line">       //è§¦å‘æ‹å–</span><br><span class="line">       id = Kicker(ilks[ilk].flip).kick(&#123; urn: urn</span><br><span class="line">                                        , gal: address(vow)</span><br><span class="line">                                        , tab: rmul(tab, ilks[ilk].chop) //æ‰€éœ€å€ºåŠ¡: daiå€ºåŠ¡ * æ¸…ç®—ç½šæ¬¾ / 10 ** 27</span><br><span class="line">                                        , lot: lot //æŠµæŠ¼å“</span><br><span class="line">                                        , bid: 0</span><br><span class="line">                                        &#125;);</span><br><span class="line"></span><br><span class="line">       emit Bite(ilk, urn, lot, art, tab, ilks[ilk].flip, id);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h5 id="example"><a href="#example" class="headerlink" title="example"></a>example</h5><p>è¡¥å……ï¼Œå€Ÿè´·çš„ç¬¬ä¸€æ­¥ï¼Œä¼šæœ‰ä¸€ä¸ªjoinåˆçº¦ï¼Œå°±æ˜¯å¸®å¿™ä¿ç®¡å¸/ä»£å¸ã€‚è°ƒç”¨joinæ–¹æ³•ï¼Œä¼šå°†å¸/ä»£å¸è½¬ç§»åˆ°æœ¬åˆçº¦åœ°å€ä¸‹ï¼Œç„¶åæœ¬åˆçº¦ä¼šè°ƒç”¨vat.slipæ–¹æ³•ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function join(address usr, uint wad) external note &#123;</span><br><span class="line">    require(int(wad) &gt;= 0);</span><br><span class="line">    vat.slip(ilk, usr, int(wad)); //gem[ilk][usr] = wad</span><br><span class="line">    require(gem.transferFrom(msg.sender, address(this), wad));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vat.init(&quot;gold&quot;);</span><br><span class="line">gemA = new GemJoin(address(vat), &quot;gold&quot;, address(gold));</span><br><span class="line">vat.file(&quot;gold&quot;, &quot;spot&quot;, ray(1 ether)); //ray: 10 ** 9</span><br><span class="line">vat.file(&quot;gold&quot;, &quot;line&quot;, rad(1000 ether)); //rad: 10 ** 27</span><br><span class="line">vat.file(&quot;Line&quot;,         rad(1000 ether));</span><br><span class="line">cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1 ether));</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">address urn = address(this);</span><br><span class="line">//è½¬ç§»å¸</span><br><span class="line">gemA.join(urn,                             500 ether);</span><br><span class="line">vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2.5 ether));</span><br><span class="line">vat.frob(&quot;gold&quot;, me, me, me, 40 ether, 100 ether);</span><br><span class="line">//å‡è®¾rateä¸º (10 ** 9)</span><br><span class="line">//å€Ÿè´·åˆ¤æ–­ï¼Œ 40 * (10 ** 18) * 2.5 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9),æ»¡è¶³æ¡ä»¶ï¼Œå¯å€Ÿè´·</span><br><span class="line">//vat.urn[gold][me]= ink(40)ï¼Œ art(100)</span><br><span class="line"></span><br><span class="line"> vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2 ether));  //æŠµæŠ¼ç‰©ä»·æ ¼ä¸‹é™</span><br><span class="line"> cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1.1 ether));</span><br><span class="line"> cat.file(&quot;gold&quot;, &quot;lump&quot;, 30 ether);</span><br><span class="line"></span><br><span class="line"> //æ¸…ç®—åˆ¤æ–­</span><br><span class="line"> uint auction = cat.bite(&quot;gold&quot;, address(this));</span><br><span class="line"> //40 * (10 ** 18) * 2 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9) å¾ˆæ˜æ˜¾ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œè§¦å‘æ¸…ç®—</span><br><span class="line"> //æ¸…ç®—lot=min(u.ink, ilks[ilk].lump) = 30 ether</span><br><span class="line"> // art = min(u.art, mul(lot, u.art) / u.ink); = 75 ether</span><br><span class="line"> //æ­¤æ—¶vat.urn[gold][me] = ink(10 ether), art(25 ether)</span><br><span class="line"> //tab = art * rate</span><br><span class="line"> //è§¦å‘æ‹å–kickä¸­tabä¸ºrmul(tab, ilks[ilk].chop)ï¼Œ (75 * (10 ** 18) * (10 ** 9)) * 1.1 * (10 ** 18) / 10 ** 27 = 82.5 * (10 ** 18) å³85 ether</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>dai</title>
      <link href="/2019/10/14/dai/"/>
      <url>/2019/10/14/dai/</url>
      
        <content type="html"><![CDATA[<h2 id="dai"><a href="#dai" class="headerlink" title="dai"></a>dai</h2><h4 id="åˆçº¦å­¦ä¹ "><a href="#åˆçº¦å­¦ä¹ " class="headerlink" title="åˆçº¦å­¦ä¹ "></a>åˆçº¦å­¦ä¹ </h4><p>ä»<a href="https://github.com/makerdao/dss">github</a>ä¸Šå…‹éš†ä¸‹æ¥æºç ã€‚ç›®å½•ç»“æ„ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">    â”œâ”€â”€ cat.sol   //é¢å‘ç”¨æˆ·çš„æ¸…ç®—CDPç½‘å…³åˆçº¦</span><br><span class="line">    â”œâ”€â”€ dai.sol   //Daiç¨³å®šå¸åˆçº¦</span><br><span class="line">    â”œâ”€â”€ end.sol  //</span><br><span class="line">    â”œâ”€â”€ flap.sol  //å½“ç³»ç»Ÿæœ‰ç›ˆä½™æ—¶ï¼Œè´Ÿè´£è´­ä¹°å’Œç‡ƒçƒ§MKR</span><br><span class="line">    â”œâ”€â”€ flip.sol</span><br><span class="line">    â”œâ”€â”€ flop.sol  //å½“ç³»ç»Ÿæœ‰åè´¦æ—¶ï¼Œè´Ÿè´£å‘è¡Œå’Œå‡ºå”®MKR</span><br><span class="line">    â”œâ”€â”€ join.sol  //è´Ÿè´£å‘è¡Œå’Œç‡ƒçƒ§DAIçš„é€‚é…å™¨(DAI? ETHæŠµæŠ¼å“ï¼Ÿ)</span><br><span class="line">    â”œâ”€â”€ jug.sol</span><br><span class="line">    â”œâ”€â”€ lib.sol</span><br><span class="line">    â”œâ”€â”€ pot.sol</span><br><span class="line">    â”œâ”€â”€ spot.sol</span><br><span class="line">    â”œâ”€â”€ test</span><br><span class="line">    â”œâ”€â”€ vat.sol  //CDPæ ¸å¿ƒå¼•æ“ï¼ŒDAIç³»ç»Ÿè®°è´¦</span><br><span class="line">    â””â”€â”€ vow.sol</span><br></pre></td></tr></table></figure><h4 id="åˆçº¦è¯æ±‡è¡¨"><a href="#åˆçº¦è¯æ±‡è¡¨" class="headerlink" title="åˆçº¦è¯æ±‡è¡¨"></a>åˆçº¦è¯æ±‡è¡¨</h4><h5 id="å¸¸ç”¨"><a href="#å¸¸ç”¨" class="headerlink" title="å¸¸ç”¨"></a>å¸¸ç”¨</h5><ul><li><code>guy</code>ï¼Œ<code>usr</code>ï¼šä¸€äº›åœ°å€</li><li><code>wad</code>ï¼šä¸€äº›æ•°é‡çš„æ ‡è®°ï¼Œé€šå¸¸ä½œä¸ºä¸€ä¸ªå›ºå®šç‚¹æ•´æ•°ï¼Œåè¿›åˆ¶ä½æ•°ä¸º10 ^ 18ã€‚</li><li><code>ray</code>ï¼šä¸€ä¸ªå›ºå®šä½æ•°æ•´æ•°ï¼Œåè¿›åˆ¶ä½æ•°ä¸º10 ^ 27ã€‚</li><li><code>rad</code>ï¼šä¸€ä¸ªå›ºå®šä½æ•°æ•´æ•°ï¼Œåè¿›åˆ¶ä½æ•°ä¸º10 ^ 45ã€‚</li><li><code>file</code>ï¼šç®¡ç†ä¸€äº›é…ç½®å€¼</li></ul><h5 id="è®¤è¯-auth"><a href="#è®¤è¯-auth" class="headerlink" title="è®¤è¯(auth)"></a>è®¤è¯(auth)</h5><ul><li><code>auth</code>ï¼šæ£€æŸ¥åœ°å€æ˜¯å¦å¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•</li><li><code>ward</code>ï¼šå…è®¸è°ƒç”¨authedæ–¹æ³•çš„åœ°å€</li><li><code>rely</code>ï¼šå…è®¸ä¸€ä¸ªåœ°å€è°ƒç”¨authedæ–¹æ³•ï¼Œæˆ–å°†ä¸€ä¸ªåœ°å€æ·»åŠ åˆ°wardä¸­</li><li><code>deny</code>ï¼šç¦æ­¢ä¸€ä¸ªåœ°å€è°ƒç”¨authedæ–¹æ³•ï¼Œæˆ–å°†ä¸€ä¸ªåœ°å€ä»wardä¸­ç§»é™¤</li></ul><h5 id="CDPå¼•æ“-vat"><a href="#CDPå¼•æ“-vat" class="headerlink" title="CDPå¼•æ“ vat"></a>CDPå¼•æ“ vat</h5><ul><li><p><code>CDP</code>ï¼šæŠµæŠ¼å€ºåŠ¡ä½ç½®</p></li><li><p><code>gem</code>ï¼šæŠµæŠ¼ä»£å¸ï¼Œæ•°æ®ç±»å‹ä¸ºmap(byte32)map(address)uint256, æŸç±»å‹æŠµæŠ¼ä»£å¸ä¸‹æŸåœ°å€çš„æŠµæŠ¼ä¸ªæ•°</p></li><li><p><code>dai</code>ï¼šç¨³å®šä»£å¸</p></li><li><p><code>sin</code>ï¼šantioinä»¤ç‰Œï¼ˆç³»ç»Ÿå€ºåŠ¡ï¼Œä¸å±äºä»»ä½•<code>urn</code>ï¼‰</p></li><li><p><code>ilk</code>ï¼šæŠµæŠ¼å“ç±»å‹</p><ul><li><code>rate</code>ï¼šç¨³å®šå€ºåŠ¡ä¹˜æ•°ï¼ˆç´¯è®¡ç¨³å®šè´¹ï¼‰</li><li><code>take</code>ï¼šæŠµæŠ¼ä½™é¢ä¹˜æ•°</li><li><code>Ink</code>ï¼šæŠµæŠ¼å“æ€»ä½™é¢ ?ä»£ç é‡Œå¥½åƒæ²¡äº†</li><li><code>Art</code>ï¼šæ€»ç¨³å®šå€ºåŠ¡</li><li><code>spot</code>ï¼šå…·æœ‰å®‰å…¨è¾¹é™…çš„æŠµæŠ¼å“ä»·æ ¼ï¼Œå³æ¯å•ä½æŠµæŠ¼å“å…è®¸çš„æœ€å¤§ç¨³å®šå¸</li><li><code>line</code>ï¼šç‰¹å®šæŠµæŠ¼å“ç±»å‹çš„å€ºåŠ¡ä¸Šé™</li><li><code>dust</code>ï¼šCDPçš„æœ€ä½å¯èƒ½å€ºåŠ¡</li></ul></li><li><p><code>Line</code>ï¼šæ‰€æœ‰æŠµæŠ¼å“ç±»å‹çš„æ€»å€ºåŠ¡ä¸Šé™</p></li><li><p><code>init</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æŠµæŠ¼å“ç±»å‹</p></li><li><p><code>urn</code>ï¼šä¸€ä¸ªç‰¹å®šçš„CDP</p><ul><li><code>ink</code>ï¼šæŠµæŠ¼å“ä½™é¢</li><li><code>art</code>ï¼šæœªå¿è¿˜ç¨³å®šå€ºåŠ¡</li></ul></li><li><p><code>debt</code>ï¼šå‘è¡Œçš„ç¨³å®šå¸æ€»é‡</p></li><li><p><code>vice</code>ï¼šç³»ç»Ÿå€ºåŠ¡æ€»é‡</p></li><li><p><code>slip</code>ï¼šä¿®æ”¹ç”¨æˆ·çš„æŠµæŠ¼å“ä½™é¢(æ“ä½œgem)</p></li><li><p><code>flux</code>ï¼šåœ¨ç”¨æˆ·ä¹‹é—´è½¬ç§»æŠµæŠ¼å“(æ“ä½œgem)</p></li><li><p><code>move</code>ï¼šåœ¨ç”¨æˆ·ä¹‹é—´è½¬ç§»stablecoin</p></li><li><p><code>grab</code>ï¼šæ¸…ç®—CDPï¼Œ(åªåšè®°å½•ï¼Œè®°å½•ä¸ºæŠµæŠ¼ç‰©å‡å°‘(å¢åŠ )ï¼ŒæŠµæŠ¼å“ä½™é¢å¢åŠ (å‡å°‘)ï¼Ÿ)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function grab(bytes32 i, address u, address v, address w, int dink, int dart) external note auth &#123;</span><br><span class="line">      Urn storage urn = urns[i][u];</span><br><span class="line">      Ilk storage ilk = ilks[i];</span><br><span class="line"></span><br><span class="line">      urn.ink = add(urn.ink, dink);</span><br><span class="line">      urn.art = add(urn.art, dart);</span><br><span class="line">      ilk.Art = add(ilk.Art, dart);</span><br><span class="line"></span><br><span class="line">      int dtab = mul(ilk.rate, dart);</span><br><span class="line"></span><br><span class="line">      gem[i][v] = sub(gem[i][v], dink);</span><br><span class="line">      sin[w]    = sub(sin[w],    dtab);</span><br><span class="line">      vice      = sub(vice,      dtab);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p><code>heal</code>ï¼šåˆ›å»º/é”€æ¯ç­‰é‡çš„ç¨³å®šå¸å’Œç³»ç»Ÿå€ºåŠ¡ï¼ˆ<code>vice</code>ï¼‰</p></li><li><p><code>fold</code>ï¼šä¿®æ”¹å€ºåŠ¡ä¹˜æ•°ï¼Œåˆ›é€ /é”€æ¯ç›¸åº”çš„å€ºåŠ¡?</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function fold(bytes32 i, address u, int rate) external note auth &#123;</span><br><span class="line">      require(live == 1);</span><br><span class="line">      Ilk storage ilk = ilks[i];</span><br><span class="line">      ilk.rate = add(ilk.rate, rate);</span><br><span class="line">      int rad  = mul(ilk.Art, rate);</span><br><span class="line">      dai[u]   = add(dai[u], rad);</span><br><span class="line">      debt     = add(debt,   rad);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p><code>toll</code>ï¼šä¿®æ”¹æŠµæŠ¼å“ä¹˜æ•°ï¼Œåˆ›å»º/é”€æ¯ç›¸åº”çš„æŠµæŠ¼å“</p></li><li><p><code>suck</code>ï¼šé“¸é€ ç¨³å®šå¸ï¼ˆå æ¯”<code>vice</code>ï¼‰</p></li><li><p><code>frob</code>ï¼šä¿®æ”¹CDP</p><ul><li><code>lock</code>ï¼šå°†æŠµæŠ¼å“è½¬ç§»åˆ°CDP</li><li><code>free</code>ï¼šä»CDPè½¬ç§»æŠµæŠ¼å“</li><li><code>draw</code>ï¼šå¢åŠ CDPå€ºåŠ¡ï¼Œåˆ›é€ Dai</li><li><code>wipe</code>ï¼šå‡å°‘CDPå€ºåŠ¡ï¼Œæ‘§æ¯Dai</li><li><code>dink</code>ï¼šæŠµæŠ¼å“çš„å˜åŒ–</li><li><code>dart</code>ï¼šå€ºåŠ¡å˜åŠ¨</li><li><code>calm</code>ï¼šå½“CDPä»å¤„äºæŠµæŠ¼å“å’Œæ€»å€ºåŠ¡ä¸Šé™æ—¶ï¼Œè¿™æ˜¯çœŸçš„</li><li><code>cool</code>ï¼šå½“ç¨³å®šå€ºåŠ¡æ²¡æœ‰å¢åŠ æ—¶ï¼Œè¿™æ˜¯çœŸçš„</li><li><code>firm</code>ï¼šå½“æŠµæŠ¼å“ä½™é¢æ²¡æœ‰å‡å°‘æ—¶ä¸ºçœŸ</li><li><code>safe</code>ï¼šå½“CDPçš„æŠµæŠ¼å“ä¸å€ºåŠ¡æ¯”ç‡é«˜äºæŠµæŠ¼å“çš„æ¸…ç®—æ¯”ç‡æ—¶ä¸ºçœŸ</li></ul></li><li><p><code>fork</code>ï¼šæ‹†åˆ†CDP - äºŒè¿›åˆ¶æ‰¹å‡†æˆ–æ‹†åˆ†/åˆå¹¶CDP</p><ul><li><code>dink</code>ï¼šäº¤æ¢æŠµæŠ¼å“çš„æ•°é‡</li><li><code>dart</code>ï¼šäº¤æ¢çš„ç¨³å®šå€ºåŠ¡é‡‘é¢</li></ul></li><li><p><code>wish</code>ï¼šæ£€æŸ¥åœ°å€æ˜¯å¦å…è®¸ä¿®æ”¹å¦ä¸€ä¸ªåœ°å€çš„gemæˆ–daiä½™é¢</p><ul><li><code>hope</code>ï¼šå¯ç”¨<code>wish</code>ä¸€å¯¹åœ°å€</li><li><code>nope</code>ï¼šç¦ç”¨<code>wish</code>ä¸€å¯¹åœ°å€</li></ul></li></ul><h5 id="ç¨³å®šè´¹ç”¨-jug"><a href="#ç¨³å®šè´¹ç”¨-jug" class="headerlink" title="ç¨³å®šè´¹ç”¨ jug"></a>ç¨³å®šè´¹ç”¨ jug</h5><ul><li><code>duty</code>ï¼šç¨³å®šè´¹</li><li><code>base</code>ï¼šå…¨çƒç¨³å®šè´¹</li><li><code>rho</code>ï¼šæœ€åä¸€æ¬¡æ”¶é›†è¿™ç§æŠµæŠ¼å“æ—¶é—´</li><li><code>drip</code>ï¼šç¡®å®šå¢åŠ </li></ul><h5 id="æ¸…ç®—-cat"><a href="#æ¸…ç®—-cat" class="headerlink" title="æ¸…ç®— cat"></a>æ¸…ç®— cat</h5><ul><li><code>mat</code>ï¼šæ¸…ç®—æ¯”ç‡</li><li><code>chop</code>ï¼šæ¸…ç®—ç½šæ¬¾</li><li><code>lump</code>ï¼šæ¸…ç®—æ•°é‡ï¼Œå³ä»»ä½•ä¸€æ¬¡æ¸…ç®—äº‹ä»¶æ‰€æ¶µç›–çš„å›ºå®šå€ºåŠ¡æ•°é‡</li><li><code>bite</code>ï¼šå¼€å§‹æ¸…ç®—CDP</li><li><code>flip</code>ï¼šæ¸…ç®—CDPçš„æŠµæŠ¼å“ä»¥æ”¯ä»˜å›ºå®šæ•°é¢çš„å€ºåŠ¡</li></ul><h5 id="ç»“ç®—-vow"><a href="#ç»“ç®—-vow" class="headerlink" title="ç»“ç®— vow"></a>ç»“ç®— vow</h5><ul><li><code>sin</code>ï¼šå€ºåŠ¡é˜Ÿåˆ—</li><li><code>Sin</code>ï¼šé˜Ÿåˆ—ä¸­çš„æ€»å€ºåŠ¡</li><li><code>Woe</code>ï¼šéæ’é˜Ÿçš„éæ‹å–å€ºåŠ¡æ€»é¢</li><li><code>Ash</code>ï¼šæ‹å–æ€»å€ºåŠ¡</li><li><code>Awe</code>ï¼šå€ºåŠ¡æ€»é¢</li><li><code>Joy</code>ï¼šæ€»ç›ˆä½™</li><li><code>fess</code>ï¼šå‘é˜Ÿåˆ—æ·»åŠ å€ºåŠ¡</li><li><code>flog</code>ï¼šä»é˜Ÿåˆ—ä¸­å®ç°å€ºåŠ¡</li><li><code>wait</code>ï¼šé˜Ÿåˆ—çš„é•¿åº¦</li><li><code>heal</code>ï¼šå–æ¶ˆç›ˆä½™å’Œå€ºåŠ¡</li><li><code>kiss</code>ï¼šå–æ¶ˆç›ˆä½™å’Œæ‹å–å€ºåŠ¡</li><li><code>sump</code>ï¼šå€ºåŠ¡æ‹å–æ‰‹æ•°ï¼Œå³ä»»ä½•ä¸€æ¬¡å€ºåŠ¡æ‹å–æ‰€æ¶µç›–çš„å›ºå®šå€ºåŠ¡æ•°é‡</li><li><code>bump</code>ï¼šå‰©ä½™æ‹å–æ‰‹æ•°ï¼Œå³ä»»ä½•ä¸€æ¬¡å‰©ä½™æ‹å–æ‰€å‡ºå”®çš„å›ºå®šå‰©ä½™æ•°é‡</li><li><code>hump</code>ï¼šåœ¨å‰©ä½™æ‹å–å¯èƒ½ä¹‹å‰å¿…é¡»è¶…è¿‡å‰©ä½™ç¼“å†²</li></ul><h5 id="æ‹å–-flop-flip-flap"><a href="#æ‹å–-flop-flip-flap" class="headerlink" title="æ‹å– flop flip flap"></a>æ‹å– flop flip flap</h5><ul><li><code>flip</code>ï¼šæŠµæŠ¼å“æ‹å–ï¼ˆä½¿ç”¨ç¨³å®šå¸è¿›è¡Œäº¤æ˜“ï¼Ÿï¼‰</li><li><code>flop</code>ï¼šå€ºåŠ¡æ‹å–ï¼ˆé€šè¿‡è†¨èƒ€MKRå’Œå‡ºå”®ç¨³å®šå¸æ¥å¿è¿˜å€ºåŠ¡)(ä»¥ç¨³å®šå¸è´­ä¹°MKRï¼Ÿ)</li><li><code>flap</code>ï¼šå‰©ä½™æ‹å–ï¼ˆå‡ºå”®MKRçš„ç¨³å®šå¸)ï¼ˆä»¥MKRæ¥è´­ä¹°ç¨³å®šå¸ï¼‰</li><li><code>lot</code>ï¼šæ‹å–æ•°é‡</li><li><code>bid</code>ï¼šæä¾›çš„æ•°é‡ <code>lot</code></li><li><code>tab</code>ï¼šæ€»daiå°†è¢«æé«˜ï¼ˆ<code>flip</code>æ‹å–ä¸­ï¼‰</li><li><code>guy</code>ï¼šé«˜å‡ºä»·è€…</li><li><code>gal</code>ï¼šæ‹å–æ”¶å…¥çš„è·å¾—è€…</li><li><code>ttl</code>ï¼šå‡ºä»·ç»ˆèº«</li><li><code>beg</code>ï¼šæœ€ä½å‡ºä»·å¢åŠ </li><li><code>tau</code>ï¼šæœ€é•¿æ‹å–æ—¶é—´</li><li><code>end</code>ï¼šæ‹å–ç»“æŸæ—¶</li><li><code>kick</code>ï¼šå¼€å§‹æ‹å–</li><li><code>tick</code>ï¼šé‡æ–°å¼€å§‹æ‹å–</li><li><code>tend</code>ï¼šå‡ºä»·ï¼Œå¢åŠ å‡ºä»·å¤§å°</li><li><code>dent</code>ï¼šå‡ºä»·ï¼Œå‡å°‘æ‰‹æ•°</li><li><code>deal</code>ï¼šè¦æ±‚ä¸­æ ‡</li></ul><h5 id="å…¨çƒç»“ç®—-end"><a href="#å…¨çƒç»“ç®—-end" class="headerlink" title="å…¨çƒç»“ç®—  end"></a>å…¨çƒç»“ç®—  end</h5><ul><li><code>when</code>ï¼šç»“ç®—æ—¶é—´</li><li><code>wait</code>ï¼šå¤„ç†å†·å´æ—¶é—´é•¿åº¦ï¼ˆå…è®¸ä¸è¶³çš„CDPä¸º<code>skim</code>medï¼‰</li><li><code>debt</code>ï¼šåœ¨ç³»ç»Ÿç›ˆä½™/èµ¤å­—è¢«å¸æ”¶åï¼Œå‡ºè‰²çš„ç¨³å®šä¾›åº”é‡</li><li><code>tag</code>ï¼šç»“ç®—æ—¶æ¯ç§æŠµæŠ¼å“çš„ä»·æ ¼</li><li><code>gap</code>ï¼šè€ƒè™‘åˆ°ä¸åˆæ ‡å‡†çš„CDPï¼Œæ¯ä¸ªæŠµæŠ¼å“çš„å·®é¢</li><li><code>fix</code>ï¼šç°é‡‘ä»·æ ¼<code>ilk</code>ï¼ˆæ¯ç¨³å®šé‡‘é¢ï¼‰</li><li><code>bag</code>ï¼šæ— æ³•è½¬ç§»çš„ç¨³å®šå¸å‡†å¤‡äº¤æ¢æŠµæŠ¼å“</li><li><code>out</code>ï¼šå·²äº¤æ¢çš„ç»™å®šåœ°å€çš„ç¨³å®šå¸çš„æ•°é‡</li><li><code>cage</code>ï¼šå†»ç»“ç³»ç»Ÿï¼Œå–æ¶ˆ<code>flip</code>/ <code>flop</code>æ‹å–ï¼Œå¼€å§‹å†·å´æœŸ</li><li><code>cage(ilk)</code>ï¼šè®¾å®šç»“ç®—ä»·æ ¼</li><li><code>skim</code>ï¼šå–æ¶ˆCDPå€ºåŠ¡ï¼Œå–å¾—æŠµæŠ¼æ‹…ä¿ï¼Œä½†ç•™ä¸‹è¿‡å‰©</li><li><code>skip</code>ï¼šå¯é€‰æ‹©å–æ¶ˆç°åœºæ‹å–</li><li><code>free</code>ï¼šä»CDPä¸­åˆ é™¤æŠµæŠ¼å“</li><li><code>thaw</code>ï¼šä¿®å¤äº†ç¨³å®šå¸çš„æ€»ä¾›åº”é‡</li><li><code>flow</code>ï¼šè®¡ç®—<code>fix</code>åŒç±»äº§å“çš„ä»·æ ¼ï¼Œå¯èƒ½<code>cage</code>ç”¨ç›ˆä½™/èµ¤å­—è°ƒæ•´ä»·æ ¼</li><li><code>pack</code>ï¼šæŠŠä¸€äº›ç¨³å®šçš„é‡‘å¸æ”¾å…¥<code>bag</code>å‡†å¤‡ä¸­<code>cash</code></li><li><code>cash</code>ï¼šäº¤æ¢ä¸€äº›<code>bag</code>ç»™å®šçš„ç¨³å®šå¸<code>gem</code>ï¼Œä¸<code>bag</code>å¤§å°æˆæ¯”ä¾‹çš„ä»½é¢</li></ul><h4 id="åŸºæœ¬çŸ¥è¯†ç‚¹"><a href="#åŸºæœ¬çŸ¥è¯†ç‚¹" class="headerlink" title="åŸºæœ¬çŸ¥è¯†ç‚¹"></a>åŸºæœ¬çŸ¥è¯†ç‚¹</h4><h5 id="ç”¨æˆ·ç±»å‹"><a href="#ç”¨æˆ·ç±»å‹" class="headerlink" title="ç”¨æˆ·ç±»å‹"></a>ç”¨æˆ·ç±»å‹</h5><p>Maker ä¸»è¦æœ‰ä¸‰ç§ user caseã€‚ä½œä¸ºæ™®é€šæƒ³ä½¿ç”¨ç¨³å®šè´§å¸çš„äººï¼Œä»–ä»¬å¯ä»¥åœ¨äº¤æ˜“æ‰€ç”¨ç¾å…ƒæˆ–è€…äººæ°‘å¸è´­ä¹° DAIï¼Œç„¶åç”¨æ¥äº¤æ˜“ã€æ”¯ä»˜ç”šè‡³ç«çŒœã€‚</p><p>ç¬¬äºŒä¸ªæ˜¯æ¯”è¾ƒé«˜çº§çš„ç”¨æˆ·ï¼Œä»–ä»¬é”å®šè‡ªå·±çš„æŠµæŠ¼èµ„äº§ï¼Œå€Ÿ DAI è¿›è¡Œæ æ†äº¤æ˜“ã€‚</p><p>ç¬¬ä¸‰ä¸ªæ˜¯æ›´æ·±å‚ä¸ç³»ç»Ÿä¸­çš„ç”¨æˆ·ï¼Œä»–ä»¬æŒæœ‰ MKR ç®¡ç†å‹è´§å¸ï¼Œç»´æŠ¤ç³»ç»Ÿï¼ŒåŒæ—¶å¦‚æœç®¡ç†å¾—å½“è·ç›Šã€‚</p><h5 id="è´§å¸"><a href="#è´§å¸" class="headerlink" title="è´§å¸"></a>è´§å¸</h5><p>åœ¨ Maker ä½“ç³»ä¸­æœ‰ä¸¤ç§ä¸»è¦çš„è´§å¸ã€‚ç¬¬ä¸€ä¸ªæ˜¯ DAIï¼Œç¨³å®šè´§å¸ã€‚ä»–æ˜¯ä¸€ç§æœ‰èµ„äº§èƒŒä¹¦çš„ç¡¬é€šè´§ï¼Œåœ¨æ— éœ€å‡†è®¸çš„ä¿¡è´·ç³»ç»Ÿä¸­ç”Ÿæˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•ç”¨æˆ·å¯ä»¥é”å®šä»–ä»¬æœ‰ä»·å€¼çš„æ•°å­—èµ„äº§ï¼Œç„¶åç”Ÿæˆ DAIã€‚ç³»ç»Ÿç”¨åŠ¨æ€çš„ç›®æ ‡åˆ©ç‡å»è°ƒèŠ‚ DAI çš„ä»·æ ¼ã€‚åœ¨ç¬¬ä¸€ç‰ˆ DAI é‡Œï¼Œæˆ‘ä»¬ä¼šä¿æŒ DAI çš„ä»·æ ¼åœ¨ 1ï¼š1 ç¾å…ƒå·¦å³æµ®åŠ¨ã€‚</p><p>ç¬¬äºŒç§ä»£å¸æ˜¯ MKRï¼Œä¹Ÿå°±æ˜¯ Makerã€‚MKR æ˜¯ç®¡ç†å‹ä»£å¸ã€‚æ‹¥æœ‰ MKR çš„ç”¨æˆ·ç»„æˆä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„ç®¡ç†ç¤¾åŒºï¼Œä»–ä»¬å†³å®šå“ªç§æœ‰ä»·å€¼çš„æ•°å­—èµ„äº§å¯ä»¥ä½œä¸ºæŠµæŠ¼èµ„äº§ï¼Œæ¸…ç®—æ¯”ä¾‹ç­‰ç­‰ã€‚ä½œä¸ºå¯¹ä»–ä»¬æœåŠ¡çš„å›æŠ¥ï¼Œå½“ç”¨æˆ·èµå›æŠµæŠ¼ç‰©çš„æ—¶å€™ï¼Œä»–ä»¬ä¸ä»…è¦è¿”è¿˜ DAIï¼Œè¿˜è¦åŠ ä¸Šä¸€å°éƒ¨åˆ†è´¹ç”¨ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†è´¹ç”¨ä¼šè¢«ç”¨æ¥è´­ä¹°å¹¶é”€æ¯ MKR ä»¥å…³é—­æŠµæŠ¼å€ºä»“ã€‚ä¹Ÿå°±æ˜¯è¯´ MKR æ˜¯ä¿¡è´·ç³»ç»Ÿçš„ç‡ƒæ–™ã€‚</p><h5 id="ä¿¡è´·ç³»ç»Ÿ"><a href="#ä¿¡è´·ç³»ç»Ÿ" class="headerlink" title="ä¿¡è´·ç³»ç»Ÿ"></a>ä¿¡è´·ç³»ç»Ÿ</h5><p>ç”¨æˆ·å¦‚æœè¦å€Ÿ DAIï¼Œä»–ä»¬é¦–å…ˆè¦å»ºç«‹ä¸€ä¸ªæŠµæŠ¼å€ºä»“ï¼ˆCDPï¼‰ï¼Œç„¶åå°†æ•°å­—èµ„äº§ä½œä¸ºæŠµæŠ¼ç‰©ï¼Œç”Ÿæˆ DAIã€‚ç„¶åä»–å¯ä»¥ç”¨ DAI å»åšå¤šä»–çœ‹å¥½çš„èµ„äº§ã€‚æœ€åä¹°å› DAIï¼Œå¿è¿˜ DAI å’Œä¸€éƒ¨åˆ†è´¹ç”¨æ‹¿å›æŠµæŠ¼èµ„äº§ã€‚</p><p>æˆ‘ä»¬åœ¨è¿™å¼ å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒæŠµæŠ¼ç‰©çš„ä»·å€¼å§‹ç»ˆå¤§äº DAI çš„ä»·å€¼ã€‚è¿™æ˜¯å› ä¸ºæŠµæŠ¼ç‰©çš„ä»·å€¼ä¼šæœ‰æ³¢åŠ¨ï¼Œæˆ‘ä»¬è¦ç¡®ä¿ DAI æœ‰è¶³å¤Ÿçš„æŠµæŠ¼ã€‚å¦‚æœæŠµæŠ¼ç‰©å‡å€¼å¹¶æ²¡æœ‰å¤ªå¤§å½±å“ï¼Œæ„å‘³ç€ DAI æœ‰æ›´è¶³å¤Ÿçš„æŠµæŠ¼ã€‚ä½†æ˜¯å¦‚æœæŠµæŠ¼ç‰©å‡å€¼ï¼Œç³»ç»Ÿéœ€è¦å¯¹æ­¤åšå‡ºååº”ã€‚</p><p>å½“æŠµæŠ¼ç‰©ä»·å€¼ä½äºæ¸…ç®—å€¼ï¼ŒCDP ä¼šè¢«æ¸…ç®—ã€‚æŠµæŠ¼ç‰©ä¼šè¢«å¼ºåˆ¶å¹³ä»“ï¼Œç”¨æ¥å›è´­ DAIï¼Œä»¥ä¿è¯ DAI çš„å¿ä»˜èƒ½åŠ›ã€‚å¯ä»¥æƒ³è±¡ä¸º margin call(è¿½åŠ ä¿è¯é‡‘)ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨è¿™ä¸€æ¬¡çš„å‘å¸ƒä¸­ï¼Œæˆ‘ä»¬ä¼šç”¨ä»€ä¹ˆä½œä¸ºæŠµæŠ¼èµ„äº§å‘¢ã€‚æˆ‘ä»¬å«åš pooled-ETHï¼Œä»¥å¤ªæ± ã€‚åœ¨ä¹‹åçš„å‘å¸ƒä¸­ï¼Œæˆ‘ä»¬ä¼šå¼•å…¥å¤šé‡èµ„äº§æŠµæŠ¼ã€‚ç›®å‰æˆ‘ä»¬è¿˜åœ¨å¼€å‘å¤šé‡èµ„äº§æŠµæŠ¼çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨è¿™ä¸€æ¬¡çš„å‘å¸ƒä¸­ï¼Œæˆ‘ä»¬ç”¨ä»¥å¤ªæ± ä½œä¸ºæŠµæŠ¼ä»£å¸ã€‚</p><p>ä»–çš„è¿è¡Œæœºåˆ¶æ˜¯ï¼šç”¨æˆ·é¦–å…ˆå°† ETH æ”¾å…¥åˆåŒä¸­ï¼Œç„¶åå›æ”¶åˆ°ç›¸åº”æ¯”ä¾‹çš„ ETH å…‘æ¢å‡­è¯ï¼ŒPETHã€‚èµ·åˆï¼ŒPETH å’Œ ETH çš„æ¯”ä¾‹æ˜¯ä¸€æ¯”ä¸€ã€‚ä½†æ˜¯è¿™ä¸€æ¯”ä¾‹ä¼šéšç€ç³»ç»Ÿçš„è¡¨ç°è€Œæ”¹å˜ã€‚</p><p>å¦‚æœç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œæ‰€æœ‰çš„ CDP åœ¨å¿è¿˜æ—¶ä¼šä¸æ–­äº§ç”Ÿè´¹ç”¨ã€‚ä¸€éƒ¨åˆ†è´¹ç”¨ä¼šè¢«ç”¨æ¥å›è´­å’Œé”€æ¯ PETHã€‚é”€æ¯ PETH æ„å‘³ç€å‰©ä¸‹çš„ PETH å¯ä»¥å…‘æ¢æ›´å¤šçš„ ETHã€‚å¯¹äºå¤§å¤šæ•°ç”¨æˆ·æ¥è¯´ï¼Œä»–ä»¬ä¹Ÿè®¸ä¼šæŠµæŠ¼ PETHï¼Œç”¨æ¥å€Ÿ DAIï¼Œç„¶ååšå¤šèµ„äº§ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥é€‰æ‹©æŒæœ‰ PETHï¼Œè·å¾—è´¹ç”¨æ”¶ç›Šã€‚</p><p>å½“é»‘å¤©é¹…æ—¶é—´å‘ç”Ÿæ—¶ï¼ŒæŠµæŠ¼ç‰©çš„ä»·æ ¼å¤§å¹…åº¦ä¸‹é™ï¼Œç”šè‡³ä½äº DAI çš„ä»·æ ¼ï¼Œæ¸…ç®—æœºåˆ¶éƒ½æ¥ä¸åŠåº”å¯¹ã€‚è¿™æ—¶å€™ç³»ç»Ÿä¼šé€šè¿‡å¢å‘ PETH æ¥å›è´­ DAI ä»¥æ”¯æ’‘æŠµæŠ¼ä¸è¶³çš„ DAIã€‚</p><p>å½“ç”¨æˆ·å…³é—­ CDP æ—¶ï¼Œä¸€éƒ¨åˆ†è´¹ç”¨ä¼šç”¨æ¥å›è´­é”€æ¯ PETHï¼Œå¦ä¸€éƒ¨åˆ†è´¹ç”¨ä¼šç”¨æ¥è´­ä¹° MKRï¼Œä½œä¸ºç®¡ç†è´¹ç”¨ã€‚</p><h5 id="æ¸…ç®—æ“ä½œ"><a href="#æ¸…ç®—æ“ä½œ" class="headerlink" title="æ¸…ç®—æ“ä½œ"></a>æ¸…ç®—æ“ä½œ</h5><p><img src="https://img.chainnews.com/material/images/a527abfe7199a3eb00887ea7f13e8293.jpg" alt="img"></p><ul><li><p>è§¦å‘å‘ç”Ÿæ¸…ç®—</p><p>é¢„è¨€æœºæ ¹æ®ç°åœ¨ PETH çš„ä»·æ ¼åé¦ˆç»™ Maker å¹³å°ã€‚Makerå¹³å°éœ€è¦æŠµæŠ¼èµ„äº§çš„å®æ—¶ä»·æ ¼ä¿¡æ¯ä»¥å†³å®šä½•æ—¶è§¦åŠ¨æ¸…ç®—ã€‚ä¹Ÿå°±æ˜¯è¯´éœ€è¦çœ‹æˆ·æœºæ‹¿åˆ°è¿™ä¸ªä»·æ ¼ï¼Œæ ¹æ®è¿™ä¸ªä»·æ ¼æ˜¯å¦å‘ç”Ÿæ¸…ç®—ã€‚</p></li></ul><ul><li><p>å‘ç”Ÿæ¸…ç®—</p><p>å½“æ­¤æ—¶å‘ç”Ÿæ¸…ç®—äº†ï¼Œé¢„è¨€æœºè§¦å‘åé¦ˆç»™çœ‹æˆ·æœºï¼Œçœ‹æŠ¤æœºåœ¨ CDP æ¸…ç®—çš„æ—¶å€™å‚ä¸å€ºåŠ¡æ‹å–å’ŒæŠµæŠ¼èµ„äº§æ‹å– ã€‚çœ‹æŠ¤æœºä¹Ÿä¼šå›´ç»•ç›®æ ‡ä»·æ ¼äº¤æ˜“ Daiã€‚å½“å¸‚åœºä»·æ ¼é«˜äºç›®æ ‡ä»·æ ¼çš„æ—¶å€™ï¼Œçœ‹æŠ¤æœºå°†å‡ºå”® Dai ã€‚åŒç†ï¼Œå½“å¸‚åœºä»·æ ¼ä½äºç›®æ ‡ä»·æ ¼çš„æ—¶å€™ï¼Œçœ‹æŠ¤æœºå°†ä¹°å…¥ Daiã€‚è¿™æ ·åšçš„æ˜¯ä¸ºäº†ä»å¸‚åœºé•¿æœŸä»·æ ¼è¶‹åŒç›®æ ‡ä»·æ ¼ä¸­è·ç›Šã€‚æ³¨ï¼šçœ‹æˆ·æœºåªæ˜¯åšä¸€ä¸ªç­–ç•¥ï¼Œå®ƒå†³å®šä»€ä¹ˆæ—¶å€™è¿›è¡Œå‡ºå”®ã€‚å½“å‡ºå”®çš„æ—¶å€™ä»–ä¼šæ ¹æ®ç³»ç»Ÿå–‚ä»·ç›´æ¥ä¸ä»¥å¤ªåŠä½¿ç”¨è€…å’Œçœ‹æŠ¤æœºè¿›è¡Œäº¤æ˜“çš„æ™ºèƒ½åˆçº¦ã€‚å½“ CDP è¢«æ¸…ç®—ï¼Œç³»ç»Ÿä¼šç«‹å³å›æ”¶å…¶æŠµæŠ¼å“ã€‚CDP æŒæœ‰è€…ä¼šæ”¶åˆ°å»é™¤å€ºåŠ¡ã€ç¨³å®šè´¹ç”¨å’Œæ¸…ç®—ç½šé‡‘åçš„å‰©ä½™æŠµæŠ¼èµ„äº§ã€‚è¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>ç¬¬ä¸€ç§ï¼Œæ­£å¸¸æƒ…å†µ</p><p>PETH æŠµæŠ¼èµ„äº§å°†ä¼šåœ¨æµåŠ¨æ€§ä¾›ç»™åˆçº¦ä¸­å‡ºå”®ï¼Œçœ‹æŠ¤æœºå¯ä»¥è‡ªåŠ¨äº¤æ˜“ Dai è´­ä¹° PETHã€‚æ‰€æœ‰æ”¯ä»˜çš„ Daiä¼šä»æµé€šä¸­ç«‹å³é”€æ¯ï¼Œç›´åˆ° CDP å€ºåŠ¡æ•°é‡è¢«æ¶ˆé™¤ã€‚å¦‚æœåœ¨å»é™¤ CDP å€ºåŠ¡åè¿˜æœ‰å‰©ä½™çš„ Daiï¼Œè¿™éƒ¨åˆ† Daiä¼šè¢«ç”¨æ¥è´­ä¹°å¹¶é”€æ¯ PETHï¼Œä»è€Œæé«˜ PETH å¯å…‘æ¢ ETH çš„æ¯”ä¾‹ã€‚è¿™å¯¹ PETH æŒæœ‰è€…æ¥è¯´å°†ä¼šæ˜¯æ”¶ç›Šã€‚</p></li><li><p>ç¬¬äºŒç§ï¼Œéæ­£å¸¸çš„æƒ…å†µä¸‹</p><p>å¦‚æœå‡ºå”®çš„ PETH æœªèƒ½å‹Ÿé›†åˆ°è¶³å¤Ÿçš„ Dai ä»¥å¿ä»˜æ•´ä¸ªå€ºåŠ¡ï¼Œç³»ç»Ÿä¼šè¿ç»­å¢å‘å¹¶å‡ºå”® PETHã€‚ä»¥è¿™ç§æ–¹å¼æ–°åˆ›é€ å‡ºæ¥çš„ PETH ä¼šé™ä½ PETH å¯å…‘æ¢ETH çš„æ¯”ä¾‹ï¼Œä»è€Œä½¿å¾— PETH æŒæœ‰è€…æ”¶ç›Šå‡å°‘ã€‚</p></li></ul><p>åœ¨æ¸…ç®—å‘ç”Ÿæ—¶ï¼ŒMaker å¹³å°ä¼šè´­ä¹° CDP ä¸­çš„æŠµæŠ¼ç‰©å¹¶é€æ¸é€šè¿‡è‡ªåŠ¨ç«å–çš„æ–¹å¼å”®å‡ºã€‚ç«å–çš„æœºåˆ¶å¯ä»¥è®©ç³»ç»Ÿå³ä½¿åœ¨æ— æ³•è·å¾—ä»·æ ¼ä¿¡æ¯çš„æ—¶å€™ï¼Œå¤„ç† CDPã€‚ä¸ºäº†èƒ½å¤Ÿå›è´­ CDP ä¸­çš„æŠµæŠ¼èµ„äº§å¹¶ç”¨æ¥å‡ºå”®ï¼Œç³»ç»Ÿä¼šé¦–å…ˆå‹Ÿé›†è¶³å¤Ÿçš„ Dai ä»¥å¿ä»˜ CDP çš„å€ºåŠ¡ã€‚è¿™ä¸€è¿‡ç¨‹å«åšå€ºåŠ¡ç«å–ï¼Œé€šè¿‡å¢å‘ MKRçš„ä¾›ç»™å¹¶ä»¥ç«å–çš„æ–¹å¼å‡ºå”®ç»™ç«å–å‚ä¸è€…ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼ŒCDP ä¸­çš„æŠµæŠ¼èµ„äº§ä¼šä»¥æŠµæŠ¼èµ„äº§ç«å–çš„æ–¹å¼å‡ºå”®ï¼ŒCDP å€ºåŠ¡å’Œæ¸…ç®—ç½šé‡‘çš„éƒ¨åˆ†ä¼šç”¨æ¥å›è´­å¹¶é”€æ¯ MKRã€‚è¿™å¯ä»¥ç›´æ¥æŠµé”€åœ¨å€ºåŠ¡ç«å–ä¸­å¢å‘çš„MKRã€‚å¦‚æœæœ‰è¶³å¤Ÿçš„ Dai ç”¨æ¥å¿ä»˜ CDP ä¸­çš„å€ºåŠ¡åŠ ä¸Šæ¸…ç®—ç½šé‡‘ï¼Œé‚£ä¹ˆæŠµæŠ¼ç«å–ä¼šè½¬æ¢åˆ°åå‘ç«å–æœºåˆ¶ï¼Œç«å–æœ€å°‘çš„æŠµæŠ¼å“ - ä»»ä½•å‰©ä½™çš„æŠµæŠ¼å“éƒ½ä¼šå½’è¿˜ç»™CDP çš„åŸæ‰€æœ‰è€…ã€‚</p></li></ul><ul><li><p>æµåŠ¨æ€§ä¾›ç»™åˆçº¦ (å•ä¸€æŠµæŠ¼é˜¶æ®µè¿‡æ¸¡æ€§æœºåˆ¶)</p><p>åœ¨å•ä¸€æŠµæŠ¼èµ„äº§ Dai çš„é˜¶æ®µï¼Œæ¸…ç®—çš„è¿‡ç¨‹å«åšæµåŠ¨æ€§ä¾›ç»™åˆçº¦ã€‚æ ¹æ®ç³»ç»Ÿå–‚ä»·ç›´æ¥ä¸ä»¥å¤ªåŠä½¿ç”¨è€…å’Œçœ‹æŠ¤æœºè¿›è¡Œäº¤æ˜“çš„æ™ºèƒ½åˆçº¦ã€‚å½“ CDPè¢«æ¸…ç®—ï¼Œç³»ç»Ÿä¼šç«‹å³å›æ”¶å…¶æŠµæŠ¼å“ã€‚CDP æŒæœ‰è€…ä¼šæ”¶åˆ°å»é™¤å€ºåŠ¡ã€ç¨³å®šè´¹ç”¨å’Œæ¸…ç®—ç½šé‡‘åçš„å‰©ä½™æŠµæŠ¼èµ„äº§ã€‚</p><p>PETH æŠµæŠ¼èµ„äº§å°†ä¼šåœ¨æµåŠ¨æ€§ä¾›ç»™åˆçº¦ä¸­å‡ºå”®ï¼Œçœ‹æŠ¤æœºå¯ä»¥è‡ªåŠ¨äº¤æ˜“ Dai è´­ä¹° PETHã€‚æ‰€æœ‰æ”¯ä»˜çš„ Dai ä¼šä»æµé€šä¸­ç«‹å³é”€æ¯ï¼Œç›´åˆ° CDPå€ºåŠ¡æ•°é‡è¢«æ¶ˆé™¤ã€‚å¦‚æœåœ¨å»é™¤ CDP å€ºåŠ¡åè¿˜æœ‰å‰©ä½™çš„ Daiï¼Œè¿™éƒ¨åˆ† Dai ä¼šè¢«ç”¨æ¥è´­ä¹°å¹¶é”€æ¯ PETH ï¼Œä»è€Œæé«˜ PETH å¯å…‘æ¢ ETHçš„æ¯”ä¾‹ã€‚è¿™å¯¹ PETH æŒæœ‰è€…æ¥è¯´å°†ä¼šæ˜¯æ”¶ç›Šã€‚</p><p>å¦‚æœå‡ºå”®çš„ PETH æœªèƒ½å‹Ÿé›†åˆ°è¶³å¤Ÿçš„ Dai ä»¥å¿ä»˜æ•´ä¸ªå€ºåŠ¡ï¼Œç³»ç»Ÿä¼šè¿ç»­å¢å‘å¹¶å‡ºå”® PETHã€‚ä»¥è¿™ç§æ–¹å¼æ–°åˆ›é€ å‡ºæ¥çš„ PETH ä¼šé™ä½ PETH å¯å…‘æ¢ETH çš„æ¯”ä¾‹ï¼Œä»è€Œä½¿å¾— PETH æŒæœ‰è€…æ”¶ç›Šå‡å°‘ã€‚</p></li></ul><ul><li><p>å€ºåŠ¡ç«å–å’ŒæŠµæŠ¼èµ„äº§ç«å–ï¼ˆå¤šç§æŠµæŠ¼é˜¶æ®µæœºåˆ¶ï¼‰</p><p>åœ¨æ¸…ç®—å‘ç”Ÿæ—¶ï¼ŒMaker å¹³å°ä¼šè´­ä¹° CDP ä¸­çš„æŠµæŠ¼ç‰©å¹¶é€æ¸é€šè¿‡è‡ªåŠ¨ç«å–çš„æ–¹å¼å”®å‡ºã€‚</p><p>ç«å–çš„æœºåˆ¶å¯ä»¥è®©ç³»ç»Ÿå³ä½¿åœ¨æ— æ³•è·å¾—ä»·æ ¼ä¿¡æ¯çš„æ—¶å€™ï¼Œå¤„ç† CDPã€‚ä¸ºäº†èƒ½å¤Ÿå›è´­ CDP ä¸­çš„æŠµæŠ¼èµ„äº§å¹¶ç”¨æ¥å‡ºå”®ï¼Œç³»ç»Ÿä¼šé¦–å…ˆå‹Ÿé›†è¶³å¤Ÿçš„ Dai ä»¥å¿ä»˜ CDP çš„å€ºåŠ¡ã€‚è¿™ä¸€è¿‡ç¨‹å«åšå€ºåŠ¡ç«å–ï¼Œé€šè¿‡å¢å‘ MKRçš„ä¾›ç»™å¹¶ä»¥ç«å–çš„æ–¹å¼å‡ºå”®ç»™ç«å–å‚ä¸è€…ã€‚ä¸æ­¤åŒæ—¶ï¼ŒCDP ä¸­çš„æŠµæŠ¼èµ„äº§ä¼šä»¥æŠµæŠ¼èµ„äº§ç«å–çš„æ–¹å¼å‡ºå”®ï¼ŒCDP å€ºåŠ¡å’Œæ¸…ç®—ç½šé‡‘çš„éƒ¨åˆ†ä¼šç”¨æ¥å›è´­å¹¶é”€æ¯ MKR ã€‚è¿™å¯ä»¥ç›´æ¥æŠµé”€åœ¨å€ºåŠ¡ç«å–ä¸­å¢å‘çš„ MKRã€‚å¦‚æœæœ‰è¶³å¤Ÿçš„ Dai ç”¨æ¥å¿ä»˜ CDP ä¸­çš„å€ºåŠ¡åŠ ä¸Šæ¸…ç®—ç½šé‡‘ï¼Œé‚£ä¹ˆæŠµæŠ¼ç«å–ä¼šè½¬æ¢åˆ°åå‘ç«å–æœºåˆ¶ï¼Œç«å–æœ€å°‘çš„æŠµæŠ¼å“ - ä»»ä½•å‰©ä½™çš„æŠµæŠ¼å“éƒ½ä¼šå½’è¿˜ç»™ CDPçš„åŸæ‰€æœ‰è€…ã€‚</p></li></ul><ul><li><p>æ¸…ç®—æœŸé—´ä¼šå‘ç”Ÿä»€ä¹ˆ</p><p>å½“ Keeper å…³é—­ CDP å¹¶å°†å…¶å‘é€åˆ°æµåŠ¨æ€§æä¾›åˆåŒï¼ˆLPCï¼‰æ—¶ï¼Œæ¸…ç®—å°±ä¼šå‘ç”Ÿï¼Œè€Œ LPC åˆä¼šåœ¨ Dai Dashboard ä¸Šæä¾› CDPèµ„äº§ã€‚ä¸€æ—¦å±¥è¡Œäº†å€ºåŠ¡ä¹‰åŠ¡ï¼Œæœªå”®å‡ºçš„ PETH æŠµæŠ¼å“å°†è¿”è¿˜ç»™ CDP æ‰€æœ‰è€…ã€‚</p><p>æ“ä½œé¡ºåºå¦‚ä¸‹ï¼š</p><ul><li>è¿çº¦çš„ CDP å·²å…³é—­ã€‚</li><li>ç½šæ¬¾è´¹ç”¨é€‚ç”¨äº DAI å€ºåŠ¡ã€‚</li><li>LPC ç§»é™¤äº†è¶³å¤Ÿçš„ PETH æŠµæŠ¼å“ä»¥æ»¡è¶³å½“å‰ Oracle ä»·æ ¼çš„å€ºåŠ¡ã€‚</li><li>CDP æ‰€æœ‰è€…ç°åœ¨èƒ½å¤Ÿä»å…³é—­ä½ç½®ç§»é™¤ä»–ä»¬çš„å‰©ä½™æŠµæŠ¼å“ã€‚</li><li>è¢«æ‰£æŠ¼çš„ PETH åœ¨ dai.makerdao.com ä¸Šå‡ºå”®ï¼Œå…¶æ¿€åŠ±æŠ˜æ‰£ç§°ä¸º Boom / Bust Spread ï¼Œé€‚ç”¨äºè¯¥å€¼ã€‚</li><li>å‡ºå”® PETH æ‰€èµšå–çš„ DAI è¢«çƒ§æ¯ä»¥æ¶ˆç­ CDP å€ºåŠ¡ã€‚</li><li>å¦‚æœé”€å”®ä¸­å­˜åœ¨è¿‡é‡çš„ DAI ï¼Œé‚£ä¹ˆå®ƒå°†è¢« PETH å‡ºå”®ï¼Œç„¶åç‡ƒçƒ§ï¼Œä»è€Œå¢åŠ å‰©ä½™ PETH çš„ä»·å€¼ã€‚</li><li>å¦‚æœå‡ºå”®çš„ DAI ä¸è¶³ï¼Œé‚£ä¹ˆ PETH å°†è¢«å‘è¡Œå¹¶å‡ºå”®ä»¥å¼¥è¡¥ä¸è¶³ã€‚è¿™ä¼šç¨€é‡Šæ± çš„æ€»ä»·å€¼ã€‚</li></ul></li></ul><ul><li><p>æ¸…ç®—åå‰©ä½™å¤šå°‘æŠµæŠ¼å“</p><p>ç®€åŒ–å…¬å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆæŠµæŠ¼å“ Ã— Oracle ä»·æ ¼ Ã— PETH / ETH æ¯”ç‡ï¼‰ - ï¼ˆæ¸…ç®—ç½šæ¬¾ Ã— ç¨³å®šæ€§å€ºåŠ¡ï¼‰ - ç¨³å®šæ€§å€ºåŠ¡ =ï¼ˆå‰©ä½™æŠµæŠ¼å“ Ã—Oracle ä»·æ ¼ï¼‰ DAI</span><br></pre></td></tr></table></figure><p>å‡è®¾ï¼š</p><ul><li><p>ä¸€ä¸ª ETH çš„ Oracle ä»·æ ¼æ˜¯ 350USD</p></li><li><p>é”å®š PETH æ€»æ•°ä¸º 10 ETH</p></li><li><p>PETH / ETH çš„æ¯”ç‡ä¸º 1.012</p></li><li><p>æ¸…ç®—ç½šæ¬¾ä¸º 13ï¼…</p></li><li><p>CDP çš„ç¨³å®šå€ºåŠ¡ä¸º 1000 DAI</p><p>è®¡ç®—ä¸º(10 Ã— 350 Ã— 1.012) âˆ’ (13% Ã— 1000) âˆ’ 1000 = 2412 DAI æˆ– 6.891428571 ETH</p></li></ul></li></ul><ul><li><p>æ¸…ç®—ä»·æ ¼</p><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç®€åŒ–å…¬å¼æ¥ç¡®å®šæŠµæŠ¼å“çš„ä»·å€¼å¿…é¡»è¾¾åˆ°å¤šè¿œæ‰èƒ½è§¦å‘ç»“ç®—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆç¨³å®šå€ºåŠ¡ Ã— æ¸…ç®—æ¯”ç‡ï¼‰/ï¼ˆæŠµæŠ¼å“ Ã— PETH / ETH æ¯”ç‡ï¼‰= æ¸…ç®—ä»·æ ¼</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><ul><li><p>ä¸€ä¸ª ETH çš„å€¼æ˜¯ 350 USD</p></li><li><p>æ€»èµŒæ³¨ PETH ä¸º 12</p></li><li><p>PETH / ETH çš„æ¯”ç‡ä¸º 1.012</p></li><li><p>æ¸…ç®—æ¯”ç‡ä¸º 150ï¼…</p></li><li><p>ç¨³å®šå€ºåŠ¡æ˜¯ 1000 DAI</p><p>è®¡ç®—ä¸º(1000 Ã— 1.5) Ã· (12 Ã— 1.012) = 123.51 USD</p><p>åœ¨ CDP è¢«è®¤ä¸ºä¸å®‰å…¨å¹¶ä¸”æœ‰è¢«æ¸…ç®—çš„é£é™©ä¹‹å‰ï¼ŒETH çš„ä»·æ ¼éœ€è¦é™è‡³ 123.51 ç¾å…ƒã€‚</p></li></ul></li></ul><ul><li><p>è®¡ç®—æŠµæŠ¼æ¯”ç‡</p><p>å¦‚æœå¸Œæœ›é€šè¿‡æŸ¥çœ‹æŠµæŠ¼å“ä¸å€ºåŠ¡çš„æ¯”ç‡æ¥ç¡®å®šæŠµæŠ¼ç‰©çš„å¥åº·çŠ¶å†µï¼Œä¸æ¸…ç®—ä»·æ ¼ç›¸åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç®€åŒ–å…¬å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆé”å®š PETH Ã— ETH ä»·æ ¼ Ã— PETH / ETH æ¯”ç‡ï¼‰Ã· ç¨³å®šæ€§å€ºåŠ¡ Ã— 100 = æŠµæŠ¼æ¯”ç‡</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><ul><li>ä¸€ä¸ª ETH çš„å€¼æ˜¯ 350 USD</li><li>æ€»èµŒæ³¨ PETH ä¸º 12</li><li>PETH / ETH çš„æ¯”ç‡ä¸º 1.012</li><li>ç¨³å®šå€ºåŠ¡æ˜¯ 1000 DAI</li></ul><p>è®¡ç®—ä¸º(12 Ã— 350 Ã— 1.012) Ã· 1000 Ã— 100 = 425.04%</p><p>CDP çš„æŠµæŠ¼æ¯”ç‡ä¸º 425.04ï¼…ã€‚</p></li></ul><ul><li><p>é™ä½æ¸…ç®—ä»·æ ¼</p><p>CDP æ‰€æœ‰è€…é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜æ˜¯åœ¨é«˜åº¦ä¸å¯é¢„æµ‹çš„å¸‚åœºä¸­ä¿æŒå®‰å…¨çš„æ æ†çŠ¶æ€ã€‚å¦‚æœ CDP æ¥è¿‘æ¸…ç®—ä»·æ ¼ï¼Œç”¨æˆ·å¯ä»¥æ·»åŠ æ›´å¤šæŠµæŠ¼å“æˆ–è¿”å› DAIä»¥é™ä½é£é™©ã€‚å¦‚æœç”¨æˆ·åšä¿¡åŸºç¡€æŠµæŠ¼å“çš„æœªæ¥ä»·å€¼ï¼Œç”¨æˆ·å¯ä»¥å†³å®šä¸ºä»–çš„æŠµæŠ¼ç‰©å¢åŠ æ›´å¤šã€‚æˆ–è€…ï¼Œå¦‚æœç”¨æˆ·å¸Œæœ›é™ä½ä»·æ ¼æ³¢åŠ¨çš„é£é™©ï¼Œä»–å¯ä»¥é€šè¿‡å°† DAI è¿”è¿˜ç»™è‡ªå·±çš„CDP æ¥å¿è¿˜å€ºåŠ¡ã€‚é™ä½æ¸…ç®—é£é™©çš„æœ€ä½³æ–¹æ³•æ˜¯å¿è¿˜ DAI ï¼Œå› ä¸ºæ¸…ç®—ä»·æ ¼ä¼šæ›´æœ‰æ•ˆåœ°é™ä½ã€‚</p><p>å‡è®¾ï¼š</p><ul><li>ä¸€ä¸ª ETH çš„å€¼æ˜¯ 350 USD</li><li>æ€»èµŒæ³¨ PETH ä¸º 12</li><li>PETH / ETH çš„æ¯”ç‡ä¸º 1.012</li><li>æ¸…ç®—æ¯”ç‡ä¸º 150ï¼…</li><li>ç¨³å®šå€ºåŠ¡æ˜¯ 1000 DAI</li></ul><p>ç›®å‰çš„æ¸…ç®—ä»·æ ¼ï¼š</p><p>(1000 Ã— 1.5 ) Ã· (12 Ã— 1.012) = 123.51 USD</p><p>æ¸…ç®—ä»·æ ¼å˜åŠ¨ï¼Œå¢åŠ  700 ç¾å…ƒçš„æŠµæŠ¼å“ï¼š</p><p>(1000 Ã— 1.5 ) Ã· (14 Ã— 1.012) = 105.87 USD</p><p>æ¸…ç®—ä»·æ ¼å˜åŠ¨ï¼Œå–æ¶ˆ 700 ç¾å…ƒçš„å€ºåŠ¡ï¼š</p><p>(300 Ã— 1.5 ) Ã· (12 Ã— 1.012) = 37.05 USD</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è¿”è¿˜ DAI è€Œä¸æ˜¯å¢åŠ æ›´å¤šæŠµæŠ¼å“ï¼Œæ˜¾ç€é™ä½äº†æ¸…ç®—ä»·æ ¼ã€‚</p></li></ul><ul><li><p>å¦‚ä½•å‡ºå”®æŠµæŠ¼å“</p><p>å½“ Keeper æ¸…ç®—ä¸å®‰å…¨çš„ CDP æ—¶ï¼ŒæµåŠ¨æ€§æä¾›åˆåŒï¼ˆLPCï¼‰ç¡®ä¿åœ¨ Dai Dashboard ä¸Šå‡ºå”®æŠµæŠ¼å“ã€‚é”€å”®ä»·æ ¼ç”±åº”ç”¨äº†ç‰¹æ®Šä¿®é¥°ç¬¦çš„Oracle Feedç¡®å®šã€‚æ­¤ä¿®é¥°ç¬¦é€šå¸¸é‡‡ç”¨æŠ˜æ‰£çš„å½¢å¼ï¼Œç„¶ååº”ç”¨äºå¿…é¡»å›æ”¶çš„æœªå¿è¿˜å€ºåŠ¡ã€‚è¿™ç§é¢å¤–çš„â€œå·®ä»·â€æ—¨åœ¨é€šè¿‡å‘æŠµæŠ¼å“ä¹°æ–¹æä¾›ä¼˜äºå¸‚åœºä»·æ ¼æ¥æ¿€åŠ±ç³»ç»Ÿçš„å¿«é€Ÿèµ„æœ¬é‡ç»„ã€‚ç”¨æˆ·å¯ä»¥åœ¨ä»ªè¡¨æ¿ä¸Šè´­ä¹°å·²è¢« LPC å ç”¨çš„ PETH ã€‚å‡ºå”®çš„ä»»ä½• DAI ç›ˆä½™éƒ½å¯ä»¥ç”¨ PETH è´­ä¹°ã€‚</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_casper</title>
      <link href="/2019/10/14/eth-casper/"/>
      <url>/2019/10/14/eth-casper/</url>
      
        <content type="html"><![CDATA[<h2 id="Casperçš„åŸºæœ¬è®¤è¯†"><a href="#Casperçš„åŸºæœ¬è®¤è¯†" class="headerlink" title="Casperçš„åŸºæœ¬è®¤è¯†"></a>Casperçš„åŸºæœ¬è®¤è¯†</h2><h4 id="Casperæ˜¯ä»¥å¤ªåŠåŸºäºPOSçš„ç ”ç©¶é¡¹ç›®ï¼ŒCasperé¡¹ç›®å…¶å®åŒ…å«ä¸¤ä¸ªç ”ç©¶é¡¹ç›®"><a href="#Casperæ˜¯ä»¥å¤ªåŠåŸºäºPOSçš„ç ”ç©¶é¡¹ç›®ï¼ŒCasperé¡¹ç›®å…¶å®åŒ…å«ä¸¤ä¸ªç ”ç©¶é¡¹ç›®" class="headerlink" title="Casperæ˜¯ä»¥å¤ªåŠåŸºäºPOSçš„ç ”ç©¶é¡¹ç›®ï¼ŒCasperé¡¹ç›®å…¶å®åŒ…å«ä¸¤ä¸ªç ”ç©¶é¡¹ç›®"></a>Casperæ˜¯ä»¥å¤ªåŠåŸºäºPOSçš„ç ”ç©¶é¡¹ç›®ï¼ŒCasperé¡¹ç›®å…¶å®åŒ…å«ä¸¤ä¸ªç ”ç©¶é¡¹ç›®</h4><ul><li>Casper the Friendly Finality Gadgetï¼ˆFFGï¼‰</li><li>Casper the Friendly GHOST: Correct-by-Constructionï¼ˆCBC/TFGï¼‰</li></ul><p>POSç®—æ³•å®ç°ä¸»è¦å¯åˆ†ä¸ºä¸¤ä¸ªæ–¹å‘ï¼Œå¦‚ä¸‹</p><ul><li>åŸºäºé“¾ï¼Œå¦‚ the Friendly GHOSTï¼Œï¼ˆç†è§£ä¸­åŸºäºé“¾æ„å‘³å¯æ˜¯å¯åˆ†å‰çš„ï¼‰</li><li>åŸºäºBFTï¼Œå¦‚Tendermint</li></ul><p>Casper TFGæ˜¯é“¾å’ŒBFTäºŒè€…æ··åˆï¼Œä¹Ÿæ˜¯POW+POSæ··åˆã€‚å…¶ä¸­ï¼ŒPOWå®Œæˆå¤§éƒ¨åˆ†åè®®ï¼ŒPOSå®šæœŸéªŒè¯æ£€æŸ¥ç‚¹ã€‚</p><p><a href="https://ethfans.org/posts/Vitalik-on-the-first-test-of-sharding" target="_blank" rel="noopener">å…³äºcasperåˆ†ç‰‡</a>,<a href="https://ethresear.ch/t/cross-links-between-main-chain-and-shards/1860" target="_blank" rel="noopener">casperäº¤è”</a>,<a href="https://ethfans.org/posts/you-want-to-be-casper-sharding-validator" target="_blank" rel="noopener">ppt</a></p><h4 id="Casper-vs-Tendermint"><a href="#Casper-vs-Tendermint" class="headerlink" title="Casper vs Tendermint"></a>Casper vs Tendermint</h4><p>ç¬¬ä¸€ä¸ªçœŸæ­£æå‡ºå°†BFTç ”ç©¶åº”ç”¨åˆ°PoSå…¬æœ‰åŒºå—é“¾ç¯å¢ƒä¸­æ˜¯Jae Kwonï¼Œä»–åœ¨2014å¹´åˆ›é€ äº†<strong>Tendermint</strong>ã€‚</p><p><strong>Tendermint</strong>çš„è®¾è®¡å†³ç­–ç¡®å®æ˜¯æŠŠå®‰å…¨æ€§å’Œä¸å¯æ”¹å˜æ€§åœ°ä½æ”¾åœ¨äº†çµæ´»æ€§ä¹‹ä¸Šã€‚åœ¨ç°å®ä¸–ç•Œä¸Šæœ‰ç›¸å½“é«˜çš„å¯èƒ½æ€§æ˜¯ï¼Œç³»ç»ŸçœŸçš„ä¼šåœæ­¢è¿è¡Œï¼Œå‚ä¸è€…å°†ä¼šéœ€è¦åœ¨åè®®å¤–ç»„ç»‡åœ¨æŸç§è½¯ä»¶ä¸Šæ›´æ–°åé‡å¯ç³»ç»Ÿã€‚</p><p>Tendermintçš„æ˜ç¡®å±æ€§</p><p>å¯è¯æ˜çš„æ´»è·ƒæ€§</p><p>å®‰å…¨é˜ˆå€¼ï¼š1/3çš„éªŒè¯è€…</p><p>å…¬æœ‰/ç§æœ‰é“¾ç›¸å®¹</p><p>å³æ—¶çš„æœ€ç»ˆç¡®å®šæ€§ï¼š1-3ç§’ï¼Œå–å†³äºéªŒè¯è€…æ•°é‡</p><p>ä¸€è‡´æ€§ä¼˜å…ˆ</p><p>åœ¨å¼±åŒæ­¥æ€§ç½‘ç»œçš„å…±è¯†å®‰å…¨</p><p><strong>Casper</strong>çš„PoSæè®®æœºåˆ¶ä¸Tendermintæè®®æœºåˆ¶æœ€å¤§çš„åŒºåˆ«æ˜¯ç›¸æ¯”è¾ƒä¼ªéšæœºé€‰æ‹©é¢†å¯¼è€…ï¼Œå‰è€…çš„éªŒè¯è€…å¯ä»¥åŸºäºè‡ªå·±è§åˆ°çš„å—æå‡ºå—ã€‚</p><p><strong>Casper</strong>æä¾›çš„ä¸€ä¸ªç‹¬ç‰¹åŠŸèƒ½æ˜¯å‚æ•°åŒ–å®‰å…¨é˜ˆå€¼ã€‚Casperçš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨ç½‘ç»œç»´æŒPoSä½å¼€é”€çš„æ—¶å€™èƒ½å¤Ÿå…è®¸éªŒè¯è€…é€‰æ‹©è‡ªå·±çš„å®¹é”™é˜ˆå€¼ã€‚</p><p><strong>Casper</strong>å¯¹ <strong>Tendermint</strong>çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºç½‘ç»œéšæ—¶å¯ä»¥å®¹çº³ä¸€å®šæ•°é‡çš„éªŒè¯è€…ã€‚å› ä¸ºTendermintä¸­çš„åŒºå—åœ¨åˆ›å»ºçš„æ—¶å€™éœ€è¦æœ€ç»ˆåŒ–ï¼Œæ‰€ä»¥åŒºå—çš„ç¡®è®¤æ—¶é—´åº”è¯¥çŸ­ä¸€ç‚¹ã€‚ä¸ºäº†è¾¾åˆ°çŸ­åŒºå—æ—¶é—´ï¼ŒTendermint PoSèƒ½å¤Ÿå®¹çº³çš„éªŒè¯è€…æ•°é‡å°±éœ€è¦æœ‰ä¸ªé™åˆ¶ã€‚</p><p><strong>Casper</strong>çš„æ˜ç¡®å±æ€§</p><p>å¯ç”¨æ€§ã€‚Casperçš„èŠ‚ç‚¹åœ¨å®ƒä»¬è¾¾æˆå…±è¯†ä¹‹å‰å¯ä»¥å—åˆ†æˆ</p><p>å¼‚æ­¥å®‰å…¨æ€§</p><p>ç”Ÿå­˜ã€‚Casperçš„å†³ç­–å¯ä»¥åœ¨éƒ¨åˆ†åŒæ­¥ä¸­å­˜æ´»ï¼Œä½†æ˜¯ä¸èƒ½åœ¨å¼‚æ­¥ä¸­å­˜æ´»</p><p>å¡ç‰¹å°”é˜»åŠ›ã€‚Casperçš„æ•´ä¸ªå‰ææ˜¯å»ºç«‹åœ¨æŠµåˆ¶å¯¡å¤´å„æ–­æ”»å‡»è€…åŸºç¡€ä¹‹ä¸Šï¼Œå› æ­¤ä¸ä¼šæœ‰ä»»ä½•å‹¾ç»“çš„éªŒè¯è€…å¯ä»¥è¶…è¶Šåè®®</p><p>å®‰å…¨æ€§ã€‚å–å†³äºæ¯ä¸ªéªŒè¯è€…çš„è¯„ä¼°å®‰å…¨é˜ˆå€¼</p>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_contract</title>
      <link href="/2019/10/14/eth-contract/"/>
      <url>/2019/10/14/eth-contract/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦"><a href="#ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦" class="headerlink" title="ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦"></a>ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦</h2><p>ä»æ™ºèƒ½åˆçº¦çš„ä»£ç åˆ°ä½¿ç”¨æ™ºèƒ½åˆçº¦ï¼Œå¤§æ¦‚åŒ…å«ä»¥ä¸‹æ­¥éª¤</p><ul><li>ç¼–å†™æ™ºèƒ½åˆçº¦çš„ä»£ç (ä¸€èˆ¬æ˜¯ç”¨Solidity)</li><li>ç¼–è¯‘æ™ºèƒ½åˆçº¦çš„ä»£ç å˜æˆå¯åœ¨EVMä¸Šæ‰§è¡Œçš„bytecode(binary code)ï¼ŒåŒæ—¶å¯ä»¥é€šè¿‡ç¼–è¯‘å–å¾—æ™ºèƒ½åˆçº¦çš„ABI</li><li>éƒ¨ç½²æ™ºèƒ½åˆçº¦ï¼Œå®é™…ä¸Šæ˜¯å§bytecodeå­˜å‚¨åœ¨é“¾ä¸Š(é€šè¿‡ä¸€ä¸ªtransaction)ï¼Œå¹¶å–å¾—ä¸€ä¸ªä¸“å±äºè¿™ä¸ªåˆçº¦çš„åœ°å€</li><li>è¦è°ƒç”¨åˆçº¦ï¼Œéœ€è¦æŠŠä¿¡æ¯å‘é€åˆ°è¿™ä¸ªåˆçº¦çš„åœ°å€ï¼Œä¸€æ ·ä¹Ÿæ˜¯é€šè¿‡transactionï¼Œä»¥å¤ªåŠèŠ‚ç‚¹ä¼šæ ¹æ®è¾“å…¥çš„ä¿¡æ¯ï¼Œé€‰æ‹©è¦æ‰§è¡Œåˆçº¦ä¸­çš„å“ªä¸€ä¸ªfunctionå’Œè¦è¾“å…¥çš„å‚æ•°</li></ul><p>ä»¥ä¸‹ï¼Œå°†è¯¦ç»†ä»‹ç»ä»¥ä¸Šæ­¥éª¤ã€‚</p><h4 id="ä»£ç ç¼–å†™åŠç¼–è¯‘éƒ¨ç½²"><a href="#ä»£ç ç¼–å†™åŠç¼–è¯‘éƒ¨ç½²" class="headerlink" title="ä»£ç ç¼–å†™åŠç¼–è¯‘éƒ¨ç½²"></a>ä»£ç ç¼–å†™åŠç¼–è¯‘éƒ¨ç½²</h4><h4 id="æ™ºèƒ½åˆçº¦ABI"><a href="#æ™ºèƒ½åˆçº¦ABI" class="headerlink" title="æ™ºèƒ½åˆçº¦ABI"></a>æ™ºèƒ½åˆçº¦ABI</h4><p>å¦‚æœè¯´apiï¼Œæƒ³å¿…éƒ½çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œå¯¹åº”çš„ï¼ŒABIï¼Œapplication binary interfaceï¼Œé¡¾åæ€ä¹‰ï¼ŒåŒæ ·æ˜¯æ¥å£ï¼Œä½†ä¼ é€’çš„æ˜¯binaryæ ¼å¼çš„ä¿¡æ¯ã€‚</p><p>ABIç†è§£å¦‚ä¸‹</p><h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><ul><li><code>name</code>ï¼ša string, æ–¹æ³•å</li><li><code>type</code>:  a stringï¼Œâ€functionâ€, â€œconstructorâ€, or â€œfallbackâ€ï¼Œæ–¹æ³•ç±»å‹</li><li><code>inputs</code>:  an arrayï¼Œæ–¹æ³•å‚æ•°ï¼Œæ¯ä¸ªå‚æ•°çš„æ ¼å¼ä¸º<ul><li><code>name</code>ï¼ša stringï¼Œå‚æ•°å</li><li><code>type</code>ï¼ša stringï¼Œå‚æ•°çš„ data type(e.g. uint256)</li><li><code>components</code>ï¼šan arrayï¼Œå¦‚æœè¾“å…¥çš„å‚æ•°æ˜¯ tuple(struct) type æ‰ä¼šæœ‰è¿™ä¸ªå‚æ•°ã€‚æè¿° struct ä¸­åŒ…å«çš„å‚æ•°ç±»å‹</li></ul></li><li><code>outputs</code>ï¼šan arrayï¼Œ æ–¹æ³•è¿”å›å€¼ï¼Œå’Œ <code>inputs</code> ä½¿ç”¨ç›¸åŒè¡¨ç¤ºæ–¹å¼ã€‚å¦‚æœæ²’æœ‰è¿”å›å€¼å¯å¿½ç•¥ï¼Œå€¼ä¸º <code>[]</code></li><li><code>payable</code>ï¼š<code>true</code>ï¼Œfunction æ˜¯å¦å¯æ”¶ Etherï¼Œé¢„è®¾ä¸º <code>false</code></li><li><code>constant</code>ï¼š<code>true</code>ï¼Œfunction æ˜¯å¦ä¼šæ”¹å†™åŒºå—é“¾çŠ¶æ€ï¼Œåä¹‹ä¸º <code>false</code></li><li><code>stateMutability</code>ï¼ša stringï¼Œå…¶å€¼å¯èƒ½ä¸ºä»¥ä¸‹å…¶ä¸­ä¹‹ä¸€ï¼šâ€pureâ€ï¼ˆä¸ä¼šè¯»å†™åŒºå—é“¾çŠ¶æ€ï¼‰ã€â€viewâ€ï¼ˆåªè¯»ä¸å†™åŒºå—é“¾çŠ¶æ€ï¼‰ã€â€payableâ€ and â€œnonpayableâ€ï¼ˆä¼šæ”¹åŒºå—é“¾çŠ¶æ€ï¼Œä¸”å¦‚å¯æ”¶ Ether ä¸º â€œpayableâ€ï¼Œåä¹‹ä¸º â€œnonpayableâ€ï¼‰</li></ul><p>ä»”ç»†çœ‹ä¼šå‘ç° <code>payable</code> å’Œ <code>constant</code> è¿™ä¸¤ä¸ªå‚æ•°æ‰€æè¿°çš„å…§å®¹ï¼Œä¼¼ä¹å·²åŒ…å«åœ¨ <code>stateMutability</code> ä¸­ã€‚</p><h5 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h5><ul><li><code>name</code>: a stringï¼Œevent çš„åç§°</li><li><code>type</code>: a stringï¼Œalways â€œeventâ€</li><li><code>inputs</code>: an arrayï¼Œè¾“å…¥å‚æ•°ï¼ŒåŒ…å«ï¼š<ul><li><code>name</code>: a stringï¼Œå‚æ•°åç§°</li><li><code>type</code>: a stringï¼Œå‚æ•°çš„ data type(e.g. uint256)</li><li><code>components</code>: an arrayï¼Œå¦‚æœè¾“å…¥å‚æ•°æ˜¯ tuple(struct) type æ‰ä¼šæœ‰è¿™ä¸ªå‚æ•°ã€‚æè¿° struct ä¸­åŒ…å«çš„ä¿¡æ¯ç±»å‹</li><li><code>indexed</code>: <code>true</code>ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°è¢«å®šä¹‰ä¸º indexed ï¼Œåä¹‹ä¸º <code>false</code></li></ul></li><li><code>anonymous</code>: <code>true</code>ï¼Œå¦‚æœ event è¢«å®šä¹‰ä¸º anonymous</li></ul><p>æ›´æ–°æ™ºèƒ½åˆçº¦çŠ¶æ€éœ€è¦å‘é€ transactionï¼Œtransaction éœ€è¦ç­‰å¾…éªŒè¯ï¼Œæ‰€ä»¥æ›´æ–°åˆçº¦çŠ¶æ€æ˜¯éåŒæ­¥çš„ï¼Œæ— æ³•é©¬ä¸Šå–å¾—è¿”å›å€¼ã€‚ä½¿ç”¨ Event å¯ä»¥åœ¨çŠ¶æ€æ›´æ–°æˆåŠŸåï¼Œå°†ç›¸å…³ä¿¡æ¯è®°å½•åˆ° Logï¼Œå¹¶è®©ç›‘å¬è¿™ä¸ª Event çš„ DApp æˆ–ä»»ä½•åº”ç”¨è¿™ä¸ªæ¥å£çš„ç¨‹åºæ”¶åˆ°é€šçŸ¥ã€‚æ¯ç¬” transaction éƒ½æœ‰å¯¹åº”çš„ Logã€‚</p><p>æ‰€ä»¥ç®€å•æ¥è¯´ï¼ŒEvent å¯ç”¨ä¾†ï¼š1. å–å¾— function æ›´æ–°åˆçº¦çŠ¶æ€çš„è¿”å›å€¼ 2. ä¹Ÿå¯ä½œä¸ºåˆçº¦å¦å¤–çš„å­˜å‚¨ç©ºé—´ã€‚</p><p>Event çš„å‚æ•°åˆ†ä¸ºï¼šæœ‰ <code>indexed</code>ï¼Œå’Œå…¶ä»–æ²¡æœ‰ <code>indexed</code> çš„ã€‚æœ‰ <code>indexed</code> çš„å‚æ•°å¯ä»¥ä½¿ç”¨ filterï¼Œä¾‹å¦‚åŒä¸€ä¸ª Eventï¼Œæˆ‘å¯ä»¥é€‰æ‹©åªç›‘å¬ä»ç‰¹å®š address å‘å‡ºæ¥çš„äº¤æ˜“ã€‚æ¯ç¬” Log çš„ä¿¡æ¯åŒæ ·åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šTopicsï¼ˆé•¿åº¦æœ€å¤šä¸º 4 çš„ arrayï¼‰ å’Œ Dataã€‚æœ‰ <code>anonymous</code> çš„å‚æ•°ä¼šå­˜å‚¨å­˜åœ¨ Log çš„ Topicsï¼Œå…¶ä»–çš„å­˜åœ¨ Dataã€‚</p><h5 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.20;</span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line">    uint public data;</span><br><span class="line">    event Set(address indexed _from, uint value);</span><br><span class="line">    function set(uint x) public &#123;</span><br><span class="line">        data = x;</span><br><span class="line">        Set(msg.sender, x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„ABIæ¥å£ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[&#123;//è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•åä¸ºdataçš„åªè¯»æ–¹æ³•ï¼Œè¿”å›dataå€¼,&quot;stateMutabTility&quot;: &quot;view&quot;ä»£è¡¨åªè¯»</span><br><span class="line">        &quot;constant&quot;: true,  </span><br><span class="line">        &quot;inputs&quot;: [],</span><br><span class="line">        &quot;name&quot;: &quot;data&quot;,</span><br><span class="line">        &quot;outputs&quot;: [&#123;&quot;name&quot;: &quot;&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class="line">        &quot;payable&quot;: false,</span><br><span class="line">        &quot;stateMutabTility&quot;: &quot;view&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;function&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;  //setæ–¹æ³•ï¼Œ &quot;stateMutability&quot;: &quot;nonpayable&quot;,å¯å†™æ–¹æ³•ï¼Œä½†ä¸å¯æ”¶Ether,æ–¹æ³•å‚æ•°ä¸ºuint256ç±»å‹</span><br><span class="line">        &quot;constant&quot;: false,</span><br><span class="line">        &quot;inputs&quot;: [&#123;&quot;name&quot;: &quot;x&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class="line">        &quot;name&quot;: &quot;set&quot;,</span><br><span class="line">        &quot;outputs&quot;: [],</span><br><span class="line">        &quot;payable&quot;: false,</span><br><span class="line">        &quot;stateMutability&quot;: &quot;nonpayable&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;function&quot;</span><br><span class="line">&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;anonymous&quot;: false,</span><br><span class="line">        &quot;inputs&quot;: [&#123;&quot;indexed&quot;: true,&quot;name&quot;: &quot;_from&quot;,&quot;type&quot;: &quot;address&quot;&#125;,&#123;&quot;indexed&quot;: false,&quot;name&quot;: &quot;value&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class="line">        &quot;name&quot;: &quot;Set&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;event&quot;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><p>eventæ—¶é—´å¯ç›‘å¬ï¼Œåœ¨web3ä½¿ç”¨æ—¶ä¼šæœ‰ç¤ºä¾‹</p><h3 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h3><p>å…³äºæ™ºèƒ½åˆçº¦çš„è°ƒç”¨ï¼Œé€šè¿‡å‘½ä»¤è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†binaryçš„æ‹¼å‡‘æœ‰ç‚¹ç¹çï¼Œweb3å°è£…çš„æ¥å£è°ƒç”¨èµ·æ¥å°±æ–¹ä¾¿å¾ˆå¤šã€‚</p><p>ç›´æ¥çœ‹ä¾‹å­å§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract hello &#123;</span><br><span class="line">    function say() constant public returns (string) &#123;</span><br><span class="line">        return &quot;Hello World&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åéƒ¨ç½²åˆ°äº†æœåŠ¡å™¨ä¸Šï¼Œè¿”å›åˆçº¦çš„åœ°å€ä¸º0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51</p><p>abiä¸ºç¼–è¯‘äº§ç”Ÿçš„abiæ•°ç»„ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var contract = web3.eth.contract(info.abi).at(&quot;0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51&quot;);</span><br><span class="line">var account_one = web3.eth.accounts[0];</span><br><span class="line">var result = contract.say(&#123;from: account_one&#125;)</span><br><span class="line">console.log(result); //Hello World</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç®€å•çš„è°ƒç”¨å°±æˆåŠŸäº†ï¼Œç„¶åå†çœ‹contractæä¾›çš„æ¥å£çš„å…·ä½“æƒ…å†µã€‚</p><p>æ™ºèƒ½åˆçº¦æ–¹æ³•è°ƒç”¨æ–¹å¼æœ‰å››ç§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//æ ¹æ®æ–¹æ³•ç±»å‹è‡ªåŠ¨å†³å®šæ˜¯ä½¿ç”¨callæ–¹å¼è¿›è¡Œè°ƒç”¨è¿˜æ˜¯sendTransactionæ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œcallå’ŒsendTransactionçš„åŒºåˆ«å‘¢ï¼Œå¦‚æœæ–¹æ³•æ˜¯åªè¯»çš„ï¼Œåˆ™ä¸éœ€è¦å…¥é“¾ï¼Œç›´æ¥è°ƒç”¨å³å¯ï¼Œæ–¹æ³•æ˜¯å¯å†™çš„ï¼Œåˆ™éœ€è¦ä»¥äº¤æ˜“çš„æ–¹æ³•è¿›è¡Œæäº¤å…¥é“¾ã€‚å‚æ•°ä¸­ï¼Œparamåˆ™æ˜¯ä¼ å…¥ç»™æ–¹æ³•çš„å‚æ•°ï¼Œåé¢æ·»åŠ åˆ«çš„å‚æ•°</span><br><span class="line">myContractInstance.myMethod(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class="line"></span><br><span class="line">//ç²¾ç¡®ä½¿ç”¨callæ–¹å¼è¿›è¡Œè°ƒç”¨</span><br><span class="line">myContractInstance.myMethod.call(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class="line"></span><br><span class="line">//ç²¾ç¡®ä½¿ç”¨å‘é€äº¤æ˜“å½¢å¼è¿›è¡Œè°ƒç”¨</span><br><span class="line">myContractInstance.myMethod.sendTransaction(param1 [, param2, ...] [, transactionObject] [, callback]);</span><br><span class="line"></span><br><span class="line">//æ²¡çœ‹æ˜ç™½</span><br><span class="line">// Get the call data, so you can call the contract through some other means</span><br><span class="line">// var myCallData = myContractInstance.myMethod.request(param1 [, param2, ...]);</span><br><span class="line">var myCallData = myContractInstance.myMethod.getData(param1 [, param2, ...]);</span><br><span class="line">// myCallData = &apos;0x45ff3ff6000000000004545345345345..&apos;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œé¡ºä¾¿ç©ä¸€ä¸‹eventã€‚</p><p>åˆçº¦ä¿®æ”¹ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line">contract hello &#123;</span><br><span class="line">    string public greeting;</span><br><span class="line">    event Set(address indexed _from, string value);</span><br><span class="line"></span><br><span class="line">    function set(string g) public &#123;</span><br><span class="line">        greeting = g;</span><br><span class="line">        Set(msg.sender, g);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get() constant public returns (string) &#123;</span><br><span class="line">        return greeting;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå®Œæ•´çš„è°ƒç”¨è„šæœ¬ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">var Web3 = require(&quot;web3&quot;);</span><br><span class="line">var web3 = new Web3();</span><br><span class="line">web3.setProvider(new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;));</span><br><span class="line">if (web3.isConnected()) &#123;</span><br><span class="line">  console.log(&quot;connection success!&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  console.log(&quot;fail to connection!&quot;);</span><br><span class="line">  return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var contract = web3.eth.contract(abi).at(address);</span><br><span class="line">var account_one = web3.eth.accounts[0];</span><br><span class="line">var my_event = contract.Set();</span><br><span class="line">var getStr = function() &#123;</span><br><span class="line">  var str = contract.greeting(&#123;from: account_one&#125;)</span><br><span class="line">  console.log(&quot;the str is: &quot; + str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getStr()</span><br><span class="line">my_event.watch(function(err, result) &#123;</span><br><span class="line">    if (!err) &#123;</span><br><span class="line">        console.log(result);</span><br><span class="line">        getStr()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    my_event.stopWatching();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">contract.set(&quot;I am Changed!&quot;,&#123;from: account_one&#125;)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¾“å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// connection success!</span><br><span class="line">// the str is:</span><br><span class="line">// &#123; address: &apos;0x8321a32f8b7bbc00a65c9e21df64948cf40bbeba&apos;,</span><br><span class="line">//   blockNumber: 785,</span><br><span class="line">//   transactionHash: &apos;0xa90e35845cd844907f251660bce78f5cde2c968876f3a6321fbf38589d7fb476&apos;,</span><br><span class="line">//   transactionIndex: 0,</span><br><span class="line">//   blockHash: &apos;0x742eecc3ae508b33ca5dde2ae2a32b8c0c87d321c6ab13a0cc8ad3909e579275&apos;,</span><br><span class="line">//   logIndex: 0,</span><br><span class="line">//   removed: false,</span><br><span class="line">//   event: &apos;Set&apos;,</span><br><span class="line">//   args:</span><br><span class="line">//    &#123; _from: &apos;0xc6e1feafcc44ebb1a7b0ecc06770566845eac7ac&apos;,</span><br><span class="line">//      value: &apos;I am Changed!&apos; &#125; &#125;</span><br><span class="line">// the str is: I am Changed!</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿”å›çš„ç»“æœä¸­åŒ…æ‹¬åŒºå—å“ˆå¸Œç­‰ä¿¡æ¯ï¼Œè¿˜æœ‰å‚æ•°</p><h4 id="Event-1"><a href="#Event-1" class="headerlink" title="Event"></a>Event</h4><p>åœ¨åˆçº¦ä¸­å®šä¹‰äº‹ä»¶ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event SendMsg(string sender, string receiver, string detail, address indexed reth);</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°indexedå…³é”®å­—ã€‚è·Ÿeventè®¢é˜…æœ‰ä¸€å®šçš„å…³ç³»ã€‚</p><p>å¤§è‡´ç†è§£æ˜¯ï¼Œeventäº‹ä»¶çŠ¹å¦‚æ—¥å¿—ï¼Œåœ¨è®¢é˜…çš„æ—¶å€™ï¼Œéœ€è¦ç¡®å®šè¦è®¢é˜…çš„å…³é”®å­—ï¼Œè¿™ä¸ªå…³é”®å­—å¯ä»¥æ˜¯äº‹ä»¶æœ¬èº«ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªå¯ç´¢å¼•çš„å€¼ï¼Œå¦‚addresså€¼ã€‚å¦‚è®¢é˜…æŸç¡®å®šaddresså€¼æ—¶ï¼Œä¼šå–å¾—æ‰€æœ‰å«æœ‰å¯ç´¢å¼•çš„è¿™ä¸ªåœ°å€ç›¸å…³çš„eventäº‹ä»¶ã€‚è®¢é˜…äº‹ä»¶æœ¬èº«çš„è¯ï¼Œå°±åªèƒ½å–å¾—è¿™ä¸ªäº‹ä»¶çš„å€¼ã€‚</p><p>é¡ºä¾¿ç²˜è´´ä¸€æ®µåœ¨web3jä¸­eventçš„ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public static void test() &#123;</span><br><span class="line">     Web3j web3j = Web3j.build(new HttpService(&quot;http://localhost:8545&quot;));</span><br><span class="line">     Event event = new Event(&quot;SendMsg&quot;,</span><br><span class="line">             Arrays.&lt;TypeReference&lt;?&gt;&gt;asList(</span><br><span class="line">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class="line">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class="line">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class="line">                     new TypeReference&lt;Address&gt;(true)&#123;&#125;</span><br><span class="line">             ));</span><br><span class="line">     EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST,</span><br><span class="line">             DefaultBlockParameterName.LATEST, &quot;0x495feebd99f645a43aa63edb32d46e057e44e286&quot;);</span><br><span class="line">     //è®¢é˜…çš„æ˜¯eventäº‹ä»¶æœ¬èº«</span><br><span class="line">     filter.addSingleTopic(EventEncoder.encode(event));</span><br><span class="line"></span><br><span class="line">     web3j.ethLogObservable(filter).subscribe(log -&gt; &#123;</span><br><span class="line">         System.out.println(log);</span><br><span class="line">         //dataå‚æ•°å€¼ï¼Œéœ€è¦è¿›è¡Œè§£ç ã€‚</span><br><span class="line">         List&lt;Type&gt; results = FunctionReturnDecoder.decode(log.getData(), event.getNonIndexedParameters());</span><br><span class="line">         for (Type type : results) &#123;</span><br><span class="line">             System.out.println(type);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125;);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> //è¾“å‡ºï¼Œä¾‹å¦‚ï¼Œå½“å‰äº‹ä»¶æœ‰ SendMsg(&quot;susan&quot;, &quot;tom&quot;, &quot;hi&quot;, &quot;0x11a857e4d069d963c0676c53b68e9d571a3e2b26&quot;)</span><br><span class="line"> //logè¾“å‡ºä¸ºLog&#123;removed=false, logIndex=&apos;0x0&apos;, transactionIndex=&apos;0x0&apos;, transactionHash=&apos;0x31aa0a485f5595fb5b5c959e94dfb511c3512e94589dfd51205c5bd07c6ba4e2&apos;, blockHash=&apos;0xc68dcd25600857642199f9ebb354b62532f8468191a85ca923c0e03e958c6398&apos;, blockNumber=&apos;0x157c&apos;, address=&apos;0x495feebd99f645a43aa63edb32d46e057e44e286&apos;, data=&apos;...&apos;, type=&apos;null&apos;, topics=[0x444f124b164dc796e3a81a1d90ea60c96a815eac0a67ad1d3d550d30afda9e1f, 0x00000000000000000000000011a857e4d069d963c0676c53b68e9d571a3e2b26]</span><br><span class="line"> //topicä¸ºä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªä¸ºSendMsgäº‹ä»¶æœ¬èº«ï¼Œç¬¬äºŒä¸ªä¸ºSendMsgäº‹ä»¶å®šä¹‰ä¸­å«æœ‰å¯ç´¢å¼•å€¼address,</span><br><span class="line"> //dataè§£ç éç´¢å¼•é¡¹ç»“æœä¸ºsusanã€tomã€hi</span><br></pre></td></tr></table></figure><h4 id="Remix"><a href="#Remix" class="headerlink" title="Remix"></a>Remix</h4><p>remixæ˜¯åŸºäºæµè§ˆå™¨å¼€å‘çš„ide</p><ul><li><p>åŠ è½½æœ¬åœ°æ–‡ä»¶å¤¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g remixd</span><br><span class="line">remixd -s &lt;absolute-path-to-the-shared-folder&gt;</span><br><span class="line">//ä¼šå¼€å¯å…±äº«æ–‡ä»¶å¤¹æœåŠ¡ï¼Œé€šè¿‡ws</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨remixä¸Šç‚¹å‡»ç±»ä¼¼äºè¶…é“¾æ¥çš„é‚£ä¸ªæŒ‰é’®</p></li></ul><h4 id="bytes32ã€string"><a href="#bytes32ã€string" class="headerlink" title="bytes32ã€string"></a>bytes32ã€string</h4><p>æ–‡æ¡£ä¸Šæ˜¯è¿™ä¹ˆè¯´çš„ï¼Œbytes1 ~bytes32æ˜¯é•¿åº¦ç‰¹å®šçš„ç±»å‹ï¼Œæ•…èŠ±è´¹æ¯”stringå’Œbyteså°ã€‚</p><p>ç„¶åè®°ä¸€ä¸‹ä¸€èˆ¬å­˜pubkey(pubkeyé™¤æ‰0xé•¿åº¦ä¸º64ï¼Œå¯ä»¥ç”¨ä¸¤ä¸ªbytes32æ¥å­˜)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bytes32 pubkey_half_pre;</span><br><span class="line">bytes32 pubkey_half_after;</span><br></pre></td></tr></table></figure><h4 id="é’±ğŸ’°ğŸ’°ğŸ’°ğŸ’°"><a href="#é’±ğŸ’°ğŸ’°ğŸ’°ğŸ’°" class="headerlink" title="é’±ğŸ’°ğŸ’°ğŸ’°ğŸ’°"></a>é’±ğŸ’°ğŸ’°ğŸ’°ğŸ’°</h4><p>åˆçº¦éƒ¨ç½²ä¹‹åç”Ÿæˆåˆçº¦åœ°å€ï¼Œåœ°å€åŒæ ·å¯ä»¥ä½œä¸ºæ™®é€šåœ°å€ä½¿ç”¨ï¼Œå³è½¬è´¦ç³»åˆ—ã€‚å¯ä»¥ç»™åˆçº¦åœ°å€è½¬è´¦ï¼Œè§<a href="https://solidity-cn.readthedocs.io/zh/develop/contracts.html#fallback" target="_blank" rel="noopener">æ–‡æ¡£</a></p><p>éœ€å®šä¹‰ä¸€ä¸ªæœªå‘½åã€æ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰è¿”å›å€¼å‡½æ•°,ä¸”ä¸ºpayableã€‚å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function () payable &#123;&#125;</span><br></pre></td></tr></table></figure><p>åœ¨icoä¸­ï¼Œè½¬è´¦ç»™åˆ°åˆçº¦åœ°å€ï¼Œåˆçº¦è¿”å›ä¸€å®šæ•°é‡tokenç»™åˆ°è½¬è´¦è€…ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªå‡½æ•°è¿›è¡Œã€‚</p><p>æˆ–è€…å‘¢ï¼Œåˆçº¦çš„æŸæ–¹æ³•å¦‚æœä½¿ç”¨äº†payableä¿®é¥°çš„è¯ï¼Œä¹Ÿä»£è¡¨è¿™ä¸ªæ–¹æ³•å¯ä»¥æ¥å—ether, å³msg.valueï¼Œé’±ä¼šå­˜åˆ°åˆçº¦åœ°å€ä¸­ï¼Œé€šè¿‡this.balanceå³å¯è·å–ä½™é¢ã€‚</p><p>åœ¨åˆçº¦ä¸­ï¼Œå‘æŸåœ°å€å‘é€ether, ä½¿ç”¨address.transferã€address.sendå³å¯ã€‚</p><h4 id="åˆçº¦äº¤äº’"><a href="#åˆçº¦äº¤äº’" class="headerlink" title="åˆçº¦äº¤äº’"></a>åˆçº¦äº¤äº’</h4><p>ç°æœ‰ä¸€åˆçº¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract UserTest &#123;</span><br><span class="line">    struct User &#123;</span><br><span class="line">        string name;</span><br><span class="line">        address addr;</span><br><span class="line">        string pubkey;</span><br><span class="line">        bool isValue;</span><br><span class="line">    &#125;</span><br><span class="line">    mapping(string =&gt; User)  users;</span><br><span class="line">    event UserChange(string uname, address addr, uint value);</span><br><span class="line"></span><br><span class="line">    function addUser(string uname, address addr, string pubkey)  public &#123;</span><br><span class="line">         require(</span><br><span class="line">           !users[uname].isValue,</span><br><span class="line">           &quot;name already exist&quot;</span><br><span class="line">       );</span><br><span class="line">       users[uname] = User(&#123;</span><br><span class="line">           name: uname,</span><br><span class="line">           addr: addr,</span><br><span class="line">           pubkey: pubkey,</span><br><span class="line">           isValue: true</span><br><span class="line">       &#125;);</span><br><span class="line">       UserChange(uname, addr, msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function userExist(string uname) constant external returns (bool) &#123;</span><br><span class="line">        return users[uname].isValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å¦ä¸€åˆçº¦ä¸­è°ƒç”¨userExistæ–¹æ³•,é¦–å…ˆéƒ¨ç½²ä¸Šè¿°åˆçº¦ï¼Œåˆçº¦åœ°å€å¦‚0x123456789</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract UserTest &#123;</span><br><span class="line">//è¦è°ƒç”¨çš„æ–¹æ³•å£°æ˜éœ€è¦è·ŸåŸæ¥ä¸€æ ·</span><br><span class="line">    function userExist(string uname) constant external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line">contract ExternalTest &#123;</span><br><span class="line"></span><br><span class="line">    address userInstance = 0x123456789;</span><br><span class="line">    UserTest user = UserTest(userInstance); //å¼ºåˆ¶ç±»å‹è½¬æ¢</span><br><span class="line"></span><br><span class="line">    function userCheck(string uname) public returns (bool)&#123;</span><br><span class="line">        return user.userExist(uname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mapping"><a href="#mapping" class="headerlink" title="mapping"></a>mapping</h4><p>mappingæ˜¯ä¸èƒ½éå†çš„ï¼Œéœ€è¦å€ŸåŠ©åˆ«çš„æ•°æ®ç»“æ„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">library IterableMapping</span><br><span class="line">&#123;</span><br><span class="line">  struct itmap</span><br><span class="line">  &#123;</span><br><span class="line">    mapping(uint =&gt; IndexValue) data;</span><br><span class="line">    KeyFlag[] keys;</span><br><span class="line">    uint size;</span><br><span class="line">  &#125;</span><br><span class="line">  struct IndexValue &#123; uint keyIndex; uint value; &#125;</span><br><span class="line">  struct KeyFlag &#123; uint key; bool deleted; &#125;</span><br><span class="line">  function insert(itmap storage self, uint key, uint value) returns (bool replaced)</span><br><span class="line">  &#123;</span><br><span class="line">    uint keyIndex = self.data[key].keyIndex;</span><br><span class="line">    self.data[key].value = value;</span><br><span class="line">    if (keyIndex &gt; 0)</span><br><span class="line">      return true;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      keyIndex = self.keys.length++;</span><br><span class="line">      self.data[key].keyIndex = keyIndex + 1;</span><br><span class="line">      self.keys[keyIndex].key = key;</span><br><span class="line">      self.size++;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  function remove(itmap storage self, uint key) returns (bool success)</span><br><span class="line">  &#123;</span><br><span class="line">    uint keyIndex = self.data[key].keyIndex;</span><br><span class="line">    if (keyIndex == 0)</span><br><span class="line">      return false;</span><br><span class="line">    delete self.data[key];</span><br><span class="line">    self.keys[keyIndex - 1].deleted = true;</span><br><span class="line">    self.size --;</span><br><span class="line">  &#125;</span><br><span class="line">  function contains(itmap storage self, uint key) returns (bool)</span><br><span class="line">  &#123;</span><br><span class="line">    return self.data[key].keyIndex &gt; 0;</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_start(itmap storage self) returns (uint keyIndex)</span><br><span class="line">  &#123;</span><br><span class="line">    return iterate_next(self, uint(-1));</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_valid(itmap storage self, uint keyIndex) returns (bool)</span><br><span class="line">  &#123;</span><br><span class="line">    return keyIndex &lt; self.keys.length;</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_next(itmap storage self, uint keyIndex) returns (uint r_keyIndex)</span><br><span class="line">  &#123;</span><br><span class="line">    keyIndex++;</span><br><span class="line">    while (keyIndex &lt; self.keys.length &amp;&amp; self.keys[keyIndex].deleted)</span><br><span class="line">      keyIndex++;</span><br><span class="line">    return keyIndex;</span><br><span class="line">  &#125;</span><br><span class="line">  function iterate_get(itmap storage self, uint keyIndex) returns (uint key, uint value)</span><br><span class="line">  &#123;</span><br><span class="line">    key = self.keys[keyIndex].key;</span><br><span class="line">    value = self.data[key].value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// How to use it:</span><br><span class="line">contract User</span><br><span class="line">&#123;</span><br><span class="line">  // Just a struct holding our data.</span><br><span class="line">  IterableMapping.itmap data;</span><br><span class="line">  // Insert something</span><br><span class="line">  function insert(uint k, uint v) returns (uint size)</span><br><span class="line">  &#123;</span><br><span class="line">    // Actually calls itmap_impl.insert, auto-supplying the first parameter for us.</span><br><span class="line">    IterableMapping.insert(data, k, v);</span><br><span class="line">    // We can still access members of the struct - but we should take care not to mess with them.</span><br><span class="line">    return data.size;</span><br><span class="line">  &#125;</span><br><span class="line">  // Computes the sum of all stored data.</span><br><span class="line">  function sum() returns (uint s)</span><br><span class="line">  &#123;</span><br><span class="line">    for (var i = IterableMapping.iterate_start(data); IterableMapping.iterate_valid(data, i); i = IterableMapping.iterate_next(data, i))</span><br><span class="line">    &#123;</span><br><span class="line">        var (key, value) = IterableMapping.iterate_get(data, i);</span><br><span class="line">        s += value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä»¥å¤ªåŠè™šæ‹Ÿæœº-EVM"><a href="#ä»¥å¤ªåŠè™šæ‹Ÿæœº-EVM" class="headerlink" title="ä»¥å¤ªåŠè™šæ‹Ÿæœº(EVM)"></a>ä»¥å¤ªåŠè™šæ‹Ÿæœº(EVM)</h4><p>ä»¥å¤ªåŠè™šæ‹Ÿæœº(EVM)æ˜¯æ™ºèƒ½åˆçº¦çš„è¿è¡Œç¯å¢ƒã€‚å®ƒæ˜¯ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„æ²™ç›’ï¼Œåˆçº¦ä»£ç åœ¨EVMå†…éƒ¨è¿è¡Œï¼Œå¯¹å¤–æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œç”šè‡³ä¸åŒåˆçº¦ä¹‹é—´ä¹Ÿåªæœ‰æœ‰é™çš„è®¿é—®æƒé™</p><h4 id="è´¦æˆ·"><a href="#è´¦æˆ·" class="headerlink" title="è´¦æˆ·"></a>è´¦æˆ·</h4><ul><li>ä»¥å¤ªåŠä¸­æœ‰ä¸¤ç§ä¸åŒç±»å‹ä½†æ˜¯å…±äº«åŒä¸€åœ°å€ç©ºé—´çš„è´¦æˆ·ï¼š<code>å¤–éƒ¨è´¦æˆ·</code>ç”±ä¸€å¯¹å…¬ç§é’¥æ§åˆ¶ï¼Œ<code>åˆçº¦è´¦æˆ·</code>ç”±è´¦æˆ·å†…éƒ¨çš„åˆçº¦ä»£ç æ§åˆ¶ã€‚</li><li>å¤–éƒ¨è´¦æˆ·çš„åœ°å€æ˜¯ç”±å…¬é’¥ï¼ˆç»è¿‡hashè¿ç®—ï¼‰å†³å®šçš„ï¼Œè€Œåˆçº¦è´¦æˆ·çš„åœ°å€åœ¨æ­¤åˆçº¦è¢«åˆ›å»ºçš„æ—¶å€™å†³å®šçš„ï¼ˆç”±åˆçº¦åˆ›å»ºè€…çš„åœ°å€å’Œå‘é€åˆ°æ­¤åˆçº¦åœ°å€çš„äº¤æ˜“æ•°å†³å®šï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œnonceâ€ï¼‰</li><li>ä¸ç®¡æ˜¯å“ªç§ç±»å‹çš„è´¦æˆ·ï¼ŒEVMçš„å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„</li><li>æ¯ä¸ªè´¦æˆ·éƒ½æœ‰ä¸€ä¸ªæŒä¹…çš„key-valueç±»å‹çš„å­˜å‚¨ï¼ŒæŠŠ256å­—èŠ‚çš„keyæ˜ å°„åˆ°256å­—èŠ‚çš„value</li><li>æ­¤å¤–ï¼Œæ¯ä¸ªè´¦æˆ·éƒ½æœ‰ä»¥â€œWeiâ€ä¸ºå•ä½ï¼Œåœ¨äº¤æ˜“è¿‡ç¨‹ä¸­ä¼šè¢«ä¿®æ”¹çš„èµ„äº§(balance)ä¿¡æ¯</li></ul><h4 id="äº¤æ˜“"><a href="#äº¤æ˜“" class="headerlink" title="äº¤æ˜“"></a>äº¤æ˜“</h4><ul><li>äº¤æ˜“æ˜¯ä¸€ä¸ªä»è´¦æˆ·å‘å¾€å¦ä¸€ä¸ªè´¦æˆ·ï¼ˆå¯ä»¥æ˜¯åŒä¸€ä¸ªè´¦æˆ·æˆ–è€…æ˜¯special zero-accountï¼‰çš„æ¶ˆæ¯ã€‚å®ƒåŒ…å«äºŒè¿›åˆ¶æ•°æ®ï¼ˆäº¤æ˜“ç›¸å…³çš„æ•°æ®ï¼‰å’Œ Etherã€‚</li><li>å¦‚æœç›®æ ‡è´¦æˆ·åŒ…å«ä»£ç ï¼Œä»£ç ä¼šè¢«æ‰§è¡Œï¼Œäº¤æ˜“ç›¸å…³çš„æ•°æ®å°†ä½œä¸ºå‚æ•°</li><li>å¦‚æœç›®æ ‡è´¦æˆ·æ˜¯åœ°å€ä¸º0çš„è´¦æˆ·<code>zero-account</code>, äº¤æ˜“ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åˆçº¦ã€‚å¦‚ä¸Šæ–‡æåˆ°çš„ï¼Œåˆçº¦åœ°å€ä¸æ˜¯ä¸€ä¸ªåœ°å€ä¸º0çš„åœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªç”±äº¤æ˜“å‘é€è€…å’Œäº¤æ˜“æ•°æ¥å†³å®šçš„åœ°å€ã€‚è¿™æ ·çš„ä¸€ç¬”ï¼ˆåˆ°zero-accountï¼‰äº¤æ˜“çš„ç›¸å…³å‚æ•°ä¼šè¢«è½¬åŒ–ä¸ºEVMå­—èŠ‚ç <br>ç„¶åè¢«æ‰§è¡Œï¼Œè¾“å‡ºç»“æœå°±æ˜¯è¢«æ°¸ä¹…å­˜å‚¨çš„åˆçº¦ä»£ç ã€‚è¿™æ„å‘³ç€ä¸ºäº†åˆ›å»ºä¸€ä¸ªåˆçº¦ï¼Œå¹¶ä¸éœ€è¦å‘é€çœŸå®çš„åˆçº¦ä»£ç ï¼Œä»£ç å¯ä»¥è¢«è‡ªåŠ¨åˆ›å»º</li></ul><h4 id="gas"><a href="#gas" class="headerlink" title="gas"></a>gas</h4><ul><li>åˆ›å»ºä¹‹åï¼Œæ¯ç¬”äº¤æ˜“éƒ½éœ€è¦ä¸€å®šæ•°é‡çš„gasï¼Œç”¨äºé™åˆ¶äº¤æ˜“æ‰€æ¶ˆè€—çš„å·¥ä½œé‡ï¼Œå³äº¤æ˜“æ˜¯éœ€è¦ä»˜å‡ºä»£ä»·çš„ï¼ˆé¿å…DDoSæ”»å‡»ï¼‰ã€‚EVMæ‰§è¡Œäº¤æ˜“çš„è¿‡ç¨‹ä¸­ï¼Œgasä¼šæŒ‰ä¸€ä¸ªç‰¹æ®Šè§„åˆ™é€æ¸å‡å°‘</li><li>è´¹ç”¨çš„å¤šå°‘æ˜¯ç”±äº¤æ˜“å‘èµ·è€…è®¾ç½®ï¼Œè‡³å°‘éœ€è¦ä»å‘èµ·è´¦æˆ·æ”¯ä»˜<code>gas_price * gas</code>ç”¨è´¹ã€‚å¦‚æœäº¤æ˜“æ‰§è¡Œå®Œæ¯•è´¹ç”¨è¿˜æœ‰å‰©ä½™çš„ï¼Œå°†é€€å›åˆ°å‘èµ·è´¦æˆ·ã€‚</li><li>å¦‚æœäº¤æ˜“å®Œæˆä¹‹å‰è´¹ç”¨è€—å°½ï¼Œå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>out-of-gas</code>çš„å¼‚å¸¸ï¼Œæ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¼šè¢«å›æ»š</li></ul><p>æ›´å¤šå…³äºgasçš„ç†è§£å’Œè®¨è®ºå¯ä»¥<a href="http://bitshuo.com/topic/5857774a2a482b0d339aab99/" target="_blank" rel="noopener">æˆ³è¿™é‡Œ</a></p><h4 id="storage-memory-stack"><a href="#storage-memory-stack" class="headerlink" title="storage,memory,stack"></a>storage,memory,stack</h4><ul><li>æ¯ä¸ªè´¦æˆ·éƒ½æœ‰ä¸€ä¸ªæŒä¹…çš„å†…å­˜ç©ºé—´ï¼Œç§°ä¹‹ä¸º<code>storage</code>,<code>storage</code>ä»¥key-valueå½¢å¼å­˜å‚¨ï¼Œ256å­—èŠ‚çš„keyæ˜ å°„åˆ°256å­—èŠ‚valueï¼Œåˆçº¦å†…éƒ¨ä¸å¯èƒ½æšä¸¾<code>storage</code>(å†…éƒ¨å…ƒç´ )ï¼Œè¯»å–æˆ–è€…ä¿®æ”¹<code>storage</code>æ“ä½œæ¶ˆè€—éƒ½å¾ˆå¤§(åŸæ–‡æ˜¯ It is not possible to enumerate storage from within a contract and it is comparatively costly to read and even more so, to modify storage. )ã€‚ åˆçº¦åªèƒ½è¯»å–å’Œä¿®æ”¹è‡ªå·±çš„<code>storage</code>é‡Œçš„æ•°æ®ã€‚</li><li>ç¬¬äºŒç§å†…å­˜ç©ºé—´ç§°ä¹‹ä¸º<code>memory</code>,é‡Œé¢å­˜å‚¨ç€æ¯ä¸ªæ¶ˆæ¯è°ƒç”¨æ—¶åˆçº¦åˆ›å»ºçš„å®ä¾‹ã€‚<code>memory</code>æ˜¯çº¿å‹çš„ï¼Œå¯ä»¥ä»¥å­—èŠ‚çº§åˆ«æ¥å¤„ç†ï¼Œä½†æ˜¯é™åˆ¶ä¸º256å­—èŠ‚å®½åº¦ï¼Œå†™å…¥å¯ä»¥æ˜¯8æˆ–256å­—èŠ‚å®½åº¦ã€‚å½“è¯»å–æˆ–å†™å…¥ä¸€ä¸ªé¢„å…ˆæœªè§¦å‘çš„æŒ‡ä»¤çš„æ—¶å€™ä¼šæ¶ˆè€—<code>memory</code>çš„ç©ºé—´ï¼Œæ¶ˆè€—ç©ºé—´çš„åŒæ—¶ï¼Œå¿…é¡»æ”¯ä»˜gasã€‚<code>memory</code>æ¶ˆè€—çš„è¶Šå¤šï¼Œéœ€è¦çš„gasè¶Šå¤šï¼ˆæŒ‰å¹³æ–¹çº§å¢é•¿ï¼‰</li><li>EVMä¸æ˜¯ä¸€ä¸ªæ³¨å†Œçš„æœºå™¨è€Œæ˜¯ä¸€ä¸ªå †æ ˆæœºå™¨ï¼Œæ‰€ä»¥æ‰€æœ‰çš„è®¡ç®—æŒ‡ä»¤éƒ½åœ¨<code>stack</code>ç©ºé—´é‡Œé¢æ‰§è¡Œã€‚<code>stack</code>æœ€å¤šåªèƒ½å®¹çº³1024ä¸ªé•¿åº¦ä¸è¶…è¿‡256å­—èŠ‚çš„æŒ‡ä»¤å…ƒç´ ã€‚åªèƒ½ç”¨ä¸‹è¿°æ–¹æ³•ï¼Œä»é¡¶éƒ¨è®¿é—®<code>stack</code>ï¼šå¯ä»¥æ‹·è´æœ€é¡¶éƒ¨çš„16ä¸ªå…ƒç´ ä¸­çš„ä¸€ä¸ªåˆ°<code>stack</code>çš„æœ€é¡¶éƒ¨ï¼Œæˆ–è€…å°†æœ€é¡¶éƒ¨çš„é‚£ä¸ªå…ƒç´ ä¸å…¶ä¸‹é¢çš„16ä¸ªå…ƒç´ ä¹‹ä¸€äº’æ¢ã€‚æ‰€æœ‰å…¶å®ƒæ“ä½œä»<code>stack</code>æœ€é¡¶éƒ¨å–å‡ºä¸¤ä¸ªï¼ˆæˆ–ä¸€ä¸ªï¼Œæˆ–æ›´å¤šï¼Œå–å†³äºæ“ä½œï¼‰å…ƒç´ ï¼Œç„¶åæŠŠç»“æœpushåˆ°<code>stack</code>é¡¶ç«¯ã€‚å½“ç„¶å°†<code>stack</code>ä¸­çš„å…ƒç´ ç§»åˆ°<code>memory</code>æˆ–è€…<code>storage</code>ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®<code>stack</code>ä¸­é—´çš„å…ƒç´ ï¼ˆå¿…é¡»ä»å¤´éƒ¨å¼€å§‹è®¿é—®ï¼‰</li></ul><h4 id="æŒ‡ä»¤é›†åˆ"><a href="#æŒ‡ä»¤é›†åˆ" class="headerlink" title="æŒ‡ä»¤é›†åˆ"></a>æŒ‡ä»¤é›†åˆ</h4><ul><li>EVMçš„æŒ‡ä»¤é›†åˆæ§åˆ¶çš„å¾ˆå°ï¼Œè¿™æ ·å¯ä»¥é¿å…é”™è¯¯çš„æ‰§è¡Œå¼•å‘é—®é¢˜ã€‚æ‰€æœ‰çš„æŒ‡ä»¤éƒ½æ˜¯æ“ä½œæœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œ256å­—èŠ‚ã€‚è€Œä¸”éƒ½æ˜¯æœ€å¸¸è§çš„é€»è¾‘ï¼Œç®—æ³•ï¼Œå­—èŠ‚å’Œæ¯”è¾ƒè¿ç®—ã€‚æœ‰æ¡ä»¶æˆ–æ— æ¡ä»¶çš„è·³è½¬éƒ½å¯ä»¥ã€‚æ­¤å¤–ï¼Œåˆçº¦å¯ä»¥è®¿é—®å½“å‰åŒºå—çš„å±æ€§ï¼Œæ¯”å¦‚åŒºå—ç¼–å·å’Œæ—¶é—´æˆ³ã€‚</li></ul><h4 id="æ¶ˆæ¯è°ƒç”¨"><a href="#æ¶ˆæ¯è°ƒç”¨" class="headerlink" title="æ¶ˆæ¯è°ƒç”¨"></a>æ¶ˆæ¯è°ƒç”¨</h4><ul><li>åˆçº¦ä¹‹é—´å¯ä»¥é€šè¿‡æ¶ˆæ¯è°ƒç”¨çš„æ–¹å¼è¿›è¡Œç›¸äº’è°ƒç”¨æˆ–è€…å¦ä¸€ä¸ªç»™å¦ä¸€ä¸ªæ— åˆçº¦è´¦æˆ·ï¼ˆå¤–éƒ¨è´¦æˆ·ï¼‰è½¬å¸ã€‚æ¶ˆæ¯è°ƒç”¨å¾ˆåƒäº¤æ˜“ï¼Œä¸¤è€…éƒ½æœ‰æºè´¦æˆ·ï¼Œç›®æ ‡è´¦æˆ·ï¼Œæ•°æ®ï¼ˆdata payloadï¼‰ï¼Œ<code>Ether</code>,è´¹ç”¨å’Œè¿”å›æ•°æ®ã€‚å®é™…ä¸Šæ¯ç¬”äº¤æ˜“éƒ½ç”±ä¸€ä¸ªå¯åˆ›å»ºæ›´å¤šè°ƒç”¨çš„é¡¶çº§è°ƒç”¨ç»„æˆã€‚</li><li>åˆçº¦å¯ä»¥å†³å®šå†…éƒ¨æ¶ˆæ¯è°ƒç”¨çš„æ—¶å€™å‘é€å¤šå°‘æ‰‹ç»­è´¹ï¼Œä¿ç•™å¤šå°‘ã€‚å¦‚æœåœ¨å†…éƒ¨æ¶ˆæ¯è°ƒç”¨çš„æ—¶å€™æŠ›å‡º<code>out-of-gas</code>å¼‚å¸¸ï¼ˆæˆ–è€…å…¶å®ƒå¼‚å¸¸ï¼‰ï¼Œè¿™ä¸ªä¼šè¢«ä¸€ä¸ªé”™è¯¯å€¼æ ‡è®°ï¼Œæ”¾åˆ°<code>stack</code>é¡¶éƒ¨ã€‚å¦‚æ­¤ï¼Œåªæœ‰å’Œæ¶ˆæ¯ä¸€èµ·å‘å‡ºçš„æ‰‹ç»­è´¹æ‰ä¼šè¢«æ¶ˆè€—ã€‚åœ¨<code>Solidity</code>ä¸­è¿™ç§æƒ…å½¢é»˜è®¤ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œä»¥ä¾¿å¼‚å¸¸â€œå†’æ³¡â€åˆ°<code>stack</code>æœ€é¡¶ç«¯</li><li>å¦‚ä¸Šæ‰€è¿°ï¼Œè¢«è°ƒç”¨çš„åˆçº¦ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªåˆšåˆ›å»ºçš„<code>memory</code>å®ä¾‹ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®è°ƒç”¨å‚æ•°ï¼Œè°ƒç”¨å‚æ•°è¢«å­˜å‚¨åœ¨ä¸€ä¸ªè¢«ä¸º<code>calldata</code>çš„éš”ç¦»çš„åŒºåŸŸã€‚æ‰§è¡Œå®Œæ¯•åï¼Œè¢«è°ƒç”¨çš„åˆçº¦å°†è¿”å›æ•°æ®å­˜å‚¨åœ¨è°ƒç”¨åˆçº¦é¢„å…ˆåˆ›å»ºçš„å†…å­˜ä¸­ã€‚</li><li>è°ƒç”¨è¢«é™åˆ¶åœ¨1024æ·±åº¦ï¼Œè¿™æ„å‘³ç€å¤æ‚çš„æ“ä½œåº”å°½é‡ä½¿ç”¨å¾ªç¯ä»£æ›¿é€’å½’è°ƒç”¨ã€‚</li></ul><h4 id="ä»£ç†è°ƒç”¨-è°ƒç”¨ä»£ç å’Œåº“"><a href="#ä»£ç†è°ƒç”¨-è°ƒç”¨ä»£ç å’Œåº“" class="headerlink" title="ä»£ç†è°ƒç”¨/è°ƒç”¨ä»£ç å’Œåº“"></a>ä»£ç†è°ƒç”¨/è°ƒç”¨ä»£ç å’Œåº“</h4><ul><li>å­˜åœ¨ä¸€ç§ç§°ä¸º<code>delegatecall</code>çš„ç‰¹æ®Šçš„å¤šæ ·æ€§çš„æ¶ˆæ¯è°ƒç”¨ï¼Œwhich is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.</li><li>è¿™æ„å‘³ç€åˆçº¦å¯ä»¥åœ¨è¿è¡Œçš„æ—¶å€™åŠ¨æ€çš„ä»å¦ä¸€ä¸ªåœ°å€åŠ è½½ä»£ç ã€‚å­˜å‚¨ã€å½“å‰åœ°å€å’Œèµ„äº§ä»ç„¶å’Œè°ƒç”¨çš„åˆçº¦ç›¸å…³è”ï¼Œåªæœ‰ä»£ç æ¥è‡ªè¢«è°ƒç”¨çš„åœ°å€ã€‚</li><li>è¿™æ ·å¯ä»¥å®ç°Solidityåº“çš„ç‰¹æ€§:åå¤ä½¿ç”¨çš„åº“ä»£ç å¯ä»¥è¢«åº”ç”¨åˆ°åˆçº¦çš„<code>storage</code>æ¥å®ç°å¤æ‚çš„æ•°æ®ç»“æ„ã€‚</li></ul><h4 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h4><p>It is possible to store data in a specially indexed data structure that maps all the way up to the block level. This feature called logs is used by Solidity in order to implement events. Contracts cannot access log data after it has been created, but they can be efficiently accessed from outside the blockchain. Since some part of the log data is stored in bloom filters, it is possible to search for this data in an efficient and cryptographically secure way, so network peers that do not download the whole blockchain (â€œlight clientsâ€) can still find these logs.</p><h4 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h4><ul><li>åˆçº¦ç”šè‡³å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„<code>opcode</code>åˆ›å»ºå…¶å®ƒçš„åˆçº¦,<code>create</code>æ¶ˆæ¯è°ƒç”¨å’Œæ™®é€šçš„æ¶ˆæ¯è°ƒç”¨åŒºåˆ«åœ¨äºï¼Œ<code>create</code>æ¶ˆæ¯è°ƒç”¨çš„dataå­—æ®µä¼šè¢«æ‰§è¡Œï¼Œæ‰§è¡Œç»“æœä»¥ä»£ç çš„å½¢å¼å­˜å‚¨ï¼Œè°ƒç”¨è€…å¯åœ¨stackä¸Šæ¥æ¥åˆ°æ–°åˆçº¦è´¦æˆ·çš„åœ°å€</li></ul><ul><li>ç¤ºä¾‹ä¸€</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract ClassifyStorage &#123;</span><br><span class="line">    mapping(address =&gt; string) details;</span><br><span class="line">    event AddDetailEvent(address classify, string detail);</span><br><span class="line"></span><br><span class="line">    function addDetail(address classify, string detail) public &#123;</span><br><span class="line">        details[classify] = strConcat(details[classify], detail);</span><br><span class="line">        AddDetailEvent(classify, detail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSpecificDetails(address classify) constant public returns (string) &#123;</span><br><span class="line">        return details[classify];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function strConcat(string _a, string _b) internal returns (string)&#123;</span><br><span class="line">        bytes memory _ba = bytes(_a);</span><br><span class="line">        if(_ba.length == 0) &#123;</span><br><span class="line">            return _b;</span><br><span class="line">        &#125;</span><br><span class="line">        bytes memory _bb = bytes(_b);</span><br><span class="line">        string memory ret = new string(_ba.length + _bb.length + 1);</span><br><span class="line">        bytes memory bret = bytes(ret);</span><br><span class="line">        uint k = 0;</span><br><span class="line">        for (uint i = 0; i &lt; _ba.length; i++)bret[k++] = _ba[i];</span><br><span class="line">        bret[k++] = &quot;,&quot;;</span><br><span class="line">        for (i = 0; i &lt; _bb.length; i++) bret[k++] = _bb[i];</span><br><span class="line">        return string(ret);</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth</title>
      <link href="/2019/10/14/eth/"/>
      <url>/2019/10/14/eth/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»¥å¤ªåŠåŸºæœ¬è®¤è¯†å’Œç†è§£ç¬”è®°"><a href="#ä»¥å¤ªåŠåŸºæœ¬è®¤è¯†å’Œç†è§£ç¬”è®°" class="headerlink" title="ä»¥å¤ªåŠåŸºæœ¬è®¤è¯†å’Œç†è§£ç¬”è®°"></a>ä»¥å¤ªåŠåŸºæœ¬è®¤è¯†å’Œç†è§£ç¬”è®°</h2><h4 id="åŸºæœ¬æ¶æ„å›¾"><a href="#åŸºæœ¬æ¶æ„å›¾" class="headerlink" title="åŸºæœ¬æ¶æ„å›¾"></a>åŸºæœ¬æ¶æ„å›¾</h4><p>å›¾â€¦..</p><p>æ ¸å¿ƒæ¨¡å—: åŸºç¡€ç»“æ„ï¼Œå…±è¯†ç®—æ³•ï¼Œç½‘ç»œæ¨¡å—ï¼Œå…¶å®ƒæ¨¡å—ã€‚è¿™å‡ ä¸ªæ¨¡å—çš„å†…å®¹ï¼Œè·Ÿæ¯”ç‰¹å¸çš„æ¨¡å—æœ‰ç‚¹åƒå•Šã€‚</p><p>åˆçº¦å±‚æ˜¯ä½¿ç”¨Solidityè¯­è¨€ç¼–å†™çš„æ™ºèƒ½åˆçº¦ï¼Œå…¶è¿è¡Œåœ¨EVMä»¥å¤ªåŠè™šæ‹Ÿæœºä¸Šï¼Œå¹¶ä¼šé€šè¿‡HTTP-RPCæˆ–JSON-RPCè°ƒç”¨å’Œä»¥å¤ªåŠçš„æ ¸å¿ƒå±‚äº¤äº’ã€‚</p><p>ä»¥å¤ªåŠæ¶æ„çš„æœ€ä¸Šå±‚æ˜¯DAppåº”ç”¨å±‚ï¼Œå®ƒé€šè¿‡Web3.jsè¿™ç§JavaScript APIå’Œæ™ºèƒ½åˆçº¦å±‚è¿›è¡Œäº¤äº’ã€‚</p><h4 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h4><h5 id="ether"><a href="#ether" class="headerlink" title="ether"></a>ether</h5><p>etherä¸ºä»¥å¤ªåŠä¸­çš„å†…ç½®è´§å¸ã€‚ä¾‹å¦‚ï¼ŒçŸ¿å·¥æŒ–å‡ºæ–°çŸ¿æ—¶ï¼Œå¥–åŠ±çš„ä¾¿æ˜¯etherã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯æä¾›ä¸»è¦æµåŠ¨æ€§å±‚ï¼Œä»¥å®ç°å„ç§æ•°å­—èµ„äº§ä¹‹é—´çš„æœ‰æ•ˆäº¤æ¢ï¼Œæ›´é‡è¦çš„æ˜¯æä¾›æ”¯ä»˜äº¤æ˜“è´¹ç”¨çš„æœºåˆ¶ã€‚</p><ul><li><p>é¦–å…ˆï¼Œè°éœ€è¦etherå‘¢ï¼Ÿ</p><ol><li>æ‰“ç®—å¼€å‘ä½¿ç”¨ethereumåŒºå—é“¾çš„åº”ç”¨çš„å¼€å‘è€…ã€‚</li><li>æƒ³è¦åœ¨ethereumåŒºå—é“¾ä¸Šè®¿é—®å¹¶ä¸æ™ºèƒ½åˆåŒäº¤äº’çš„ç”¨æˆ·ã€‚</li></ol></li><li><p>å…¶æ¬¡ï¼Œetherä¸bitcoinçš„å…³ç³»æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>Ethereum would never be possible without bitcoinâ€”both the technology and the currencyâ€”and we see ourselves not as a competing currency but as complementary within the digital ecosystem. Ether is to be treated as â€œcrypto-fuelâ€, a token whose purpose is to pay for computation, and is not intended to be used as or considered a currency, asset, share or anything else.</p></blockquote></li></ul><p>â€‹         æ„æ€å‘¢ï¼Œå°±æ˜¯äºŒè€…å¹¶éç«äº‰å…³ç³»ï¼Œè€Œæ˜¯äº’ç›¸è¡¥å……çš„å…³ç³»ã€‚etherçš„ç›®çš„æ˜¯è®¡ç®—ä»˜è´¹ï¼Œå¹¶ä¸æ‰“ç®—ç”¨ä½œè´§å¸ï¼Œèµ„äº§ï¼Œè‚¡ç¥¨æˆ–å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚åœ¨ä¸€äº›ä»¥å¤ªåŠçš„ç”Ÿæ€ä¸­ï¼Œetherä¸bitcoinæ˜¯å¯ä»¥è¿›è¡Œä»·å€¼å…‘æ¢çš„ã€‚</p><h5 id="gas"><a href="#gas" class="headerlink" title="gas"></a>gas</h5><p>gasä¸ºè®¡ç®—èŠ±è´¹çš„åŸºæœ¬å•ä½ã€‚é€šå¸¸ï¼Œä¸€æ­¥çš„è®¡ç®—èŠ±è´¹1gasï¼Œä½†æ˜¯ä¸€äº›æ“ä½œè€—è´¹æ›´é«˜çš„æ°”ä½“é‡ï¼Œå› ä¸ºå®ƒä»¬åœ¨è®¡ç®—ä¸Šæ›´æ˜‚è´µï¼Œæˆ–è€…å¢åŠ äº†ä½œä¸ºçŠ¶æ€çš„ä¸€éƒ¨åˆ†å¿…é¡»å­˜å‚¨çš„æ•°æ®é‡ã€‚äº¤æ˜“æ•°æ®ä¸­çš„æ¯ä¸ªå­—èŠ‚çš„è´¹ç”¨5gas,æ”¶è´¹ç³»ç»Ÿçš„ç›®çš„æ˜¯è¦æ±‚æ”»å‡»è€…æŒ‰æ¯”ä¾‹æ”¯ä»˜å¥¹ä»¬æ¶ˆè´¹çš„æ¯ç§èµ„æºï¼ŒåŒ…æ‹¬è®¡ç®—é‡ï¼Œå¸¦å®½å’Œå­˜å‚¨é‡ã€‚</p><p>ä¸€ç¬”äº¤æ˜“ï¼Œé™¤äº†éœ€è¦åŒ…å«æ¥æ”¶æ–¹ï¼Œå‘ä»¶äººç­¾åï¼Œetherçš„æ•°é‡ï¼Œä¹‹å¤–ï¼Œè¿˜éœ€è¦åŒ…å«æ•°æ®å­—æ®µï¼ˆå¯é€‰ï¼‰ï¼Œä¸€ä¸ªSTARTGASå€¼ï¼Œè¡¨ç¤ºå…è®¸æ‰§è¡Œäº‹åŠ¡æ‰§è¡Œçš„æœ€å¤§è®¡ç®—æ­¥éª¤æ•°ï¼Œå’Œä¸€ä¸ªGASPRICEå€¼ï¼Œå³ä¸ºæ¯gasçš„èŠ±è´¹çš„etherã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œç°æœ‰ä¸€ç¬”äº¤æ˜“ï¼Œå†…å®¹ä¸ºå‘é€çš„etherä¸º10ï¼ŒSTARTGASä¸º2000ï¼ŒGASPRICEä¸º0.001ï¼Œå’Œä¸€ä¸ª64bytesçš„æ•°æ®ï¼Œé‚£ä¹ˆè®¡ç®—å…è®¸çš„æ‰€éœ€è¦çš„etherä¸ºå•ä»·*æ•°é‡=2000 * 0.001=2ã€‚ æ¯”è¾ƒè¯¦ç»†çš„äº¤æ˜“å¦‚ä¸‹</p><ol><li><p>æ£€æŸ¥äº¤æ˜“æ˜¯å¦æœ‰æ•ˆ</p></li><li><p>æ£€æŸ¥å‘é€æ–¹è´¦æˆ·æ˜¯å¦è‡³å°‘å«æœ‰2000*0.001=2 ether, å¦‚æœæœ‰ï¼Œåˆ™ä»å‘é€æ–¹è´¦æˆ·ä¸­å‡å»2 ether</p></li><li><p>æ€»å…±æœ‰2000gas, å‡è®¾äº¤æ˜“é•¿åº¦ä¸º170bytes, æ¯bytes 5gas,é‚£ä¹ˆå‡å»850ï¼Œå‰©ä½™1150gas</p></li><li><p>ä»å‘é€æ–¹è´¦æˆ·ä½™é¢ä¸­å‡å»å‘é€çš„10 ether, å¹¶æ·»åŠ åˆ°åˆçº¦è´¦æˆ·ä¸­</p></li><li><p>è¿è¡Œä»£ç è¿›è¡Œè®¡ç®—ï¼Œå‡è®¾è®¡ç®—è¿‡ç¨‹æ¶ˆè€—äº†187gas, é‚£ä¹ˆå‰©ä½™1150-187=963gas</p></li><li><p>å°†963gasè½¬æ¢ä¸ºether, æ­¤é¡¹äº¤æ˜“ä¸­å•ä»·æ˜¯0.001ï¼Œé‚£ä¹ˆè¿”å›åˆ°å‘é€æ–¹çš„etherä¸º0.963</p></li></ol><h5 id="è´¦æˆ·"><a href="#è´¦æˆ·" class="headerlink" title="è´¦æˆ·"></a>è´¦æˆ·</h5><p> åœ¨ä»¥å¤ªåŠä¸­ï¼ŒçŠ¶æ€ç”±è´¦æˆ·å¯¹è±¡ç»„æˆï¼Œæ¯ä¸ªè´¦æˆ·éƒ½æœ‰ä¸€ä¸ª20byteçš„åœ°å€ï¼ŒçŠ¶æ€è½¬æ¢æ˜¯è´¦æˆ·ä¹‹é—´ä»·å€¼å’Œä¿¡æ¯çš„ç›´æ¥è½¬ç§»ã€‚ä»¥å¤ªåŠè´¦æˆ·åŒ…å«å››ä¸ªå­—æ®µï¼š</p><ul><li>nonce, ç”¨æ¥ç¡®ä¿æ¯ç¬”äº¤æ˜“æŸœå°ä¸€æ¬¡åªèƒ½å¤„ç†</li><li>è´¦æˆ·å½“å‰çš„etherä½™é¢</li><li>è´¦æˆ·çš„åˆçº¦ä»£ç ï¼Œå¦‚æœå­˜åœ¨çš„è¯</li><li>è´¦æˆ·çš„å­˜å‚¨ç©ºé—´ï¼Œé»˜è®¤ä¸ºç©º</li></ul><p>é€šå¸¸ï¼Œæœ‰ä¸¤ç§è´¦æˆ·ï¼Œå¤–éƒ¨çš„ä¸ªäººæ‹¥æœ‰çš„è´¦æˆ·ï¼Œä½¿ç”¨ç§é’¥è¿›è¡Œæ§åˆ¶ï¼› ä»¥åŠåˆçº¦è´¦æˆ·ï¼Œè¢«åˆçº¦ä»£ç æ§åˆ¶ã€‚ä¸ªäººè´¦æˆ·èƒ½å¤Ÿå‘é€æ¶ˆæ¯ä»¥åŠåˆ›å»ºå¹¶ç­¾ç½²äº¤æ˜“ã€‚åˆçº¦è´¦æˆ·æ”¶åˆ°å…¶æ¿€æ´»ç å¯è¯»å†™å†…å­˜ï¼Œå‘é€æ¶ˆæ¯ä»¥åŠåˆ›å»ºæ–°çš„åˆçº¦</p><h5 id="æ¶ˆæ¯å’Œäº¤æ˜“"><a href="#æ¶ˆæ¯å’Œäº¤æ˜“" class="headerlink" title="æ¶ˆæ¯å’Œäº¤æ˜“"></a>æ¶ˆæ¯å’Œäº¤æ˜“</h5><p>äº¤æ˜“éœ€è¦åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>æ¶ˆæ¯çš„æ”¶ä»¶äºº</li><li>è¯†åˆ«å‘ä»¶äººçš„ç­¾å</li><li>å‘é€çš„etheræ•°é‡</li><li>å¯é€‰çš„æ•°æ®å­—æ®µ</li><li>ä¸€ä¸ª<code>STARTGAS</code>å€¼ï¼Œè¡¨ç¤ºå…è®¸æ‰§è¡Œäº‹åŠ¡æ‰§è¡Œçš„æœ€å¤§è®¡ç®—æ­¥éª¤æ•°</li><li>ä¸€ä¸ª<code>GASPRICE</code>å€¼ï¼Œè¡¨ç¤ºå‘ä»¶äººæŒ‰è®¡ç®—æ­¥éª¤æ”¯ä»˜çš„è´¹ç”¨</li></ul><p>æ¶ˆæ¯åŒ…å«ï¼š</p><ul><li>æ¶ˆæ¯çš„å‘é€è€…ï¼ˆéšå¼ï¼‰</li><li>æ¶ˆæ¯çš„æ”¶ä»¶äºº</li><li>ä¸æ¶ˆæ¯ä¸€èµ·ä¼ è¾“çš„etheræ•°é‡</li><li>å¯é€‰çš„æ•°æ®å­—æ®µ</li><li>ä¸€ä¸ª<code>STARTGAS</code>å€¼</li></ul><p>ä»æœ¬è´¨ä¸Šè®²ï¼Œæ¶ˆæ¯å°±åƒä¸€ä¸ªäº¤æ˜“ï¼Œé™¤äº†å®ƒæ˜¯ç”±åˆåŒäº§ç”Ÿçš„è€Œä¸æ˜¯ç”±å¤–éƒ¨å‚ä¸è€…äº§ç”Ÿçš„ã€‚å½“ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œä»£ç çš„åˆåŒæ‰§è¡Œ<code>CALL</code>æ“ä½œç æ—¶ï¼Œäº§ç”Ÿä¸€æ¡æ¶ˆæ¯ï¼Œè¯¥æ“ä½œç äº§ç”Ÿå¹¶æ‰§è¡Œä¸€æ¡æ¶ˆæ¯ã€‚å°±åƒä¸€ä¸ªäº¤æ˜“ï¼Œä¸€æ¡æ¶ˆæ¯å¯¼è‡´æ”¶ä»¶äººè´¦æˆ·è¿è¡Œå…¶ä»£ç ã€‚å› æ­¤ï¼Œåˆçº¦å¯ä»¥ä¸å¤–éƒ¨å‚ä¸è€…å®Œå…¨ç›¸åŒçš„æ–¹å¼ä¸å…¶ä»–åˆçº¦æœ‰å…³ç³»ã€‚</p><p>è¯·æ³¨æ„ï¼Œäº¤æ˜“æˆ–åˆåŒåˆ†é…çš„gasé™é¢é€‚ç”¨äºè¯¥äº¤æ˜“å’Œæ‰€æœ‰å­æ‰§è¡Œæ¶ˆè€—çš„gasé‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¤–éƒ¨å‚ä¸è€…Aå‘Bå‘é€1000ä¸ªgasçš„äº‹åŠ¡ï¼Œå¹¶ä¸”Båœ¨å‘Cå‘é€æ¶ˆæ¯ä¹‹å‰æ¶ˆè€—600gasï¼Œå¹¶ä¸”Cçš„å†…éƒ¨æ‰§è¡Œåœ¨è¿”å›ä¹‹å‰æ¶ˆè€—300gasï¼Œåˆ™Båœ¨è¿è¡Œä¹‹å‰å¯ä»¥èŠ±è´¹å¦å¤–100ä¸ªgasã€‚</p><p>è¯·æ³¨æ„ï¼Œæ¶ˆæ¯åœ¨å›å¤æ–¹é¢ä¸äº‹åŠ¡ç­‰æ•ˆï¼šå¦‚æœæ¶ˆæ¯æ‰§è¡Œè€—å°½ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯çš„æ‰§è¡Œä»¥åŠè¯¥æ‰§è¡Œè§¦å‘çš„æ‰€æœ‰å…¶ä»–æ‰§è¡Œéƒ½ä¼šæ¢å¤ï¼Œä½†çˆ¶æ‰§è¡Œä¸éœ€è¦æ¢å¤ã€‚è¿™æ„å‘³ç€åˆåŒå¯ä»¥è°ƒç”¨å¦ä¸€ä»½åˆåŒæ˜¯â€œå®‰å…¨çš„â€ï¼Œå°±å¥½åƒAç”¨Gæ°”è°ƒç”¨Bä¸€æ ·ï¼Œé‚£ä¹ˆAçš„æ‰§è¡Œä¿è¯æœ€å¤šä¼šæŸå¤±Gæ°”ã€‚æœ€åï¼Œè¯·æ³¨æ„ï¼Œæœ‰ä¸€ä¸ªæ“ä½œç <code>CREATE</code>å¯ä»¥åˆ›å»ºåˆåŒ; å…¶æ‰§è¡Œæœºåˆ¶é€šå¸¸ä¸æ‰§è¡Œæœºåˆ¶ç±»ä¼¼<code>CALL</code>ï¼Œä½†æ‰§è¡Œè¾“å‡ºå†³å®šäº†æ–°åˆ›å»ºåˆåŒçš„ä»£ç ã€‚</p><h5 id="çŠ¶æ€è½¬æ¢"><a href="#çŠ¶æ€è½¬æ¢" class="headerlink" title="çŠ¶æ€è½¬æ¢"></a>çŠ¶æ€è½¬æ¢</h5><p>ä»¥å¤ªåŠçŠ¶æ€è½¬æ¢åŠŸèƒ½<code>APPLY(S,TX) -&gt; S&#39;</code>å¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p>æ£€æŸ¥äº¤æ˜“æ˜¯å¦æ ¼å¼æ­£ç¡®ï¼ˆå³å…·æœ‰æ­£ç¡®æ•°é‡çš„å€¼ï¼‰ï¼Œç­¾åæ˜¯å¦æœ‰æ•ˆï¼Œå¹¶ä¸”nonceä¸å‘ä»¶äººå¸æˆ·ä¸­çš„nonceç›¸åŒ¹é…ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</p></li><li><p>è®¡ç®—äº¤æ˜“è´¹ç”¨<code>STARTGAS * GASPRICE</code>ï¼Œå¹¶ä»ç­¾åç¡®å®šå‘é€åœ°å€ã€‚ä»å‘ä»¶äººå¸æˆ·ä½™é¢ä¸­æ‰£é™¤è´¹ç”¨å¹¶å¢åŠ å‘ä»¶äººçš„nonceã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ä½™é¢å¯ç”¨ï¼Œè¯·è¿”å›é”™è¯¯ã€‚</p></li><li><p>åˆå§‹åŒ–<code>GAS = STARTGAS</code>å¹¶åœ¨æ¯ä¸ªå­—èŠ‚ä¸­å–å‡ºä¸€å®šæ•°é‡çš„æ°”ä½“ä»¥æ”¯ä»˜äº¤æ˜“ä¸­çš„å­—èŠ‚æ•°ã€‚</p></li><li><p>å°†äº¤æ˜“é‡‘é¢ä»å‘ä»¶äººçš„å¸æˆ·è½¬ç§»åˆ°æ”¶æ¬¾å¸æˆ·ã€‚å¦‚æœæ¥æ”¶å¸æˆ·å°šä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºå®ƒã€‚å¦‚æœæ¥æ”¶è´¦æˆ·æ˜¯åˆåŒï¼Œåˆ™è¿è¡ŒåˆåŒä»£ç ä»¥å®Œæˆæˆ–ç›´åˆ°æ‰§è¡Œç”¨å®Œä¸ºæ­¢ã€‚</p></li><li><p>å¦‚æœç”±äºå‘ä»¶äººæ²¡æœ‰è¶³å¤Ÿçš„èµ„é‡‘æˆ–ä»£ç æ‰§è¡Œè€—å°½è€Œå¯¼è‡´ä»·å€¼è½¬ç§»å¤±è´¥ï¼Œè¯·æ¢å¤é™¤æ”¯ä»˜è´¹ç”¨ä¹‹å¤–çš„æ‰€æœ‰çŠ¶æ€æ›´æ”¹ï¼Œå¹¶å°†è´¹ç”¨æ·»åŠ åˆ°çŸ¿å·¥å¸æˆ·ã€‚</p></li><li><p>å¦åˆ™ï¼Œå°†æ‰€æœ‰å‰©ä½™å¤©ç„¶æ°”çš„è´¹ç”¨é€€è¿˜ç»™å‘é€æ–¹ï¼Œå¹¶å°†æ”¯ä»˜çš„å¤©ç„¶æ°”è´¹ç”¨å‘é€ç»™çŸ¿å·¥</p></li></ol><h5 id="ä»£ç æ‰§è¡Œ"><a href="#ä»£ç æ‰§è¡Œ" class="headerlink" title="ä»£ç æ‰§è¡Œ"></a>ä»£ç æ‰§è¡Œ</h5><p>åˆçº¦ä¸­çš„ä»£ç é‡‡ç”¨low-level,åŸºäºå †æ ˆçš„å­—èŠ‚ç è¯­è¨€ç¼–å†™ï¼Œç§°ä¸ºâ€ä»¥å¤ªç½‘è™šæ‹Ÿæœºä»£ç â€æˆ–â€EVMä»£ç â€ã€‚è¯¥ä»£ç ç”±ä¸€ç³»åˆ—å­—èŠ‚ç»„æˆï¼Œå…¶ä¸­æ¯ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæ“ä½œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä»£ç æ‰§è¡Œæ˜¯åœ¨å½“å‰ç¨‹åºè®¡æ•°å™¨(ä»é›¶å¼€å§‹)é‡å¤æ‰§è¡Œæ“ä½œï¼Œç„¶åå°†ç¨‹åºè®¡æ•°å™¨é€’å¢1ï¼Œç›´åˆ°ä»£ç ç»“æŸæˆ–é”™è¯¯<code>STOP</code>æˆ–<code>RETURN</code>æŒ‡ä»¤è¢«æ£€æµ‹åˆ°çš„ä¸€ä¸ªæ— é™å¾ªç¯ã€‚è¿™äº›æ“ä½œå¯ä»¥è®¿é—®ä¸‰ç§ç±»å‹çš„å­˜å‚¨ç©ºé—´ï¼š</p><ol><li>å †æ ˆï¼Œåè¿›å…ˆå‡ºå®¹å™¨ï¼Œå…¶å€¼å¯ä»¥è¢«å‹å…¥å’Œå¼¹å‡º</li><li>å†…å­˜ã€‚ä¸€ä¸ªæ— é™æ‰©å±•çš„å­—èŠ‚æ•°ç»„</li><li>åˆåŒçš„é•¿æœŸå­˜å‚¨ï¼Œä¸€ä¸ªkey/valueçš„å­˜å‚¨ï¼Œä¸è®¡ç®—ç»“æŸåé‡ç½®çš„å †æ ˆå’Œå†…å­˜ä¸åŒï¼Œå­˜å‚¨é•¿æœŸå­˜åœ¨ã€‚</li></ol><p>ä»£ç è¿˜å¯ä»¥è®¿é—®ä¼ å…¥æ¶ˆæ¯çš„å€¼ï¼Œå‘é€è€…å’Œæ•°æ®ä»¥åŠå—å¤´æ•°æ®ï¼Œä»£ç ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºè¾“å‡ºã€‚</p><p>EVMä»£ç çš„æ­£å¼æ‰§è¡Œæ¨¡å‹éå¸¸ç®€å•ã€‚å½“ä»¥å¤ªåŠè™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œå®ƒçš„å®Œæ•´è®¡ç®—çŠ¶æ€å¯ä»¥ç”±å…ƒç»„å®šä¹‰<code>(block_state, transaction, message, code, memory, stack, pc, gas)</code>ï¼Œå…¶ä¸­<code>block_state</code>æ˜¯åŒ…å«æ‰€æœ‰å¸æˆ·å¹¶åŒ…æ‹¬ä½™é¢å’Œå­˜å‚¨çš„å…¨å±€çŠ¶æ€ã€‚åœ¨æ¯ä¸€è½®æ‰§è¡Œå¼€å§‹æ—¶ï¼Œå½“å‰çš„æŒ‡ä»¤æ˜¯é€šè¿‡å–<code>pc</code>ç¬¬<code>code</code>ï¼ˆæˆ–0 <code>pc &gt;= len(code)</code>ï¼‰ä¸ªå­—èŠ‚çš„ç¬¬nä¸ªå­—èŠ‚æ¥æ‰¾åˆ°çš„ï¼Œå¹¶ä¸”æ¯æ¡æŒ‡ä»¤éƒ½æœ‰å®ƒè‡ªå·±çš„å®šä¹‰ï¼Œä»¥è¡¨æ˜å®ƒå¦‚ä½•å½±å“å…ƒç»„ã€‚ä¾‹å¦‚ï¼Œ<code>ADD</code>ä»å †å ä¸­å¼¹å‡ºä¸¤ä¸ªç‰©å“å¹¶æ¨åŠ¨å®ƒä»¬çš„æ€»å’Œï¼Œå‡<code>gas</code>1å’Œå¢<code>pc</code>1ï¼Œ<code>SSTORE</code>ä»å †æ ˆä¸­å¼¹å‡ºå‰ä¸¤ä¸ªé¡¹ç›®ï¼Œå¹¶å°†ç¬¬äºŒä¸ªé¡¹ç›®æ’å…¥åˆ°ç¬¬ä¸€ä¸ªé¡¹ç›®æŒ‡å®šçš„ç´¢å¼•å¤„çš„åˆåŒå­˜å‚¨å™¨ä¸­ã€‚è™½ç„¶æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥é€šè¿‡å³æ—¶ç¼–è¯‘æ¥ä¼˜åŒ–ä»¥å¤ªåŠè™šæ‹Ÿæœºçš„æ‰§è¡Œï¼Œä½†ä»¥å¤ªåŠçš„åŸºæœ¬å®ç°å¯ä»¥é€šè¿‡å‡ ç™¾è¡Œä»£ç å®Œæˆã€‚</p><h5 id="åŒºå—é“¾å’Œé‡‡çŸ¿"><a href="#åŒºå—é“¾å’Œé‡‡çŸ¿" class="headerlink" title="åŒºå—é“¾å’Œé‡‡çŸ¿"></a>åŒºå—é“¾å’Œé‡‡çŸ¿</h5><p>ä»¥å¤ªåŠçš„åŒºå—é“¾å’Œæ¯”ç‰¹å¸çš„åŒºå—é“¾æœ‰å¾ˆå¤šåœ°æ–¹ç›¸ä¼¼ï¼Œä¹Ÿæœ‰ä¸åŒçš„åœ°æ–¹ã€‚æœ€å¤§çš„ä¸åŒç‚¹åœ¨äºï¼Œä»¥å¤ªåŠåŒºå—åŒ…å«äº¤æ˜“åˆ—è¡¨åŠæœ€æ–°çŠ¶æ€äºŒè€…çš„å‰¯æœ¬ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåœ¨åŒºå—ä¸­è¿˜å­˜å‚¨äº†ä¸¤ä¸ªå…¶ä»–çš„å€¼ï¼ŒåŒºå—å·ï¼Œå’Œéš¾åº¦ï¼ˆè®¡ç®—éš¾åº¦ï¼‰ã€‚ä»¥å¤ªåŠä¸­çš„åŸºæœ¬å—éªŒè¯ç®—æ³•å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥å‰é¢çš„å—å¼•ç”¨æ˜¯å¦å­˜åœ¨å¹¶ä¸”æ˜¯æœ‰æ•ˆçš„ã€‚</li><li>æ£€æŸ¥å—çš„æ—¶é—´æˆ³å¤§äºå¼•ç”¨çš„å‰ä¸€ä¸ªå—çš„æ—¶é—´æˆ³ï¼Œå¹¶ä¸”åœ¨æœªæ¥15åˆ†é’Ÿå†…</li><li>æ£€æŸ¥å—å·ï¼Œéš¾åº¦ï¼Œäº¤æ˜“æ ¹ï¼Œå”å”æ ¹å’Œæ°”ä½“é™åˆ¶ï¼ˆå„ç§ä½çº§ä»¥å¤ªåŠç‰¹å®šæ¦‚å¿µï¼‰æ˜¯å¦æœ‰æ•ˆã€‚</li><li>æ£€æŸ¥å—çš„å·¥ä½œè¯æ˜æ˜¯å¦æœ‰æ•ˆã€‚</li><li>è®©æˆ‘ä»¬<code>S[0]</code>æˆä¸ºä¸Šä¸€ä¸ªåŒºå—ç»“æŸæ—¶çš„çŠ¶æ€å§ã€‚</li><li>è®©<code>TX</code>å—æˆä¸ºå…·æœ‰<code>n</code>ä¸ªäº¤æ˜“çš„äº¤æ˜“æ¸…å•ã€‚å¯¹äºæ‰€æœ‰<code>i</code>çš„<code>0...n-1</code>è®¾ç½®<code>S[i+1] = APPLY(S[i],TX[i])</code>ã€‚å¦‚æœä»»ä½•åº”ç”¨ç¨‹åºè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œæˆ–è€…å¦‚æœåœ¨è¿™ä¸ªç‚¹ä¸Šé˜»å¡çš„æ°”ä½“æ€»é‡è¶…è¿‡äº†è¿™ä¸ªæ•°é‡<code>GASLIMIT</code>ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li><li>æˆ‘ä»¬<code>S_FINAL</code>æ˜¯<code>S[n]</code>ï¼Œè€Œä¸”å°†æ”¯ä»˜ç»™çŸ¿å·¥å—å¥–åŠ±ã€‚</li><li>æ£€æŸ¥çŠ¶æ€çš„Merkleæ ‘æ ¹<code>S_FINAL</code>æ˜¯å¦ç­‰äºå—å¤´ä¸­æä¾›çš„æœ€ç»ˆçŠ¶æ€æ ¹ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¯¥å—æœ‰æ•ˆ; å¦åˆ™ï¼Œå®ƒæ˜¯æ— æ•ˆçš„ã€‚</li></ol><p>è¿™ç§æ–¹æ³•ä¹ä¸€çœ‹ä¼¼ä¹æ•ˆç‡å¾ˆä½ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨æ¯ä¸ªå—ä¸­å­˜å‚¨æ•´ä¸ªçŠ¶æ€ï¼Œä½†å®é™…ä¸Šæ•ˆç‡åº”è¯¥ä¸æ¯”ç‰¹å¸ç›¸å½“ã€‚åŸå› æ˜¯çŠ¶æ€å­˜å‚¨åœ¨æ ‘çŠ¶ç»“æ„ä¸­ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªå—ä¹‹ååªéœ€è¦æ”¹å˜æ ‘çš„ä¸€å°éƒ¨åˆ†ã€‚å› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ä¸¤ä¸ªç›¸é‚»å—ä¹‹é—´ï¼Œç»å¤§å¤šæ•°æ ‘åº”è¯¥æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤æ•°æ®å¯ä»¥è¢«å­˜å‚¨ä¸€æ¬¡å¹¶ä¸”ä½¿ç”¨æŒ‡é’ˆï¼ˆå³å­æ ‘çš„æ•£åˆ—ï¼‰è¢«å¼•ç”¨ä¸¤æ¬¡ã€‚ä¸€ç§ç§°ä¸ºâ€œPatriciaæ ‘â€çš„ç‰¹æ®Šæ ‘è¢«ç”¨æ¥å®ç°è¿™ä¸€ç‚¹ï¼ŒåŒ…æ‹¬å¯¹Merkleæ ‘æ¦‚å¿µçš„ä¿®æ”¹ï¼Œå…è®¸èŠ‚ç‚¹è¢«æ’å…¥å’Œåˆ é™¤ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ‰æ•ˆåœ°æ”¹å˜ã€‚å¦å¤–ï¼Œå› ä¸ºæ‰€æœ‰çš„çŠ¶æ€ä¿¡æ¯éƒ½æ˜¯æœ€åä¸€ä¸ªå—çš„ä¸€éƒ¨åˆ†ï¼Œæ²¡æœ‰å¿…è¦å­˜å‚¨æ•´ä¸ªåŒºå—é“¾çš„å†å²â€”â€”å¦‚æœå¯ä»¥åº”ç”¨åˆ°æ¯”ç‰¹å¸ä¸Šï¼Œå°±å¯ä»¥è®¡ç®—å‡ºåœ¨å¤ªç©ºä¸­èŠ‚çœ5-20xçš„æˆæœ¬ã€‚</p><p>å°±ç‰©ç†ç¡¬ä»¶è€Œè¨€ï¼Œä¸€ä¸ªå¸¸è§é—®é¢˜æ˜¯åœ¨å“ªé‡Œæ‰§è¡ŒåˆåŒä»£ç ã€‚è¿™æœ‰ä¸€ä¸ªç®€å•çš„ç­”æ¡ˆï¼šæ‰§è¡ŒåˆåŒä»£ç çš„è¿‡ç¨‹æ˜¯çŠ¶æ€è½¬æ¢å‡½æ•°çš„å®šä¹‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯å—éªŒè¯ç®—æ³•çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªäº‹åŠ¡è¢«æ·»åŠ åˆ°å—<code>B</code>ä¸­ï¼Œè¯¥äº‹åŠ¡ç”Ÿæˆçš„ä»£ç æ‰§è¡Œå°†è¢«æ‰§è¡Œæ‰€æœ‰èŠ‚ç‚¹ç°åœ¨å’Œå°†æ¥éƒ½ä¼šä¸‹è½½å¹¶éªŒè¯å—<code>B</code>ã€‚</p><h5 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h5><p>æ€»çš„æ¥è¯´ï¼Œåœ¨ä»¥å¤ªåŠä¹‹ä¸Šæœ‰ä¸‰ç§ç±»å‹çš„åº”ç”¨ç¨‹åºã€‚ç¬¬ä¸€ç±»æ˜¯é‡‘èåº”ç”¨ç¨‹åºï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¼ºå¤§çš„ç®¡ç†æ–¹å¼ï¼Œå¹¶ä½¿ç”¨ä»–ä»¬çš„èµ„é‡‘ç­¾è®¢åˆåŒã€‚è¿™åŒ…æ‹¬å­è´§å¸ï¼Œé‡‘èè¡ç”Ÿå“ï¼Œå¥—æœŸä¿å€¼åˆçº¦ï¼Œå‚¨è“„é’±åŒ…ï¼Œé—å˜±ä»¥åŠæœ€ç»ˆç”šè‡³æ˜¯ä¸€äº›ç±»åˆ«çš„å…¨é¢é›‡ä½£åˆåŒã€‚ç¬¬äºŒç±»æ˜¯åŠé‡‘èåº”ç”¨ï¼Œæ¶‰åŠé‡‘é’±ï¼Œä½†ä¹Ÿæœ‰éå¸¸é‡è¦çš„éè´§å¸æ–¹é¢çš„å·¥ä½œ; ä¸€ä¸ªå®Œç¾çš„ä¾‹å­å°±æ˜¯ä¸ºè®¡ç®—é—®é¢˜çš„è§£å†³æ–¹æ¡ˆè‡ªæˆ‘å®æ–½å¥–åŠ±ã€‚æœ€åï¼Œè¿˜æœ‰è¯¸å¦‚åœ¨çº¿æŠ•ç¥¨å’Œåˆ†æ•£æ²»ç†ç­‰åº”ç”¨ç¨‹åºï¼Œè¿™äº›åº”ç”¨ç¨‹åºæ ¹æœ¬æ²¡æœ‰è´¢åŠ¡ã€‚</p><p>è¯¥ç« èŠ‚å¹¶ä¸å®Œå…¨ï¼Œä»…æ‘˜å–äº†ä»‹ç»éƒ¨åˆ†ï¼Œè¯¦ç»†å†…å®¹è¿˜éœ€åˆ°<a href="https://github.com/ethereum/wiki/wiki/White-Paper">ä»¥å¤ªåŠç™½çš®ä¹¦</a>ä¸­æŸ¥é˜…</p><h6 id="ä»¤ç‰Œç³»ç»Ÿ"><a href="#ä»¤ç‰Œç³»ç»Ÿ" class="headerlink" title="ä»¤ç‰Œç³»ç»Ÿ"></a>ä»¤ç‰Œç³»ç»Ÿ</h6><p>åŒºå—é“¾ä¸Šçš„ä»£å¸ç³»ç»Ÿæœ‰è®¸å¤šåº”ç”¨ç¨‹åºï¼Œä»ä»£è¡¨èµ„äº§ï¼ˆå¦‚ç¾å…ƒæˆ–é»„é‡‘ï¼‰çš„å­è´§å¸åˆ°å…¬å¸è‚¡ç¥¨ï¼Œä»£è¡¨æ™ºèƒ½è´¢äº§çš„å•ä¸ªä»£å¸ï¼Œå®‰å…¨ä¸å¯ä¼ªé€ çš„ä¼˜æƒ åˆ¸ï¼Œç”šè‡³ä¸å¸¸è§„å€¼å®Œå…¨æ— å…³çš„ä»£å¸ç³»ç»Ÿï¼Œç”¨ä½œç‚¹æ¿€åŠ±åˆ¶åº¦ã€‚ä»¤ç‰Œç³»ç»Ÿåœ¨Ethereumä¸­å®ç°èµ·æ¥éå¸¸ç®€å•ã€‚è¦ç†è§£çš„å…³é”®æ˜¯ï¼Œæ‰€æœ‰è´§å¸æˆ–æ ‡è®°ç³»ç»ŸåŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼Œåªæœ‰ä¸€ä¸ªæ“ä½œï¼šä»Aä¸­å‡å»Xä¸ªå•ä½å¹¶å°†Xä¸ªå•ä½ç»™äºˆBï¼Œä½†æ¡ä»¶æ˜¯ï¼ˆ1ï¼‰Aè‡³å°‘æœ‰Xä¸ªå•ä½äº¤æ˜“å’Œï¼ˆ2ï¼‰äº¤æ˜“ç”±Aæ‰¹å‡†ã€‚å®ç°ä»¤ç‰Œç³»ç»Ÿæ‰€éœ€çš„ä¸€åˆ‡å°±æ˜¯å°†è¯¥é€»è¾‘å®æ–½åˆ°åˆåŒä¸­ã€‚</p><h6 id="é‡‘èè¡ç”Ÿäº§å“å’Œç¨³å®šä»·å€¼è´§å¸"><a href="#é‡‘èè¡ç”Ÿäº§å“å’Œç¨³å®šä»·å€¼è´§å¸" class="headerlink" title="é‡‘èè¡ç”Ÿäº§å“å’Œç¨³å®šä»·å€¼è´§å¸"></a>é‡‘èè¡ç”Ÿäº§å“å’Œç¨³å®šä»·å€¼è´§å¸</h6><p>é‡‘èè¡ç”Ÿå·¥å…·æ˜¯â€œæ™ºèƒ½åˆçº¦â€ä¸­æœ€å¸¸è§çš„åº”ç”¨ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„ä»£ç å®ç°ä¹‹ä¸€ã€‚å®æ–½é‡‘èåˆåŒé¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜æ˜¯ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†è¦æ±‚å‚è€ƒå¤–éƒ¨ä»·æ ¼æŠ¥ä»·; ä¾‹å¦‚ï¼Œä¸€ä¸ªéå¸¸ç†æƒ³çš„åº”ç”¨ç¨‹åºæ˜¯ä¸€ç§æ™ºèƒ½åˆçº¦ï¼Œå¯ä»¥æŠµå¾¡ä»¥å¤ªå¸ï¼ˆæˆ–å¦ä¸€ç§åŠ å¯†è´§å¸ï¼‰ç›¸å¯¹äºç¾å…ƒçš„æ³¢åŠ¨æ€§ï¼Œä½†è¿™æ ·åšéœ€è¦åˆçº¦çŸ¥é“ETH / USDçš„ä»·å€¼ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯é€šè¿‡ç”±ç‰¹å®šæ–¹ï¼ˆä¾‹å¦‚çº³æ–¯è¾¾å…‹ï¼‰ç»´æŠ¤çš„â€œæ•°æ®é¦ˆé€â€åˆåŒï¼Œä»¥ä¾¿è¯¥æ–¹èƒ½å¤Ÿæ ¹æ®éœ€è¦æ›´æ–°åˆåŒï¼Œå¹¶æä¾›ä¸€ä¸ªæ¥å£ï¼Œä»¥å…è®¸å…¶ä»–åˆåŒå‘é€å‘è¯¥åˆåŒå‘é€æ¶ˆæ¯å¹¶å–å›æä¾›ä»·æ ¼çš„å“åº”ã€‚</p><h6 id="èº«ä»½å’Œå£°èª‰ç³»ç»Ÿ"><a href="#èº«ä»½å’Œå£°èª‰ç³»ç»Ÿ" class="headerlink" title="èº«ä»½å’Œå£°èª‰ç³»ç»Ÿ"></a>èº«ä»½å’Œå£°èª‰ç³»ç»Ÿ</h6><p>æ‰€æœ‰çš„æœ€æ—©çš„æ›¿ä»£æ€§åŠ å¯†è´§å¸ï¼Œ<a href="http://namecoin.org/" target="_blank" rel="noopener">Namecoin</a>è¯•å›¾ä½¿ç”¨ç±»ä¼¼æ¯”ç‰¹å¸çš„<a href="http://namecoin.org/" target="_blank" rel="noopener">åŒºå—</a>é“¾æ¥æä¾›åç§°æ³¨å†Œç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¬å…±æ•°æ®åº“ä¸­å°†ä»–ä»¬çš„åç§°ä¸å…¶ä»–æ•°æ®ä¸€èµ·æ³¨å†Œã€‚ä¸»è¦å¼•ç”¨çš„ç”¨ä¾‹æ˜¯<a href="http://en.wikipedia.org/wiki/Domain_Name_System" target="_blank" rel="noopener">DNS</a>ç³»ç»Ÿï¼Œå°†åŸŸåï¼ˆæ¯”å¦‚â€œbitcoin.orgâ€ï¼‰ï¼ˆæˆ–è€…åœ¨Namecoinçš„ä¾‹å­ä¸­ï¼Œâ€œbitcoin.bitâ€ï¼‰æ˜ å°„åˆ°IPåœ°å€ã€‚å…¶ä»–ç”¨ä¾‹åŒ…æ‹¬ç”µå­é‚®ä»¶è®¤è¯å’Œæ½œåœ¨æ›´é«˜çº§çš„ä¿¡èª‰ç³»ç»Ÿã€‚</p><h6 id="åˆ†æ•£çš„æ–‡ä»¶å­˜å‚¨"><a href="#åˆ†æ•£çš„æ–‡ä»¶å­˜å‚¨" class="headerlink" title="åˆ†æ•£çš„æ–‡ä»¶å­˜å‚¨"></a>åˆ†æ•£çš„æ–‡ä»¶å­˜å‚¨</h6><p>ä»¥å¤ªåŠåˆåŒå¯ä»¥å…è®¸å¼€å‘åˆ†æ•£å¼æ–‡ä»¶å­˜å‚¨ç”Ÿæ€ç³»ç»Ÿï¼Œä¸ªäººç”¨æˆ·å¯ä»¥é€šè¿‡ç§Ÿç”¨è‡ªå·±çš„ç¡¬ç›˜æ¥èµšå–å°‘é‡çš„èµ„é‡‘ï¼Œæœªä½¿ç”¨çš„ç©ºé—´å¯ä»¥ç”¨æ¥è¿›ä¸€æ­¥é™ä½æ–‡ä»¶å­˜å‚¨æˆæœ¬ã€‚</p><p>è¿™ç§è®¾å¤‡çš„å…³é”®åœ¨äºæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œåˆ†æ•£å¼DropboxåˆåŒâ€ã€‚è¯¥åˆåŒçš„å·¥ä½œå¦‚ä¸‹ã€‚é¦–å…ˆï¼Œå°†æ‰€éœ€æ•°æ®åˆ†æˆå—ï¼Œå¯¹æ¯ä¸ªå—è¿›è¡Œéšç§åŠ å¯†ï¼Œå¹¶ä»ä¸­æ„å»ºä¸€ä¸ªMerkleæ ‘ã€‚ç„¶åç”¨åˆçº¦è§„åˆ™è§„å®šï¼Œæ¯Nä¸ªå—ï¼Œåˆçº¦å°†åœ¨Merkleæ ‘ä¸­é€‰æ‹©ä¸€ä¸ªéšæœºç´¢å¼•ï¼ˆä½¿ç”¨ä¹‹å‰çš„å—æ•£åˆ—ï¼Œå¯ä»åˆåŒä»£ç è®¿é—®ï¼Œä½œä¸ºéšæœºæºï¼‰ï¼Œå¹¶å°†X etherèµ‹äºˆç¬¬ä¸€ä¸ªå®ä½“ä¸ºè¯¥äº¤æ˜“æä¾›ä¸€ä¸ªç®€åŒ–çš„æ”¯ä»˜éªŒè¯ç±»ä¼¼æ ‘ä¸­è¯¥ç‰¹å®šç´¢å¼•å¤„å—çš„æ‰€æœ‰æƒè¯æ˜ã€‚å½“ç”¨æˆ·æƒ³è¦é‡æ–°ä¸‹è½½ä»–ä»¬çš„æ–‡ä»¶æ—¶ï¼Œä»–ä»¬å¯ä»¥ä½¿ç”¨å¾®æ”¯ä»˜é€šé“åè®®ï¼ˆä¾‹å¦‚ï¼Œæ”¯ä»˜æ¯32åƒå­—èŠ‚1ä¸ªszaboï¼‰æ¥æ¢å¤æ–‡ä»¶;</p><p>è¯¥åè®®çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ï¼Œè™½ç„¶çœ‹èµ·æ¥å¥½åƒä¸€ä¸ªäººç›¸ä¿¡è®¸å¤šéšæœºèŠ‚ç‚¹ä¸ä¼šå†³å®šå¿˜è®°æ–‡ä»¶ï¼Œä½†å¯ä»¥é€šè¿‡ç§˜å¯†å…±äº«å°†æ–‡ä»¶åˆ†å‰²æˆè®¸å¤šå—ï¼Œä»è€Œå°†é£é™©é™ä½åˆ°æ¥è¿‘äºé›¶ï¼Œå¹¶ä¸”çœ‹åˆåŒï¼Œçœ‹çœ‹æ¯ä»¶ä½œå“ä»ç„¶åœ¨æŸä¸ªèŠ‚ç‚¹ä¸­ã€‚å¦‚æœåˆåŒä»åœ¨æ”¯ä»˜é‡‘é’±ï¼Œé‚£ä¹ˆå®ƒæä¾›äº†ä¸€ä¸ªå¯†ç è¯æ˜ï¼Œè¡¨æ˜æŸäººä»åœ¨å­˜å‚¨è¯¥æ–‡ä»¶ã€‚</p><h6 id="åˆ†æ•£çš„è‡ªæ²»ç»„ç»‡"><a href="#åˆ†æ•£çš„è‡ªæ²»ç»„ç»‡" class="headerlink" title="åˆ†æ•£çš„è‡ªæ²»ç»„ç»‡"></a>åˆ†æ•£çš„è‡ªæ²»ç»„ç»‡</h6><p>â€œåˆ†æ•£å¼è‡ªæ²»ç»„ç»‡â€çš„ä¸€èˆ¬æ¦‚å¿µæ˜¯æ‹¥æœ‰ä¸€å®šæ•°é‡çš„æˆå‘˜æˆ–è‚¡ä¸œçš„è™šæ‹Ÿå®ä½“çš„æ¦‚å¿µï¼Œè¿™äº›æˆå‘˜æˆ–è‚¡ä¸œå¯èƒ½æ‹¥æœ‰67ï¼…çš„å¤šæ•°è‚¡ä¸œæœ‰æƒåˆ©ç”¨è¯¥å®ä½“çš„èµ„é‡‘å¹¶ä¿®æ”¹å…¶ä»£ç ã€‚æˆå‘˜ä»¬å°†å…±åŒå†³å®šç»„ç»‡å¦‚ä½•åˆ†é…èµ„é‡‘ã€‚åˆ†é…DAOèµ„é‡‘çš„æ–¹æ³•å¯ä»¥ä»èµé‡‘ï¼Œå·¥èµ„åˆ°ç”šè‡³æ›´å¤šå¤–æ¥æœºåˆ¶ï¼ˆå¦‚å†…éƒ¨è´§å¸ï¼‰ä»¥å¥–åŠ±å·¥ä½œã€‚è¿™åŸºæœ¬ä¸Šå¤åˆ¶äº†ä¼ ç»Ÿå…¬å¸æˆ–éè¥åˆ©ç»„ç»‡çš„æ³•å¾‹æ ‡å¿—ï¼Œä½†ä»…ä½¿ç”¨åŠ å¯†åŒºå—é“¾æŠ€æœ¯æ‰§è¡Œã€‚</p><p>å‚è€ƒåœ°å€å¦‚ä¸‹</p><ol><li><a href="http://baijiahao.baidu.com/s?id=1595831842043592716&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener">http://baijiahao.baidu.com/s?id=1595831842043592716&amp;wfr=spider&amp;for=pc</a></li><li><a href="https://github.com/ethereum/wiki/wiki/White-Paper">https://github.com/ethereum/wiki/wiki/White-Paper</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_build</title>
      <link href="/2019/10/14/eth-build/"/>
      <url>/2019/10/14/eth-build/</url>
      
        <content type="html"><![CDATA[<p>é¡¹ç›®é€‰æ‹©ä¸ºgo-ethereumï¼Œå³gethã€‚ï¼ˆåŸæ¥gethæ˜¯go-ethereumçš„ç®€ç§°..ï¼‰ã€‚gethæ˜¯ä»¥å¤ªåŠã€Whisperï¼ˆå»ä¸­å¿ƒåŒ–é€šä¿¡åè®®ï¼‰å’ŒSwarmï¼ˆå»ä¸­å¿ƒåŒ–æ–‡ä»¶ç³»ç»Ÿï¼‰èŠ‚ç‚¹çš„ä¸€ä¸ªå®ç°ã€‚ç”¨äºæ¥å…¥ä»¥å¤ªåŠç½‘ç»œï¼Œè¿›è¡Œè´¦æˆ·ç®¡ç†ã€äº¤æ˜“ã€æŒ–çŸ¿ã€æ™ºèƒ½åˆçº¦ç›¸å…³çš„æ“ä½œçš„ä»¥å¤ªåŠå®¢æˆ·ç«¯ã€‚å¦å¤–ï¼Œgethæ˜¯ä¸€ç§CLIåº”ç”¨ã€‚</p><p>ç¯å¢ƒé…ç½®</p><p>ç¯å¢ƒä¸ºmac</p><p>æŒ‰ç…§<a href>å®˜æ–¹æ–‡æ¡£</a>è¿›è¡Œé…ç½®å°±å¥½ã€‚é‡‡ç”¨çš„æ˜¯å…‹éš†go-ethereumä»“åº“çš„æ–¹å¼è¿›è¡Œé…ç½®ã€‚</p><p>æ³¨æ„çš„ç‚¹æ˜¯ï¼Œgoç‰ˆæœ¬å¾ˆå…³é”®ã€‚åˆšå¼€å§‹ä¸‹è½½çš„goç‰ˆæœ¬å°±ä¸º1.7.+,ç„¶ååœ¨è¿›è¡Œmake gethçš„æ—¶å€™æŠ¥é”™äº†..ç„¶åé‡æ–°brew install goï¼Œæåˆ°goç‰ˆæœ¬1.10.+ï¼Œç„¶åè¿›è¡Œmake gethè¿˜æ˜¯æŠ¥é”™..æ— å¥ˆä¸‹è½½å®˜æ–¹å»ºè®®1.9.+ï¼Œé¡ºåˆ©é€šè¿‡â€¦</p><p>makeè§£è¯»ï¼Œä½¿ç”¨makeå‘½ä»¤æ—¶è°ƒç”¨makefileæ–‡ä»¶ï¼ŒæŸ¥çœ‹makefileä»£ç ï¼Œå…¶å®make all/make gethå…¶å®å°±æ˜¯ä½¿ç”¨goå¯¹cmd/ç›®å½•ä¸‹å„å·¥å…·è¿›è¡Œä»£ç æ‰“åŒ…æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ç”Ÿæˆæ–‡ä»¶ä½äºcmd/binä¸‹ã€‚</p><p>makeå®Œæˆåå°†cmd/binç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œæ–¹ä¾¿ä¹‹åä½¿ç”¨ã€‚</p><p>åˆ›å»º3ä¸ªç›®å½•æ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«å­˜æ”¾3ä¸ªè´¦æˆ·æ•°æ®ã€‚ â€”datadir node1 ä¸ºæŒ‡å®šData directory for the databases and keystoreã€‚åˆ›å»º3ä¸ªè´¦æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xiaoxuez$ ls</span><br><span class="line">node1node2node3</span><br><span class="line">xiaoxuez$ geth --datadir node1 account new</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆåˆ›ä¸–å—ï¼Œéœ€è¦å®šä¹‰.jsonæ–‡ä»¶ï¼Œpuppethå·¥å…·å¯ä»¥å¸®å¿™å¿«é€Ÿç”Ÿæˆåˆ›ä¸–å¿«æ–‡ä»¶ã€‚puppethæºä»£ç ä½äºcmd/ä¸‹ï¼Œmakeçš„æ—¶å€™å¦‚æœåªmake etheruemçš„è¯å°±åªä¼šç”Ÿæˆethereumçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œmake allå°±éƒ½æœ‰äº†~  å®åœ¨æ²¡æœ‰çš„è¯å°±å•ç‹¬ç”Ÿæˆä¸€æ¬¡ã€‚å¯å‚ç…§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build/env.sh go run build/ci.go install ./cmd/puppeth/</span><br></pre></td></tr></table></figure><p>å›åˆ°æ­£é¢˜ï¼Œpuppethçš„ä½¿ç”¨ç›´æ¥è§å‘½ä»¤è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">$ puppeth</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line">| Welcome to puppeth, your Ethereum private network manager |</span><br><span class="line">|                                                           |</span><br><span class="line">| This tool lets you create a new Ethereum network down to  |</span><br><span class="line">| the genesis block, bootnodes, miners and ethstats servers |</span><br><span class="line">| without the hassle that it would normally entail.         |</span><br><span class="line">|                                                           |</span><br><span class="line">| Puppeth uses SSH to dial in to remote servers, and builds |</span><br><span class="line">| its network components out of Docker containers using the |</span><br><span class="line">| docker-compose toolset.                                   |</span><br><span class="line">+-----------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">Please specify a network name to administer (no spaces or hyphens, please)</span><br><span class="line">&gt; helloworldprivate</span><br><span class="line"></span><br><span class="line">Sweet, you can set this via --network=helloworldprivate next time!</span><br><span class="line"></span><br><span class="line">INFO [04-10|13:45:58] Administering Ethereum network           name=helloworldprivate</span><br><span class="line">WARN [04-10|13:45:58] No previous configurations found         path=/Users/xiaoxuez/.puppeth/helloworldprivate</span><br><span class="line"></span><br><span class="line">What would you like to do? (default = stats)</span><br><span class="line"> 1. Show network stats</span><br><span class="line"> 2. Configure new genesis</span><br><span class="line"> 3. Track new remote server</span><br><span class="line"> 4. Deploy network components</span><br><span class="line">&gt; 2</span><br><span class="line"></span><br><span class="line">Which consensus engine to use? (default = clique) #å…±è¯†é€‰æ‹©ï¼Œå¯ç›´æ¥é€‰æ‹©pow,è¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯poa,(ä¸æ¶ˆè€—è®¡ç®—åŠ›, å¯ä»¥ç”¨äºç§é“¾æµ‹è¯•å¼€å‘)</span><br><span class="line"> 1. Ethash - proof-of-work</span><br><span class="line"> 2. Clique - proof-of-authority</span><br><span class="line">&gt; 2</span><br><span class="line"></span><br><span class="line">How many seconds should blocks take? (default = 15)  #5så‡ºä¸€ä¸ªå—</span><br><span class="line">&gt; 5</span><br><span class="line"></span><br><span class="line">Which accounts are allowed to seal? (mandatory at least one)  #è¾“å…¥æœ‰ç­¾åæƒé™çš„è´¦æˆ·</span><br><span class="line">&gt; 0x1186c97871079e86e9adcf11f56b90caa3619ea4</span><br><span class="line">&gt; 0x34c72adc7499cce01530dc27e67810a79fdbd8ea</span><br><span class="line">&gt; 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74</span><br><span class="line">&gt; 0x</span><br><span class="line"></span><br><span class="line">Which accounts should be pre-funded? (advisable at least one)  #è¾“å…¥æœ‰é¢„ç•™ä½™é¢çš„è´¦æˆ·</span><br><span class="line">&gt; 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74</span><br><span class="line">&gt; 0x34c72adc7499cce01530dc27e67810a79fdbd8ea</span><br><span class="line">&gt; 0x1186c97871079e86e9adcf11f56b90caa3619ea4</span><br><span class="line">&gt; 0x</span><br><span class="line"></span><br><span class="line">Specify your chain/network ID if you want an explicit one (default = random) #è¾“å…¥ç§é“¾ID, ç›´æ¥è¾“å…¥å›è½¦,å·²é»˜è®¤éšæœºæ•°ä½œä¸ºç§é“¾ID</span><br><span class="line">&gt;</span><br><span class="line">INFO [04-10|13:47:49] Configured new genesis block</span><br><span class="line"></span><br><span class="line">What would you like to do? (default = stats)</span><br><span class="line"> 1. Show network stats</span><br><span class="line"> 2. Manage existing genesis</span><br><span class="line"> 3. Track new remote server</span><br><span class="line"> 4. Deploy network components</span><br><span class="line">&gt; 2</span><br><span class="line"></span><br><span class="line"> 1. Modify existing fork rules</span><br><span class="line"> 2. Export genesis configuration</span><br><span class="line"> 3. Remove genesis configuration</span><br><span class="line">&gt; 2</span><br><span class="line"></span><br><span class="line">Which file to save the genesis into? (default = helloworldprivate.json)</span><br><span class="line">&gt;</span><br><span class="line">INFO [04-10|13:48:00] Exported existing genesis block</span><br><span class="line"></span><br><span class="line">What would you like to do? (default = stats)</span><br><span class="line"> 1. Show network stats</span><br><span class="line"> 2. Manage existing genesis</span><br><span class="line"> 3. Track new remote server</span><br><span class="line"> 4. Deploy network components</span><br><span class="line">&gt; ^C</span><br><span class="line">$ ls  #ç»“æŸåä¼šåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹çœ‹åˆ°å¯¼å‡ºçš„.jsonæ–‡ä»¶</span><br><span class="line">helloworldprivate.jsonnode1node2node3</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨.jsonæ–‡ä»¶ç”Ÿæˆåˆ›ä¸–å—äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#init:Bootstrap and initialize a new genesis block</span><br><span class="line">$ geth --datadir node1 init helloworldprivate.json</span><br><span class="line">$ geth --datadir node1 --port 30000 --nodiscover --unlock &apos;0&apos; --password ./node1/password console</span><br><span class="line">#å¯åŠ¨geth, --port: Network listening port ï¼ŒæŒ‡å®šå’Œå…¶ä»–èŠ‚ç‚¹é“¾æ¥æ‰€ç”¨çš„ç«¯å£å·</span><br><span class="line">#               --nodiscover: Disables the peer discovery mechanism (manual peer addition)å…³é—­èŠ‚ç‚¹å‘ç°æœºåˆ¶ï¼Œé˜²æ­¢åŠ å…¥æœ‰åŒæ ·åˆå§‹é…ç½®çš„é™Œç”ŸèŠ‚ç‚¹ï¼Œåç»­æ‰‹åŠ¨é…ç½®èŠ‚ç‚¹ç½‘ç»œï¼Œ</span><br><span class="line">#               --unlock: Comma separated list of accounts to unlock, è§£é”çš„è´¦æˆ·ï¼Œä»¥é€—å·åˆ†éš”ï¼Œè´¦æˆ·è¦è½¬å¸æˆ–è€…éƒ¨ç½²åˆçº¦ï¼Œéœ€è¦å…ˆè§£é”</span><br><span class="line">#               console: è¿›å…¥æ§åˆ¶å°ï¼Œä¸åŠ consoleçš„è¯ï¼Œä¹Ÿå¯åœ¨gethå¯åŠ¨åé€šè¿‡geth attach</span><br><span class="line">ipc:node0/geth.ipcæ¥è®¿é—®</span><br><span class="line">#               --rpc: è¡¨ç¤ºå¼€å¯http-rpcæœåŠ¡</span><br><span class="line">                --rpcport: æŒ‡å®šhttp-rpcæœåŠ¡ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º8545</span><br><span class="line">                --ws:</span><br><span class="line">                --wsport:</span><br><span class="line">                --allow-insecure-unlock</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œç›®å‰å¯åŠ¨3ä¸ªèŠ‚ç‚¹ï¼Œä½¿ç”¨ä¸åŒç«¯å£æ¥æ¨¡æ‹Ÿå¤šèŠ‚ç‚¹ï¼Œå¦èµ·ç»ˆç«¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ geth --datadir node2 init helloworldprivate.json</span><br><span class="line">$ geth --datadir node2 --port 30001 --nodiscover --unlock &apos;0&apos; --password ./node2/password console</span><br><span class="line"></span><br><span class="line">$ geth --datadir node3 init helloworldprivate.json</span><br><span class="line">$ geth --datadir node3 --port 30002 --nodiscover --unlock &apos;0&apos; --password ./node3/password console</span><br></pre></td></tr></table></figure><p>ä¸‰ä¸ªå¯åŠ¨æ—¶å€™unlock çš„å€¼éƒ½æ˜¯â€™0â€™,  ä¹‹å‰åœ¨æ¯ä¸ªèŠ‚ç‚¹æ–‡ä»¶ä¸‹éƒ½åªåˆ›å»ºäº†ä¸€ä¸ªè´¦æˆ·ï¼Œæ‰€ä»¥è§£é”çš„å°±æ˜¯å„ä¸ªèŠ‚ç‚¹ä¸‹çš„è´¦æˆ·ï¼Œå³ç›®å‰ä¸‰ä¸ªè´¦æˆ·éƒ½æ˜¯è§£é”ã€‚è¿™é‡Œçš„å°ç–‘é—®æ˜¯è¦èµ·3ä¸ªåˆå§‹å—ï¼ŒçŒœæµ‹æ˜¯ç›¸åŒåˆå§‹é…ç½®çš„èŠ‚ç‚¹æ‰èƒ½åŠ å…¥åˆ°åŒä¸€ä¸ªç½‘ç»œä¸­ã€‚</p><p>consoleè¿›å…¥çš„æ§åˆ¶å°æ˜¯ä¸€ä¸ªäº¤äº’å¼çš„JavaScriptæ‰§è¡Œç¯å¢ƒï¼Œåœ¨è¿™é‡Œé¢å¯ä»¥æ‰§è¡ŒJavaScriptä»£ç ã€‚è¿™ä¸ªç¯å¢ƒé‡Œä¹Ÿå†…ç½®äº†ä¸€äº›ç”¨æ¥æ“ä½œä»¥å¤ªåŠçš„JavaScriptå¯¹è±¡ï¼Œä¾‹å¦‚</p><ul><li>ethï¼šåŒ…å«ä¸€äº›è·Ÿæ“ä½œåŒºå—é“¾ç›¸å…³çš„æ–¹æ³•ï¼›</li><li>netï¼šåŒ…å«ä¸€äº›æŸ¥çœ‹p2pç½‘ç»œçŠ¶æ€çš„æ–¹æ³•ï¼›</li><li>adminï¼šåŒ…å«ä¸€äº›ä¸ç®¡ç†èŠ‚ç‚¹ç›¸å…³çš„æ–¹æ³•ï¼›</li><li>minerï¼šåŒ…å«å¯åŠ¨&amp;åœæ­¢æŒ–çŸ¿çš„ä¸€äº›æ–¹æ³•ï¼›</li><li>personalï¼šä¸»è¦åŒ…å«ä¸€äº›ç®¡ç†è´¦æˆ·çš„æ–¹æ³•ï¼›</li><li>txpoolï¼šåŒ…å«ä¸€äº›æŸ¥çœ‹äº¤æ˜“å†…å­˜æ± çš„æ–¹æ³•ï¼›</li><li>web3ï¼šåŒ…å«äº†ä»¥ä¸Šå¯¹è±¡ï¼Œè¿˜åŒ…å«ä¸€äº›å•ä½æ¢ç®—çš„æ–¹æ³•ã€‚</li></ul><p>å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li><p>personal.newAccount()ï¼šåˆ›å»ºè´¦æˆ·ï¼›</p></li><li><p>personal.unlockAccount()ï¼šè§£é”è´¦æˆ·ï¼›</p></li><li><p>eth.accountsï¼šæšä¸¾ç³»ç»Ÿä¸­çš„è´¦æˆ·ï¼›</p></li><li><p>eth.getBalance()ï¼šæŸ¥çœ‹è´¦æˆ·ä½™é¢ï¼Œè¿”å›å€¼çš„å•ä½æ˜¯ Weiï¼ˆWei æ˜¯ä»¥å¤ªåŠä¸­æœ€å°è´§å¸é¢é¢å•ä½ï¼Œç±»ä¼¼æ¯”ç‰¹å¸ä¸­çš„<code>èª</code>ï¼Œ1 ether = 10^18 Weiï¼‰ï¼› <code>web3.fromWei(eth.getBalance(e), &quot;ether&quot;)</code></p><p><code>web3.toWei(&#39;1&#39;, &#39;ether&#39;)</code></p></li></ul><ul><li><p>eth.blockNumberï¼šåˆ—å‡ºåŒºå—æ€»æ•°ï¼›blockNumberä¸ºethçš„å±æ€§ï¼Œç›´æ¥æŸ¥çœ‹å³å¯</p></li><li><p>eth.getTransaction()ï¼šè·å–äº¤æ˜“ï¼›</p></li><li><p>eth.getBlock()ï¼šè·å–åŒºå—ï¼›å¦‚eth.getBlock(â€œpendingâ€, true).transactions æŸ¥çœ‹å½“å‰å¾…ç¡®è®¤äº¤æ˜“ã€‚æˆ–é€šè¿‡åŒºå—å·æŸ¥çœ‹eth.getBlock(4)</p></li><li><p>miner.start()ï¼šå¼€å§‹æŒ–çŸ¿ï¼›</p></li><li><p>miner.stop()ï¼šåœæ­¢æŒ–çŸ¿ï¼›</p></li><li><p>web3.fromWei()ï¼šWei æ¢ç®—æˆä»¥å¤ªå¸ï¼›</p></li><li><p>web3.toWei()ï¼šä»¥å¤ªå¸æ¢ç®—æˆ Weiï¼›å¦‚amount = web3.toWei(5,â€™etherâ€™)</p></li><li><p>txpool.statusï¼šäº¤æ˜“æ± ä¸­çš„çŠ¶æ€ï¼›</p></li><li><p>admin.addPeer()ï¼šè¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼›</p></li></ul><p>æ¥ä¸‹æ¥ï¼Œæ·»åŠ peerèŠ‚ç‚¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; admin.peers #æŸ¥çœ‹å½“å‰èŠ‚ç‚¹é“¾æ¥çš„èŠ‚ç‚¹</span><br><span class="line">&gt; net.peerCount #æŸ¥çœ‹å½“å‰èŠ‚ç‚¹é“¾æ¥çš„èŠ‚ç‚¹æ•°</span><br></pre></td></tr></table></figure><p>ç›®å‰ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æ²¡æœ‰é“¾æ¥çš„ï¼Œæ‰€ä»¥admin.peersçš„ç»“æœä¸º[]ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; admin.nodeInfo.enode #æŸ¥çœ‹èŠ‚ç‚¹åœ°å€ï¼Œåœ°å€ç»„æˆä¸ºencode://&lt;èŠ‚ç‚¹id&gt;@ipåœ°å€ï¼šç«¯å£</span><br><span class="line">&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹node1èŠ‚ç‚¹åœ°å€ï¼Œåœ¨node2, node3çš„consoleä¸­ä½¿ç”¨admin.addPeerï¼Œå°†node1åˆ†åˆ«æ·»åŠ åˆ°node2,node3ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; admin.addPeer(&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;)</span><br></pre></td></tr></table></figure><p>å†ä½¿ç”¨admin.peersæŸ¥çœ‹çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°node1é“¾æ¥ä¸Š2ä¸ªèŠ‚ç‚¹ï¼ˆnode2, node3ï¼‰,node2å’Œnode3å„è‡ªé“¾æ¥ä¸Š1ä¸ªèŠ‚ç‚¹ï¼ˆnode1ï¼‰</p><p>ä¹Ÿå¯ä½¿ç”¨é…ç½®æ–‡ä»¶çš„å½¢å¼æ·»åŠ èŠ‚ç‚¹ï¼Œåœ¨èŠ‚ç‚¹çš„datadirä¸‹æ–°å»ºstatic-node.json, å°†éœ€è¦è¿æ¥çš„èŠ‚ç‚¹åœ°å€å†™å…¥ï¼Œå¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;,</span><br><span class="line">&quot;enode://79671ba7d09a4e6d16a64128e2cb24f544ec8740084e1ceb1abcac7b1c2b8a37dae812653360caf30ceff782265b124c1e6ce1d547dc6854bafb85596795751c@[::]:30001?discport=0&quot;,</span><br><span class="line">&quot;enode://3237c4eaf0dbf55b459eef14c4ecffe987b5179e482399b282bc5ab3d1559dd8461a9d39460810bf0d8c276fb13a9950eca5c38890dbf11d9dccdb1b61231a78@[::]:30002?discport=0&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>æˆ–è€…ç›´æ¥åœ¨gethå¯åŠ¨è¡Œä¸­æ·»åŠ  - -bootnodes enode:â€¦.</p><p>é‚£ä¹ˆåœ¨gethå¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨é“¾æ¥ã€‚é“¾æ¥åˆ°çš„èŠ‚ç‚¹å°±äº’ç›¸å‘ç°ç»„æˆä»¥å¤ªåŠç§é“¾ç½‘ç»œäº†</p><p>å½“ç»„æˆç½‘ç»œä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹æŒ–çŸ¿äº†ã€‚åœ¨æŸä¸ªèŠ‚ç‚¹ä¸‹ï¼Œè°ƒç”¨miner.start()</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; miner.start()</span><br><span class="line">INFO [04-10|17:59:10] Transaction pool price threshold updated price=18000000000</span><br><span class="line">INFO [04-10|17:59:10] Starting mining operation</span><br><span class="line">null</span><br><span class="line">&gt; INFO [04-10|17:59:10] Commit new mining work                   number=1 txs=2 uncles=0 elapsed=1.058ms</span><br><span class="line">INFO [04-10|17:59:10] Successfully sealed new block            number=1 hash=3b7e10â€¦38d85e</span><br><span class="line">INFO [04-10|17:59:10] ğŸ”¨ mined potential block                  number=1 hash=3b7e10â€¦38d85e</span><br><span class="line">INFO [04-10|17:59:10] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=285.156Âµs</span><br><span class="line">INFO [04-10|17:59:15] Successfully sealed new block            number=2 hash=1bb861â€¦fbcb78</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µæ˜¯è¿™ä¸ªæ ·å­..  ä¸æ­£å¸¸çš„æƒ…å†µï¼Œå…¶ä¸€éœ€è¦å…ˆè§£é”è´¦æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WARN [04-10|17:55:49] Block sealing failed                     err=&quot;authentication needed: password or unlock&quot;</span><br><span class="line">&gt; personal.unlockAccount(eth.accounts[0])</span><br></pre></td></tr></table></figure><p>å…¶äºŒï¼Œå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; miner.start()</span><br><span class="line"></span><br><span class="line">null</span><br></pre></td></tr></table></figure><p>è¿”å›null, æ˜¯ä¸å¾—è¡Œçš„~ï¼Œè§£å†³æ–¹å¼å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; miner.setEtherbase(eth.accounts[0])</span><br><span class="line">true</span><br><span class="line">&gt; miner.start()</span><br></pre></td></tr></table></figure><p>åœ¨æŸä¸ªèŠ‚ç‚¹ä¸‹ï¼Œæäº¤ä¸€ä¸ªäº¤æ˜“ï¼Œå¦‚,  toä¸ºè´¦æˆ·åœ°å€ï¼ŒæŸ¥çœ‹è´¦æˆ·åœ°å€ä¸ºeth.accounts</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; eth.sendTransaction(&#123;from: eth.accounts[0], to: &quot;b6deeb049de5fb90345b5b84dd1faf2d56c6929e&quot;, value: web3.toWei(200, &quot;ether&quot;)&#125;)</span><br></pre></td></tr></table></figure><p>å¦‚æœmineræ²¡æœ‰å…³æ‰çš„è¯ï¼Œå‡ ç§’åå°±ä¼šæœ‰å«æœ‰äº¤æ˜“çš„blockäº§å‡º,  txsä¸ºblockåŒ…å«çš„äº¤æ˜“æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO [04-10|17:59:15] Imported new chain segment               blocks=2 txs=1 mgas=0.042 elapsed=1.348ms  mgasps=31.157 number=2 hash=1bb861â€¦fbcb78 cache=2.47kB</span><br></pre></td></tr></table></figure><p>æŒ–çŸ¿ï¼ŒæŒ–åˆ°ä¸€ä¸ªåŒºå—ä¹‹åå°±åœæ­¢æŒ–çŸ¿å¯ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; miner.start(1);admin.sleepBlocks(1);miner.stop();</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯ç½‘é€ŸåŸå› â€¦ è¿‡å‡ åˆ†é’Ÿå†è¯•å°±å¥½äº†ã€‚</p><p>æ™ºèƒ½åˆçº¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install solc</span><br></pre></td></tr></table></figure><p>â€¦..</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">geth attach http://0.0.0.0:1112</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;/Applications/Ethereum Wallet.app/Contents/MacOS/Ethereum Wallet&quot; --rpc http://localhost:8545</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    --rpcapi=&quot;db,eth,net,web3,personal,web3&quot; --rpc --rpcaddr 0.0.0.0 -rpcport 1112 --mine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eth.sendTransaction(&#123;from:eth.accounts[0], data:&quot;0x0100f862a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000809471562b71999873db5b286df957af199ec94617f78568656c6c6f80808080&quot;&#125;)</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘android</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make android</span><br><span class="line"></span><br><span class="line">./build/env.sh xgo --go=latest --dest=build/bin -v --targets=android-23/arm64 ./cmd/geth</span><br><span class="line"></span><br><span class="line">glide mirror set golang.org/x/text  /home/users/qiangmzsx/var/golang/golang.org/x/text</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eth.sendTransaction(&#123;from: eth.accounts[0], to: &quot;0x71562b71999873DB5b286dF957af199Ec94617F7&quot;, value: 200000&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_rlp</title>
      <link href="/2019/10/14/eth-rlp/"/>
      <url>/2019/10/14/eth-rlp/</url>
      
        <content type="html"><![CDATA[<h4 id="åºåˆ—åŒ–-RLP"><a href="#åºåˆ—åŒ–-RLP" class="headerlink" title="åºåˆ—åŒ– RLP"></a>åºåˆ—åŒ– RLP</h4><h4 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h4><p>å¯¹è±¡åºåˆ—åŒ–çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¦‚jsonç¼–ç ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type Student struct&#123;</span><br><span class="line">    Name string `json:&quot;name&quot;`</span><br><span class="line">    Sex string `json:&quot;sex&quot;`</span><br><span class="line">&#125;</span><br><span class="line">s := Student&#123;Name:&quot;icattlecoder&quot;,Sex:&quot;male&quot;&#125;</span><br><span class="line">bs,_ := json.Marsal(&amp;s)</span><br></pre></td></tr></table></figure><p>ä½†ç¼–ç çš„ç»“æœä¸º<code>{&quot;name&quot;:&quot;icattlecoder&quot;,&quot;sex&quot;:&quot;male&quot;}</code>,å®é™…æœ‰æ•ˆæ•°æ®æ˜¯icattlecoderå’Œmaleï¼Œå…±è®¡16ä¸ªå­—èŠ‚ï¼Œå¯ä»¥çœ‹åˆ°jsonåºåˆ—åŒ–æ—¶å¼•å…¥äº†å¤ªå¤šçš„å†—ä½™ä¿¡æ¯ï¼Œæ‰€ä»¥ï¼Œä»¥å¤ªåŠè®¾è®¡äº†ç»“æœæ›´å°çš„ç¼–ç æ–¹å¼â€”â€” RLPç¼–ç </p><blockquote><p>RLPçš„å…¨ç§°ä¸ºRecursive Length Prefixï¼Œä¸­æ–‡ç¿»è¯‘è¿‡æ¥å«é€’å½’é•¿åº¦å‰ç¼€ç¼–ç ï¼Œå®ƒæ˜¯ä»¥å¤ªåŠåºåˆ—åŒ–æ‰€é‡‡ç”¨çš„ç¼–ç æ–¹å¼ã€‚RLPä¸»è¦ç”¨äºä»¥å¤ªåŠä¸­æ•°æ®çš„ç½‘ç»œä¼ è¾“å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚</p></blockquote><p>RLPå®é™…åªç»™ä»¥ä¸‹ä¸¤ç§ç±»å‹æ•°æ®ç¼–ç ï¼š</p><ul><li>byteæ•°ç»„</li><li>byteæ•°ç»„çš„æ•°ç»„ï¼Œç§°ä¹‹ä¸ºåˆ—è¡¨</li></ul><p><strong>è§„åˆ™1</strong>ï¼šå¯¹äºå€¼åœ¨[0, 127]ä¹‹é—´çš„å•ä¸ªå­—èŠ‚ï¼Œå…¶ç¼–ç æ˜¯å…¶æœ¬èº«ã€‚</p><p>ä¾‹1ï¼š<code>a</code>çš„ç¼–ç æ˜¯<code>97</code>ã€‚</p><p><strong>è§„åˆ™2</strong>ï¼šå¦‚æœbyteæ•°ç»„é•¿åº¦<code>l &lt;= 55</code>ï¼Œç¼–ç çš„ç»“æœæ˜¯æ•°ç»„æœ¬èº«ï¼Œå†åŠ ä¸Š<code>128+l</code>ä½œä¸ºå‰ç¼€ã€‚</p><p>ä¾‹2ï¼šç©ºå­—ç¬¦ä¸²ç¼–ç æ˜¯<code>128</code>ï¼Œå³<code>128 = 128 + 0</code>ã€‚</p><p>ä¾‹3ï¼š<code>abc</code>ç¼–ç ç»“æœæ˜¯<code>131 97 98 99</code>ï¼Œå…¶ä¸­<code>131=128+len(&quot;abc&quot;)</code>ï¼Œ<code>97 98 99</code>ä¾æ¬¡æ˜¯<code>a b c</code>ã€‚</p><p><strong>è§„åˆ™3</strong>ï¼šå¦‚æœæ•°ç»„é•¿åº¦å¤§äº55ï¼Œ ç¼–ç ç»“æœç¬¬ä¸€ä¸ªæ˜¯183åŠ æ•°ç»„é•¿åº¦çš„ç¼–ç çš„é•¿åº¦ï¼Œç„¶åæ˜¯æ•°ç»„é•¿åº¦çš„æœ¬èº«çš„ç¼–ç ï¼Œæœ€åæ˜¯byteæ•°ç»„çš„ç¼–ç ã€‚</p><p>å‘ƒï¼Œå¤§äº55æ˜¯ç¬¬ä¸€ä¸ªæ˜¯183+ æ•°ç»„é•¿åº¦<strong>ç¼–ç </strong>çš„é•¿åº¦ï¼Œç¬¬äºŒä½æ‰æ˜¯é•¿åº¦çš„ç¼–ç </p><p>å¦‚ç¼–ç ä¸‹é¢è¿™æ®µå­—ç¬¦ä¸²ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The length of this sentence is more than 55 bytes, I know it because I pre-designed it</span><br></pre></td></tr></table></figure><p>è¿™æ®µå­—ç¬¦ä¸²å…±86ä¸ªå­—èŠ‚ï¼Œè€Œ86çš„ç¼–ç åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£å°±æ˜¯å®ƒè‡ªå·±ï¼Œå› æ­¤ï¼Œç¼–ç çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">184 86 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110 116101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101 11544 32 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114 101 45 100101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å‰ä¸‰ä¸ªå­—èŠ‚çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li><code>184 = 183 + 1</code>ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦<code>86</code>ç¼–ç åä»…å ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚</li><li><code>86</code>å³æ•°ç»„é•¿åº¦<code>86</code></li><li><code>84</code>æ˜¯<code>T</code>çš„ç¼–ç </li></ol><p>ç¼–ç ä¸€ä¸ªé‡å¤1024æ¬¡â€aâ€çš„å­—ç¬¦ä¸²ï¼Œå…¶ç»“æœä¸ºï¼š<code>185 4 0 97 97 97 97 97 97 ...</code>ã€‚<br>1024æŒ‰ big endianç¼–ç ä¸º<code>0ã€€0ã€€4 0</code>ï¼Œçœç•¥æ‰å‰é¢çš„é›¶ï¼Œé•¿åº¦ä¸º2ï¼Œå› æ­¤<code>185 = 183 + 2</code>ã€‚</p><p>è§„åˆ™1~3å®šä¹‰äº†byteæ•°ç»„çš„ç¼–ç æ–¹æ¡ˆï¼Œä¸‹é¢ä»‹ç»åˆ—è¡¨çš„ç¼–ç è§„åˆ™ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰<strong>åˆ—è¡¨é•¿åº¦</strong>æ˜¯æŒ‡å­åˆ—è¡¨ç¼–ç åçš„é•¿åº¦ä¹‹å’Œã€‚</p><p><strong>è§„åˆ™4</strong>ï¼šå¦‚æœåˆ—è¡¨é•¿åº¦å°äº55ï¼Œç¼–ç ç»“æœç¬¬ä¸€ä½æ˜¯192åŠ åˆ—è¡¨é•¿åº¦çš„ç¼–ç çš„é•¿åº¦ï¼Œç„¶åä¾æ¬¡è¿æ¥å„å­åˆ—è¡¨çš„ç¼–ç ã€‚</p><p>æ³¨æ„è§„åˆ™4æœ¬èº«æ˜¯é€’å½’å®šä¹‰çš„ã€‚<br>ä¾‹6ï¼š<code>[&quot;abc&quot;, &quot;def&quot;]</code>çš„ç¼–ç ç»“æœæ˜¯<code>200 131 97 98 99 131 100 101 102</code>ã€‚<br>å…¶ä¸­<code>abc</code>çš„ç¼–ç ä¸º<code>131 97 98 99</code>,<code>def</code>çš„ç¼–ç ä¸º<code>131 100 101 102</code>ã€‚ä¸¤ä¸ªå­å­—ç¬¦ä¸²çš„ç¼–ç åæ€»é•¿åº¦æ˜¯8ï¼Œå› æ­¤ç¼–ç ç»“æœç¬¬ä¸€ä½è®¡ç®—å¾—å‡ºï¼š<code>192 + 8 = 200</code></p><p><strong>è§„åˆ™5</strong>ï¼šå¦‚æœåˆ—è¡¨é•¿åº¦è¶…è¿‡55ï¼Œç¼–ç ç»“æœç¬¬ä¸€ä½æ˜¯247åŠ åˆ—è¡¨é•¿åº¦çš„ç¼–ç é•¿åº¦ï¼Œç„¶åæ˜¯åˆ—è¡¨é•¿åº¦æœ¬èº«çš„ç¼–ç ï¼Œæœ€åä¾æ¬¡è¿æ¥å„å­åˆ—è¡¨çš„ç¼–ç ã€‚</p><p>è§„åˆ™5æœ¬èº«ä¹Ÿæ˜¯é€’å½’å®šä¹‰çš„ï¼Œå’Œè§„åˆ™3ç›¸ä¼¼ã€‚</p><p>ä¾‹7ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]</span><br></pre></td></tr></table></figure><p>çš„ç¼–ç ç»“æœæ˜¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å‰ä¸¤ä¸ªå­—èŠ‚çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p><ol><li><code>248 = 247 +1</code></li><li><code>88 = 86 + 2</code>ï¼Œåœ¨<strong>è§„åˆ™3</strong>çš„ç¤ºä¾‹ä¸­ï¼Œé•¿åº¦ä¸º<code>86</code>ï¼Œè€Œåœ¨æ­¤ä¾‹ä¸­ï¼Œç”±äºæœ‰ä¸¤ä¸ªå­å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­å­—ç¬¦ä¸²æœ¬èº«çš„é•¿åº¦çš„ç¼–ç å„å 1å­—èŠ‚ï¼Œå› æ­¤æ€»å…±å 2å­—èŠ‚ã€‚<br>ç¬¬3ä¸ªå­—èŠ‚<code>179</code>ä¾æ®<strong>è§„åˆ™2</strong>å¾—å‡º<code>179 = 128 + 51</code></li></ol><p>ç¬¬55ä¸ªå­—èŠ‚<code>163</code>åŒæ ·ä¾æ®<strong>è§„åˆ™2</strong>å¾—å‡º<code>163 = 128 + 35</code></p><p>ä¾‹8ï¼šæœ€åæˆ‘ä»¬å†æ¥çœ‹ä¸ªç¨å¤æ‚ç‚¹çš„ä¾‹å­ä»¥åŠ æ·±ç†è§£<strong>é€’å½’</strong>é•¿åº¦å‰ç¼€ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;abc&quot;,[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]]</span><br></pre></td></tr></table></figure><p>ç¼–ç ç»“æœæ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">248 94 131 97 98 99 248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105115 32 115 101 110 116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 5332 98 121 116 101 115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 10132 73 32 112 114 101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure><p>åˆ—è¡¨ç¬¬ä¸€é¡¹å­—ç¬¦ä¸²<code>abc</code>æ ¹æ®<strong>è§„åˆ™2</strong>ï¼Œç¼–ç ç»“æœä¸º<code>131 97 98 99</code>,é•¿åº¦ä¸º4ã€‚<br>åˆ—è¡¨ç¬¬äºŒé¡¹ä¹Ÿæ˜¯ä¸€ä¸ªåˆ—è¡¨é¡¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]</span><br></pre></td></tr></table></figure><p>æ ¹æ®<strong>è§„åˆ™5</strong>ï¼Œç»“æœä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure><p>é•¿åº¦ä¸º90ï¼Œå› æ­¤ï¼Œæ•´ä¸ªåˆ—è¡¨çš„ç¼–ç ç»“æœç¬¬äºŒä½æ˜¯<code>90 + 4 = 94</code>, å ç”¨1ä¸ªå­—èŠ‚ï¼Œç¬¬ä¸€ä½<code>247 + 1 = 248</code></p><p>ä»¥ä¸Š5æ¡å°±æ˜¯RPLçš„å…¨éƒ¨ç¼–ç è§„åˆ™ã€‚</p><h4 id="è§£ç "><a href="#è§£ç " class="headerlink" title="è§£ç "></a>è§£ç </h4><p>è§£ç æ—¶ï¼Œé¦–å…ˆæ ¹æ®ç¼–ç ç»“æœç¬¬ä¸€ä¸ªå­—èŠ‚<code>f</code>çš„å¤§å°ï¼Œæ‰§è¡Œä»¥ä¸‹çš„è§„åˆ™åˆ¤æ–­ï¼š</p><ol><li>å¦‚æœfâˆˆ [0,128),ã€€é‚£ä¹ˆå®ƒæ˜¯ä¸€ä¸ªå­—èŠ‚æœ¬èº«ã€‚</li><li>å¦‚æœfâˆˆ[128,184)ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸€ä¸ªé•¿åº¦ä¸è¶…è¿‡55çš„byteæ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ä¸º <code>l=f-128</code></li><li>å¦‚æœfâˆˆ[184,192)ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸€ä¸ªé•¿åº¦è¶…è¿‡55çš„æ•°ç»„ï¼Œé•¿åº¦æœ¬èº«çš„ç¼–ç é•¿åº¦<code>ll=f-183</code>,ç„¶åä»ç¬¬äºŒä¸ªå­—èŠ‚å¼€å§‹è¯»å–é•¿åº¦ä¸ºllçš„bytesï¼ŒæŒ‰ç…§BigEndianç¼–ç æˆæ•´æ•°lï¼Œlå³ä¸ºæ•°ç»„çš„é•¿åº¦ã€‚</li><li>å¦‚æœfâˆˆ(192,247]ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸€ä¸ªç¼–ç åæ€»é•¿åº¦ä¸è¶…è¿‡55çš„åˆ—è¡¨ï¼Œåˆ—è¡¨é•¿åº¦ä¸º<code>l=f-192</code>ã€‚é€’å½’ä½¿ç”¨è§„åˆ™1~4è¿›è¡Œè§£ç ã€‚</li><li>å¦‚æœfâˆˆ(247,256]ï¼Œé‚£ä¹ˆå®ƒæ˜¯ç¼–ç åé•¿åº¦å¤§äº55çš„åˆ—è¡¨ï¼Œå…¶é•¿åº¦æœ¬èº«çš„ç¼–ç é•¿åº¦<code>ll=f-247</code>,ç„¶åä»ç¬¬äºŒä¸ªå­—èŠ‚è¯»å–é•¿åº¦ä¸ºllçš„bytes,æŒ‰BigEndianç¼–ç æˆæ•´æ•°lï¼Œlå³ä¸ºå­åˆ—è¡¨é•¿åº¦ã€‚ç„¶åé€’å½’æ ¹æ®è§£ç è§„åˆ™è¿›è¡Œè§£ç ã€‚</li></ol><h4 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><p>è¯­è¨€åœ¨å…·ä½“å®ç°RLPç¼–ç æ—¶ï¼Œé¦–å…ˆéœ€è¦å°†å¯¹åƒæ˜ å°„æˆbyteæ•°ç»„æˆ–åˆ—è¡¨ä¸¤ç§å½¢å¼ã€‚ä»¥goè¯­è¨€ç¼–ç structä¸ºä¾‹ï¼Œä¼šå°†å…¶æ˜ å°„ä¸ºåˆ—è¡¨ï¼Œä¾‹å¦‚<code>Student</code>è¿™ä¸ªå¯¹è±¡å¤„ç†æˆåˆ—è¡¨<code>[&quot;icattlecoder&quot;,&quot;male&quot;]</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type Student struct&#123;</span><br><span class="line">    Name string</span><br><span class="line">    Sex string</span><br><span class="line">&#125;</span><br><span class="line">s := Student&#123;Name:&quot;icattlecoder&quot;,Sex:&quot;male&quot;&#125;</span><br><span class="line">buff := bytes.Buffer&#123;&#125;</span><br><span class="line">rpl.Encode(&amp;buff, &amp;s)</span><br><span class="line">print(buff.Bytes())</span><br><span class="line">// [210 140 105 99 97 116 116 108 101 99 111 100 101 114 132 109 97 108 101]</span><br></pre></td></tr></table></figure><p>å¦‚æœç¼–ç mapç±»å‹ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹åˆ—è¡¨å½¢å¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[&quot;&quot;,&quot;&quot;],[&quot;&quot;,&quot;&quot;],[&quot;&quot;,&quot;&quot;]]</span><br></pre></td></tr></table></figure><h5 id="ä»£ç å­¦ä¹ æ”¶è·"><a href="#ä»£ç å­¦ä¹ æ”¶è·" class="headerlink" title="ä»£ç å­¦ä¹ æ”¶è·"></a>ä»£ç å­¦ä¹ æ”¶è·</h5><ul><li><p>bytes.Buffer</p><p>åœ¨éœ€è¦å­—ç¬¦æ‹¼æ¥é¢‘ç¹æ—¶ï¼Œå¯ä½¿ç”¨Buffer</p><p>bufferæ˜¯ä¸€ä¸ªå˜é•¿çš„ bytesï¼Œå…·æœ‰ Read å’ŒWrite æ–¹æ³•ã€‚ Buffer çš„ é›¶å€¼ æ˜¯ä¸€ä¸ª ç©ºçš„ bufferï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ã€‚<br>Buffer å°±åƒä¸€ä¸ªé›†è£…ç®±å®¹å™¨ï¼Œå¯ä»¥å­˜ä¸œè¥¿ï¼Œå–ä¸œè¥¿ï¼ˆå­˜å–æ•°æ®ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b1 := new(bytes.Buffer)</span><br><span class="line">b1.Write([]byte(&quot;asd&quot;))</span><br><span class="line">b1.Bytes() --&gt; asd</span><br></pre></td></tr></table></figure><p>åœ¨å­—ç¬¦ä¸²å€’æ¥å€’å»çš„æ—¶å€™ï¼Œæˆ–è€…æ˜¯å˜é•¿æ—¶å€™ï¼ŒGoä¸­å¯ä»¥ä½¿ç”¨â€œ+â€åˆå¹¶å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿™ç§åˆå¹¶æ–¹å¼æ•ˆç‡éå¸¸ä½ï¼Œ<strong>æ¯åˆå¹¶ä¸€æ¬¡ï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²,å°±å¿…é¡»éå†å¤åˆ¶ä¸€æ¬¡å­—ç¬¦ä¸²</strong>ï¼Œåœ¨Javaä¸­ä¼šé€‰æ‹©ä½¿ç”¨StringBuilder, åœ¨goä¸­ï¼Œç±»ä¼¼çš„æ–¹æ³•å°±æ˜¯bytes.Buffer(çº¿ç¨‹ä¸å®‰å…¨)ã€‚</p></li></ul><ul><li><p>sync.Pool</p><p>å¯¹è±¡æ± ã€‚åˆ›å»ºçš„æ—¶å€™å¯ä»¥æŒ‡å®šä¸€ä¸ªNewå‡½æ•°ï¼Œè·å–å¯¹è±¡çš„æ—¶å€™å¦‚ä½•åœ¨æ± é‡Œé¢æ‰¾ä¸åˆ°ç¼“å­˜çš„å¯¹è±¡å°†ä¼šä½¿ç”¨æŒ‡å®šçš„newå‡½æ•°åˆ›å»ºä¸€ä¸ªè¿”å›</p><p>å®ƒçš„ç”¨é€”ä»…ä»…æ˜¯å¢åŠ å¯¹è±¡é‡ç”¨çš„å‡ ç‡ï¼Œå‡å°‘gcçš„è´Ÿæ‹…ï¼Œè€Œå¼€é”€æ–¹é¢ä¹Ÿä¸æ˜¯å¾ˆä¾¿å®œçš„</p></li><li><p>æ¥å£å‡½æ•°</p><p>åœ¨ooä¸­ï¼Œå®ç°æ–¹æ³•çš„å¤šæ€ï¼Œéœ€è¦å¤šä¸ªå­ç±»ã€‚åœ¨goä¸­ï¼Œä½¿ç”¨æ¥å£å‡½æ•°å³å¯å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œè€Œä¸”éå¸¸ç®€ä¾¿</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">type print func()</span><br><span class="line">type A struct &#123;</span><br><span class="line">print</span><br><span class="line">&#125;</span><br><span class="line">func printString() &#123;</span><br><span class="line">fmt.Println(&quot;I am a string...&quot;)</span><br><span class="line">&#125;</span><br><span class="line">func printInt() &#123;</span><br><span class="line">fmt.Println(&quot;123456&quot;)</span><br><span class="line">&#125;</span><br><span class="line">func TestA_SetPrint(t *testing.T) &#123;</span><br><span class="line">a := &amp;A&#123;&#125;</span><br><span class="line">a.SetPrint(printString)</span><br><span class="line">a.print()</span><br><span class="line">//I am a string...</span><br><span class="line">&#125;</span><br><span class="line">//è¿˜æ˜¯å¾ˆåƒå¤šæ€ï¼Œåªæ˜¯å°†æ–¹æ³•printä½œä¸ºçˆ¶ï¼Œå…¶ä½™printStringã€printIntéƒ½æ˜¯å­ï¼Œè°ƒç”¨çš„æ—¶å€™è°ƒç”¨æŒ‡å‘å­çš„å¼•ç”¨ã€‚</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eth_code_tx_event</title>
      <link href="/2019/10/14/eth-code-tx-event/"/>
      <url>/2019/10/14/eth-code-tx-event/</url>
      
        <content type="html"><![CDATA[<h4 id="ApplyTransaction"><a href="#ApplyTransaction" class="headerlink" title="ApplyTransaction"></a>ApplyTransaction</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// ApplyTransaction attempts to apply a transaction to the given state database</span><br><span class="line">// and uses the input parameters for its environment. It returns the receipt</span><br><span class="line">// for the transaction, gas used and an error if the transaction failed,</span><br><span class="line">// indicating the block was invalid.</span><br><span class="line">//åº”ç”¨äº¤æ˜“åˆ°state databaseä¸­</span><br><span class="line">func ApplyTransaction(config *params.ChainConfig, bc ChainContext, author *common.Address, gp *GasPool, statedb *state.StateDB, header *types.Header, tx *types.Transaction, usedGas *uint64, cfg vm.Config) (*types.Receipt, uint64, error) &#123;</span><br><span class="line">//æ„é€ äº¤æ˜“æ¶ˆæ¯</span><br><span class="line">msg, err := tx.AsMessage(types.MakeSigner(config, header.Number))</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return nil, 0, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//EVMè¿›è¡Œäº¤æ˜“å¤„ç†ï¼Œè¿”å›ä¸ºå¤„ç†ç»“æœã€æ¶ˆè€—gasã€æ˜¯å¦å¤±è´¥ã€errï¼Œlogsæ˜¯åœ¨evmå¤„ç†æ—¶äº§ç”Ÿçš„</span><br><span class="line">// Create a new context to be used in the EVM environment</span><br><span class="line">context := NewEVMContext(msg, header, bc, author)</span><br><span class="line">// Create a new environment which holds all relevant information</span><br><span class="line">// about the transaction and calling mechanisms.</span><br><span class="line">vmenv := vm.NewEVM(context, statedb, config, cfg)</span><br><span class="line">// Apply the transaction to the current state (included in the env)</span><br><span class="line">_, gas, failed, err := ApplyMessage(vmenv, msg, gp)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return nil, 0, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//æ ¹æ®å¤„ç†ç»“æœæ„å»ºè¿”å›æ•°æ®</span><br><span class="line">// Update the state with pending changes</span><br><span class="line">var root []byte</span><br><span class="line">if config.IsByzantium(header.Number) &#123;</span><br><span class="line">statedb.Finalise(true)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">root = statedb.IntermediateRoot(config.IsEIP158(header.Number)).Bytes()</span><br><span class="line">&#125;</span><br><span class="line">*usedGas += gas</span><br><span class="line"></span><br><span class="line">// Create a new receipt for the transaction, storing the intermediate root and gas used by the tx</span><br><span class="line">// based on the eip phase, we&apos;re passing whether the root touch-delete accounts.</span><br><span class="line">receipt := types.NewReceipt(root, failed, *usedGas)</span><br><span class="line">receipt.TxHash = tx.Hash()</span><br><span class="line">receipt.GasUsed = gas</span><br><span class="line">// if the transaction created a contract, store the creation address in the receipt.</span><br><span class="line">if msg.To() == nil &#123;</span><br><span class="line">receipt.ContractAddress = crypto.CreateAddress(vmenv.Context.Origin, tx.Nonce())</span><br><span class="line">&#125;</span><br><span class="line">// Set the receipt logs and create a bloom for filtering</span><br><span class="line">receipt.Logs = statedb.GetLogs(tx.Hash())</span><br><span class="line">receipt.Bloom = types.CreateBloom(types.Receipts&#123;receipt&#125;)</span><br><span class="line"></span><br><span class="line">return receipt, gas, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">func (evm *EVM) Call(caller ContractRef, addr common.Address, input []byte, gas uint64, value *big.Int) (ret []byte, leftOverGas uint64, err error) &#123;</span><br><span class="line">if evm.vmConfig.NoRecursion &amp;&amp; evm.depth &gt; 0 &#123;</span><br><span class="line">return nil, gas, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Fail if we&apos;re trying to execute above the call depth limit</span><br><span class="line">if evm.depth &gt; int(params.CallCreateDepth) &#123;</span><br><span class="line">return nil, gas, ErrDepth</span><br><span class="line">&#125;</span><br><span class="line">// Fail if we&apos;re trying to transfer more than the available balance</span><br><span class="line">if !evm.Context.CanTransfer(evm.StateDB, caller.Address(), value) &#123;</span><br><span class="line">return nil, gas, ErrInsufficientBalance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">to       = AccountRef(addr)</span><br><span class="line">snapshot = evm.StateDB.Snapshot()</span><br><span class="line">)</span><br><span class="line">if !evm.StateDB.Exist(addr) &#123;</span><br><span class="line">precompiles := PrecompiledContractsHomestead</span><br><span class="line">if evm.ChainConfig().IsByzantium(evm.BlockNumber) &#123;</span><br><span class="line">precompiles = PrecompiledContractsByzantium</span><br><span class="line">&#125;</span><br><span class="line">if precompiles[addr] == nil &amp;&amp; evm.ChainConfig().IsEIP158(evm.BlockNumber) &amp;&amp; value.Sign() == 0 &#123;</span><br><span class="line">// Calling a non existing account, don&apos;t do anything, but ping the tracer</span><br><span class="line">if evm.vmConfig.Debug &amp;&amp; evm.depth == 0 &#123;</span><br><span class="line">evm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)</span><br><span class="line">evm.vmConfig.Tracer.CaptureEnd(ret, 0, 0, nil)</span><br><span class="line">&#125;</span><br><span class="line">return nil, gas, nil</span><br><span class="line">&#125;</span><br><span class="line">evm.StateDB.CreateAccount(addr)</span><br><span class="line">&#125;</span><br><span class="line">evm.Transfer(evm.StateDB, caller.Address(), to.Address(), value)</span><br><span class="line">// Initialise a new contract and set the code that is to be used by the EVM.</span><br><span class="line">// The contract is a scoped environment for this execution context only.</span><br><span class="line">contract := NewContract(caller, to, value, gas)</span><br><span class="line">contract.SetCallCode(&amp;addr, evm.StateDB.GetCodeHash(addr), evm.StateDB.GetCode(addr))</span><br><span class="line"></span><br><span class="line">// Even if the account has no code, we need to continue because it might be a precompile</span><br><span class="line">start := time.Now()</span><br><span class="line"></span><br><span class="line">// Capture the tracer start/end events in debug mode</span><br><span class="line">if evm.vmConfig.Debug &amp;&amp; evm.depth == 0 &#123;</span><br><span class="line">evm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)</span><br><span class="line"></span><br><span class="line">defer func() &#123; // Lazy evaluation of the parameters</span><br><span class="line">evm.vmConfig.Tracer.CaptureEnd(ret, gas-contract.Gas, time.Since(start), err)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">ret, err = run(evm, contract, input, false)</span><br><span class="line"></span><br><span class="line">// When an error was returned by the EVM or when setting the creation code</span><br><span class="line">// above we revert to the snapshot and consume any gas remaining. Additionally</span><br><span class="line">// when we&apos;re in homestead this also counts for code storage gas errors.</span><br><span class="line">if err != nil &#123;</span><br><span class="line">evm.StateDB.RevertToSnapshot(snapshot)</span><br><span class="line">if err != errExecutionReverted &#123;</span><br><span class="line">contract.UseGas(contract.Gas)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return ret, contract.Gas, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="handleMsg"><a href="#handleMsg" class="headerlink" title="handleMsg"></a>handleMsg</h4><p>å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ç </p><ul><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StatusMsg</span><br></pre></td></tr></table></figure><p>æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯è¯´æ˜æ¡æ‰‹å¤±è´¥</p></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetBlockHeadersMsg</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢åŒºå—å¤´è¯·æ±‚ï¼Œå›å¤åŒºå—å¤´ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BlockHeadersMsg</span><br></pre></td></tr></table></figure><p>åŒºå—å¤´ä¿¡æ¯çš„å›å¤</p></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetBlockBodiesMsg</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢åŒºå—è¯·æ±‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BlockBodiesMsg</span><br></pre></td></tr></table></figure><p>åŒºå—è¯·æ±‚æŸ¥è¯¢çš„å›å¤ï¼Œ</p></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetNodeDataMsg</span><br></pre></td></tr></table></figure></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NodeDataMsg</span><br></pre></td></tr></table></figure></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetReceiptsMsg</span><br></pre></td></tr></table></figure></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReceiptsMsg</span><br></pre></td></tr></table></figure></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NewBlockHashesMsg</span><br></pre></td></tr></table></figure></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NewBlockMsg</span><br></pre></td></tr></table></figure></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TxMsg</span><br></pre></td></tr></table></figure></li></ul><h4 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h4><p>è¿™å››ä¸ªgoroutine åŸºæœ¬ä¸Šå°±åœ¨ä¸åœçš„åšå¹¿æ’­åŒºå—ã€å¹¿æ’­äº¤æ˜“ï¼ŒåŒæ­¥åˆ°åŒºå—ã€åŒæ­¥åˆ°äº¤æ˜“ï¼Œå†å¹¿æ’­åŒºå—ã€å¹¿æ’­äº¤æ˜“ã€‚</p><ul><li><p>txBroadcastLoop</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func (self *ProtocolManager) txBroadcastLoop() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case event := &lt;-self.txCh:</span><br><span class="line">            self.BroadcastTx(event.Tx.Hash(), event.Tx)</span><br><span class="line"></span><br><span class="line">        // Err() channel will be closed when unsubscribing.</span><br><span class="line">        case &lt;-self.txSub.Err():</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>core/tx_pool.go äº§ç”Ÿæ–°çš„äº¤æ˜“çš„æ—¶å€™ä¼šsend self.txChï¼Œè¿™æ—¶å€™ä¼šæ¿€æ´»<br>self.BroadcastTx(event.Tx.Hash(), event.Tx)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func (pm *ProtocolManager) BroadcastTx(hash common.Hash, tx *types.Transaction) &#123;</span><br><span class="line">    // Broadcast transaction to a batch of peers not knowing about it</span><br><span class="line">    peers := pm.peers.PeersWithoutTx(hash)</span><br><span class="line">    //FIXME include this again: peers = peers[:int(math.Sqrt(float64(len(peers))))]</span><br><span class="line">    for _, peer := range peers &#123;</span><br><span class="line">        peer.SendTransactions(types.Transactions&#123;tx&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Trace(&quot;Broadcast transaction&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(peers))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç¼“å­˜çš„æ²¡æœ‰è¿™ä¸ªäº¤æ˜“hashçš„ç½‘ç»œèŠ‚ç‚¹å¹¿æ’­æ­¤æ¬¡äº¤æ˜“ã€‚</p></li><li><p>minedBroadcastLoop</p><p>æ”¶åˆ°miner.go é‡Œé¢NewMinedBlockEvent æŒ–åˆ°æ–°åŒºå—çš„äº‹ä»¶é€šçŸ¥ï¼Œæ¿€æ´»self.BroadcastBlock(ev.Block, true)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Mined broadcast loop</span><br><span class="line">func (self *ProtocolManager) minedBroadcastLoop() &#123;</span><br><span class="line">    // automatically stops if unsubscribe</span><br><span class="line">    for obj := range self.minedBlockSub.Chan() &#123;</span><br><span class="line">        switch ev := obj.Data.(type) &#123;</span><br><span class="line">        case core.NewMinedBlockEvent:</span><br><span class="line">            self.BroadcastBlock(ev.Block, true)  // First propagate block to peers</span><br><span class="line">            self.BroadcastBlock(ev.Block, false) // Only then announce to the rest</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">func (pm *ProtocolManager) BroadcastBlock(block *types.Block, propagate bool) &#123;</span><br><span class="line">    hash := block.Hash()</span><br><span class="line">    peers := pm.peers.PeersWithoutBlock(hash)</span><br><span class="line"></span><br><span class="line">    // If propagation is requested, send to a subset of the peer</span><br><span class="line">    if propagate &#123;</span><br><span class="line">        // Calculate the TD of the block (it&apos;s not imported yet, so block.Td is not valid)</span><br><span class="line">        var td *big.Int</span><br><span class="line">        if parent := pm.blockchain.GetBlock(block.ParentHash(), block.NumberU64()-1); parent != nil &#123;</span><br><span class="line">            td = new(big.Int).Add(block.Difficulty(), pm.blockchain.GetTd(block.ParentHash(), block.NumberU64()-1))</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            log.Error(&quot;Propagating dangling block&quot;, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        // Send the block to a subset of our peers</span><br><span class="line">        transfer := peers[:int(math.Sqrt(float64(len(peers))))]</span><br><span class="line">        for _, peer := range transfer &#123;</span><br><span class="line">            peer.SendNewBlock(block, td)</span><br><span class="line">        &#125;</span><br><span class="line">        log.Trace(&quot;Propagated block&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(transfer), &quot;duration&quot;, common.PrettyDuration(time.Since(block.ReceivedAt)))</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // Otherwise if the block is indeed in out own chain, announce it</span><br><span class="line">    if pm.blockchain.HasBlock(hash, block.NumberU64()) &#123;</span><br><span class="line">        for _, peer := range peers &#123;</span><br><span class="line">            peer.SendNewBlockHashes([]common.Hash&#123;hash&#125;, []uint64&#123;block.NumberU64()&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        log.Trace(&quot;Announced block&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(peers), &quot;duration&quot;, common.PrettyDuration(time.Since(block.ReceivedAt)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœpropagateä¸ºtrue å‘ç½‘ç»œèŠ‚ç‚¹å¹¿æ’­æ•´ä¸ªæŒ–åˆ°çš„blockï¼Œä¸ºfalse åªå¹¿æ’­æŒ–åˆ°çš„åŒºå—çš„hashå€¼å’Œnumberå€¼ã€‚å¹¿æ’­çš„åŒºå—è¿˜åŒ…æ‹¬è¿™ä¸ªåŒºå—æ‰“åŒ…çš„æ‰€æœ‰äº¤æ˜“ã€‚</p></li><li><p>syncer</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">func (pm *ProtocolManager) syncer() &#123;</span><br><span class="line">    // Start and ensure cleanup of sync mechanisms</span><br><span class="line">    pm.fetcher.Start()</span><br><span class="line">    defer pm.fetcher.Stop()</span><br><span class="line">    defer pm.downloader.Terminate()</span><br><span class="line"></span><br><span class="line">    // Wait for different events to fire synchronisation operations</span><br><span class="line">    forceSync := time.NewTicker(forceSyncCycle)</span><br><span class="line">    defer forceSync.Stop()</span><br><span class="line"></span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-pm.newPeerCh:</span><br><span class="line">            // Make sure we have peers to select from, then sync</span><br><span class="line">            if pm.peers.Len() &lt; minDesiredPeerCount &#123;</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            go pm.synchronise(pm.peers.BestPeer())</span><br><span class="line"></span><br><span class="line">        case &lt;-forceSync.C:</span><br><span class="line">            // Force a sync even if not enough peers are present</span><br><span class="line">            go pm.synchronise(pm.peers.BestPeer())</span><br><span class="line"></span><br><span class="line">        case &lt;-pm.noMorePeers:</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pm.fetcher.Start()å¯åŠ¨ fetcherï¼Œè¾…åŠ©åŒæ­¥åŒºå—æ•°æ®</p><p>å½“P2P serveræ‰§è¡Œ ProtocolManager çš„p2p.Protocol çš„RunæŒ‡é’ˆçš„æ—¶å€™ä¼šsend pm.newPeerChï¼Œè¿™æ—¶å€™é€‰æ‹©æœ€ä¼˜çš„ç½‘ç»œèŠ‚ç‚¹ï¼ˆTD æ€»éš¾åº¦æœ€å¤§çš„ï¼‰å¯åŠ¨pm.synchronise(pm.peers.BestPeer()) goroutineã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// synchronise tries to sync up our local block chain with a remote peer.</span><br><span class="line">func (pm *ProtocolManager) synchronise(peer *peer) &#123;</span><br><span class="line">    // Short circuit if no peers are available</span><br><span class="line">    if peer == nil &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // Make sure the peer&apos;s TD is higher than our own</span><br><span class="line">    currentBlock := pm.blockchain.CurrentBlock()</span><br><span class="line">    td := pm.blockchain.GetTd(currentBlock.Hash(), currentBlock.NumberU64())</span><br><span class="line"></span><br><span class="line">    pHead, pTd := peer.Head()</span><br><span class="line">    if pTd.Cmp(td) &lt;= 0 &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // Otherwise try to sync with the downloader</span><br><span class="line">    mode := downloader.FullSync</span><br><span class="line">    if atomic.LoadUint32(&amp;pm.fastSync) == 1 &#123;</span><br><span class="line">        // Fast sync was explicitly requested, and explicitly granted</span><br><span class="line">        mode = downloader.FastSync</span><br><span class="line">    &#125; else if currentBlock.NumberU64() == 0 &amp;&amp; pm.blockchain.CurrentFastBlock().NumberU64() &gt; 0 &#123;</span><br><span class="line">        // The database seems empty as the current block is the genesis. Yet the fast</span><br><span class="line">        // block is ahead, so fast sync was enabled for this node at a certain point.</span><br><span class="line">        // The only scenario where this can happen is if the user manually (or via a</span><br><span class="line">        // bad block) rolled back a fast sync node below the sync point. In this case</span><br><span class="line">        // however it&apos;s safe to reenable fast sync.</span><br><span class="line">        atomic.StoreUint32(&amp;pm.fastSync, 1)</span><br><span class="line">        mode = downloader.FastSync</span><br><span class="line">    &#125;</span><br><span class="line">    // Run the sync cycle, and disable fast sync if we&apos;ve went past the pivot block</span><br><span class="line">    if err := pm.downloader.Synchronise(peer.id, pHead, pTd, mode); err != nil &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    if atomic.LoadUint32(&amp;pm.fastSync) == 1 &#123;</span><br><span class="line">        log.Info(&quot;Fast sync complete, auto disabling&quot;)</span><br><span class="line">        atomic.StoreUint32(&amp;pm.fastSync, 0)</span><br><span class="line">    &#125;</span><br><span class="line">    atomic.StoreUint32(&amp;pm.acceptTxs, 1) // Mark initial sync done</span><br><span class="line">    if head := pm.blockchain.CurrentBlock(); head.NumberU64() &gt; 0 &#123;</span><br><span class="line">        // We&apos;ve completed a sync cycle, notify all peers of new state. This path is</span><br><span class="line">        // essential in star-topology networks where a gateway node needs to notify</span><br><span class="line">        // all its out-of-date peers of the availability of a new block. This failure</span><br><span class="line">        // scenario will most often crop up in private and hackathon networks with</span><br><span class="line">        // degenerate connectivity, but it should be healthy for the mainnet too to</span><br><span class="line">        // more reliably update peers or the local TD state.</span><br><span class="line">        go pm.BroadcastBlock(head, false)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ€ä¼˜çš„ç½‘ç»œèŠ‚ç‚¹çš„TDå€¼å¤§äºæœ¬åœ°æœ€æ–°åŒºå—çš„TDå€¼ï¼Œè°ƒç”¨pm.downloader.Synchronise(peer.id, pHead, pTd, mode)è¿›è¡ŒåŒæ­¥ã€‚åŒæ­¥å®Œæˆåå†å±Œç”¨go pm.BroadcastBlock(head, false)ï¼ŒæŠŠè‡ªå·±æœ€æ–°çš„åŒºå—çŠ¶æ€å¹¿æ’­å‡ºå»ã€‚</p></li><li><p>txsyncLoop</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">func (pm *ProtocolManager) txsyncLoop() &#123;</span><br><span class="line">    var (</span><br><span class="line">        pending = make(map[discover.NodeID]*txsync)</span><br><span class="line">        sending = false               // whether a send is active</span><br><span class="line">        pack    = new(txsync)         // the pack that is being sent</span><br><span class="line">        done    = make(chan error, 1) // result of the send</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    // send starts a sending a pack of transactions from the sync.</span><br><span class="line">    send := func(s *txsync) &#123;</span><br><span class="line">        // Fill pack with transactions up to the target size.</span><br><span class="line">        size := common.StorageSize(0)</span><br><span class="line">        pack.p = s.p</span><br><span class="line">        pack.txs = pack.txs[:0]</span><br><span class="line">        for i := 0; i &lt; len(s.txs) &amp;&amp; size &lt; txsyncPackSize; i++ &#123;</span><br><span class="line">            pack.txs = append(pack.txs, s.txs[i])</span><br><span class="line">            size += s.txs[i].Size()</span><br><span class="line">        &#125;</span><br><span class="line">        // Remove the transactions that will be sent.</span><br><span class="line">        s.txs = s.txs[:copy(s.txs, s.txs[len(pack.txs):])]</span><br><span class="line">        if len(s.txs) == 0 &#123;</span><br><span class="line">            delete(pending, s.p.ID())</span><br><span class="line">        &#125;</span><br><span class="line">        // Send the pack in the background.</span><br><span class="line">        s.p.Log().Trace(&quot;Sending batch of transactions&quot;, &quot;count&quot;, len(pack.txs), &quot;bytes&quot;, size)</span><br><span class="line">        sending = true</span><br><span class="line">        go func() &#123; done &lt;- pack.p.SendTransactions(pack.txs) &#125;()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // pick chooses the next pending sync.</span><br><span class="line">    pick := func() *txsync &#123;</span><br><span class="line">        if len(pending) == 0 &#123;</span><br><span class="line">            return nil</span><br><span class="line">        &#125;</span><br><span class="line">        n := rand.Intn(len(pending)) + 1</span><br><span class="line">        for _, s := range pending &#123;</span><br><span class="line">            if n--; n == 0 &#123;</span><br><span class="line">                return s</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case s := &lt;-pm.txsyncCh:</span><br><span class="line">            pending[s.p.ID()] = s</span><br><span class="line">            if !sending &#123;</span><br><span class="line">                send(s)</span><br><span class="line">            &#125;</span><br><span class="line">        case err := &lt;-done:</span><br><span class="line">            sending = false</span><br><span class="line">            // Stop tracking peers that cause send failures.</span><br><span class="line">            if err != nil &#123;</span><br><span class="line">                pack.p.Log().Debug(&quot;Transaction send failed&quot;, &quot;err&quot;, err)</span><br><span class="line">                delete(pending, pack.p.ID())</span><br><span class="line">            &#125;</span><br><span class="line">            // Schedule the next send.</span><br><span class="line">            if s := pick(); s != nil &#123;</span><br><span class="line">                send(s)</span><br><span class="line">            &#125;</span><br><span class="line">        case &lt;-pm.quitSync:</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä»ç½‘ç»œèŠ‚ç‚¹åŒæ­¥è¿‡æ¥æœ€æ–°çš„äº¤æ˜“æ•°æ®åï¼Œæœ¬åœ°ä¹Ÿä¼šæŠŠæ–°åŒæ­¥ä¸‹æ¥çš„äº¤æ˜“æ•°æ®å¹¿æ’­ç»™ç½‘ç»œä¸­çš„å…¶ä»–èŠ‚ç‚¹ã€‚</p></li></ul><h4 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h4><p>fetcheræ˜¯ç”¨æ¥è¾…åŠ©åŒæ­¥åŒºå—æ•°æ®çš„ï¼Œè®°å½•å„ä¸ªåŒºå—å¤´å’ŒåŒºå—ä½“çš„åŒæ­¥çŠ¶æ€ï¼Œä½†å®ƒå¹¶ä¸åšçœŸæ­£ä¸‹è½½åŒºå—æ•°æ®çš„äº‹æƒ…ï¼Œä¸‹è½½çš„äº‹æƒ…äº¤ç”±downloaderæ¥åšã€‚é‚£fetcherå…·ä½“æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿ<br>æˆ‘ä»¬å…ˆçœ‹çœ‹pm.handleMsg åœ¨æ”¶åˆ° NewBlockHashesMsgå¹¿æ’­é€šçŸ¥çš„å¤„ç†ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">case msg.Code == NewBlockHashesMsg:</span><br><span class="line">        var announces newBlockHashesData</span><br><span class="line">        if err := msg.Decode(&amp;announces); err != nil &#123;</span><br><span class="line">            return errResp(ErrDecode, &quot;%v: %v&quot;, msg, err)</span><br><span class="line">        &#125;</span><br><span class="line">        // Mark the hashes as present at the remote node</span><br><span class="line">        for _, block := range announces &#123;</span><br><span class="line">            p.MarkBlock(block.Hash)</span><br><span class="line">        &#125;</span><br><span class="line">        // Schedule all the unknown hashes for retrieval</span><br><span class="line">        unknown := make(newBlockHashesData, 0, len(announces))</span><br><span class="line">        for _, block := range announces &#123;</span><br><span class="line">            if !pm.blockchain.HasBlock(block.Hash, block.Number) &#123;</span><br><span class="line">                unknown = append(unknown, block)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        for _, block := range unknown &#123;</span><br><span class="line">            pm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä»å¹¿æ’­é€šçŸ¥é‡Œä¼šè·å–åˆ°ä¸€ä¸ªnewBlockHashesDataçš„åˆ—è¡¨ã€‚newBlockHashesDataåªåŒ…æ‹¬blockçš„hashå€¼å’Œblockçš„numberå€¼ã€‚<br>ç„¶åæ¯ä¸ªnewBlockHashesDataè°ƒç”¨pm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)æ–¹æ³•ï¼Œé™¤äº†ä¼ å…¥blockçš„hashå€¼å’Œblockçš„numberå€¼ï¼Œè¿˜éœ€è¦ä¼ å…¥å½“å‰çš„æ—¶é—´æˆ³ï¼Œpeer.goçš„ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func (f *Fetcher) Notify(peer string, hash common.Hash, number uint64, time time.Time,</span><br><span class="line">    headerFetcher headerRequesterFn, bodyFetcher bodyRequesterFn) error &#123;</span><br><span class="line">    block := &amp;announce&#123;</span><br><span class="line">        hash:        hash,</span><br><span class="line">        number:      number,</span><br><span class="line">        time:        time,</span><br><span class="line">        origin:      peer,</span><br><span class="line">        fetchHeader: headerFetcher,</span><br><span class="line">        fetchBodies: bodyFetcher,</span><br><span class="line">    &#125;</span><br><span class="line">    select &#123;</span><br><span class="line">    case f.notify &lt;- block:</span><br><span class="line">        return nil</span><br><span class="line">    case &lt;-f.quit:</span><br><span class="line">        return errTerminated</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Notify()æ–¹æ³•æŠŠä¼ è¿›æ¥çš„å‚æ•°æ‹¼æˆä¸€ä¸ªannounceå¯¹è±¡ï¼Œç„¶åsendç»™f.notifyã€‚fetcherçš„loop()ä¸»å›è·¯é‡Œf.notify receive åˆ°è¿™ä¸ªnotification, è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">case notification := &lt;-f.notify:</span><br><span class="line">            // A block was announced, make sure the peer isn&apos;t DOSing us</span><br><span class="line">            propAnnounceInMeter.Mark(1)</span><br><span class="line"></span><br><span class="line">            count := f.announces[notification.origin] + 1</span><br><span class="line">            if count &gt; hashLimit &#123;</span><br><span class="line">                log.Debug(&quot;Peer exceeded outstanding announces&quot;, &quot;peer&quot;, notification.origin, &quot;limit&quot;, hashLimit)</span><br><span class="line">                propAnnounceDOSMeter.Mark(1)</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            // If we have a valid block number, check that it&apos;s potentially useful</span><br><span class="line">            if notification.number &gt; 0 &#123;</span><br><span class="line">                if dist := int64(notification.number) - int64(f.chainHeight()); dist &lt; -maxUncleDist || dist &gt; maxQueueDist &#123;</span><br><span class="line">                    log.Debug(&quot;Peer discarded announcement&quot;, &quot;peer&quot;, notification.origin, &quot;number&quot;, notification.number, &quot;hash&quot;, notification.hash, &quot;distance&quot;, dist)</span><br><span class="line">                    propAnnounceDropMeter.Mark(1)</span><br><span class="line">                    break</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // All is well, schedule the announce if block&apos;s not yet downloading</span><br><span class="line">            if _, ok := f.fetching[notification.hash]; ok &#123;</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            if _, ok := f.completing[notification.hash]; ok &#123;</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            f.announces[notification.origin] = count</span><br><span class="line">            f.announced[notification.hash] = append(f.announced[notification.hash], notification)</span><br><span class="line">            if f.announceChangeHook != nil &amp;&amp; len(f.announced[notification.hash]) == 1 &#123;</span><br><span class="line">                f.announceChangeHook(notification.hash, true)</span><br><span class="line">            &#125;</span><br><span class="line">            if len(f.announced) == 1 &#123;</span><br><span class="line">                f.rescheduleFetch(fetchTimer)</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>1ï¼Œå°†æ”¶åˆ°çš„ä¸æ»¡è¶³æ¡ä»¶çš„é€šçŸ¥éƒ½ä¸¢å¼ƒæ‰ï¼Œå¦‚æœåœ¨f.fetching çŠ¶æ€åˆ—è¡¨é‡Œå’Œf.completing çŠ¶æ€åˆ—è¡¨é‡Œï¼Œä¹Ÿç›´æ¥è¿”å›ã€‚æ¥ç€æ›´æ–°notification.origin è¿™ä¸ªèŠ‚ç‚¹çš„announces æ•°é‡ï¼Œæ·»åŠ åˆ°f.announced ç­‰å¾…fetchçš„è¡¨é‡Œã€‚<br>2ï¼Œå¦‚æœlen(f.announced[notification.hash]) == 1 è¯´æ˜f.announcedåªæœ‰è¿™ä¸€ä¸ªé€šçŸ¥ï¼Œåˆ™è°ƒç”¨f.announceChangeHookã€‚<br>3ï¼Œå¦‚æœlen(f.announced) == 1 ä¹Ÿè¯´æ˜åªæœ‰ä¸€ä¸ªé€šçŸ¥ï¼Œåˆ™å¯åŠ¨fetchTimerçš„è°ƒåº¦ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">case &lt;-fetchTimer.C:</span><br><span class="line">            // At least one block&apos;s timer ran out, check for needing retrieval</span><br><span class="line">            request := make(map[string][]common.Hash)</span><br><span class="line"></span><br><span class="line">            for hash, announces := range f.announced &#123;</span><br><span class="line">                if time.Since(announces[0].time) &gt; arriveTimeout-gatherSlack &#123;</span><br><span class="line">                    // Pick a random peer to retrieve from, reset all others</span><br><span class="line">                    announce := announces[rand.Intn(len(announces))]</span><br><span class="line">                    f.forgetHash(hash)</span><br><span class="line"></span><br><span class="line">                    // If the block still didn&apos;t arrive, queue for fetching</span><br><span class="line">                    if f.getBlock(hash) == nil &#123;</span><br><span class="line">                        request[announce.origin] = append(request[announce.origin], hash)</span><br><span class="line">                        f.fetching[hash] = announce</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Send out all block header requests</span><br><span class="line">            for peer, hashes := range request &#123;</span><br><span class="line">                log.Trace(&quot;Fetching scheduled headers&quot;, &quot;peer&quot;, peer, &quot;list&quot;, hashes)</span><br><span class="line"></span><br><span class="line">                // Create a closure of the fetch and schedule in on a new thread</span><br><span class="line">                fetchHeader, hashes := f.fetching[hashes[0]].fetchHeader, hashes</span><br><span class="line">                go func() &#123;</span><br><span class="line">                    if f.fetchingHook != nil &#123;</span><br><span class="line">                        f.fetchingHook(hashes)</span><br><span class="line">                    &#125;</span><br><span class="line">                    for _, hash := range hashes &#123;</span><br><span class="line">                        headerFetchMeter.Mark(1)</span><br><span class="line">                        fetchHeader(hash) // Suboptimal, but protocol doesn&apos;t allow batch header retrievals</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;()</span><br><span class="line">            &#125;</span><br><span class="line">            // Schedule the next fetch if blocks are still pending</span><br><span class="line">            f.rescheduleFetch(fetchTimer)</span><br></pre></td></tr></table></figure><p>1ï¼Œé¦–å…ˆéå†f.announcedï¼Œå¦‚æœè¶…è¿‡äº†arriveTimeout-gatherSlackè¿™ä¸ªæ—¶é—´ï¼ŒæŠŠè¿™ä¸ªhashå¯¹åº”åœ¨fetcheré‡Œé¢çš„çŠ¶æ€éƒ½æ¸…äº†ã€‚<br>è¿™é‡Œéšæœºæ‹¿è¿™ä¸ªannouncesé‡Œé¢ä»»æ„ä¸€ä¸ªannounceï¼Œä¸ºå•¥éšæœºå–ä¸€ä¸ªå‘¢ï¼Ÿå› ä¸ºéƒ½æ˜¯åŒä¸€ä¸ªblockçš„hashï¼Œè¿™ä¸ªhashä¸‹çš„å“ªä¸€ä¸ªannounceéƒ½æ˜¯ä¸€æ ·çš„ã€‚<br>å¦‚æœå‘ç°è¶…æ—¶äº†è¿˜æ²¡æœ‰æ²¡æœ‰è·å–åˆ°è¿™ä¸ªhashçš„blockï¼Œåˆ™æŠŠè¿™ä¸ªannounceåŠ åˆ°requeståˆ—è¡¨ä¸­ï¼ŒåŒæ—¶é‡æ–°æŠŠannounceæ”¾åˆ°f.fetchingçŠ¶æ€åˆ—è¡¨ã€‚<br>2ï¼Œç„¶åéå†requeståˆ—è¡¨ï¼Œrequeståˆ—è¡¨é‡Œé¢çš„æ¯ä¸ªç½‘ç»œèŠ‚ç‚¹è¿‡æ¥çš„æ‰€æœ‰çš„blockçš„hashï¼Œéƒ½ä¼šè°ƒç”¨fetchHeader(hash)æ–¹æ³•æ¥è·å–headeræ•°æ®ã€‚<br>è¿™ä¸ªfetchHeader(hash)æ–¹æ³•æ˜¯pm.fetcher.Notifyä¼ è¿›æ¥çš„ï¼Œpeer.go<br>é‡Œé¢çš„ä¸€ä¸ªå…¨å±€æ–¹æ³•ã€‚<br>3ï¼Œ è¿™æ—¶å€™NewBlockHashesMsg çš„fetcherå¤„ç†å°±ç»“æŸäº†ï¼Œæœ€åå†å¯åŠ¨fetchTimerçš„è°ƒåº¦ã€‚</p><p>ä¸‰ï¼ŒFetcheråˆ†æï¼Œ ä¹‹FilterHeaders()<br>fetchHeader(hash)æ–¹æ³•ï¼Œè°ƒç”¨äº†peer.go é‡Œé¢çš„å…¨å±€æ–¹æ³•RequestOneHeader(hash common.Hash)  Sendç»™ç½‘ç»œèŠ‚ç‚¹ä¸€ä¸ªGetBlockHeadersMsg æ¶ˆæ¯ã€‚<br>ç„¶åpm.handleMsg æ”¶åˆ° BlockHashesMsgå¹¿æ’­é€šçŸ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">case msg.Code == BlockHeadersMsg:</span><br><span class="line">        // A batch of headers arrived to one of our previous requests</span><br><span class="line">        var headers []*types.Header</span><br><span class="line">        if err := msg.Decode(&amp;headers); err != nil &#123;</span><br><span class="line">            return errResp(ErrDecode, &quot;msg %v: %v&quot;, msg, err)</span><br><span class="line">        &#125;</span><br><span class="line">        // If no headers were received, but we&apos;re expending a DAO fork check, maybe it&apos;s that</span><br><span class="line">        if len(headers) == 0 &amp;&amp; p.forkDrop != nil &#123;</span><br><span class="line">            // Possibly an empty reply to the fork header checks, sanity check TDs</span><br><span class="line">            verifyDAO := true</span><br><span class="line"></span><br><span class="line">            // If we already have a DAO header, we can check the peer&apos;s TD against it. If</span><br><span class="line">            // the peer&apos;s ahead of this, it too must have a reply to the DAO check</span><br><span class="line">            if daoHeader := pm.blockchain.GetHeaderByNumber(pm.chainconfig.DAOForkBlock.Uint64()); daoHeader != nil &#123;</span><br><span class="line">                if _, td := p.Head(); td.Cmp(pm.blockchain.GetTd(daoHeader.Hash(), daoHeader.Number.Uint64())) &gt;= 0 &#123;</span><br><span class="line">                    verifyDAO = false</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // If we&apos;re seemingly on the same chain, disable the drop timer</span><br><span class="line">            if verifyDAO &#123;</span><br><span class="line">                p.Log().Debug(&quot;Seems to be on the same side of the DAO fork&quot;)</span><br><span class="line">                p.forkDrop.Stop()</span><br><span class="line">                p.forkDrop = nil</span><br><span class="line">                return nil</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // Filter out any explicitly requested headers, deliver the rest to the downloader</span><br><span class="line">        filter := len(headers) == 1</span><br><span class="line">        if filter &#123;</span><br><span class="line">            // If it&apos;s a potential DAO fork check, validate against the rules</span><br><span class="line">            if p.forkDrop != nil &amp;&amp; pm.chainconfig.DAOForkBlock.Cmp(headers[0].Number) == 0 &#123;</span><br><span class="line">                // Disable the fork drop timer</span><br><span class="line">                p.forkDrop.Stop()</span><br><span class="line">                p.forkDrop = nil</span><br><span class="line"></span><br><span class="line">                // Validate the header and either drop the peer or continue</span><br><span class="line">                if err := misc.VerifyDAOHeaderExtraData(pm.chainconfig, headers[0]); err != nil &#123;</span><br><span class="line">                    p.Log().Debug(&quot;Verified to be on the other side of the DAO fork, dropping&quot;)</span><br><span class="line">                    return err</span><br><span class="line">                &#125;</span><br><span class="line">                p.Log().Debug(&quot;Verified to be on the same side of the DAO fork&quot;)</span><br><span class="line">                return nil</span><br><span class="line">            &#125;</span><br><span class="line">            // Irrelevant of the fork checks, send the header to the fetcher just in case</span><br><span class="line">            headers = pm.fetcher.FilterHeaders(p.id, headers, time.Now())</span><br><span class="line">        &#125;</span><br><span class="line">        if len(headers) &gt; 0 || !filter &#123;</span><br><span class="line">            err := pm.downloader.DeliverHeaders(p.id, headers)</span><br><span class="line">            if err != nil &#123;</span><br><span class="line">                log.Debug(&quot;Failed to deliver headers&quot;, &quot;err&quot;, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æ˜¯ç¡¬åˆ†å‰çš„daoHeaderï¼ŒåŒæ—¶len(headers) == 1ï¼Œåˆ™æ‰§è¡Œpm.fetcher.FilterHeaders(p.id, headers, time.Now())æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func (f *Fetcher) FilterHeaders(peer string, headers []*types.Header, time time.Time) []*types.Header &#123;</span><br><span class="line">    log.Trace(&quot;Filtering headers&quot;, &quot;peer&quot;, peer, &quot;headers&quot;, len(headers))</span><br><span class="line"></span><br><span class="line">    // Send the filter channel to the fetcher</span><br><span class="line">    filter := make(chan *headerFilterTask)</span><br><span class="line"></span><br><span class="line">    select &#123;</span><br><span class="line">    case f.headerFilter &lt;- filter:</span><br><span class="line">    case &lt;-f.quit:</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">    // Request the filtering of the header list</span><br><span class="line">    select &#123;</span><br><span class="line">    case filter &lt;- &amp;headerFilterTask&#123;peer: peer, headers: headers, time: time&#125;:</span><br><span class="line">    case &lt;-f.quit:</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">    // Retrieve the headers remaining after filtering</span><br><span class="line">    select &#123;</span><br><span class="line">    case task := &lt;-filter:</span><br><span class="line">        return task.headers</span><br><span class="line">    case &lt;-f.quit:</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>send ä¸€ä¸ªfilter åˆ°f.headerFilterï¼Œfetcherçš„loop()ä¸»å›è·¯é‡Œf.headerFilter receive åˆ°è¿™ä¸ªfilterï¼Œè¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">case filter := &lt;-f.headerFilter:</span><br><span class="line">            // Headers arrived from a remote peer. Extract those that were explicitly</span><br><span class="line">            // requested by the fetcher, and return everything else so it&apos;s delivered</span><br><span class="line">            // to other parts of the system.</span><br><span class="line">            var task *headerFilterTask</span><br><span class="line">            select &#123;</span><br><span class="line">            case task = &lt;-filter:</span><br><span class="line">            case &lt;-f.quit:</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            headerFilterInMeter.Mark(int64(len(task.headers)))</span><br><span class="line"></span><br><span class="line">            // Split the batch of headers into unknown ones (to return to the caller),</span><br><span class="line">            // known incomplete ones (requiring body retrievals) and completed blocks.</span><br><span class="line">            unknown, incomplete, complete := []*types.Header&#123;&#125;, []*announce&#123;&#125;, []*types.Block&#123;&#125;</span><br><span class="line">            for _, header := range task.headers &#123;</span><br><span class="line">                hash := header.Hash()</span><br><span class="line"></span><br><span class="line">                // Filter fetcher-requested headers from other synchronisation algorithms</span><br><span class="line">                if announce := f.fetching[hash]; announce != nil &amp;&amp; announce.origin == task.peer &amp;&amp; f.fetched[hash] == nil &amp;&amp; f.completing[hash] == nil &amp;&amp; f.queued[hash] == nil &#123;</span><br><span class="line">                    // If the delivered header does not match the promised number, drop the announcer</span><br><span class="line">                    if header.Number.Uint64() != announce.number &#123;</span><br><span class="line">                        log.Trace(&quot;Invalid block number fetched&quot;, &quot;peer&quot;, announce.origin, &quot;hash&quot;, header.Hash(), &quot;announced&quot;, announce.number, &quot;provided&quot;, header.Number)</span><br><span class="line">                        f.dropPeer(announce.origin)</span><br><span class="line">                        f.forgetHash(hash)</span><br><span class="line">                        continue</span><br><span class="line">                    &#125;</span><br><span class="line">                    // Only keep if not imported by other means</span><br><span class="line">                    if f.getBlock(hash) == nil &#123;</span><br><span class="line">                        announce.header = header</span><br><span class="line">                        announce.time = task.time</span><br><span class="line"></span><br><span class="line">                        // If the block is empty (header only), short circuit into the final import queue</span><br><span class="line">                        if header.TxHash == types.DeriveSha(types.Transactions&#123;&#125;) &amp;&amp; header.UncleHash == types.CalcUncleHash([]*types.Header&#123;&#125;) &#123;</span><br><span class="line">                            log.Trace(&quot;Block empty, skipping body retrieval&quot;, &quot;peer&quot;, announce.origin, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())</span><br><span class="line"></span><br><span class="line">                            block := types.NewBlockWithHeader(header)</span><br><span class="line">                            block.ReceivedAt = task.time</span><br><span class="line"></span><br><span class="line">                            complete = append(complete, block)</span><br><span class="line">                            f.completing[hash] = announce</span><br><span class="line">                            continue</span><br><span class="line">                        &#125;</span><br><span class="line">                        // Otherwise add to the list of blocks needing completion</span><br><span class="line">                        incomplete = append(incomplete, announce)</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        log.Trace(&quot;Block already imported, discarding header&quot;, &quot;peer&quot;, announce.origin, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())</span><br><span class="line">                        f.forgetHash(hash)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Fetcher doesn&apos;t know about it, add to the return list</span><br><span class="line">                    unknown = append(unknown, header)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            headerFilterOutMeter.Mark(int64(len(unknown)))</span><br><span class="line">            select &#123;</span><br><span class="line">            case filter &lt;- &amp;headerFilterTask&#123;headers: unknown, time: task.time&#125;:</span><br><span class="line">            case &lt;-f.quit:</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            // Schedule the retrieved headers for body completion</span><br><span class="line">            for _, announce := range incomplete &#123;</span><br><span class="line">                hash := announce.header.Hash()</span><br><span class="line">                if _, ok := f.completing[hash]; ok &#123;</span><br><span class="line">                    continue</span><br><span class="line">                &#125;</span><br><span class="line">                f.fetched[hash] = append(f.fetched[hash], announce)</span><br><span class="line">                if len(f.fetched) == 1 &#123;</span><br><span class="line">                    f.rescheduleComplete(completeTimer)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Schedule the header-only blocks for import</span><br><span class="line">            for _, block := range complete &#123;</span><br><span class="line">                if announce := f.completing[block.Hash()]; announce != nil &#123;</span><br><span class="line">                    f.enqueue(announce.origin, block)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>1ï¼Œéå†headerFilteré‡Œé¢çš„å„ä¸ªheaderï¼Œå¦‚æœåœ¨ f.fetchingçŠ¶æ€åˆ—è¡¨ï¼Œä¸”ä¸åœ¨f.fetchedçŠ¶æ€åˆ—è¡¨å’Œ f.completingçŠ¶æ€åˆ—è¡¨ï¼Œå°±ç»§ç»­è¿›è¡Œè¿‡æ»¤ï¼Œå¦åˆ™å¡è¿›unknowné˜Ÿåˆ— å‘é€ç»™filterï¼ŒFilterHeadersé‡Œé¢task æ¥æ”¶åˆ°filterï¼Œå¹¶ä½œä¸ºFilterHeadersçš„è¿”å›å€¼è¿”å›ã€‚<br>2ï¼Œå¦‚æœå‘ç°è¿™ä¸ªheaderçš„numberå’Œä»f.fetchingçŠ¶æ€åˆ—è¡¨å–åˆ°çš„announceçš„numberä¸ä¸€æ ·ï¼Œè¯´æ˜æœ‰å¯èƒ½æ”¶åˆ°ä¸€ä¸ªä¼ªé€ çš„åŒºå—é€šçŸ¥ï¼Œæ­¤æ—¶å°±è¦æŠŠè¿™ä¸ªå¯èƒ½çš„ä¼ªé€ èŠ‚ç‚¹å’Œå¯èƒ½çš„ä¼ªé€ çš„hashæŠ›å¼ƒï¼Œå¦å¯é”™æ€ï¼Œä¸èƒ½æ”¾è¿‡ã€‚<br>3ï¼Œå¦‚æœæœ¬èŠ‚ç‚¹å·²ç»æœ‰è¿™ä¸ªhashçš„blockï¼Œåˆ™æ”¾å¼ƒè¿™ä¸ªhashã€‚å¦‚æœè¿™ä¸ªblocké‡Œé¢æ²¡æœ‰ä»»ä½•äº¤æ˜“ä¹Ÿæ²¡æœ‰ä»»ä½•å”åŒºå—ï¼Œåˆ™æŠŠè¿™ä¸ªhashæ”¾å…¥completeåˆ—è¡¨åŒæ—¶åŠ å…¥f.completingçŠ¶æ€åˆ—è¡¨ï¼Œå¦åˆ™æ”¾å…¥incompleteåˆ—è¡¨ã€‚<br>4ï¼Œåœ¨incompleteåˆ—è¡¨é‡Œé¢ï¼Œä¸”ä¸åœ¨f.completingçŠ¶æ€åˆ—è¡¨é‡Œï¼Œåˆ™åŠ å…¥f.fetchedçŠ¶æ€åˆ—è¡¨ï¼Œå¯åŠ¨completeTimerçš„è°ƒåº¦ã€‚<br>5ï¼Œåœ¨completeåˆ—è¡¨é‡Œé¢ï¼ŒåŒæ—¶ä¹Ÿåœ¨f.completingçŠ¶æ€åˆ—è¡¨ï¼Œåˆ™è°ƒç”¨f.enqueue(announce.origin, block)æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">case &lt;-completeTimer.C:</span><br><span class="line">            // At least one header&apos;s timer ran out, retrieve everything</span><br><span class="line">            request := make(map[string][]common.Hash)</span><br><span class="line"></span><br><span class="line">            for hash, announces := range f.fetched &#123;</span><br><span class="line">                // Pick a random peer to retrieve from, reset all others</span><br><span class="line">                announce := announces[rand.Intn(len(announces))]</span><br><span class="line">                f.forgetHash(hash)</span><br><span class="line"></span><br><span class="line">                // If the block still didn&apos;t arrive, queue for completion</span><br><span class="line">                if f.getBlock(hash) == nil &#123;</span><br><span class="line">                    request[announce.origin] = append(request[announce.origin], hash)</span><br><span class="line">                    f.completing[hash] = announce</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Send out all block body requests</span><br><span class="line">            for peer, hashes := range request &#123;</span><br><span class="line">                log.Trace(&quot;Fetching scheduled bodies&quot;, &quot;peer&quot;, peer, &quot;list&quot;, hashes)</span><br><span class="line"></span><br><span class="line">                // Create a closure of the fetch and schedule in on a new thread</span><br><span class="line">                if f.completingHook != nil &#123;</span><br><span class="line">                    f.completingHook(hashes)</span><br><span class="line">                &#125;</span><br><span class="line">                bodyFetchMeter.Mark(int64(len(hashes)))</span><br><span class="line">                go f.completing[hashes[0]].fetchBodies(hashes)</span><br><span class="line">            &#125;</span><br><span class="line">            // Schedule the next fetch if blocks are still pending</span><br><span class="line">            f.rescheduleComplete(completeTimer)</span><br></pre></td></tr></table></figure><p>1ï¼Œé¦–å…ˆéå†f.fetchedï¼Œhashå¯¹åº”åœ¨fetcheré‡Œé¢çš„çŠ¶æ€éƒ½æ¸…äº†ã€‚<br>å¦‚æœå‘ç°è¶…æ—¶äº†è¿˜æ²¡æœ‰æ²¡æœ‰è·å–åˆ°è¿™ä¸ªhashçš„blockï¼Œåˆ™æŠŠè¿™ä¸ªannounceåŠ åˆ°requeståˆ—è¡¨ä¸­ï¼ŒåŒæ—¶é‡æ–°æŠŠannounceæ”¾åˆ°f.completingçŠ¶æ€åˆ—è¡¨ã€‚<br>2ï¼Œç„¶åéå†requeståˆ—è¡¨ï¼Œrequeståˆ—è¡¨é‡Œé¢çš„æ¯ä¸ªç½‘ç»œèŠ‚ç‚¹è¿‡æ¥çš„æ‰€æœ‰çš„blockçš„hashï¼Œéƒ½ä¼šè°ƒç”¨fetchBodies(hashes)æ–¹æ³•æ¥è·å–åŒºå—bodyæ•°æ®ã€‚è¿™ä¸ªfetchBodies(hashes)æ–¹æ³•æ˜¯peer.goé‡Œé¢çš„ä¸€ä¸ªå…¨å±€æ–¹æ³•ã€‚<br>3ï¼Œ è¿™æ—¶å€™BlockHashesMsg çš„fetcherå¤„ç†å°±ç»“æŸäº†ï¼Œæœ€åå†å¯åŠ¨completeTimerå¾ªç¯è°ƒåº¦ã€‚</p><p>å››ï¼ŒFetcheråˆ†æï¼Œ ä¹‹FilterBodies() ï¼ŒEnqueue(ï¼‰ï¼Œ<br>1ï¼ŒfetchBodies(hash)æ–¹æ³•ï¼Œè°ƒç”¨äº†peer.go é‡Œé¢çš„å…¨å±€æ–¹æ³•RequestBodies(hashes []common.Hash) Sendç»™ç½‘ç»œèŠ‚ç‚¹ä¸€ä¸ªGetBlockBodiesMsg æ¶ˆæ¯ã€‚<br>2ï¼Œç„¶åpm.handleMsg ä¼šæ”¶åˆ° BlockBodiesMsgå¹¿æ’­é€šçŸ¥ã€‚<br>3ï¼Œæ‰§è¡Œ pm.fetcher.FilterBodies(p.id, trasactions, uncles, time.Now())ã€‚<br>æ¥ä¸‹æ¥å°±å’ŒFilterHeaders()æµç¨‹ç±»ä¼¼ï¼Œä¸€é¡¿å•ªå•ªå•ªéªŒè¯ï¼Œä¸€é¡¿å•ªå•ªå•ªæ”¹å˜çŠ¶æ€ï¼Œä¸€é¡¿å•ªå•ªå•ªé€šé“è·³è½¬<br>4ï¼Œåº†å¹¸çš„æ˜¯ï¼Œèµ°å®ŒFilterBodies()å°±å®Œäº‹äº†ï¼Œä¸ç”¨åœ¨èµ°timerè°ƒåº¦ï¼Œä¹Ÿä¸ç”¨å†å‘ç½‘ç»œè¯·æ±‚äº†ã€‚<br>5ï¼Œåœ¨FilterHeaders()å’ŒFilterBodies()æœ€åéƒ½èµ°åˆ°äº†f.enqueue(announce.origin, block)æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">func (f *Fetcher) enqueue(peer string, block *types.Block) &#123;</span><br><span class="line">    hash := block.Hash()</span><br><span class="line"></span><br><span class="line">    // Ensure the peer isn&apos;t DOSing us</span><br><span class="line">    count := f.queues[peer] + 1</span><br><span class="line">    if count &gt; blockLimit &#123;</span><br><span class="line">        log.Debug(&quot;Discarded propagated block, exceeded allowance&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;limit&quot;, blockLimit)</span><br><span class="line">        propBroadcastDOSMeter.Mark(1)</span><br><span class="line">        f.forgetHash(hash)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // Discard any past or too distant blocks</span><br><span class="line">    if dist := int64(block.NumberU64()) - int64(f.chainHeight()); dist &lt; -maxUncleDist || dist &gt; maxQueueDist &#123;</span><br><span class="line">        log.Debug(&quot;Discarded propagated block, too far away&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;distance&quot;, dist)</span><br><span class="line">        propBroadcastDropMeter.Mark(1)</span><br><span class="line">        f.forgetHash(hash)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // Schedule the block for future importing</span><br><span class="line">    if _, ok := f.queued[hash]; !ok &#123;</span><br><span class="line">        op := &amp;inject&#123;</span><br><span class="line">            origin: peer,</span><br><span class="line">            block:  block,</span><br><span class="line">        &#125;</span><br><span class="line">        f.queues[peer] = count</span><br><span class="line">        f.queued[hash] = op</span><br><span class="line">        f.queue.Push(op, -float32(block.NumberU64()))</span><br><span class="line">        if f.queueChangeHook != nil &#123;</span><br><span class="line">            f.queueChangeHook(op.block.Hash(), true)</span><br><span class="line">        &#125;</span><br><span class="line">        log.Debug(&quot;Queued propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;queued&quot;, f.queue.Size())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤æ‰å¤ªè¿œçš„åŒºå—ã€‚å¹¶æŠŠhashåŠ å…¥åˆ°f.queueåˆ—è¡¨ä¸­ã€‚<br>åœ¨loopä¸»å›è·¯é‡Œé¢éå†f.queueåˆ—è¡¨ï¼Œå¹¶æŠŠåˆ—è¡¨ä¸­çš„block insertåˆ°æœ¬åœ°çš„block chainä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">func (f *Fetcher) insert(peer string, block *types.Block) &#123;</span><br><span class="line">    hash := block.Hash()</span><br><span class="line"></span><br><span class="line">    // Run the import on a new thread</span><br><span class="line">    log.Debug(&quot;Importing propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        defer func() &#123; f.done &lt;- hash &#125;()</span><br><span class="line"></span><br><span class="line">        // If the parent&apos;s unknown, abort insertion</span><br><span class="line">        parent := f.getBlock(block.ParentHash())</span><br><span class="line">        if parent == nil &#123;</span><br><span class="line">            log.Debug(&quot;Unknown parent of propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;parent&quot;, block.ParentHash())</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        // Quickly validate the header and propagate the block if it passes</span><br><span class="line">        switch err := f.verifyHeader(block.Header()); err &#123;</span><br><span class="line">        case nil:</span><br><span class="line">            // All ok, quickly propagate to our peers</span><br><span class="line">            propBroadcastOutTimer.UpdateSince(block.ReceivedAt)</span><br><span class="line">            go f.broadcastBlock(block, true)</span><br><span class="line"></span><br><span class="line">        case consensus.ErrFutureBlock:</span><br><span class="line">            // Weird future block, don&apos;t fail, but neither propagate</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            // Something went very wrong, drop the peer</span><br><span class="line">            log.Debug(&quot;Propagated block verification failed&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;err&quot;, err)</span><br><span class="line">            f.dropPeer(peer)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        // Run the actual import and log any issues</span><br><span class="line">        if _, err := f.insertChain(types.Blocks&#123;block&#125;); err != nil &#123;</span><br><span class="line">            log.Debug(&quot;Propagated block import failed&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;err&quot;, err)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        // If import succeeded, broadcast the block</span><br><span class="line">        propAnnounceOutTimer.UpdateSince(block.ReceivedAt)</span><br><span class="line">        go f.broadcastBlock(block, false)</span><br><span class="line"></span><br><span class="line">        // Invoke the testing hook if needed</span><br><span class="line">        if f.importedHook != nil &#123;</span><br><span class="line">            f.importedHook(block)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨å…±è¯†å¼•æ“çš„æ–¹æ³•f.verifyHeader(block.Header())ï¼ŒéªŒè¯blockHeaderçš„æœ‰æ•ˆæ€§ã€‚<br>å¦‚æœæ²¡é—®é¢˜å°±å¹¿æ’­å‡ºå»ï¼Œå‘Šè¯‰å…¨ä¸–ç•Œæˆ‘çš„åŒºå—é“¾æ›´æ–°äº†ä¸€ä¸ªæ–°åŒºå—ã€‚<br>ç„¶åè°ƒç”¨f.insertChain(types.Blocks{block}) æ’å…¥æœ¬åœ°åŒºå—é“¾ã€‚<br>æ’å…¥æˆåŠŸï¼Œæœ€åå†å¹¿æ’­ä¸€æ¬¡(è¿™æ˜¯å¤šä¹ˆçš„è‡ªæ‹å•Š)ï¼Œè¿™æ¬¡åªå¹¿æ’­blockçš„hashã€‚</p><p>æ€»ç»“<br>fetcher.go ä½œä¸ºä»¥å¤ªåŠåŒæ­¥åŒºå—çš„ä¸€ä¸ªè¾…åŠ©ç±»ï¼Œå®ƒçš„èŒè´£å°±æ˜¯å±‚å±‚æŠŠå…³ï¼Œå±‚å±‚è¿‡æ»¤ï¼ŒæŠµåˆ¶æ— æ•ˆçš„åŒºå—è¿›å…¥ï¼Œæœç»æ— ç”¨çš„åŒæ­¥è¯·æ±‚ã€‚è¿™å—ä»£ç å¾ˆå¤šå¾ˆä¹±ï¼Œç¬¬ä¸€æ¬¡çœ‹å¯èƒ½ä¼šæœ‰ç‚¹æ™•ï¼Œç¬¬äºŒæ¬¡çœ‹å¯èƒ½è¿˜æ˜¯å¾ˆæ™•ï¼Œå¤šçœ‹å‡ æ¬¡å¯èƒ½è¿˜ä¼šæ™•ğŸ˜„ï¼Œä¸è¿‡åªè¦çŸ¥é“å®ƒåšä»€ä¹ˆå°±å¥½äº†ã€‚</p><h4 id="Downloader"><a href="#Downloader" class="headerlink" title="Downloader"></a>Downloader</h4><p>ä¸€ï¼Œå¯åŠ¨Downloader<br>ProtocolManageråˆå§‹åŒ–çš„æ—¶å€™ä¼šè¿›è¡ŒDownloaderçš„åˆå§‹åŒ–ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">func New(mode SyncMode, stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn) *Downloader &#123;</span><br><span class="line">    if lightchain == nil &#123;</span><br><span class="line">        lightchain = chain</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dl := &amp;Downloader&#123;</span><br><span class="line">        mode:           mode,</span><br><span class="line">        stateDB:        stateDb,</span><br><span class="line">        mux:            mux,</span><br><span class="line">        queue:          newQueue(),</span><br><span class="line">        peers:          newPeerSet(),</span><br><span class="line">        rttEstimate:    uint64(rttMaxEstimate),</span><br><span class="line">        rttConfidence:  uint64(1000000),</span><br><span class="line">        blockchain:     chain,</span><br><span class="line">        lightchain:     lightchain,</span><br><span class="line">        dropPeer:       dropPeer,</span><br><span class="line">        headerCh:       make(chan dataPack, 1),</span><br><span class="line">        bodyCh:         make(chan dataPack, 1),</span><br><span class="line">        receiptCh:      make(chan dataPack, 1),</span><br><span class="line">        bodyWakeCh:     make(chan bool, 1),</span><br><span class="line">        receiptWakeCh:  make(chan bool, 1),</span><br><span class="line">        headerProcCh:   make(chan []*types.Header, 1),</span><br><span class="line">        quitCh:         make(chan struct&#123;&#125;),</span><br><span class="line">        stateCh:        make(chan dataPack),</span><br><span class="line">        stateSyncStart: make(chan *stateSync),</span><br><span class="line">        trackStateReq:  make(chan *stateReq),</span><br><span class="line">    &#125;</span><br><span class="line">    go dl.qosTuner()</span><br><span class="line">    go dl.stateFetcher()</span><br><span class="line">    return dl</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆå§‹åŒ–Downloaderå¯¹è±¡çš„æˆå‘˜ï¼Œç„¶åå¯åŠ¨dl.qosTuner() goroutineè®¡ç®—è¯·æ±‚å›è·¯æ—¶é—´ï¼Œå¯åŠ¨dl.stateFetcher() goroutine å¼€å¯DownloaderçŠ¶æ€ç›‘æ§ã€‚</p><p>ProtocolManageræ”¶åˆ°æ–°çš„åŒºå—æ¶ˆæ¯å¹¿æ’­æˆ–è€…æœ‰æ–°çš„P2Pç½‘ç»œèŠ‚ç‚¹åŠ å…¥çš„æ—¶å€™ä¼šè°ƒç”¨ProtocolManagerçš„ synchronise(peer *peer)æ–¹æ³•ï¼Œè¿™æ—¶å€™ä¼šè°ƒç”¨Downloaderçš„Synchronise(peer.id, pHead, pTd, mode)æ–¹æ³•ã€‚</p><p>Synchroniseæ–¹æ³•ï¼Œé‡ç½®d.queueå’Œd.peersï¼Œæ¸…ç©ºd.bodyWakeCh, d.receiptWakeChï¼Œd.headerCh, d.bodyCh, d.receiptChï¼Œd.headerProcChã€‚è°ƒç”¨d.syncWithPeer(p, hash, td)æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) syncWithPeer(p *peerConnection, hash common.Hash, td *big.Int) (err error) &#123;</span><br><span class="line">    d.mux.Post(StartEvent&#123;&#125;)</span><br><span class="line">    defer func() &#123;</span><br><span class="line">        // reset on error</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            d.mux.Post(FailedEvent&#123;err&#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            d.mux.Post(DoneEvent&#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    if p.version &lt; 62 &#123;</span><br><span class="line">        return errTooOld</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Debug(&quot;Synchronising with the network&quot;, &quot;peer&quot;, p.id, &quot;eth&quot;, p.version, &quot;head&quot;, hash, &quot;td&quot;, td, &quot;mode&quot;, d.mode)</span><br><span class="line">    defer func(start time.Time) &#123;</span><br><span class="line">        log.Debug(&quot;Synchronisation terminated&quot;, &quot;elapsed&quot;, time.Since(start))</span><br><span class="line">    &#125;(time.Now())</span><br><span class="line"></span><br><span class="line">    // Look up the sync boundaries: the common ancestor and the target block</span><br><span class="line">    latest, err := d.fetchHeight(p)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    height := latest.Number.Uint64()</span><br><span class="line"></span><br><span class="line">    origin, err := d.findAncestor(p, height)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    d.syncStatsLock.Lock()</span><br><span class="line">    if d.syncStatsChainHeight &lt;= origin || d.syncStatsChainOrigin &gt; origin &#123;</span><br><span class="line">        d.syncStatsChainOrigin = origin</span><br><span class="line">    &#125;</span><br><span class="line">    d.syncStatsChainHeight = height</span><br><span class="line">    d.syncStatsLock.Unlock()</span><br><span class="line"></span><br><span class="line">    // Ensure our origin point is below any fast sync pivot point</span><br><span class="line">    pivot := uint64(0)</span><br><span class="line">    if d.mode == FastSync &#123;</span><br><span class="line">        if height &lt;= uint64(fsMinFullBlocks) &#123;</span><br><span class="line">            origin = 0</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            pivot = height - uint64(fsMinFullBlocks)</span><br><span class="line">            if pivot &lt;= origin &#123;</span><br><span class="line">                origin = pivot - 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    d.committed = 1</span><br><span class="line">    if d.mode == FastSync &amp;&amp; pivot != 0 &#123;</span><br><span class="line">        d.committed = 0</span><br><span class="line">    &#125;</span><br><span class="line">    // Initiate the sync using a concurrent header and content retrieval algorithm</span><br><span class="line">    d.queue.Prepare(origin+1, d.mode)</span><br><span class="line">    if d.syncInitHook != nil &#123;</span><br><span class="line">        d.syncInitHook(origin, height)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fetchers := []func() error&#123;</span><br><span class="line">        func() error &#123; return d.fetchHeaders(p, origin+1, pivot) &#125;, // Headers are always retrieved</span><br><span class="line">        func() error &#123; return d.fetchBodies(origin + 1) &#125;,          // Bodies are retrieved during normal and fast sync</span><br><span class="line">        func() error &#123; return d.fetchReceipts(origin + 1) &#125;,        // Receipts are retrieved during fast sync</span><br><span class="line">        func() error &#123; return d.processHeaders(origin+1, pivot, td) &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    if d.mode == FastSync &#123;</span><br><span class="line">        fetchers = append(fetchers, func() error &#123; return d.processFastSyncContent(latest) &#125;)</span><br><span class="line">    &#125; else if d.mode == FullSync &#123;</span><br><span class="line">        fetchers = append(fetchers, d.processFullSyncContent)</span><br><span class="line">    &#125;</span><br><span class="line">    return d.spawnSync(fetchers)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨latest, err := d.fetchHeight(p)è·å–åˆ°peerèŠ‚ç‚¹æœ€æ–°çš„åŒºå—å¤´,è¿™ä¸ªæ–¹æ³•æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) fetchHeight(p *peerConnection) (*types.Header, error) &#123;</span><br><span class="line">    p.log.Debug(&quot;Retrieving remote chain height&quot;)</span><br><span class="line"></span><br><span class="line">    // Request the advertised remote head block and wait for the response</span><br><span class="line">    head, _ := p.peer.Head()</span><br><span class="line">    go p.peer.RequestHeadersByHash(head, 1, 0, false)</span><br><span class="line"></span><br><span class="line">    ttl := d.requestTTL()</span><br><span class="line">    timeout := time.After(ttl)</span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-d.cancelCh:</span><br><span class="line">            return nil, errCancelBlockFetch</span><br><span class="line"></span><br><span class="line">        case packet := &lt;-d.headerCh:</span><br><span class="line">            // Discard anything not from the origin peer</span><br><span class="line">            if packet.PeerId() != p.id &#123;</span><br><span class="line">                log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            // Make sure the peer actually gave something valid</span><br><span class="line">            headers := packet.(*headerPack).headers</span><br><span class="line">            if len(headers) != 1 &#123;</span><br><span class="line">                p.log.Debug(&quot;Multiple headers for single request&quot;, &quot;headers&quot;, len(headers))</span><br><span class="line">                return nil, errBadPeer</span><br><span class="line">            &#125;</span><br><span class="line">            head := headers[0]</span><br><span class="line">            p.log.Debug(&quot;Remote head header identified&quot;, &quot;number&quot;, head.Number, &quot;hash&quot;, head.Hash())</span><br><span class="line">            return head, nil</span><br><span class="line"></span><br><span class="line">        case &lt;-timeout:</span><br><span class="line">            p.log.Debug(&quot;Waiting for head header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class="line">            return nil, errTimeout</span><br><span class="line"></span><br><span class="line">        case &lt;-d.bodyCh:</span><br><span class="line">        case &lt;-d.receiptCh:</span><br><span class="line">            // Out of bounds delivery, ignore</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ï¼Œè°ƒç”¨peer.RequestHeadersByHash(head, 1, 0, false)ï¼Œç»™ç½‘ç»œèŠ‚ç‚¹å‘é€ä¸€ä¸ªGetBlockHeadersMsgçš„æ¶ˆæ¯<br>2ï¼Œç„¶åé˜»å¡ä½çº¿ç¨‹ï¼Œç›´åˆ°æ”¶åˆ°d.headerChæˆ–è€…timeout<br>3ï¼Œæœ¬åœ°èŠ‚ç‚¹ä¼šæ”¶åˆ°ç½‘ç»œèŠ‚ç‚¹çš„BlockHeadersMsgçš„æ¶ˆæ¯è¿”å›<br>4ï¼Œè°ƒç”¨downloader.DeliverHeaders(p.id, headers)<br>5ï¼Œè¿™æ—¶å€™ä¼šæŠŠp.idå’Œheadersæ‰“åŒ…å‘é€ç»™d.headerCh<br>6ï¼Œè¿™æ—¶å€™selectæ”¶åˆ°d.headerChï¼Œé˜»å¡æ‰“å¼€ï¼Œå¹¶è¿”å›headerå†…å®¹</p><p>syncWithPeer() æ–¹æ³•æ¥ç€è°ƒç”¨ d.findAncestor(p, height)æ¥è·å–æœ¬åœ°èŠ‚ç‚¹å’Œç½‘ç»œèŠ‚ç‚¹å…±åŒçš„ç¥–å…ˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) findAncestor(p *peerConnection, height uint64) (uint64, error) &#123;</span><br><span class="line">    // Figure out the valid ancestor range to prevent rewrite attacks</span><br><span class="line">    floor, ceil := int64(-1), d.lightchain.CurrentHeader().Number.Uint64()</span><br><span class="line"></span><br><span class="line">    if d.mode == FullSync &#123;</span><br><span class="line">        ceil = d.blockchain.CurrentBlock().NumberU64()</span><br><span class="line">    &#125; else if d.mode == FastSync &#123;</span><br><span class="line">        ceil = d.blockchain.CurrentFastBlock().NumberU64()</span><br><span class="line">    &#125;</span><br><span class="line">    if ceil &gt;= MaxForkAncestry &#123;</span><br><span class="line">        floor = int64(ceil - MaxForkAncestry)</span><br><span class="line">    &#125;</span><br><span class="line">    p.log.Debug(&quot;Looking for common ancestor&quot;, &quot;local&quot;, ceil, &quot;remote&quot;, height)</span><br><span class="line"></span><br><span class="line">    // Request the topmost blocks to short circuit binary ancestor lookup</span><br><span class="line">    head := ceil</span><br><span class="line">    if head &gt; height &#123;</span><br><span class="line">        head = height</span><br><span class="line">    &#125;</span><br><span class="line">    from := int64(head) - int64(MaxHeaderFetch)</span><br><span class="line">    if from &lt; 0 &#123;</span><br><span class="line">        from = 0</span><br><span class="line">    &#125;</span><br><span class="line">    // Span out with 15 block gaps into the future to catch bad head reports</span><br><span class="line">    limit := 2 * MaxHeaderFetch / 16</span><br><span class="line">    count := 1 + int((int64(ceil)-from)/16)</span><br><span class="line">    if count &gt; limit &#123;</span><br><span class="line">        count = limit</span><br><span class="line">    &#125;</span><br><span class="line">    go p.peer.RequestHeadersByNumber(uint64(from), count, 15, false)</span><br><span class="line"></span><br><span class="line">    // Wait for the remote response to the head fetch</span><br><span class="line">    number, hash := uint64(0), common.Hash&#123;&#125;</span><br><span class="line"></span><br><span class="line">    ttl := d.requestTTL()</span><br><span class="line">    timeout := time.After(ttl)</span><br><span class="line"></span><br><span class="line">    for finished := false; !finished; &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-d.cancelCh:</span><br><span class="line">            return 0, errCancelHeaderFetch</span><br><span class="line"></span><br><span class="line">        case packet := &lt;-d.headerCh:</span><br><span class="line">            // Discard anything not from the origin peer</span><br><span class="line">            if packet.PeerId() != p.id &#123;</span><br><span class="line">                log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            // Make sure the peer actually gave something valid</span><br><span class="line">            headers := packet.(*headerPack).headers</span><br><span class="line">            if len(headers) == 0 &#123;</span><br><span class="line">                p.log.Warn(&quot;Empty head header set&quot;)</span><br><span class="line">                return 0, errEmptyHeaderSet</span><br><span class="line">            &#125;</span><br><span class="line">            // Make sure the peer&apos;s reply conforms to the request</span><br><span class="line">            for i := 0; i &lt; len(headers); i++ &#123;</span><br><span class="line">                if number := headers[i].Number.Int64(); number != from+int64(i)*16 &#123;</span><br><span class="line">                    p.log.Warn(&quot;Head headers broke chain ordering&quot;, &quot;index&quot;, i, &quot;requested&quot;, from+int64(i)*16, &quot;received&quot;, number)</span><br><span class="line">                    return 0, errInvalidChain</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Check if a common ancestor was found</span><br><span class="line">            finished = true</span><br><span class="line">            for i := len(headers) - 1; i &gt;= 0; i-- &#123;</span><br><span class="line">                // Skip any headers that underflow/overflow our requested set</span><br><span class="line">                if headers[i].Number.Int64() &lt; from || headers[i].Number.Uint64() &gt; ceil &#123;</span><br><span class="line">                    continue</span><br><span class="line">                &#125;</span><br><span class="line">                // Otherwise check if we already know the header or not</span><br><span class="line">                if (d.mode == FullSync &amp;&amp; d.blockchain.HasBlock(headers[i].Hash(), headers[i].Number.Uint64())) || (d.mode != FullSync &amp;&amp; d.lightchain.HasHeader(headers[i].Hash(), headers[i].Number.Uint64())) &#123;</span><br><span class="line">                    number, hash = headers[i].Number.Uint64(), headers[i].Hash()</span><br><span class="line"></span><br><span class="line">                    // If every header is known, even future ones, the peer straight out lied about its head</span><br><span class="line">                    if number &gt; height &amp;&amp; i == limit-1 &#123;</span><br><span class="line">                        p.log.Warn(&quot;Lied about chain head&quot;, &quot;reported&quot;, height, &quot;found&quot;, number)</span><br><span class="line">                        return 0, errStallingPeer</span><br><span class="line">                    &#125;</span><br><span class="line">                    break</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        case &lt;-timeout:</span><br><span class="line">            p.log.Debug(&quot;Waiting for head header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class="line">            return 0, errTimeout</span><br><span class="line"></span><br><span class="line">        case &lt;-d.bodyCh:</span><br><span class="line">        case &lt;-d.receiptCh:</span><br><span class="line">            // Out of bounds delivery, ignore</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // If the head fetch already found an ancestor, return</span><br><span class="line">    if !common.EmptyHash(hash) &#123;</span><br><span class="line">        if int64(number) &lt;= floor &#123;</span><br><span class="line">            p.log.Warn(&quot;Ancestor below allowance&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash, &quot;allowance&quot;, floor)</span><br><span class="line">            return 0, errInvalidAncestor</span><br><span class="line">        &#125;</span><br><span class="line">        p.log.Debug(&quot;Found common ancestor&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash)</span><br><span class="line">        return number, nil</span><br><span class="line">    &#125;</span><br><span class="line">    // Ancestor not found, we need to binary search over our chain</span><br><span class="line">    start, end := uint64(0), head</span><br><span class="line">    if floor &gt; 0 &#123;</span><br><span class="line">        start = uint64(floor)</span><br><span class="line">    &#125;</span><br><span class="line">    for start+1 &lt; end &#123;</span><br><span class="line">        // Split our chain interval in two, and request the hash to cross check</span><br><span class="line">        check := (start + end) / 2</span><br><span class="line"></span><br><span class="line">        ttl := d.requestTTL()</span><br><span class="line">        timeout := time.After(ttl)</span><br><span class="line"></span><br><span class="line">        go p.peer.RequestHeadersByNumber(check, 1, 0, false)</span><br><span class="line"></span><br><span class="line">        // Wait until a reply arrives to this request</span><br><span class="line">        for arrived := false; !arrived; &#123;</span><br><span class="line">            select &#123;</span><br><span class="line">            case &lt;-d.cancelCh:</span><br><span class="line">                return 0, errCancelHeaderFetch</span><br><span class="line"></span><br><span class="line">            case packer := &lt;-d.headerCh:</span><br><span class="line">                // Discard anything not from the origin peer</span><br><span class="line">                if packer.PeerId() != p.id &#123;</span><br><span class="line">                    log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packer.PeerId())</span><br><span class="line">                    break</span><br><span class="line">                &#125;</span><br><span class="line">                // Make sure the peer actually gave something valid</span><br><span class="line">                headers := packer.(*headerPack).headers</span><br><span class="line">                if len(headers) != 1 &#123;</span><br><span class="line">                    p.log.Debug(&quot;Multiple headers for single request&quot;, &quot;headers&quot;, len(headers))</span><br><span class="line">                    return 0, errBadPeer</span><br><span class="line">                &#125;</span><br><span class="line">                arrived = true</span><br><span class="line"></span><br><span class="line">                // Modify the search interval based on the response</span><br><span class="line">                if (d.mode == FullSync &amp;&amp; !d.blockchain.HasBlock(headers[0].Hash(), headers[0].Number.Uint64())) || (d.mode != FullSync &amp;&amp; !d.lightchain.HasHeader(headers[0].Hash(), headers[0].Number.Uint64())) &#123;</span><br><span class="line">                    end = check</span><br><span class="line">                    break</span><br><span class="line">                &#125;</span><br><span class="line">                header := d.lightchain.GetHeaderByHash(headers[0].Hash()) // Independent of sync mode, header surely exists</span><br><span class="line">                if header.Number.Uint64() != check &#123;</span><br><span class="line">                    p.log.Debug(&quot;Received non requested header&quot;, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash(), &quot;request&quot;, check)</span><br><span class="line">                    return 0, errBadPeer</span><br><span class="line">                &#125;</span><br><span class="line">                start = check</span><br><span class="line"></span><br><span class="line">            case &lt;-timeout:</span><br><span class="line">                p.log.Debug(&quot;Waiting for search header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class="line">                return 0, errTimeout</span><br><span class="line"></span><br><span class="line">            case &lt;-d.bodyCh:</span><br><span class="line">            case &lt;-d.receiptCh:</span><br><span class="line">                // Out of bounds delivery, ignore</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Ensure valid ancestry and return</span><br><span class="line">    if int64(start) &lt;= floor &#123;</span><br><span class="line">        p.log.Warn(&quot;Ancestor below allowance&quot;, &quot;number&quot;, start, &quot;hash&quot;, hash, &quot;allowance&quot;, floor)</span><br><span class="line">        return 0, errInvalidAncestor</span><br><span class="line">    &#125;</span><br><span class="line">    p.log.Debug(&quot;Found common ancestor&quot;, &quot;number&quot;, start, &quot;hash&quot;, hash)</span><br><span class="line">    return start, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ï¼Œè°ƒç”¨peer.RequestHeadersByNumber(uint64(from), count, 15, false)ï¼Œè·å–headerã€‚è¿™é‡Œä¼ å…¥ countå’Œ 15ï¼ŒæŒ‡ä»æœ¬åœ°æœ€é«˜çš„headerå¾€å‰æ•°192ä¸ªåŒºå—çš„å¤´ï¼Œæ¯16ä¸ªåŒºå—å–ä¸€ä¸ªåŒºå—å¤´ã€‚ä¸ºäº†åé¢selectæ”¶åˆ°d.headerChæ—¶åŠ ä»¥éªŒè¯ã€‚<br>2ï¼Œselectæ”¶åˆ°äº†headersï¼Œéå†headerï¼Œçœ‹æ˜¯å¦åœ¨æœ¬åœ°æ˜¯å¦å­˜åœ¨è¿™ä¸ªheaderï¼Œå¦‚æœæœ‰ï¼Œå¹¶ä¸”ä¸ä¸ºç©ºï¼Œå°±è¯´æ˜æ‰¾åˆ°å…±åŒçš„ç¥–å…ˆï¼Œè¿”å›ç¥–å…ˆnumber<br>3ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å…±åŒçš„ç¥–å…ˆï¼Œå†é‡æ–°ä»æœ¬åœ°çš„åŒºå—é“¾MaxForkAncestryèµ·çš„ä¸€åŠçš„ä½ç½®å¼€å§‹å–åŒºå—å¤´ï¼Œä¸€ä¸€éªŒè¯æ˜¯å¦è·Ÿç½‘ç»œèŠ‚ç‚¹è¿”å›çš„headerä¸€è‡´ï¼Œå¦‚æœæœ‰å°±è¯´æ˜æœ‰å…±åŒçš„ç¥–å…ˆï¼Œå¹¶è¿”å›ï¼Œæ²¡æœ‰çš„è¯å°±è¿”å›0.</p><p>ç»§ç»­syncWithPeer()æ–¹æ³•ï¼Œæ‰¾åˆ°åŒæ­¥çš„è½´å¿ƒçš„pivotï¼Œæœ€åæŠŠè¦åŒæ­¥çš„æ•°æ®å’ŒåŒæ­¥çš„æ–¹æ³•ä¼ ç»™d.spawnSync(fetchers)ï¼Œå¹¶æ‰§è¡Œã€‚d.spawnSync(fetchers)æŒ¨ä¸ªæ‰§è¡Œä¼ å…¥çš„åŒæ­¥æ–¹æ³•ã€‚</p><p>äºŒï¼ŒDownloaderåŒæ­¥æ•°æ®æ–¹æ³•<br>fetchHeaders()ï¼ŒfetchBodies() , fetchReceipts()</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) fetchHeaders(p *peerConnection, from uint64, pivot uint64) error &#123;</span><br><span class="line">    p.log.Debug(&quot;Directing header downloads&quot;, &quot;origin&quot;, from)</span><br><span class="line">    defer p.log.Debug(&quot;Header download terminated&quot;)</span><br><span class="line"></span><br><span class="line">    // Create a timeout timer, and the associated header fetcher</span><br><span class="line">    skeleton := true            // Skeleton assembly phase or finishing up</span><br><span class="line">    request := time.Now()       // time of the last skeleton fetch request</span><br><span class="line">    timeout := time.NewTimer(0) // timer to dump a non-responsive active peer</span><br><span class="line">    &lt;-timeout.C                 // timeout channel should be initially empty</span><br><span class="line">    defer timeout.Stop()</span><br><span class="line"></span><br><span class="line">    var ttl time.Duration</span><br><span class="line">    getHeaders := func(from uint64) &#123;</span><br><span class="line">        request = time.Now()</span><br><span class="line"></span><br><span class="line">        ttl = d.requestTTL()</span><br><span class="line">        timeout.Reset(ttl)</span><br><span class="line"></span><br><span class="line">        if skeleton &#123;</span><br><span class="line">            p.log.Trace(&quot;Fetching skeleton headers&quot;, &quot;count&quot;, MaxHeaderFetch, &quot;from&quot;, from)</span><br><span class="line">            go p.peer.RequestHeadersByNumber(from+uint64(MaxHeaderFetch)-1, MaxSkeletonSize, MaxHeaderFetch-1, false)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            p.log.Trace(&quot;Fetching full headers&quot;, &quot;count&quot;, MaxHeaderFetch, &quot;from&quot;, from)</span><br><span class="line">            go p.peer.RequestHeadersByNumber(from, MaxHeaderFetch, 0, false)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Start pulling the header chain skeleton until all is done</span><br><span class="line">    getHeaders(from)</span><br><span class="line"></span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-d.cancelCh:</span><br><span class="line">            return errCancelHeaderFetch</span><br><span class="line"></span><br><span class="line">        case packet := &lt;-d.headerCh:</span><br><span class="line">            // Make sure the active peer is giving us the skeleton headers</span><br><span class="line">            if packet.PeerId() != p.id &#123;</span><br><span class="line">                log.Debug(&quot;Received skeleton from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            headerReqTimer.UpdateSince(request)</span><br><span class="line">            timeout.Stop()</span><br><span class="line"></span><br><span class="line">            // If the skeleton&apos;s finished, pull any remaining head headers directly from the origin</span><br><span class="line">            if packet.Items() == 0 &amp;&amp; skeleton &#123;</span><br><span class="line">                skeleton = false</span><br><span class="line">                getHeaders(from)</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">            // If no more headers are inbound, notify the content fetchers and return</span><br><span class="line">            if packet.Items() == 0 &#123;</span><br><span class="line">                // Don&apos;t abort header fetches while the pivot is downloading</span><br><span class="line">                if atomic.LoadInt32(&amp;d.committed) == 0 &amp;&amp; pivot &lt;= from &#123;</span><br><span class="line">                    p.log.Debug(&quot;No headers, waiting for pivot commit&quot;)</span><br><span class="line">                    select &#123;</span><br><span class="line">                    case &lt;-time.After(fsHeaderContCheck):</span><br><span class="line">                        getHeaders(from)</span><br><span class="line">                        continue</span><br><span class="line">                    case &lt;-d.cancelCh:</span><br><span class="line">                        return errCancelHeaderFetch</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // Pivot done (or not in fast sync) and no more headers, terminate the process</span><br><span class="line">                p.log.Debug(&quot;No more headers available&quot;)</span><br><span class="line">                select &#123;</span><br><span class="line">                case d.headerProcCh &lt;- nil:</span><br><span class="line">                    return nil</span><br><span class="line">                case &lt;-d.cancelCh:</span><br><span class="line">                    return errCancelHeaderFetch</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            headers := packet.(*headerPack).headers</span><br><span class="line"></span><br><span class="line">            // If we received a skeleton batch, resolve internals concurrently</span><br><span class="line">            if skeleton &#123;</span><br><span class="line">                filled, proced, err := d.fillHeaderSkeleton(from, headers)</span><br><span class="line">                if err != nil &#123;</span><br><span class="line">                    p.log.Debug(&quot;Skeleton chain invalid&quot;, &quot;err&quot;, err)</span><br><span class="line">                    return errInvalidChain</span><br><span class="line">                &#125;</span><br><span class="line">                headers = filled[proced:]</span><br><span class="line">                from += uint64(proced)</span><br><span class="line">            &#125;</span><br><span class="line">            // Insert all the new headers and fetch the next batch</span><br><span class="line">            if len(headers) &gt; 0 &#123;</span><br><span class="line">                p.log.Trace(&quot;Scheduling new headers&quot;, &quot;count&quot;, len(headers), &quot;from&quot;, from)</span><br><span class="line">                select &#123;</span><br><span class="line">                case d.headerProcCh &lt;- headers:</span><br><span class="line">                case &lt;-d.cancelCh:</span><br><span class="line">                    return errCancelHeaderFetch</span><br><span class="line">                &#125;</span><br><span class="line">                from += uint64(len(headers))</span><br><span class="line">            &#125;</span><br><span class="line">            getHeaders(from)</span><br><span class="line"></span><br><span class="line">        case &lt;-timeout.C:</span><br><span class="line">            if d.dropPeer == nil &#123;</span><br><span class="line">                // The dropPeer method is nil when `--copydb` is used for a local copy.</span><br><span class="line">                // Timeouts can occur if e.g. compaction hits at the wrong time, and can be ignored</span><br><span class="line">                p.log.Warn(&quot;Downloader wants to drop peer, but peerdrop-function is not set&quot;, &quot;peer&quot;, p.id)</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">            // Header retrieval timed out, consider the peer bad and drop</span><br><span class="line">            p.log.Debug(&quot;Header request timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class="line">            headerTimeoutMeter.Mark(1)</span><br><span class="line">            d.dropPeer(p.id)</span><br><span class="line"></span><br><span class="line">            // Finish the sync gracefully instead of dumping the gathered data though</span><br><span class="line">            for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class="line">                select &#123;</span><br><span class="line">                case ch &lt;- false:</span><br><span class="line">                case &lt;-d.cancelCh:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            select &#123;</span><br><span class="line">            case d.headerProcCh &lt;- nil:</span><br><span class="line">            case &lt;-d.cancelCh:</span><br><span class="line">            &#125;</span><br><span class="line">            return errBadPeer</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ï¼ŒgetHeaders()è°ƒç”¨peer.RequestHeadersByNumber()æ–¹æ³• è·å–ç½‘ç»œèŠ‚ç‚¹çš„headersã€‚<br>2ï¼Œæœ‰ä¸¤ç§è·å–æ–¹å¼ï¼Œé¦–å…ˆèµ°çš„æ˜¯skeletonæ–¹å¼ï¼Œä»æŸ¥æ‰¾åˆ°çš„å…±åŒç¥–å…ˆåŒºå—+192ä¸ªåŒºå—ä½ç½®å¼€å§‹ï¼Œæ¯éš”192ä¸ªåŒºå—ï¼Œè·å–128ä¸ªåŒºå—å¤´ã€‚éskeletonæ–¹å¼ï¼Œä»å…±åŒç¥–å…ˆåŒºå—å¼€å§‹ï¼Œè·å–192ä¸ªåŒºå—å¤´ã€‚<br>3ï¼Œå¦‚æœç¬¬ä¸€ç§æ–¹å¼è·å–ä¸åˆ°åŒºå—å¤´ï¼Œåˆ™æ‰§è¡Œç¬¬äºŒç§è·å–æ–¹å¼ï¼Œå¦‚æœç¬¬äºŒç§æ–¹å¼è¿˜æ˜¯æ²¡æœ‰è·å–åˆ°åŒºå—å¤´çš„è¯ï¼Œç›´æ¥è¿”å›<br>4ï¼Œå¦‚æœæ˜¯skeletonè·å–åˆ°çš„ï¼Œè°ƒç”¨fillHeaderSkeleton()æ–¹æ³•åŠ å…¥åˆ°skeleton header chain<br>5ï¼Œç„¶åè°ƒæ•´fromå€¼ï¼Œå†é€’å½’è°ƒç”¨getHeaders()æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) fillHeaderSkeleton(from uint64, skeleton []*types.Header) ([]*types.Header, int, error) &#123;</span><br><span class="line">    log.Debug(&quot;Filling up skeleton&quot;, &quot;from&quot;, from)</span><br><span class="line">    d.queue.ScheduleSkeleton(from, skeleton)</span><br><span class="line"></span><br><span class="line">    var (</span><br><span class="line">        deliver = func(packet dataPack) (int, error) &#123;</span><br><span class="line">            pack := packet.(*headerPack)</span><br><span class="line">            return d.queue.DeliverHeaders(pack.peerId, pack.headers, d.headerProcCh)</span><br><span class="line">        &#125;</span><br><span class="line">        expire   = func() map[string]int &#123; return d.queue.ExpireHeaders(d.requestTTL()) &#125;</span><br><span class="line">        throttle = func() bool &#123; return false &#125;</span><br><span class="line">        reserve  = func(p *peerConnection, count int) (*fetchRequest, bool, error) &#123;</span><br><span class="line">            return d.queue.ReserveHeaders(p, count), false, nil</span><br><span class="line">        &#125;</span><br><span class="line">        fetch    = func(p *peerConnection, req *fetchRequest) error &#123; return p.FetchHeaders(req.From, MaxHeaderFetch) &#125;</span><br><span class="line">        capacity = func(p *peerConnection) int &#123; return p.HeaderCapacity(d.requestRTT()) &#125;</span><br><span class="line">        setIdle  = func(p *peerConnection, accepted int) &#123; p.SetHeadersIdle(accepted) &#125;</span><br><span class="line">    )</span><br><span class="line">    err := d.fetchParts(errCancelHeaderFetch, d.headerCh, deliver, d.queue.headerContCh, expire,</span><br><span class="line">        d.queue.PendingHeaders, d.queue.InFlightHeaders, throttle, reserve,</span><br><span class="line">        nil, fetch, d.queue.CancelHeaders, capacity, d.peers.HeaderIdlePeers, setIdle, &quot;headers&quot;)</span><br><span class="line"></span><br><span class="line">    log.Debug(&quot;Skeleton fill terminated&quot;, &quot;err&quot;, err)</span><br><span class="line"></span><br><span class="line">    filled, proced := d.queue.RetrieveHeaders()</span><br><span class="line">    return filled, proced, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>a) æŠŠskeletonçš„headersåŠ å…¥queue.ScheduleSkeletonè°ƒåº¦é˜Ÿåˆ—ï¼Œ<br>b) ç„¶åæ‰§è¡Œd.fetchParts()æ–¹æ³•ã€‚<br>d.fetchParts()æ–¹æ³•ä¸»è¦åšäº†è¿™å‡ ä»¶äº‹æƒ…<br>1ï¼Œå¯¹æ”¶åˆ°çš„headersæ‰§è¡Œd.queue.DeliverHeaders()æ–¹æ³•ã€‚<br>2ï¼Œå¦‚æœd.queue.PendingHeadersæœ‰pendingçš„headersï¼Œè°ƒç”¨d.peers.HeaderIdlePeersè·å–åˆ°idleçš„peers<br>3ï¼Œè°ƒç”¨d.queue.ReserveHeadersæŠŠpendingçš„headerså‚¨å¤‡åˆ°idleçš„peersé‡Œé¢<br>4ï¼Œç”¨idleçš„peersè°ƒç”¨p.FetchHeaders(req.From, MaxHeaderFetch)å»è·å–headers<br>c) æœ€åæ‰§è¡Œd.queue.RetrieveHeaders()ï¼Œè·å–åˆ°filledè¿›å»çš„headers</p><p>å…¶ä»–åŒæ­¥åŒºå—æ•°æ®çš„æ–¹æ³•d.fetchBodies() , d.fetchReceipts() å’ŒfetchHeaders()æµç¨‹ç±»ä¼¼ï¼Œè¿˜æ›´ç®€å•ä¸€äº›ã€‚</p><p>ä¸‰ï¼ŒDownloaderåŒæ­¥æ•°æ®è¿‡ç¨‹<br>d.processHeaders(), d.processFastSyncContent(latest) , d.processFullSyncContent<br>1ï¼Œd.processHeaders() æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) processHeaders(origin uint64, pivot uint64, td *big.Int) error &#123;</span><br><span class="line">    // Keep a count of uncertain headers to roll back</span><br><span class="line">    rollback := []*types.Header&#123;&#125;</span><br><span class="line">    defer func() &#123;</span><br><span class="line">        if len(rollback) &gt; 0 &#123;</span><br><span class="line">            // Flatten the headers and roll them back</span><br><span class="line">            hashes := make([]common.Hash, len(rollback))</span><br><span class="line">            for i, header := range rollback &#123;</span><br><span class="line">                hashes[i] = header.Hash()</span><br><span class="line">            &#125;</span><br><span class="line">            lastHeader, lastFastBlock, lastBlock := d.lightchain.CurrentHeader().Number, common.Big0, common.Big0</span><br><span class="line">            if d.mode != LightSync &#123;</span><br><span class="line">                lastFastBlock = d.blockchain.CurrentFastBlock().Number()</span><br><span class="line">                lastBlock = d.blockchain.CurrentBlock().Number()</span><br><span class="line">            &#125;</span><br><span class="line">            d.lightchain.Rollback(hashes)</span><br><span class="line">            curFastBlock, curBlock := common.Big0, common.Big0</span><br><span class="line">            if d.mode != LightSync &#123;</span><br><span class="line">                curFastBlock = d.blockchain.CurrentFastBlock().Number()</span><br><span class="line">                curBlock = d.blockchain.CurrentBlock().Number()</span><br><span class="line">            &#125;</span><br><span class="line">            log.Warn(&quot;Rolled back headers&quot;, &quot;count&quot;, len(hashes),</span><br><span class="line">                &quot;header&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastHeader, d.lightchain.CurrentHeader().Number),</span><br><span class="line">                &quot;fast&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastFastBlock, curFastBlock),</span><br><span class="line">                &quot;block&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastBlock, curBlock))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    // Wait for batches of headers to process</span><br><span class="line">    gotHeaders := false</span><br><span class="line"></span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-d.cancelCh:</span><br><span class="line">            return errCancelHeaderProcessing</span><br><span class="line"></span><br><span class="line">        case headers := &lt;-d.headerProcCh:</span><br><span class="line">            // Terminate header processing if we synced up</span><br><span class="line">            if len(headers) == 0 &#123;</span><br><span class="line">                // Notify everyone that headers are fully processed</span><br><span class="line">                for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class="line">                    select &#123;</span><br><span class="line">                    case ch &lt;- false:</span><br><span class="line">                    case &lt;-d.cancelCh:</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if d.mode != LightSync &#123;</span><br><span class="line">                    head := d.blockchain.CurrentBlock()</span><br><span class="line">                    if !gotHeaders &amp;&amp; td.Cmp(d.blockchain.GetTd(head.Hash(), head.NumberU64())) &gt; 0 &#123;</span><br><span class="line">                        return errStallingPeer</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if d.mode == FastSync || d.mode == LightSync &#123;</span><br><span class="line">                    head := d.lightchain.CurrentHeader()</span><br><span class="line">                    if td.Cmp(d.lightchain.GetTd(head.Hash(), head.Number.Uint64())) &gt; 0 &#123;</span><br><span class="line">                        return errStallingPeer</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // Disable any rollback and return</span><br><span class="line">                rollback = nil</span><br><span class="line">                return nil</span><br><span class="line">            &#125;</span><br><span class="line">            // Otherwise split the chunk of headers into batches and process them</span><br><span class="line">            gotHeaders = true</span><br><span class="line"></span><br><span class="line">            for len(headers) &gt; 0 &#123;</span><br><span class="line">                // Terminate if something failed in between processing chunks</span><br><span class="line">                select &#123;</span><br><span class="line">                case &lt;-d.cancelCh:</span><br><span class="line">                    return errCancelHeaderProcessing</span><br><span class="line">                default:</span><br><span class="line">                &#125;</span><br><span class="line">                // Select the next chunk of headers to import</span><br><span class="line">                limit := maxHeadersProcess</span><br><span class="line">                if limit &gt; len(headers) &#123;</span><br><span class="line">                    limit = len(headers)</span><br><span class="line">                &#125;</span><br><span class="line">                chunk := headers[:limit]</span><br><span class="line"></span><br><span class="line">                // In case of header only syncing, validate the chunk immediately</span><br><span class="line">                if d.mode == FastSync || d.mode == LightSync &#123;</span><br><span class="line">                    // Collect the yet unknown headers to mark them as uncertain</span><br><span class="line">                    unknown := make([]*types.Header, 0, len(headers))</span><br><span class="line">                    for _, header := range chunk &#123;</span><br><span class="line">                        if !d.lightchain.HasHeader(header.Hash(), header.Number.Uint64()) &#123;</span><br><span class="line">                            unknown = append(unknown, header)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // If we&apos;re importing pure headers, verify based on their recentness</span><br><span class="line">                    frequency := fsHeaderCheckFrequency</span><br><span class="line">                    if chunk[len(chunk)-1].Number.Uint64()+uint64(fsHeaderForceVerify) &gt; pivot &#123;</span><br><span class="line">                        frequency = 1</span><br><span class="line">                    &#125;</span><br><span class="line">                    if n, err := d.lightchain.InsertHeaderChain(chunk, frequency); err != nil &#123;</span><br><span class="line">                        // If some headers were inserted, add them too to the rollback list</span><br><span class="line">                        if n &gt; 0 &#123;</span><br><span class="line">                            rollback = append(rollback, chunk[:n]...)</span><br><span class="line">                        &#125;</span><br><span class="line">                        log.Debug(&quot;Invalid header encountered&quot;, &quot;number&quot;, chunk[n].Number, &quot;hash&quot;, chunk[n].Hash(), &quot;err&quot;, err)</span><br><span class="line">                        return errInvalidChain</span><br><span class="line">                    &#125;</span><br><span class="line">                    // All verifications passed, store newly found uncertain headers</span><br><span class="line">                    rollback = append(rollback, unknown...)</span><br><span class="line">                    if len(rollback) &gt; fsHeaderSafetyNet &#123;</span><br><span class="line">                        rollback = append(rollback[:0], rollback[len(rollback)-fsHeaderSafetyNet:]...)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // Unless we&apos;re doing light chains, schedule the headers for associated content retrieval</span><br><span class="line">                if d.mode == FullSync || d.mode == FastSync &#123;</span><br><span class="line">                    // If we&apos;ve reached the allowed number of pending headers, stall a bit</span><br><span class="line">                    for d.queue.PendingBlocks() &gt;= maxQueuedHeaders || d.queue.PendingReceipts() &gt;= maxQueuedHeaders &#123;</span><br><span class="line">                        select &#123;</span><br><span class="line">                        case &lt;-d.cancelCh:</span><br><span class="line">                            return errCancelHeaderProcessing</span><br><span class="line">                        case &lt;-time.After(time.Second):</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // Otherwise insert the headers for content retrieval</span><br><span class="line">                    inserts := d.queue.Schedule(chunk, origin)</span><br><span class="line">                    if len(inserts) != len(chunk) &#123;</span><br><span class="line">                        log.Debug(&quot;Stale headers&quot;)</span><br><span class="line">                        return errBadPeer</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                headers = headers[limit:]</span><br><span class="line">                origin += uint64(limit)</span><br><span class="line">            &#125;</span><br><span class="line">            // Signal the content downloaders of the availablility of new tasks</span><br><span class="line">            for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class="line">                select &#123;</span><br><span class="line">                case ch &lt;- true:</span><br><span class="line">                default:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ï¼Œæ”¶åˆ°ä»fetchHeaders()æ–¹æ³• ä¸­d.headerProcChå‘é€è¿‡æ¥çš„headers<br>2ï¼Œå¦‚æœæ˜¯FastSyncæˆ–è€…LightSyncæ¨¡å¼ï¼Œç›´æ¥è°ƒç”¨lightchain.InsertHeaderChain(chunk, frequency)æ’å…¥åˆ°headerChainã€‚<br>3ï¼Œå¦‚æœæ˜¯FullSyncæˆ–è€…FastSynæ¨¡å¼ï¼Œè°ƒç”¨d.queue.Schedule(chunk, origin)ï¼Œæ”¾å…¥downloader.queueæ¥è°ƒåº¦</p><p>2ï¼ŒprocessFastSyncContent() æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) processFastSyncContent(latest *types.Header) error &#123;</span><br><span class="line">    // Start syncing state of the reported head block. This should get us most of</span><br><span class="line">    // the state of the pivot block.</span><br><span class="line">    stateSync := d.syncState(latest.Root)</span><br><span class="line">    defer stateSync.Cancel()</span><br><span class="line">    go func() &#123;</span><br><span class="line">        if err := stateSync.Wait(); err != nil &amp;&amp; err != errCancelStateFetch &#123;</span><br><span class="line">            d.queue.Close() // wake up WaitResults</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    // Figure out the ideal pivot block. Note, that this goalpost may move if the</span><br><span class="line">    // sync takes long enough for the chain head to move significantly.</span><br><span class="line">    pivot := uint64(0)</span><br><span class="line">    if height := latest.Number.Uint64(); height &gt; uint64(fsMinFullBlocks) &#123;</span><br><span class="line">        pivot = height - uint64(fsMinFullBlocks)</span><br><span class="line">    &#125;</span><br><span class="line">    // To cater for moving pivot points, track the pivot block and subsequently</span><br><span class="line">    // accumulated download results separatey.</span><br><span class="line">    var (</span><br><span class="line">        oldPivot *fetchResult   // Locked in pivot block, might change eventually</span><br><span class="line">        oldTail  []*fetchResult // Downloaded content after the pivot</span><br><span class="line">    )</span><br><span class="line">    for &#123;</span><br><span class="line">        // Wait for the next batch of downloaded data to be available, and if the pivot</span><br><span class="line">        // block became stale, move the goalpost</span><br><span class="line">        results := d.queue.Results(oldPivot == nil) // Block if we&apos;re not monitoring pivot staleness</span><br><span class="line">        if len(results) == 0 &#123;</span><br><span class="line">            // If pivot sync is done, stop</span><br><span class="line">            if oldPivot == nil &#123;</span><br><span class="line">                return stateSync.Cancel()</span><br><span class="line">            &#125;</span><br><span class="line">            // If sync failed, stop</span><br><span class="line">            select &#123;</span><br><span class="line">            case &lt;-d.cancelCh:</span><br><span class="line">                return stateSync.Cancel()</span><br><span class="line">            default:</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if d.chainInsertHook != nil &#123;</span><br><span class="line">            d.chainInsertHook(results)</span><br><span class="line">        &#125;</span><br><span class="line">        if oldPivot != nil &#123;</span><br><span class="line">            results = append(append([]*fetchResult&#123;oldPivot&#125;, oldTail...), results...)</span><br><span class="line">        &#125;</span><br><span class="line">        // Split around the pivot block and process the two sides via fast/full sync</span><br><span class="line">        if atomic.LoadInt32(&amp;d.committed) == 0 &#123;</span><br><span class="line">            latest = results[len(results)-1].Header</span><br><span class="line">            if height := latest.Number.Uint64(); height &gt; pivot+2*uint64(fsMinFullBlocks) &#123;</span><br><span class="line">                log.Warn(&quot;Pivot became stale, moving&quot;, &quot;old&quot;, pivot, &quot;new&quot;, height-uint64(fsMinFullBlocks))</span><br><span class="line">                pivot = height - uint64(fsMinFullBlocks)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        P, beforeP, afterP := splitAroundPivot(pivot, results)</span><br><span class="line">        if err := d.commitFastSyncData(beforeP, stateSync); err != nil &#123;</span><br><span class="line">            return err</span><br><span class="line">        &#125;</span><br><span class="line">        if P != nil &#123;</span><br><span class="line">            // If new pivot block found, cancel old state retrieval and restart</span><br><span class="line">            if oldPivot != P &#123;</span><br><span class="line">                stateSync.Cancel()</span><br><span class="line"></span><br><span class="line">                stateSync = d.syncState(P.Header.Root)</span><br><span class="line">                defer stateSync.Cancel()</span><br><span class="line">                go func() &#123;</span><br><span class="line">                    if err := stateSync.Wait(); err != nil &amp;&amp; err != errCancelStateFetch &#123;</span><br><span class="line">                        d.queue.Close() // wake up WaitResults</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;()</span><br><span class="line">                oldPivot = P</span><br><span class="line">            &#125;</span><br><span class="line">            // Wait for completion, occasionally checking for pivot staleness</span><br><span class="line">            select &#123;</span><br><span class="line">            case &lt;-stateSync.done:</span><br><span class="line">                if stateSync.err != nil &#123;</span><br><span class="line">                    return stateSync.err</span><br><span class="line">                &#125;</span><br><span class="line">                if err := d.commitPivotBlock(P); err != nil &#123;</span><br><span class="line">                    return err</span><br><span class="line">                &#125;</span><br><span class="line">                oldPivot = nil</span><br><span class="line"></span><br><span class="line">            case &lt;-time.After(time.Second):</span><br><span class="line">                oldTail = afterP</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // Fast sync done, pivot commit done, full import</span><br><span class="line">        if err := d.importBlockResults(afterP); err != nil &#123;</span><br><span class="line">            return err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1ï¼ŒåŒæ­¥æœ€æ–°çš„çŠ¶æ€ä¿¡æ¯ï¼Œçš„åˆ°æœ€æ–°çš„pivotå€¼<br>2ï¼Œä¸åœçš„ä»d.queue çš„resultç¼“å­˜ä¸­è·å–è¦å¤„ç†çš„resultæ•°æ®<br>3ï¼Œå¦‚æœresultsæ•°æ®ä¸ºç©ºï¼ŒåŒæ—¶pivotä¹Ÿä¸ºç©ºçš„æ—¶å€™ï¼Œè¯´æ˜åŒæ­¥å®Œæˆäº†ï¼Œå¹¶è¿”å›<br>4ï¼Œæ ¹æ®pivotå€¼å’Œresultsè®¡ç®—ï¼špivotå€¼å¯¹åº”çš„resultï¼Œå’Œpivotå€¼ä¹‹å‰çš„resultså’Œpivotå€¼ä¹‹åçš„results<br>5ï¼Œè°ƒç”¨commitFastSyncDataæŠŠpivotå€¼ä¹‹å‰çš„results æ’å…¥æœ¬åœ°åŒºå—é“¾ä¸­ï¼Œå¸¦ä¸Šæ”¶æ®å’Œäº¤æ˜“æ•°æ®<br>6ï¼Œæ›´æ–°åŒæ­¥çŠ¶æ€ä¿¡æ¯åï¼ŒæŠŠpivotå€¼å¯¹åº”çš„result è°ƒç”¨commitPivotBlockæ’å…¥æœ¬åœ°åŒºå—é“¾ä¸­ï¼Œå¹¶è°ƒç”¨FastSyncCommitHeadï¼Œè®°å½•è¿™ä¸ªpivotçš„hashå€¼<br>7ï¼Œè°ƒç”¨d.importBlockResultsæŠŠpivotå€¼ä¹‹åçš„resultsæ’å…¥æœ¬åœ°åŒºå—é“¾ä¸­ï¼Œè¿™æ—¶å€™ä¸æ’å…¥åŒºå—äº¤æ˜“æ”¶æ®æ•°æ®ã€‚</p><p>3ï¼ŒprocessFullSyncContent()æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">func (d *Downloader) processFullSyncContent() error &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        results := d.queue.Results(true)</span><br><span class="line">        if len(results) == 0 &#123;</span><br><span class="line">            return nil</span><br><span class="line">        &#125;</span><br><span class="line">        if d.chainInsertHook != nil &#123;</span><br><span class="line">            d.chainInsertHook(results)</span><br><span class="line">        &#125;</span><br><span class="line">        if err := d.importBlockResults(results); err != nil &#123;</span><br><span class="line">            return err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (d *Downloader) importBlockResults(results []*fetchResult) error &#123;</span><br><span class="line">    // Check for any early termination requests</span><br><span class="line">    if len(results) == 0 &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">    select &#123;</span><br><span class="line">    case &lt;-d.quitCh:</span><br><span class="line">        return errCancelContentProcessing</span><br><span class="line">    default:</span><br><span class="line">    &#125;</span><br><span class="line">    // Retrieve the a batch of results to import</span><br><span class="line">    first, last := results[0].Header, results[len(results)-1].Header</span><br><span class="line">    log.Debug(&quot;Inserting downloaded chain&quot;, &quot;items&quot;, len(results),</span><br><span class="line">        &quot;firstnum&quot;, first.Number, &quot;firsthash&quot;, first.Hash(),</span><br><span class="line">        &quot;lastnum&quot;, last.Number, &quot;lasthash&quot;, last.Hash(),</span><br><span class="line">    )</span><br><span class="line">    blocks := make([]*types.Block, len(results))</span><br><span class="line">    for i, result := range results &#123;</span><br><span class="line">        blocks[i] = types.NewBlockWithHeader(result.Header).WithBody(result.Transactions, result.Uncles)</span><br><span class="line">    &#125;</span><br><span class="line">    if index, err := d.blockchain.InsertChain(blocks); err != nil &#123;</span><br><span class="line">        log.Debug(&quot;Downloaded item processing failed&quot;, &quot;number&quot;, results[index].Header.Number, &quot;hash&quot;, results[index].Header.Hash(), &quot;err&quot;, err)</span><br><span class="line">        return errInvalidChain</span><br><span class="line">    &#125;</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processFullSyncContentæ–¹æ³•æ¯”è¾ƒç®€å•ï¼šç›´æ¥è·å–ç¼“å­˜çš„resultsæ•°æ®ï¼Œå¹¶æ’å…¥åˆ°æœ¬åœ°åŒºå—é“¾ä¸­ã€‚</p><p>æ€»ç»“ï¼š<br>Downloaderçœ‹ä¼¼éå¸¸å¤æ‚ï¼Œå…¶å®é€»è¾‘è¿˜å¥½ï¼Œå¦‚æœæ²¡æœ‰lightæ¨¡å¼ï¼Œè¯»èµ·æ¥ä¼šå¥½å¾ˆå¤šã€‚å…¶å®lightæ¨¡å¼ä¸å¤ªæˆç†Ÿï¼ŒåŸºæœ¬ä¹Ÿæ²¡ä»€ä¹ˆç”¨ã€‚fastæ¨¡å¼æ¯”fullæ¨¡å¼é€»è¾‘ä¸Šé¢å¤šäº†ä¸€ä¸ªpivotï¼Œå¤„ç†èµ·æ¥å°±å¤æ‚å¾ˆå¤šã€‚ä½†æ˜¯fastæ¨¡å¼åœ¨æœ¬åœ°å­˜å‚¨äº†æ”¶æ®æ•°æ®ï¼Œå¤§å¤§å‡å°‘äº†åŒºå—äº¤æ˜“éªŒè¯çš„æ—¶é—´ã€‚å¦‚æœè¦æ›´æ¸…æ¥šæ˜ç™½fastæ¨¡å¼çš„åŸç†ï¼Œå¯ä»¥çœ‹çœ‹ä»¥å¤ªåŠç™½çš®ä¹¦å…³äºfastæ¨¡å¼åŒæ­¥è¿™ä¸€éƒ¨åˆ†ï¼š<a href="https://github.com/ethereum/go-ethereum/pull/1889">æ–‡æ¡£</a></p>]]></content>
      
      
      <categories>
          
          <category> eth </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eos_code</title>
      <link href="/2019/10/14/eos-code/"/>
      <url>/2019/10/14/eos-code/</url>
      
        <content type="html"><![CDATA[<h3 id="EOS-æºç å­¦ä¹ ä¹‹é¡¹ç›®ç»“æ„åˆ†æ-plugins"><a href="#EOS-æºç å­¦ä¹ ä¹‹é¡¹ç›®ç»“æ„åˆ†æ-plugins" class="headerlink" title="EOS æºç å­¦ä¹ ä¹‹é¡¹ç›®ç»“æ„åˆ†æ(plugins)"></a>EOS æºç å­¦ä¹ ä¹‹é¡¹ç›®ç»“æ„åˆ†æ(plugins)</h3><p>æ•´ä½“çš„ä»£ç ä½ç½®ä¸»è¦ä½äºpluginsã€librariesã€‚</p><p><strong>eosé¡¹ç›®é‡‡ç”¨äº†æ’ä»¶ç®¡ç†çš„ç»“æ„</strong>ã€‚</p><h4 id="å…¥å£"><a href="#å…¥å£" class="headerlink" title="å…¥å£"></a>å…¥å£</h4><p>programsçš„æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼Œåœ¨<a href="https://github.com/EOSIO/eos/wiki/Programs-&-Tools">eoså®˜æ–¹wiki</a>ä¸­å¯ä»¥æŸ¥çœ‹å…·ä½“æ¯ä¸ªç›®å½•çš„å«ä¹‰åŠä½œç”¨ã€‚è¿™é‡Œä»…å¤‡æ³¨å‡ ä¸ªç¤ºä¾‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.. eos/programs:</span><br><span class="line"></span><br><span class="line">â”œâ”€â”€ CMakeLists.txt</span><br><span class="line">â”œâ”€â”€ cleos //å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚æœæŠŠeosæ¯”ä½œæ“ä½œç³»ç»Ÿçš„è¯ï¼Œcleoså°±ç±»ä¼¼ç»ˆç«¯ä½œç”¨  </span><br><span class="line">â”œâ”€â”€ debug_node</span><br><span class="line">â”œâ”€â”€ eosio-abigen</span><br><span class="line">â”œâ”€â”€ eosio-applesedemo</span><br><span class="line">â”œâ”€â”€ eosio-launcher</span><br><span class="line">â”œâ”€â”€ genesis</span><br><span class="line">â”œâ”€â”€ keosd  //é’±åŒ…</span><br><span class="line">â”œâ”€â”€ nodeos  //èŠ‚ç‚¹æ ¸å¿ƒè¿›ç¨‹</span><br><span class="line">â””â”€â”€ snapshot</span><br></pre></td></tr></table></figure><p>è¦å¯åŠ¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ç”¨åˆ°çš„ä¾¿æ˜¯nodeosï¼Œcleosä¸­å¯ä½¿ç”¨çš„REST APIä¾¿æ˜¯nodeosä¸­æš´éœ²å‡ºæ¥çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬çœ‹çœ‹nodeosã€‚</p><p>æºä»£ç main.cppä¸­ï¼Œä»£ç ä»…æœ‰105è¡Œã€‚ä¸»è¦çœ‹çœ‹mainæ–¹æ³•å§ï¼ˆä¸æƒ³çœ‹ä»£ç å¯ä»¥ç•¥è¿‡ä»£ç éƒ¨åˆ† = =ï¼‰ï¼Œé€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œmainæ–¹æ³•ä½œç”¨åŒ…æ‹¬è®¾ç½®ç‰ˆæœ¬ã€å·¥ä½œè·¯å¾„ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œä»¥åŠlogçš„åˆå§‹åŒ–ï¼Œå¦å¤–å°±æ˜¯startupæ–¹æ³•çœ‹èµ·æ¥å°±æ˜¯å…³é”®ï¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv)</span><br><span class="line">&#123;</span><br><span class="line">   try &#123;</span><br><span class="line">      app().set_version(eosio::nodeos::config::version);</span><br><span class="line">      auto root = fc::app_path();</span><br><span class="line">      app().set_default_data_dir(root / &quot;eosio/nodeos/data&quot; );</span><br><span class="line">      app().set_default_config_dir(root / &quot;eosio/nodeos/config&quot; );</span><br><span class="line">      if(!app().initialize&lt;chain_plugin, http_plugin, net_plugin, producer_plugin&gt;(argc, argv))</span><br><span class="line">         return -1;</span><br><span class="line">      initialize_logging();</span><br><span class="line">      ilog(&quot;nodeos version $&#123;ver&#125;&quot;, (&quot;ver&quot;, eosio::utilities::common::itoh(static_cast&lt;uint32_t&gt;(app().version()))));</span><br><span class="line">      ilog(&quot;eosio root is $&#123;root&#125;&quot;, (&quot;root&quot;, root.string()));</span><br><span class="line">      //é‡è¦çš„ä»£ç !!!</span><br><span class="line">      app().startup();</span><br><span class="line">      app().exec();</span><br><span class="line">   &#125; catch (const fc::exception&amp; e) &#123;</span><br><span class="line">   &#125; .....(æ­¤å¤„çœç•¥å¤šä¸ªcatch)</span><br><span class="line">   return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>app()ä½ç½®ä½äº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./libraries/appbase/application.cpp</span><br><span class="line">//app()æ–¹æ³•è¿”å›applicationçš„å®ä¾‹(å¯¹c++çš„ç±»çš„æœºåˆ¶ä¸äº†è§£ï¼Œè¿™ä¸ªå®ä¾‹åƒæ˜¯é™æ€å¯¹è±¡ï¼Œåæ­£å°±æ˜¯é€šè¿‡è¿”å›çš„å®ä¾‹å¯ä»¥è°ƒç”¨ç›¸å…³æ–¹æ³•å§ï¼ŒåŒ…æ‹¬startupè¿™ä¸ªçœ‹èµ·æ¥å°±è·Ÿå…³é”®çš„æ–¹æ³•)</span><br></pre></td></tr></table></figure><p>è¿›å…¥åˆ°application.cppä¸­ï¼Œä¾‹ä¸¾ç›¸å…³æ–¹æ³•</p><ul><li><p>initialize_..: åˆå§‹åŒ–æ’ä»¶ï¼ŒåŠŸèƒ½åŒ…æ‹¬è°ƒç”¨å„ä¸ªæ’ä»¶è®¾ç½®å‘½ä»¤è¡Œå‚æ•°ï¼Œä»¥åŠåˆå§‹åŒ–æ–¹æ³•ï¼Œè¿˜æœ‰appè‡ªèº«å¯¹åº”åˆå§‹åŒ–æ“ä½œ</p></li><li><p>startup:  å¾ªç¯å„æ’ä»¶ï¼Œè°ƒç”¨å„æ’ä»¶çš„startupæ–¹æ³•</p></li><li><p>exec:  è¡¨ç¤ºå®Œå…¨çœ‹ä¸æ‡‚= =!!ã€‚çŒœæµ‹ä¸€ä¸‹ï¼Œåº”è¯¥æ˜¯ç›‘å¬ioäº‹ä»¶ï¼Œä¾‹å¦‚ç»“æŸè¿›ç¨‹ç³»åˆ—..</p></li></ul><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä¸»è¦çš„å…·ä½“çš„é‡è¦çš„å†…å®¹éƒ½åœ¨å„æ’ä»¶å†…éƒ¨ã€‚</p><h4 id="æ’ä»¶"><a href="#æ’ä»¶" class="headerlink" title="æ’ä»¶"></a>æ’ä»¶</h4><p>eosé¡¹ç›®é‡‡ç”¨äº†æ’ä»¶ç®¡ç†çš„ç»“æ„ã€‚æ’ä»¶çš„ç›®å½•å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.. eos/plugins:</span><br><span class="line"></span><br><span class="line">â”œâ”€â”€ CMakeLists.txt</span><br><span class="line">â”œâ”€â”€ account_history_api_plugin</span><br><span class="line">â”œâ”€â”€ account_history_plugin</span><br><span class="line">â”œâ”€â”€ chain_api_plugin</span><br><span class="line">â”œâ”€â”€ chain_plugin</span><br><span class="line">â”œâ”€â”€ eosio-make_new_plugin.sh</span><br><span class="line">â”œâ”€â”€ faucet_testnet_plugin</span><br><span class="line">â”œâ”€â”€ http_plugin</span><br><span class="line">â”œâ”€â”€ mongo_db_plugin</span><br><span class="line">â”œâ”€â”€ net_api_plugin</span><br><span class="line">â”œâ”€â”€ net_plugin</span><br><span class="line">â”œâ”€â”€ producer_plugin</span><br><span class="line">â”œâ”€â”€ template_plugin</span><br><span class="line">â”œâ”€â”€ txn_test_gen_plugin</span><br><span class="line">â”œâ”€â”€ wallet_api_plugin</span><br><span class="line">â””â”€â”€ wallet_plugin</span><br></pre></td></tr></table></figure><p>å®Œå…¨å¯ä»¥é€šè¿‡å‘½åæ¥ç†è§£å„æ’ä»¶çš„å«ä¹‰ã€‚è¦åˆ†æçš„è¯ï¼Œç›´æ¥ä»ç›¸åº”pluginså…¥æ‰‹ã€‚é€ä¸€è§‚å¯Ÿ..</p><h3 id="eos-nodeoså­¦ä¹ "><a href="#eos-nodeoså­¦ä¹ " class="headerlink" title="eos/nodeoså­¦ä¹ "></a>eos/nodeoså­¦ä¹ </h3><h4 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//è®¾ç½®ç‰ˆæœ¬</span><br><span class="line">app().set_version(eosio::nodeos::config::version);</span><br><span class="line">auto root = fc::app_path();</span><br><span class="line">//è®¾ç½®å·¥ä½œè·¯å¾„</span><br><span class="line">app().set_default_data_dir(root / &quot;eosio/nodeos/data&quot; );</span><br><span class="line">app().set_default_config_dir(root / &quot;eosio/nodeos/config&quot; );</span><br><span class="line">//å•èŠ‚ç‚¹éœ€è¦çš„æ’ä»¶åŒ…æ‹¬ä»¥ä¸‹å››ä¸ª</span><br><span class="line">if(!app().initialize&lt;chain_plugin, http_plugin, net_plugin, producer_plugin&gt;(argc, argv))</span><br><span class="line">   return -1;</span><br><span class="line"></span><br><span class="line">initialize_logging();</span><br><span class="line">ilog(&quot;nodeos version $&#123;ver&#125;&quot;, (&quot;ver&quot;, eosio::nodeos::config::itoh(static_cast&lt;uint32_t&gt;(app().version()))));</span><br><span class="line">ilog(&quot;eosio root is $&#123;root&#125;&quot;, (&quot;root&quot;, root.string()));</span><br><span class="line">app().startup();</span><br><span class="line">app().exec();</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯é…ç½®å’Œappçš„ä¸€äº›è°ƒç”¨ã€‚ç„¶åè½¬åˆ°appä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./libraries/appbase/application.cpp</span><br></pre></td></tr></table></figure><ul><li><p>app:  è¿”å›applicationçš„å®ä¾‹ï¼ˆå®ä¾‹åªæ˜¯å£°æ˜ï¼Œæœ¨æœ‰åˆå§‹åŒ–ï¼Œå¯¹c++ç±»æœºåˆ¶ä¸å¤ªäº†è§£ï¼Œéœ€è¿›ä¸€æ­¥äº†è§£ï¼Œç›®å‰å°±ç†è§£æˆè¿™ä¸ªå®ä¾‹å°±å¯è®¿é—®application::methodæ–¹æ³•ï¼‰</p></li><li><p>initialize_..: åˆå§‹åŒ–æ’ä»¶ï¼ŒåŠŸèƒ½åŒ…æ‹¬è°ƒç”¨å„ä¸ªæ’ä»¶è®¾ç½®å‘½ä»¤è¡Œå‚æ•°ï¼Œä»¥åŠåˆå§‹åŒ–æ–¹æ³•ï¼Œè¿˜æœ‰appè‡ªèº«å¯¹åº”åˆå§‹åŒ–æ“ä½œ</p></li><li><p>startup:  å¾ªç¯å„æ’ä»¶ï¼Œè°ƒç”¨å„æ’ä»¶çš„startupæ–¹æ³•</p></li><li><p>exec:  è¡¨ç¤ºå®Œå…¨çœ‹ä¸æ‡‚= =!!ã€‚çŒœæµ‹ä¸€ä¸‹ï¼Œåº”è¯¥æ˜¯ç›‘å¬ioäº‹ä»¶ï¼Œä¾‹å¦‚ç»“æŸè¿›ç¨‹ç³»åˆ—..</p></li></ul><p>é‚£ä¹ˆé’ˆå¯¹å•ä¸ªèŠ‚ç‚¹å¯åŠ¨å¿…è¦çš„4ä¸ªæ’ä»¶ï¼Œè¿›è¡Œé€ä¸ªå­¦ä¹ ã€‚</p><p>é¦–å…ˆæ˜¯æ’ä»¶çˆ¶æ–¹æ³•ï¼šï¼ˆåœ¨applicationä¸­è°ƒç”¨çš„æ–¹æ³•åç›´æ¥æ˜¯start_upï¼Œæ²¡æœ‰pluginå‰ç¼€ï¼Œè¿™ä¸ªé—®é¢˜æœ‰å¾…è§£å†³..ï¼‰</p><ul><li><p>set_program_options //è®¾ç½®å‘½ä»¤è¡Œå‚æ•°</p></li><li><p>plugin_initialize //åˆå§‹åŒ–æ“ä½œ</p></li><li><p>plugin_startup  //å¯åŠ¨</p></li><li><p>plugin_shutdown  //é€€å‡º</p></li></ul><h4 id="Chain-plugin"><a href="#Chain-plugin" class="headerlink" title="Chain_plugin"></a>Chain_plugin</h4><h4 id="Producer-plugin"><a href="#Producer-plugin" class="headerlink" title="Producer_plugin"></a>Producer_plugin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// dposå…±è¯†  åœ°æ–¹ -&gt; get_scheduled_producerçš„å®šä¹‰åœ¨chain_controller</span><br><span class="line">auto scheduled_producer = chain.get_scheduled_producer( slot );</span><br><span class="line">  // we must control the producer scheduled to produce the next block.</span><br><span class="line">  if( _producers.find( scheduled_producer ) == _producers.end() )</span><br><span class="line">  &#123;</span><br><span class="line">     capture(&quot;scheduled_producer&quot;, scheduled_producer);</span><br><span class="line">     return block_production_condition::not_my_turn;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chain_controllerçš„ä¸€äº›ç›¸å…³produceræ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤§æ„çŒœæµ‹æ›´æ–°æ–°åŒºå—ï¼ŒåŒ…æ‹¬æ–°åŒºå—å’Œç­¾åæ–°åŒºå—çš„producer</span></span><br><span class="line">update_signing_producer(<span class="keyword">const</span> producer_object&amp; signing_producer, <span class="keyword">const</span> signed_block&amp; new_block)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®æ–°çš„producersæ›´æ–°dbè¡¨ï¼Ÿç–‘é—®æ˜¯ä»£ç ä¸­åªæœ‰createï¼Œæ²¡æœ‰åˆ é™¤æ“ä½œ</span></span><br><span class="line">update_or_create_producers( <span class="keyword">const</span> producer_schedule_type&amp; producers)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¥½åƒè¿™ä¸ªæ˜¯å…³é”®ï¼è¯¦ç»†çœ‹ä¸€ä¸‹ï¼Œå¯¹æ–¹æ³•çš„è§£é‡Šä¸ºï¼Œä»æŠ•ç¥¨æ’åä¸­å–å‡ºå‰mä¸ªproducer,å¹¶æ’é™¤block_signing_keyæ˜¯nullçš„é‚£äº›ï¼Œmä¸ºé…ç½®ä¸­çš„producer_countã€‚ç„¶è€Œä»£ç ä¼¼ä¹æ²¡å…¨..</span></span><br><span class="line">_calculate_producer_schedule() &#123;</span><br><span class="line">  <span class="comment">//get_global_propertiesè¿”å›ä¸ºglobal_property_objectå¯¹è±¡ï¼Œnew_active_producersä¸ºå¯¹è±¡çš„ç†Ÿæ‚‰</span></span><br><span class="line">  <span class="comment">//æ®è§‚å¯Ÿï¼Œnew_active_producersçš„èµ‹å€¼ç›®å‰åªå‡ºç°åœ¨wasmçš„apiä¸­ï¼Œé‚£æ˜¯ä¸æ˜¯å°±å¯ä»¥å¾—å‡ºç»“è®ºnew_active_producersæ˜¯æ‰€æœ‰çš„å‚é€‰producers..è¿™ä¸ªæ–¹æ³•(_calculate_producer_schedule)è¦åšçš„å°±æ˜¯ä»æ‰€æœ‰å‚é€‰è€…ä¸­æŒ‰æ’åå–å‰mä¸ªï¼Œç„¶åå»æ‰block_signing_keyæ˜¯nullçš„é‚£äº›</span></span><br><span class="line">   producer_schedule_type schedule = get_global_properties().new_active_producers;</span><br><span class="line">   <span class="keyword">const</span> auto&amp; hps = _head_producer_schedule();</span><br><span class="line">   schedule.version = hps.version;</span><br><span class="line">   <span class="keyword">if</span>( hps != schedule )</span><br><span class="line">      ++schedule.version;</span><br><span class="line">   <span class="keyword">return</span> schedule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ²¡çœ‹æ‡‚..å¥½åƒæ˜¯ç»™æ‰€æœ‰producersæ€ä¹ˆæäº†ä¸€ä¸‹è®¤è¯(æ›´æ–°åˆ°_dbæŸè¡¨)</span></span><br><span class="line">_update_producers_authority()</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å½“å‰åŒºå—å¤´çš„producer</span></span><br><span class="line">head_block_producer()</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®account_name/ownernameè·å–å¯¹äºproducer</span></span><br><span class="line">get_producer(<span class="keyword">const</span> account_name&amp; ownername)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™ä¸ªæ–¹æ³•ä¹Ÿè›®é‡è¦çš„ï¼Œæ ¹æ®slot_numè·å–å·²è®¡åˆ’å¥½çš„producer.å…¶ä¸­ï¼Œslot_numå§‹ç»ˆå¯¹åº”äºæœªæ¥çš„æŸä¸€æ—¶åˆ»ï¼›å¦å¤–ï¼Œå¯¹äºslot_numçš„å€¼ï¼Œç›¸å¯¹å½“å‰å¤šå°‘åŒºå—çš„é—´éš”ï¼Œä¾‹å¦‚ï¼Œslot_num == 1 åˆ™ä¸ºä¸‹ä¸€ä¸ªproducer, slot_num == 2ï¼Œåˆ™ä¸ºåœ¨ä¸€ä¸ªåŒºå—é—´éš”åçš„ä¸‹ä¸€ä¸ªproducerã€‚æ³¨æ„çš„æ˜¯slot_numä»£è¡¨çš„æ˜¯åŒºå—é—´éš”ï¼Œéproduceré—´éš”</span></span><br><span class="line">get_scheduled_producer(uint32_t slot_num) &#123;</span><br><span class="line">   <span class="keyword">const</span> dynamic_global_property_object&amp; dpo = get_dynamic_global_properties();</span><br><span class="line">  <span class="comment">//æ³¨æ„ç‚¹1ï¼Œæœ€åç”¨æ¥è®¡ç®—ä½ç½®çš„å€¼æ˜¯ä¸€ä¸ªå½“å‰çš„ç»å¯¹ä½ç½® + slot_num  ï¼Ÿå…·ä½“å›å¤´å†çœ‹</span></span><br><span class="line">   uint64_t current_aslot = dpo.current_absolute_slot + slot_num;</span><br><span class="line">   ...</span><br><span class="line">  <span class="comment">//ä½ç½®å¯¹producer*é‡å¤æ¬¡æ•°çš„ç§¯å–æ¨¡</span></span><br><span class="line">   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¡ç®—producerè¿‡å»ç”Ÿäº§çš„å‚ä¸ç‡ï¼Œä»£ç æœªè¯¦</span></span><br><span class="line">producer_participation_rate()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤§æ¦‚çœ‹äº†ä»¥ä¸Šæ–¹æ³•ï¼Œæœ‰ç‚¹ä¹±ã€‚ç°åœ¨è¿˜ä¸èƒ½è¿æˆçº¿ï¼Œåªæ˜¯ç‚¹</span></span><br><span class="line">å…³é”®</span><br><span class="line">update_last_irreversible_block</span><br></pre></td></tr></table></figure><h3 id="produceræºç å­¦ä¹ "><a href="#produceræºç å­¦ä¹ " class="headerlink" title="produceræºç å­¦ä¹ "></a>produceræºç å­¦ä¹ </h3><p>ä»£ç ä½ç½®ä¸º..eos/plugins/producer_plugin/</p><p>æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼Œproducer_plugin.hppä¸ºæ–¹æ³•çš„å£°æ˜ï¼Œ producer_plugin.cppä¸ºå…·ä½“å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ CMakeLists.txt</span><br><span class="line">â”œâ”€â”€ include</span><br><span class="line">â”‚Â Â  â””â”€â”€ eosio</span><br><span class="line">â”‚Â Â      â””â”€â”€ producer_plugin</span><br><span class="line">â”‚Â Â          â””â”€â”€ producer_plugin.hpp</span><br><span class="line">â””â”€â”€ producer_plugin.cpp</span><br></pre></td></tr></table></figure><p>è™½ç„¶producer_plugin.cppçš„ä»£ç ä¹Ÿåªæœ‰ä¸åˆ°400è¡Œï¼Œä½†èŠ‚çœæ—¶é—´å’Œèµ„æºï¼Œå°±æŒ‘å‡ºå—ç›¸å…³çš„è¯´å§ã€‚æ–¹æ³•è°ƒç”¨å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugin_startup -&gt; schedule_production_loop(åˆ°æ²¡åˆ°å‡ºå—æ—¶é—´ï¼Œåˆ°äº†å°±å‡ºå—,è¿™ä¸ªæ–¹æ³•ä¸æ–­å¾ªç¯) -&gt; block_production_loop -&gt; maybe_produce_block</span><br></pre></td></tr></table></figure><p>maybe_produce_blockæ–¹æ³•æ˜¯æœ€åå†³å®šæ˜¯ä¸æ˜¯å‡ºå—çš„ã€‚ä»¥ä¸‹ä¸»è¦è§£é‡Šmaybe_produce_blockæ–¹æ³•</p><ul><li><p>é¦–å…ˆä¼šæ£€æŸ¥åŒºå—æ˜¯å¦åŒæ­¥åˆ°æœ€æ–°ã€‚</p></li><li><p>æ¥ä¸‹æ¥è¿™æ®µä»£ç ä¼šåˆ¤æ–­æ˜¯å¦åˆ°è¾¾å‡ºå—æ—¶é—´ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uint32_t slot = chain.get_slot_at_time( now );</span><br><span class="line">  if( slot == 0 )</span><br><span class="line">  &#123;</span><br><span class="line">     capture(&quot;next_time&quot;, chain.get_slot_time(1));</span><br><span class="line">     return block_production_condition::not_time_yet;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>ç„¶åå°±é€‰æ‹©å‡ºå—produceräº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto scheduled_producer = chain.get_scheduled_producer( slot );</span><br></pre></td></tr></table></figure></li></ul><p>å®Œäº†åˆ¤æ–­è¿™ä¸ªscheduled_produceræ˜¯ä¸æ˜¯è‡ªå·±ï¼Œæ˜¯çš„è¯ï¼Œå†æ£€æŸ¥ç‚¹åˆ«çš„(ä¾‹å¦‚ç§é’¥å•Šç­‰)ï¼Œæœ€åå°±å‡ºå—äº†ã€‚</p><p>é‚£ä¹ˆï¼Œå…³é”®ä»£ç å°±æ˜¯get_scheduled_produceræ–¹æ³•ã€‚get_scheduled_producerçš„è¿½è¸ªè¦åˆ°chain_controller.cppæ–‡ä»¶ä¸­äº†ã€‚ä½ç½®ä½äº./eos/libriaries/chain/chain_controller.cppã€‚ä»¥ä¸‹ä»£ç æœªåšç‰¹æ®Šè¯´æ˜ï¼Œéƒ½ä½äºchain_controller.cppä¸­ã€‚</p><p>é¦–å…ˆçœ‹get_scheduled_producerçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œâ‘¢é€šè¿‡ä»dbä¸­è¯»å‡ºglobal_property_objectå¯¹è±¡gpoï¼ˆä¸‹é¢ä¼šæœ‰ä»‹ç»ï¼‰ï¼Œgpo.active_producersä¸ºå½“å‰æ´»è·ƒçš„producersï¼Œç„¶åâ‘£â‘¤ä¸ºç®—å¾—å½“å‰ç´¢å¼•ä¸‹æ ‡indexï¼Œæœ€åæ ¹æ®indexåœ¨gpo.active_producersä¸­å–å‡ºç›¸åº”producerå³ä¸ºè¿”å›å€¼ã€‚ä¸‹æ ‡è®¡ç®—çš„æ–¹å¼å°±æ˜¯æ•°å­¦ç®—å¼index=å½“å‰åŒºå—ä½ç½® % ï¼ˆproducersæ€»æ•° * æ¯ä¸ªproduceré‡å¤å‡ºå¤šå°‘å—ï¼‰ã€‚æœ€åå†é™¤ä»¥æ¯ä¸ªproduceré‡å¤å‡ºå¤šå°‘å—ã€‚æ¯”è¾ƒä¸ç†è§£çš„æ˜¯å½“å‰åŒºå—ä½ç½®(ä»£ç ä¸­çš„current_aslot)çš„è®¡ç®—æ–¹å¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//å…·ä½“ä»£ç </span><br><span class="line">/*</span><br><span class="line">* 1. slot_numå§‹ç»ˆå¯¹åº”äºæœªæ¥çš„æŸä¸€æ—¶åˆ»</span><br><span class="line">* 2.å¯¹äºslot_numçš„å€¼ï¼Œç›¸å¯¹å½“å‰å¤šå°‘åŒºå—çš„é—´éš”ï¼Œ</span><br><span class="line">*     ä¾‹å¦‚ï¼Œslot_num == 1 åˆ™ä¸ºä¸‹ä¸€ä¸ªåŒºå—çš„producer,</span><br><span class="line">*          slot_num == 2ï¼Œåˆ™ä¸ºåœ¨ä¸€ä¸ªåŒºå—é—´éš”åçš„ä¸‹ä¸€ä¸ªproducerã€‚slot_numå³ä¸ºåŒºå—é—´éš”æ•°</span><br><span class="line">* 3.ä½¿ç”¨æ–¹æ³•get_slot_timeå’Œget_slot_at_timeä½œä¸ºslot_numå’Œæ—¶é—´æˆ³çš„è½¬æ¢</span><br><span class="line">* 4.slot_num == 0ï¼Œè¿”å›EOS_NULL_PRODUCER</span><br><span class="line">*/</span><br><span class="line">account_name chain_controller::get_scheduled_producer(uint32_t slot_num)const</span><br><span class="line">&#123;</span><br><span class="line">   const dynamic_global_property_object&amp; dpo = get_dynamic_global_properties(); //â‘ </span><br><span class="line">   uint64_t current_aslot = dpo.current_absolute_slot + slot_num; //â‘¡</span><br><span class="line">   const auto&amp; gpo = _db.get&lt;global_property_object&gt;(); //â‘¢</span><br><span class="line">   auto number_of_active_producers = gpo.active_producers.producers.size();</span><br><span class="line">   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);  //â‘£</span><br><span class="line">   index /= config::producer_repetitions; //â‘¤</span><br><span class="line">   FC_ASSERT( gpo.active_producers.producers.size() &gt; 0, &quot;no producers defined&quot; );</span><br><span class="line"></span><br><span class="line">   return gpo.active_producers.producers[index].producer_name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºglobal_property_objectä¸»è¦å±æ€§æœ‰active_producersã€new_active_producersã€pending_active_producersã€‚</p><p>active_producersæ˜¯å½“å‰è½®çš„producers, pending_active_producersä¸ºæ»¡è¶³æ’åç­‰è¦æ±‚çš„producers, new_active_producersä¸ºæ‰€æœ‰å¯æŠ•ç¥¨(æˆ–è€…æ˜¯æ‰€æœ‰å¤‡é€‰)çš„producerã€‚</p><p>åœ¨controller_chain.cppä¸­æœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//ä»æŠ•ç¥¨æ’åä¸­å–å‡ºå‰mä¸ªproducer,å¹¶æ’é™¤block_signing_keyæ˜¯nullçš„é‚£äº›ï¼Œmä¸ºé…ç½®ä¸­çš„producer_countã€‚ç„¶è€Œä»£ç ä¼¼ä¹æ²¡å…¨.</span><br><span class="line">_calculate_producer_schedule() &#123;...&#125;</span><br><span class="line"></span><br><span class="line">//æ›´æ–°global_properties</span><br><span class="line">update_global_properties()&#123;...&#125;</span><br><span class="line"></span><br><span class="line">//ä¸Šé¢æåˆ°è¿‡çš„æœ‰å¯èƒ½æ›´æ–°active_producersçš„æ–¹æ³•</span><br><span class="line">update_last_irreversible_block()&#123;...&#125;</span><br><span class="line"></span><br><span class="line"> /*</span><br><span class="line"> *  After applying all transactions successfully we can update</span><br><span class="line"> *  the current block time, block number, producer stats, etc</span><br><span class="line"> */</span><br><span class="line">_finalize_block()&#123;...&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦é€šè¿‡ä¸Šé¢åˆ—ä¸¾çš„æ–¹æ³•ä»‹ç»active_producersã€new_active_producersã€pending_active_producersæ˜¯å¦‚ä½•å…³è”çš„ã€‚ä¸‹é¢ä¸€æ®µå¦‚æœè§‰å¾—å„ä¸ªæ–¹æ³•è°ƒç”¨æ¯”è¾ƒè’™çš„è¯ï¼Œå¯ä»¥ç›´æ¥çœ‹ä¸‰ä¸ªåŠ ç²—å¥å­ï¼Œå¯ä»¥äº†è§£åˆ°active_producersã€new_active_producersã€pending_active_producersä¹‹é—´çš„å…³è”ã€‚</p><p>åœ¨_finalize_blockè°ƒç”¨çš„æ—¶å€™ï¼Œé¦–å…ˆè°ƒç”¨update_global_propertiesï¼Œåœ¨update_global_propertiesæ–¹æ³•ä¸­è°ƒç”¨äº†_calculate_producer_scheduleæ–¹æ³•ï¼Œcalculate_producer_scheduleæ–¹æ³•å®ç°çš„æ˜¯<strong>ä»new_active_producersä¸­é€‰å‡ºç¬¦åˆæ¡ä»¶çš„producers</strong>ï¼Œç„¶åå›åˆ°update_global_propertiesï¼Œ<strong>æ ¹æ®é€‰å‡ºçš„producers,æ›´æ–°pending_active_producers</strong>ï¼Œç„¶åå›åˆ°_finalize_blockæ–¹æ³•ï¼Œè°ƒç”¨update_global_propertiesä¹‹åè°ƒç”¨update_last_irreversible_blockæ–¹æ³•ï¼Œ<strong>é€šè¿‡pending_active_producersé€‚å½“æ›´æ–°active_producers</strong>ã€‚</p><p>ç„¶åï¼Œnew_active_producersæ˜¯é€šè¿‡wasmçš„apiè¿›è¡Œæ›´æ–°ã€‚è¿™æ ·å°±ç¼•é€šäº†ï¼Œé€šè¿‡æŠ•ç¥¨å®¢æˆ·ç«¯ï¼Œè¿›è¡ŒæŠ•ç¥¨ï¼Œå¹¶æ§åˆ¶æ›´æ–°new_active_producerså‚æ•°é€‰æ‰‹ï¼Œå’Œç›¸åº”ç¥¨æ•°ã€‚ç„¶åæ ¹æ®new_active_producerså’Œç¥¨æ•°å†³å®šblocker producersã€‚</p><p>é‚£ä¹ˆï¼Œblocker producersçš„é¡ºåºå‘¢ï¼Ÿ?? ä¸çŸ¥é“æ˜¯è¢«æˆ‘ç–å¿½äº†è¿˜æ˜¯çœŸçš„æ²¡çœ‹åˆ°ã€‚</p><p>produceræºç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸Šå±‚é€»è¾‘åœ¨ producer_plugin.cppä¸­ï¼ŒåŸºæœ¬çš„dposç­‰é€»è¾‘è¿˜æ˜¯åœ¨chain_controller.cppä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> eos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>eos</title>
      <link href="/2019/10/14/eos/"/>
      <url>/2019/10/14/eos/</url>
      
        <content type="html"><![CDATA[<h2 id="EOSç”Ÿæ€ç³»ç»Ÿä»‹ç»"><a href="#EOSç”Ÿæ€ç³»ç»Ÿä»‹ç»" class="headerlink" title="EOSç”Ÿæ€ç³»ç»Ÿä»‹ç»"></a>EOSç”Ÿæ€ç³»ç»Ÿä»‹ç»</h2><h3 id="EOSç›®æ ‡"><a href="#EOSç›®æ ‡" class="headerlink" title="EOSç›®æ ‡"></a>EOSç›®æ ‡</h3><ul><li>EOSèƒ½å®ç°æ¯ç§’ç™¾ä¸‡çº§çš„å¤„ç†é‡ï¼Œè€Œç›®å‰æ¯”ç‰¹å¸æ˜¯æ¯ç§’7ç¬”ï¼Œä»¥å¤ªåŠæ˜¯30-40ç¬”ã€‚</li><li>EOSå°†æ˜¯ç¬¬ä¸€ä¸ªæ‹¥æœ‰è‡ªå·±å®ªæ³•(constitution)çš„åŒºå—é“¾ï¼Œèƒ½å®ç°é«˜åº¦è‡ªæ²»ã€‚</li><li>EOSå°†ä¼šæˆä¸ºåŒºå—é“¾çš„æ“ä½œç³»ç»Ÿï¼Œä¸ºå¼€å‘dAppçš„å¼€å‘è€…æä¾›åº•å±‚æ¨¡å—ï¼Œé™ä½å¼€å‘é—¨æ§›ã€‚ä¼šå¯¼è‡´å¼€å‘åŒºå—é“¾dAppçš„å¤§æ½®ã€‚å¹¶å‘å¤„ç†å¿«ï¼Œæ²¡æœ‰æ‰‹ç»­è´¹ï¼Œä¼šå¸å¼•æ›´å¤šæ™®é€šç”¨æˆ·ã€‚</li></ul><h3 id="EOS-Appæ¶æ„"><a href="#EOS-Appæ¶æ„" class="headerlink" title="EOS Appæ¶æ„"></a>EOS Appæ¶æ„</h3><p><img src="https://upload-images.jianshu.io/upload_images/3866441-75058ee05f7b7f8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="æ¶æ„å›¾"></p><ul><li><p>IPFSå­˜å‚¨</p><p>åŒ…å«æ–‡ä»¶çš„å­˜å‚¨ï¼Œå’ŒæœåŠ¡å™¨ç«¯ç¨‹åºçš„å­˜å‚¨</p></li><li><p>æ•°æ®åº“æŸ¥è¯¢æœåŠ¡</p></li></ul><p>â€‹        é™¤äº†æ‰˜ç®¡æ–‡ä»¶ä¹‹å¤–ï¼Œå—ç”Ÿäº§è€…è¿˜éœ€è¦è¿è¡Œèƒ½å¤Ÿä»£è¡¨åº”ç”¨ç¨‹åºæŸ¥è¯¢åŒºå—é“¾æ•°æ®åº“çŠ¶æ€çš„APIèŠ‚ç‚¹</p><ul><li><p>èµ„æºé™åˆ¶</p><p>åº”ç”¨ç¨‹åºåœ¨å—é“¾å’Œæ¥å£ä¸Šéƒ½å ç”¨ä¼ è¾“å¸¦å®½ï¼ŒCPUå’Œå­˜å‚¨ç©ºé—´ã€‚ <strong>å—é“¾ç”Ÿäº§è€…</strong>å¿…é¡»è®¾ç½®è®¿é—®é™åˆ¶è§„åˆ™ï¼Œä»¥é˜²ç”¨æˆ·æ»¥ç”¨</p></li></ul><h3 id="EOS-ç³»ç»Ÿç»„æˆ"><a href="#EOS-ç³»ç»Ÿç»„æˆ" class="headerlink" title="EOS ç³»ç»Ÿç»„æˆ"></a>EOS ç³»ç»Ÿç»„æˆ</h3><p><img src="https://github.com/EOSIO/eos/wiki/assets/Single-Host-Testnet-No-keosd.png" alt="EOSç³»ç»Ÿç»„æˆ"></p><p>ä¸Šå›¾ä¸ºæœ¬åœ°å•èŠ‚ç‚¹ç»„æˆã€‚</p><ul><li><code>keosd</code>ï¼šæœ¬åœ°é’±åŒ…å·¥å…·ã€‚éèŠ‚ç‚¹ç”¨æˆ·å­˜å‚¨é’±åŒ…çš„è¿›ç¨‹ï¼Œå¯ä»¥ç®¡ç†å¤šä¸ªå«æœ‰ç§é’¥çš„é’±åŒ…å¹¶åŠ å¯†ã€‚</li><li><code>cleos</code>:æœ¬åœ°çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡å‘½ä»¤è¡Œä¸çœŸäººç”¨æˆ·äº¤äº’ï¼Œå¹¶ä¸èŠ‚ç‚¹ï¼ˆnodeosï¼‰çš„ REST æ¥å£é€šä¿¡ã€‚æ˜¯ç”¨æˆ·æˆ–è€…å¼€å‘è€…ä¸èŠ‚ç‚¹è¿›ç¨‹äº¤äº’çš„æ¡¥æ¢ã€‚</li><li><code>nodeos</code>ï¼š EOS ç³»ç»Ÿçš„æ ¸å¿ƒè¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œèŠ‚ç‚¹â€ã€‚</li></ul><p>èŠ‚ç‚¹è¿è¡Œæ—¶å¯é…ç½®ç›¸å…³æ’ä»¶ã€‚å¦‚</p><ul><li><code>producer_plugin</code>ï¼ˆè§è¯äººæ’ä»¶ï¼‰ï¼šè§è¯äººå¿…é¡»ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œæ™®é€šèŠ‚ç‚¹ä¸éœ€è¦ã€‚</li><li><code>wallet_plugin</code>ï¼ˆé’±åŒ…æ’ä»¶ï¼‰ï¼šä½¿ç”¨è¿™ä¸ªæ’ä»¶å°±å¯ä»¥çœå» keosd é’±åŒ…å·¥å…·ã€‚</li><li><code>wallet_api_plugin</code>ï¼ˆé’±åŒ…æ¥å£æ’ä»¶ï¼‰ï¼šç»™é’±åŒ…æ’ä»¶æä¾›æ¥å£ã€‚</li><li><code>chain_api_plugin</code>ï¼ˆåŒºå—é“¾æ¥å£æ’ä»¶ï¼‰ï¼šæä¾›åŒºå—é“¾æ•°æ®æ¥å£ã€‚</li><li><code>http_plugin</code>ï¼ˆhttp æ’ä»¶ï¼‰ï¼šæä¾› http æ¥å£ã€‚</li><li><code>account_history_api_plugin</code>ï¼ˆè´¦æˆ·å†å²æ¥å£ï¼‰ï¼šæä¾›è´¦æˆ·å†å²æŸ¥è¯¢æ¥å£ã€‚</li></ul><p>å…¬å…±ç½‘ç»œä¸‹ï¼Œç”¨æˆ·é€šè¿‡ <code>cleos</code> è¿æ¥åˆ° <code>nodeos</code> ï¼Œ <code>nodeos</code> å†è¿æ¥åˆ°åŒºå—é“¾ç½‘ç»œï¼ˆå…¶ä»–<code>nodeos</code>ï¼‰ã€‚</p><h3 id="å…±è¯†ç®—æ³•-BFT-DPOS"><a href="#å…±è¯†ç®—æ³•-BFT-DPOS" class="headerlink" title="å…±è¯†ç®—æ³•(BFT-DPOS)"></a>å…±è¯†ç®—æ³•(BFT-DPOS)</h3><p>è¢«æŠ•ç¥¨é€‰å‡ºçš„21ä¸ªè¶…çº§èŠ‚ç‚¹è½®æµè¿›è¡Œå‡ºå—ï¼Œæ¯0.5ç§’ç”Ÿæˆä¸€ä¸ªã€‚ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªç”Ÿäº§è€…è¢«æˆæƒäº§ç”ŸåŒºå—ã€‚å¦‚æœåœ¨è®¡åˆ’çš„æŸä¸ªæ—¶é—´å†…æ²¡æœ‰æˆåŠŸå‡ºå—ï¼Œåˆ™è·³è¿‡è¯¥å—ã€‚å¦‚æœæœ‰ä¸€ä¸ªæˆ–æ›´å¤šçš„åŒºå—è¢«è·³è¿‡ï¼Œåˆ™åœ¨åŒºå—é“¾ä¸Šä¼šæœ‰0.5sæˆ–è€…æ›´ä¹…çš„ç©ºç™½ã€‚ä¸€ä¸ªç”Ÿäº§è€…ä¸€æ¬¡è¿ç»­å‡º6ä¸ªå—ã€‚é‚£ä¹ˆï¼ŒåŒºå—çš„äº§ç”Ÿæ˜¯ä»¥126ä¸ªåŒºå—(æ¯ä¸ªå‡ºå—è€…å…­ä¸ªåŒºå—ï¼Œä¹˜ä»¥21ä¸ªå‡ºå—è€…)ä¸ºä¸€ä¸ªå‘¨æœŸã€‚åœ¨æ¯ä¸ªå‡ºå—å‘¨æœŸå¼€å§‹æ—¶ï¼Œä¼šæ ¹æ®é€šè¯æŒæœ‰äººæ‰€æŠ•ç¥¨æ•°é€‰å‡º21ä¸ªåŒºå—ç”Ÿäº§è€…ã€‚è¢«é€‰ä¸­çš„åŒºå—ç”Ÿäº§è€…çš„é¡ºåºä¼šæ ¹æ®15ä¸ªåŠä»¥ä¸Šçš„åŒºå—ç”Ÿäº§è€…çš„åŒæ„ï¼Œåˆ¶å®šå‡ºå—é¡ºåºçš„å®‰æ’ã€‚</p><p>å¦‚æœå‡ºå—è€…é”™è¿‡äº†ä¸€ä¸ªå—ï¼Œå¹¶ä¸”åœ¨æœ€è¿‘24å°æ—¶å†…æ²¡æœ‰äº§ç”Ÿä»»ä½•å—ï¼Œåˆ™è¿™ä¸ªå‡ºå—è€…å°†è¢«å‰”é™¤åœ¨è€ƒè™‘èŒƒå›´ä¹‹å¤–ï¼Œç›´åˆ°ä»–ä»¬é€šçŸ¥åŒºå—é“¾å¯ä»¥é‡æ–°å¼€å§‹äº§ç”ŸåŒºå—ã€‚è¿™ç¡®ä¿äº†ç½‘ç»œçš„é¡ºåˆ©è¿è¡Œï¼ŒæŠŠè¢«è¯æ˜ä¸ºä¸å¯é çš„åŒºå—ç”Ÿäº§è€…æ’é™¤åœ¨å‡ºå—æ’ç¨‹ä¹‹å¤–ï¼Œé€šè¿‡è¿™ä¸€æ–¹å¼ä½¿å¾—é”™è¿‡åŒºå—çš„æ•°é‡æœ€å°åŒ–</p><p><strong>æŠ•ç¥¨</strong>ï¼šæ ¹æ®æœ€æ–°è§„åˆ™ï¼ŒæŠ•ç¥¨å°†ä¼šåœ¨å®˜æ–¹é’±åŒ…ä¸­è¿›è¡Œï¼Œæ¯éš” 63s ï¼Œä¹Ÿå°±æ˜¯æ¯äº§ç”Ÿ126ä¸ªåŒºå—è¿›è¡Œä¸€æ¬¡ã€‚æ¯ä¸ªEOSæ‹¥æœ‰ 30 ç¥¨ï¼Œå¯ä»¥æŠ•ç»™ä¸åŒçš„å€™é€‰è€…ã€‚å‚ä¸æŠ•ç¥¨çš„ä»£å¸å°†ä¼šè¢«é”å®šä¸€æ®µæ—¶é—´ï¼Œä»£å¸æŒæœ‰è€…å¯ä»¥è®¾ç½®ä»£å¸é”å®šæœŸå†…çš„å€™é€‰äººè´¦æˆ·å’ŒæŠ•ç¥¨æ•°é‡è¿›è¡ŒæŠ•ç¥¨ã€‚</p><p>æŠ•ç¥¨ç»“æœï¼ŒEOS ç³»ç»Ÿä¼šç»Ÿè®¡å„ä¸ªå€™é€‰èŠ‚ç‚¹è·å¾—çš„ä»£å¸æ•°é‡ã€‚å…¶ä¸­è·å¾—ä»£å¸æ•°é‡æœ€å¤šçš„ 21 ä¸ªèŠ‚ç‚¹å°†è¢«é€‰å®šä¸ºè¶…çº§èŠ‚ç‚¹ï¼Œæ¬¡å¤šçš„ 100 ä¸ªèŠ‚ç‚¹è¢«é€‰ä¸ºå¤‡ç”¨èŠ‚ç‚¹ã€‚</p><p><strong>è¶…çº§èŠ‚ç‚¹</strong>ï¼šæ”¶é›†ã€éªŒè¯ç½‘ç»œäº¤æ˜“ä¿¡æ¯ï¼Œæ‰“åŒ…åˆ°åŒºå—ä¸­ï¼Œå¹¶å¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ã€‚</p><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼ŒDPOSå—é“¾ä¸ä¼šç»å†ä»»ä½•åˆ†å‰ï¼Œå› ä¸ºåŒºå—ç”Ÿäº§è€…å¹¶éç«äº‰å…³ç³»ï¼Œä»–ä»¬åˆä½œäº§ç”ŸåŒºå—ã€‚å¦‚æœæœ‰åŒºå—åˆ†å‰ï¼Œå…±è¯†å°†è‡ªåŠ¨åˆ‡æ¢åˆ°æœ€é•¿é“¾ã€‚å…³äºä¸ä¼šåˆ†å‰çš„éªŒè¯ï¼Œè§<a href="https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper" target="_blank" rel="noopener">éªŒè¯ç¯‡</a></p><p>å¦å¤–ï¼Œåœ¨ä¼ ç»Ÿçš„DPOSç®—æ³•ä¸Šå¢åŠ äº†æ‹œå åº­å®¹é”™ç®—æ³•(Byzantin Fault Tolerance) ï¼Œæ‰€æœ‰çš„å‡ºå—è€…éƒ½è¦å¯¹æ‰€æœ‰åŒºå—ç­¾åï¼Œä»¥æ­¤æ¥ç¡®ä¿åœ¨åŒä¸€æ—¶é—´æˆ³æˆ–è€…åŒä¸€åŒºå—é«˜åº¦ä¸Šï¼Œæ²¡æœ‰åŒºå—ç”Ÿäº§è€…èƒ½å¤ŸåŒæ—¶åœ¨ä¸¤ä¸ªåŒºå—ä¸Šç­¾åã€‚ä¸€ä¸ªåŒºå—æœ‰äº†15ä¸ªåŒºå—ç”Ÿäº§è€…çš„ç­¾åï¼Œè¯¥åŒºå—å°±è¢«è®¤ä¸ºæ˜¯ä¸å¯é€†çš„ã€‚</p><h3 id="ç”Ÿæ€å»ºè®¾"><a href="#ç”Ÿæ€å»ºè®¾" class="headerlink" title="ç”Ÿæ€å»ºè®¾"></a>ç”Ÿæ€å»ºè®¾</h3><p>Block.oneå’ŒGalaxy Digitalå°†é€šè¿‡èµ„æœ¬åŒ–ä¸€ä¸ªæ–°çš„3.25äº¿ç¾å…ƒçš„<a href="https://link.zhihu.com/?target=http%3A//EOS.IO" target="_blank" rel="noopener">http://EOS.IO</a>ç”Ÿæ€ç³»ç»ŸåŸºé‡‘ï¼ˆâ€œåŸºé‡‘â€ï¼‰ï¼Œä¸ºæœªæ¥çš„æŠ•èµ„éƒ¨ç½²èµ„é‡‘ã€‚æ€»ä¹‹ä¸ç¼ºé’±ï¼Œè€Œä¸”ç›®å‰æœ‰å¤§é‡DAPPå·²ç»å®£å¸ƒåŠ å…¥EOSï¼Œæœ‰æ˜“ç”¨çš„é€šç”¨å¼€å‘æ¨¡å—ï¼ŒåŸºé‡‘æŠ•èµ„ï¼Œäººæ°”å¾ˆä¸é”™ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-1b8fb0ef655fcc6e3c70a8da6d3a379d_hd.jpg" alt="EOSçš„Dappç”Ÿæ€å›¾"></p>]]></content>
      
      
      <categories>
          
          <category> eos </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>zilliqa_network</title>
      <link href="/2019/10/14/zilliqa-network/"/>
      <url>/2019/10/14/zilliqa-network/</url>
      
        <content type="html"><![CDATA[<h2 id="Zilliqaç½‘ç»œåˆ†ç‰‡ç¯‡ç¿»è¯‘"><a href="#Zilliqaç½‘ç»œåˆ†ç‰‡ç¯‡ç¿»è¯‘" class="headerlink" title="Zilliqaç½‘ç»œåˆ†ç‰‡ç¯‡ç¿»è¯‘"></a>Zilliqaç½‘ç»œåˆ†ç‰‡ç¯‡ç¿»è¯‘</h2><p><a href="https://docs.zilliqa.com/whitepaper.pdf" target="_blank" rel="noopener">è‹±æ–‡ç‰ˆæœ¬</a></p><h3 id="åŒºå—"><a href="#åŒºå—" class="headerlink" title="åŒºå—"></a>åŒºå—</h3><p>ZILLIQAåè®®ä»‹ç»ä¸¤ç§ç±»å‹çš„åŒºå—ï¼ˆæ‰€ä»¥å­˜åœ¨ä¸¤æ¡é“¾ï¼‰ï¼šäº¤æ˜“åŒºå—(TX-Block)å’Œç›®å½•æœåŠ¡åŒºå—ï¼ˆDS-Blockï¼‰ã€‚TX-Blockè®°å½•ç”¨æˆ·çš„äº¤æ˜“ï¼ŒDS-Blockä¸ºå‚ä¸å…±è¯†åè®®çš„çŸ¿å·¥çš„å…ƒæ•°æ®ã€‚TX-Blockå­˜å‚¨è¢«DS-Blockä¸­çš„èŠ‚ç‚¹åŒæ„çš„äº¤æ˜“ï¼Œæ¯ä¸ªDS-Blockä¸å¤šä¸ªTX-Blocksç›¸å…³ã€‚</p><p>â€¦</p><h3 id="ç½‘ç»œå±‚"><a href="#ç½‘ç»œå±‚" class="headerlink" title="ç½‘ç»œå±‚"></a>ç½‘ç»œå±‚</h3><p>ZILLIQAè¢«è®¾è®¡æˆæ˜¯äº¤æ˜“ç‡æŒ‰æ¯”ä¾‹å†³å®šã€‚ä¸»è¦çš„æƒ³æ³•æ˜¯ï¼Œåˆ†ç‰‡ã€‚å³ï¼Œå°†æŒ–çŸ¿ç½‘ç»œåˆ†æˆå°åˆ†ç‰‡ï¼Œæ¯ä¸ªå°åˆ†ç‰‡å¤„ç†äº¤æ˜“æ˜¯å¹¶è¡Œçš„ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç½‘ç»œå’Œäº¤æ˜“åˆ†ç‰‡ã€‚</p><h4 id="ç½‘ç»œåˆ†ç‰‡"><a href="#ç½‘ç»œåˆ†ç‰‡" class="headerlink" title="ç½‘ç»œåˆ†ç‰‡"></a>ç½‘ç»œåˆ†ç‰‡</h4><p>ç½‘ç»œåˆ†ç‰‡ã€‚å°†æŒ–çŸ¿ç½‘ç»œåˆ†æˆå°åˆ†ç‰‡æ˜¯ä¸€ä¸ªä¸¤ä¸ªçš„è¿‡ç¨‹ï¼Œé¦–å…ˆï¼Œä¸€ç»„ä¸“ç”¨çš„ç§°ä¸ºç›®å½•æœåŠ¡å§”å‘˜ä¼šï¼ˆæˆ–DSå§”å‘˜ä¼šï¼‰çš„èŠ‚ç‚¹è¢«é€‰ä¸¾å‡ºæ¥ï¼Œç„¶åä»–ä»¬å°†å°†ç½‘ç»œå’ŒèŠ‚ç‚¹åˆ†åˆ°ä»–ä»¬çš„åˆ†ç‰‡ä¸­ã€‚åœ¨ä¸‹é¢ï¼Œå°†å…·ä½“ä»‹ç»ç»†èŠ‚ã€‚</p><ul><li><p>ç›®å½•æœåŠ¡å§”å‘˜ä¼šï¼ˆDirectory Service Committeeï¼‰ï¼šä¸ºäº†ä¿ƒè¿›ç½‘ç»œçš„åˆ‡åˆ†ï¼Œæˆ‘ä»¬é¦–å…ˆä¼šé€‰ä¸¾å‡ºä¸€ç»„èŠ‚ç‚¹ï¼Œæˆä¸ºç›®å½•æœåŠ¡(DS)èŠ‚ç‚¹ã€‚DSèŠ‚ç‚¹å½¢æˆä¸€ä¸ªDSå§”å‘˜ä¼šã€‚DSèŠ‚ç‚¹çš„é€‰ä¸¾æ˜¯åŸºäºproof-of-work1ç®—æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//Algorithm 1: PoW1 for DS committee election.</span><br><span class="line">Input: i: Current DS-epoch, DSiâˆ’1: Prev. DS committee</span><br><span class="line">composition.</span><br><span class="line">Output: header: DS-Block header.</span><br><span class="line"> On each competing node:</span><br><span class="line">// get epoch randomness from the DS blockchain</span><br><span class="line">// DBiâˆ’1: Most recent DS-Block before start of i-th epoch</span><br><span class="line"> r1 â† GetEpochRand(DBiâˆ’1)</span><br><span class="line">// get epoch randomness from the transaction blockchain</span><br><span class="line">// TBj : Most recent TX-Block before start of i-th epoch</span><br><span class="line"> r2 â† GetEpochRand(TBj )</span><br><span class="line">// pk: nodeâ€™s public key, IP = nodeâ€™s IP address</span><br><span class="line"> nonce, mixHash â† Ethash-PoW(pk, IP, r1, r2)</span><br><span class="line"> header â† BuildHeader(nonce, mixHash, pk)</span><br><span class="line">// header includes pk and nonce among other fields</span><br><span class="line">// IP, header is multicast to members in the DS committee</span><br><span class="line"> MulticastToDSiâˆ’1(IP, header)</span><br><span class="line"> return header</span><br></pre></td></tr></table></figure><p>æ¯”å…¶ä»–èŠ‚ç‚¹æ›´æ—©æˆåŠŸäº§ç”Ÿä¸€ä¸ªæœ‰æ•ˆçš„éšæœºæ•°çš„èŠ‚ç‚¹ï¼Œå°†ä¸ºæ–°å—æä¾›åŒºå—å¤´ã€‚å›æƒ³ä¸€ä¸‹DS-Blockå¤´å’Œç­¾åéƒ¨åˆ†ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹è§£å†³äº†POW1ï¼Œå®ƒä¾¿å¯ä»¥ç”Ÿäº§ä»…ä»…1ä¸ªåŒºå—å¤´ï¼ŒåŒºå—å¤´éšåä¼šè¢«å¤šç‚¹å¹¿æ’­ç»™DSå§”å‘˜ä¼šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒDSå§”å‘˜ä¼šå°†å¯¹äº§ç”Ÿçš„åŒºå—å¤´è¿›è¡Œå…±è¯†åç”Ÿæˆç­¾åéƒ¨åˆ†ã€‚2fä¸ªDSèŠ‚ç‚¹ç­¾åäº†åŒºå—å¤´ï¼Œè¿™ä¸ªåŒºå—ä¾¿è¢«ç¡®è®¤æ·»åŠ åˆ°DSåŒºå—é“¾ä¸­ã€‚</p><p> åœ¨æˆåŠŸå¼•å¯¼é˜¶æ®µåï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼Œè§„å®šDSèŠ‚ç‚¹çš„ç»„æˆä¸ºä¸€ä¸ªé¢„å®šä¹‰çš„çª—å£å¤§å°n0ã€‚åœ¨æœ€è¿‘n0èŠ‚ç‚¹ä¸­å¹¶æˆåŠŸæŒ–æ˜DS-Blockçš„èŠ‚ç‚¹å°†åŠ å…¥DSå§”å‘˜ä¼šã€‚</p><p>è¿ç»­æŒ–åˆ°ä¸¤ä¸ªDS-Blockä¹‹é—´çš„å¹³å‡æ—¶é—´ç§°ä¸ºDS-epochã€‚DS-eposhçš„å€¼çš„è®¾ç½®æ˜¯å‡å°ä¸¤ä¸ªç«äº‰å—å‡ ç‡çš„ä¸€ç§æ–¹æ³•ã€‚åœ¨DS-epochçš„å¼€å§‹ï¼Œä¸€ä¸ªæ–°çš„DSèŠ‚ç‚¹åŠ å…¥DSå§”å‘˜ç„¶åDSå§”å‘˜ä¼šä¸­æœ€è€çš„æˆå‘˜ä¼š<u>è¢«æŒ¤å‡º(åŸæ–‡ä¸ºis churned out..ä¸çŸ¥é“è¯¥æ€ä¹ˆç¿»è¯‘æ¯”è¾ƒå¥½)</u>ã€‚è¿™å›ºå®šäº†åœ¨DS-eposhæœŸé—´DSå§”å‘˜ä¼šçš„å¤§å°å§‹ç»ˆæ˜¯n0ã€‚DSå§”å‘˜ä¸­æœ€æ–°çš„æˆå‘˜å°†æˆä¸ºleader, å¹¶é¢†å¯¼è¯¥æ—¶æœŸçš„å…±è¯†åè®®ã€‚ è¿™è¿›ä¸€æ­¥å¯¼è‡´äº†DSå§”å‘˜ä¼šæˆå‘˜çš„ä¸¥æ ¼æ’åºã€‚</p><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œå¦‚æœDSå§”å‘˜ä¼šçš„è§„æ¨¡n0è¶³å¤Ÿå¤§ï¼ˆæ¯”å¦‚è¯´800ï¼‰ï¼Œé‚£ä¹ˆåœ¨n0ä¸ªå§”å‘˜ä¼šæˆå‘˜ä¸­ææœ‰å¯èƒ½æœ€å¤šæœ‰1/3æ˜¯æ‹œå åº­ã€‚</p></li><li><p>å†²çªè§£å†³ï¼šæˆ‘ä»¬çš„å…±è¯†åè®®ä¸å…è®¸åœ¨DSåŒºå—é“¾ä¸­åˆ†å‰ã€‚  å½“å¤šä¸ªèŠ‚ç‚¹å¤§è‡´åŒæ—¶è§£å†³éš¾é¢˜æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°åˆ†å‰ã€‚ ä¸ºäº†è§£å†³å†²çªï¼Œæ¯ä¸ªDSèŠ‚ç‚¹ä»æ¥æ”¶åˆ°çš„å¤´ä¸­æ£€ç´¢nonceå­—æ®µï¼Œå¹¶æŒ‰é€’å¢é¡ºåºå¯¹å®ƒä»¬è¿›è¡Œæ’åºã€‚ è®©æˆ‘ä»¬å‡è®¾ç¬¬iä¸ªDSèŠ‚ç‚¹çš„æœ€å¤§éšæœºæ•°æ˜¯max(nâ±)ã€‚</p><p>DSå§”å‘˜ä¼šçš„leaderç„¶åæå‡ºè‡ªå·±çš„headerï¼ˆå¯¹åº”äºä»–æ‰€è§è¿‡çš„æœ€å¤§éšæœºæ•°ï¼‰ï¼Œå¹¶è¿è¡Œä¸€è‡´çš„åè®®æ¥å°±DS-         Block headerè¾¾æˆä¸€è‡´ã€‚ åªæœ‰å½“ç›¸åº”çš„éšæœºæ•°å¤§äºæˆ–ç­‰äºmax(nâ±)æ—¶ï¼Œ<u>ç¬¬iä¸ªDSèŠ‚ç‚¹æ‰åŒæ„æ¥å—å»ºè®®çš„headerï¼ˆæ²¡ç†è§£ä¸Šï¼‰</u>ã€‚ ä¸€æ—¦è¾¾æˆå…±è¯†ï¼ŒDS-Blockçš„ç­¾åéƒ¨åˆ†å°±å»ºç«‹èµ·æ¥äº†ï¼Œç„¶åæˆä¸ºé¢†å¯¼è€…</p></li><li><p>åˆ†ç‰‡ç”Ÿæˆï¼šä¸€æ—¦é€‰å‡ºDSå§”å‘˜ä¼šï¼Œç½‘ç»œçš„å®é™…åˆ†ç‰‡å°±å¯ä»¥å¼€å§‹ã€‚ ä¸ºäº†ä½¿èŠ‚ç‚¹å‚ä¸ä¸‹é¢çš„å…±è¯†åè®®ï¼Œå®ƒå¿…é¡»æ‰§è¡Œå·¥ä½œè¯æ˜ï¼ˆPoW2ï¼‰ã€‚ åˆ†ç‰‡åè®®åœ¨æ¯ä¸ªDSæ—¶æœŸå¼€å§‹æ—¶é‡å¤ã€‚ ç®—æ³•2ç»™å‡ºäº†PoW2çš„ç®—æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Algorithm 2: PoW2 for shard membership.</span><br><span class="line">Input: i: Current DS-epoch, DSi: Current DS committee</span><br><span class="line">composition.</span><br><span class="line">Output: nonce, mixHash: outputs of Ethash-PoW</span><br><span class="line"> On each competing node:</span><br><span class="line">// get epoch randomness from the DS blockchain</span><br><span class="line">// DBiâˆ’1: Most recent DS-Block before start of i-th epoch</span><br><span class="line"> r â† GetEpochRand(DBi)</span><br><span class="line">// pk: nodeâ€™s public key, IP = nodeâ€™s IP address</span><br><span class="line"> nonce, mixHash â† Ethash-PoW(pk, IP, r)</span><br><span class="line">// IP, header is multicast to members in the DS committee</span><br><span class="line"> MulticastToDSi(nonce, mixHash, pk, IP)</span><br><span class="line"> return nonce, mixHash</span><br></pre></td></tr></table></figure><p>ç„¶åå°†è®¡ç®—å‡ºçš„PoW2çš„æœ‰æ•ˆéšæœºæ•°ï¼ˆå’Œæ··åˆæ•£åˆ—ï¼‰å¤šæ’­åˆ°DSå§”å‘˜ä¼šã€‚ DSèŠ‚ç‚¹å°†å…±åŒæ¥å—è¶³å¤Ÿçš„PoWè§£å†³æ–¹æ¡ˆï¼Œä»¥åˆ†è§£ä¸ºLä¸ªå…±è¯†å§”å‘˜ä¼šæˆ–åˆ†ç‰‡ï¼Œæ¯ä¸ªéƒ½å…·æœ‰n0ä¸ªèŠ‚ç‚¹ä»¥è¾¾æˆå…±è¯†ã€‚ä¸€æ—¦DSå§”å‘˜ä¼šè´Ÿè´£äººæ”¶åˆ°è¶³å¤Ÿæ•°é‡çš„PoW2è§£å†³æ–¹æ¡ˆï¼Œä»–å°±å¯åŠ¨ä¸€ä¸ªåå•†ä¸€è‡´çš„åè®®ï¼Œä»¥å°±è¯¥ç»„æœ‰æ•ˆçš„PoW2è§£å†³æ–¹æ¡ˆè¾¾æˆä¸€è‡´ã€‚åœ¨å…±è¯†åè®®ç»“æŸæ—¶ï¼Œleaderç”Ÿæˆç”±DSèŠ‚ç‚¹ç­¾åçš„EC-Schnorrå¤šé‡ç­¾åã€‚ä¸ºäº†è¿›ä¸€æ­¥è¿›è¡Œä¸‹å»ï¼Œè¶…è¿‡2/3çš„DSèŠ‚ç‚¹å¿…é¡»åŒæ„ä¸€ç»„å¯æ¥å—çš„PoW2è§£å†³æ–¹æ¡ˆã€‚<br>Shardingåˆ©ç”¨ç¡®å®šæ€§å‡½æ•°å°†èŠ‚ç‚¹åˆ†é…ç»™åˆ†ç‰‡ã€‚è®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬éœ€è¦æ¯ä¸ªéƒ½æœ‰n0ä¸ªèŠ‚ç‚¹çš„ç¢ç‰‡ã€‚éšæœºæ•°å€¼æŒ‰å‡åºæ’åºï¼Œç¬¬ä¸€ä¸ªæœ‰n0ä¸ªèŠ‚ç‚¹çš„èŠ‚ç‚¹ä»¬è¢«åˆ†é…ç»™ç¬¬ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¸‹ä¸€ä¸ªn0åˆ†é…åˆ°ä¸‹ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¾æ­¤ç±»æ¨ã€‚åœ¨ç¢ç‰‡ä¸­æå‡ºæœ€å¤§éšæœºæ•°çš„çŸ¿å·¥çš„èº«ä»½è¢«å®£å¸ƒä¸ºleaderã€‚è¿™è¿›ä¸€æ­¥è¯±å¯¼äº†å¯¹åˆ†ç‰‡æˆå‘˜çš„ä¸¥æ ¼æ’åºã€‚ä¹Ÿå¯ä»¥è¡¨æ˜ï¼Œå¦‚æœn0è¶³å¤Ÿå¤§ï¼ˆæ¯”å¦‚800ä»¥ä¸Šï¼‰ï¼Œé‚£ä¹ˆåœ¨æ¯ä¸ªç¢ç‰‡å†…è‡³å¤šæœ‰1/3ä¸ªæ˜¯å…·æœ‰é«˜æ¦‚ç‡çš„æ‹œå åº­</p></li></ul><h4 id="å…¬å…±ä¿¡é“"><a href="#å…¬å…±ä¿¡é“" class="headerlink" title="å…¬å…±ä¿¡é“"></a>å…¬å…±ä¿¡é“</h4><p>DSèŠ‚ç‚¹åœ¨å…¬å…±ä¿¡é“ä¸Šå‘å¸ƒæŸäº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬DSèŠ‚ç‚¹çš„èº«ä»½å’Œè¿æ¥ä¿¡æ¯ï¼Œæ¯ä¸ªåˆ†ç‰‡ä¸­çš„èŠ‚ç‚¹åˆ—è¡¨ä»¥åŠäº¤æ˜“çš„åˆ†ç‰‡é€»è¾‘ï¼ˆåœ¨ç¬¬V-DèŠ‚ä¸­è§£é‡Šï¼‰ã€‚ å…¬å…±é¢‘é“ä¸å¯ä¿¡ï¼Œå¹¶å‡å®šæ‰€æœ‰èŠ‚ç‚¹å‡å¯è®¿é—®ã€‚ åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çš„å¹¿æ’­åŸè¯­å®ç°äº†è¿™æ ·çš„å…¬å…±é¢‘é“ã€‚ æˆ‘ä»¬åŒºå—é“¾çš„ç”¨æˆ·æƒ³è¦æäº¤äº¤æ˜“ä»¥è¿›è¡Œæ¥å—ï¼Œç„¶åå¯ä»¥æ£€æŸ¥åˆ†ç‰‡ä¿¡æ¯ä»¥è·å–è´Ÿè´£å¤„ç†å…¶äº¤æ˜“çš„ç¢ç‰‡ã€‚ åœ¨å…¬å…±é¢‘é“ä¸Šå‘å¸ƒçš„ä¿¡æ¯é¢„è®¡å°†ç”±ä»»ä½•èŠ‚ç‚¹æˆ–ç”¨æˆ·å¯éªŒè¯çš„DSèŠ‚ç‚¹çš„2/3ä»¥ä¸Šè¿›è¡Œç­¾åã€‚</p><h4 id="æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA"><a href="#æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA" class="headerlink" title="æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA"></a>æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA</h4><p>å¯¹äºæ–°èŠ‚ç‚¹åŠ å…¥ç½‘ç»œï¼Œå®ƒå¯ä»¥å°è¯•è§£å†³PoW1æˆä¸ºDSèŠ‚ç‚¹æˆ–PoW2æˆä¸ºåˆ†ç‰‡çš„æˆå‘˜ã€‚ ä¸ºæ­¤ï¼Œå®ƒéœ€è¦ä»åŒºå—é“¾è·å¾—å…³äºPoW1æˆ–PoW2æ‰€éœ€çš„éšæœºæ€§çš„ä¿¡æ¯ã€‚ ä¸€æ—¦è·å¾—äº†éšæœºæ€§ä¿¡æ¯ï¼Œæ–°èŠ‚ç‚¹å°±å¯ä»¥å°†å…¶è§£å†³æ–¹æ¡ˆæäº¤ç»™DSå§”å‘˜ä¼šã€‚</p><h4 id="äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹"><a href="#äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹" class="headerlink" title="äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹"></a>äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹</h4><p>å¦‚ä»¥ä¸Šæ‰€è¿°ï¼Œç½‘ç»œåˆ†ç‰‡åˆ›å»ºäº†æ¯ä¸ªèƒ½å¤Ÿå¹¶è¡Œå¤„ç†äº¤æ˜“çš„åˆ†ç‰‡ã€‚ åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç‰¹å®šäº¤æ˜“å¦‚ä½•åˆ†é…ç»™åˆ†ç‰‡ä»¥åŠå¦‚ä½•å¤„ç†äº¤æ˜“ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æŠ½è±¡ï¼šA -â¿-&gt;Bæ¥æŒ‡ç¤ºä»å‘ä»¶äººè´¦æˆ·Aåˆ°æ”¶ä»¶äººè´¦æˆ·Bçš„nä¸ªZILçš„äº¤æ˜“</p><ul><li><p>äº¤æ˜“åˆ†é…ï¼šä»»ä½•äº¤æ˜“éƒ½è¡¨ç¤ºA -â¿-&gt;Bè¢«å•ä¸ªåˆ†ç‰‡å¤„ç†ã€‚ å‡è®¾æœ‰Lä¸ªåˆ†ç‰‡ï¼Œç¼–å·ä¸º0åˆ°L-1ï¼Œäº‹åŠ¡è¢«åˆ†é…åˆ°ç”±å‘é€è€…åœ°å€çš„(logâ‚‚L + 1)å³è¾¹çš„ä½ï¼ˆbitï¼‰æ ‡è¯†çš„ç¢ç‰‡ã€‚å³ï¼Œå®ä¾‹ä¸­Açš„è´¦æˆ·åœ°å€ã€‚å› ä¸ºè´¦æˆ·åœ°å€æ˜¯ä¸€ä¸ª160ä½(bit)çš„æ•´å‹æ•°æ®ï¼Œæ‰€ä»¥Lçš„èŒƒå›´åº”è¯¥ä¸º<strong>logâ‚‚L + 1 â‰¤ 160</strong>ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒä¼šå°äº100ã€‚</p><p>ä¸€æ—¦è¯†åˆ«äº†åˆ†é…çš„åˆ†ç‰‡ï¼Œäº‹åŠ¡å°±ä¼šè¢«å¤šæ’­åˆ°åˆ†ç‰‡ä¸­çš„ä¸€äº›èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ç„¶åå†è¿›ä¸€æ­¥å¹¿æ’­å®ƒã€‚ ä¸€æ—¦äº¤æ˜“åˆ°è¾¾æŒ‡å®šåˆ†ç‰‡çš„é¢†å¯¼è€…ï¼Œå®ƒå°†æŠŠäº¤æ˜“åŒ…å«åœ¨TX-Blockä¸­å¹¶è¿è¡Œå…±è¯†åè®®ã€‚</p><p>åŒèŠ±ï¼ˆæˆ–é‡æ’­æ”»å‡»ï¼‰å¯ä»¥ä½¿ç”¨æ¯ç¬”äº¤æ˜“ä¸­çš„éšæœºæ•°è½»æ¾æ£€æµ‹ã€‚ å›æƒ³ä¸€ä¸‹ï¼Œæ¯ç¬”äº¤æ˜“éƒ½æœ‰ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨äºç»Ÿè®¡å‘ä»¶äººå¸æˆ·å‘é€çš„äº¤æ˜“æ•°é‡ã€‚ ä¸€æ—¦äº¤æ˜“è¿›å…¥äº¤æ˜“åŒºå—é“¾ï¼Œnonceåœ¨è´¦æˆ·çŠ¶æ€ä¸­æ›´æ–°ï¼Œä»è€Œå¤„äºå…¨å±€çŠ¶æ€ã€‚ å½“å‰å€¼å°äºæˆ–ç­‰äºå…¨å±€çŠ¶æ€å½“å‰å€¼çš„äº¤æ˜“è¢«çŸ¿å·¥æ‹’ç»ã€‚ æ ¹æ®å‘ä»¶äººçš„å¸æˆ·åœ°å€æœ¬åœ°åˆ†ç‰‡äº¤æ˜“å…è®¸åˆ†ç‰‡æˆå‘˜æ£€æµ‹åŒå€æ”¯å‡ºï¼Œå› ä¸ºå‘ä»¶äººçš„æ¯ä¸ªäº¤æ˜“éƒ½å°†åœ¨åŒä¸€åˆ†ç‰‡ä¸­å¤„ç†ã€‚</p></li><li><p>äº¤æ˜“å¤„ç†ï¼šå§”å‘˜ä¼šå†…çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ä»¥æå‡ºäº¤æ˜“ã€‚è¿™äº›äº¤æ˜“è¢«å‘é€ç»™é¢†å¯¼è€…ä»¥è¿è¡Œä¸€ç»„åè®®ï¼Œå…¶ä¸­ä¸€ç»„äº¤æ˜“å½¢æˆä¸‹ä¸€ä¸ªTXå—ã€‚ç”±æ¯ä¸ªåˆ†ç‰‡å»ºè®®çš„å—ç§°ä¸ºå¾®å—ï¼ˆç”±ç±»å‹æ ‡è®°0x00æ ‡è¯†ï¼‰ã€‚ä¸€ä¸ªå¾®å—åŒ…å«EC-Schnorrå¤šé‡ç­¾åï¼Œç”±åˆ†ç‰‡ä¸­çš„2/3ä¸ªèŠ‚ç‚¹ç»„æˆã€‚leaderè¿˜å»ºç«‹ä¸€ä¸ªæ ‡è¯†ç­¾åè€…å…¬é’¥çš„ä½å›¾Bã€‚å¦‚æœåˆ†ç‰‡çš„ç¬¬iä¸ªæˆå‘˜ç­¾ç½²äº†TX-Blockå¤´éƒ¨ï¼Œåˆ™B [i] = 1ã€‚å½“ä¸€ä¸ªåˆ†ç‰‡åœ¨TXå—ä¸Šè¾¾æˆå…±è¯†æ—¶ï¼Œå…¶é¢†å¯¼è€…å°†å—å¤´å’Œç­¾åå¤šæ’­ç»™ä¸€äº›DSèŠ‚ç‚¹ã€‚ DSèŠ‚ç‚¹ç„¶ååœ¨DSå§”å‘˜ä¼šå†…å¹¿æ’­å®ƒï¼Œä»¥ä¾¿è¯¥å—åˆ°è¾¾å…¶é¢†å¯¼è€…ã€‚å—çš„æ•°æ®éƒ¨åˆ†å¯ä»¥å¼‚æ­¥å‘é€åˆ°èŠ‚ç‚¹ã€‚ DSå§”å‘˜ä¼šç„¶åæ±‡é›†ä»ç¢ç‰‡å‘é€çš„æ‰€æœ‰å—ï¼Œå¹¶ä¸”åœ¨å®ƒä»¬ä¹‹é—´è¿è¡Œå¦ä¸€è½®å…±è¯†åè®®ä»¥è¾¾æˆæœ€ç»ˆå—ã€‚æœ€åçš„å—æ˜¯ç”±ç±»å‹æ ‡è®°0x01æ ‡è¯†çš„TXå—ã€‚æœ€åä¸€ä¸ªå—åŒ…å«æ¥è‡ªDSå§”å‘˜ä¼šçš„è¶…è¿‡2/3ä¸ªn0èŠ‚ç‚¹çš„EC-Schnorrå¤šé‡ç­¾åã€‚ DSå§”å‘˜ä¼šçš„leaderè¿˜æ„å»ºäº†ä¸€ä¸ªä½å›¾Bï¼Œç”¨äºæ ‡è¯†ç­¾åè€…çš„å…¬é’¥ã€‚å¦‚æœDSå§”å‘˜ä¼šçš„ç¬¬iä¸ªæˆå‘˜ç­¾ç½²äº†TX-Blockæ ‡é¢˜ï¼Œåˆ™B [i] = 1ã€‚æœ€åçš„å—å¤´å’Œç­¾åï¼Œç„¶åè¢«ç»„æ’­åˆ°æ¯ä¸ªåˆ†ç‰‡ä¸­çš„ä¸€äº›èŠ‚ç‚¹ã€‚å®é™…çš„TXå—æ•°æ®ä¸æ˜¯ç”±DSèŠ‚ç‚¹å‘é€çš„ã€‚</p><p>åœ¨æ¯ä¸ªåˆ†ç‰‡ä¸­ï¼Œé‡‡å–ä»¥ä¸‹æ­¥éª¤æ¥å¤„ç†æœ€ç»ˆçš„å—:</p><ol><li>åˆ†ç‰‡ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨DSèŠ‚ç‚¹çš„å…¬é’¥éªŒè¯EC-Schnorrå¤šé‡ç­¾åã€‚ å¦‚æœç­¾åå¯¹ç”±ä½å›¾è¡¨ç¤ºçš„è¶…è¿‡2/3ä¸ªn0å…¬é’¥æœ‰æ•ˆï¼Œåˆ™èŠ‚ç‚¹æ‰§è¡Œä¸‹ä¸€ä¸ªæ£€æŸ¥ã€‚</li><li>å¯¹äºåŒ…å«åœ¨æœ€ç»ˆå—å¤´ä¸­çš„æ¯ä¸ªäº¤æ˜“hashï¼ŒèŠ‚ç‚¹æ£€æŸ¥å…¶ç›¸åº”çš„äº¤æ˜“å†…å®¹æ˜¯å¦å¯ç”¨ã€‚ å¦‚æœç›¸åº”çš„äº¤æ˜“ç”±èŠ‚ç‚¹æ‰€å±çš„åˆ†ç‰‡æå‡ºï¼Œåˆ™å°†äº¤æ˜“æ•°æ®çš„æ•£åˆ—ä¸åŒ…å«åœ¨æœ€åå—headerä¸­çš„æ•£åˆ—è¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æœäº¤æ˜“æ˜¯ç”±å¦ä¸€ä¸ªåˆ†ç‰‡æå‡ºçš„ï¼Œåˆ™äº¤æ˜“æ•°æ®è·¨åˆ†ç‰‡å¼‚æ­¥å…±äº«</li><li>ä¸€æ—¦äº¤æ˜“æ•°æ®å¯ç”¨ï¼Œæœ€ç»ˆå—çš„dataéƒ¨åˆ†è¢«é‡æ„å¹¶ä¸”TXå—è¢«é™„åŠ åˆ°æœ¬åœ°äº¤æ˜“åŒºå—é“¾ã€‚ è´¦æˆ·çŠ¶æ€å’Œå…¨å±€çŠ¶æ€ç›¸åº”åœ°è¢«æ›´æ–°ã€‚</li><li>å¦‚æœäº¤æ˜“å†…å®¹ä¸å¯ç”¨ï¼Œåˆ™èŠ‚ç‚¹åœ¨å…¶æœ¬åœ°è´¦æˆ·è§†å›¾ä¸­ä¸´æ—¶ä½¿è¯¥äº¤æ˜“çš„å‘é€è´¦æˆ·å¤±æ•ˆï¼Œä»¥ä¾¿è¯¥è´¦æˆ·çš„ä»»ä½•å…¶ä»–æœªå†³äº¤æ˜“è¢«æ‹’ç»ï¼Œç›´åˆ°æœ¬åœ°äº¤æ˜“å†…å®¹å¯ä»¥ä¸å…¨å±€çŠ¶æ€åŒæ­¥ã€‚ è¿™äº›è¢«æ‹’ç»çš„äº‹åŠ¡å°†ä¸å¾—ä¸ç”±å‘é€èŠ‚ç‚¹é‡è¯•</li></ol></li></ul><h3 id="å…±è¯†å±‚"><a href="#å…±è¯†å±‚" class="headerlink" title="å…±è¯†å±‚"></a>å…±è¯†å±‚</h3><p>å¦‚ä»¥ä¸Šæåˆ°çš„ï¼Œæ¯ä¸ªåˆ†ç‰‡å’ŒDSå§”å‘˜ä¼šéœ€è¦åˆ†åˆ«åœ¨å¾®å—å’Œç»ˆå—ä¸Šè·‘ä¸€ä¸ªå…±è¯†åè®®ã€‚åœ¨è¿™ä¸€å—ï¼Œæˆ‘ä»¬å°†å±•ç¤ºåœ¨æ¯ä¸€ä¸ªåˆ†ç‰‡å’ŒDSå§”å‘˜ä¼šä¸­å®šä¹‰çš„å…±è¯†åè®®çš„å…±è¯†å±‚ã€‚åœ¨è®¨è®ºä¸­ï¼Œæˆ‘ä»¬å°†åˆ†ç‰‡å’ŒDSå§”å‘˜ä¼šä»£æŒ‡ä¸ºå…±è¯†ç»„ã€‚</p><h5 id="å®ç”¨æ‹œå åº­å®¹é”™"><a href="#å®ç”¨æ‹œå åº­å®¹é”™" class="headerlink" title="å®ç”¨æ‹œå åº­å®¹é”™"></a>å®ç”¨æ‹œå åº­å®¹é”™</h5><p>ZILLIQAå…±è¯†åè®®çš„æ ¸å¿ƒä¾èµ–äºå®ç”¨æ‹œå åº­å®¹é”™(PBFT)åè®®ã€‚ç„¶è€Œæˆ‘ä»¬é€šè¿‡åœ¨PBFTä¸­ä½¿ç”¨EC-Schnorrå¤šç­¾åæ¥æå‡æ•ˆç‡ã€‚EC-Schnorrå¤šé‡ç­¾åçš„ä½¿ç”¨å°†æ­£å¸¸æƒ…å†µä¸‹çš„é€šä¿¡å»¶è¿Ÿä»O(n*n)é™ä½ä¸ºO(n)ï¼Œå¹¶å°†ç­¾åå¤§å°ä»O(n)å‡å°åˆ°O(1)ï¼Œå…¶ä¸­næ˜¯å…±è¯†ç»„çš„å¤§å°ã€‚ åœ¨è¿™ä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬æä¾›PBFTçš„æ¦‚è¿°ã€‚</p><p>åœ¨PBFTä¸­ï¼Œå…±è¯†ç»„å†…çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‰é¡ºåºæ’åˆ—ï¼Œå®ƒæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼ˆæˆ–é¢†å¯¼è€…ï¼‰ï¼Œå…¶ä»–èŠ‚ç‚¹ç§°ä¸ºå¤‡ä»½èŠ‚ç‚¹ã€‚ æ¯è½®PBFTéƒ½æœ‰ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹æ‰€è¿°ï¼š</p><ul><li>é¢„å‡†å¤‡é˜¶æ®µ:  åœ¨è¿™ä¸ªé˜¶æ®µï¼Œé¢†å¯¼è€…å®£å¸ƒè¯¥å°ç»„å°†åº”è¯¥è¾¾æˆä¸€è‡´å…±è¯†çš„ä¸‹ä¸€ä¸ªè®°å½•ï¼ˆåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­æ˜¯TX-Blockï¼‰</li><li>å‡†å¤‡é˜¶æ®µï¼šåœ¨æ¥æ”¶åˆ°é¢„å…ˆå‡†å¤‡æ¶ˆæ¯åï¼Œæ¯ä¸ªèŠ‚ç‚¹éªŒè¯å…¶æ­£ç¡®æ€§å¹¶å°†å‡†å¤‡æ¶ˆæ¯å¤šæ’­ç»™æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹</li><li>æäº¤é˜¶æ®µï¼šåœ¨æ”¶åˆ°è¶…è¿‡2/3*nå‡†å¤‡æ¶ˆæ¯æ—¶ï¼ŒèŠ‚ç‚¹å‘ç»„æ’­ç»„å‘é€æäº¤æ¶ˆæ¯ã€‚æœ€åï¼ŒèŠ‚ç‚¹ç­‰å¾…è¶…è¿‡2/3*nçš„æäº¤æ¶ˆæ¯ï¼Œä»¥ç¡®ä¿æœ‰è¶³å¤Ÿæ•°é‡çš„èŠ‚ç‚¹åšå‡ºç›¸åŒçš„å†³å®šã€‚ å› æ­¤ï¼Œæ‰€æœ‰è¯šå®çš„èŠ‚ç‚¹éƒ½æ¥å—ç›¸åŒçš„æœ‰æ•ˆè®°å½•ã€‚</li></ul><p>PBFTä¾é æ­£ç¡®çš„é¢†å¯¼è€…å¼€å§‹æ¯ä¸ªé˜¶æ®µï¼Œå¹¶åœ¨è¶³å¤Ÿå¤šèŠ‚ç‚¹å­˜åœ¨æ—¶ç»§ç»­è¿›è¡Œã€‚ å¦‚æœé¢†å¯¼æ˜¯æ‹œå åº­ï¼Œå®ƒå¯èƒ½ä¼šæ‹–å»¶æ•´ä¸ªå…±è¯†åè®®ã€‚ ä¸ºäº†åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼ŒPBFTæä¾›äº†è§†å›¾æ›´æ”¹åè®®æ¥ä½¿ç”¨å¦ä¸€ä¸ªå–ä»£æ‹œå åº­é¢†è¢–ã€‚ å¦‚æœèŠ‚ç‚¹åœ¨æœ‰é™çš„æ—¶é—´å†…æ²¡æœ‰çœ‹åˆ°ä»»ä½•è¿›å±•ï¼Œä»–ä»¬å¯ä»¥ç‹¬ç«‹å®£å¸ƒæ”¹å˜é¢†å¯¼è€…çš„æ„¿æœ›ã€‚ å¦‚æœè¶…è¿‡2/3*nä¸ªèŠ‚ç‚¹çš„æ³•å®šäººæ•°å†³å®šé¢†å¯¼è€…æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨å·²çŸ¥è®¡åˆ’ä¸­çš„ä¸‹ä¸€ä¸ªé¢†å¯¼è€…å°±ä¼šæ¥ç®¡ã€‚</p><p> ç”±äºåœ¨å‡†å¤‡/æäº¤é˜¶æ®µæ¯ä¸ªèŠ‚ç‚¹çš„å¤šæ’­ï¼Œæ­£å¸¸æƒ…å†µä¸‹PBFTçš„é€šä¿¡å¤æ‚åº¦ä¸ºOï¼ˆn*nï¼‰</p><h5 id="æé«˜æ•ˆç‡"><a href="#æé«˜æ•ˆç‡" class="headerlink" title="æé«˜æ•ˆç‡"></a>æé«˜æ•ˆç‡</h5><p>ç»å…¸çš„PBFTä½¿ç”¨æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰è¿›è¡ŒèŠ‚ç‚¹ä¹‹é—´çš„è®¤è¯é€šä¿¡ã€‚ ç”±äºMACéœ€è¦åœ¨æ¯ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´å…±äº«å¯†é’¥ï¼Œæ‰€ä»¥ä¸€ä¸ªå…±è¯†ç»„ä¸­çš„èŠ‚ç‚¹å¯ä»¥åœ¨åŒä¸€ä¸ªè®°å½•ä¸Šè¾¾æˆä¸€è‡´ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„é€šä¿¡å¤æ‚åº¦ä¸ºOï¼ˆn*nï¼‰ã€‚ ç”±äºäºŒæ¬¡å¤æ‚æ€§ï¼Œå½“å§”å‘˜ä¼šæœ‰20å¤šä¸ªèŠ‚ç‚¹æ—¶ï¼ŒPBFTå˜å¾—ä¸åˆ‡å®é™…ã€‚</p><p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¥æºäºByzCoinçš„æƒ³æ³•ï¼š</p><ul><li>æˆ‘ä»¬ç”¨æ•°å­—ç­¾åæ›¿æ¢MACæ¥æœ‰æ•ˆåœ°å‡å°‘Oï¼ˆnï¼‰çš„é€šä¿¡å¼€é”€ã€‚</li><li>ä¸æ­¤åŒæ—¶ï¼Œä¸ºäº†è®©å…¶ä»–èŠ‚ç‚¹èƒ½å¤ŸéªŒè¯åè®®ï¼Œä¸€ç§å…¸å‹çš„æ–¹æ³•æ˜¯ä»è¯šå®çš„å¤šæ•°æ”¶é›†ç­¾åå¹¶å°†å®ƒä»¬é™„åŠ åˆ°åè®®ä¸­ï¼Œä»è€Œå¯¼è‡´åå•†è§„æ¨¡ä¸åå•†ç»„çš„å¤§å°æˆçº¿æ€§å…³ç³»ã€‚ ä¸ºäº†æ”¹å–„è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨EC-Schnorrå¤šé‡ç­¾åæ¥å°†å‡ ä¸ªç­¾åèšåˆæˆOï¼ˆ1ï¼‰ - å¤§å°å¤šé‡ç­¾å</li></ul><p>ç„¶è€Œï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨PBFTè®¾ç½®ä¸­ä½¿ç”¨ç»å…¸çš„EC-Schnorrå¤šé‡ç­¾åæ–¹æ¡ˆã€‚ è¿™æ˜¯å› ä¸ºåœ¨å¤å…¸è®¾ç½®ä¸­ï¼Œæ‰€æœ‰ç­¾åè€…éƒ½åŒæ„ç­¾ç½²ç»™å®šçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ç­¾ååªæœ‰åœ¨æ‰€æœ‰ç­¾åè€…éƒ½ç­¾ååæ‰æœ‰æ•ˆã€‚ åœ¨PBFTè®¾ç½®ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å…±è¯†ç»„ä¸­è¶…è¿‡2/3*nä¸ªèŠ‚ç‚¹ç­¾ç½²æ¶ˆæ¯ã€‚ æ‰€éœ€çš„ä¸»è¦ä¿®æ”¹ä¹‹ä¸€æ˜¯ä¸ºå‚ä¸ç­¾åè¿‡ç¨‹çš„ç­¾åè€…ç»´æŠ¤ä½å›¾B. å¦‚æœç¬¬iä¸ªèŠ‚ç‚¹å‚ä¸è¯¥è¿‡ç¨‹ï¼Œåˆ™B [i] = 1ï¼Œå¦åˆ™ä¸º0ã€‚ä½å›¾ç”±é¢†å¯¼è€…æ„å»ºã€‚ ä½å›¾å¯ä»¥è¢«ä»»ä½•éªŒè¯è€…ç”¨æ¥éªŒè¯ç­¾åã€‚ æœ€ç»ˆçš„åè®®ç•™åœ¨é™„å½•Bä¸­ã€‚</p><h5 id="Zilliqaå…±è¯†"><a href="#Zilliqaå…±è¯†" class="headerlink" title="Zilliqaå…±è¯†"></a>Zilliqaå…±è¯†</h5><p>åœ¨ZILLIQAä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨PBFTä½œä¸ºåŸºç¡€å…±è¯†åè®®ï¼Œå¹¶é‡‡ç”¨ä¸¤è½®EC-Schnorrå¤šé‡ç­¾åæ¥æ›¿æ¢PBFTä¸­çš„å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µã€‚ ä¸‹é¢å°†è§£é‡Šå¯¹PBFTé˜¶æ®µçš„ä¸åŒä¿®æ”¹ã€‚</p><ul><li>é¢„å‡†å¤‡é˜¶æ®µ: ä¸æ ‡å‡†PBFTä¸­ä¸€æ ·ï¼Œé¢†å¯¼è€…å°†TX-Blockæˆ–å£°æ˜ï¼ˆç”±é¢†å¯¼è€…ç­¾åï¼‰åˆ†å‘ç»™å…±è¯†ç»„ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</li><li>å‡†å¤‡é˜¶æ®µï¼šæ‰€æœ‰è¯šå®çš„èŠ‚ç‚¹æ£€æŸ¥TXå—çš„æœ‰æ•ˆæ€§ï¼Œå¹¶ä¸”é¢†å¯¼è€…æ”¶é›†æ¥è‡ªè¶…è¿‡2/3*nä¸ªèŠ‚ç‚¹çš„å“åº”ã€‚ è¿™ä¿è¯é¢†å¯¼è€…æå‡ºçš„é™ˆè¿°æ˜¯å®‰å…¨çš„å¹¶ä¸”ä¸ä»¥å‰çš„æ‰€æœ‰å†å²ä¸€è‡´ã€‚ ç­¾åæ˜¯ä½¿ç”¨EC-Schnorrå¤šé‡ç­¾åç”Ÿæˆçš„ã€‚ é¢†å¯¼è€…è¿˜æ„å»ºç­¾ç½²TXå—çš„èŠ‚ç‚¹çš„ä½å›¾</li><li>æäº¤é˜¶æ®µï¼šä¸ºäº†ç¡®ä¿è¶…è¿‡2/3*nçš„èŠ‚ç‚¹çŸ¥é“è¶…è¿‡2/3*nèŠ‚ç‚¹éªŒè¯äº†TX-Blockçš„äº‹å®ã€‚æˆ‘ä»¬è¿›è¡Œç¬¬äºŒè½®EC-Schnorrå¤šé‡ç­¾åã€‚ æ­£åœ¨ç­¾ç½²çš„å£°æ˜æ˜¯ä¸Šä¸€è½®ç”Ÿæˆçš„å¤šé‡ç­¾åã€‚</li></ul><p>åœ¨ä¸‰ä¸ªé˜¶æ®µç»“æŸæ—¶ï¼Œå°±é¢†å¯¼è€…æå‡ºçš„TX-Blockå°†è¾¾æˆå…±è¯†ã€‚</p><h5 id="é¢†å¯¼è€…æ”¹å˜"><a href="#é¢†å¯¼è€…æ”¹å˜" class="headerlink" title="é¢†å¯¼è€…æ”¹å˜"></a>é¢†å¯¼è€…æ”¹å˜</h5><p>åœ¨æˆ‘ä»¬çš„å…±è¯†åè®®ä¸­ï¼Œå¦‚æœé¢†å¯¼è€…æ˜¯è¯šå®çš„ï¼Œå®ƒå¯ä»¥ä¸æ–­çš„æ¨åŠ¨å…±è¯†å°ç»„ä¸­çš„èŠ‚ç‚¹å°±æ–°çš„äº¤æ˜“è¾¾æˆåè®®ã€‚ ä½†æ˜¯ï¼Œå¦‚æœé¢†å¯¼æ˜¯æ‹œå åº­ï¼Œå®ƒå¯ä»¥æœ‰æ„åœ°å»¶è¿Ÿæˆ–ä¸¢å¼ƒæ¥è‡ªè¯šå®èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼Œå¹¶å‡æ…¢åè®®ã€‚ ä¸ºäº†æƒ©ç½šè¿™äº›æ¶æ„é¢†å¯¼è€…ï¼Œæˆ‘ä»¬çš„åè®®ä¼šå®šæœŸæ›´æ”¹æ¯ä¸ªåˆ†ç‰‡çš„é¢†å¯¼å’ŒDSå§”å‘˜ä¼šã€‚ è¿™å¯ä»¥é˜²æ­¢æ‹œå åº­é¢†è¢–åœ¨æ— é™æœŸçš„æ—¶é—´å†…æ‹–å»¶å…±è¯†åè®®ã€‚ ç”±äºæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯æœ‰åºçš„ï¼Œä¸‹ä¸€ä¸ªé¢†å¯¼è€…å°†ä»¥å¾ªç¯æ–¹å¼é€‰æ‹©ã€‚</p><p> äº‹å®ä¸Šï¼Œæ¯ä¸€ä¸ªå¾®å—ååˆ†ç‰‡çš„é¢†å¯¼è€…éƒ½ä¼šæ”¹å˜ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæœ€åä¸€ä¸ªåŒºå—ä¹‹åDSå§”å‘˜ä¼šçš„é¢†å¯¼è€…ä¹Ÿä¼šæ›´æ”¹ã€‚ è®©æˆ‘ä»¬å‡è®¾å…±è¯†ç»„çš„å¤§å°ä¸ºnï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªDS-epochæ—¶æœŸå†…ï¼Œæˆ‘ä»¬å…è®¸çš„æœ€ç»ˆå—çš„æœ€å¤§å€¼ä¸ºnï¼Œæ¯ä¸ªæœ€ç»ˆå—æœ€å¤šåœ¨1ä¸ªåˆ†ç‰‡èšåˆ1ä¸ªå¾®å—ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> zilliqa </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>zilliqa</title>
      <link href="/2019/10/14/zilliqa/"/>
      <url>/2019/10/14/zilliqa/</url>
      
        <content type="html"><![CDATA[<h2 id="Zilç™½çš®ä¹¦ç¿»è¯‘"><a href="#Zilç™½çš®ä¹¦ç¿»è¯‘" class="headerlink" title="Zilç™½çš®ä¹¦ç¿»è¯‘"></a>Zilç™½çš®ä¹¦ç¿»è¯‘</h2><p>æ‰©å¤§ååé‡çš„å…³é”®æ˜¯ç½‘ç»œå’Œå…±è¯†åè®®çš„è®¾è®¡ã€‚</p><h4 id="åŠ å¯†å±‚"><a href="#åŠ å¯†å±‚" class="headerlink" title="åŠ å¯†å±‚"></a>åŠ å¯†å±‚</h4><p>å¯†ç å±‚å®šä¹‰äº†ZILLIQAä¸­ä½¿ç”¨çš„å¯†ç åŸºç¡€ã€‚ ä¸å…¶ä»–å‡ ä¸ªåŒºå—é“¾å¹³å°ç±»ä¼¼ï¼ŒZILLIQAä¾é æ¤­åœ†æ›²çº¿å¯†ç å­¦è¿›è¡Œæ•°å­—ç­¾åï¼Œå¹¶ä½¿ç”¨å†…å­˜ç¡¬æ•£åˆ—å‡½æ•°è¿›è¡Œæ ¡å¯¹ï¼ˆPoWï¼‰ã€‚ åœ¨æ•´ä¸ªç™½çš®ä¹¦ä¸­ï¼Œæˆ‘ä»¬å¹¿æ³›ä½¿ç”¨SHA3 [6]æ•£åˆ—å‡½æ•°æ¥å‘ˆç°æˆ‘ä»¬çš„è®¾è®¡ã€‚ SHA3æœ€åˆåŸºäºKeccak [7]ï¼Œå¹¿æ³›åº”ç”¨äºä¸åŒçš„åŒºå—é“¾å¹³å°ï¼Œå°¤å…¶æ˜¯ä»¥å¤ªåŠã€‚ åœ¨ä¸ä¹…çš„å°†æ¥ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè½¬å‘Keccakä»¥å®ç°ä¸å…¶ä»–å¹³å°æ›´å¥½çš„äº’æ“ä½œæ€§ã€‚</p><ul><li><p>æ•°å­—ç­¾å</p><p>ZILLIQAé‡‡ç”¨åŸºäºæ¤­åœ†æ›²çº¿çš„Schnorrç­¾åç®—æ³•ï¼ˆEC-Schnorrï¼‰[8]ä½œä¸ºåŸºç¡€ç­¾åç®—æ³•ã€‚æˆ‘ä»¬ç”¨secp256k1æ›²çº¿å®ä¾‹åŒ–äº†è¿™ä¸ªæ–¹æ¡ˆ[9]ã€‚æ¯”ç‰¹å¸å’Œä»¥å¤ªåŠç›®å‰ä½¿ç”¨ç›¸åŒçš„æ›²çº¿ï¼Œä½†ä½¿ç”¨ä¸åŒçš„ç­¾åç®—æ³•ECDSAã€‚é€šè¿‡ECDSAé€‰æ‹©ECSchnorræœ‰å‡ ä¸ªå¥½å¤„ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢è®¨è®ºï¼š</p><ol><li>éå¯å¡‘æ€§ï¼šéæ­£å¼åœ°è¯´ï¼Œéå¯å¡‘æ€§å±æ€§æ„å‘³ç€ç»™å®šä¸€ç»„ä½¿ç”¨ç§é’¥ç”Ÿæˆçš„ç­¾åï¼Œå¯¹äºæ”»å‡»è€…æ¥è¯´å¾ˆéš¾ä¸ºç›¸åº”çš„å…¬é’¥ç”Ÿæˆç›¸åŒæ¶ˆæ¯çš„æ–°ç­¾åã€‚ä¸ECDSAä¸åŒï¼ŒEC Schnorrå·²è¢«è¯æ˜æ˜¯ä¸å¯ä¿®æ”¹çš„ã€‚[10]</li><li>å¤šé‡ç­¾åï¼šå¤šé‡ç­¾åæ–¹æ¡ˆå…è®¸å¤šä¸ªè®¾è®¡è€…å°†ä»–ä»¬çš„ç­¾åé›†åˆåˆ°ä¸€ä¸ªç»™å®šçš„æ¶ˆæ¯ä¸­ï¼Œå¹¶å°†å…¶é›†ä¸­åˆ°ä¸€ä¸ªå•ä¸€çš„ç­¾åä¸­ï¼Œè¿™ä¸ªç­¾åå¯ä»¥é€šè¿‡ä¸€ä¸ªå…¬é’¥å³â€œæ±‡é›†â€æ‰€æœ‰æˆæƒæ–¹çš„é’¥åŒ™ã€‚è€ŒEC-Schnorræœ¬è´¨ä¸Šæ˜¯ä¸€ç§å¤šé‡ç­¾åæ–¹æ¡ˆï¼ˆå‚è§[11]ï¼‰ï¼ŒECDSAå…è®¸åˆ›å»ºå¤šé‡ç­¾åï¼Œä½†ä¸å¤Ÿçµæ´»ã€‚å½“æ¶ˆæ¯éœ€è¦å¤šä¸ªç­¾åæ—¶ï¼ŒZILLIQAä½¿ç”¨åŸºäºEC-Schnorrçš„å¤šé‡ç­¾åæ¥å‡å°‘ç­¾åå¤§å°ã€‚è¾ƒå°çš„ç­¾ååœ¨æˆ‘ä»¬çš„å…±è¯†åè®®ä¸­å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå¤šæ–¹éœ€è¦é€šè¿‡ç­¾ç½²åè®®æ¥è¾¾æˆä¸€è‡´</li><li>é€Ÿåº¦ï¼šEC-Schnorræ¯”ECDSAæ›´å¿«ï¼Œå› ä¸ºåè€…éœ€è¦è®¡ç®—å¤§æ•°åæ¨¡ã€‚ EC-Schnorrä¸éœ€è¦åè½¬ã€‚</li></ol><p>EC-Schnorrå¯†é’¥ç”Ÿæˆï¼Œç­¾åå’ŒéªŒè¯ç¨‹åºåœ¨é™„å½•Aä¸­ç»™å‡ºã€‚åœ¨é™„å½•ä¸­ï¼Œæˆ‘ä»¬è¿˜ä»‹ç»äº†EC-Schnorrå¦‚ä½•ç”¨ä½œå¤šé‡ç­¾åæ–¹æ¡ˆ</p></li></ul><ul><li><p>POW</p><p>ZILLIQAä»…ä½¿ç”¨PoWæ¥é˜²æ­¢Sybilæ”»å‡»å¹¶ç”ŸæˆèŠ‚ç‚¹æ ‡è¯†ã€‚è¿™ä¸è®¸å¤šç°æœ‰çš„åŒºå—é“¾å¹³å°ï¼ˆç‰¹åˆ«æ˜¯æ¯”ç‰¹å¸å’Œä»¥å¤ªåŠï¼‰å½¢æˆé²œæ˜å¯¹æ¯”ï¼Œå…¶ä¸­PoWç”¨äºè¾¾æˆåˆ†å¸ƒå¼å…±è¯†ã€‚ ZILLIQAé‡‡ç”¨Ethash ï¼Œå³Ethereum 1.0ä¸­ä½¿ç”¨çš„PoWç®—æ³•ã€‚ Ethashæ˜¯ä¸€ç§å†…å­˜ç¡¬æ•£åˆ—å‡½æ•°ï¼Œæ—¨åœ¨ä½¿ç”¨GPUå¾ˆå®¹æ˜“æŒ–æ˜ï¼Œä½†ä½¿ç”¨ä¸“ç”¨è®¡ç®—ç¡¬ä»¶ï¼ˆå¦‚ASICï¼‰å¾ˆéš¾ã€‚ä¸ºæ­¤ï¼ŒEthashè®¡ç®—éœ€è¦å¤§é‡å†…å­˜ï¼ˆä»¥GBä¸ºå•ä½ï¼‰å’ŒI / Oå¸¦å®½ï¼Œä»¥ä¾¿è¯¥åŠŸèƒ½ä¸èƒ½åœ¨ä¸“ç”¨è®¡ç®—ç¡¬ä»¶ä¸Šå¹¶è¡Œè°ƒç”¨ã€‚ç²—ç•¥åœ°è¯´ï¼ŒEthashå°†ä¸€ä¸ªæ•°æ®ï¼ˆä¾‹å¦‚ä¸€ä¸ªå—å¤´ï¼‰å’Œä¸€ä¸ª64ä½éšæœºæ•°ä½œä¸ºè¾“å…¥ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª256ä½çš„æ‘˜è¦ã€‚è¯¥ç®—æ³•ç”±å››ä¸ªä»¥ç»™å®šé¡ºåºè¿è¡Œçš„å­ä¾‹ç¨‹ç»„æˆï¼š</p><ol><li>ç§å­ç”Ÿæˆï¼šç§å­æ˜¯ä¸€ä¸ªSHA3-256æ‘˜è¦ï¼Œæ¯30000ä¸ªå—ç§°ä¸ºä¸€ä¸ªæ—¶æœŸåæ›´æ–°ã€‚å¯¹äºç¬¬ä¸€ä¸ªæ—¶ä»£ï¼Œå®ƒæ˜¯ä¸€ç³»åˆ—32å­—èŠ‚é›¶çš„SHA3-256æ•£åˆ—ã€‚å¯¹äºå…¶ä»–æ—¶ä»£ï¼Œå®ƒå§‹ç»ˆæ˜¯å‰ä¸€ä¸ªç§å­çš„SHA3-256æ•£åˆ—ã€‚</li><li>ç¼“å­˜ç”Ÿæˆï¼šç§å­ç”¨äºä½¿ç”¨SHA3-512ç”Ÿæˆä¼ªéšæœºç¼“å­˜ã€‚ç¼“å­˜çš„å¤§å°éšç€æ—¶æœŸçº¿æ€§å¢åŠ ã€‚ç¼“å­˜çš„åˆå§‹å¤§å°ä¸º16 MBã€‚</li><li>æ•°æ®é›†ç”Ÿæˆï¼šç„¶åä½¿ç”¨é«˜é€Ÿç¼“å­˜ç”Ÿæˆæ•°æ®é›†ï¼Œå…¶ä¸­æ•°æ®é›†ä¸­çš„æ¯ä¸ªâ€œé¡¹ç›®â€ä»…å–å†³äºç¼“å­˜ä¸­çš„å°‘é‡é¡¹ç›®ã€‚æ•°æ®é›†æ¯æ¬¡æ›´æ–°ä¸€æ¬¡ï¼Œä»¥ä¾¿çŸ¿å·¥ä¸å¿…éå¸¸é¢‘ç¹åœ°è¿›è¡Œæ›´æ”¹ã€‚æ•°æ®é›†çš„å¤§å°ä¹Ÿéšç€æ—¶æœŸçº¿æ€§å¢åŠ ã€‚æ•°æ®é›†çš„åˆå§‹å¤§å°ä¸º1 GBã€‚</li><li>æŒ–æ˜å’ŒéªŒè¯ï¼šæŒ–æ˜åŒ…æ‹¬æŠ“å–æ•°æ®é›†çš„éšæœºåˆ‡ç‰‡å¹¶å°†å®ƒä»¬æ•£åˆ—åœ¨ä¸€èµ·ã€‚éªŒè¯ä½¿ç”¨ç¼“å­˜é‡æ–°ç”Ÿæˆè®¡ç®—å“ˆå¸Œæ‰€éœ€çš„ç‰¹å®šæ•°æ®é›†ã€‚</li></ol></li></ul><h4 id="æ•°æ®å±‚"><a href="#æ•°æ®å±‚" class="headerlink" title="æ•°æ®å±‚"></a>æ•°æ®å±‚</h4><p>å¹¿ä¹‰è€Œè¨€ï¼Œæ•°æ®å±‚å®šä¹‰äº†æ„æˆZILLIQAå…¨å±€çŠ¶æ€çš„æ•°æ®ã€‚ é€šè¿‡æ‰©å±•ï¼Œå®ƒè¿˜å®šä¹‰äº†ZILLIQAä¸­ä¸åŒå®ä½“æ›´æ–°å…¶å…¨å±€çŠ¶æ€æ‰€éœ€çš„æ•°æ®ã€‚</p><ul><li><p>è´¦æˆ·ã€åœ°å€å’ŒçŠ¶æ€</p><p>ZILLIQAæ˜¯ä¸€ä¸ªåŸºäºè´¦æˆ·çš„ç³»ç»Ÿï¼ˆå¦‚ä»¥å¤ªåŠï¼‰ã€‚ æœ‰ä¸¤ç§ç±»å‹çš„å¸æˆ·ï¼šæ™®é€šå¸æˆ·å’ŒåˆåŒå¸æˆ·ã€‚ é€šè¿‡ç”ŸæˆECSchnorrç§é’¥åˆ›å»ºæ™®é€šå¸æˆ·ã€‚ åˆåŒå¸æˆ·ç”±å¦ä¸€ä¸ªå¸æˆ·åˆ›å»ºã€‚æ¯ä¸ªå¸æˆ·ç”±æ ¹æ®å…¶ç±»å‹å¯¼å‡ºçš„åœ°å€æ ‡è¯†ã€‚ æ™®é€šè´¦æˆ·çš„åœ°å€æ¥æºäºè´¦æˆ·çš„ç§é’¥ã€‚ å¯¹äºç»™å®šçš„ç§é’¥skï¼Œåœ°å€Anormalæ˜¯ä¸€ä¸ª160ä½çš„å€¼ï¼Œå…¶è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Anormal = LSB160(SHA3-256(PubKey(sk))),</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒLSB160ï¼ˆÂ·ï¼‰è¿”å›è¾“å…¥çš„æœ€å³è¾¹çš„160ä½ï¼ŒPubKeyï¼ˆÂ·ï¼‰è¿”å›ä¸è¾“å…¥å¯†é’¥å¯¹åº”çš„å…¬é’¥ã€‚ åˆçº¦å¸æˆ·çš„åœ°å€æ˜¯æ ¹æ®å…¶åˆ›å»ºè€…çš„åœ°å€ä»¥åŠåˆ›å»ºè€…å¸æˆ·å‘é€çš„äº¤æ˜“æ¬¡æ•°è®¡ç®—çš„ï¼Œä¹Ÿå°±æ˜¯å¸æˆ·éšæœºæ•°ï¼ˆå¦‚ä¸‹æ‰€è¿°ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Acontract = LSB160(SHA3-256(address||nonce)),</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œaddressæ˜¯åˆ›å»ºè€…è´¦æˆ·çš„åœ°å€ï¼Œnonceæ˜¯åˆ›å»ºè€…çš„ç°æ—¶å€¼ã€‚æ¯ä¸ªè´¦æˆ·ï¼ˆæ— è®ºæ˜¯æ­£å¸¸è´¦æˆ·è¿˜æ˜¯åˆçº¦ï¼‰éƒ½ä¸è´¦æˆ·çŠ¶æ€ç›¸å…³è”ã€‚è´¦æˆ·çŠ¶æ€æ˜¯ä¸€ä¸ªå…³é”®çš„ä»·å€¼å­˜å‚¨åŒºï¼Œç”±ä»¥ä¸‹é”®ç»„æˆï¼š</p><p>1ï¼‰å¸æˆ·ç°æ—¶ï¼šï¼ˆ64ä½ï¼‰è®¡æ•°ä»æ™®é€šå¸æˆ·å‘é€çš„äº¤æ˜“æ•°é‡çš„è®¡æ•°å™¨ï¼ˆåˆå§‹åŒ–ä¸º0ï¼‰ã€‚å¦‚æœæ˜¯åˆåŒå¸æˆ·ï¼Œå®ƒä¼šè®¡ç®—å¸æˆ·åˆ›å»ºçš„åˆåŒæ•°é‡ã€‚</p><p>2ï¼‰ä½™é¢ï¼šï¼ˆ128ä½ï¼‰ä¸€ä¸ªéè´Ÿå€¼ã€‚æ¯å½“ä¸€ä¸ªè´¦æˆ·æ”¶åˆ°æ¥è‡ªå¦ä¸€ä¸ªè´¦æˆ·çš„tokenæ—¶ï¼Œæ”¶åˆ°çš„é‡‘é¢å°†è¢«æ·»åŠ åˆ°è´¦æˆ·çš„ä½™é¢ä¸­ã€‚å½“ä¸€ä¸ªè´¦æˆ·å‘å¦ä¸€ä¸ªè´¦æˆ·å‘é€tokenæ—¶ï¼Œä½™é¢ä¼šå‡å°‘é€‚å½“çš„é‡‘é¢ã€‚</p><p>3ï¼‰ä»£ç æ•£åˆ—ï¼šï¼ˆ256ä½ï¼‰è¿™å­˜å‚¨åˆåŒä»£ç çš„SHA3-256æ‘˜è¦ã€‚å¯¹äºæ™®é€šå¸æˆ·ï¼Œå®ƒæ˜¯ç©ºå­—ç¬¦ä¸²çš„SHA3-256æ‘˜è¦ã€‚</p><p>4ï¼‰å­˜å‚¨æ ¹ï¼šï¼ˆ256ä½ï¼‰æ¯ä¸ªå¸æˆ·éƒ½æœ‰ä¸€ä¸ªå­˜å‚¨ï¼Œå®ƒåˆæ˜¯ä¸€ä¸ªkey-valueå­˜å‚¨ï¼Œå­˜å‚¨256ä½å¯†é’¥å’Œ256ä½å€¼ã€‚å­˜å‚¨æ ¹ç›®å½•æ˜¯ä»£è¡¨æ­¤å­˜å‚¨çš„SHA3-256æ‘˜è¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå­˜å‚¨æ˜¯ä¸€ä¸ªtrieï¼Œé‚£ä¹ˆå­˜å‚¨æ ¹å°±æ˜¯trieçš„æ ¹çš„æ‘˜è¦ã€‚</p><p>ZILLIQAçš„å…¨å±€çŠ¶æ€ï¼ˆçŠ¶æ€ï¼‰æ˜¯å¸æˆ·åœ°å€å’Œå¸æˆ·çŠ¶æ€ä¹‹é—´çš„æ˜ å°„ã€‚å®ƒä½¿ç”¨ç±»ä¼¼äºæ•°æ®ç»“æ„çš„trieæ¥å®ç°ã€‚</p></li><li><p>äº¤æ˜“</p><p>äº¤æ˜“æ€»æ˜¯ä»æ™®é€šè´¦æˆ·åœ°å€å‘é€ï¼Œå¹¶æ›´æ–°ZILLIQAçš„å…¨å±€çŠ¶æ€ã€‚äº¤æ˜“å…·æœ‰ä»¥ä¸‹å­—æ®µï¼š<br>1ï¼‰ç‰ˆæœ¬ï¼ˆ32ä½ï¼‰ï¼šå½“å‰ç‰ˆæœ¬ã€‚<br>2ï¼‰nonceï¼ˆ64ä½ï¼‰ï¼šä¸€ä¸ªè®¡æ•°å™¨ï¼Œç­‰äºæ­¤äº¤æ˜“å‘é€è€…å‘é€çš„äº¤æ˜“æ•°ã€‚<br>3ï¼‰ç›®çš„ï¼ˆ160ä½ï¼‰ï¼šç›®çš„åœ°å¸æˆ·åœ°å€ã€‚å¦‚æœäº¤æ˜“åˆ›å»ºæ–°çš„åˆåŒå¸æˆ·ï¼Œåˆ™è¯¥å­—æ®µæ˜¯ç©ºå­—ç¬¦ä¸²çš„æœ€å³è¾¹çš„160ä½SHA3-256ã€‚<br>4ï¼‰é‡‘é¢ï¼ˆ128ä½ï¼‰ï¼šè¦è½¬ç§»åˆ°ç›®æ ‡åœ°å€çš„äº¤æ˜“é‡‘é¢ã€‚<br>5ï¼‰gasä»·æ ¼ï¼ˆ128ä½ï¼‰ï¼šgasè¢«å®šä¹‰ä¸ºè®¡ç®—çš„æœ€å°å•ä½ã€‚gasä»·æ ¼æ˜¯å‘é€è€…æ„¿æ„ä¸ºäº¤æ˜“å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿçš„è®¡ç®—è€Œæ”¯ä»˜çš„æ¯å•ä½gasçš„é‡‘é¢ã€‚<br>6ï¼‰gasé™åˆ¶ï¼ˆ128ä½ï¼‰ï¼šå¤„ç†äº¤æ˜“æ—¶åº”ä½¿ç”¨çš„æœ€å¤§gasé‡ã€‚<br>7ï¼‰ä»£ç ï¼ˆæ— é™åˆ¶ï¼‰ï¼šæŒ‡å®šåˆåŒä»£ç çš„å¯æ‰©å±•å­—èŠ‚æ•°ç»„ã€‚åªæœ‰åœ¨äº¤æ˜“åˆ›å»ºæ–°çš„åˆåŒå¸æˆ·æ—¶æ‰å­˜åœ¨ã€‚<br>8ï¼‰dataï¼ˆæ— é™ï¼‰ï¼šä¸€ä¸ªå¯æ‰©å±•çš„å­—èŠ‚æ•°ç»„ï¼Œç”¨äºæŒ‡å®šåº”è¯¥ç”¨æ¥å¤„ç†æ•°æ®çš„æ•°æ®ã€‚å®ƒä»…åœ¨äº¤æ˜“è°ƒç”¨ç›®æ ‡åœ°å€çš„åˆåŒè°ƒç”¨æ—¶æ‰å­˜åœ¨ã€‚<br>9ï¼‰å…¬é’¥ï¼ˆ264ä½ï¼‰ï¼šåº”è¯¥ç”¨æ¥éªŒè¯ç­¾åçš„EC-Schnorrå…¬é’¥ã€‚ pubkeyå­—æ®µä¹Ÿå†³å®šäº†äº¤æ˜“çš„å‘é€åœ°å€ã€‚<br>10ï¼‰ç­¾åï¼ˆ512ä½ï¼‰ï¼šæ•´ä¸ªæ•°æ®ä¸Šçš„EC-Schnorrç­¾åã€‚æ¯ä¸ªäº¤æ˜“éƒ½ç”±ä¸€ä¸ªäº¤æ˜“IDå”¯ä¸€æ ‡è¯† - ä¸€ä¸ªæ’é™¤ç­¾åå­—æ®µçš„äº¤æ˜“æ•°æ®çš„SHA3-256æ‘˜è¦ã€‚</p></li></ul><h4 id="å—"><a href="#å—" class="headerlink" title="å—"></a>å—</h4><p>ZILLIQAåè®®å¼•å…¥äº†ä¸¤ç§ç±»å‹çš„å—ï¼ˆä»¥åŠä¸¤ä¸ªå—é“¾ï¼‰ï¼šäº‹åŠ¡å—ï¼ˆTXå—ï¼‰å’Œç›®å½•æœåŠ¡å—ï¼ˆDSå—ï¼‰ã€‚ TXå—åŒ…å«ç”¨æˆ·å‘é€çš„äº¤æ˜“ï¼Œè€ŒDSå—åŒ…å«æœ‰å…³å‚ä¸å…±è¯†åè®®çš„çŸ¿å·¥çš„å…ƒæ•°æ®ã€‚</p><ul><li>DSå—ï¼šDSå—å…·æœ‰ä¸¤éƒ¨åˆ†ï¼šå¤´éƒ¨å’Œç­¾åã€‚ DSå—çš„æ ‡é¢˜éƒ¨åˆ†åŒ…å«ä»¥ä¸‹å­—æ®µï¼š</li></ul><p>â€‹    1ï¼‰ç‰ˆæœ¬ï¼ˆ32ä½ï¼‰ï¼šå½“å‰ç‰ˆæœ¬ã€‚<br>â€‹    2ï¼‰å…ˆå‰çš„æ•£åˆ—ï¼ˆ256ä½ï¼‰ï¼šå…¶çˆ¶å—æ ‡é¢˜çš„SHA3-256æ‘˜è¦ã€‚<br>â€‹    3ï¼‰å…¬é’¥ï¼ˆ264ä½ï¼‰ï¼šåœ¨è¿™ä¸ªå—å¤´ä¸ŠåšPoWçš„çŸ¿å·¥çš„å…¬é’¥ã€‚<br>â€‹    4ï¼‰éš¾åº¦ï¼ˆ64ä½ï¼‰ï¼šè¿™å¯ä»¥ä»å‰é¢çš„å—çš„éš¾åº¦å’Œå—ç¼–å·ä¸­è®¡ç®—å‡ºæ¥ã€‚å®ƒå­˜å‚¨äº†PoWéš¾é¢˜çš„éš¾åº¦ã€‚<br>â€‹    5ï¼‰æ•°å­—ï¼ˆ256ä½ï¼‰ï¼šç¥–å…ˆå—çš„æ•°é‡ã€‚ç”Ÿæˆå—çš„å—å·ä¸º0ã€‚<br>â€‹    6ï¼‰æ—¶é—´æˆ³ï¼ˆ64ä½ï¼‰ï¼šUnixåˆ›å»ºè¯¥å—æ—¶çš„æ—¶é—´ï¼ˆï¼‰ã€‚<br>â€‹    7ï¼‰mixHashï¼ˆ256æ¯”ç‰¹ï¼‰ï¼šæ ¹æ®nonceè®¡ç®—å‡ºçš„æ‘˜è¦ï¼Œç”¨äºæ£€æµ‹DoSæ”»å‡»ã€‚<br>â€‹    8ï¼‰nonceï¼ˆ64ä½ï¼‰ï¼šPoWçš„è§£å†³æ–¹æ¡ˆã€‚</p><p> DSå—çš„ç­¾åéƒ¨åˆ†åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªå­—æ®µï¼š<br>â€‹    1ï¼‰ç­¾åï¼ˆ512æ¯”ç‰¹ï¼‰ï¼šç­¾åæ˜¯DSèŠ‚ç‚¹ç­¾åçš„DSå—å¤´ä¸Šçš„åŸºäºEC-Schnorrçš„å¤šé‡ç­¾åã€‚<br>â€‹    2ï¼‰ä½å›¾ï¼ˆ1024ä½ï¼‰ï¼šå®ƒè®°å½•å“ªäº›DSèŠ‚ç‚¹å‚ä¸å¤šé‡ç­¾åã€‚æˆ‘ä»¬ç”¨ä½å‘é‡Bè¡¨ç¤ºä½å›¾ï¼Œå…¶ä¸­ï¼ŒB [i] = 0, å¦‚æœç¬¬iä¸ªèŠ‚ç‚¹ç­¾åB [i] = 1ã€‚</p><p>DSå—å½¢æˆDSåŒºå—é“¾ã€‚</p><ul><li><p>äº¤æ˜“å—ï¼š</p><p>å¦‚å‰æ‰€è¿°ï¼ŒDSå—åŒ…å«æœ‰å…³äº¤æ˜“å…±è¯†èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚ TXå—å­˜å‚¨å…³äºDSå—ä¸­çš„èŠ‚ç‚¹åŒæ„çš„äº¤æ˜“çš„ä¿¡æ¯ã€‚æ¯ä¸ªDSå—éƒ½é“¾æ¥åˆ°å¤šä¸ªTXå—ã€‚ TXå—åŒ…å«ä¸‰éƒ¨åˆ†ï¼šæ ‡é¢˜ï¼Œæ•°æ®å’Œç­¾åã€‚æ ‡é¢˜ç”±ä»¥ä¸‹å­—æ®µç»„æˆï¼š<br>1ï¼‰ç±»å‹ï¼ˆ8ä½ï¼‰ï¼šTX-Blockæœ‰ä¸¤ç§ç±»å‹ï¼Œå³å¾®å—ï¼ˆ0x00ï¼‰å’Œæœ€ç»ˆå—ï¼ˆ0x01ï¼‰ã€‚æ›´å¤šå…³äºè¿™äº›åœ¨ç¬¬V-Déƒ¨åˆ†ã€‚<br>2ï¼‰ç‰ˆæœ¬ï¼ˆ32ä½ï¼‰ï¼šå½“å‰ç‰ˆæœ¬ã€‚<br>3ï¼‰å…ˆå‰çš„æ•£åˆ—ï¼ˆ256ä½ï¼‰ï¼šå…¶çˆ¶å—æ ‡é¢˜çš„SHA3-256æ‘˜è¦ã€‚<br>4ï¼‰gasé™åˆ¶ï¼ˆ128ä½ï¼‰ï¼šæ¯ä¸ªå—ä¸­gasæ¶ˆè€—çš„é™åˆ¶ã€‚<br>5ï¼‰ä½¿ç”¨çš„gasï¼ˆ128ä½ï¼‰ï¼šæœ¬åŒºå—äº¤æ˜“ä½¿ç”¨çš„gasæ€»é‡ã€‚<br>6ï¼‰æ•°å­—ï¼ˆ256ä½ï¼‰ï¼šç¥–å…ˆå—çš„æ•°é‡ã€‚genesiså—çš„å—å·ä¸º0ã€‚<br>7ï¼‰æ—¶é—´æˆ³ï¼ˆ64ä½ï¼‰ï¼šUnixåˆ›å»ºè¯¥å—æ—¶çš„æ—¶é—´ï¼ˆï¼‰ã€‚<br>8ï¼‰çŠ¶æ€æ ¹ï¼ˆ256ä½ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªSHA3-256æ‘˜è¦ï¼Œè¡¨ç¤ºæ‰€æœ‰äº¤æ˜“æ‰§è¡Œå¹¶å®Œæˆåçš„å…¨å±€çŠ¶æ€ã€‚å¦‚æœå…¨å±€çŠ¶æ€è¢«å­˜å‚¨ä¸ºä¸€ä¸ªtrieï¼Œé‚£ä¹ˆçŠ¶æ€æ ¹å°±æ˜¯trieçš„æ ¹çš„æ‘˜è¦ã€‚<br>9ï¼‰äº¤æ˜“æ ¹ï¼ˆ256ä½ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªSHA3-256æ‘˜è¦ï¼Œè¡¨ç¤ºå­˜å‚¨æ­¤å—ä¸­å­˜åœ¨çš„æ‰€æœ‰äº¤æ˜“çš„Merkleæ ‘çš„æ ¹ã€‚<br>10ï¼‰txæ•£åˆ—ï¼ˆæ¯ä¸ª256ä½ï¼‰ï¼šäº¤æ˜“çš„SHA3-256æ‘˜è¦åˆ—è¡¨ã€‚äº¤æ˜“çš„ç­¾åéƒ¨åˆ†ä¹Ÿè¢«æ•£åˆ—ã€‚<br>11ï¼‰å…¬é’¥ï¼ˆ264ä½ï¼‰ï¼šæå‡ºè¯¥å—çš„é¢†å¯¼è€…çš„EC-Schnorrå…¬é’¥ã€‚<br>12ï¼‰pubkeyå¾®å—ï¼ˆæ— é™åˆ¶ï¼‰ï¼šå®ƒæ˜¯ECSchnorrå…¬é’¥çš„åˆ—è¡¨ï¼ˆæ¯ä¸ªé•¿åº¦ä¸º264ä½ï¼‰ã€‚è¯¥æ¸…å•åŒ…å«æäº¤äº¤æ˜“çš„é¢†å¯¼äººçš„å…¬é’¥ã€‚è¯¥å­—æ®µä»…åœ¨finalå—æ‰å­˜åœ¨ã€‚<br>13ï¼‰çˆ¶å—æ•£åˆ—ï¼ˆ256ä½ï¼‰ï¼šå®ƒæ˜¯å‰ä¸€ä¸ªæœ€åå—æ ‡é¢˜çš„SHA3-256æ‘˜è¦ã€‚<br>14ï¼‰çˆ¶DSæ•£åˆ—ï¼ˆ256ä½ï¼‰ï¼šå®ƒæ˜¯å…¶çˆ¶DS-Blockå¤´çš„SHA3-256æ‘˜è¦ã€‚<br>15ï¼‰çˆ¶DSå—å·ï¼ˆ256ä½ï¼‰ï¼šå®ƒæ˜¯çˆ¶DSå—å·ã€‚</p><p> TXå—çš„æ•°æ®éƒ¨åˆ†åŒ…å«äº¤æ˜“åˆ—è¡¨ã€‚å®ƒæœ‰ä»¥ä¸‹é¢†åŸŸï¼š<br>1ï¼‰txè®¡æ•°ï¼ˆ32ä½ï¼‰ï¼šè¯¥å—ä¸­çš„äº¤æ˜“æ•°ã€‚<br>2ï¼‰tx listï¼ˆunlimitedï¼‰ï¼šäº¤æ˜“æ¸…å•ã€‚</p><p> TX-Blockçš„ç­¾åéƒ¨åˆ†åŒ…å«åŸºäºECSchnorrçš„å¤šé‡ç­¾åã€‚å®ƒæœ‰ä»¥ä¸‹ä¸¤ä¸ªå­—æ®µï¼š</p><ol><li>ç­¾åï¼ˆ512æ¯”ç‰¹ï¼‰ï¼šç­¾ååŸºäºEC-Schnorrçš„å¤šé‡ç­¾åï¼Œç”±ä¸€ç»„èŠ‚ç‚¹åœ¨TX-Blocä¸Šè¿›è¡Œç­¾åã€‚ç­¾åçš„èŠ‚ç‚¹å–å†³äºå®ƒæ˜¯å¾®å—è¿˜æ˜¯æœ€ç»ˆå—çš„ä¸åŒèŠ‚ç‚¹ç»„ã€‚ç¬¬V-DèŠ‚ç»™å‡ºäº†ç­¾ç½²æ–¹çš„è¿›ä¸€æ­¥ç»†èŠ‚ã€‚</li></ol><p>2ï¼‰ä½å›¾ï¼ˆ1024ä½ï¼‰ï¼šå®ƒè®°å½•å‚ä¸å¤šé‡ç­¾åçš„èŠ‚ç‚¹ã€‚æˆ‘ä»¬ç”¨ä½å‘é‡Bè¡¨ç¤ºä½å›¾ï¼Œå…¶ä¸­ï¼Œå¦‚æœç¬¬iä¸ªèŠ‚ç‚¹å¯¹å¤´éƒ¨è¿›è¡Œç­¾åï¼Œåˆ™B [i] = 1ï¼Œå¦åˆ™B [i] = 0ã€‚</p><p>finalå—å½¢æˆäº¤æ˜“åŒºå—é“¾ã€‚äº¤æ˜“åŒºå—é“¾ä¸åŒ…å«å¾®å—</p></li></ul><h3 id="ç½‘ç»œå±‚"><a href="#ç½‘ç»œå±‚" class="headerlink" title="ç½‘ç»œå±‚"></a>ç½‘ç»œå±‚</h3><p>ZILLIQAè¢«è®¾è®¡æˆæ˜¯äº¤æ˜“ç‡æŒ‰æ¯”ä¾‹å†³å®šã€‚ä¸»è¦çš„æƒ³æ³•æ˜¯ï¼Œåˆ†ç‰‡ã€‚å³ï¼Œå°†æŒ–çŸ¿ç½‘ç»œåˆ†æˆå°åˆ†ç‰‡ï¼Œæ¯ä¸ªå°åˆ†ç‰‡å¤„ç†äº¤æ˜“æ˜¯å¹¶è¡Œçš„ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç½‘ç»œå’Œäº¤æ˜“åˆ†ç‰‡ã€‚</p><h4 id="ç½‘ç»œåˆ†ç‰‡"><a href="#ç½‘ç»œåˆ†ç‰‡" class="headerlink" title="ç½‘ç»œåˆ†ç‰‡"></a>ç½‘ç»œåˆ†ç‰‡</h4><p>ç½‘ç»œåˆ†ç‰‡ã€‚å°†æŒ–çŸ¿ç½‘ç»œåˆ†æˆå°åˆ†ç‰‡æ˜¯ä¸€ä¸ªä¸¤ä¸ªçš„è¿‡ç¨‹ï¼Œé¦–å…ˆï¼Œä¸€ç»„ä¸“ç”¨çš„ç§°ä¸ºç›®å½•æœåŠ¡å§”å‘˜ä¼šï¼ˆæˆ–DSå§”å‘˜ä¼šï¼‰çš„èŠ‚ç‚¹è¢«é€‰ä¸¾å‡ºæ¥ï¼Œç„¶åä»–ä»¬å°†å°†ç½‘ç»œå’ŒèŠ‚ç‚¹åˆ†åˆ°ä»–ä»¬çš„åˆ†ç‰‡ä¸­ã€‚åœ¨ä¸‹é¢ï¼Œå°†å…·ä½“ä»‹ç»ç»†èŠ‚ã€‚</p><ul><li><p>ç›®å½•æœåŠ¡å§”å‘˜ä¼šï¼ˆDirectory Service Committeeï¼‰ï¼šä¸ºäº†ä¿ƒè¿›ç½‘ç»œçš„åˆ‡åˆ†ï¼Œæˆ‘ä»¬é¦–å…ˆä¼šé€‰ä¸¾å‡ºä¸€ç»„èŠ‚ç‚¹ï¼Œæˆä¸ºç›®å½•æœåŠ¡(DS)èŠ‚ç‚¹ã€‚<strong>DSèŠ‚ç‚¹å½¢æˆä¸€ä¸ªDSå§”å‘˜ä¼šã€‚DSèŠ‚ç‚¹çš„é€‰ä¸¾æ˜¯åŸºäºproof-of-work1ç®—æ³•</strong>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//Algorithm 1: PoW1 for DS committee election.</span><br><span class="line">Input: i: Current DS-epoch, DSiâˆ’1: Prev. DS committee</span><br><span class="line">composition.</span><br><span class="line">Output: header: DS-Block header.</span><br><span class="line"> On each competing node:</span><br><span class="line">// get epoch randomness from the DS blockchain</span><br><span class="line">// DBiâˆ’1: Most recent DS-Block before start of i-th epoch</span><br><span class="line"> r1 â† GetEpochRand(DBiâˆ’1)</span><br><span class="line">// get epoch randomness from the transaction blockchain</span><br><span class="line">// TBj : Most recent TX-Block before start of i-th epoch</span><br><span class="line"> r2 â† GetEpochRand(TBj )</span><br><span class="line">// pk: nodeâ€™s public key, IP = nodeâ€™s IP address</span><br><span class="line"> nonce, mixHash â† Ethash-PoW(pk, IP, r1, r2)</span><br><span class="line"> header â† BuildHeader(nonce, mixHash, pk)</span><br><span class="line">// header includes pk and nonce among other fields</span><br><span class="line">// IP, header is multicast to members in the DS committee</span><br><span class="line"> MulticastToDSiâˆ’1(IP, header)</span><br><span class="line"> return header</span><br></pre></td></tr></table></figure><p>æ¯”å…¶ä»–èŠ‚ç‚¹æ›´æ—©æˆåŠŸäº§ç”Ÿä¸€ä¸ªæœ‰æ•ˆçš„éšæœºæ•°çš„èŠ‚ç‚¹ï¼Œå°†ä¸ºæ–°å—æä¾›åŒºå—å¤´ã€‚å›æƒ³ä¸€ä¸‹DS-Blockå¤´å’Œç­¾åéƒ¨åˆ†ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹è§£å†³äº†POW1ï¼Œå®ƒä¾¿å¯ä»¥ç”Ÿäº§ä»…ä»…1ä¸ªåŒºå—å¤´ï¼ŒåŒºå—å¤´éšåä¼šè¢«å¤šç‚¹å¹¿æ’­ç»™DSå§”å‘˜ä¼šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒDSå§”å‘˜ä¼šå°†å¯¹äº§ç”Ÿçš„åŒºå—å¤´è¿›è¡Œå…±è¯†åç”Ÿæˆç­¾åéƒ¨åˆ†ã€‚2fä¸ªDSèŠ‚ç‚¹ç­¾åäº†åŒºå—å¤´ï¼Œè¿™ä¸ªåŒºå—ä¾¿è¢«ç¡®è®¤æ·»åŠ åˆ°DSåŒºå—é“¾ä¸­ã€‚</p><p> åœ¨æˆåŠŸå¼•å¯¼é˜¶æ®µåï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼Œè§„å®šDSèŠ‚ç‚¹çš„ç»„æˆä¸ºä¸€ä¸ªé¢„å®šä¹‰çš„çª—å£å¤§å°n0ã€‚åœ¨æœ€è¿‘n0èŠ‚ç‚¹ä¸­å¹¶æˆåŠŸæŒ–æ˜DS-Blockçš„èŠ‚ç‚¹å°†åŠ å…¥DSå§”å‘˜ä¼šã€‚</p><p>è¿ç»­æŒ–åˆ°ä¸¤ä¸ªDS-Blockä¹‹é—´çš„å¹³å‡æ—¶é—´ç§°ä¸ºDS-epochã€‚DS-eposhçš„å€¼çš„è®¾ç½®æ˜¯å‡å°ä¸¤ä¸ªç«äº‰å—å‡ ç‡çš„ä¸€ç§æ–¹æ³•ã€‚åœ¨DS-epochçš„å¼€å§‹ï¼Œä¸€ä¸ªæ–°çš„DSèŠ‚ç‚¹åŠ å…¥DSå§”å‘˜ç„¶åDSå§”å‘˜ä¼šä¸­æœ€è€çš„æˆå‘˜ä¼šå‡ºå»ã€‚è¿™å›ºå®šäº†åœ¨DS-eposhæœŸé—´DSå§”å‘˜ä¼šçš„å¤§å°å§‹ç»ˆæ˜¯n0ã€‚<strong>DSå§”å‘˜ä¸­æœ€æ–°çš„æˆå‘˜å°†æˆä¸ºleader, å¹¶é¢†å¯¼è¯¥æ—¶æœŸçš„å…±è¯†åè®®ã€‚</strong> è¿™è¿›ä¸€æ­¥å¯¼è‡´äº†DSå§”å‘˜ä¼šæˆå‘˜çš„ä¸¥æ ¼æ’åºã€‚</p><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œå¦‚æœDSå§”å‘˜ä¼šçš„è§„æ¨¡n0è¶³å¤Ÿå¤§ï¼ˆæ¯”å¦‚è¯´800ï¼‰ï¼Œé‚£ä¹ˆåœ¨n0ä¸ªå§”å‘˜ä¼šæˆå‘˜ä¸­ææœ‰å¯èƒ½æœ€å¤šæœ‰1/3æ˜¯æ‹œå åº­ã€‚</p></li><li><p>å†²çªè§£å†³ï¼šæˆ‘ä»¬çš„å…±è¯†åè®®ä¸å…è®¸åœ¨DSåŒºå—é“¾ä¸­åˆ†å‰ã€‚  å½“å¤šä¸ªèŠ‚ç‚¹å¤§è‡´åŒæ—¶è§£å†³éš¾é¢˜æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°åˆ†å‰ã€‚ ä¸ºäº†è§£å†³å†²çªï¼Œæ¯ä¸ªDSèŠ‚ç‚¹ä»æ¥æ”¶åˆ°çš„å¤´ä¸­æ£€ç´¢nonceå­—æ®µï¼Œå¹¶æŒ‰é€’å¢é¡ºåºå¯¹å®ƒä»¬è¿›è¡Œæ’åºã€‚ è®©æˆ‘ä»¬å‡è®¾ç¬¬iä¸ªDSèŠ‚ç‚¹çš„æœ€å¤§éšæœºæ•°æ˜¯max(nâ±)ã€‚</p><p>DSå§”å‘˜ä¼šçš„leaderç„¶åæå‡ºè‡ªå·±çš„headerï¼ˆå¯¹åº”äºä»–æ‰€è§è¿‡çš„æœ€å¤§éšæœºæ•°ï¼‰ï¼Œå¹¶è¿è¡Œä¸€è‡´çš„åè®®æ¥å°±DS-         Block headerè¾¾æˆä¸€è‡´ã€‚ åªæœ‰å½“ç›¸åº”çš„éšæœºæ•°å¤§äºæˆ–ç­‰äºmax(nâ±)æ—¶ï¼Œç¬¬iä¸ªDSèŠ‚ç‚¹æ‰è¢«åŒæ„æ¥å—å»ºè®®çš„headerã€‚ ä¸€æ—¦è¾¾æˆå…±è¯†ï¼ŒDS-Blockçš„ç­¾åéƒ¨åˆ†å°±å»ºç«‹èµ·æ¥äº†ï¼Œç„¶åæˆä¸ºé¢†å¯¼è€…</p></li><li><p>åˆ†ç‰‡ç”Ÿæˆï¼šä¸€æ—¦é€‰å‡ºDSå§”å‘˜ä¼šï¼Œç½‘ç»œçš„å®é™…åˆ†ç‰‡å°±å¯ä»¥å¼€å§‹ã€‚ ä¸ºäº†ä½¿èŠ‚ç‚¹å‚ä¸ä¸‹é¢çš„å…±è¯†åè®®ï¼Œå®ƒå¿…é¡»æ‰§è¡Œå·¥ä½œè¯æ˜ï¼ˆPoW2ï¼‰ã€‚ åˆ†ç‰‡åè®®åœ¨æ¯ä¸ªDSæ—¶æœŸå¼€å§‹æ—¶é‡å¤ã€‚ ç®—æ³•2ç»™å‡ºäº†PoW2çš„ç®—æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Algorithm 2: PoW2 for shard membership.</span><br><span class="line">Input: i: Current DS-epoch, DSi: Current DS committee</span><br><span class="line">composition.</span><br><span class="line">Output: nonce, mixHash: outputs of Ethash-PoW</span><br><span class="line"> On each competing node:</span><br><span class="line">// get epoch randomness from the DS blockchain</span><br><span class="line">// DBiâˆ’1: Most recent DS-Block before start of i-th epoch</span><br><span class="line"> r â† GetEpochRand(DBi)</span><br><span class="line">// pk: nodeâ€™s public key, IP = nodeâ€™s IP address</span><br><span class="line"> nonce, mixHash â† Ethash-PoW(pk, IP, r)</span><br><span class="line">// IP, header is multicast to members in the DS committee</span><br><span class="line"> MulticastToDSi(nonce, mixHash, pk, IP)</span><br><span class="line"> return nonce, mixHash</span><br></pre></td></tr></table></figure><p>ç„¶åå°†<strong>è®¡ç®—å‡ºçš„PoW2çš„æœ‰æ•ˆéšæœºæ•°ï¼ˆå’Œæ··åˆæ•£åˆ—ï¼‰å¤šæ’­åˆ°DSå§”å‘˜ä¼šã€‚ DSèŠ‚ç‚¹å°†å…±åŒæ¥å—è¶³å¤Ÿçš„PoWè§£å†³æ–¹æ¡ˆï¼Œä»¥åˆ†è§£ä¸ºLä¸ªå…±è¯†å§”å‘˜ä¼šæˆ–åˆ†ç‰‡ï¼Œæ¯ä¸ªéƒ½å…·æœ‰n0ä¸ªèŠ‚ç‚¹ä»¥è¾¾æˆå…±è¯†</strong>ã€‚ä¸€æ—¦DSå§”å‘˜ä¼šè´Ÿè´£äººæ”¶åˆ°è¶³å¤Ÿæ•°é‡çš„PoW2è§£å†³æ–¹æ¡ˆï¼Œä»–å°±å¯åŠ¨ä¸€ä¸ªåå•†ä¸€è‡´çš„åè®®ï¼Œä»¥å°±è¯¥ç»„æœ‰æ•ˆçš„PoW2è§£å†³æ–¹æ¡ˆè¾¾æˆä¸€è‡´ã€‚åœ¨å…±è¯†åè®®ç»“æŸæ—¶ï¼Œleaderç”Ÿæˆç”±DSèŠ‚ç‚¹ç­¾åçš„EC-Schnorrå¤šé‡ç­¾åã€‚ä¸ºäº†è¿›ä¸€æ­¥è¿›è¡Œä¸‹å»ï¼Œè¶…è¿‡2/3çš„DSèŠ‚ç‚¹å¿…é¡»åŒæ„ä¸€ç»„å¯æ¥å—çš„PoW2è§£å†³æ–¹æ¡ˆã€‚<br>Shardingåˆ©ç”¨ç¡®å®šæ€§å‡½æ•°å°†èŠ‚ç‚¹åˆ†é…ç»™åˆ†ç‰‡ã€‚è®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬éœ€è¦æ¯ä¸ªéƒ½æœ‰n0ä¸ªèŠ‚ç‚¹çš„ç¢ç‰‡ã€‚éšæœºæ•°å€¼æŒ‰å‡åºæ’åºï¼Œç¬¬ä¸€ä¸ªæœ‰n0ä¸ªèŠ‚ç‚¹çš„èŠ‚ç‚¹ä»¬è¢«åˆ†é…ç»™ç¬¬ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¸‹ä¸€ä¸ªn0åˆ†é…åˆ°ä¸‹ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¾æ­¤ç±»æ¨ã€‚<strong>åœ¨ç¢ç‰‡ä¸­æå‡ºæœ€å¤§éšæœºæ•°çš„çŸ¿å·¥çš„èº«ä»½è¢«å®£å¸ƒä¸ºleader</strong>ã€‚è¿™è¿›ä¸€æ­¥è¯±å¯¼äº†å¯¹åˆ†ç‰‡æˆå‘˜çš„ä¸¥æ ¼æ’åºã€‚ä¹Ÿå¯ä»¥è¡¨æ˜ï¼Œå¦‚æœn0è¶³å¤Ÿå¤§ï¼ˆæ¯”å¦‚800ä»¥ä¸Šï¼‰ï¼Œé‚£ä¹ˆåœ¨æ¯ä¸ªç¢ç‰‡å†…è‡³å¤šæœ‰1/3ä¸ªæ˜¯å…·æœ‰é«˜æ¦‚ç‡çš„æ‹œå åº­</p></li></ul><h4 id="å…¬å…±ä¿¡é“"><a href="#å…¬å…±ä¿¡é“" class="headerlink" title="å…¬å…±ä¿¡é“"></a>å…¬å…±ä¿¡é“</h4><p>DSèŠ‚ç‚¹åœ¨å…¬å…±ä¿¡é“ä¸Šå‘å¸ƒæŸäº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬DSèŠ‚ç‚¹çš„èº«ä»½å’Œè¿æ¥ä¿¡æ¯ï¼Œæ¯ä¸ªåˆ†ç‰‡ä¸­çš„èŠ‚ç‚¹åˆ—è¡¨ä»¥åŠäº¤æ˜“çš„åˆ†ç‰‡é€»è¾‘ï¼ˆåœ¨ç¬¬V-DèŠ‚ä¸­è§£é‡Šï¼‰ã€‚ å…¬å…±é¢‘é“ä¸å¯ä¿¡ï¼Œå¹¶å‡å®šæ‰€æœ‰èŠ‚ç‚¹å‡å¯è®¿é—®ã€‚ åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çš„å¹¿æ’­åŸè¯­å®ç°äº†è¿™æ ·çš„å…¬å…±é¢‘é“ã€‚ æˆ‘ä»¬åŒºå—é“¾çš„ç”¨æˆ·æƒ³è¦æäº¤äº¤æ˜“ä»¥è¿›è¡Œæ¥å—ï¼Œç„¶åå¯ä»¥æ£€æŸ¥åˆ†ç‰‡ä¿¡æ¯ä»¥è·å–è´Ÿè´£å¤„ç†å…¶äº¤æ˜“çš„ç¢ç‰‡ã€‚ åœ¨å…¬å…±é¢‘é“ä¸Šå‘å¸ƒçš„ä¿¡æ¯é¢„è®¡å°†ç”±ä»»ä½•èŠ‚ç‚¹æˆ–ç”¨æˆ·å¯éªŒè¯çš„DSèŠ‚ç‚¹çš„2/3ä»¥ä¸Šè¿›è¡Œç­¾åã€‚</p><h4 id="æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA"><a href="#æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA" class="headerlink" title="æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA"></a>æ–°èŠ‚ç‚¹åŠ å…¥ZILLIQA</h4><p>å¯¹äºæ–°èŠ‚ç‚¹åŠ å…¥ç½‘ç»œï¼Œå®ƒå¯ä»¥å°è¯•è§£å†³PoW1æˆä¸ºDSèŠ‚ç‚¹æˆ–PoW2æˆä¸ºåˆ†ç‰‡çš„æˆå‘˜ã€‚ ä¸ºæ­¤ï¼Œå®ƒéœ€è¦ä»åŒºå—é“¾è·å¾—å…³äºPoW1æˆ–PoW2æ‰€éœ€çš„éšæœºæ€§çš„ä¿¡æ¯ã€‚ ä¸€æ—¦è·å¾—äº†éšæœºæ€§ä¿¡æ¯ï¼Œæ–°èŠ‚ç‚¹å°±å¯ä»¥å°†å…¶è§£å†³æ–¹æ¡ˆæäº¤ç»™DSå§”å‘˜ä¼šã€‚</p><h4 id="äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹"><a href="#äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹" class="headerlink" title="äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹"></a>äº¤æ˜“åˆ†ç‰‡å’Œè¿‡ç¨‹</h4><p>å¦‚ä»¥ä¸Šæ‰€è¿°ï¼Œç½‘ç»œåˆ†ç‰‡åˆ›å»ºäº†æ¯ä¸ªèƒ½å¤Ÿå¹¶è¡Œå¤„ç†äº¤æ˜“çš„åˆ†ç‰‡ã€‚ åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç‰¹å®šäº¤æ˜“å¦‚ä½•åˆ†é…ç»™åˆ†ç‰‡ä»¥åŠå¦‚ä½•å¤„ç†äº¤æ˜“ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æŠ½è±¡ï¼šA -â¿-&gt;Bæ¥æŒ‡ç¤ºä»å‘ä»¶äººè´¦æˆ·Aåˆ°æ”¶ä»¶äººè´¦æˆ·Bçš„nä¸ªZILçš„äº¤æ˜“</p><ul><li><p>äº¤æ˜“åˆ†é…ï¼šä»»ä½•äº¤æ˜“éƒ½è¡¨ç¤ºA -â¿-&gt;Bè¢«å•ä¸ªåˆ†ç‰‡å¤„ç†ã€‚ å‡è®¾æœ‰Lä¸ªåˆ†ç‰‡ï¼Œç¼–å·ä¸º0åˆ°L-1ï¼Œäº¤æ˜“è¢«åˆ†é…åˆ°ç”±å‘é€è€…åœ°å€çš„(logâ‚‚L + 1)å³è¾¹çš„ä½ï¼ˆbitï¼‰æ ‡è¯†çš„ç¢ç‰‡ã€‚å³ï¼Œå®ä¾‹ä¸­Açš„è´¦æˆ·åœ°å€ã€‚å› ä¸ºè´¦æˆ·åœ°å€æ˜¯ä¸€ä¸ª160ä½(bit)çš„æ•´å‹æ•°æ®ï¼Œæ‰€ä»¥Lçš„èŒƒå›´åº”è¯¥ä¸º<strong>logâ‚‚L + 1 â‰¤ 160</strong>ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒä¼šå°äº100ã€‚</p><p>ä¸€æ—¦è¯†åˆ«äº†åˆ†é…çš„åˆ†ç‰‡ï¼Œäº¤æ˜“å°±ä¼šè¢«å¤šæ’­åˆ°åˆ†ç‰‡ä¸­çš„ä¸€äº›èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ç„¶åå†è¿›ä¸€æ­¥å¹¿æ’­å®ƒã€‚ ä¸€æ—¦äº¤æ˜“åˆ°è¾¾æŒ‡å®šåˆ†ç‰‡çš„é¢†å¯¼è€…ï¼Œå®ƒå°†æŠŠäº¤æ˜“åŒ…å«åœ¨TX-Blockä¸­å¹¶è¿è¡Œå…±è¯†åè®®ã€‚</p><p><strong>åŒèŠ±ï¼ˆæˆ–é‡æ’­æ”»å‡»ï¼‰å¯ä»¥ä½¿ç”¨æ¯ç¬”äº¤æ˜“ä¸­çš„éšæœºæ•°è½»æ¾æ£€æµ‹</strong>ã€‚ å›æƒ³ä¸€ä¸‹ï¼Œæ¯ç¬”äº¤æ˜“éƒ½æœ‰ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨äºç»Ÿè®¡å‘ä»¶äººå¸æˆ·å‘é€çš„äº¤æ˜“æ•°é‡ã€‚ ä¸€æ—¦äº¤æ˜“è¿›å…¥äº¤æ˜“åŒºå—é“¾ï¼Œnonceåœ¨è´¦æˆ·çŠ¶æ€ä¸­æ›´æ–°ï¼Œä»è€Œå¤„äºå…¨å±€çŠ¶æ€ã€‚ å½“å‰å€¼å°äºæˆ–ç­‰äºå…¨å±€çŠ¶æ€å½“å‰å€¼çš„äº¤æ˜“è¢«çŸ¿å·¥æ‹’ç»ã€‚ æ ¹æ®å‘ä»¶äººçš„å¸æˆ·åœ°å€æœ¬åœ°åˆ†ç‰‡äº¤æ˜“å…è®¸åˆ†ç‰‡æˆå‘˜æ£€æµ‹åŒå€æ”¯å‡ºï¼Œå› ä¸ºå‘ä»¶äººçš„æ¯ä¸ªäº¤æ˜“éƒ½å°†åœ¨åŒä¸€åˆ†ç‰‡ä¸­å¤„ç†ã€‚</p></li><li><p>äº¤æ˜“å¤„ç†ï¼šå§”å‘˜ä¼šå†…çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ä»¥æå‡ºäº¤æ˜“ã€‚è¿™äº›äº¤æ˜“è¢«å‘é€ç»™é¢†å¯¼è€…ä»¥è¿è¡Œä¸€ç»„åè®®ï¼Œå…¶ä¸­ä¸€ç»„äº¤æ˜“å½¢æˆä¸‹ä¸€ä¸ªTXå—ã€‚ç”±æ¯ä¸ªåˆ†ç‰‡å»ºè®®çš„å—ç§°ä¸ºå¾®å—ï¼ˆç”±ç±»å‹æ ‡è®°0x00æ ‡è¯†ï¼‰ã€‚ä¸€ä¸ªå¾®å—åŒ…å«EC-Schnorrå¤šé‡ç­¾åï¼Œç”±åˆ†ç‰‡ä¸­çš„2/3ä¸ªèŠ‚ç‚¹ç»„æˆã€‚leaderè¿˜å»ºç«‹ä¸€ä¸ªæ ‡è¯†ç­¾åè€…å…¬é’¥çš„ä½å›¾Bã€‚å¦‚æœåˆ†ç‰‡çš„ç¬¬iä¸ªæˆå‘˜ç­¾ç½²äº†TX-Blockå¤´éƒ¨ï¼Œåˆ™B [i] = 1ã€‚å½“ä¸€ä¸ªåˆ†ç‰‡åœ¨TXå—ä¸Šè¾¾æˆå…±è¯†æ—¶ï¼Œå…¶é¢†å¯¼è€…å°†å—å¤´å’Œç­¾åå¤šæ’­ç»™ä¸€äº›DSèŠ‚ç‚¹ã€‚ DSèŠ‚ç‚¹ç„¶ååœ¨DSå§”å‘˜ä¼šå†…å¹¿æ’­å®ƒï¼Œä»¥ä¾¿è¯¥å—åˆ°è¾¾å…¶é¢†å¯¼è€…ã€‚å—çš„æ•°æ®éƒ¨åˆ†å¯ä»¥å¼‚æ­¥å‘é€åˆ°èŠ‚ç‚¹ã€‚ DSå§”å‘˜ä¼šç„¶åæ±‡é›†ä»åˆ†ç‰‡å‘é€çš„æ‰€æœ‰å—ï¼Œå¹¶ä¸”åœ¨å®ƒä»¬ä¹‹é—´è¿è¡Œå¦ä¸€è½®å…±è¯†åè®®ä»¥è¾¾æˆæœ€ç»ˆå—ã€‚æœ€åçš„å—æ˜¯ç”±ç±»å‹æ ‡è®°0x01æ ‡è¯†çš„TXå—ã€‚æœ€åä¸€ä¸ªå—åŒ…å«æ¥è‡ªDSå§”å‘˜ä¼šçš„è¶…è¿‡2/3ä¸ªn0èŠ‚ç‚¹çš„EC-Schnorrå¤šé‡ç­¾åã€‚ DSå§”å‘˜ä¼šçš„leaderè¿˜æ„å»ºäº†ä¸€ä¸ªä½å›¾Bï¼Œç”¨äºæ ‡è¯†ç­¾åè€…çš„å…¬é’¥ã€‚å¦‚æœDSå§”å‘˜ä¼šçš„ç¬¬iä¸ªæˆå‘˜ç­¾ç½²äº†TX-Blockæ ‡é¢˜ï¼Œåˆ™B [i] = 1ã€‚æœ€åçš„å—å¤´å’Œç­¾åï¼Œç„¶åè¢«ç»„æ’­åˆ°æ¯ä¸ªåˆ†ç‰‡ä¸­çš„ä¸€äº›èŠ‚ç‚¹ã€‚å®é™…çš„TXå—æ•°æ®ä¸æ˜¯ç”±DSèŠ‚ç‚¹å‘é€çš„ã€‚(DSèŠ‚ç‚¹å‘é€çš„æ˜¯å—å¤´å’Œç­¾åï¼Œtxå—æ•°æ®åº”è¯¥æ˜¯ç”±åˆ†ç‰‡èŠ‚ç‚¹é—´è¿›è¡ŒåŒæ­¥å¹¿æ’­)</p><p>åœ¨æ¯ä¸ªåˆ†ç‰‡ä¸­ï¼Œé‡‡å–ä»¥ä¸‹æ­¥éª¤æ¥å¤„ç†æœ€ç»ˆçš„å—:</p><ol><li>åˆ†ç‰‡ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨DSèŠ‚ç‚¹çš„å…¬é’¥éªŒè¯EC-Schnorrå¤šé‡ç­¾åã€‚ å¦‚æœç­¾åå¯¹ç”±ä½å›¾è¡¨ç¤ºçš„è¶…è¿‡2/3ä¸ªn0å…¬é’¥æœ‰æ•ˆï¼Œåˆ™èŠ‚ç‚¹æ‰§è¡Œä¸‹ä¸€ä¸ªæ£€æŸ¥ã€‚</li><li>å¯¹äºåŒ…å«åœ¨æœ€ç»ˆå—å¤´ä¸­çš„æ¯ä¸ªäº¤æ˜“hashï¼ŒèŠ‚ç‚¹æ£€æŸ¥å…¶ç›¸åº”çš„äº¤æ˜“å†…å®¹æ˜¯å¦å¯ç”¨ã€‚ å¦‚æœç›¸åº”çš„äº¤æ˜“ç”±èŠ‚ç‚¹æ‰€å±çš„åˆ†ç‰‡æå‡ºï¼Œåˆ™å°†äº¤æ˜“æ•°æ®çš„æ•£åˆ—ä¸åŒ…å«åœ¨æœ€åå—headerä¸­çš„æ•£åˆ—è¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æœäº¤æ˜“æ˜¯ç”±å¦ä¸€ä¸ªåˆ†ç‰‡æå‡ºçš„ï¼Œåˆ™äº¤æ˜“æ•°æ®è·¨åˆ†ç‰‡å¼‚æ­¥å…±äº«</li><li>ä¸€æ—¦äº¤æ˜“æ•°æ®å¯ç”¨ï¼Œæœ€ç»ˆå—çš„dataéƒ¨åˆ†è¢«é‡æ„å¹¶ä¸”TXå—è¢«é™„åŠ åˆ°æœ¬åœ°äº¤æ˜“åŒºå—é“¾ã€‚ è´¦æˆ·çŠ¶æ€å’Œå…¨å±€çŠ¶æ€ç›¸åº”åœ°è¢«æ›´æ–°ã€‚</li><li>å¦‚æœäº¤æ˜“å†…å®¹ä¸å¯ç”¨ï¼Œåˆ™èŠ‚ç‚¹åœ¨å…¶æœ¬åœ°è´¦æˆ·è§†å›¾ä¸­ä¸´æ—¶ä½¿è¯¥äº¤æ˜“çš„å‘é€è´¦æˆ·å¤±æ•ˆï¼Œä»¥ä¾¿è¯¥è´¦æˆ·çš„ä»»ä½•å…¶ä»–æœªå†³äº¤æ˜“è¢«æ‹’ç»ï¼Œç›´åˆ°æœ¬åœ°äº¤æ˜“å†…å®¹å¯ä»¥ä¸å…¨å±€çŠ¶æ€åŒæ­¥ã€‚ è¿™äº›è¢«æ‹’ç»çš„äº‹åŠ¡å°†ä¸å¾—ä¸ç”±å‘é€èŠ‚ç‚¹é‡è¯•</li></ol></li></ul><h3 id="å…±è¯†å±‚"><a href="#å…±è¯†å±‚" class="headerlink" title="å…±è¯†å±‚"></a>å…±è¯†å±‚</h3><p>å¦‚ä»¥ä¸Šæåˆ°çš„ï¼Œæ¯ä¸ªåˆ†ç‰‡å’ŒDSå§”å‘˜ä¼šéœ€è¦åˆ†åˆ«åœ¨å¾®å—å’Œç»ˆå—ä¸Šè·‘ä¸€ä¸ªå…±è¯†åè®®ã€‚åœ¨è¿™ä¸€å—ï¼Œæˆ‘ä»¬å°†å±•ç¤ºåœ¨æ¯ä¸€ä¸ªåˆ†ç‰‡å’ŒDSå§”å‘˜ä¼šä¸­å®šä¹‰çš„å…±è¯†åè®®çš„å…±è¯†å±‚ã€‚åœ¨è®¨è®ºä¸­ï¼Œæˆ‘ä»¬å°†åˆ†ç‰‡å’ŒDSå§”å‘˜ä¼šä»£æŒ‡ä¸ºå…±è¯†ç»„ã€‚</p><h5 id="å®ç”¨æ‹œå åº­å®¹é”™"><a href="#å®ç”¨æ‹œå åº­å®¹é”™" class="headerlink" title="å®ç”¨æ‹œå åº­å®¹é”™"></a>å®ç”¨æ‹œå åº­å®¹é”™</h5><p>ZILLIQAå…±è¯†åè®®çš„æ ¸å¿ƒä¾èµ–äºå®ç”¨æ‹œå åº­å®¹é”™(PBFT)åè®®ã€‚ç„¶è€Œæˆ‘ä»¬é€šè¿‡åœ¨PBFTä¸­ä½¿ç”¨EC-Schnorrå¤šç­¾åæ¥æå‡æ•ˆç‡ã€‚EC-Schnorrå¤šé‡ç­¾åçš„ä½¿ç”¨å°†æ­£å¸¸æƒ…å†µä¸‹çš„é€šä¿¡å»¶è¿Ÿä»O(n*n)é™ä½ä¸ºO(n)ï¼Œå¹¶å°†ç­¾åå¤§å°ä»O(n)å‡å°åˆ°O(1)ï¼Œå…¶ä¸­næ˜¯å…±è¯†ç»„çš„å¤§å°ã€‚ åœ¨è¿™ä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬æä¾›PBFTçš„æ¦‚è¿°ã€‚</p><p>åœ¨PBFTä¸­ï¼Œå…±è¯†ç»„å†…çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‰é¡ºåºæ’åˆ—ï¼Œå®ƒæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼ˆæˆ–é¢†å¯¼è€…ï¼‰ï¼Œå…¶ä»–èŠ‚ç‚¹ç§°ä¸ºå¤‡ä»½èŠ‚ç‚¹ã€‚ æ¯è½®PBFTéƒ½æœ‰ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹æ‰€è¿°ï¼š</p><ul><li>é¢„å‡†å¤‡é˜¶æ®µ:  åœ¨è¿™ä¸ªé˜¶æ®µï¼Œé¢†å¯¼è€…å®£å¸ƒè¯¥å°ç»„å°†åº”è¯¥è¾¾æˆä¸€è‡´å…±è¯†çš„ä¸‹ä¸€ä¸ªè®°å½•ï¼ˆåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­æ˜¯TX-Blockï¼‰</li><li>å‡†å¤‡é˜¶æ®µï¼šåœ¨æ¥æ”¶åˆ°é¢„å…ˆå‡†å¤‡æ¶ˆæ¯åï¼Œæ¯ä¸ªèŠ‚ç‚¹éªŒè¯å…¶æ­£ç¡®æ€§å¹¶å°†å‡†å¤‡æ¶ˆæ¯å¤šæ’­ç»™æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹</li><li>æäº¤é˜¶æ®µï¼šåœ¨æ”¶åˆ°è¶…è¿‡2/3*nå‡†å¤‡æ¶ˆæ¯æ—¶ï¼ŒèŠ‚ç‚¹å‘ç»„æ’­ç»„å‘é€æäº¤æ¶ˆæ¯ã€‚æœ€åï¼ŒèŠ‚ç‚¹ç­‰å¾…è¶…è¿‡2/3*nçš„æäº¤æ¶ˆæ¯ï¼Œä»¥ç¡®ä¿æœ‰è¶³å¤Ÿæ•°é‡çš„èŠ‚ç‚¹åšå‡ºç›¸åŒçš„å†³å®šã€‚ å› æ­¤ï¼Œæ‰€æœ‰è¯šå®çš„èŠ‚ç‚¹éƒ½æ¥å—ç›¸åŒçš„æœ‰æ•ˆè®°å½•ã€‚</li></ul><p>PBFTä¾é æ­£ç¡®çš„é¢†å¯¼è€…å¼€å§‹æ¯ä¸ªé˜¶æ®µï¼Œå¹¶åœ¨è¶³å¤Ÿå¤šèŠ‚ç‚¹å­˜åœ¨æ—¶ç»§ç»­è¿›è¡Œã€‚ å¦‚æœé¢†å¯¼æ˜¯æ‹œå åº­ï¼Œå®ƒå¯èƒ½ä¼šæ‹–å»¶æ•´ä¸ªå…±è¯†åè®®ã€‚ ä¸ºäº†åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼ŒPBFTæä¾›äº†è§†å›¾æ›´æ”¹åè®®æ¥ä½¿ç”¨å¦ä¸€ä¸ªå–ä»£æ‹œå åº­é¢†è¢–ã€‚ å¦‚æœèŠ‚ç‚¹åœ¨æœ‰é™çš„æ—¶é—´å†…æ²¡æœ‰çœ‹åˆ°ä»»ä½•è¿›å±•ï¼Œä»–ä»¬å¯ä»¥ç‹¬ç«‹å®£å¸ƒæ”¹å˜é¢†å¯¼è€…çš„æ„¿æœ›ã€‚ å¦‚æœè¶…è¿‡2/3*nä¸ªèŠ‚ç‚¹çš„æ³•å®šäººæ•°å†³å®šé¢†å¯¼è€…æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨å·²çŸ¥è®¡åˆ’ä¸­çš„ä¸‹ä¸€ä¸ªé¢†å¯¼è€…å°±ä¼šæ¥ç®¡ã€‚</p><p> ç”±äºåœ¨å‡†å¤‡/æäº¤é˜¶æ®µæ¯ä¸ªèŠ‚ç‚¹çš„å¤šæ’­ï¼Œæ­£å¸¸æƒ…å†µä¸‹PBFTçš„é€šä¿¡å¤æ‚åº¦ä¸ºOï¼ˆn*nï¼‰</p><h5 id="æé«˜æ•ˆç‡"><a href="#æé«˜æ•ˆç‡" class="headerlink" title="æé«˜æ•ˆç‡"></a>æé«˜æ•ˆç‡</h5><p>ç»å…¸çš„PBFTä½¿ç”¨æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰è¿›è¡ŒèŠ‚ç‚¹ä¹‹é—´çš„è®¤è¯é€šä¿¡ã€‚ ç”±äºMACéœ€è¦åœ¨æ¯ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´å…±äº«å¯†é’¥ï¼Œæ‰€ä»¥ä¸€ä¸ªå…±è¯†ç»„ä¸­çš„èŠ‚ç‚¹å¯ä»¥åœ¨åŒä¸€ä¸ªè®°å½•ä¸Šè¾¾æˆä¸€è‡´ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„é€šä¿¡å¤æ‚åº¦ä¸ºOï¼ˆn*nï¼‰ã€‚ ç”±äºäºŒæ¬¡å¤æ‚æ€§ï¼Œå½“å§”å‘˜ä¼šæœ‰20å¤šä¸ªèŠ‚ç‚¹æ—¶ï¼ŒPBFTå˜å¾—ä¸åˆ‡å®é™…ã€‚</p><p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¥æºäºByzCoinçš„æƒ³æ³•ï¼š</p><ul><li>æˆ‘ä»¬ç”¨æ•°å­—ç­¾åæ›¿æ¢MACæ¥æœ‰æ•ˆåœ°å‡å°‘Oï¼ˆnï¼‰çš„é€šä¿¡å¼€é”€ã€‚</li><li>ä¸æ­¤åŒæ—¶ï¼Œä¸ºäº†è®©å…¶ä»–èŠ‚ç‚¹èƒ½å¤ŸéªŒè¯åè®®ï¼Œä¸€ç§å…¸å‹çš„æ–¹æ³•æ˜¯ä»è¯šå®çš„å¤šæ•°æ”¶é›†ç­¾åå¹¶å°†å®ƒä»¬é™„åŠ åˆ°åè®®ä¸­ï¼Œä»è€Œå¯¼è‡´åå•†è§„æ¨¡ä¸åå•†ç»„çš„å¤§å°æˆçº¿æ€§å…³ç³»ã€‚ ä¸ºäº†æ”¹å–„è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨EC-Schnorrå¤šé‡ç­¾åæ¥å°†å‡ ä¸ªç­¾åèšåˆæˆOï¼ˆ1ï¼‰ - å¤§å°å¤šé‡ç­¾å</li></ul><p>ç„¶è€Œï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨PBFTè®¾ç½®ä¸­ä½¿ç”¨ç»å…¸çš„EC-Schnorrå¤šé‡ç­¾åæ–¹æ¡ˆã€‚ è¿™æ˜¯å› ä¸ºåœ¨å¤å…¸è®¾ç½®ä¸­ï¼Œæ‰€æœ‰ç­¾åè€…éƒ½åŒæ„ç­¾ç½²ç»™å®šçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ç­¾ååªæœ‰åœ¨æ‰€æœ‰ç­¾åè€…éƒ½ç­¾ååæ‰æœ‰æ•ˆã€‚ åœ¨PBFTè®¾ç½®ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å…±è¯†ç»„ä¸­è¶…è¿‡2/3*nä¸ªèŠ‚ç‚¹ç­¾ç½²æ¶ˆæ¯ã€‚ æ‰€éœ€çš„ä¸»è¦ä¿®æ”¹ä¹‹ä¸€æ˜¯ä¸ºå‚ä¸ç­¾åè¿‡ç¨‹çš„ç­¾åè€…ç»´æŠ¤ä½å›¾B. å¦‚æœç¬¬iä¸ªèŠ‚ç‚¹å‚ä¸è¯¥è¿‡ç¨‹ï¼Œåˆ™B [i] = 1ï¼Œå¦åˆ™ä¸º0ã€‚ä½å›¾ç”±é¢†å¯¼è€…æ„å»ºã€‚ ä½å›¾å¯ä»¥è¢«ä»»ä½•éªŒè¯è€…ç”¨æ¥éªŒè¯ç­¾åã€‚ æœ€ç»ˆçš„åè®®ç•™åœ¨é™„å½•Bä¸­ã€‚</p><h5 id="Zilliqaå…±è¯†"><a href="#Zilliqaå…±è¯†" class="headerlink" title="Zilliqaå…±è¯†"></a>Zilliqaå…±è¯†</h5><p>åœ¨ZILLIQAä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨PBFTä½œä¸ºåŸºç¡€å…±è¯†åè®®ï¼Œå¹¶é‡‡ç”¨ä¸¤è½®EC-Schnorrå¤šé‡ç­¾åæ¥æ›¿æ¢PBFTä¸­çš„å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µã€‚ ä¸‹é¢å°†è§£é‡Šå¯¹PBFTé˜¶æ®µçš„ä¸åŒä¿®æ”¹ã€‚</p><ul><li>é¢„å‡†å¤‡é˜¶æ®µ: ä¸æ ‡å‡†PBFTä¸­ä¸€æ ·ï¼Œé¢†å¯¼è€…å°†TX-Blockæˆ–å£°æ˜ï¼ˆç”±é¢†å¯¼è€…ç­¾åï¼‰åˆ†å‘ç»™å…±è¯†ç»„ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</li><li>å‡†å¤‡é˜¶æ®µï¼šæ‰€æœ‰è¯šå®çš„èŠ‚ç‚¹æ£€æŸ¥TXå—çš„æœ‰æ•ˆæ€§ï¼Œå¹¶ä¸”é¢†å¯¼è€…æ”¶é›†æ¥è‡ªè¶…è¿‡2/3*nä¸ªèŠ‚ç‚¹çš„å“åº”ã€‚ è¿™ä¿è¯é¢†å¯¼è€…æå‡ºçš„é™ˆè¿°æ˜¯å®‰å…¨çš„å¹¶ä¸”ä¸ä»¥å‰çš„æ‰€æœ‰å†å²ä¸€è‡´ã€‚ ç­¾åæ˜¯ä½¿ç”¨EC-Schnorrå¤šé‡ç­¾åç”Ÿæˆçš„ã€‚ é¢†å¯¼è€…è¿˜æ„å»ºç­¾ç½²TXå—çš„èŠ‚ç‚¹çš„ä½å›¾</li><li>æäº¤é˜¶æ®µï¼šä¸ºäº†ç¡®ä¿è¶…è¿‡2/3*nçš„èŠ‚ç‚¹çŸ¥é“è¶…è¿‡2/3*nèŠ‚ç‚¹éªŒè¯äº†TX-Blockçš„äº‹å®ã€‚æˆ‘ä»¬è¿›è¡Œç¬¬äºŒè½®EC-Schnorrå¤šé‡ç­¾åã€‚ æ­£åœ¨ç­¾ç½²çš„å£°æ˜æ˜¯ä¸Šä¸€è½®ç”Ÿæˆçš„å¤šé‡ç­¾åã€‚</li></ul><p>åœ¨ä¸‰ä¸ªé˜¶æ®µç»“æŸæ—¶ï¼Œå°±é¢†å¯¼è€…æå‡ºçš„TX-Blockå°†è¾¾æˆå…±è¯†ã€‚</p><h5 id="é¢†å¯¼è€…æ”¹å˜"><a href="#é¢†å¯¼è€…æ”¹å˜" class="headerlink" title="é¢†å¯¼è€…æ”¹å˜"></a>é¢†å¯¼è€…æ”¹å˜</h5><p>åœ¨æˆ‘ä»¬çš„å…±è¯†åè®®ä¸­ï¼Œå¦‚æœé¢†å¯¼è€…æ˜¯è¯šå®çš„ï¼Œå®ƒå¯ä»¥ä¸æ–­çš„æ¨åŠ¨å…±è¯†å°ç»„ä¸­çš„èŠ‚ç‚¹å°±æ–°çš„äº¤æ˜“è¾¾æˆåè®®ã€‚ ä½†æ˜¯ï¼Œå¦‚æœé¢†å¯¼æ˜¯æ‹œå åº­ï¼Œå®ƒå¯ä»¥æœ‰æ„åœ°å»¶è¿Ÿæˆ–ä¸¢å¼ƒæ¥è‡ªè¯šå®èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼Œå¹¶å‡æ…¢åè®®ã€‚ ä¸ºäº†æƒ©ç½šè¿™äº›æ¶æ„é¢†å¯¼è€…ï¼Œæˆ‘ä»¬çš„åè®®ä¼šå®šæœŸæ›´æ”¹æ¯ä¸ªåˆ†ç‰‡çš„é¢†å¯¼å’ŒDSå§”å‘˜ä¼šã€‚ è¿™å¯ä»¥é˜²æ­¢æ‹œå åº­é¢†è¢–åœ¨æ— é™æœŸçš„æ—¶é—´å†…æ‹–å»¶å…±è¯†åè®®ã€‚ ç”±äºæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯æœ‰åºçš„ï¼Œä¸‹ä¸€ä¸ªé¢†å¯¼è€…å°†ä»¥å¾ªç¯æ–¹å¼é€‰æ‹©ã€‚</p><p> äº‹å®ä¸Šï¼Œæ¯ä¸€ä¸ªå¾®å—ååˆ†ç‰‡çš„é¢†å¯¼è€…éƒ½ä¼šæ”¹å˜ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæœ€åä¸€ä¸ªåŒºå—ä¹‹åDSå§”å‘˜ä¼šçš„é¢†å¯¼è€…ä¹Ÿä¼šæ›´æ”¹ã€‚ è®©æˆ‘ä»¬å‡è®¾å…±è¯†ç»„çš„å¤§å°ä¸ºnï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªDS-epochæ—¶æœŸå†…ï¼Œæˆ‘ä»¬å…è®¸çš„æœ€ç»ˆå—çš„æœ€å¤§å€¼ä¸ºnï¼Œæ¯ä¸ªæœ€ç»ˆå—æœ€å¤šåœ¨1ä¸ªåˆ†ç‰‡èšåˆ1ä¸ªå¾®å—ã€‚</p><h4 id="é™„å½•Aï¼Œæ•°å­—ç­¾åç®—æ³•"><a href="#é™„å½•Aï¼Œæ•°å­—ç­¾åç®—æ³•" class="headerlink" title="é™„å½•Aï¼Œæ•°å­—ç­¾åç®—æ³•"></a>é™„å½•Aï¼Œæ•°å­—ç­¾åç®—æ³•</h4><h5 id="EC-Schnorrï¼ˆå•ä¸ªç­¾åè€…ï¼‰æœºåˆ¶"><a href="#EC-Schnorrï¼ˆå•ä¸ªç­¾åè€…ï¼‰æœºåˆ¶" class="headerlink" title="EC-Schnorrï¼ˆå•ä¸ªç­¾åè€…ï¼‰æœºåˆ¶"></a>EC-Schnorrï¼ˆå•ä¸ªç­¾åè€…ï¼‰æœºåˆ¶</h5><p>EC-Schnorrå·¥ä½œåœ¨ç¦»æ•£å¯¹æ•°å¾ˆéš¾çš„ç»„[8]ï¼Œ[24]ï¼Œ[25]ã€‚ ZILLIQAä½¿ç”¨åœ¨æµè¡Œçš„secp256k1æ›²çº¿ä¸Šå®šä¹‰çš„æ¤­åœ†æ›²çº¿ç»„ã€‚ æˆ‘ä»¬ç”¨C :=ï¼ˆpï¼ŒGï¼Œnï¼‰è¡¨ç¤ºå®šä¹‰ç»„çš„å‚æ•°é›†åˆï¼Œå…¶ä¸­pæ˜¯æŒ‡å®šåŸºç¡€åœºFpçš„è´¨æ•°ï¼ŒGæ˜¯æ›²çº¿ä¸Šçš„åŸºç‚¹ï¼Œnï¼ˆç´ æ•°ï¼‰æ˜¯ Gçš„é¡ºåºã€‚EC-Schnorrè¿˜éœ€è¦ä¸€ä¸ªå¯†ç æ•£åˆ—å‡½æ•°Hï¼Œæˆ‘ä»¬ç”¨SHA3-256 [6]å®ä¾‹åŒ–ã€‚</p><p> EC-Schnorræ˜¯æˆ‘ä»¬åœ¨æœ¬èŠ‚ä¸­ä»‹ç»çš„ä¸€ç»„ä¸‰ç§ç®—æ³•KeyGenï¼ŒSignå’ŒVerifyã€‚ åœ¨ä¸‹é¢çš„ç®—æ³•ä¸­ï¼Œå¯¹äºä»»ä½•æ ‡é‡xå’Œç‚¹Qï¼Œæˆ‘ä»¬ç”¨[x] Qè¡¨ç¤ºä¹˜æ³•</p><ul><li>KeyGen(C): è¯¥ç®—æ³•å–æ›²çº¿å‚æ•°Cå¹¶è¿”å›ä¸€å¯¹å…¬é’¥ï¼ˆpkï¼‰å’Œç§é’¥ï¼ˆskï¼‰ã€‚ç®—æ³•çœç•¥</li><li>Sign(C, pk, sk, m)ï¼šè¯¥ç®—æ³•ç”±ç­¾åè€…è¿è¡Œã€‚ æ ¹æ®æ›²çº¿å‚æ•°Cï¼Œå…¬é’¥å’Œç§é’¥å¯¹ï¼ˆpkï¼Œskï¼‰ä»¥åŠç­¾ç½²çš„æ¶ˆæ¯ã€‚ å®ƒè¿”å›ä¸€ä¸ªç­¾åÏƒ</li><li>Verify(C, Ïƒ, pk, m): è¯¥ç®—æ³•ç”±å¸Œæœ›æ£€æŸ¥ç­¾åæœ‰æ•ˆæ€§çš„éªŒè¯è€…è¿è¡Œã€‚ å®ƒå–æ›²çº¿å‚æ•°Cï¼Œç­¾åÏƒï¼Œå…¬é’¥pkå’Œæ¶ˆæ¯mã€‚ å¦‚æœç­¾åå¯¹äºpkä¸‹çš„mæœ‰æ•ˆï¼Œåˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0</li></ul><h5 id><a href="#" class="headerlink" title></a></h5><h5 id="EC-Schnorrå¤šé‡ç­¾åæœºåˆ¶"><a href="#EC-Schnorrå¤šé‡ç­¾åæœºåˆ¶" class="headerlink" title="EC-Schnorrå¤šé‡ç­¾åæœºåˆ¶"></a>EC-Schnorrå¤šé‡ç­¾åæœºåˆ¶</h5><ul><li><p>è®¾ç½®å’Œå‡è®¾ï¼šEC-Schnorrä¹Ÿå¯ä»¥ç”¨ä½œå¤šé‡ç­¾åæ–¹æ¡ˆ[11]ã€‚åœ¨å¤šé‡ç­¾åæ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬æœ‰Tä¸ªç­¾åè€…ï¼šP1ï¼Œâ€¦ã€‚ ã€‚ ã€‚ ï¼ŒPTï¼Œèšåˆå™¨å’ŒéªŒè¯è€…ã€‚ç­¾åè€…å¸Œæœ›è”åˆç­¾ç½²æ¶ˆæ¯mã€‚èšåˆè€…æ‰®æ¼”ä¿ƒè¿›è€…çš„è§’è‰²å¹¶èšåˆæ¯ä¸ªç­¾åè€…å‘é€çš„ç­¾åã€‚éªŒè¯è€…éªŒè¯æ±‡æ€»çš„ç­¾åã€‚èšåˆè€…å’ŒéªŒè¯è€…çš„è§’è‰²å¯ä»¥ç”±åŒä¸€ä¸ªå®ä½“æ¥æ‰®æ¼”ã€‚æ¯ä¸ªç­¾åè€…Piæ‹¥æœ‰å¥¹è‡ªå·±çš„ç”¨äºEC-Schnorrå•ç­¾åè€…æ–¹æ¡ˆçš„å…¬å…±ç§é’¥å¯¹ï¼ˆpkiï¼Œskiï¼‰ã€‚</p><p>æˆ‘ä»¬ç”¨P = {pk1ï¼Œã€‚ ã€‚ ã€‚ ï¼ŒpkT}è¡¨ç¤ºæ‰€æœ‰å…¬é’¥çš„é›†åˆã€‚æˆ‘ä»¬è¿˜å‡è®¾æ¯ä¸ªå®ä½“éƒ½çŸ¥é“å…¬å…±æ¶ˆæ¯mpã€‚æ¶ˆæ¯mpå¯èƒ½æ˜¯ç‰¹å®šäºåº”ç”¨åœºæ™¯çš„ï¼Œå¹¶é‡‡å–ä»¥ä¸‹å½¢å¼ï¼šæˆ‘çŸ¥é“ä¼šè¯IDä¸ºXXXXçš„å…¬é’¥çš„ç§é’¥ã€‚è¿™ä¸ªæ¶ˆæ¯çš„ç›®çš„æ˜¯ä¸ºäº†å‡»è´¥å¯¹è¯¥æ–¹æ¡ˆçš„æŸäº›å·²çŸ¥æ”»å‡»[26]ã€‚</p></li><li><p>å¤šé‡ç­¾ååè®®ï¼šå¤šé‡ç­¾åæ˜¯ç­¾åè€…ï¼Œèšåˆå™¨å’ŒéªŒè¯è€…ä¹‹é—´çš„äº¤äº’åè®®ï¼ˆå‚è§å›¾2çš„ç¤ºæ„å›¾ï¼‰ã€‚è¯¥åè®®æœ‰å…­ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚</p><ol><li><p>ï¼ˆä¸€æ¬¡æ€§ï¼‰èº«ä»½è®¾ç½®ï¼šæ­¤æ­¥éª¤åœ¨æ¯ä¸ªå‚ä¸è€…å’ŒéªŒè¯è€…ä¹‹é—´è¿è¡Œã€‚åœ¨åè®®å¼€å§‹æ—¶ï¼Œæ¯ä¸ªç­¾åè€…Piå¦‚æœå½“å‰ä¸æ¶‰åŠå¦ä¸€ä¸ªç­¾ååè®®ï¼Œåˆ™åœ¨æ¶ˆæ¯mpä¸Šç”ŸæˆEC-Schnorrç­¾åÏƒiã€‚ç„¶åPiå°†ï¼ˆÏƒiï¼Œpkiï¼‰å‘é€ç»™éªŒè¯è€…ã€‚éªŒè¯è€…ç„¶åæ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š</p><ul><li>æ£€æŸ¥pkiâˆˆP.å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œæ£€éªŒå™¨å°†ä¸­æ­¢ã€‚</li><li>é€šè¿‡è°ƒç”¨Verifyï¼ˆCï¼ŒÏƒiï¼Œpkiï¼Œmpï¼‰æ¥æ£€æŸ¥æ¯ä¸ªÏƒiæ˜¯å¦æ˜¯pkiä¸Šmpçš„æœ‰æ•ˆEC-Schnorrç­¾åã€‚å¦‚æœä»»ä½•è¿™äº›ç­¾åéªŒè¯è¿”å›0ï¼Œåˆ™éªŒè¯ç¨‹åºä¸­æ­¢ã€‚å¦‚æœæ‰€æœ‰ç­¾åå‡æœ‰æ•ˆï¼Œåˆ™åè®®è¿›è¡Œåˆ°ä¸‹ä¸€æ­¥ã€‚</li></ul><p>å¦‚æœéªŒè¯ç¨‹åºæ²¡æœ‰æ”¶åˆ°Pä¸­æ¯ä¸ªpkiçš„Ïƒiï¼Œå¥¹ä¹Ÿä¼šä¸­æ­¢ã€‚ä¸ºäº†è®°å½•å¥¹æ˜¯å¦æ”¶åˆ°æ¥è‡ªPiçš„ç­¾åï¼Œå¥¹ä½¿ç”¨ä½å›¾Z [1ï¼Œâ€¦ã€‚ ã€‚ ã€‚ ï¼Œ| P |] .èº«ä»½è®¾ç½®æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§è¿‡ç¨‹ï¼Œéšåæ˜¯ä»»æ„æ•°é‡çš„ä¸‹ä¸€æ­¥ã€‚åªæœ‰åœ¨è®¾ç½®æˆåŠŸç»“æŸåï¼Œåè®®çš„åç»­æ­¥éª¤æ‰èƒ½å¼€å§‹ã€‚</p></li><li><p>commitment é˜¶æ®µï¼šæ¯ä¸ªç­¾åè€…Piéšåé€‰æ‹©ä¸€ä¸ªéšæœºki $â†[1ï¼Œn-1]å¹¶è®¡ç®—Qi = [ki] Gã€‚å›æƒ³ä¸€ä¸‹ï¼ŒGæ˜¯æ¤­åœ†æ›²çº¿ä¸Šçš„åŸºç‚¹ï¼Œnæ˜¯Gçš„é˜¶æ•°.Piç„¶åå°†Qiå‘é€ç»™èšåˆå™¨ã€‚</p></li><li><p>Challenge é˜¶æ®µï¼šèšåˆå™¨é¦–å…ˆç”¨Pä¸­çš„å¯†é’¥è®¡ç®—èšåˆå¯†é’¥ã€‚å¥¹è¿˜è®¡ç®—å‰ä¸€æ­¥éª¤ä¸­æ¥æ”¶åˆ°çš„Qiçš„èšåˆã€‚ç„¶åå¥¹è®¡ç®—râ†Hï¼ˆQ || pk || mï¼‰mod nå¹¶å°†ï¼ˆrï¼ŒQï¼Œpkï¼‰å‘é€ç»™æ¯ä¸ªPi</p></li><li><p>å“åº”ç”Ÿæˆï¼šæ¯ä¸ªç­¾åè€…Pié¦–å…ˆæ£€æŸ¥ä¹‹å‰æ”¶åˆ°çš„rçš„å®Œæ•´æ€§ã€‚è¿™æ˜¯é€šè¿‡é‡æ–°è®¡ç®—Hï¼ˆQ || pk || mï¼‰å¹¶æ£€æŸ¥å®ƒæ˜¯å¦ç­‰äºæ¥æ”¶åˆ°çš„ræ¥å®Œæˆçš„ã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œåˆ™Piä¼šä¸­æ­¢åè®®æˆ–è€…ç”Ÿæˆsiâ†ï¼ˆki -rÂ·skiï¼‰mod nå¹¶å°†siå‘é€ç»™èšåˆå™¨ã€‚</p></li><li><p>å“åº”èšåˆï¼šèšåˆå™¨è®¡ç®—èšåˆå“åº”s = Pi si mod nå¹¶å»ºç«‹èšåˆç­¾åÏƒ=ï¼ˆrï¼Œsï¼‰ã€‚ç„¶åï¼Œå¥¹å°†ï¼ˆmï¼ŒÏƒï¼‰å‘é€ç»™éªŒè¯è€…ã€‚</p></li><li><p>ç­¾åéªŒè¯ï¼šVerifierç°åœ¨æ£€æŸ¥ç­¾åæ˜¯å¦æœ‰æ•ˆã€‚å¥¹æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li>å°†Pä¸­çš„å…¬é’¥é›†ä¸­ä¸ºpk0ã€‚</li><li>é€šè¿‡è°ƒç”¨ï¼Œæ£€æŸ¥Ïƒæ˜¯å¦ä¸ºmä¸Šå…¬é’¥pk0çš„æœ‰æ•ˆEC-Schnorrç­¾å</li></ul></li></ol></li></ul><p>æœ‰ç‚¹éš¾ç†è§£ï¼Œä»¥ä¸‹æ¯”è¾ƒåå¥½ç†è§£çš„è§’åº¦æ¥è¯´ã€‚</p><p>å¤šé‡ç­¾åæ–¹æ¡ˆåŸºæœ¬ä¸Šåˆ†ä¸¤æ­¥è¿›è¡Œã€‚åœ¨åè®®çš„ç¬¬ä¸€æ­¥ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å°†å…¶å…¬é’¥å‘é€ç»™èšåˆè€…ï¼Œèšåˆè€…æ ¹æ®å…¬é’¥çš„æ•°å­¦å½¢å¼ï¼Œé€šè¿‡ç®€å•çš„åŠ æ³•æˆ–ä¹˜æ³•å°†ä¹‹èšåˆä¸ºä¸€ä¸ªå•ä¸€çš„å…¬é’¥ã€‚</p><p>ä¾‹å¦‚ï¼Œèšåˆå…¬é’¥= å…¬é’¥_1 + å…¬é’¥_2 + â€¦+å…¬é’¥_nã€‚</p><p>ç„¶åèšåˆè€…å°†èšåˆå…¬é’¥è½¬å‘ç»™éªŒè¯è€…ä»è€Œå¯ä»¥ä½¿åè€…éªŒè¯èšåˆç­¾åï¼Œä¸æ­¤åŒæ—¶èšåˆè€…ä¹Ÿå°†èšåˆå…¬é’¥å‘é€ç»™æ¯ä¸ªç­¾åè€…è®©æ‰€æœ‰äººç­¾åã€‚</p><p>åœ¨ç¬¬äºŒæ­¥ä¸­ï¼Œèšåˆè€…å¯åŠ¨ä¸æ¯ä¸ªç­¾åè€…çš„äº¤äº’åè®®ï¼ˆinteractive protocolï¼‰ã€‚è¿™ä¸ªäº¤äº’åè®®æ€»åˆ†åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼š</p><p><strong>1ã€æäº¤é˜¶æ®µï¼ˆCommit phaseï¼‰ï¼š</strong>æ­¤é˜¶æ®µæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆä¸€äº›éšæœºå†…å®¹å¹¶æäº¤ç»™äº¤äº’åè®®ã€‚å¦‚æœä½ ä¸äº†è§£ä»€ä¹ˆæ˜¯åŠ å¯†æäº¤ï¼ˆcryptographic commitmentï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è¿™ç§ç±»æ¯”çš„æ–¹å¼ç†è§£ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½ç§˜å¯†åœ°æ·éª°å­ï¼Œç„¶åå°†ç»“æœå†™åœ¨ä¸€å¼ çº¸ä¸Šå¹¶å°†å…¶æ”¾åœ¨ä¸€ä¸ªç›’å­ä¸­é”å¥½ï¼Œæœ€åå‘é€ç»™èšåˆè€…ã€‚èšåˆè€…æ— æƒæ‰“å¼€ç›’å­ã€‚</p><p><strong>2ã€æŒ‘æˆ˜é˜¶æ®µï¼ˆChallenge phaseï¼‰ï¼š</strong>æ­¤é˜¶æ®µèšåˆè€…é¦–å…ˆä½¿ç”¨åŠ æ³•æˆ–ä¹˜æ³•å°†æ‰€æœ‰çš„æäº¤èšåˆä¸ºä¸€ä¸ªèšåˆæäº¤ï¼Œç„¶åä½¿ç”¨å®ƒä»¥åŠèšåˆå…¬é’¥ã€æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ªæŒ‘æˆ˜ï¼Œå†å°†æŒ‘æˆ˜å‘é€åˆ°æ‰€æœ‰èŠ‚ç‚¹ã€‚ä¹‹åæŒ‘æˆ˜å¯ç”¨äºç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹éƒ½çŸ¥é“å…¬é’¥å¯¹åº”çš„ç§é’¥ã€‚è¿™ä¸å¸¸è§„æ•°å­—ç­¾åçš„å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼Œå³ç”±ç­¾åè¯æ˜ç­¾åäººç¡®å®çŸ¥é“ç§é’¥ã€‚</p><p><strong>3ã€å›åº”é˜¶æ®µï¼ˆResponse phaseï¼‰ï¼š</strong>æ‰€æœ‰èŠ‚ç‚¹ä¸ºäº†åº”å¯¹æŒ‘æˆ˜ä¼šå‘æŒ‘æˆ˜å‘é€ç§é’¥è¿›è¡Œå›åº”ï¼Œä¹‹åèšåˆè€…å°†èšåˆæ‰€æœ‰çš„å›åº”ã€‚å› æ­¤å›åº”å¯è¢«è§†ä¸ºç­¾åè€…çŸ¥é“å…¶å…¬é’¥å¯¹åº”çš„ç§é’¥çš„è¯æ®ã€‚</p><p>å› æ­¤ï¼Œæœ€åçš„èšåˆç­¾åå®é™…ä¸Šæ˜¯æŒ‘æˆ˜å’Œèšåˆå›åº”çš„ä¿¡æ¯å¯¹ï¼Œå¹¶èƒ½éªŒè¯ç¬¬ä¸€æ­¥ç”Ÿæˆçš„èšåˆå…¬é’¥ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œèšåˆç­¾åçš„å¤§å°ä¸å–å†³äºç­¾åè€…çš„æ•°é‡ï¼Œå®ƒæ˜¯å›ºå®šçš„ã€‚</p><p>å›¾ä¸­è“è‰²çš„èŠ‚ç‚¹æ˜¯èšåˆè€…ã€‚Hæ˜¯ç”¨äºå°†æ¶ˆæ¯mç”ŸæˆæŒ‘æˆ˜çš„å¯†ç æ•£åˆ—å‡½æ•°ã€‚èšåˆç­¾åå°±æ˜¯Rå’ŒSçš„ä¿¡æ¯å¯¹ã€‚Rçš„å¤§å°ç­‰äºRiï¼ŒSçš„å¤§å°ç­‰äºSiçš„ã€‚ä»…åœ¨çŸ¥é“ç§é’¥çš„æƒ…å†µä¸‹æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆçš„å›åº”ã€‚</p><p>å½“éªŒè¯è€…æ£€æŸ¥èšåˆç­¾åæ—¶ï¼Œå®ƒæ£€æŸ¥çš„ä¸æ˜¯æ¯ä¸ªå•ç‹¬ç­¾åè€…æ˜¯å¦éƒ½æ­£ç¡®åœ°éµå®ˆåè®®ï¼Œè€Œæ˜¯æ£€æŸ¥æ‰€æœ‰ç­¾åè€…ä½œä¸ºä¸€ä¸ªæ•´ä½“æ˜¯å¦æ­£ç¡®åœ°éµå®ˆåè®®å¹¶çŸ¥é“ç§é’¥ã€‚å› æ­¤ï¼ŒéªŒè¯è€…åšå‡ºçš„å†³å®šæ˜¯å…¨æœ‰æˆ–å…¨æ— ï¼ˆall-or-nothingï¼‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> zilliqa </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>blockchain</title>
      <link href="/2019/10/14/blockchain/"/>
      <url>/2019/10/14/blockchain/</url>
      
        <content type="html"><![CDATA[<h2 id="åŒºå—é“¾"><a href="#åŒºå—é“¾" class="headerlink" title="åŒºå—é“¾"></a>åŒºå—é“¾</h2><p>åŒºå—é“¾çš„æœ¬è´¨ï¼Œæ˜¯å»ä¸­å¿ƒåŒ–çš„åˆ†å¸ƒå¼çš„æ•°æ®åº“ç³»ç»Ÿï¼Œå®ç°äº†æ•°æ®å…¬å¼€ã€é€æ˜ã€å¯è¿½æº¯ã€‚</p><p>åŒºå—é“¾æŠ€æœ¯ï¼Œå¹¿ä¹‰ä¸Šæ¥è¯´ï¼ŒåŒºå—é“¾æŠ€æœ¯æ˜¯å®ç°äº†æ•°æ®å…¬å¼€é€æ˜å¯è¿½æº¯çš„äº§å“çš„æ¶æ„æ¶‰åŠæ–¹æ³•ï¼Œå¿…é¡»åŒ…å«ç‚¹å¯¹ç‚¹ç½‘ç»œè®¾è®¡ã€åŠ å¯†æŠ€æœ¯åº”ç”¨ã€åˆ†å¸ƒå¼ç®—æ³•çš„å®ç°ã€æ•°æ®å­˜å‚¨æŠ€æœ¯çš„ä½¿ç”¨ç­‰4æ–¹é¢ï¼Œå¯èƒ½è¿˜æ¶‰åŠåˆ°åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæœºå™¨å­¦ä¹ ï¼ŒVRï¼Œç‰©è”ç½‘ï¼Œå¤§æ•°æ®ç­‰ï¼›ç‹­ä¹‰ä¸Šæ¥è¯´ï¼ŒåŒºå—é“¾æ˜¯æŒ‡ç±»ä¼¼æ¯”ç‰¹å¸çš„æ•°æ®å­˜å‚¨æ–¹å¼æˆ–æ•°æ®åº“å®ç°ï¼Œä»…ä»…æ¶‰åŠåˆ°æ•°æ®å­˜å‚¨æŠ€æœ¯ï¼Œæ•°æ®åº“æˆ–æ–‡ä»¶æ“ä½œç­‰ã€‚</p><p>ä»æ¶æ„ä¸Šæ¥è¯´ï¼ŒåŒºå—é“¾ç”±ä¸‹åˆ°ä¸Šå¯ä»¥ç®€å•çš„åˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼Œ<strong>åè®®å±‚</strong>ã€<strong>æ‰©å±•å±‚</strong>å’Œ<strong>åº”ç”¨å±‚</strong>ã€‚æœ€åº•å±‚çš„åè®®å±‚åˆ†ä¸ºå­˜å‚¨å±‚å’Œç½‘ç»œå±‚ï¼Œå­˜å‚¨å±‚å­˜å‚¨å„ä¸ªåŒºå—ï¼Œç»„æˆåŒºå—é“¾ï¼Œå­˜å‚¨å±‚çš„ä¸Šæ–¹æ˜¯ç½‘ç»œå±‚ï¼Œç½‘ç»œå±‚çš„ä¸»è¦å·¥ä½œæ˜¯é€šè¿‡æŒ–çŸ¿æŠ•ç¥¨ç­‰å…±è¯†ç®—æ³•ä¿éšœèŠ‚ç‚¹å®‰å…¨ï¼Œç½‘ç»œå±‚å†å‘ä¸Šï¼Œä¾¿æ˜¯æ‰©å±•å±‚äº†ï¼Œæ‰©å±•å±‚ä¸­å«æœ‰çš„æ‰©å±•ä¾‹å¦‚æ™ºèƒ½åˆçº¦ã€å„ç§ä¾§é“¾åº”ç”¨ï¼Œæˆ–è€…æ–‡æ¡£ã€å›¾ä¹¦ç”µå­ä¹¦è§†é¢‘ç­‰ç”¨æˆ·æ•°æ®æ–‡ä»¶å­˜å‚¨æˆ–åˆ†äº«ç­‰..åº”ç”¨å±‚å°±è¦å°±æ˜¯å¯è§†åŒ–æ“ä½œç­‰..</p><p><strong>åè®®å±‚</strong>æ¶‰åŠçš„æŠ€æœ¯ä¸»è¦æ˜¯ï¼Œç½‘ç»œç¼–ç¨‹ï¼ŒåŠ å¯†ç­¾åï¼Œåˆ†å¸ƒç®—æ³•ï¼Œæ•°æ®å­˜å‚¨ã€‚æ€»çš„çœ‹æ¥ï¼Œç½‘ç»œçš„å®ç°å’Œå¹¶å‘å¤„ç†æ˜¯å¼€å‘çš„éš¾ç‚¹ï¼Œæ•…å¼€å‘è¯­è¨€é€‰æ‹©ä¼˜å…ˆé€‰æ‹©ç½‘ç»œç¼–ç¨‹èƒ½åŠ›å¼ºï¼Œå¹¶å‘å¤„ç†ç®€å•çš„è¯­è¨€ï¼Œä¾‹å¦‚Nodejs,Goã€‚</p><p><strong>æ‰©å±•å±‚</strong>çš„ç¼–ç¨‹è¯­è¨€ä¸åè®®å±‚çš„ç¼–ç¨‹è¯­è¨€å¯ä»¥ä¸ç”¨ï¼Œå› ä¸ºäºŒè€…äº¤äº’æ˜¯é€šè¿‡http/rpcæˆ–json/rpcå®ç°ï¼ŒäºŒè€…åŸºæœ¬å®Œå…¨åˆ†ç±»ï¼ŒäºŒè€…é™¤äº†åœ¨äº¤æ˜“æ—¶å‘ç”Ÿäº¤äº’ä¹‹å¤–ï¼Œå…¶ä»–æ—¶å€™å°½é‡ä¸è¦æ··åœ¨ä¸€èµ·ã€‚æ‰©å±•å±‚ä¸åº”ç”¨å±‚æ›´åŠ æ¥è¿‘ï¼Œä¹Ÿå¯ä»¥ç†è§£ä½B/Sæ¶æ„çš„äº§å“ä¸­çš„æœåŠ¡ç«¯ï¼ˆServerï¼‰ã€‚</p><h4 id="å…±è¯†æœºåˆ¶"><a href="#å…±è¯†æœºåˆ¶" class="headerlink" title="å…±è¯†æœºåˆ¶"></a>å…±è¯†æœºåˆ¶</h4><p>åŒºå—é“¾æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œå»ä¸­å¿ƒåŒ–çš„åŸºç¡€å°±æ˜¯èŠ‚ç‚¹ä¼—å¤šï¼Œé‚£ä¹ˆå¦‚ä½•å¸å¼•ç”¨æˆ·åŠ å…¥ç½‘ç»œæˆä¸ºèŠ‚ç‚¹ï¼Œæœ‰å“ªäº›æ¿€åŠ±æœºåˆ¶ï¼ŸåŒæ—¶ï¼Œå¼€å‘çš„é‡ç‚¹æ˜¯è®©å¤šä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆå¦‚ä½•å†³å®šå“ªä¸ªèŠ‚ç‚¹å†™å…¥ï¼Ÿä½•æ—¶å†™å…¥ï¼Ÿä¸€æ—¦å†™å…¥ï¼Œåˆæ€ä¹ˆä¿è¯ä¸è¢«å…¶ä»–çš„èŠ‚ç‚¹æ›´æ”¹ï¼ˆä¸å¯é€†ï¼‰ï¼Ÿè¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼Œå°±æ˜¯å…±è¯†æœºåˆ¶ã€‚å…±è¯†æœºåˆ¶å¯é˜²åŒèŠ±</p><ul><li>POWï¼Œ å·¥ä½œé‡è¯æ˜ï¼Œå¼•å…¥äº†å¯¹ä¸€ä¸ªç‰¹å®šå€¼çš„è®¡ç®—å·¥ä½œï¼Œæ¯”ç‰¹å¸é‡‡ç”¨çš„å…±è¯†ç®—æ³•å°±æ˜¯POW</li><li>POSï¼Œæƒç›Šè¯æ˜ï¼Œç®€å•è¯´æ¥ï¼Œè¿™ç§æœºåˆ¶é€šè¿‡è®¡ç®—ä½ æŒæœ‰å æ€»å¸æ•°çš„ç™¾åˆ†æ¯”ï¼ŒåŒ…æ‹¬ä½ å æœ‰å¸æ•°çš„æ—¶é—´æ¥å†³å®šè®°è´¦æƒã€‚å› æ­¤åœ¨PoSä¸­ï¼Œä¸€ä¸ªè´¦æˆ·çš„ä½™é¢è¶Šå¤šï¼Œåœ¨åŒç­‰ç®—åŠ›ä¸‹ï¼Œå°±è¶Šå®¹æ˜“å‘ç°ä¸‹ä¸€ä¸ªåŒºå—ã€‚</li><li>DPOSï¼Œ  å§”æ‰˜æƒç›Šè¯æ˜</li><li>PBFTï¼Œ å®ç”¨æ‹œå åº­å®¹é”™</li></ul><h4 id="æ™ºèƒ½åˆçº¦"><a href="#æ™ºèƒ½åˆçº¦" class="headerlink" title="æ™ºèƒ½åˆçº¦"></a>æ™ºèƒ½åˆçº¦</h4><p>æ™ºèƒ½åˆçº¦å°±æ˜¯å¯ç¼–ç¨‹åˆçº¦ï¼Œæˆ–è€…å«åšåˆçº¦æ™ºèƒ½åŒ–ï¼Œå…¶ä¸­çš„â€æ™ºèƒ½â€æ˜¯æ‰§è¡Œä¸Šçš„æ™ºèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´è¾¾åˆ°æŸä¸ªæ¡ä»¶ï¼Œåˆçº¦è‡ªåŠ¨æ‰§è¡Œï¼Œæ¯”å¦‚è‡ªåŠ¨è½¬ç§»è¯åˆ¸ã€è‡ªåŠ¨ä»˜æ¬¾ç­‰</p><h4 id="åŠ å¯†è´§å¸"><a href="#åŠ å¯†è´§å¸" class="headerlink" title="åŠ å¯†è´§å¸"></a>åŠ å¯†è´§å¸</h4><p>ç”Ÿæ´»ä¸­æ¥è§¦åˆ°çš„æ•°å­—è´§å¸å¾ˆå¤šï¼ŒåƒQå¸ç­‰çš„å¹³å°å†…å¸ï¼Œè¿™äº›ç”¨â€œä»£å¸â€æ¥ç§°å‘¼æ›´ä¸ºé€‚åˆã€‚é‚£ä¹ˆåŠ å¯†è´§å¸å’Œè¿™äº›â€œä»£å¸â€åˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸåŠ å¯†è´§å¸å®šä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>åŠ å¯†è´§å¸ï¼Œæ˜¯ä¸€ç§åŸºäºç‚¹å¯¹ç‚¹ç½‘ç»œï¼ˆP2Pç½‘ç»œ)ã€æ²¡æœ‰å‘è¡Œæœºæ„ã€æ€»é‡åŸºæœ¬å›ºå®šçš„åŠ å¯†ç”µå­é€šè´§ã€‚</p></blockquote><ol><li>P2Pç½‘ç»œï¼šè¿™ä¸ªä¸æ˜¯ä»€ä¹ˆæ–°é²œç©æ„ï¼Œæœ€æ—©æˆ‘ä»¬ä½¿ç”¨çš„BT(BitTorrent)ä¸‹è½½ï¼Œå°±æ˜¯åŸºäºP2Pç½‘ç»œçš„ï¼Œç°åœ¨å¾ˆå¤šä¸‹è½½å·¥å…·éƒ½æ”¯æŒã€‚å®ƒçš„å¥½å¤„å°±æ˜¯â€œå»ä¸­å¿ƒåŒ–â€ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä¸­å¤®æœåŠ¡å™¨ï¼Œè¦ä¸‹è½½çš„æ–‡ä»¶éƒ½åœ¨ç”¨æˆ·è‡ªå·±ç”µè„‘ä¸Šï¼Œè€Œä¸”ä¸‹è½½é€Ÿåº¦æ›´å¿«;</li><li>æ²¡æœ‰å‘è¡Œæœºæ„ï¼šå°±æ˜¯è¯´ï¼Œä¸æ˜¯é‚£ä¸ªå…¬å¸ã€é“¶è¡Œæˆ–å›½å®¶æ§åˆ¶å‘è¡Œçš„ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼ŒåŒæ—¶é˜²æ­¢é€šè´§è†¨èƒ€ç­‰å› ç´ ï¼Œéœ€è¦åœ¨ç¼–ç¨‹ä¸­ä½¿ç”¨éå¸¸å¤æ‚çš„æœºåˆ¶å’Œè§„åˆ™æ¥å®ç°ã€‚</li><li>æ€»é‡åŸºæœ¬å›ºå®šï¼šè¿™æ˜¯ä¿è¯åŠ å¯†è´§å¸ä»·å€¼çš„ä¸€ç§ç­–ç•¥ï¼Œâ€œç‰©ä»¥ç¨€ä¸ºè´µâ€ï¼Œä»»ä½•ä¸œè¥¿æ²¡æœ‰ä¸Šé™å°±ä¼šå¤±å»å®ƒçš„å¸å¼•åŠ›ã€‚è¿™ä¸€ç‚¹ï¼ŒåŒºåˆ«äºå¾ˆå¤šç½‘ç»œç¤¾åŒºä½¿ç”¨çš„ç§¯åˆ†ï¼Œæ¯”å¦‚ï¼šAå¸ã€Cå¸ã€Qå¸ã€Så¸ç­‰ã€‚</li><li>åŠ å¯†ï¼šè¿™é‡Œè¯´çš„åŠ å¯†ï¼Œä¸æ˜¯ç”¨æˆ·ä½¿ç”¨çš„è¾“å…¥ç”¨æˆ·åã€å¯†ç é‚£ç§ç®€å•çš„æƒé™æ§åˆ¶ï¼Œè€Œæ˜¯å¯¹æ¯ä¸€ä¸ªäº§ç”Ÿçš„ç”µå­è´§å¸æœ¬èº«çš„äº¤æ˜“ä¸ä¼ è¾“çš„åŠ å¯†ã€‚å¯†ç å­¦æœ¬èº«å¾ˆå¤æ‚ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒå¹¶ä¸å¤æ‚ï¼Œæ˜ç™½è¿™ä¸ªå°±è¶³å¤Ÿäº†ã€‚</li><li>ç”µå­é€šè´§ï¼šä¹Ÿå°±æ˜¯è¯´åŠ å¯†è´§å¸å°±æ˜¯è´§å¸ï¼Œè·Ÿæ³•å¸ä¸€æ ·ï¼Œå¯ä»¥è‡ªç”±äº¤æ˜“ï¼Œåªä¸è¿‡æ˜¯ä¸€ç§ç”µå­ï¼ˆæ•°å­—ï¼‰å½¢å¼è€Œå·²ã€‚</li></ol><h4 id="ååé‡"><a href="#ååé‡" class="headerlink" title="ååé‡"></a>ååé‡</h4><p>åŒºå—é“¾æ¯ç§’äº¤æ˜“é‡ã€‚ååé‡å¯¹äºåŒºå—é“¾é¡¹ç›®æ¥è¯´ï¼Œè¿˜ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ã€‚å…±è¯†ç®—æ³•ä¸­ï¼Œé‡‡ç”¨POW/POSçš„åŒºå—é“¾çš„ååé‡å°±å—åˆ°äº†æå¤§çš„é™åˆ¶ï¼Œååé‡ä¸è¶…è¿‡100tx/sï¼Œä¾‹å¦‚æ¯”ç‰¹å¸å’Œä»¥å¤ªåŠã€‚åŸå› åœ¨äºå•çº¯çš„æé«˜åŒºå—å¤§å°æˆ–è€…å‡å°‘åŒºå—ç”Ÿæˆä¹‹é—´çš„æ—¶é—´è§£å†³ä¸äº†é—®é¢˜ï¼Œå› ä¸ºåŒºå—éœ€è¦æ—¶é—´ä¼ è¾“éªŒè¯ï¼Œå¦‚æœåŒºå—å¤ªå¤§ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆç½‘ç»œèŠ‚ç‚¹çš„ä¸ä¸€è‡´æ€§åŠ é‡ï¼ˆåˆ†å‰å˜å¤šï¼‰ï¼Œä»è€Œä¸¥é‡å½±å“å¯é æ€§ã€‚DPOSé€šè¿‡ç¼©å°å‚ä¸æ ¸å¿ƒå…±è¯†è¿‡ç¨‹çš„èŠ‚ç‚¹æ•°é‡ï¼Œæé«˜å…±è¯†æ•ˆç‡ã€‚PBFTå¯¹äºèŠ‚ç‚¹æ•°é‡å°‘(å°äº100)çš„æƒ…å†µä¸‹ï¼Œäº¤æ˜“é‡å¤§æ¦‚è¿˜èƒ½æœ‰1000tx/sè¿™æ ·ã€‚</p><h4 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h4><p>ä»£å¸ã€‚</p><ul><li>ICOï¼š å½“æŸæ–¹ä»¥æŸä¸ªä»·æ ¼å‘æŠ•èµ„è€…æä¾›ä¸€äº›æ–°çš„åŠ å¯†è´§å¸ï¼ˆå³ä»£å¸ï¼‰æ—¶ï¼Œå¯ä»¥ä¸å…¶ä»–åŠ å¯†è´§å¸ï¼ˆå³ä»£å¸ï¼‰è¿›è¡Œäº¤æ¢ã€‚ è¿™ä¸ªæƒ³æ³•æ˜¯æŠ•èµ„è€…è´­ä¹°è¿™äº›ä»£å¸ï¼Œä»£å¸å¯ä»¥è¿›è¡Œäº’æ¢å’Œè½¬ç§»ã€‚é”€å”®ä»£å¸ç­¹èµ„çš„æ¦‚å¿µç§°ä½œInitial Coin Offeræˆ–ICO</li></ul><h4 id="ç¡¬åˆ†å‰-è½¯åˆ†å‰"><a href="#ç¡¬åˆ†å‰-è½¯åˆ†å‰" class="headerlink" title="ç¡¬åˆ†å‰/è½¯åˆ†å‰"></a>ç¡¬åˆ†å‰/è½¯åˆ†å‰</h4><p><strong>æ¯”ç‰¹å¸äº¤æ˜“å…¶ä¸­ä¸€ä¸ªå«ä¹‰æŒ‡çš„æ˜¯æˆ‘ä»¬å‘é€æ¯”ç‰¹å¸ç»Ÿä¸€ä½¿ç”¨çš„æ•°æ®ç»“æ„</strong>ï¼Œè¿™æ˜¯ä¸€å¥—è§„åˆ™ï¼Œæˆ‘ä»¬æ‰€æœ‰äººå‘é€æ¯”ç‰¹å¸ï¼Œä¸è®ºä½ ä½¿ç”¨ä»€ä¹ˆé’±åŒ…è½¯ä»¶éƒ½å¾—éµå®ˆè¿™ä¸€å¥—è§„åˆ™ã€‚</p><p>ç¡¬åˆ†å‰å®šä¹‰</p><blockquote><p>ç¡¬åˆ†å‰æ˜¯æŒ‡æ¯”ç‰¹å¸åŒºå—æ ¼å¼æˆ–äº¤æ˜“æ ¼å¼ï¼ˆè¿™å°±æ˜¯å¹¿æ³›æµä¼ çš„â€œå…±è¯†â€ï¼‰å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæœªå‡çº§çš„èŠ‚ç‚¹æ‹’ç»éªŒè¯å·²ç»å‡çº§çš„èŠ‚ç‚¹ç”Ÿäº§å‡ºçš„åŒºå—ï¼Œä¸è¿‡å·²ç»å‡çº§çš„èŠ‚ç‚¹å¯ä»¥éªŒè¯æœªå‡çº§èŠ‚ç‚¹ç”Ÿäº§å‡ºçš„åŒºå—ï¼Œç„¶åå¤§å®¶å„è‡ªå»¶ç»­è‡ªå·±è®¤ä¸ºæ­£ç¡®çš„é“¾ï¼Œæ‰€ä»¥åˆ†æˆä¸¤æ¡é“¾ã€‚</p></blockquote><p>è½¯åˆ†å‰å®šä¹‰</p><blockquote><p>è½¯åˆ†å‰æ˜¯æŒ‡æ¯”ç‰¹å¸äº¤æ˜“çš„æ•°æ®ç»“æ„ï¼ˆè¿™å°±æ˜¯è¢«å¹¿æ³›æµä¼ çš„â€œå…±è¯†â€ï¼‰å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæœªå‡çº§çš„èŠ‚ç‚¹å¯ä»¥éªŒè¯å·²ç»å‡çº§çš„èŠ‚ç‚¹ç”Ÿäº§å‡ºçš„åŒºå—ï¼Œè€Œä¸”å·²ç»å‡çº§çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥éªŒè¯æœªå‡çº§çš„èŠ‚ç‚¹ç”Ÿäº§å‡ºçš„åŒºå—ã€‚</p></blockquote><p>ç¡¬åˆ†å‰ä¸å‘å‰å…¼å®¹ï¼Œæ—§ç‰ˆæœ¬ä¸ä¼šæ¥å—æ–°ç‰ˆæœ¬åˆ›å»ºçš„åŒºå—ã€‚è¦å®ç°ç¡¬åˆ†å‰æ‰€æœ‰ç”¨æˆ·éƒ½éœ€è¦åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬åè®®ä¸Šã€‚</p><p>è½¯åˆ†å‰å‘å‰å…¼å®¹ï¼Œæ—§çš„ç‰ˆæœ¬ä¼šæ¥å—æ–°ç‰ˆæœ¬åˆ›å»ºçš„åŒºå—ï¼Œåœ¨è½¯åˆ†å‰ä¸­åªéœ€è¦çŸ¿å·¥å‡çº§åˆ°æ–°ç‰ˆæœ¬å³å¯ï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨æ—§ç‰ˆæœ¬çš„åè®®ï¼Œä»–ä»¬ä»ç„¶ä¼šæ¥å—æ–°ç‰ˆæœ¬åè®®åˆ›å»ºçš„åŒºå—ã€‚å¦‚æœæœ‰è‡³å°‘51%çš„çŸ¿å·¥çš„ç®—åŠ›è½¬å‘çš„æ–°ç‰ˆæœ¬ï¼Œé‚£ä¹ˆç½‘ç»œè‡ªåŠ¨å®Œæˆè½¯åˆ†å‰ï¼šä¸€å¼€å§‹æ—§ç‰ˆæœ¬åˆ›å»ºçš„åŒºå—åœ¨æ–°åè®®ä¸‹è¢«è®¤ä¸ºæ˜¯ä¸åˆæ³•çš„ï¼Œè¿™æ—¶ä¼šå‡ºç°ä¸€ä¸ªçŸ­æš‚çš„åˆ†å‰ï¼Œä½†æœ€ç»ˆæ–°ç‰ˆæœ¬çš„åˆ†å‰ä¼šèµ¶è¶…æ—§ç‰ˆæœ¬çš„åˆ†å‰æˆä¸ºæœ€é•¿é“¾ã€‚å› ä¸ºåœ¨æ—§ç‰ˆæœ¬ä¸Šçš„ç®—åŠ›æ˜¯å°äºæ–°ç‰ˆæœ¬çš„ã€‚</p><h4 id="çŸ³å¢¨çƒ¯æŠ€æœ¯"><a href="#çŸ³å¢¨çƒ¯æŠ€æœ¯" class="headerlink" title="çŸ³å¢¨çƒ¯æŠ€æœ¯"></a>çŸ³å¢¨çƒ¯æŠ€æœ¯</h4><p><a href="https://github.com/cryptonomex/graphene">githubåœ°å€</a></p><h3 id="bft"><a href="#bft" class="headerlink" title="bft"></a>bft</h3><p>æœ¬æ–‡æå‡ºäº†Zyzzyva1ï¼Œä¸€ç§ä½¿ç”¨æ¨æµ‹æ¥é™ä½æˆæœ¬å¹¶ç®€åŒ–BFTçŠ¶æ€æœºå¤åˆ¶è®¾è®¡çš„æ–°åè®®[18,34]ã€‚ä¸ä¼ ç»Ÿçš„çŠ¶æ€æœºå¤åˆ¶åè®®[9,32,40]ä¸€æ ·ï¼Œä¸»è¦æå‡ºäº†å®¢æˆ·ç«¯å¯¹å…¶ä»–å‰¯æœ¬çš„è¯·æ±‚çš„é¡ºåºã€‚åœ¨Zyzzyvaä¸­ï¼Œä¸ä¼ ç»Ÿåè®®ä¸åŒï¼Œå¤åˆ¶å“æ¨æµ‹æ€§åœ°æ‰§è¡Œè¯·æ±‚ï¼Œè€Œä¸è¿è¡Œæ˜‚è´µçš„åè®®åè®®æ¥ç¡®å®šè®¢å•ã€‚å› æ­¤ï¼Œæ­£ç¡®çš„å‰¯æœ¬çŠ¶æ€å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œå¹¶ä¸”å‰¯æœ¬å¯èƒ½ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸åŒçš„å“åº”ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®¢æˆ·ç«¯çš„åº”ç”¨ç¨‹åºè§‚å¯Ÿåˆ°å¤åˆ¶çŠ¶æ€æœºçš„ä¼ ç»Ÿå’Œå¼ºå¤§çš„æŠ½è±¡ï¼Œå®ƒä»¥å¯çº¿æ€§åŒ–[13]çš„é¡ºåºæ‰§è¡Œè¯·æ±‚ï¼Œå› ä¸ºç­”å¤å¸¦æœ‰è¶³å¤Ÿçš„å†å²ä¿¡æ¯ç»™å®¢æˆ·ç«¯ä»¥ç¡®å®šç­”å¤å’Œå†å²è®°å½•æ˜¯å¦ç¨³å®šå¹¶æœ€ç»ˆä¿è¯æœ€ç»ˆæ‰¿è¯ºã€‚å¦‚æœæ¨æµ‹å›å¤å’Œå†å²è®°å½•ç¨³å®šï¼Œåˆ™å®¢æˆ·ç«¯ä½¿ç”¨å›å¤ã€‚å¦åˆ™ï¼Œå®¢æˆ·ç«¯ä¼šç­‰å¾…ç³»ç»Ÿæ”¶æ•›äºç¨³å®šçš„å›å¤å’Œå†å²è®°å½•ã€‚</p><p>Zyzzyvaé¢ä¸´çš„æŒ‘æˆ˜æ˜¯ç¡®ä¿å¯¹æ­£ç¡®å®¢æˆ·çš„å“åº”å˜å¾—ç¨³å®šã€‚ æœ€ç»ˆï¼Œå‰¯æœ¬è´Ÿè´£ç¡®ä¿æ¥è‡ªæ­£ç¡®å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚æœ€ç»ˆå®Œæˆï¼Œä½†ç­‰å¾…å›å¤å¹¶ä¸”å†å²ç¨³å®šçš„å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æä¾›å°†å¯¼è‡´è¯·æ±‚åœ¨å½“å‰è§†å›¾å†…å¿«é€Ÿç¨³å®šçš„ä¿¡æ¯æ¥åŠ é€Ÿè¿›ç¨‹ æˆ–è§¦å‘è§†å›¾æ›´æ”¹ã€‚ è¯·æ³¨æ„ï¼Œç”±äºå®¢æˆ·ä¸éœ€è¦æäº¤è¯·æ±‚ï¼Œè€Œåªæ˜¯ä¸ºäº†ä¿æŒç¨³å®šï¼Œå› æ­¤å®¢æˆ·å¯ä»¥æŒ‰ç…§ä¸€åˆ°ä¸¤ä¸ªé˜¶æ®µè€Œä¸æ˜¯æƒ¯å¸¸çš„ä¸‰ä¸ªè¯·æ±‚è¡Œäº‹[9,32,40]ã€‚</p><p>é‰´äºBFTå¤åˆ¶åè®®å·²ç»åœ¨å®¢æˆ·ç«¯ä¸Šå®æ–½çš„èŒè´£[3,9,10,21,32,40]ï¼Œå°†è¾“å‡ºæäº¤å®Œå…¨ç§»äº¤ç»™å®¢æˆ·ç«¯å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ­¥éª¤ï¼Œä½†è¿™ä¸€å°æ­¥éª¤å¸¦æ¥äº†å·¨å¤§çš„æ”¶ç›Šã€‚é¦–å…ˆï¼ŒZyzzyvaåˆ©ç”¨æ¨æµ‹æ‰§è¡Œ - å¤åˆ¶å“åœ¨è®¢å•å®Œå…¨å»ºç«‹ä¹‹å‰æ‰§è¡Œè¯·æ±‚ã€‚å…¶æ¬¡ï¼ŒZyzzyvaåˆ©ç”¨å¿«é€Ÿåè®®åè®®[11,20,24]åœ¨å°‘è‡³ä¸‰ä¸ªæ¶ˆæ¯å»¶è¿Ÿçš„æƒ…å†µä¸‹å»ºç«‹è¯·æ±‚æ’åºã€‚ç¬¬ä¸‰ï¼Œä¸€æ—¦å®¢æˆ·çŸ¥é“è¯·æ±‚çš„é¡ºåºï¼Œåè®®å­åè®®å°±åœæ­¢å¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…åœ¨å‰¯æœ¬ä¸Šå»ºç«‹è¿™äº›çŸ¥è¯†æ‰€éœ€çš„å·¥ä½œã€‚</p><p>è¿™äº›é€‰æ‹©å¯¼è‡´è®¾è®¡Zyzzyvaæ—¶é‡åˆ°ä¸¤ä¸ªå…³é”®æŒ‘æˆ˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»ä»”ç»†åœ°æŒ‡å®šè¯·æ±‚åœ¨å®¢æˆ·ç«¯å®Œæˆçš„æ¡ä»¶ï¼Œå¹¶å®šä¹‰åè®®ï¼Œæ£€æŸ¥ç‚¹å’Œè§†å›¾å˜æ›´å­åè®®ï¼Œä»¥ä¿ç•™è¯·æ±‚åœ¨å•ä¸ªæ­£ç¡®çš„çŠ¶æ€æœºä¸Šæ‰§è¡Œçš„æŠ½è±¡ã€‚ç›´æ¥åœ°ï¼Œå½“æ­£ç¡®çš„å®¢æˆ·ç«¯å¯ä»¥å®‰å…¨åœ°å¤„ç†å¯¹è¯¥è¯·æ±‚çš„å›å¤ã€‚ä¸ºäº†å¸®åŠ©å®¢æˆ·ç¡®å®šä½•æ—¶é€‚åˆå›å¤ï¼ŒZyzzyvaä¼šå°†å†å²ä¿¡æ¯é™„åŠ åˆ°å®¢æˆ·æ”¶åˆ°çš„å›å¤ä¸­ï¼Œä»¥ä¾¿å®¢æˆ·å¯ä»¥åˆ¤æ–­å›å¤æ˜¯å¦åŸºäºç›¸åŒçš„è¯·æ±‚é¡ºåºã€‚</p><h4 id="åè®®æ¦‚è¿°"><a href="#åè®®æ¦‚è¿°" class="headerlink" title="åè®®æ¦‚è¿°"></a>åè®®æ¦‚è¿°</h4><p>3f+1ä¸ªèŠ‚ç‚¹replicasæ‰§è¡Œï¼Œç”±ä¸€ç³»åˆ—viewsç»„æˆï¼Œåœ¨ä¸€ä¸ªviewå†…ï¼Œä¸€ä¸ªå•ç‚¹çš„èŠ‚ç‚¹replicaè¢«æŒ‡å®šä¸ºä¸»è¦è´Ÿè´£å­åè®®å…±è¯†çš„leaderã€‚</p><p>å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ç»™åˆ°leader, leaderè½¬å‘ç»™å…¶ä½™replicas, æ”¶åˆ°è¯·æ±‚çš„replicasæ‰§è¡Œè¯·æ±‚å¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å®Œæˆ1ä¸ªè¯·æ±‚æœ‰ä¸¤ç§æ–¹å¼ï¼Œé¦–å…ˆï¼Œå¦‚æœå®¢æˆ·ç«¯æ”¶åˆ°3f+1ç›¸äº’ä¸€è‡´çš„å“åº”ç»“æœï¼ˆåŒ…æ‹¬historyå’Œapplication-levelçš„å›å¤ï¼‰ï¼Œç„¶åå®¢æˆ·ç«¯ä¾¿è®¤ä¸ºè¯·æ±‚å®Œæˆå¹¶æ‰§è¡Œä¹‹ã€‚å…¶æ¬¡ï¼Œå¦‚æœå®¢æˆ·ç«¯æ”¶åˆ°å†2f+1 ~ 3fä¹‹é—´ä¸ªæ•°çš„ä¸€è‡´çš„ç»“æœï¼Œå®¢æˆ·ç«¯å°†æ‰‹æœº2f+1çš„ç»“æœç„¶ååˆ†å‘commit certificateç»™replicasï¼Œä¸€æ—¦2f+1çš„replicasç¡®è®¤æ”¶åˆ°commit certificateï¼Œå®¢æˆ·ç«¯å°†ä¼šè®¤ä¸ºè¯·æ±‚å®Œæˆå¹¶ä¸”æ‰§è¡Œå“åº”çš„å›å¤ã€‚</p><p>å¦‚æœæœ‰è¶³å¤Ÿçš„replicasè®¤ä¸ºleaderæ•…éšœï¼Œç„¶åviewå°†ä¼šè¿›è¡Œæ›´æ¢ï¼Œä¸€ä¸ªæ–°çš„leaderå°†ä¼šäº§ç”Ÿã€‚</p><p>åœ¨æœ¬èŠ‚çš„å…¶ä½™éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬æè¿°åŸºæœ¬åè®®å¹¶æ¦‚è¿°å…¶æ­£ç¡®æ€§çš„è¯æ˜[16]ã€‚ åœ¨Â§4ä¸­ï¼Œæˆ‘ä»¬æè¿°äº†ä¸€äº›ä¼˜åŒ–ï¼Œè¿™äº›ä¼˜åŒ–å…¨éƒ¨åœ¨æˆ‘ä»¬çš„åŸå‹ä¸­å®ç°ï¼Œé€šè¿‡ç”¨æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰ä»£æ›¿å…¬é’¥ç­¾åæ¥é™ä½åŠ å¯†æˆæœ¬ï¼Œé€šè¿‡æ‰¹é‡è¯·æ±‚æé«˜ååé‡ï¼Œé€šè¿‡ç¼“å­˜out-of é€šè¿‡ä¼˜åŒ–åªè¯»è¯·æ±‚æ¥æé«˜è¯»å–æ€§èƒ½ï¼Œé€šè¿‡ä½¿å¤§å¤šæ•°å‰¯æœ¬å‘é€æ•£åˆ—è€Œä¸æ˜¯å®Œæ•´å›å¤æ¥å‡å°‘å¸¦å®½ï¼Œé€šè¿‡ä»…ä¸ºé¦–é€‰æ³•å®šæ•°åŒ…æ‹¬MACæ¥å‡å°‘å¼€é”€ï¼Œå¹¶ä¸”é€šè¿‡åŒ…æ‹¬é¢å¤–çš„é™„åŠ åŠŸèƒ½æ¥æé«˜å­˜åœ¨æ•…éšœèŠ‚ç‚¹çš„æ€§èƒ½ è¯äººå‰¯æœ¬ã€‚</p><h4 id="èŠ‚ç‚¹çŠ¶æ€å’Œæ£€æŸ¥ç‚¹åè®®"><a href="#èŠ‚ç‚¹çŠ¶æ€å’Œæ£€æŸ¥ç‚¹åè®®" class="headerlink" title="èŠ‚ç‚¹çŠ¶æ€å’Œæ£€æŸ¥ç‚¹åè®®"></a>èŠ‚ç‚¹çŠ¶æ€å’Œæ£€æŸ¥ç‚¹åè®®</h4><p>ä¸ºäº†æ˜ç¡®åœ°è®¨è®ºæˆ‘ä»¬çš„è®¨è®ºï¼Œæˆ‘ä»¬é¦–å…ˆè®¨è®ºç”±æ¯ä¸ªå‰¯æœ¬ç»´æŠ¤çš„çŠ¶æ€ï¼Œå¦‚å›¾2æ‰€æ€»ç»“çš„ã€‚æ¯ä¸ªå‰¯æœ¬iç»´æŠ¤å®ƒå·²æ‰§è¡Œçš„è¯·æ±‚çš„æœ‰åºå†å²è®°å½•ï¼Œä»¥åŠæœ€å¤§æäº¤è¯ä¹¦å‰¯æœ¬ï¼Œæäº¤è¯ä¹¦ï¼ˆå®šä¹‰å¦‚ä¸‹ï¼‰ç”±æˆ‘çœ‹åˆ°ï¼Œæ¶µç›–äº†æˆ‘å­˜å‚¨å†å²çš„æœ€å¤§å‰ç¼€ã€‚è¿™ä¸ªæäº¤è¯ä¹¦è¦†ç›–çš„åºåˆ—å·æœ€é«˜çš„è¯·æ±‚çš„å†å²è®°å½•æ˜¯æ‰¿è¯ºçš„å†å²è®°å½•ï¼Œä»¥ä¸‹çš„å†å²è®°å½•æ˜¯æ¨æµ‹å†å²è®°å½•ã€‚å¦‚æœnæ˜¯æäº¤å†å²è®°å½•ä¸­çš„ä»»ä½•è¯·æ±‚çš„æœ€é«˜åºåˆ—å·ï¼Œæˆ‘ä»¬è¯´ä¸€ä¸ªæäº¤è¯ä¹¦çš„åºåˆ—å·ä¸ºnã€‚</p><p>æ¯ä¸ªCP INTERVALè¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ£€æŸ¥ç‚¹ã€‚å‰¯æœ¬ç»´æŠ¤ä¸€ä¸ªç¨³å®šçš„æ£€æŸ¥ç‚¹å’Œä¸€ä¸ªç›¸åº”çš„ç¨³å®šåº”ç”¨ç¨‹åºçŠ¶æ€å¿«ç…§ï¼Œå¹¶ä¸”å®ƒå¯ä»¥å­˜å‚¨å¤šè¾¾ä¸€ä¸ªæš‚å®šæ£€æŸ¥ç‚¹å’Œç›¸åº”çš„æš‚å®šåº”ç”¨ç¨‹åºçŠ¶æ€å¿«ç…§ã€‚å°è¯•æ€§æ£€æŸ¥ç‚¹å’Œåº”ç”¨ç¨‹åºçŠ¶æ€æäº¤çš„è¿‡ç¨‹ä¸æ—©æœŸBFTåè®®æ‰€ä½¿ç”¨çš„è¿‡ç¨‹ç±»ä¼¼[9,10,17,32,40]ï¼Œå› æ­¤æˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºæ¨è¿Ÿåˆ°æˆ‘ä»¬çš„æ‰©å±•æŠ€æœ¯æŠ¥å‘Š[16]ã€‚ä½†æ˜¯ï¼Œç®€è¦æ€»ç»“ä¸€ä¸‹ï¼šå½“æ­£ç¡®çš„å‰¯æœ¬ç”Ÿæˆä¸´æ—¶æ£€æŸ¥ç‚¹æ—¶ï¼Œå®ƒä¼šå‘æ‰€æœ‰å‰¯æœ¬å‘é€ç­¾åæ£€æŸ¥ç‚¹æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯åŒ…å«æ£€æŸ¥ç‚¹ä¸­åŒ…å«çš„ä»»ä½•è¯·æ±‚çš„æœ€é«˜åºåˆ—å·ä»¥åŠå¯¹åº”çš„è¯•éªŒæ€§æ£€æŸ¥ç‚¹å’Œåº”ç”¨ç¨‹åºå¿«ç…§çš„æ‘˜è¦ã€‚å½“æ”¶é›†ç”±ä¸åŒå‰¯æœ¬ç­¾åçš„f + 1åŒ¹é…æ£€æŸ¥ç‚¹æ¶ˆæ¯æ—¶ï¼Œæ­£ç¡®çš„Zyzzyvaå‰¯æœ¬ä¼šå°†æ£€æŸ¥ç‚¹å’Œç›¸åº”çš„åº”ç”¨ç¨‹åºå¿«ç…§è§†ä¸ºç¨³å®šã€‚ä¸ºäº†é™åˆ¶å†å²çš„å¤§å°ï¼Œå‰¯æœ¬ï¼ˆ1ï¼‰åœ¨æäº¤çš„æ£€æŸ¥ç‚¹ä¹‹å‰æˆªæ–­å†å²è®°å½•ï¼Œï¼ˆ2ï¼‰åœ¨å¤„ç†è‡ªä¸Šæ¬¡æäº¤çš„æ£€æŸ¥ç‚¹ä»¥æ¥çš„2Ã—CP INTERVALè¯·æ±‚ä¹‹åé˜»æ­¢å¤„ç†æ–°çš„è¯·æ±‚ã€‚æœ€åï¼Œæ¯ä¸ªå‰¯æœ¬ç»´æŠ¤ä¸€ä¸ªå“åº”ç¼“å­˜ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå®¢æˆ·ç«¯çš„æœ€æ–°è®¢è´­è¯·æ±‚çš„å‰¯æœ¬ä»¥åŠç›¸åº”çš„å“åº”ã€‚</p><h3 id="IPFS"><a href="#IPFS" class="headerlink" title="IPFS"></a>IPFS</h3><p>IPFSæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒç»¼åˆäº†ä»¥å‰çš„å¯¹ç­‰ç³»ç»Ÿçš„æˆåŠŸæƒ³æ³•ï¼ŒåŒ…æ‹¬DHTï¼ŒBitTorrentï¼ŒGitå’ŒSFSï¼ˆSFSæ–‡ä»¶ç³»ç»Ÿçš„åå­—è®¤è¯äº†å®ƒçš„æœåŠ¡ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æœåŠ¡æä¾›çš„å…¬é’¥æ¥éªŒè¯ï¼Œåå•†ä¸€ä¸ªå…±äº«çš„ç§é’¥ï¼Œä¿è¯æ‰€æœ‰çš„é€šä¿¡ã€‚æ‰€æœ‰çš„SFSå®ä¾‹éƒ½å…±äº«äº†ä¸€ä¸ªå…¨å±€çš„å‘½åç©ºé—´ï¼Œè¿™ä¸ªå‘½åç©ºé—´çš„åç§°åˆ†é…æ˜¯åŠ å¯†çš„ï¼Œä¸è¢«ä»»ä½•ä¸­å¿ƒåŒ–çš„bodyæ§åˆ¶ï¼‰ã€‚</p><p> IPFSçš„è´¡çŒ®æ˜¯ç®€åŒ–ï¼Œå‘å±•å’Œå°†æˆç†Ÿçš„æŠ€æœ¯è¿æ¥æˆä¸€ä¸ªå•ä¸€çš„å†…èšç³»ç»Ÿï¼Œå¤§äºå…¶éƒ¨åˆ†çš„æ€»å’Œã€‚ IPFSæä¾›äº†ç¼–å†™å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–°å¹³å°ï¼Œä»¥åŠä¸€ä¸ªæ–°çš„åˆ†å‘ç³»ç»Ÿç‰ˆæœ¬åŒ–å¤§æ•°æ®ã€‚ IPFSç”šè‡³å¯ä»¥æ¼”è¿›ç½‘ç»œæœ¬èº«ã€‚</p><p>IPFSæ˜¯ç‚¹å¯¹ç‚¹çš„;æ²¡æœ‰èŠ‚ç‚¹æ˜¯ç‰¹æƒçš„ã€‚ IPFSèŠ‚ç‚¹å°†IPFSå¯¹è±¡å­˜å‚¨åœ¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚èŠ‚ç‚¹å½¼æ­¤è¿æ¥å¹¶ä¼ è¾“å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡è¡¨ç¤ºæ–‡ä»¶å’Œå…¶ä»–æ•°æ®ç»“æ„ã€‚ IPFSåè®®åˆ†ä¸ºä¸€ç»„è´Ÿè´£ä¸åŒåŠŸèƒ½çš„å­åè®®ï¼š</p><ul><li>èº«ä»½<br>ç®¡ç†èŠ‚ç‚¹èº«ä»½ç”Ÿæˆå’ŒéªŒè¯ã€‚</li><li>ç½‘ç»œ<br>ç®¡ç†ä¸å…¶ä»–å¯¹ç­‰ä½“çš„è¿æ¥ï¼Œä½¿ç”¨å„ç§åº•å±‚ç½‘ç»œåè®®ã€‚å¯é…ç½®çš„ã€‚</li><li>è·¯ç”±<br>ç»´æŠ¤ä¿¡æ¯ä»¥å®šä½ç‰¹å®šçš„å¯¹ç­‰ä½“å’Œå¯¹è±¡ã€‚å“åº”æœ¬åœ°å’Œè¿œç¨‹æŸ¥è¯¢ã€‚é»˜è®¤ä¸ºDHTï¼Œä½†å¯æ›´æ¢ã€‚</li><li>å¯¹è±¡<br>å…·æœ‰é“¾æ¥çš„å†…å®¹å¯»å€ä¸å¯æ›´æ”¹å¯¹è±¡çš„Merkle DAGã€‚ç”¨äºè¡¨ç¤ºä»»æ„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚æ–‡ä»¶å±‚æ¬¡å’Œé€šä¿¡ç³»ç»Ÿã€‚</li><li>äº¤æ¢<br>ä¸€ç§æ”¯æŒæœ‰æ•ˆå—åˆ†é…çš„æ–°å‹å—äº¤æ¢åè®®ï¼ˆBitSwapï¼‰ã€‚æ¨¡æ‹Ÿå¸‚åœºï¼Œå¼±åŒ–æ•°æ®å¤åˆ¶ã€‚è´¸æ˜“ç­–ç•¥å¯æ›¿æ¢ã€‚</li><li>æ–‡ä»¶<br>ç”±Gitå¯å‘çš„ç‰ˆæœ¬åŒ–æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„ã€‚</li><li>å‘½å<br>è‡ªæˆ‘è®¤è¯çš„å¯å˜åç§°ç³»ç»Ÿã€‚è¿™äº›å­ç³»ç»Ÿä¸æ˜¯ç‹¬ç«‹çš„;å®ƒä»¬æ˜¯é›†æˆåœ¨ä¸€èµ·ï¼Œäº’ç›¸åˆ©ç”¨å„è‡ªçš„å±æ€§ã€‚ä½†æ˜¯ï¼Œåˆ†å¼€æè¿°å®ƒä»¬æ˜¯æœ‰ç”¨çš„ï¼Œä»ä¸‹åˆ°ä¸Šæ„å»ºåè®®æ ˆã€‚ç¬¦å·ï¼šGoè¯­è¨€ä¸­æŒ‡å®šäº†ä»¥ä¸‹æ•°æ®ç»“æ„å’ŒåŠŸèƒ½</li></ul><p>ä¸€æ­¥æ­¥æ¥å­¦ä¹ IPFSã€‚</p><h3 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h3><p>P2Pç½‘ç»œç»“æ„å¯åˆ†ä¸ºç»“æ„åŒ–å’Œéç»“æ„åŒ–ï¼Œéç»“æ„åŒ–ç»„å»ºæ–¹ä¾¿ï¼Œå¤šä¸ªpeeråŒæ—¶åŠ å…¥æˆ–ä¸‹çº¿ç¦»å¼€ï¼Œæ•´ä¸ªç½‘ç»œä¹Ÿä¼šå¾ˆç¨³å®šï¼Œç»“æ„åŒ–ç½‘ç»œæ•°æ®æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œä½†å½“å¤§é‡peeråŒæ—¶åŠ å…¥æˆ–ç¦»å¼€æ—¶ç½‘ç»œç¨³å®šæ€§å·®ï¼Œæ€§èƒ½å—å½±å“ã€‚</p><p>ç»“æ„åŒ–ç½‘ç»œä¸çº¯åˆ†å¸ƒå¼ç½‘ç»œä¸åŒçš„æ˜¯ï¼Œæ‰€æœ‰èŠ‚ç‚¹æŒ‰ç…§æŸç§ç»“æ„æœ‰åºç»„ç»‡ï¼Œæ¯”å¦‚å½¢æˆç¯çŠ¶ç½‘ç»œï¼Œæˆ–æ ‘çŠ¶ç½‘ç»œã€‚DHTæå‡ºäº†ä¸€ç§ç½‘ç»œæ¨¡å‹ï¼ŒåŸºäºDHTï¼Œå®ç°ç»“æ„åŒ–ç½‘ç»œçš„ç®—æ³•å¦‚Chordã€Pastryã€Kadç­‰</p><p>DHTçš„æ ¸å¿ƒä¸ºï¼Œèµ„æºç©ºé—´å’ŒèŠ‚ç‚¹ç©ºé—´éƒ½è¿›è¡Œç¼–å·ï¼Œèµ„æºç©ºé—´çš„ç¼–å·å¯æ˜ å°„åˆ°å¯¹åº”èŠ‚ç‚¹ç©ºé—´ã€‚èŠ‚ç‚¹è·¯ç”±çš„æ™®éå®ç°ä¸ºtrieæ ‘ï¼Œå½¢æˆKæ¡¶ã€‚èµ„æºçš„å®ç°çš„è¯ï¼Œé‚»è¿‘èŠ‚ç‚¹å¯å­˜å‚¨å†—ä½™ï¼Œå¯¹äºçƒ­ç‚¹ä¿¡æ¯ï¼ŒæŸ¥è¯¢å‘¨å›´å¯ç¼“å­˜ï¼ŒKadç®—æ³•æœ¬èº«å¹¶æœªå®ç°èµ„æºçš„å†—ä½™å­˜å‚¨ï¼Œä¸»è¦æ˜¯Kæ¡¶çš„å®ç°ï¼Œé€»è¾‘çš„è·ç¦»ä¸ºèŠ‚ç‚¹Idçš„å¼‚æˆ–ã€‚</p><p>Kæ¡¶ä¸€èˆ¬ä¸ºå®šæ—¶åˆ·æ–°ï¼Œä»¥è‡ªå·±ä¸ºä¸­å¿ƒï¼ŒæŸ¥è¯¢è·ç¦»è‡ªå·±æœ€è¿‘çš„èŠ‚ç‚¹ç»„æˆKæ¡¶ï¼Œä»¥å¤ªåŠçš„Kadç®—æ³•ä¸å¤ªä¸€æ ·çš„æ˜¯æŸ¥è¯¢çš„æ˜¯æŸä¸ªéšæœºIDä½œä¸ºåˆ·æ–°åŸºç‚¹ï¼Œæ‰€æŸ¥æ‰¾çš„èŠ‚ç‚¹å‡åœ¨è·ç¦»ä¸Šå‘éšæœºç”Ÿæˆçš„TargetIdæ”¶æ•›ã€‚</p><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><p>å¯æŸ¥çœ‹<a href="http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi/" target="_blank" rel="noopener">ä»¥å¤ªåŠP2Pè§£æ</a>è¿›ä¸€æ­¥ç†è§£ã€‚</p><p><a href="https://github.com/shiyanhui/dht">DHTçš„å®ç°ï¼ŒBTç§å­å—…æ¢å™¨</a></p><p>å‚è€ƒè‡ª</p><ol><li><a href="https://github.com/imfly/bitcoin-on-nodejs/blob/master/">https://github.com/imfly/bitcoin-on-nodejs/blob/master/</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> blockchain </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>crypto</title>
      <link href="/2019/10/14/crypto/"/>
      <url>/2019/10/14/crypto/</url>
      
        <content type="html"><![CDATA[<h2 id="åŒºå—é“¾ä¸­ä½¿ç”¨åˆ°çš„å¯†ç å­¦"><a href="#åŒºå—é“¾ä¸­ä½¿ç”¨åˆ°çš„å¯†ç å­¦" class="headerlink" title="åŒºå—é“¾ä¸­ä½¿ç”¨åˆ°çš„å¯†ç å­¦"></a>åŒºå—é“¾ä¸­ä½¿ç”¨åˆ°çš„å¯†ç å­¦</h2><h4 id="å“ˆå¸Œç®—æ³•"><a href="#å“ˆå¸Œç®—æ³•" class="headerlink" title="å“ˆå¸Œç®—æ³•"></a>å“ˆå¸Œç®—æ³•</h4><p>å°†ä»»æ„é•¿åº¦çš„æ¶ˆæ¯å‹ç¼©ä¸ºå›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶ä¸²ï¼Œå…¶è¾“å‡ºç§°ä¸ºå“ˆå¸Œå€¼ï¼Œä¹Ÿç§°ä¸ºæ•£åˆ—å€¼ã€‚</p><p>å“ˆå¸Œå‡½æ•°çš„æ€§è´¨åŒ…æ‹¬</p><ul><li>æŠ—ç¢°æ’æ€§ï¼Œæ‰€è°“ç¢°æ’æ˜¯æŒ‡ä¸¤ä¸ªä¸åŒçš„æ¶ˆæ¯åœ¨åŒä¸€ä¸ªå“ˆå¸Œå‡½æ•°ä½œç”¨ä¸‹ï¼Œå…·æœ‰ç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œå“ˆå¸Œå‡½æ•°çš„æ‰›ç¢°æ’æ€§æ˜¯æŒ‡å¯»æ‰¾ä¸¤ä¸ªèƒ½å¤Ÿäº§ç”Ÿç¢°æ’çš„æ¶ˆæ¯åœ¨è®¡ç®—ä¸Šæ˜¯ä¸å¯è¡Œçš„ã€‚</li><li>åŸåƒä¸å¯é€†ï¼ŒæŒ‡çš„æ˜¯çŸ¥é“è¾“å…¥å€¼ï¼Œå¾ˆå®¹æ˜“é€šè¿‡å“ˆå¸Œè®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œä½†çŸ¥é“å“ˆå¸Œå€¼ï¼Œæ²¡æœ‰åŠæ³•è®¡ç®—å‡ºåŸæ¥çš„è¾“å…¥å€¼ã€‚</li><li>éš¾é¢˜å‹å¥½æ€§ï¼Œæ²¡æœ‰ä¾¿æ·çš„æ–¹æ³•å»äº§ç”Ÿä¸€æ»¡è¶³ç‰¹æ®Šè¦æ±‚çš„å“ˆå¸Œå€¼ã€‚</li></ul><p>å“ˆå¸Œå‡½æ•°çš„åº”ç”¨ï¼Œåœ¨åŒºå—é“¾ä¸­ï¼Œå¯ç”¨äºéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚</p><h4 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h4><ul><li>å¯¹ç§°åŠ å¯†ï¼ŒåŠ å¯†è§£å¯†é’¥åŒ™ä¸ºåŒä¸€æŠŠ</li><li>éå¯¹ç§°åŠ å¯†ï¼Œé’¥åŒ™åˆ†ä¸ºç§é’¥å’Œå…¬é’¥ï¼Œç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†</li></ul><p>åŒºå—é“¾ä¸­æ‰€ä½¿ç”¨çš„å…¬é’¥å¯†ç ç®—æ³•æ˜¯æ¤­åœ†æ›²çº¿ç®—æ³•ã€‚æ¤­åœ†æ›²çº¿å‡½æ•°çš„ç‰¹æ€§ä¸ºæ›²çº¿ä¸Šçš„ä¸¤ä¸ªä¸åŒçš„ç‚¹ç›¸åŠ æ‰€å¾—åˆ°çš„ç‚¹ä»åœ¨åŸæ›²çº¿ä¸Šï¼Œå³P + P + P + P .. = k*P = Qï¼Œå…¶ä¸­Pã€Qä¸ºå‡æ›²çº¿ä¸Šçš„ç‚¹ã€‚ä¸”æœ‰ç‰¹æ€§å¦‚ä¸‹ï¼Œå·²çŸ¥kå’Œç‚¹Pï¼Œæ±‚Qå®¹æ˜“ï¼Œä½†å·²çŸ¥ç‚¹P,Qï¼Œæ±‚kè¶…è¶…éš¾ï¼Œè¿ç”¨åœ¨å®é™…ä¸­ï¼Œkå¯¹åº”ä¸ºç§é’¥ï¼ŒQå¯¹åº”ä¸ºå…¬é’¥ã€‚</p><h4 id="æ•°å­—ç­¾å"><a href="#æ•°å­—ç­¾å" class="headerlink" title="æ•°å­—ç­¾å"></a>æ•°å­—ç­¾å</h4><p>æ•°å­—ç­¾åå¯ä¿è¯æ¶ˆæ¯çš„çœŸå®æ€§å’Œä¸å¯å¦è®¤æ€§ã€‚æ•°å­—ç­¾åä¸ºä½¿ç”¨ç§é’¥å¯¹æ¶ˆæ¯æ‘˜è¦è¿›è¡Œç­¾åç”Ÿæˆæ•°å­—ç­¾åï¼ŒéªŒè¯æ•°å­—ç­¾åæ—¶ä½¿ç”¨æ¶ˆæ¯æ‘˜è¦ï¼Œå…¬é’¥ã€æ•°å­—ç­¾åå¸¦å…¥ç®—æ³•å³å¯éªŒè¯ã€‚</p><p>å…¶ä¸­ï¼Œç­¾åç®—æ³•ï¼Œä¾‹å¦‚ECDSAï¼Œåˆæˆ–è€…BLS.. (<u>emmï¼Œè™½ç„¶æœ‰è¯´ç­¾åå°±æ˜¯å…¬é’¥å¯†ç â€œåè¿‡æ¥â€å®ç°çš„.ä½†ç­¾åçš„ç®—æ³•å…¶å®æ²¡çœ‹æ‡‚</u>.)ï¼Œ ç„¶åBLSçš„ä¼˜åŠ¿æ˜¯ç­¾åé•¿åº¦çŸ­ï¼Œåœ¨å½“å‰åº”ç”¨ä¸­ï¼Œä½¿ç”¨BLSç­¾åçš„ä¸»è¦æ˜¯ä¸VRFä¸€èµ·ä½¿ç”¨ï¼Œå¦‚DFINITYé¡¹ç›®~</p><h4 id="æ•°å­—è¯ä¹¦"><a href="#æ•°å­—è¯ä¹¦" class="headerlink" title="æ•°å­—è¯ä¹¦"></a>æ•°å­—è¯ä¹¦</h4><p>ä¸€èˆ¬ä½¿ç”¨ä¸Šæ˜¯å¯¹æ–¹æŒæœ‰ä½ çš„å…¬é’¥ï¼Œä½ ç”¨ç§é’¥åŠ å¯†ï¼Œå‘é€ç»™å¯¹æ–¹ï¼Œå¯¹æ–¹ä½¿ç”¨ä½ çš„å…¬é’¥è¿›è¡Œè§£å¯†ï¼Œé—®é¢˜åœ¨äºä¸‡ä¸€å¯¹æ–¹æŒæœ‰çš„ä½ çš„å…¬é’¥è¢«æ›¿æ¢äº†ï¼Œå¯¹æ–¹æ— æ³•ç¡®è®¤å…¬é’¥æ˜¯å¦æ˜¯å±äºä½ çš„ï¼Œè§£å†³æ–¹å¼å‘¢ï¼Œå°±æ˜¯å­˜åœ¨ä¸€ä¸ªè¯ä¹¦ä¸­å¿ƒï¼Œæ‰€æœ‰äººéƒ½æŒæœ‰è¯ä¹¦ä¸­å¿ƒçš„å…¬é’¥ï¼Œè¯ä¹¦ä¸­å¿ƒä½¿ç”¨è‡ªå·±çš„ç§é’¥ï¼Œå¯¹ä½ çš„å…¬é’¥å’Œä¸€äº›ç›¸å…³ä¿¡æ¯è¿›è¡Œä¸€èµ·åŠ å¯†ï¼Œç”Ÿæˆæ•°å­—è¯ä¹¦ï¼Œä½ åœ¨å‘é€ä¿¡æ¯çš„æ—¶å€™é™„å¸¦ä¸Šæ•°å­—è¯ä¹¦ä¸€èµ·å‘é€ã€‚</p><p>æ•°å­—è¯ä¹¦ä½¿ç”¨çš„ç¤ºä¾‹ä¹‹ä¸€ä¸ºï¼Œhttpsåè®®ï¼Œç½‘é¡µåŠ å¯†ã€‚</p><p>é¦–å…ˆï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºåŠ å¯†è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç”¨è‡ªå·±çš„ç§é’¥åŠ å¯†ç½‘é¡µä»¥åï¼Œè¿åŒæœ¬èº«çš„æ•°å­—è¯ä¹¦ï¼Œä¸€èµ·å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯(æµè§ˆå™¨)çš„è¯ä¹¦ç®¡ç†å™¨ä¸­ï¼Œæœ‰å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„åˆ—è¡¨ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ®è¿™å¼ åˆ—è¡¨ï¼ŒæŸ¥çœ‹è§£å¼€æ•°å­—è¯ä¹¦çš„å…¬é’¥æ˜¯å¦åœ¨åˆ—è¡¨ä¹‹å†…(è¯ä¹¦ä¸­å¿ƒæ˜¯å¦å¯é )ã€‚å¦‚æœæ•°å­—è¯ä¹¦è®°è½½çš„ç½‘å€ï¼Œä¸ä½ æ­£åœ¨æµè§ˆçš„ç½‘å€ä¸ä¸€è‡´ï¼Œå°±è¯´æ˜è¿™å¼ è¯ä¹¦å¯èƒ½è¢«å†’ç”¨ï¼Œæµè§ˆå™¨ä¼šå‘å‡ºè­¦å‘Šï¼Œå¦‚æœè¿™å¼ è¯ä¹¦ä¸æ˜¯ç”±å—ä¿¡ä»»çš„æœºæ„é¢å‘çš„ï¼Œæµè§ˆå™¨ä¼šå‘å‡ºå¦ä¸€ç§è­¦å‘Šï¼Œå¦‚æœæ•°å­—è¯ä¹¦æ˜¯å¯é çš„ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥ä½¿ç”¨è¯ä¹¦ä¸­çš„æœåŠ¡å™¨å…¬é’¥ï¼Œå¯¹ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œç„¶åä¸æœåŠ¡å™¨äº¤æ¢åŠ å¯†ä¿¡æ¯ã€‚</p><h4 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><p>æ¶ˆæ¯ä¼ è¾“å®‰å…¨ä½“ç³»ã€‚</p><p>å½“å‘é€æ–¹Aå‘Bå‘é€æ•°æ®æ—¶ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜æœ‰</p><ul><li>æ•°æ®çš„å®‰å…¨æ€§ï¼Œå³æ•°æ®ä¸è¢«å·çª¥</li><li>æ•°æ®çš„å®Œæ•´æ€§ï¼Œå³æ•°æ®ä¸è¢«ç¯¡æ”¹</li><li>æ•°æ®çš„çœŸå®æ€§ï¼Œå³æ•°æ®ç¡®å®æ¥è‡ªå‘é€æ–¹ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«æ›¿æ¢</li><li>æ•°æ®çš„ä¸å¯å¦è®¤æ€§ï¼Œå³å‘é€æ–¹ä¸èƒ½æŠµèµ–å‘é€äº†æ¶ˆæ¯</li></ul><p>ä¸Šè¿°ç®—æ³•å¯¹åº”å®‰å…¨ä½“ç³»ä¸­ï¼Œå…³ç³»å¦‚ä¸‹</p><p><img src="https://images2015.cnblogs.com/blog/802212/201703/802212-20170307221220969-754021676.png" alt="img"></p><h5 id="MAC-ä¸æ•°å­—ç­¾åçš„å¯¹æ¯”"><a href="#MAC-ä¸æ•°å­—ç­¾åçš„å¯¹æ¯”" class="headerlink" title="MAC ä¸æ•°å­—ç­¾åçš„å¯¹æ¯”"></a>MAC ä¸æ•°å­—ç­¾åçš„å¯¹æ¯”</h5><p>MACï¼Œæ¶ˆæ¯è®¤è¯ç ã€‚ç”±æ¶ˆæ¯å’Œå¯†é’¥ç”ŸæˆMACå€¼ï¼Œå¯ç”¨äºç¡®è®¤å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚</p><p>å…¶å®çœ‹èµ·æ¥å’Œæ•°å­—ç­¾åæ˜¯æœ‰ç‚¹åƒçš„ï¼ŒåŒºåˆ«åœ¨äºï¼ŒMACä½¿ç”¨å¯¹ç§°åŠ å¯†ï¼ŒåŠ å¯†è§£å¯†çš„å¯†é’¥æ˜¯ä¸€æ ·çš„ï¼Œæ•°å­—ç­¾åä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼Œæ‰€ä»¥MACä¸èƒ½ä¿è¯å‘é€æ–¹å¯ä»¥å¦è®¤å‘é€è¿‡æ•°æ®ï¼Œè€Œæ•°å­—ç­¾åå´å¯ä»¥ä¿è¯ä»–ä¸èƒ½æŠµèµ–(ç§é’¥åªæœ‰ä½ è‡ªå·±çŸ¥é“)ã€‚</p><h3 id="ç­¾å"><a href="#ç­¾å" class="headerlink" title="ç­¾å"></a>ç­¾å</h3><h4 id="æ•°å­—ç­¾åã€æ•°å­—è¯ä¹¦"><a href="#æ•°å­—ç­¾åã€æ•°å­—è¯ä¹¦" class="headerlink" title="æ•°å­—ç­¾åã€æ•°å­—è¯ä¹¦"></a>æ•°å­—ç­¾åã€æ•°å­—è¯ä¹¦</h4><p>æ•°å­—ç­¾åç›®å‰çš„å®ç°æ–¹æ³•ä¹‹ä¸€ä¸ºå…¬ç§é’¥å¯¹ï¼ŒAå°†å…¶å…¬é’¥æ‹¿ç»™Bï¼ŒBç»™Aå‘æ¶ˆæ¯çš„æ—¶å€™ä½¿ç”¨Açš„å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼ŒAæ”¶åˆ°æ¶ˆæ¯åä½¿ç”¨Açš„ç§é’¥è¿›è¡Œè§£å¯†ã€‚</p><p>æ•°å­—ç­¾åï¼ŒAå‘é€æ¶ˆæ¯ç»™Bï¼ŒæŠŠæ¶ˆæ¯è¿›è¡Œå“ˆå¸Œç®—æ³•ç”Ÿæˆæ‘˜è¦ï¼Œä½¿ç”¨ç§é’¥å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼Œç”Ÿæˆçš„ç§°ä¸ºæ•°å­—ç­¾åï¼Œå‘é€æ—¶å‘é€æ¶ˆæ¯å’Œæ•°å­—ç­¾åã€‚Bæ”¶åˆ°æ¶ˆæ¯åï¼Œä½¿ç”¨Açš„å…¬é’¥è§£å¯†æ•°å­—ç­¾åï¼Œè¯æ˜ç¡®å®æ˜¯Aå‘å‡ºçš„æ¶ˆæ¯ï¼Œå¦å¯¹æ¶ˆæ¯æ±‚å“ˆå¸Œä¸æ•°å­—ç­¾åè§£å¯†å‡ºæ¥çš„å“ˆå¸Œå¯¹æ¯”ï¼Œå¯éªŒè¯æ¶ˆæ¯å®Œæ•´æ€§ã€‚</p><p>æ•°å­—è¯ä¹¦ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹å¯ä¿¡æœºæ„ï¼Œå¤§å®¶è®¤ä¸ºå…¶å…¬é’¥éƒ½æ˜¯å¯ä¿¡çš„ï¼Œå¯ä¿¡æœºæ„ä½¿ç”¨ç§é’¥å¯¹Açš„å…¬é’¥åŠç›¸å…³ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œç§°ä¸ºæ•°å­—è¯ä¹¦ï¼ŒBä½¿ç”¨å¯ä¿¡æœºæ„å…¬é’¥è¿›è¡Œè§£å¯†å¾—åˆ°Açš„å…¬é’¥ï¼Œå¯ä¿è¯Aå…¬é’¥ç¡®å®Açš„å…¬é’¥ã€‚</p><p>é€šå¸¸è€Œè¨€ï¼Œå…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œç§é’¥è¿›è¡Œæ•°å­—ç­¾åã€‚</p><p>æ•°å­—ç­¾åçš„ä½œç”¨ï¼Œ</p><ul><li>ä¸€æ–¹é¢æ˜¯æ¶ˆæ¯çš„åŠ å¯†è§£å¯†ï¼Œ</li><li>ä¸€æ–¹é¢å¯ä¿è¯æ¶ˆæ¯çš„å®Œæ•´æ€§ä¸”ä¸è¢«ç¯¡æ”¹ã€‚</li></ul><h4 id="åŒºå—é“¾ä¸­çš„æ•°å­—ç­¾å"><a href="#åŒºå—é“¾ä¸­çš„æ•°å­—ç­¾å" class="headerlink" title="åŒºå—é“¾ä¸­çš„æ•°å­—ç­¾å"></a>åŒºå—é“¾ä¸­çš„æ•°å­—ç­¾å</h4><p>åŒºå—é“¾ä¸­æ‰€ä½¿ç”¨çš„å…¬é’¥å¯†ç ç®—æ³•æ˜¯æ¤­åœ†æ›²çº¿ç®—æ³•ã€‚</p><p>æ¤­åœ†æ›²çº¿çš„æ•°å­¦æ„ä¹‰ä¸ºï¼Œä¸¤ä¸ªæ¤­åœ†æ›²çº¿ä¸Šçš„ç‚¹ç›¸åŠ æ‰€å¾—åˆ°çš„ç‚¹ä¾ç„¶åœ¨åŸæ¤­åœ†æ›²çº¿ä¸Šï¼Œå³k*P = Qï¼ŒPä¸ºæ¤­åœ†ä¸Šçš„ç‚¹ï¼Œåœ¨å·²çŸ¥kã€Pï¼Œæ±‚ç‚¹Qæ¯”è¾ƒå®¹æ˜“ï¼Œä½†æ˜¯åè¿‡æ¥ï¼Œå·²çŸ¥ç‚¹PQ,æ±‚kå´æ˜¯ç›¸å½“å›°éš¾çš„ã€‚è¿™ä¸ªé—®é¢˜æˆä¸ºæ¤­åœ†æ›²çº¿ä¸Šç‚¹ç¾¤çš„ç¦»æ•£å¯¹æ•°é—®é¢˜ã€‚æ¤­åœ†æ›²çº¿å¯†ç ä½“åˆ¶æ­£æ˜¯åˆ©ç”¨è¿™ä¸ªè®¾è®¡ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œkä½œä¸ºç§é’¥ï¼Œqä½œä¸ºå…¬é’¥ã€‚</p><p>æ¤­åœ†æ›²çº¿ç®—æ³•å…·æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„æœ‰ç‚¹ï¼š</p><ul><li>çŸ­çš„å¯†é’¥é•¿åº¦ï¼Œè¿™æ„å‘³ç€å°çš„å¸¦å®½å’Œå­˜å‚¨è¦æ±‚ã€‚</li><li>æ‰€æœ‰çš„ç”¨æˆ·å¯ä»¥é€‰æ‹©åŒä¸€åŸºåŸŸä¸Šçš„ä¸åŒæ¤­åœ†æ›²çº¿ï¼Œå¯ä½¿æ‰€æœ‰çš„ç”¨æˆ·ä½¿ç”¨åŒæ ·çš„æ“ä½œå®ŒæˆåŸŸè¿ç®—ã€‚</li></ul><p>æ¤­åœ†æ›²çº¿ç­¾åä¸éªŒè¯ç­¾åï¼š</p><ul><li>å‘é€æ¶ˆæ¯åŒ…å«æ¶ˆæ¯æœ¬èº«ã€å…¬é’¥ã€å’Œæ•°å­—ç­¾åã€‚æ•°å­—ç­¾åä¸ºï¼Œå¯¹æ¶ˆæ¯æ±‚å“ˆå¸Œåä½¿ç”¨ç§é’¥è¿›è¡Œç­¾å</li><li>éªŒè¯è¿‡ç¨‹ä¸ºï¼Œå°†æ¶ˆæ¯å–å“ˆå¸Œã€å…¬é’¥ã€æ•°å­—ç­¾åå¸¦å…¥ç®—æ³•è¿›è¡Œè®¡ç®—ï¼Œæ ¹æ®è®¡ç®—ç»“æœå¯åˆ¤å®šéªŒè¯æ˜¯å¦é€šè¿‡</li></ul><p>æ•°å­—ç­¾åçš„ä½œç”¨ï¼Œ</p><ul><li>ä¿è¯ç”¨æˆ·çš„è´¦æˆ·ä¸èƒ½è¢«å†’åé¡¶æ›¿</li><li>ç¡®ä¿ç”¨æˆ·ä¸èƒ½å¦è®¤å…¶æ‰€ç­¾åçš„äº¤æ˜“</li></ul><h4 id="åŒºå—é“¾ä¸­çš„å¯†ç å­¦"><a href="#åŒºå—é“¾ä¸­çš„å¯†ç å­¦" class="headerlink" title="åŒºå—é“¾ä¸­çš„å¯†ç å­¦"></a>åŒºå—é“¾ä¸­çš„å¯†ç å­¦</h4><ul><li>å“ˆå¸Œç®—æ³•ï¼Œå¯¹æ¶ˆæ¯Aå–å“ˆå¸Œå¾—åˆ°å›ºå®šé•¿åº¦ä¸²Bï¼Œå¯ç†è§£ä¸ºæ‘˜è¦ã€‚Aè®¡ç®—å¾—åˆ°Bï¼ŒBå¾ˆéš¾è®¡ç®—å‡ºå¾—åˆ°Aã€‚å“ˆå¸Œç¢°æ’çš„é—®é¢˜ä¸ºä¸åŒçš„ä¸²å¾—åˆ°ç›¸åŒçš„å“ˆå¸Œï¼Œå–å†³äºå“ˆå¸Œæ¡¶çš„å¤§å°ï¼Œæ•…å½“å‰å¾ˆå¤šå“ˆå¸Œç®—æ³•æ¡¶å–å€¼è›®å¤§ï¼Œå¦‚128ã€256ç­‰(æ¡¶å¤§å°ä¸º2çš„128æˆ–256æ¬¡æ–¹ï¼Œå“ˆå¸Œç¢°æ’çš„å¯èƒ½æ€§åŸºæœ¬å¾ˆå°å¾ˆå°)</li><li>merkleæ ‘ï¼Œå¯¹æ•°æ®å—è¿›è¡Œå–å“ˆå¸Œï¼Œä¸¤ä¸¤æ‹¼å‡‘ï¼Œå†å–å“ˆå¸Œï¼Œæœ€åå¾—åˆ°æ ¹å“ˆå¸Œï¼Œæ•´ä¸ªç»“æ„å½¢æˆæ ‘ï¼Œç§°ä¸ºmerkleæ ‘ï¼ŒéªŒè¯æŸæ•°æ®å—åªéœ€å¾—åˆ°ç›¸åº”éå¶å­èŠ‚ç‚¹å“ˆå¸Œè¿›è¡Œè®¡ç®—å³å¯ï¼Œå¯è¿›è¡Œè½»é‡éªŒè¯</li><li>å…¬é’¥å¯†ç </li></ul><h4 id="å¤šé‡ç­¾å"><a href="#å¤šé‡ç­¾å" class="headerlink" title="å¤šé‡ç­¾å"></a>å¤šé‡ç­¾å</h4><p>å¤šé‡ç­¾åï¼ŒæŸæ¡æ¶ˆæ¯æ˜¯ç”±å¤šä¸ªå…¬é’¥(mä¸ª)è¿›è¡Œç­¾åï¼Œç­¾åéªŒè¯æ—¶éœ€è¦nä¸ªå…¬é’¥è¿›è¡Œè§£å¯†ï¼Œå…¶ä¸­m&gt;=nã€‚å¯ä»¥æ˜¯3/2, 5/3ç­‰ã€‚</p><p>ä¾‹å¦‚ï¼ŒåŠ¨ç”¨è¿™ç¬”èµ„é‡‘éœ€è¦å¤šä¸ªç§é’¥ç­¾åï¼Œé€šå¸¸è¿™ç¬”èµ„é‡‘æˆ–æ•°å­—èµ„äº§ä¼šä¿å­˜åœ¨ä¸€ä¸ªå¤šé‡ç­¾åçš„åœ°å€æˆ–å¸å·é‡Œï¼ˆå°±æ¯”ç‰¹å¸è€Œè¨€ï¼Œå¤šé‡ç­¾ååœ°å€é€šå¸¸ä»¥<code>3</code>å¼€å¤´ï¼‰ã€‚åœ¨å®é™…çš„æ“ä½œè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªå¤šé‡ç­¾ååœ°å€å¯ä»¥å…³è”nä¸ªç§é’¥ï¼Œåœ¨éœ€è¦è½¬è´¦ç­‰æ“ä½œæ—¶ï¼Œåªè¦å…¶ä¸­çš„mä¸ªç§é’¥ç­¾åå°±å¯ä»¥æŠŠèµ„é‡‘è½¬ç§»äº†ï¼Œå…¶ä¸­mè¦å°äºç­‰äºnï¼Œä¹Ÿå°±æ˜¯è¯´m/nå°äº1ï¼Œå¯ä»¥æ˜¯2/3, 3/5ç­‰ç­‰ï¼Œæ˜¯è¦åœ¨å»ºç«‹è¿™ä¸ªå¤šé‡ç­¾ååœ°å€çš„æ—¶å€™ç¡®å®šå¥½çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> blockchain </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>wallet_connection</title>
      <link href="/2019/10/14/wallet-connection/"/>
      <url>/2019/10/14/wallet-connection/</url>
      
        <content type="html"><![CDATA[<h2 id="wallet-connection"><a href="#wallet-connection" class="headerlink" title="wallet connection"></a>wallet connection</h2><p>ç»ƒä¹ ä½¿ç”¨çš„åº“æ˜¯kotlinçš„<a href="https://github.com/WalletConnect/kotlin-walletconnect-lib">https://github.com/WalletConnect/kotlin-walletconnect-lib</a></p><p>ç„¶åä¸‹è½½ä¸‹æ¥ï¼Œå¯¼å…¥åˆ°asä¸­â€¦æ›²æŠ˜è€Œåˆè‰°è¾›ã€‚</p><ul><li><p>ä»€ä¹ˆgradleå’Œkotlinç‰ˆæœ¬é—®é¢˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classpath &apos;com.android.tools.build:gradle:3.4.1&apos;</span><br></pre></td></tr></table></figure><p>åœ¨é¡¹ç›®build.gradleä¸­åŠ å…¥</p></li><li><p>sample:appä¸æ˜¯module</p><p>åœ¨settings.gradleä¸­ä¿®æ”¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include &apos;:lib&apos; , &apos;:sample:app&apos;</span><br></pre></td></tr></table></figure></li><li><p>äº‘é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/central&apos; &#125;</span><br><span class="line">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/groups/public&apos; &#125;</span><br><span class="line">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/google&apos; &#125;</span><br><span class="line">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/gradle-plugin&apos; &#125;</span><br><span class="line">        maven &#123; url &quot;https://maven.google.com&quot; &#125;</span><br><span class="line">        /**ä¸éœ€è¦fabricå°±ä¸éœ€è¦æ­¤é¡¹*/</span><br><span class="line">        maven &#123; url &apos;http://s3.amazonaws.com/fabric-artifacts/public&apos; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">~</span><br></pre></td></tr></table></figure><p> init.gradleä¸ºä¸Šè¿°å†…å®¹ï¼Œæ·»åŠ åˆ°~/.gradleç›®å½•ä¸‹</p></li><li><p>æ­£å¸¸æƒ…å†µä¸‹å°±èƒ½ç¼–è¯‘å¥½äº†ï¼Œå¦‚æœå‡ºç°ä»£ç ç‰ˆæœ¬ä¸å…¼å®¹çš„é—®é¢˜ï¼Œå°±æ ¹æ®ä»£ç æç¤ºä¿®æ”¹ä¸‹</p></li></ul><p>ç„¶åå°±èƒ½æ­£å¸¸è¿è¡Œå’Œç¼–è¯‘å•¦ã€‚</p><p>ç²˜è´´ä¸€ä¸ªtest</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">class WalletConnectBridgeRepositoryIntegrationTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Integration test that can be used with the wallet connect example dapp</span><br><span class="line">     */</span><br><span class="line">    @Test</span><br><span class="line">    fun approveSession() &#123;</span><br><span class="line">        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()</span><br><span class="line">        val moshi = Moshi.Builder().build()</span><br><span class="line">        val sessionDir = File(&quot;build/tmp/&quot;).apply &#123; mkdirs() &#125;</span><br><span class="line">        val sessionStore = FileWCSessionStore(File(sessionDir, &quot;test_store.json&quot;).apply &#123; createNewFile() &#125;, moshi)</span><br><span class="line">        //wc:33...ä¸ºæ‰«ç æ‰«å‡ºæ¥çš„ç»“æœ</span><br><span class="line">        val config = Session.Config.fromWCUri(&quot;wc:79870fae-c04f-479e-8241-085e96603f2b@1?bridge=http%3A%2F%2F192.168.20.18%3A8000%2Fapi%2Fv1%2Fws&amp;key=db8147b92d96a62cb1a2181dd3f9076cfd8eceaeba01feb8becfb965754e6f3e&quot;)</span><br><span class="line">        val session = WCSession(</span><br><span class="line">            config,</span><br><span class="line">            MoshiPayloadAdapter(moshi),</span><br><span class="line">            sessionStore,</span><br><span class="line">            OkHttpTransport.Builder(client, moshi),</span><br><span class="line">            Session.PeerMeta(name = &quot;WC Unit Test&quot;)</span><br><span class="line">        )</span><br><span class="line">        session.addCallback(object : Session.Callback &#123;</span><br><span class="line">            //ç›¸å…³çš„çŠ¶æ€ä¼šå›è°ƒï¼Œå¦‚å»ºç«‹è¿æ¥ï¼Œè¿æ¥æ–­æ‰</span><br><span class="line">            override fun onStatus(status: Session.Status) &#123;</span><br><span class="line">                System.out.println(&quot;onStatus: $status&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">            //ç½‘é¡µæœ‰è¯·æ±‚ï¼Œä¼šæ¥æ”¶åˆ°å›è°ƒ</span><br><span class="line">            override fun onMethodCall(call: Session.MethodCall) &#123;</span><br><span class="line"></span><br><span class="line">                if (call is Session.MethodCall.SessionRequest) &#123;</span><br><span class="line">                    //Session.MethodCall.SessionRequestæˆæƒè¯·æ±‚</span><br><span class="line">                    //å›å¤è´¦æˆ·åœ°å€ï¼Œä»£è¡¨æˆæƒæ­¤è´¦æˆ·åœ°å€</span><br><span class="line">                    session.approve(listOf(&quot;0x32C772DCCF8DCddd3e271B213a0027c22C98Fd1e&quot;), 1L)</span><br><span class="line">                &#125; else if (call is Session.MethodCall.SendTransaction) &#123;</span><br><span class="line">                    //Session.MethodCall.SessionRequestå‘é€äº¤æ˜“è¯·æ±‚</span><br><span class="line">                    // å¯æ‹¿åˆ°call.to, call.from, call.data ç­‰ä¿¡æ¯ï¼Œåè¿›è¡Œç­¾åäº¤æ˜“ï¼Œå¹¶å‘é€ï¼Œç„¶åå›å¤å¤„ç†æˆåŠŸ</span><br><span class="line">                    session.approveRequest(call.id, &quot;ok&quot;)</span><br><span class="line">                &#125; else if(call is Session.MethodCall.Custom) &#123;</span><br><span class="line">                    //è‡ªå®šä¹‰æ–¹æ³•å’Œå‚æ•°</span><br><span class="line">                    //æ ¹æ®call.params call.methodè¿›è¡Œå¤„ç†åç­¾åäº¤æ˜“ï¼Œå¹¶å‘é€ï¼Œç„¶åå›å¤å¤„ç†æˆåŠŸ</span><br><span class="line">                    session.approveRequest(call.id, &quot;ok&quot;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        //åˆ›å»ºè¿æ¥</span><br><span class="line">        session.init()</span><br><span class="line">        Thread.sleep(2000000)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun approveSession1() &#123;</span><br><span class="line">        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()</span><br><span class="line">        val moshi = Moshi.Builder().build()</span><br><span class="line">        val sessionDir = File(&quot;build/tmp/&quot;).apply &#123; mkdirs() &#125;</span><br><span class="line">        val sessionStore = FileWCSessionStore(File(sessionDir, &quot;test_store.json&quot;).apply &#123; createNewFile() &#125;, moshi)</span><br><span class="line">        val key = ByteArray(32).also &#123; Random().nextBytes(it) &#125;.toNoPrefixHexString()</span><br><span class="line">        val topic  = ByteArray(32).also &#123; Random().nextBytes(it) &#125;.toNoPrefixHexString()</span><br><span class="line">        println(&quot;topic: &quot; + topic)</span><br><span class="line">        println(&quot;key : $key&quot;)</span><br><span class="line">        val config = Session.Config(topic, &quot;http://192.168.20.18:5000&quot;, key)</span><br><span class="line">        val session = WCSession(</span><br><span class="line">                config,</span><br><span class="line">                MoshiPayloadAdapter(moshi),</span><br><span class="line">                sessionStore,</span><br><span class="line">                OkHttpTransport.Builder(client, moshi),</span><br><span class="line">                Session.PeerMeta(name = &quot;WC Unit Test&quot;)</span><br><span class="line">        )</span><br><span class="line">        session.addCallback(object : Session.Callback &#123;</span><br><span class="line">            override fun onStatus(status: Session.Status) &#123;</span><br><span class="line">                System.out.println(&quot;onStatus: $status&quot;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            override fun onMethodCall(call: Session.MethodCall) &#123;</span><br><span class="line">                System.out.println(&quot;onMethodCall: $call&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        session.offer()</span><br><span class="line">        Thread.sleep(5000)</span><br><span class="line">        println(&quot;==========================&quot;)</span><br><span class="line">        val id = Random().nextLong()</span><br><span class="line">        println(&quot;id: &quot;+ id)</span><br><span class="line">        val p = session.performMethodCall(Session.MethodCall.Custom(id, &quot;tttt&quot;,  listOf(1,2,&quot;3&quot;,4,&quot;5&quot;)), callback = &#123; resp -&gt;</span><br><span class="line">            println(resp)</span><br><span class="line">        &#125;)</span><br><span class="line">        println(p)</span><br><span class="line">        Thread.sleep(100000)</span><br><span class="line">        session.kill()</span><br><span class="line">        Thread.sleep(200000)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> blockchain </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>how to set up a blog</title>
      <link href="/2019/10/12/how-to-set-up-a-blog/"/>
      <url>/2019/10/12/how-to-set-up-a-blog/</url>
      
        <content type="html"><![CDATA[<h2 id="åšå®¢æ­å»º"><a href="#åšå®¢æ­å»º" class="headerlink" title="åšå®¢æ­å»º"></a>åšå®¢æ­å»º</h2><p><font size="1">å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œç»§æˆ‘å·¥ä½œ3å¹´åï¼Œç»ˆäºæ­å»ºäº†åšå®¢äº†ã€‚(è™½ç„¶è¿Ÿåˆ°äº†è¿™ä¹ˆä¹…â€¦ä½†è¿˜æ˜¯å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå¥½å¼€å¿ƒå•Š)</font></p><h3 id="æ–¹æ¡ˆ"><a href="#æ–¹æ¡ˆ" class="headerlink" title="æ–¹æ¡ˆ"></a>æ–¹æ¡ˆ</h3><p>Github Pages + Travis + Hexo</p><h3 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h3><p>Hexoå‘¢ï¼Œæ˜¯åŸºäºNode.jsçš„é™æ€åšå®¢æ¡†æ¶ã€‚åæ­£å°±æ˜¯ï¼Œå¯ä»¥å‡å°é‚£äº›åˆ«çš„æ“ä½œï¼Œè®©å†™åšå®¢çš„äººæ›´ä¸“æ³¨äºå†™åšå®¢å†…å®¹ã€‚ </p><h5 id="å®‰è£…å’Œä½¿ç”¨"><a href="#å®‰è£…å’Œä½¿ç”¨" class="headerlink" title="å®‰è£…å’Œä½¿ç”¨"></a>å®‰è£…å’Œä½¿ç”¨</h5><p>å‰ææ¡ä»¶ï¼Œå·²å®‰è£…gitã€nodejsã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œhexo-cliå·¥å…·åï¼Œå°±å¯ä»¥ä½¿ç”¨hexoå‘½ä»¤è¿›è¡Œæ“ä½œäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init [dir]</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–åšå®¢ã€‚</p><p>å®Œæˆä¹‹åï¼Œä¼šäº§ç”Ÿå‡ ä¸ªæ–‡ä»¶å¤¹ï¼Œå¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ _config.yml</span><br><span class="line">â”œâ”€â”€ package.json</span><br><span class="line">â”œâ”€â”€ scaffolds   //æ¨¡æ¿ï¼Œç”¨äºåˆ›å»ºåšæ–‡ç­‰</span><br><span class="line">â”œâ”€â”€ source   //åšæ–‡ç­‰å…·ä½“ä½ç½®</span><br><span class="line">â””â”€â”€ themes  //ä¸»é¢˜</span><br></pre></td></tr></table></figure><p>å…³äºhexoçš„æ“ä½œå‘½ä»¤å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">hexo --help</span><br><span class="line">Usage: hexo &lt;command&gt;</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  clean     Remove generated files and cache.</span><br><span class="line">  config    Get or set configurations.</span><br><span class="line">  deploy    Deploy your website.</span><br><span class="line">  generate  Generate static files.</span><br><span class="line">  help      Get help on a command.</span><br><span class="line">  init      Create a new Hexo folder.</span><br><span class="line">  list      List the information of the site</span><br><span class="line">  migrate   Migrate your site from other system to Hexo.</span><br><span class="line">  new       Create a new post.</span><br><span class="line">  publish   Moves a draft post from _drafts to _posts folder.</span><br><span class="line">  render    Render files with renderer plugins.</span><br><span class="line">  server    Start the server.</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨generateå¯äº§ç”Ÿé™æ€æ–‡ä»¶å¤¹<code>public</code>ï¼Œä½¿ç”¨serverå‘½ä»¤å³å¯åœ¨æœ¬åœ°å¯åŠ¨nodeæœåŠ¡ï¼Œä½¿ç”¨æµè§ˆå™¨å³å¯æŸ¥çœ‹åˆ°æ•ˆæœã€‚</p><p>å¦‚æœ hexoæ²¡æœ‰serverçš„è¯ï¼Œæ˜¯å› ä¸ºç‰ˆæœ¬çš„ä¸åŒï¼Œå°†serverç‹¬ç«‹å‡ºå»äº†ï¼Œéœ€è¦å•ç‹¬å®‰è£…<code>npm install hexo-server --save</code></p><p>å…³äºä¸»é¢˜çš„è¯ï¼Œå¦‚æœé€‰æ‹©å¼€æºä¸»é¢˜ï¼Œå¯ç›´æ¥ä¸‹è½½åˆ°themeæ–‡ä»¶å¤¹å³å¯ä½¿ç”¨ã€‚æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯<a href="https://github.com/probberechts/hexo-theme-cactus">cactus</a></p><h3 id="Github-Pages"><a href="#Github-Pages" class="headerlink" title="Github Pages"></a>Github Pages</h3><blockquote><p><a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> is designed to host your personal, organization, or project pages from a GitHub repository.</p><p> Your site is published at <a href="https://xiaoxuez.github.io/" target="_blank" rel="noopener">https://xiaoxuez.github.io/</a></p></blockquote><p>å°±æ˜¯githubæä¾›çš„æœåŠ¡ï¼Œå°†githubä»“åº“éƒ¨ç½²åˆ°<code>https://username.github.io</code>è¿™æ ·çš„åŸŸåä¸‹ã€‚</p><p><font size="2">è¿™æ ·å°±ä¸ç”¨è‡ªå·±ä¹°æœåŠ¡å™¨ï¼Œè‡ªå·±éƒ¨ç½²æœåŠ¡äº†ã€‚</font></p><p>ä½¿ç”¨æ–¹å¼å‘¢ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªä»“åº“ï¼Œç„¶åä»ä»“åº“settingé¡µï¼Œå³å¯çœ‹åˆ°Github Pagesè®¾ç½®é¡¹ï¼Œå¯é€‰æ‹©è¦éƒ¨ç½²çš„åˆ†æ”¯å’Œé€‰æ‹©ä¸»é¢˜ã€‚è¿™é‡Œè¦é€‰æ‹©ä¸€ä¸ªä¸»é¢˜ã€‚ç„¶åå¦‚æœä½¿ç”¨username.github.ioå‘½åçš„ä»“åº“çš„è¯ï¼Œåªèƒ½éƒ¨ç½²masteråˆ†æ”¯ï¼Œä¸èƒ½ä¿®æ”¹ã€‚</p><h3 id="Travis"><a href="#Travis" class="headerlink" title="Travis"></a>Travis</h3><p><a href="[https://travis-ci.com](https://travis-ci.com/)">travis</a>è‡ªåŠ¨åŒ–éƒ¨ç½²</p><p>é¦–å…ˆè¦ç†è§£çš„æ˜¯ï¼Œåšå®¢ï¼Œå…¶å®æ˜¯æœ‰ä¸¤å¥—ä»£ç çš„ï¼Œä¸€å¥—æ˜¯æºä»£ç ï¼Œä¸€å¥—æ˜¯ç”Ÿæˆçš„<code>public</code>ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†æºä»£ç æ”¾åˆ°ä¸€ä¸ªåˆ†æ”¯ä¸Šï¼Œ<code>public</code>æäº¤åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šã€‚ç„¶åGithub Pageséƒ¨ç½²çš„åˆ†æ”¯é€‰æ‹©<code>public</code>æ‰€åœ¨çš„åˆ†æ”¯å³å¯ã€‚</p><p>é‚£ä¹ˆï¼Œtraviså¯ä»¥å¸®åŠ©çš„äº‹å‘¢ï¼Œå°±æ˜¯å½“æˆ‘å°†æºä»£ç pushåˆ°è¿œç¨‹ä»“åº“åï¼Œåšä¸€äº›äº‹ï¼Œæ¯”å¦‚æ‰§è¡Œ<code>hexo generate</code>è„šæœ¬ç”Ÿæˆ<code>public</code>æ–‡ä»¶å¤¹å¹¶pushåˆ°å¯¹åº”åˆ†æ”¯ä¸Šã€‚è¿™æ ·å°±å¾ˆå®Œç¾äº†ã€‚</p><p>å…³äºtravisçš„å…·ä½“ä½¿ç”¨ï¼Œå¯è§<a href="https://docs.travis-ci.com/" target="_blank" rel="noopener">è¯¦ç»†æ–‡æ¡£</a></p><p>é¦–å…ˆï¼Œè¦æ·»åŠ <code>.travis.yaml</code>é…ç½®æ–‡ä»¶åˆ°ä»“åº“ä»£ç é‡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo: false</span><br><span class="line">language: node_js</span><br><span class="line">node_js:</span><br><span class="line">  - 10 # use nodejs v10 LTS</span><br><span class="line">cache: npm</span><br><span class="line">branches:</span><br><span class="line">  only:</span><br><span class="line">    - resource # build master branch only</span><br><span class="line">script:</span><br><span class="line">  - hexo generate # generate static files</span><br><span class="line">deploy:</span><br><span class="line">  provider: pages</span><br><span class="line">  skip-cleanup: true</span><br><span class="line">  github-token: $GH_TOKEN</span><br><span class="line">  keep-history: true</span><br><span class="line">  on:</span><br><span class="line">    branch: resource  //æ„å»ºresourceåˆ†æ”¯</span><br><span class="line">  local-dir: public</span><br><span class="line">  target_branch: master  //å‘å¸ƒåˆ°masteråˆ†æ”¯</span><br></pre></td></tr></table></figure><p>target_branché»˜è®¤å‘¢æ˜¯<code>gh-pages</code>ã€‚ç„¶åå› ä¸ºæˆ‘çš„ä»“åº“åä¸º<code>xiaoxuez.github.io</code>ï¼Œä¸Šæ–‡æåˆ°äº†æˆ‘éœ€è¦å°†é™æ€æ–‡ä»¶æäº¤åˆ°masteråˆ†æ”¯ï¼Œæ‰€ä»¥æˆ‘å°†<code>hexo generate</code>ä¹‹åçš„<code>public</code>æ–‡ä»¶å¤¹å‘å¸ƒåˆ°msteråˆ†æ”¯ä¸Šäº†ã€‚å…³äºdeployå„å­—æ®µçš„ä»‹ç»ï¼Œå¯è§<a href="https://docs.travis-ci.com/user/deployment/pages/" target="_blank" rel="noopener">æ–‡æ¡£</a></p><p>æœ€åï¼Œå°±æ˜¯è¦githubæˆæƒç»™travisï¼Œæ–‡æ¡£åœ¨<a href="https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚Tokençš„å­˜æ”¾å¯ä»¥é€‰æ‹©åœ¨æœ¬åœ°ï¼Œæˆ–è€…é…ç½®åˆ°<a href="https://docs.travis-ci.com/user/environment-variables#defining-variables-in-repository-settings" target="_blank" rel="noopener">travis</a>ä¸Šã€‚</p><p>è¿™æ ·ï¼Œå°±å¯ä»¥ä½¿ç”¨å•¦ã€‚</p><p>è¿˜æœ‰å°±æ˜¯åœ¨githubä¸Šçš„personal settingsé‡Œçš„Applicaitonsä¼šå®‰è£…travisæ’ä»¶ï¼Œå¯ä»¥æ§åˆ¶travisçš„æƒé™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> enjoyment </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>btc_data_dat</title>
      <link href="/2019/04/14/btc-data-dat/"/>
      <url>/2019/04/14/btc-data-dat/</url>
      
        <content type="html"><![CDATA[<h2 id="btc-datæ•°æ®é‡ç»„"><a href="#btc-datæ•°æ®é‡ç»„" class="headerlink" title="btc datæ•°æ®é‡ç»„"></a>btc datæ•°æ®é‡ç»„</h2><p>Bitcoin coreåŒæ­¥çš„æ•°æ®æ˜¯datæ–‡ä»¶å’Œindexæ–‡ä»¶å¤¹ï¼Œindexæ–‡ä»¶å¤¹é‡Œæ˜¯ldb </p><p>datæ˜¯å‘å„ä¸ªèŠ‚ç‚¹åŒæ­¥çš„æ•°æ®ï¼Œå„ä¸ªåŒºå—ä¹‹é—´ä¸ä¿è¯æœ‰åºã€‚ldbé‡Œä¿å­˜äº†å¦‚ä½•å»datæ–‡ä»¶é‡ŒæŸ¥è¯¢åŒºå—/äº¤æ˜“ç­‰çš„ä¿¡æ¯ã€‚ </p><p>å…·ä½“ç»´åŸºè§£é‡Š <a href="https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage" target="_blank" rel="noopener">https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage</a> </p><p>å…¶ä¸­ldbä¸­åŒºå—ä¿¡æ¯ä¸º </p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&apos;b&apos; + 32-byte block hash -&gt; block index record. Each record stores: </span><br><span class="line"></span><br><span class="line">     * The block header </span><br><span class="line"></span><br><span class="line">     * The height. </span><br><span class="line"></span><br><span class="line">     * The number of transactions. </span><br><span class="line"></span><br><span class="line">     * To what extent this block is validated. </span><br><span class="line"></span><br><span class="line">     * In which file, and where in that file, the block data is stored. </span><br><span class="line"></span><br><span class="line">     * In which file, and where in that file, the undo data is stored.</span><br></pre></td></tr></table></figure><p>å®ç°ï¼Œé‡ç»„ä¸ºæœ‰åºçš„datæ–‡ä»¶ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">@Time : 2019/4/4 ä¸‹åˆ6:57</span><br><span class="line">@Author : xiaoxuez</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">   &quot;encoding/binary&quot;</span><br><span class="line">   &quot;encoding/hex&quot;</span><br><span class="line">   &quot;errors&quot;</span><br><span class="line">   &quot;flag&quot;</span><br><span class="line">   &quot;fmt&quot;</span><br><span class="line">   &quot;io&quot;</span><br><span class="line">   &quot;os&quot;</span><br><span class="line">   &quot;path&quot;</span><br><span class="line">   &quot;sync&quot;</span><br><span class="line"></span><br><span class="line">   &quot;git.wokoworks.com/blockchain/btc-explorer/db&quot;</span><br><span class="line">   &quot;git.wokoworks.com/blockchain/btc-explorer/log&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type readBlockChain struct &#123;</span><br><span class="line">   height    uint64</span><br><span class="line">   blockHash [32]byte</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var indexLDB *db.LDBDatabase</span><br><span class="line">var blSourceDir string</span><br><span class="line">var blDirtyDir string</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">   log.InitHandler(log.Root(), log.LvlTrace, &quot;logs/reorder.log&quot;)</span><br><span class="line">   var err error</span><br><span class="line">   flag.StringVar(&amp;blSourceDir, &quot;old&quot;, &quot;/Users/xiaoxuez/btc_test_db/mainnet/&quot;, &quot;xx&quot;)</span><br><span class="line">   flag.StringVar(&amp;blDirtyDir, &quot;new&quot;, &quot;/Users/xiaoxuez/btc_test_db/reorder&quot;, &quot;xx&quot;)</span><br><span class="line">   flag.Parse()</span><br><span class="line">   //bmdb, err = db.NewLDBDatabase(&quot;/Users/xiaoxuez/btc_test_db/mainnet/index&quot;, 0, 0)</span><br><span class="line">   indexLDB, err = db.NewLDBDatabase(path.Join(blSourceDir, &quot;index&quot;), 0, 0)</span><br><span class="line">   if err != nil &#123;</span><br><span class="line">      panic(err)</span><br><span class="line">   &#125;</span><br><span class="line">   //len must &lt; 24</span><br><span class="line">   var data = []readBlockChain&#123;</span><br><span class="line">      &#123;</span><br><span class="line">         height:    0,</span><br><span class="line">         blockHash: hexToHash(&quot;00000000000003a20def7a05a77361b9657ff954b2f2080e135ea6f5970da215&quot;), // 20ä¸‡-1</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         height:    20 * 10000,</span><br><span class="line">         blockHash: hexToHash(&quot;0000000000000009c2e82d884ec07b4aafb64ca3ef83baca2b6b0b5eb72c8f02&quot;), // 25ä¸‡-1</span><br><span class="line">      &#125;,</span><br><span class="line">      //&#123;</span><br><span class="line">      // height:    25 * 10000,</span><br><span class="line">      // blockHash: hexToHash(&quot;000000000000000067ecc744b5ae34eebbde14d21ca4db51652e4d67e155f07e&quot;), // 30-1</span><br><span class="line">      //&#125;,</span><br><span class="line">      //&#123;</span><br><span class="line">      // height:    30 * 10000,</span><br><span class="line">      // blockHash: hexToHash(&quot;000000000000000002045664f89a1077d0c6c0aaa6dd89b485208cf92d6bbd30&quot;), // 35-1</span><br><span class="line">      //&#125;,</span><br><span class="line">      //&#123;</span><br><span class="line">      // height:    35 * 10000,</span><br><span class="line">      // blockHash: hexToHash(&quot;0000000000000000030034b661aed920a9bdf6bbfa6d2e7a021f78481882fa39&quot;), // 40-1</span><br><span class="line">      //&#125;,</span><br><span class="line">      //&#123;</span><br><span class="line">      // height:    40 * 10000,</span><br><span class="line">      // blockHash: hexToHash(&quot;0000000000000000024c4a35f0485bab79ce341cdd5cc6b15186d9b5b57bf3da&quot;), // 45-1</span><br><span class="line">      //&#125;,</span><br><span class="line">      //&#123;</span><br><span class="line">      // height:    45 * 10000,</span><br><span class="line">      // blockHash: hexToHash(&quot;0000000000000000007962066dcd6675830883516bcf40047d42740a85eb2919&quot;), // 50</span><br><span class="line">      //&#125;,</span><br><span class="line">      //&#123;</span><br><span class="line">      // height:    50 * 10000,</span><br><span class="line">      // blockHash: hexToHash(&quot;00000000000000000013dad60a42a3401a8f37ca02f1c00ac5923e674566a3ae&quot;), // 55</span><br><span class="line">      //&#125;,</span><br><span class="line">   &#125;</span><br><span class="line">   if len(data) &gt; 24 &#123;</span><br><span class="line">      log.Error(&quot;parallel number must &lt; 24&quot;, &quot;actual &quot;, len(data))</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   var wg sync.WaitGroup</span><br><span class="line">   for index, v := range data &#123;</span><br><span class="line">      wg.Add(1)</span><br><span class="line">      go func(index int, v readBlockChain) &#123;</span><br><span class="line">         rwBlocks(v.blockHash[:], v.height, fmt.Sprint(index), func() &#123; wg.Done() &#125;)</span><br><span class="line">      &#125;(index, v)</span><br><span class="line">   &#125;</span><br><span class="line">   wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func rwBlocks(startBlock []byte, endHeight uint64, prefix string, callback func()) &#123;</span><br><span class="line">   defer callback()</span><br><span class="line">   fileCache := make(map[uint64]*os.File, 0)</span><br><span class="line">   blockHash := startBlock</span><br><span class="line">   reverWriter := NewReverseWriter(blDirtyDir, 138*1024*1024, prefix)</span><br><span class="line">   defer reverWriter.Flush()</span><br><span class="line">   count := 0</span><br><span class="line">   for &#123;</span><br><span class="line">      content, height, err := rwBlock(fileCache, blockHash)</span><br><span class="line">      if err != nil &#123;</span><br><span class="line">         log.Error(&quot;rw block&quot;, &quot;err&quot;, err.Error())</span><br><span class="line">         return</span><br><span class="line">      &#125;</span><br><span class="line">      blockHash = content[12:44]</span><br><span class="line">      err = reverWriter.Insert(content)</span><br><span class="line">      if err != nil &#123;</span><br><span class="line">         fmt.Println(&quot;writer err&quot;, err)</span><br><span class="line">         return</span><br><span class="line">      &#125;</span><br><span class="line">      if height == endHeight &#123;</span><br><span class="line">         log.Info(&quot;finish to save block height&quot;, &quot;height&quot;, height)</span><br><span class="line">         return</span><br><span class="line">      &#125;</span><br><span class="line">      if height%3000 == 0 &#123;</span><br><span class="line">         log.Trace(&quot;====&gt;&quot;, &quot;height&quot;, height, &quot;parent block hash&quot;, hashToHex(blockHash))</span><br><span class="line">      &#125;</span><br><span class="line">      count++</span><br><span class="line">   &#125;</span><br><span class="line">   log.Info(&quot;write file end&quot;, &quot;count&quot;, count)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func rwBlock(fileCache map[uint64]*os.File, block []byte) ([]byte, uint64, error) &#123;</span><br><span class="line">   value, err := indexLDB.Get(append([]byte(&quot;b&quot;), block...))</span><br><span class="line">   if err != nil &#123;</span><br><span class="line">      return []byte&#123;&#125;, 0, errors.New(fmt.Sprintf(&quot;%s%s&quot;, err.Error(), hashToHex(block)))</span><br><span class="line">   &#125;</span><br><span class="line">   bm := parseBlockMeta(value)</span><br><span class="line">   file, ok := fileCache[bm.file]</span><br><span class="line">   if !ok &#123;</span><br><span class="line">      file, err = os.Open(idx2fname(blSourceDir, uint32(bm.file)))</span><br><span class="line">      if err != nil &#123;</span><br><span class="line">         return []byte&#123;&#125;, 0, err</span><br><span class="line">      &#125;</span><br><span class="line">      fileCache[bm.file] = file</span><br><span class="line">   &#125;</span><br><span class="line">   file.Seek(int64(bm.dataPos-8), io.SeekStart)</span><br><span class="line">   res, err := readBlockFromFile(file)</span><br><span class="line"></span><br><span class="line">   if err != nil &#123;</span><br><span class="line">      return []byte&#123;&#125;, 0, err</span><br><span class="line">   &#125;</span><br><span class="line">   binary.LittleEndian.PutUint32(res[:4], uint32(bm.height))</span><br><span class="line">   return res, bm.height, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func readBlockFromFile(f *os.File) (res []byte, e error) &#123;</span><br><span class="line">   var buf [4]byte</span><br><span class="line">   _, e = f.Read(buf[:])</span><br><span class="line">   _, e = f.Read(buf[:])</span><br><span class="line">   if e != nil &#123;</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   le := uint32(lsb2uint(buf[:]))</span><br><span class="line">   if le &lt; 81 &#123;</span><br><span class="line">      e = errors.New(fmt.Sprintf(&quot;Incorrect block size %d&quot;, le))</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   res = make([]byte, le+8)</span><br><span class="line">   copy(res[4:8], buf[:])</span><br><span class="line">   _, e = f.Read(res[8:])</span><br><span class="line">   if e != nil &#123;</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line">func idx2fname(dir string, fidx uint32) (s string) &#123;</span><br><span class="line">   if fidx == 0xffffffff &#123;</span><br><span class="line">      return &quot;blk99999.dat&quot;</span><br><span class="line">   &#125;</span><br><span class="line">   return fmt.Sprintf(&quot;%s/blk%05d.dat&quot;, dir, fidx)</span><br><span class="line">&#125;</span><br><span class="line">func lsb2uint(lt []byte) (res uint64) &#123;</span><br><span class="line">   for i := 0; i &lt; len(lt); i++ &#123;</span><br><span class="line">      res |= uint64(lt[i]) &lt;&lt; uint(i*8)</span><br><span class="line">   &#125;</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type blockMeta struct &#123;</span><br><span class="line">   version uint64</span><br><span class="line">   height  uint64</span><br><span class="line">   status  uint64</span><br><span class="line">   nTx     uint64</span><br><span class="line">   file    uint64</span><br><span class="line">   dataPos uint64</span><br><span class="line">   undoPos uint64</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func parseBlockMeta(raw []byte) (bm blockMeta) &#123;</span><br><span class="line">   var pos uint64</span><br><span class="line">   var i uint64</span><br><span class="line">   bm.version, i = readRawData(raw[pos:])</span><br><span class="line">   pos += i</span><br><span class="line">   bm.height, i = readRawData(raw[pos:])</span><br><span class="line">   pos += i</span><br><span class="line">   bm.status, i = readRawData(raw[pos:])</span><br><span class="line">   pos += i</span><br><span class="line">   bm.nTx, i = readRawData(raw[pos:])</span><br><span class="line">   pos += i</span><br><span class="line">   bm.file, i = readRawData(raw[pos:])</span><br><span class="line">   pos += i</span><br><span class="line">   bm.dataPos, i = readRawData(raw[pos:])</span><br><span class="line">   pos += i</span><br><span class="line">   bm.undoPos, i = readRawData(raw[pos:])</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func readRawData(raw []byte) (uint64, uint64) &#123;</span><br><span class="line">   var n uint64</span><br><span class="line">   var pos uint64</span><br><span class="line">   for &#123;</span><br><span class="line">      data := raw[pos]</span><br><span class="line">      pos += 1</span><br><span class="line">      n = (n &lt;&lt; 7) | (uint64(data) &amp; 0x7f)</span><br><span class="line">      if data&amp;0x80 == 0 &#123;</span><br><span class="line">         return n, pos</span><br><span class="line">      &#125;</span><br><span class="line">      n += 1</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func hashToHex(hash []byte) (s string) &#123;</span><br><span class="line">   for i := 0; i &lt; 32; i++ &#123;</span><br><span class="line">      s += fmt.Sprintf(&quot;%02x&quot;, hash[31-i])</span><br><span class="line">   &#125;</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func hexToHash(s string) (res [32]byte) &#123;</span><br><span class="line">   d, e := hex.DecodeString(s)</span><br><span class="line">   if e != nil &#123;</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   if len(d) != 32 &#123;</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line">   for i := 0; i &lt; 32; i++ &#123;</span><br><span class="line">      res[31-i] = d[i]</span><br><span class="line">   &#125;</span><br><span class="line">   return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type ReverseWriter struct &#123;</span><br><span class="line">   Dir          string</span><br><span class="line">   CacheMaxSize int</span><br><span class="line">   len          int</span><br><span class="line">   cache        []byte</span><br><span class="line">   seek         int</span><br><span class="line">   index        int</span><br><span class="line">   Prefix       string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func NewReverseWriter(dir string, cacheSize int, prefix string) *ReverseWriter &#123;</span><br><span class="line">   rw := &amp;ReverseWriter&#123;Dir: dir, CacheMaxSize: cacheSize, Prefix: prefix&#125;</span><br><span class="line">   rw.init()</span><br><span class="line">   return rw</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (rw *ReverseWriter) init() &#123;</span><br><span class="line">   rw.len = 0</span><br><span class="line">   rw.cache = make([]byte, rw.CacheMaxSize)</span><br><span class="line">   rw.seek = rw.CacheMaxSize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (rw *ReverseWriter) Insert(content []byte) error &#123;</span><br><span class="line">   if rw.len+len(content) &gt; rw.CacheMaxSize &#123;</span><br><span class="line">      err := rw.writeToFile()</span><br><span class="line">      if err != nil &#123;</span><br><span class="line">         return err</span><br><span class="line">      &#125;</span><br><span class="line">      rw.index++</span><br><span class="line">      rw.init()</span><br><span class="line">   &#125;</span><br><span class="line">   copy(rw.cache[rw.seek-len(content):rw.seek], content)</span><br><span class="line">   rw.seek = rw.seek - len(content)</span><br><span class="line">   rw.len += len(content)</span><br><span class="line">   return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (rw *ReverseWriter) writeToFile() error &#123;</span><br><span class="line">   if rw.len == 0 &#123;</span><br><span class="line">      return nil</span><br><span class="line">   &#125;</span><br><span class="line">   writer, err := os.OpenFile(fmt.Sprintf(&quot;%s/%sblk%05d.dat&quot;, rw.Dir, rw.Prefix, rw.index), os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0666)</span><br><span class="line">   if err != nil &#123;</span><br><span class="line">      return err</span><br><span class="line">   &#125;</span><br><span class="line">   _, err = writer.Write(rw.cache[rw.seek:])</span><br><span class="line">   return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (rw *ReverseWriter) Flush() error &#123;</span><br><span class="line">   err := rw.writeToFile()</span><br><span class="line">   rw.index++</span><br><span class="line">   rw.init()</span><br><span class="line">   return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">é‡ç»„å®Œæˆä¹‹åï¼Œè¿›è¡Œæ›´åæ“ä½œ</span><br><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line"># shell is funny</span><br><span class="line"></span><br><span class="line">read -p &quot;Are you sure:(y/n) &quot; an</span><br><span class="line">if [[ $&#123;an&#125; != &quot;y&quot; ]]; then exit; fi</span><br><span class="line"></span><br><span class="line">cd /Users/woko/bitcoin</span><br><span class="line"></span><br><span class="line">function rename_2() &#123;</span><br><span class="line">    index=0</span><br><span class="line">    for name in $(ls | grep .dat) ; do</span><br><span class="line">        if [[ -f $&#123;name&#125; ]]; then</span><br><span class="line">            rename=$(echo $&#123;index&#125;|awk &apos;&#123;printf(&quot;blk%05d.dat&quot;,$0)&#125;&apos;)</span><br><span class="line">            echo $&#123;name&#125; &quot; ==&gt; &quot; $&#123;rename&#125;</span><br><span class="line">            mv $&#123;name&#125; $&#123;rename&#125;</span><br><span class="line">            ((index=index+1))</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function rename_1() &#123;</span><br><span class="line">    count=0</span><br><span class="line">    for (( i = 0; i &lt; 10; ++i )); do</span><br><span class="line">        index=$(ls $&#123;count&#125;*.dat | wc -l)</span><br><span class="line">        for name in $(ls $&#123;count&#125;*.dat) ; do</span><br><span class="line">            if [[ -f $&#123;name&#125; ]]; then</span><br><span class="line">                ((index=index-1))</span><br><span class="line">                rename=$(echo &quot;$&#123;count&#125; $&#123;index&#125;&quot;|awk &apos;&#123;printf(&quot;%02dblk%05d.dat&quot;,$1,$2)&#125;&apos;)</span><br><span class="line">                echo $&#123;name&#125; &quot; ==&gt; &quot; $&#123;rename&#125;</span><br><span class="line">                mv $&#123;name&#125; $&#123;rename&#125;</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        ((count=count+1))</span><br><span class="line">        echo &quot;--------------&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rename_1</span><br><span class="line">echo &quot;==============&quot;</span><br><span class="line">rename_2</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> btc </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>fabric_code_consensus_event</title>
      <link href="/2019/04/14/fabric-code-consensus-event/"/>
      <url>/2019/04/14/fabric-code-consensus-event/</url>
      
        <content type="html"><![CDATA[<h2 id="fabric-consensus-eventæºç è§£æ"><a href="#fabric-consensus-eventæºç è§£æ" class="headerlink" title="fabric consensus eventæºç è§£æ"></a>fabric consensus eventæºç è§£æ</h2><p>ä»£ç ä½ç½®ä¸º fabric/consensus/â€¦</p><p>æƒ³å†™pbftçš„ä»£ç è§£ææ¥ç€ã€‚çœ‹åˆ°é‡Œé¢çš„äº‹ä»¶æµï¼Œè®¾è®¡å¾—å¾ˆèµï¼Œå­¦ä¹ ä¸€ä¸‹ã€‚</p><h4 id="Manager-äº‹ä»¶ç®¡ç†"><a href="#Manager-äº‹ä»¶ç®¡ç†" class="headerlink" title="Manager äº‹ä»¶ç®¡ç†"></a>Manager äº‹ä»¶ç®¡ç†</h4><p>ä¸»è¦å®ç°çš„åŠŸèƒ½æ˜¯äº‹ä»¶é€šé“çš„å¤„ç†ï¼Œé€šè¿‡ç›¸å…³æ¥å£ï¼Œå†™å…¥æ•°æ®åˆ°é€šé“ä¸­ï¼Œæ•°æ®å¤„ç†æ–¹æä¾›å¤„ç†æ–¹æ³•å³å¯ï¼Œä¸éœ€å…³æ³¨é€šé“çš„å®ç°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//é¦–å…ˆï¼Œæ¥å£äº‹ä»¶è¦åšçš„äº‹ä¸»è¦æ˜¯ï¼Œå†…éƒ¨æä¾›ä¸€ä¸ªäº‹ä»¶é€šé“ï¼Œæš´éœ²å‡ºå¾€é€šé“å†™æ•°æ®çš„æ¥å£ï¼Œä»¥åŠæ•°æ®å¤„ç†æ¥æ”¶æ–¹æ³•ï¼Œæ¥æ”¶æ–¹æ³•ç”±Receiveræä¾›ï¼ŒMagagerçš„å®ç°è€…éœ€è¦å®ç°æ•°æ®ä»é€šé“è¯»å‡ºæ¥ï¼Œå›è°ƒç»™æ¥æ”¶è€…çš„è¿‡ç¨‹ã€‚</span><br><span class="line">type Manager interface &#123;</span><br><span class="line">Inject(Event)         //ä¸€ä¸ªæš‚æ—¶çš„æ¥å£ï¼Œè·³è¿‡äº†é€šé“ï¼Œç›´æ¥ç»™åˆ°æ¥æ”¶è€…ï¼Œåªé™äºManageræœ¬çº¿ç¨‹ä½¿ç”¨ï¼Œå› ä¸ºæ²¡æœ‰äº†é€šé“åšæ•°æ®ä¿æŠ¤</span><br><span class="line">Queue() chan&lt;- Event  //æä¾›ä¸€ä¸ªåªå†™é€šé“ï¼Œç”¨äºå¾€é€šé“å†…å†™æ•°æ®</span><br><span class="line">SetReceiver(Receiver) //è®¾ç½®æ¥æ”¶è€…ï¼Œæ¥æ”¶è€…éœ€è¦å®ç°æ¥æ”¶æ–¹æ³•ï¼Œåœ¨Receiveræ¥å£ä¸­æœ‰å…·ä½“æ–¹æ³•å®šä¹‰</span><br><span class="line">Start()               // å¯åŠ¨Managerçº¿ç¨‹</span><br><span class="line">Halt()                // åœæ­¢managerçº¿ç¨‹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Receiveræ¥å£"><a href="#Receiveræ¥å£" class="headerlink" title="Receiveræ¥å£"></a>Receiveræ¥å£</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type Receiver interface &#123;</span><br><span class="line">//äº‹ä»¶å¤„ç†çš„åœ°æ–¹ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼ é€’äº‹ä»¶ç»™åˆ°Receiver,æ³¨æ„åˆ°è¿™ä¸ªè®¾è®¡çš„æ˜¯è¿”å›å€¼ä¹Ÿæ˜¯Eventäº‹ä»¶ï¼Œè¿™ä¸ªåœ¨ä¹‹åçš„åœ°æ–¹è¿›è¡Œè¯¦ç»†è§£é‡Š</span><br><span class="line">ProcessEvent(e Event) Event</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Managerå®ç°"><a href="#Managerå®ç°" class="headerlink" title="Managerå®ç°"></a>Managerå®ç°</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type managerImpl struct &#123;</span><br><span class="line">threaded  //æä¾›ä¸€ä¸ªexitçš„é€šé“ï¼Œä½œä¸ºä»å¤–é¢ç»“æŸçº¿ç¨‹çš„ä¿¡å·ï¼ŒåŒ…æ‹¬Haltæ–¹æ³•çš„å®ç°</span><br><span class="line">receiver Receiver  //æ¥æ”¶è€…</span><br><span class="line">events   chan Event //æ•°æ®é€šé“</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰è¯´manageræ˜¯ä¸€ä¸ªäº‹ä»¶é€šé“çš„å¤„ç†ï¼Œé‚£ä¹ˆï¼Œä¸šåŠ¡é€»è¾‘ä¸€å®šæ˜¯ä¸æ–­å¾ªç¯ï¼Œä»é€šé“ä¸­è¯»å‡ºæ•°æ®ï¼Œç„¶åè°ƒç”¨æ¥æ”¶è€…çš„æ–¹æ³•ä¼ é€’ç»™æ¥æ”¶è€…ã€‚æ‰€ä»¥ä»£ç æ˜¯..</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">func (em *managerImpl) Start() &#123;</span><br><span class="line">    //å¼€å¯å­çº¿ç¨‹</span><br><span class="line">go em.eventLoop()</span><br><span class="line">&#125;</span><br><span class="line">func (em *managerImpl) eventLoop() &#123;</span><br><span class="line">for &#123;</span><br><span class="line">select &#123;</span><br><span class="line">case next := &lt;-em.events:</span><br><span class="line">em.Inject(next)</span><br><span class="line">case &lt;-em.exit:</span><br><span class="line">logger.Debug(&quot;eventLoop told to exit&quot;)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">//ä¼ é€’Eventç»™receiver</span><br><span class="line">func (em *managerImpl) Inject(event Event) &#123;</span><br><span class="line">if em.receiver != nil &#123;</span><br><span class="line">SendEvent(em.receiver, event)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">//è°ƒç”¨receiver.PeoceesEventæ–¹æ³•å°†äº‹ä»¶ä¼ é€’ç»™æ¥æ”¶è€…</span><br><span class="line">func SendEvent(receiver Receiver, event Event) &#123;</span><br><span class="line">next := event</span><br><span class="line">for &#123;</span><br><span class="line">// å¦‚æœProcessEventæ–¹æ³•è¿”å›å€¼ä¸ä¸ºç©ºï¼Œåˆ™ä½œä¸ºæ–°çš„äº‹ä»¶ï¼Œç»§ç»­å¤„ç†</span><br><span class="line">next = receiver.ProcessEvent(next)</span><br><span class="line">if next == nil &#123;</span><br><span class="line">break</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProcessEventè®¾è®¡ä¸ºæœ‰è¿”å›å€¼ï¼Œä¸”ä¸ºEventï¼Œå½“è¿”å›å€¼ä¸ä¸ºç©ºï¼Œåˆ™ä½œä¸ºæ–°çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œç›´åˆ°è¿”å›å€¼ä¸ºç©ºã€‚å½“ç„¶ï¼Œå› ä¸ºæ˜¯åŒä¸€ä¸ªreceiverï¼Œå¦‚æœè®¾è®¡ä¸ºè¿”å›å€¼ä¸ºç©ºï¼Œç„¶ååœ¨ProcessEventé‡Œç›´æ¥è¿›è¡Œé€’å½’è°ƒç”¨ï¼Œæ„Ÿè§‰ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ä½†è¿™æ ·å†™çš„è¯ï¼Œåœ¨ProcessEventå°±ä¼šå¹²å‡€å¾ˆå¤šã€‚</p><h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p>goæºç åŒ…ä¸­æ˜¯æœ‰timeåŒ…çš„ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å°è£…ä¸€ä¸ªtimerå‘¢ï¼ŒåŸå› æ˜¯å°è£…çš„timerä¸€æ—¦è¢«resetæˆ–stopï¼Œå°±ç®—å€’è®¡æ—¶è§¦å‘äº‹ä»¶äº†ï¼Œäº‹ä»¶ä¹Ÿä¸ä¼šä¼ é€’åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚</p><p>æ—¢ç„¶æåˆ°goä¸­åŸtimeåŒ…ï¼Œå¤šå˜´ä¸€å¥ï¼ŒtimeåŒ…ä¸­çš„timerä¹Ÿæ˜¯å…·ä½“stopå’Œresetæ–¹æ³•ï¼Œä½†å¯ä»¥çœ‹åˆ°å®˜æ–¹å‡½æ•°è§£é‡Š</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Stop does not close the channel, to prevent a read from the channel succeeding incorrectly</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>å³stopæ–¹æ³•ä¸ä¼šå…³é—­é€šé“ï¼Œä¸€èˆ¬ä½¿ç”¨timerçš„å®šæ—¶å™¨æˆ–tickerï¼Œéƒ½æ˜¯ç›‘å¬é€šé“æ˜¯å¦æœ‰å€¼ï¼Œå°±æ„å‘³ç€å³ä½¿stopæ‰å®šæ—¶å™¨ï¼Œä½†é€šé“è¿˜æ˜¯åœ¨çš„ï¼Œç›‘å¬é€šé“çš„ç¨‹åºä¸ä¼šé€€å‡ºã€‚</p><p>å¥½äº†ï¼Œä¸‹é¢è¯´æ˜eventä¸­å°è£…çš„Timerå§ã€‚</p><p>ç›´æ¥çœ‹å®ç°å§ï¼Œæ¥å£å°±ç•¥è¿‡äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// newTimer creates a new instance of timerImpl</span><br><span class="line">func newTimerImpl(manager Manager) Timer &#123;</span><br><span class="line">et := &amp;timerImpl&#123;</span><br><span class="line">startChan: make(chan *timerStart),</span><br><span class="line">stopChan:  make(chan struct&#123;&#125;),</span><br><span class="line">threaded:  threaded&#123;make(chan struct&#123;&#125;)&#125;,</span><br><span class="line">manager:   manager,</span><br><span class="line">&#125;</span><br><span class="line">go et.loop()</span><br><span class="line">return et</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°ç»“æ„ä½“ä¸­æœ‰managerçš„å¼•ç”¨ï¼Œå®ç°çš„å®šæ—¶å™¨ä¸ºï¼Œå½“å¼€å¯å®šæ—¶å™¨æ—¶ï¼Œéœ€è¦ä¼ å…¥å®šæ—¶æ—¶é—´ï¼Œå’Œeventäº‹ä»¶ï¼Œå½“æ—¶é—´è§¦å‘æ—¶ï¼ŒæŠŠeventäº‹ä»¶ä¼ é€’ç»™manager.receiverï¼Œä¼ é€’æ–¹å¼ä¸ºmanagerä¸­çš„ä¼ é€’æ–¹å¼ã€‚æ•…ä¸»è¦ä»£ç ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">func (et *timerImpl) loop() &#123;</span><br><span class="line">var eventDestChan chan&lt;- Event //å†…éƒ¨ç¼“å­˜é€šé“</span><br><span class="line">var event Event //äº‹ä»¶</span><br><span class="line"></span><br><span class="line">for &#123;</span><br><span class="line">select &#123;</span><br><span class="line">case start := &lt;-et.startChan:</span><br><span class="line">//è®¡æ—¶å¼€å§‹ï¼Œæ—¶é—´ä¸ºstart.durationï¼Œäº‹ä»¶ä¸ºstart.event</span><br><span class="line">if et.timerChan != nil &#123;</span><br><span class="line">if start.hard &#123;</span><br><span class="line">logger.Debug(&quot;Resetting a running timer&quot;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">continue</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">logger.Debug(&quot;Starting timer&quot;)</span><br><span class="line">et.timerChan = time.After(start.duration)</span><br><span class="line">if eventDestChan != nil &#123;</span><br><span class="line">logger.Debug(&quot;Timer cleared pending event&quot;)</span><br><span class="line">&#125;</span><br><span class="line">event = start.event</span><br><span class="line">eventDestChan = nil</span><br><span class="line">case &lt;-et.stopChan:</span><br><span class="line">//ç»“æŸè®¡æ—¶</span><br><span class="line">if et.timerChan == nil &amp;&amp; eventDestChan == nil &#123;</span><br><span class="line">logger.Debug(&quot;Attempting to stop an unfired idle timer&quot;)</span><br><span class="line">&#125;</span><br><span class="line">et.timerChan = nil</span><br><span class="line">logger.Debug(&quot;Stopping timer&quot;)</span><br><span class="line">if eventDestChan != nil &#123;</span><br><span class="line">logger.Debug(&quot;Timer cleared pending event&quot;)</span><br><span class="line">&#125;</span><br><span class="line">eventDestChan = nil</span><br><span class="line">event = nil</span><br><span class="line">case &lt;-et.timerChan:</span><br><span class="line">//å€’è®¡æ—¶è§¦å‘ï¼Œè¿™é‡Œå¥½ç»•ï¼Œå€’è®¡æ—¶è§¦å‘ï¼Œä»…ä»…åªæ˜¯å°†äº‹ä»¶ä¼ é€’é€šé“çš„å¼•ç”¨ç¼“å­˜ä¸‹æ¥</span><br><span class="line">logger.Debug(&quot;Event timer fired&quot;)</span><br><span class="line">et.timerChan = nil</span><br><span class="line">eventDestChan = et.manager.Queue()</span><br><span class="line">case eventDestChan &lt;- event:</span><br><span class="line">//å¦‚æœäº‹ä»¶ä¼ é€’é€šé“ä¸ä¸ºç©ºï¼Œä¸”eventä¹Ÿä¸ä¸ºç©ºï¼Œåˆ™å°†eventä¼ é€’ç»™äº‹ä»¶é€šé“ä¸­ eventDestChan &lt;- eventè¿™ä¸€å¥è¯å°±ç«Ÿç„¶èƒ½å®ç°è¿™ä¹ˆå¤šä»¶äº‹ï¼</span><br><span class="line">logger.Debug(&quot;Timer event delivered&quot;)</span><br><span class="line">eventDestChan = nil</span><br><span class="line">case &lt;-et.exit:</span><br><span class="line">//é€€å‡º</span><br><span class="line">logger.Debug(&quot;Halting timer&quot;)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç çœ‹åˆ°ï¼Œå€’è®¡æ—¶è§¦å‘çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ç«‹å³ç›´æ¥å°†eventé€å…¥é€šé“ï¼Œè€Œæ˜¯å°†é€šé“ç¼“å­˜ä¸‹æ¥ï¼Œç­‰åˆ°ä¸‹ä¸€æ¬¡selectï¼Œå†æ‰§è¡Œå°†äº‹ä»¶é€å…¥é€šé“çš„äº‹ã€‚<strong>åœ¨nilé€šé“ä¸Šå‘é€å’Œæ¥å—å°†æ°¸è¿œè¢«é˜»å¡ï¼Œåœ¨selectä¸­ï¼Œå¦‚æœå…¶é€šé“æ˜¯nilï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šè¢«é€‰æ‹©</strong>ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°eventDestChanå¦‚æœä¸ºnil, case eventDestChan &lt;- eventçš„è¯­å¥å°±ä¸ä¼šè¢«é€‰æ‹©ã€‚eventDestChanä¸ä¸ºnilæ—¶ï¼Œå°±èƒ½è¢«é€‰æ‹©äº†ï¼Œselectçš„ç”¨æ³•æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆèµï¼</p>]]></content>
      
      
      <categories>
          
          <category> fabric </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>fabric_pbft</title>
      <link href="/2019/04/14/fabric-pbft/"/>
      <url>/2019/04/14/fabric-pbft/</url>
      
        <content type="html"><![CDATA[<h4 id="fabric-consensus-pbft-VS-neo-dbft"><a href="#fabric-consensus-pbft-VS-neo-dbft" class="headerlink" title="fabric consensus pbft VS neo dbft"></a>fabric consensus pbft VS neo dbft</h4><h4 id="pbft"><a href="#pbft" class="headerlink" title="pbft"></a>pbft</h4><p><strong>pbftåˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œpre-prepare, prepare, commit</strong>ã€‚</p><p>ä¸€ç›´å¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆæ˜¯3ä¸ªé˜¶æ®µï¼Œä¸ºä»€ä¹ˆè¿™ä¸‰ä¸ªé˜¶æ®µå°±èƒ½ä¿è¯æ‹œå åº­å‘¢ï¼Ÿ</p><ul><li>é¦–å…ˆï¼Œ pre-prepareé˜¶æ®µæ˜¯ä¸»èŠ‚ç‚¹å‘ç»™å„ä¸ªä»èŠ‚ç‚¹çš„ï¼Œpre-prepareæ¶ˆæ¯ä¸­åŒ…æ‹¬å…±è¯†æ¶ˆæ¯ã€åºå·ç­‰</li><li>ä»èŠ‚ç‚¹æ”¶åˆ°pre-prepareæ¶ˆæ¯åï¼Œå‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­prepareæ¶ˆæ¯ï¼Œè¿™æ˜¯ä¸ºäº†å‘Šè¯‰åˆ«äººè‡ªå·±æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ä»€ä¹ˆ</li><li>ä»èŠ‚ç‚¹æ”¶åˆ°æœ‰æ•ˆçš„prepareæ¶ˆæ¯è¶³å¤Ÿå¤š(f+1)ï¼Œä»£è¡¨æœ‰f+1ä¸ªèŠ‚ç‚¹æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ä¸€æ ·çš„ï¼Œæ•…<strong>è¯æ˜æ¶ˆæ¯çš„çœŸå®å¯ä¿¡æ€§</strong>ã€‚å‘å‡ºcommitï¼Œcommitä¸ºè‡ªèº«ç­¾åæ¶ˆæ¯ï¼Œä»£è¡¨è‡ªå·±åŒæ„æ¶ˆæ¯ã€‚</li><li>åªè¦æœ‰1ä¸ªèŠ‚ç‚¹æ”¶åˆ°çš„commitæ¶ˆæ¯æ•°é‡æœ‰f+1ï¼Œåˆ™å¯ä»¥ç¡®è®¤æ¶ˆæ¯æˆåŠŸã€‚</li></ul><h4 id="dbft"><a href="#dbft" class="headerlink" title="dbft"></a>dbft</h4><p>dbftä¸­ï¼Œdæ˜¯æˆæƒçš„æ„æ€ï¼Œæˆæƒæ‹œå åº­ï¼Œè¿™é‡Œå¿½ç•¥éªŒè¯äººçš„é€‰æ‹©ï¼Œä»…ä»…å°±å…±è¯†è¿‡ç¨‹è¿›è¡Œè®¨è®ºã€‚</p><p><strong>å…±è¯†è¿‡ç¨‹åªæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œprepare, prepare-response</strong></p><ul><li>é¦–å…ˆï¼Œprepareé˜¶æ®µï¼Œä¸»èŠ‚ç‚¹å‘ç»™å„ä¸ªä»èŠ‚ç‚¹çš„ï¼Œprepareæ¶ˆæ¯ä¸­åŒ…æ‹¬å…±è¯†æ¶ˆæ¯ã€åºå·ç­‰</li><li>ä»èŠ‚ç‚¹æ”¶åˆ°prepareæ¶ˆæ¯åï¼Œå°±æ¶ˆæ¯è¿›è¡ŒéªŒè¯åˆ¤æ–­ï¼Œå¦‚åŒæ„æ¶ˆæ¯ï¼Œåˆ™å‘é€prepare-responseæ¶ˆæ¯</li><li>ä»èŠ‚ç‚¹æ”¶é›†prepare-responseæ¶ˆæ¯ï¼Œå¦‚æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ•°é‡è¾¾åˆ°é˜ˆå€¼ï¼Œåˆ™ç¡®è®¤å…±è¯†æˆåŠŸ</li></ul><p>äºŒè€…å¯¹æ¯”èµ·æ¥ï¼Œå¾ˆæ˜æ˜¾ï¼Œneoçš„dbftç¼ºå°‘äº†éªŒè¯æ¶ˆæ¯çœŸå®å¯ä¿¡æ€§ï¼Œå³æ— æ³•åˆ¤æ–­ä¸»èŠ‚ç‚¹å‘é€ç»™å¤§å®¶çš„prepareæ¶ˆæ¯æ˜¯ç›¸åŒçš„è¿˜æ˜¯ä¸åŒçš„ã€‚å½“ç„¶ï¼Œå› ä¸ºå›å¤çš„responseæ˜¯å¯¹æ¶ˆæ¯çš„ç­¾åï¼Œæ˜¯å¦å¯ä»¥ä»ç­¾åçš„ç‰¹æ€§å‡ºå‘ï¼Œåˆ¤æ–­å¯¹æ–¹ç­¾åçš„æ•°æ®æ˜¯å¦ä¸è‡ªèº«ç­¾åçš„æ•°æ®æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸€ç‚¹ï¼Œåœ¨ä»£ç é‡Œæ¥çœ‹ï¼Œæš‚æ—¶è¿˜æ²¡çœ‹åˆ°å…·ä½“è§£é‡Šã€‚</p>]]></content>
      
      
      <categories>
          
          <category> fabric </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>btc_wallet</title>
      <link href="/2019/04/14/btc-wallet/"/>
      <url>/2019/04/14/btc-wallet/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¯”ç‰¹å¸é’±åŒ…gocoinå­¦ä¹ ç¬”è®°"><a href="#æ¯”ç‰¹å¸é’±åŒ…gocoinå­¦ä¹ ç¬”è®°" class="headerlink" title="æ¯”ç‰¹å¸é’±åŒ…gocoinå­¦ä¹ ç¬”è®°"></a>æ¯”ç‰¹å¸é’±åŒ…gocoinå­¦ä¹ ç¬”è®°</h3><blockquote><p><a href="https://github.com/piotrnar/gocoin">https://github.com/piotrnar/gocoin</a></p><p><strong>Gocoin</strong> is a full <strong>Bitcoin</strong> solution written in Go language (golang).</p><p>The software architecture is focused on maximum performance of the node and cold storage security of the wallet.</p><p>The <strong>wallet</strong> is designed to be used offline. It is deterministic and password seeded. As long as you remember the password, you do not need any backups ever. Wallet can be used without the client, but with the provided <strong>balio</strong> tool instead.</p><p>The <strong>client</strong> (p2p node) is an application independent from the <strong>wallet</strong>. It keeps the entire UTXO set in RAM, providing the best block processing performance on the market.</p></blockquote><h4 id="blockdb"><a href="#blockdb" class="headerlink" title="blockdb"></a>blockdb</h4><ul><li>cache, ç¼“å­˜æ± ï¼Œæ–°äº§ç”Ÿblockï¼Œæ·»åŠ å…¥ç¼“å­˜æ± ï¼Œå½“ç¼“å­˜æ± æ»¡äº†ä¹‹åï¼Œè¸¢æ‰æœ€è€ä½¿ç”¨çš„block</li><li>å†™ç¼“å­˜channelï¼Œå½“channelæ»¡äº†ä¹‹åï¼Œflush channel åˆ°dbæ–‡ä»¶ä¸­</li></ul><h4 id="unspent-db"><a href="#unspent-db" class="headerlink" title="unspent_db"></a>unspent_db</h4><p>å¦‚ä»‹ç»ä¸­æåˆ°çš„ï¼Œä¼šå°†æ‰€æœ‰çš„utxoéƒ½å­˜åœ¨å†…å­˜é‡Œã€‚</p><ul><li>map, keyä¸ºtxid, vä¸ºtxidä¸‹çš„æ‰€æœ‰çš„outsã€‚é—®é¢˜æ˜¯keyçš„é•¿åº¦ä¸º8ï¼Ÿtxidé•¿åº¦ä¸º32ï¼Œåªå–å‰8ä½ï¼Ÿä¸ä¼šå­˜åœ¨å†²çªå—</li><li>updateä¸ºæ•´ä½“ä¿®æ”¹ï¼Œå³txidä¸‹æ‰€æœ‰çš„outsã€‚</li><li>å­˜äºæ–‡ä»¶ï¼Œç¨‹åºå¯åŠ¨æ—¶ä»æ–‡ä»¶è¯»å–ï¼Œå¿…è¦æ—¶å­˜å…¥æ–‡ä»¶(å¦‚ç¨‹åºé€€å‡ºæ—¶)</li></ul><h4 id="wallet-db-go"><a href="#wallet-db-go" class="headerlink" title="wallet/db.go"></a>wallet/db.go</h4><p>è´¦æˆ·ç³»ç»Ÿï¼Œaddr - utxo - balance</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var (</span><br><span class="line">AllBalancesP2KH, AllBalancesP2SH, AllBalancesP2WKH map[[20]byte]*OneAllAddrBal</span><br><span class="line">AllBalancesP2WSH                                   map[[32]byte]*OneAllAddrBal</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type OneAllAddrInp [utxo.UtxoIdxLen + 4]byte</span><br><span class="line"></span><br><span class="line">type OneAllAddrBal struct &#123;</span><br><span class="line">Value   uint64 // Highest bit of it means P2SH</span><br><span class="line">unsp    []OneAllAddrInp</span><br><span class="line">unspMap map[OneAllAddrInp]bool</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥ä¸»è¦æ˜¯å­˜äºå†…å­˜ä¸­ï¼Œmapçš„keyä¸ºaddrï¼ŒOneAllAddrInpä¸ºtxidçš„å‰8ä½(unspend_dbä¸­mapçš„key)+n(ç¬¬å‡ ä¸ªout)</p><p>å…¶ä¸­ï¼Œæ ¹æ®outä¸­scriptå¯ä»¥åˆ¤æ–­æ˜¯ä»€ä¹ˆåœ°å€çš„ç­¾åã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">if out.IsP2KH() &#123;</span><br><span class="line">copy(uidx[:], out.PKScr[3:23])</span><br><span class="line">rec = AllBalancesP2KH[uidx]</span><br><span class="line">if rec == nil &#123;</span><br><span class="line">rec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class="line">AllBalancesP2KH[uidx] = rec</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if out.IsP2SH() &#123;</span><br><span class="line">copy(uidx[:], out.PKScr[2:22])</span><br><span class="line">rec = AllBalancesP2SH[uidx]</span><br><span class="line">if rec == nil &#123;</span><br><span class="line">rec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class="line">AllBalancesP2SH[uidx] = rec</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if out.IsP2WPKH() &#123;</span><br><span class="line">copy(uidx[:], out.PKScr[2:22])</span><br><span class="line">rec = AllBalancesP2WKH[uidx]</span><br><span class="line">if rec == nil &#123;</span><br><span class="line">rec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class="line">AllBalancesP2WKH[uidx] = rec</span><br><span class="line">&#125;</span><br><span class="line">&#125; else if out.IsP2WSH() &#123;</span><br><span class="line">var uidx [32]byte</span><br><span class="line">copy(uidx[:], out.PKScr[2:34])</span><br><span class="line">rec = AllBalancesP2WSH[uidx]</span><br><span class="line">if rec == nil &#123;</span><br><span class="line">rec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class="line">AllBalancesP2WSH[uidx] = rec</span><br><span class="line">&#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">continue</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func (out *UtxoTxOut) IsP2KH() bool &#123;</span><br><span class="line">return len(out.PKScr) == 25 &amp;&amp; out.PKScr[0] == 0x76 &amp;&amp; out.PKScr[1] == 0xa9 &amp;&amp;</span><br><span class="line">out.PKScr[2] == 0x14 &amp;&amp; out.PKScr[23] == 0x88 &amp;&amp; out.PKScr[24] == 0xac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *UtxoTxOut) IsP2SH() bool &#123;</span><br><span class="line">return len(r.PKScr) == 23 &amp;&amp; r.PKScr[0] == 0xa9 &amp;&amp; r.PKScr[1] == 0x14 &amp;&amp; r.PKScr[22] == 0x87</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *UtxoTxOut) IsP2WPKH() bool &#123;</span><br><span class="line">return len(r.PKScr) == 22 &amp;&amp; r.PKScr[0] == 0 &amp;&amp; r.PKScr[1] == 20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *UtxoTxOut) IsP2WSH() bool &#123;</span><br><span class="line">return len(r.PKScr) == 34 &amp;&amp; r.PKScr[0] == 0 &amp;&amp; r.PKScr[1] == 32</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ†å‰å¤„ç†"><a href="#åˆ†å‰å¤„ç†" class="headerlink" title="åˆ†å‰å¤„ç†"></a>åˆ†å‰å¤„ç†</h4><p>é¦–å…ˆï¼Œæ”¶åˆ°æ¥è‡ªpeerçš„åŒºå—éƒ½ä¼šå­˜ä¸‹æ¥ï¼Œåªæ˜¯ä½¿ç”¨trustå­—æ®µæ¥è¡¨é¢è¿™æ˜¯ä¸»é“¾ä¸Šçš„å—è¿˜æ˜¯åˆ†å‰é“¾ä¸Šçš„å—ã€‚åœ¨ä¿å­˜åˆ°ç£ç›˜æ—¶åŒæ ·ä¼šä¿å­˜trustå­—æ®µã€‚</p><p>å…¶æ¬¡ï¼Œå¦‚æœå‡ºç°åˆ†å‰äº†ï¼Œä¼šç»Ÿè®¡ä¸¤æ¡é“¾çš„ç®—åŠ›(è¿™é‡Œä¸ºä»€ä¹ˆä¸æ˜¯ç»Ÿè®¡åŒºå—é«˜åº¦è€Œæ˜¯éš¾åº¦å€¼è®©æˆ‘æœ‰ç‚¹è´¹è§£)ï¼Œç„¶åå¦‚æœåˆ†å‰é“¾çš„ç®—åŠ›å¤§äºä¸»é“¾ï¼Œä¼šè¿›è¡Œä¸»é“¾é‡ç½®ã€‚è·Ÿethçš„å¤„ç†ç±»ä¼¼ï¼Œé¦–å…ˆæ‰¾åˆ°å…±åŒçš„ä¸»å—(åˆ†å‰å¼€å§‹çš„åœ°æ–¹)ï¼Œç„¶ååºŸé™¤çš„ä¸€æ–¹è¿›è¡Œutxoçš„undo, å—çš„åˆ é™¤ï¼Œç„¶åæ–°é“¾è¿›è¡Œutxoçš„doingã€‚</p><p>ä»£ç å¤§è‡´ä½äºlib/chain/ä¸‹ï¼Œå¦‚blockdb.go,chain_accept.goç­‰</p><p>åˆ†å‰ç®—åŠ›ç»Ÿè®¡ç®—æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Returns true if b1 has more POW than b2</span><br><span class="line">func (b1 *BlockTreeNode) MorePOW(b2 *BlockTreeNode) bool &#123;</span><br><span class="line">var b1sum, b2sum float64</span><br><span class="line">for b1.Height &gt; b2.Height &#123;</span><br><span class="line">b1sum += btc.GetDifficulty(b1.Bits())</span><br><span class="line">b1 = b1.Parent</span><br><span class="line">&#125;</span><br><span class="line">for b2.Height &gt; b1.Height &#123;</span><br><span class="line">b2sum += btc.GetDifficulty(b2.Bits())</span><br><span class="line">b2 = b2.Parent</span><br><span class="line">&#125;</span><br><span class="line">for b1 != b2 &#123;</span><br><span class="line">b1sum += btc.GetDifficulty(b1.Bits())</span><br><span class="line">b2sum += btc.GetDifficulty(b2.Bits())</span><br><span class="line">b1 = b1.Parent</span><br><span class="line">b2 = b2.Parent</span><br><span class="line">&#125;</span><br><span class="line">return b1sum &gt; b2sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å…³äºåœ°å€"><a href="#å…³äºåœ°å€" class="headerlink" title="å…³äºåœ°å€"></a>å…³äºåœ°å€</h4><p>ä¹‹å‰æƒ³é€šè¿‡inputä¸­çš„scriptç›´æ¥ç®—å‡ºåœ°å€ï¼Œæ˜¯ä¸å¯è¡Œçš„ã€‚</p><p>æ™®é€šçš„<em>P2PKH</em>çš„inputä¸­ç­¾ååŒ…å«ä¸¤éƒ¨åˆ†pk+sigï¼Œæ‰€ä»¥æ‹¿åˆ°æ˜¯å¯ä»¥é€šè¿‡pkè§£æå‡ºåœ°å€çš„ã€‚</p><p>ä½†P2SH scriptçš„ç­¾åæ˜¯ä¸åŒ…å«pkçš„ï¼Œæ‰€ä»¥æ˜¯è§£æä¸åˆ°çš„ã€‚</p><p>æ™®éè€Œè¨€ï¼Œè¿˜æ˜¯åœ¨outä¸­æ‰¾å¥½äº†</p>]]></content>
      
      
      <categories>
          
          <category> btc </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>btc</title>
      <link href="/2019/04/14/btc/"/>
      <url>/2019/04/14/btc/</url>
      
        <content type="html"><![CDATA[<h3 id="æ¯”ç‰¹å¸çš„åŸºæœ¬æ¦‚å¿µåŠç›¸å…³è®¤è¯†"><a href="#æ¯”ç‰¹å¸çš„åŸºæœ¬æ¦‚å¿µåŠç›¸å…³è®¤è¯†" class="headerlink" title="æ¯”ç‰¹å¸çš„åŸºæœ¬æ¦‚å¿µåŠç›¸å…³è®¤è¯†"></a>æ¯”ç‰¹å¸çš„åŸºæœ¬æ¦‚å¿µåŠç›¸å…³è®¤è¯†</h3><p>æœ¬ç¯‡ç¬”è®°ç»å¤§éƒ¨åˆ†å‚è€ƒè‡ª<a href="https://github.com/liuchengxu/blockchain-tutorial">æ¯”ç‰¹å¸è¶…çº§è¯¦ç»†å…¥é—¨æŒ‡å—</a>ä»¥åŠ<a href="http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html" target="_blank" rel="noopener">é˜®ä¸€å³°è€å¸ˆå…³äºåŒºå—é“¾çš„ç›¸å…³åšå®¢</a></p><p>åŒºå—é“¾æœ¬è´¨ä¸Šæ˜¯åˆ†å¸ƒå¼çš„æ•°æ®åº“ç³»ç»Ÿï¼Œæ˜¯å¼€æ”¾å¼çš„è´¦ç°¿ç³»ç»Ÿ(ledger)ã€‚</p><p>æœ¬è´¨ä¸Šï¼ŒåŒºå—é“¾å°±æ˜¯ä¸€ä¸ªæœ‰ç€ç‰¹å®šç»“æ„çš„æ•°æ®åº“ï¼Œæ˜¯ä¸€ä¸ªæœ‰åºï¼Œæ¯ä¸€ä¸ªå—éƒ½è¿æ¥åˆ°å‰ä¸€ä¸ªå—çš„é“¾è¡¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒºå—æŒ‰ç…§æ’å…¥çš„é¡ºåºè¿›è¡Œå­˜å‚¨ï¼Œæ¯ä¸ªå—éƒ½ä¸å‰ä¸€ä¸ªå—ç›¸è¿ã€‚è¿™æ ·çš„ç»“æ„ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å¿«é€Ÿåœ°è·å–é“¾ä¸Šçš„æœ€æ–°å—ï¼Œå¹¶ä¸”é«˜æ•ˆåœ°é€šè¿‡å“ˆå¸Œæ¥æ£€ç´¢ä¸€ä¸ªå—ã€‚</p><h5 id="æŒ–çŸ¿ï¼ˆå·¥ä½œé‡è¯æ˜ï¼‰"><a href="#æŒ–çŸ¿ï¼ˆå·¥ä½œé‡è¯æ˜ï¼‰" class="headerlink" title="æŒ–çŸ¿ï¼ˆå·¥ä½œé‡è¯æ˜ï¼‰"></a>æŒ–çŸ¿ï¼ˆå·¥ä½œé‡è¯æ˜ï¼‰</h5><p>å·¥ä½œé‡è¯æ˜æ˜¯ä¸€ç§å…±è¯†ç®—æ³•ï¼Œåœ¨æ¯”ç‰¹å¸ä¸­ï¼Œè¿™ä¸ªå·¥ä½œå°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå—çš„æœ‰æ•ˆå“ˆå¸Œï¼Œå¹¶è¯æ˜å…¶æœ‰æ•ˆæ€§ã€‚</p><p>è·å¾—æŒ‡å®šæ•°æ®çš„ä¸€ä¸ªå“ˆå¸Œå€¼çš„è¿‡ç¨‹ï¼Œå°±å«åšå“ˆå¸Œè®¡ç®—ã€‚ä¸€ä¸ªå“ˆå¸Œï¼Œå°±æ˜¯å¯¹æ‰€è®¡ç®—æ•°æ®çš„ä¸€ä¸ªå”¯ä¸€è¡¨ç¤ºã€‚å¯¹äºä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œè¾“å…¥ä»»æ„å¤§å°çš„æ•°æ®ï¼Œå®ƒä¼šè¾“å‡ºä¸€ä¸ªå›ºå®šå¤§å°çš„å“ˆå¸Œå€¼ã€‚ä¸‹é¢æ˜¯å“ˆå¸Œçš„å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼š</p><ol><li>æ— æ³•ä»ä¸€ä¸ªå“ˆå¸Œå€¼æ¢å¤åŸå§‹æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå“ˆå¸Œå¹¶ä¸æ˜¯åŠ å¯†ã€‚</li><li>å¯¹äºç‰¹å®šçš„æ•°æ®ï¼Œåªèƒ½æœ‰ä¸€ä¸ªå“ˆå¸Œï¼Œå¹¶ä¸”è¿™ä¸ªå“ˆå¸Œæ˜¯å”¯ä¸€çš„ã€‚</li><li>å³ä½¿æ˜¯ä»…ä»…æ”¹å˜è¾“å…¥æ•°æ®ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿä¼šå¯¼è‡´è¾“å‡ºä¸€ä¸ªå®Œå…¨ä¸åŒçš„å“ˆå¸Œã€‚</li></ol><p>åœ¨åŒºå—é“¾ä¸­ï¼Œå“ˆå¸Œè¢«ç”¨äºä¿è¯ä¸€ä¸ªå—çš„ä¸€è‡´æ€§ã€‚å“ˆå¸Œç®—æ³•çš„è¾“å…¥æ•°æ®åŒ…å«äº†å‰ä¸€ä¸ªå—çš„å“ˆå¸Œï¼Œå› æ­¤ä½¿å¾—ä¸å¤ªå¯èƒ½ï¼ˆæˆ–è€…ï¼Œè‡³å°‘å¾ˆå›°éš¾ï¼‰å»ä¿®æ”¹é“¾ä¸­çš„ä¸€ä¸ªå—ï¼šå› ä¸ºå¦‚æœä¸€ä¸ªäººæƒ³è¦ä¿®æ”¹å‰é¢ä¸€ä¸ªå—çš„å“ˆå¸Œï¼Œé‚£ä¹ˆä»–å¿…é¡»è¦é‡æ–°è®¡ç®—è¿™ä¸ªå—ä»¥åŠåé¢æ‰€æœ‰å—çš„å“ˆå¸Œã€‚</p><p>å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„å“ˆå¸Œï¼Œéœ€è¦å¤§é‡çš„è®¡ç®—ï¼Œå¹³å‡æ˜¯10åˆ†é’Ÿæ‰èƒ½æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å“ˆå¸Œï¼Œç”Ÿæˆ1ä¸ªæ–°çš„åŒºå—ã€‚</p><h5 id="äº¤æ˜“"><a href="#äº¤æ˜“" class="headerlink" title="äº¤æ˜“"></a>äº¤æ˜“</h5><p>æ¯”ç‰¹å¸ä¸­äº¤æ˜“åˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>æ™®é€šäº¤æ˜“ï¼Œè¾“å…¥ä¼šå¼•ç”¨ä¹‹å‰ä¸€ç¬”äº¤æ˜“çš„è¾“å‡ºã€‚å³èŠ±è´¹ä¹‹å‰çš„äº¤æ˜“è¾“å‡º</li><li>ä¾‹å¤–ï¼Œcoinbaseäº¤æ˜“ï¼Œå³æŒ–çŸ¿å¥–åŠ±ï¼Œåªæœ‰è¾“å‡º</li></ol><p>åœ¨äº¤æ˜“ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>ä¸€ç¬”äº¤æ˜“çš„è¾“å…¥å¯ä»¥å¼•ç”¨ä¹‹å‰å¤šç¬”äº¤æ˜“çš„è¾“å‡º</li><li>ä¸€ä¸ªè¾“å…¥å¿…é¡»å¼•ç”¨ä¸€ä¸ªè¾“å‡º</li><li>æ²¡æœ‰è¢«å¼•ç”¨çš„è¾“å‡ºï¼Œå³ä¸ºæœªèŠ±è´¹äº¤æ˜“è¾“å‡º</li><li>è¾“å‡ºæ˜¯ä¸å¯å†åˆ†çš„ï¼Œå³ä¸€ä¸ªè¾“å‡ºä½ æ— æ³•ä»…å¼•ç”¨å®ƒçš„å…¶ä¸­æŸä¸€éƒ¨åˆ†ï¼Œè¦ä¹ˆä¸è¦ï¼Œè¦ä¹ˆä¸€æ¬¡æ€§ç”¨å®Œã€‚å½“å®ƒçš„å€¼æ¯”éœ€è¦çš„å€¼å¤§ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ‰¾é›¶ï¼Œæ‰¾é›¶ä¼šè¿”è¿˜ç»™å‘é€æ–¹ã€‚</li></ul><p>é‚£ä¹ˆï¼Œäº¤æ˜“çš„è¯ï¼Œéœ€è¦çš„æ˜¯å‘é€æ–¹ï¼Œæ¥æ”¶æ–¹ï¼Œäº¤æ˜“é‡‘é¢ã€‚æ•´ä¸ªäº¤æ˜“çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ä»å‘é€æ–¹ä¸­æ‰¾åˆ°è¶³å¤Ÿäº¤æ˜“é‡‘é¢çš„æœªèŠ±è´¹äº¤æ˜“è¾“å‡ºs(å¯èƒ½æ˜¯å¤šä¸ªè¾“å‡ºçš„å åŠ )ï¼Œä½œä¸ºäº¤æ˜“çš„è¾“å…¥</li><li>ç¡®å®šè¾“å‡ºï¼Œè¾“å‡ºæœ‰å¯èƒ½ä¸º2ä¸ªï¼Œä¸€ä¸ªæ˜¯æ¥æ”¶æ–¹ï¼Œä¸€ä¸ªæ˜¯å‘é€è€…çš„æ‰¾é›¶</li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œäº¤æ˜“ç”Ÿæˆåï¼Œå¹¶ä¸æ˜¯ç«‹åˆ»ç”Ÿæ•ˆï¼Œè€Œæ˜¯å…ˆå°†äº¤æ˜“æ”¾åˆ°ä¸€ä¸ªå†…å­˜æ± ä¸­ï¼Œç„¶åå½“çŸ¿å·¥å‡†å¤‡æŒ–å‡ºä¸€ä¸ªæ–°å—æ—¶ï¼Œå®ƒå°±ä»å†…å­˜æ± ä¸­å–å‡ºæ‰€æœ‰äº¤æ˜“ï¼Œåˆ›å»ºä¸€ä¸ªå€™é€‰å—ï¼Œå½“åŒ…å«è¿™äº›äº¤æ˜“çš„å—è¢«æŒ–å‡ºæ¥æ·»åŠ åˆ°åŒºå—é“¾ä»¥åï¼Œé‡Œé¢çš„äº¤æ˜“æ‰å¼€å§‹ç¡®è®¤ã€‚</p><h5 id="åœ°å€"><a href="#åœ°å€" class="headerlink" title="åœ°å€"></a>åœ°å€</h5><p>å½“äº¤æ˜“å‘ç”Ÿæ—¶ï¼Œå¦‚ä½•æ ¡éªŒå‘é€æ–¹å’Œæ¥æ”¶æ–¹å‘¢ï¼Œæ²¡æœ‰ç”¨æˆ·è´¦æˆ·ï¼Œå¦‚ä½•æŸ¥éªŒè‡ªå·±æ‰€æœ‰çš„æœªèŠ±è´¹è¾“å‡ºå‘¢ã€‚åœ¨æ¯”ç‰¹å¸ä¸­ï¼Œæ ¡éªŒæ–¹å¼ä¸ºï¼Œå¯†é’¥å¯¹ï¼Œå…¬é’¥å’Œç§é’¥ã€‚ç§é’¥ä»£è¡¨çš„å°±æ˜¯ä½ ï¼Œæ‰€æœ‰çš„äº¤æ˜“ä¸­å«æœ‰çš„ä¿¡æ¯ä¸ºå…¬é’¥ç›¸å…³ã€‚</p><p>æ ¹æ®åè®®ï¼Œå…¬é’¥çš„é•¿åº¦æ˜¯512ä½ã€‚è¿™ä¸ªé•¿åº¦ä¸å¤ªæ–¹ä¾¿ä¼ æ’­ï¼Œå› æ­¤åè®®åˆè§„å®šï¼Œè¦ä¸ºå…¬é’¥ç”Ÿæˆä¸€ä¸ª160ä½çš„æŒ‡çº¹ã€‚æ‰€è°“æŒ‡çº¹ï¼Œå°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„ã€æ˜“äºä¼ æ’­çš„å“ˆå¸Œå€¼ã€‚160ä½æ˜¯äºŒè¿›åˆ¶ï¼Œå†™æˆåå…­è¿›åˆ¶ï¼Œå¤§çº¦æ˜¯26åˆ°35ä¸ªå­—ç¬¦ï¼Œå³åœ°å€ã€‚</p><p>äº¤æ˜“äº§ç”Ÿæ—¶ï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡Œç­¾åï¼Œç­¾åè¿‡ç¨‹éœ€è¦è¢«ç­¾åçš„æ•°æ®å’Œç§é’¥ï¼Œè¿™ä¸ªç­¾åä¼šè¢«å­˜å‚¨åœ¨äº¤æ˜“è¾“å…¥ä¸­ã€‚ä¸ºäº†å¯¹ä¸€ä¸ªç­¾åè¿›è¡ŒéªŒè¯ï¼Œéœ€è¦è¢«ç­¾åçš„æ•°æ®ï¼Œç­¾åï¼Œå…¬é’¥ã€‚æ‰€ä»¥åœ¨ä¸€ä¸ªäº¤æ˜“çš„è¾“å…¥ä¸­ï¼Œè¿™ä¸‰è€…éƒ½ä¼šå­˜å‚¨ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™è¿›è¡ŒéªŒè¯å‘¢ï¼Œå½“æŠŠäº¤æ˜“ä»å†…å­˜æ± ä¸­å–å‡ºæ¥æ”¾å…¥åˆ°ä¸€ä¸ªå—ä¹‹å‰ï¼Œå¯¹æ¯ä¸€ç¬”äº¤æ˜“éƒ½è¦è¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Œå…¶ä¸€æ˜¯æ£€æŸ¥äº¤æ˜“è¾“å…¥æœ‰æƒä½¿ç”¨æ¥è‡ªä¹‹å‰äº¤æ˜“çš„è¾“å‡ºï¼Œå…¶äºŒæ˜¯æ£€æŸ¥äº¤æ˜“ç­¾åæ˜¯æ­£ç¡®çš„ã€‚</p><p>äº¤æ˜“è¿‡ç¨‹ï¼Œä¸€ç¬”äº¤æ˜“å°±æ˜¯ä¸€ä¸ªåœ°å€çš„æ¯”ç‰¹å¸è½¬ç§»åˆ°å¦ä¸€ä¸ªåœ°å€ã€‚ç”³æŠ¥äº¤æ˜“æ—¶ï¼Œé™¤äº†äº¤æ˜“é‡‘é¢ï¼Œè½¬å‡ºæ¯”ç‰¹å¸çš„ä¸€æ–¹è¿˜å¿…é¡»æä¾›ä»¥ä¸‹æ•°æ®ï¼š</p><ul><li>ä¸Šä¸€ç¬”äº¤æ˜“çš„hash(ä½ ä»å“ªé‡Œå¾—åˆ°çš„è¿™äº›æ¯”ç‰¹å¸)</li><li>æœ¬æ¬¡äº¤æ˜“åŒæ–¹çš„åœ°å€</li><li>æ”¯ä»˜æ–¹çš„å…¬é’¥</li><li>æ”¯ä»˜æ–¹çš„ç§é’¥ç”Ÿæˆçš„æ•°å­—ç­¾å</li></ul><p>éªŒè¯è¿™ç¬”äº¤æ˜“æ˜¯å¦å±å®ï¼Œéœ€è¦ä¸‰æ­¥ï¼š</p><ol><li>æ‰¾åˆ°ä¸Šä¸€ç¬”äº¤æ˜“ï¼Œç¡®è®¤æ”¯ä»˜æ–¹çš„æ¯”ç‰¹å¸æ¥æº</li><li>ç®—å‡ºæ”¯ä»˜æ–¹å…¬é’¥çš„æŒ‡çº¹ï¼Œç¡®è®¤ä¸æ”¯ä»˜æ–¹çš„åœ°å€ä¸€ç›´ï¼Œä»è€Œä¿è¯å…¬é’¥å±å®</li><li>ä½¿ç”¨å…¬é’¥å»è§£å¼€æ•°å­—ç­¾åï¼Œä¿è¯ç§é’¥å±å®</li></ol><p>äº¤æ˜“ç¡®è®¤ï¼Œäº¤æ˜“å¿…é¡»å†™å…¥åŒºå—é“¾ï¼Œæ‰ç®—ç”Ÿæ•ˆã€‚é¦–å…ˆï¼Œæ‰€æœ‰çš„äº¤æ˜“æ•°æ®éƒ½ä¼šä¼ é€åˆ°çŸ¿å·¥é‚£é‡Œï¼ŒçŸ¿å·¥è´Ÿè´£æŠŠè¿™äº›äº¤æ˜“å†™å…¥åŒºå—é“¾ã€‚æ ¹æ®æ¯”ç‰¹å¸åè®®ï¼Œä¸€ä¸ªåŒºå—çš„å¤§å°æœ€å¤§æ˜¯ 1MBï¼Œè€Œä¸€ç¬”äº¤æ˜“å¤§æ¦‚æ˜¯500å­—èŠ‚å·¦å³ï¼Œå› æ­¤ä¸€ä¸ªåŒºå—æœ€å¤šå¯ä»¥åŒ…å«2000å¤šç¬”äº¤æ˜“ã€‚çŸ¿å·¥è´Ÿè´£æŠŠè¿™2000å¤šç¬”äº¤æ˜“æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œç»„æˆä¸€ä¸ªåŒºå—ç„¶åè®¡ç®—è¿™ä¸ªåŒºå—çš„ Hashï¼ˆå·¥ä½œé‡è¯æ˜ï¼‰ã€‚å¦å¤–ï¼Œé‰´äºåŒºå—é“¾åˆ†å‰çš„æƒ…å†µï¼Œæ ¹æ®æ¯”ç‰¹å¸åè®®è§„å®šï¼Œåˆ†å‰ç‚¹æœ€å…ˆè¾¾åˆ°6ä¸ªåŒºå—çš„é‚£ä¸ªåˆ†æ”¯ï¼Œè¢«è®¤å®šä¸ºæ­£å¼çš„åŒºå—é“¾ï¼Œå…¶ä»–åˆ†æ”¯éƒ½å°†è¢«æ”¾å¼ƒï¼Œæ‰€ä»¥ï¼Œä¸€ç¬”äº¤æ˜“çœŸæ­£ç”Ÿæ•ˆï¼Œå¿…é¡»ç­‰å¾…è‡³å°‘1ä¸ªå°æ—¶ã€‚</p><p>ç²˜è´´ä¸€ç‚¹æ•°æ®ç»“æ„ï¼Œä¾›å‚è€ƒã€‚</p><p>è¾“å…¥ç»“æ„ä½“å®šä¹‰ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type TXInput struct &#123;</span><br><span class="line">    Txid      []byte  //ä¸€ä¸ªè¾“å…¥å¼•ç”¨ä¹‹å‰äº¤æ˜“çš„ä¸€ä¸ªè¾“å‡ºï¼Œtxidä¸ºä¹‹å‰äº¤æ˜“çš„ID</span><br><span class="line">    Vout      int  //ä¹‹å‰äº¤æ˜“çš„è¾“å‡ºå¯èƒ½æœ‰å¤šä¸ªï¼Œéœ€è¦æŒ‡æ˜æ˜¯å…·ä½“å“ªä¸€ä¸ª</span><br><span class="line">    Signature []byte //ç­¾å</span><br><span class="line">    PubKey    []byte //å…¬é’¥</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æ„ä½“å®šä¹‰ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type TXOutput struct &#123;</span><br><span class="line">    Value      int  </span><br><span class="line">    PubKeyHash []byte //å…¬é’¥å“ˆå¸Œ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°ä¸¤ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼Œå¯ä»¥æƒ³åˆ°ï¼Œç­¾åçš„ä½œç”¨ä»…åœ¨äºåˆ°è¢«éªŒè¯å®Œæ¯•ã€‚è¾“å‡ºä¸­å…¬é’¥å“ˆå¸Œçš„ä½¿ç”¨åœºæ™¯åœ¨äºæ ¡éªŒï¼Œä¾‹å¦‚æŸ¥æ‰¾æœªèŠ±è´¹è¾“å‡ºæ—¶ï¼Œåˆ¤æ–­æ¡ä»¶ä¸ºè¾“å‡ºä¸­çš„å…¬é’¥å“ˆå¸Œå’Œå½“å‰å…¬é’¥è¿›è¡Œå“ˆå¸Œä¹‹åæ˜¯å¦åŒ¹é…ï¼Œè¿˜æœ‰å¦å¤–çš„åœºæ™¯..ä¸‹é¢æ¥å›é¡¾ä¸€ä¸‹ä¸€ä¸ªäº¤æ˜“å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><ol><li>èµ·åˆï¼Œåˆ›ä¸–å—é‡Œé¢åŒ…å«äº†ä¸€ä¸ªcoinbaseäº¤æ˜“ï¼Œåœ¨coinbaseäº¤æ˜“ä¸­ï¼Œæ²¡æœ‰è¾“å…¥ï¼Œå°±ä¸éœ€è¦ç­¾åï¼Œcoinbaseäº¤æ˜“çš„è¾“å‡ºåŒ…å«äº†ä¸€ä¸ªå“ˆå¸Œè¿‡çš„å…¬é’¥ï¼ˆä½¿ç”¨çš„æ˜¯ <strong>RIPEMD16(SHA256(PubKey))</strong> ç®—æ³•ï¼‰</li><li>å½“æœ‰äººå‘é€å¸æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ç¬”äº¤æ˜“ï¼Œè¿™ç¬”äº¤æ˜“çš„è¾“å…¥ä¼šå¼•ç”¨ä¹‹å‰äº¤æ˜“çš„è¾“å‡ºï¼Œè¿˜ä¼šå­˜å‚¨ä¸€ä¸ªå…¬é’¥(æ²¡æœ‰è¢«å“ˆå¸Œ)å’Œæ•´ä¸ªäº¤æ˜“çš„ä¸€ä¸ªç­¾å</li><li>æ¯”ç‰¹å¸ç½‘ç»œä¸­æ¥æ”¶åˆ°äº¤æ˜“çš„å…¶ä»–èŠ‚ç‚¹ä¼šå¯¹è¯¥äº¤æ˜“è¿›è¡ŒéªŒè¯ï¼Œé™¤äº†ä¸€äº›å…¶ä»–äº‹æƒ…ï¼Œä»–ä»¬è¿˜ä¼šæ£€æŸ¥ï¼Œåœ¨ä¸€ä¸ªè¾“å…¥ä¸­ï¼Œå…¬é’¥å“ˆå¸Œä¸æ‰€å¼•ç”¨çš„è¾“å‡ºå“ˆå¸Œç›¸åŒ¹é…ï¼ˆè¿™ä¿è¯äº†å‘é€æ–¹åªèƒ½èŠ±è´¹å±äºè‡ªå·±çš„å¸ï¼‰ï¼›ç­¾åæ˜¯æ­£ç¡®çš„ï¼ˆè¿™ä¿è¯äº†äº¤æ˜“æ˜¯ç”±å¸çš„å®é™…æ‹¥æœ‰è€…æ‰€åˆ›å»ºï¼‰ã€‚</li><li>å½“ä¸€ä¸ªçŸ¿å·¥å‡†å¤‡æŒ–ä¸€ä¸ªæ–°å—æ—¶ï¼Œä»–ä¼šå°†äº¤æ˜“æ”¾åˆ°å—ä¸­ï¼Œç„¶åå¼€å§‹æŒ–çŸ¿ã€‚</li><li>å½“æ–°å—è¢«æŒ–å‡ºæ¥ä»¥åï¼Œç½‘ç»œä¸­çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ä¼šæ¥æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œå‘Šè¯‰å…¶ä»–äººè¿™ä¸ªå—å·²ç»è¢«æŒ–å‡ºå¹¶è¢«åŠ å…¥åˆ°åŒºå—é“¾ã€‚</li><li>å½“ä¸€ä¸ªå—è¢«åŠ å…¥åˆ°åŒºå—é“¾ä»¥åï¼Œäº¤æ˜“å°±ç®—å®Œæˆï¼Œå®ƒçš„è¾“å‡ºå°±å¯ä»¥åœ¨æ–°çš„äº¤æ˜“ä¸­è¢«å¼•ç”¨ã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯è¿™å…¶ä¸­çš„ä¸€äº›åŠ å¯†ç®—æ³•å•¦~</p><ul><li><p>ç§é’¥ç”Ÿæˆç®—æ³•ï¼Œæ¤­åœ†æ›²çº¿åŠ å¯†</p></li><li><p>åœ°å€ç”Ÿæˆç®—æ³•ï¼ŒBase58,  å¦‚æœä½ æƒ³è¦ç»™æŸä¸ªäººå‘é€å¸ï¼Œåªéœ€è¦çŸ¥é“ä»–çš„åœ°å€å°±å¯ä»¥äº†ã€‚å½“æˆ‘ä»¬ç»™æŸä¸ªäººå‘é€å¸æ—¶ï¼Œæˆ‘ä»¬åªçŸ¥é“ä»–çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä½¿ç”¨ä¸€ä¸ªåœ°å€ä½œä¸ºå”¯ä¸€çš„å‚æ•°ã€‚ç„¶åï¼Œåœ°å€ä¼šè¢«è§£ç ï¼Œä»ä¸­æå–å‡ºå…¬é’¥å“ˆå¸Œå¹¶ä¿å­˜åœ¨ <code>PubKeyHash</code> å­—æ®µ</p></li><li><p>ç­¾åçš„æ•°æ®ï¼Œå› ä¸ºç”¨äºç­¾åçš„è¿™ä¸ªæ•°æ®ï¼Œå¿…é¡»è¦åŒ…å«èƒ½å¤Ÿå”¯ä¸€è¯†åˆ«æ•°æ®çš„ä¿¡æ¯ã€‚æ‰€ä»¥éœ€è¦ç­¾åçš„æ•°æ®å¿…é¡»åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†</p><ol><li>å­˜å‚¨åœ¨å·²è§£é”è¾“å‡ºçš„å…¬é’¥å“ˆå¸Œã€‚å®ƒè¯†åˆ«äº†ä¸€ç¬”äº¤æ˜“çš„â€œå‘é€æ–¹â€ã€‚</li><li>å­˜å‚¨åœ¨æ–°çš„é”å®šè¾“å‡ºé‡Œé¢çš„å…¬é’¥å“ˆå¸Œã€‚å®ƒè¯†åˆ«äº†ä¸€ç¬”äº¤æ˜“çš„â€œæ¥æ”¶æ–¹â€ã€‚</li><li>æ–°çš„è¾“å‡ºå€¼ã€‚</li></ol><p>æ¯”ç‰¹å¸é‡Œï¼Œ æ‰€ç­¾åçš„å¹¶ä¸æ˜¯ä¸€ä¸ªäº¤æ˜“ï¼Œè€Œæ˜¯ä¸€ä¸ªå»é™¤éƒ¨åˆ†å†…å®¹çš„è¾“å…¥å‰¯æœ¬ã€‚</p></li></ul><h5 id="UTXOé›†"><a href="#UTXOé›†" class="headerlink" title="UTXOé›†"></a>UTXOé›†</h5><p>åœ¨æŸ¥æ‰¾æŸä¸ªå…¬é’¥çš„æ‰€æœ‰æœªèŠ±è´¹è¾“å‡ºæ—¶ï¼Œéœ€è¦æŸ¥æ‰¾æ‰€æœ‰çš„åŒºå—ï¼ŒåŒºå—ä¸­çš„æ¯ä¸€ç¬”äº¤æ˜“ï¼Œä½†æ˜¯å¦‚æœåŒºå—ç‰¹åˆ«å¤šçš„æƒ…å†µä¸‹ï¼Œè¿­ä»£éœ€è¦çš„æˆæœ¬å°±å¤ªå¤§äº†ã€‚è§£å†³æ–¹å¼å°±æ˜¯æœ‰ä¸€ä¸ªä»…æœ‰æœªèŠ±è´¹è¾“å‡ºçš„ç´¢å¼•ï¼Œè¿™å°±æ˜¯UTXOé›†è¦åšçš„äº‹æƒ…ï¼Œè¿™æ˜¯ä¸€ä¸ªä»æ‰€æœ‰åŒºå—é“¾äº¤æ˜“ä¸­æ„å»º(å¯¹åŒºå—è¿›è¡Œè¿­ä»£ï¼Œä½†æ˜¯åªé¡»åšä¸€æ¬¡)è€Œæ¥çš„ç¼“å­˜ï¼Œç„¶åç”¨å®ƒæ¥è®¡ç®—ä½™é¢å’ŒéªŒè¯æ–°çš„äº¤æ˜“ã€‚</p><h5 id="Merkleæ ‘"><a href="#Merkleæ ‘" class="headerlink" title="Merkleæ ‘"></a>Merkleæ ‘</h5><p>Merkleæ ‘ä¸º1ç§ä¼˜åŒ–æœºåˆ¶ï¼Œå®ç°çš„æ˜¯æ¯ä¸ªå—ä¸­ï¼Œéƒ½æœ‰1ä¸ªMerkleæ ‘ï¼Œæ ‘çš„å¶å­èŠ‚ç‚¹ä¸ºä¸€ä¸ªäº¤æ˜“å“ˆå¸Œï¼Œä»ä¸‹å¾€ä¸Šï¼Œä¸¤ä¸¤æˆå¯¹ï¼Œè¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹å“ˆå¸Œï¼Œå°†ç»„åˆå“ˆå¸Œä½œä¸ºæ–°çš„å“ˆå¸Œï¼Œæ–°çš„å“ˆå¸Œå°±æˆä¸ºæ–°çš„æ ‘èŠ‚ç‚¹ï¼Œä¸€ç›´åˆ°æ ‘æ ¹ï¼Œæ ¹å“ˆå¸Œå°±ä¼šå½“ä½œæ˜¯æ•´ä¸ªå—äº¤æ˜“çš„å”¯ä¸€æ ‡è¯†ï¼Œå°†å®ƒä¿å­˜åˆ°åŒºå—å¤´ï¼Œç„¶åç”¨äºå·¥ä½œé‡è¯æ˜ã€‚</p><p>Merkleæ ‘çš„å¥½å¤„å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥åœ¨ä¸ä¸‹è½½æ•´ä¸ªå—çš„æƒ…å†µä¸‹ï¼ŒéªŒè¯æ˜¯å¦åŒ…å«æŸç¬”äº¤æ˜“ã€‚å¹¶ä¸”è¿™äº›åªéœ€è¦ä¸€ä¸ªäº¤æ˜“å“ˆå¸Œï¼Œä¸€ä¸ª Merkle æ ‘æ ¹å“ˆå¸Œå’Œä¸€ä¸ª Merkle è·¯å¾„ã€‚</p><h5 id="P2PKH"><a href="#P2PKH" class="headerlink" title="P2PKH"></a>P2PKH</h5><p>åœ¨æ¯”ç‰¹å¸ä¸­æœ‰ä¸€ä¸ª <em>è„šæœ¬ï¼ˆScriptï¼‰</em>ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒç”¨äºé”å®šäº¤æ˜“è¾“å‡ºï¼›äº¤æ˜“è¾“å…¥æä¾›äº†è§£é”è¾“å‡ºçš„æ•°æ®ã€‚è¿™ä¸ªä¸ªè„šæœ¬å«åš <em>Pay to Public Key Hash(P2PKH)</em>ï¼Œè¿™æ˜¯æ¯”ç‰¹å¸æœ€å¸¸ç”¨çš„ä¸€ä¸ªè„šæœ¬ã€‚å®ƒæ‰€åšçš„äº‹æƒ…å°±æ˜¯å‘ä¸€ä¸ªå…¬é’¥å“ˆå¸Œæ”¯ä»˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æŸä¸€ä¸ªå…¬é’¥é”å®šä¸€äº›å¸ã€‚è¿™æ˜¯<strong>æ¯”ç‰¹å¸æ”¯ä»˜çš„æ ¸å¿ƒ</strong>ï¼šæ²¡æœ‰è´¦æˆ·ï¼Œæ²¡æœ‰èµ„é‡‘è½¬ç§»ï¼›åªæœ‰ä¸€ä¸ªè„šæœ¬æ£€æŸ¥æä¾›çš„ç­¾åå’Œå…¬é’¥æ˜¯å¦æ­£ç¡®ã€‚æœ‰äº†ä¸€ä¸ªè¿™æ ·çš„è„šæœ¬è¯­è¨€ï¼Œå®é™…ä¸Šä¹Ÿå¯ä»¥è®©æ¯”ç‰¹å¸æˆä¸ºä¸€ä¸ªæ™ºèƒ½åˆçº¦å¹³å°ï¼šé™¤äº†å°†ä¸€ä¸ªå•ä¸€çš„å…¬é’¥è½¬ç§»èµ„é‡‘ï¼Œè¿™ä¸ªè¯­è¨€è¿˜ä½¿å¾—ä¸€äº›å…¶ä»–çš„æ”¯ä»˜æ–¹æ¡ˆæˆä¸ºå¯èƒ½ã€‚</p><h5 id="æ•°æ®åº“ç»“æ„"><a href="#æ•°æ®åº“ç»“æ„" class="headerlink" title="æ•°æ®åº“ç»“æ„"></a>æ•°æ®åº“ç»“æ„</h5><p>ç®€å•æ¥è¯´ï¼ŒBitcoin Coreä½¿ç”¨ä¸¤ä¸ªâ€bucketâ€æ¥å­˜å‚¨æ•°æ®ï¼š</p><ol><li>blocks, å®ƒå­˜å‚¨äº†æè¿°ä¸€æ¡é“¾ä¸­æ‰€æœ‰å—çš„å…ƒæ•°æ®</li><li>chainstate, å­˜å‚¨äº†ä¸€æ¡é“¾çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ‰€æœ‰çš„æœªèŠ±è´¹çš„äº¤æ˜“è¾“å‡ºï¼Œå’Œä¸€äº›å…ƒæ•°æ®</li></ol><p>æ­¤å¤–ï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼ŒBitcoin Core å°†æ¯ä¸ªåŒºå—ï¼ˆblockï¼‰å­˜å‚¨ä¸ºç£ç›˜ä¸Šçš„ä¸åŒæ–‡ä»¶ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå°±ä¸éœ€è¦ä»…ä»…ä¸ºäº†è¯»å–ä¸€ä¸ªå•ä¸€çš„å—è€Œå°†æ‰€æœ‰ï¼ˆæˆ–è€…éƒ¨åˆ†ï¼‰çš„å—éƒ½åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h5 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h5><p>åŒºå—é“¾ç½‘ç»œæ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯ä¹Ÿä¸éœ€è¦ä¾èµ–æœåŠ¡å™¨æ¥è·å–æˆ–å¤„ç†æ•°æ®ã€‚åœ¨åŒºå—é“¾ç½‘ç»œä¸­ï¼Œæœ‰çš„æ˜¯èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯ç½‘ç»œçš„ä¸€ä¸ªå®Œå…¨ï¼ˆfull-fledgedï¼‰æˆå‘˜ã€‚èŠ‚ç‚¹å°±æ˜¯ä¸€åˆ‡ï¼šå®ƒæ—¢æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ã€‚è¿™ä¸€ç‚¹éœ€è¦ç‰¢è®°äºå¿ƒï¼Œå› ä¸ºè¿™ä¸ä¼ ç»Ÿçš„ç½‘é¡µåº”ç”¨éå¸¸ä¸åŒã€‚</p><p>åŒºå—é“¾ç½‘ç»œæ˜¯ä¸€ä¸ª P2Pï¼ˆPeer-to-Peerï¼Œç«¯åˆ°ç«¯ï¼‰çš„ç½‘ç»œï¼Œå³èŠ‚ç‚¹ç›´æ¥è¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚å®ƒçš„æ‹“æ‰‘æ˜¯æ‰å¹³çš„ï¼Œå› ä¸ºåœ¨èŠ‚ç‚¹çš„ä¸–ç•Œä¸­æ²¡æœ‰å±‚çº§ä¹‹åˆ†ã€‚æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸å¾ˆå¤šå…¶ä»–èŠ‚ç‚¹è¿›è¡Œäº¤äº’ï¼Œå®ƒå¿…é¡»è¯·æ±‚å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¸è‡ªå·±çš„çŠ¶æ€è¿›è¡Œæ¯”è¾ƒï¼Œå½“çŠ¶æ€è¿‡æ—¶æ—¶è¿›è¡Œæ›´æ–°ã€‚</p><p>å½“ä½ å‘ç”Ÿäº†ä¸€ç¬”æ”¯ä»˜ï¼Œä½ æ‰€åœ¨çš„èŠ‚ç‚¹å°±ä¼šæŠŠè¿™ç¬”äº¤æ˜“å‘Šè¯‰å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´è‡³ä¼ éæ•´ä¸ªç½‘ç»œã€‚çŸ¿å·¥ä»ç½‘ä¸Šæ”¶é›†å„ç§æ–°å‘ç”Ÿçš„äº¤æ˜“ï¼Œå°†å®ƒä»¬æ‰“åŒ…å†™å…¥åŒºå—é“¾ã€‚ä¸€æ—¦å†™å…¥æˆåŠŸï¼Œ çŸ¿å·¥æ‰€åœ¨èŠ‚ç‚¹çš„åŒºå—é“¾ï¼Œå°±æˆä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½ä¼šæ¥å¤åˆ¶æ–°å¢çš„åŒºå—ï¼Œä¿è¯å…¨ç½‘çš„åŒºå—é“¾éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p><p>èŠ‚ç‚¹è§’è‰²ï¼š</p><ul><li>çŸ¿å·¥ è¿™æ ·çš„èŠ‚ç‚¹è¿è¡Œäºå¼ºå¤§æˆ–ä¸“ç”¨çš„ç¡¬ä»¶ï¼ˆæ¯”å¦‚ ASICï¼‰ä¹‹ä¸Šï¼Œå®ƒä»¬å”¯ä¸€çš„ç›®æ ‡æ˜¯ï¼Œå°½å¯èƒ½å¿«åœ°æŒ–å‡ºæ–°å—ã€‚çŸ¿å·¥æ˜¯åŒºå—é“¾ä¸­å”¯ä¸€å¯èƒ½ä¼šç”¨åˆ°å·¥ä½œé‡è¯æ˜çš„è§’è‰²ï¼Œå› ä¸ºæŒ–çŸ¿å®é™…ä¸Šæ„å‘³ç€è§£å†³ PoW éš¾é¢˜ã€‚åœ¨æƒç›Šè¯æ˜ PoS çš„åŒºå—é“¾ä¸­ï¼Œæ²¡æœ‰æŒ–çŸ¿ã€‚</li><li>å…¨èŠ‚ç‚¹ è¿™äº›èŠ‚ç‚¹éªŒè¯çŸ¿å·¥æŒ–å‡ºæ¥çš„å—çš„æœ‰æ•ˆæ€§ï¼Œå¹¶å¯¹äº¤æ˜“è¿›è¡Œç¡®è®¤ã€‚ä¸ºæ­¤ï¼Œä»–ä»¬å¿…é¡»æ‹¥æœ‰åŒºå—é“¾çš„å®Œæ•´æ‹·è´ã€‚åŒæ—¶ï¼Œå…¨èŠ‚ç‚¹æ‰§è¡Œè·¯ç”±æ“ä½œï¼Œå¸®åŠ©å…¶ä»–èŠ‚ç‚¹å‘ç°å½¼æ­¤ã€‚å¯¹äºç½‘ç»œæ¥è¯´ï¼Œéå¸¸é‡è¦çš„ä¸€æ®µå°±æ˜¯è¦æœ‰è¶³å¤Ÿå¤šçš„å…¨èŠ‚ç‚¹ã€‚å› ä¸ºæ­£æ˜¯è¿™äº›èŠ‚ç‚¹æ‰§è¡Œäº†å†³ç­–åŠŸèƒ½ï¼šä»–ä»¬å†³å®šäº†ä¸€ä¸ªå—æˆ–ä¸€ç¬”äº¤æ˜“çš„æœ‰æ•ˆæ€§ã€‚</li><li>SPV SPV è¡¨ç¤º Simplified Payment Verificationï¼Œç®€å•æ”¯ä»˜éªŒè¯ã€‚è¿™äº›èŠ‚ç‚¹å¹¶ä¸å­˜å‚¨æ•´ä¸ªåŒºå—é“¾å‰¯æœ¬ï¼Œä½†æ˜¯ä»ç„¶èƒ½å¤Ÿå¯¹äº¤æ˜“è¿›è¡ŒéªŒè¯ï¼ˆä¸è¿‡ä¸æ˜¯éªŒè¯å…¨éƒ¨äº¤æ˜“ï¼Œè€Œæ˜¯ä¸€ä¸ªäº¤æ˜“å­é›†ï¼Œæ¯”å¦‚ï¼Œå‘é€åˆ°æŸä¸ªæŒ‡å®šåœ°å€çš„äº¤æ˜“ï¼‰ã€‚ä¸€ä¸ª SPV èŠ‚ç‚¹ä¾èµ–ä¸€ä¸ªå…¨èŠ‚ç‚¹æ¥è·å–æ•°æ®ï¼Œå¯èƒ½æœ‰å¤šä¸ª SPV èŠ‚ç‚¹è¿æ¥åˆ°ä¸€ä¸ªå…¨èŠ‚ç‚¹ã€‚SPV ä½¿å¾—é’±åŒ…åº”ç”¨æˆä¸ºå¯èƒ½ï¼šä¸€ä¸ªäººä¸éœ€è¦ä¸‹è½½æ•´ä¸ªåŒºå—é“¾ï¼Œä½†æ˜¯ä»èƒ½å¤ŸéªŒè¯ä»–çš„äº¤æ˜“ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> btc </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>fabric_example</title>
      <link href="/2019/04/11/fabric-example/"/>
      <url>/2019/04/11/fabric-example/</url>
      
        <content type="html"><![CDATA[<p>fabric-exampleså­¦ä¹ ç¬”è®°</p><p>ç”±äºdocker imagesä¸‹è½½çš„é€Ÿåº¦å®åœ¨å¤ªâ€¦ è¿™ä¸ªæ—¶é—´å°±å…ˆçœ‹çœ‹exampleså§</p><p>ç‰ˆæœ¬release-1.1</p><p>chaincode</p><ul><li><p>Example-01</p><p>  func main() {</p><pre><code>err := shim.Start(new(SimpleChaincode))if err != nil {    fmt.Printf(&quot;Error starting Simple chaincode: %s&quot;, err)}</code></pre><p>  }</p></li></ul><p>ç¬¬ä¸€ä¸ªä¾‹å­å°±è¯¦ç»†çœ‹ä¸€ä¸‹ç»“æ„ï¼Œåé¢çš„éƒ½ç±»ä¼¼ã€‚</p><p>mainæ–¹æ³•é‡Œshim.Start(new(ç»“æ„ä½“))æ˜¯å…¥å£ï¼Œæ‰€æœ‰ä»£ç å®ç°çš„éƒ¨åˆ†éƒ½æ˜¯å®ç°è¿™ä¸ªç»“æ„ä½“ã€‚è¿™ä¸ªç»“æ„ä½“éœ€è¦å®ç°çš„æ–¹æ³•</p><ul><li>Init(stub shim.ChaincodeStubInterface) pb.Response</li><li>Invoke(stub shim.ChaincodeStubInterface) pb.Response</li></ul><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰ä¸¤ä¸ªè´¦æˆ·åŠå…¶ä½™é¢ï¼ŒInitæ–¹æ³•ä¸ºè®¾ç½®ä¸¤ä¸ªè´¦æˆ·çš„åå­—åŠä½™é¢ã€‚Invokeæ–¹æ³•å®ç°çš„æ˜¯ä»Aè´¦æˆ·è½¬è´¦åˆ°Bè´¦æˆ·ã€‚é¡¾åæ€ä¹‰çš„è¯ï¼ŒInitä¸ºåˆå§‹åŒ–æ–¹æ³•ï¼ŒInvokeçŒœæµ‹åº”è¯¥æ˜¯ä½¿ç”¨åå°„ï¼Œå¯å®ç°ä¸ºåˆ†å‘çš„åŠŸèƒ½ï¼Œåˆ†å‘åˆ°å…¶ä»–æ–¹æ³•ä¸­ï¼Œå®ç°å…·ä½“ç›¸åº”åŠŸèƒ½ã€‚ä¾‹å¦‚</p><pre><code>func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {    function, args := stub.GetFunctionAndParameters() //è·å–è°ƒç”¨çš„æ–¹æ³•ååŠå…¶å‚æ•°    if function == &quot;invoke&quot; {        // Make payment of X units from A to B        return t.invoke(stub, args)  //è°ƒç”¨ç›¸åº”æ–¹æ³•    } else if function == &quot;delete&quot; {        // Deletes an entity from its state        return t.delete(stub, args)  //è°ƒç”¨ç›¸åº”æ–¹æ³•    } else if function == &quot;query&quot; {        // the old &quot;Query&quot; is now implemtned in invoke        return t.query(stub, args)  //è°ƒç”¨ç›¸åº”æ–¹æ³•    }    return shim.Error(&quot;Invalid invoke function name. Expecting \&quot;invoke\&quot; \&quot;delete\&quot; \&quot;query\&quot;&quot;)}</code></pre><p>å¥½å§å…¶å®è¿™æ˜¯example-02çš„ä»£ç äº†  - . -</p><ul><li>Example-02</li></ul><p>åŠŸèƒ½ä¸Šæ¥è¯´çš„è¯ï¼Œ01æ˜¯ä¸¤ä¸ªå›ºå®šçš„è´¦æˆ·ï¼Œ02æ˜¯è´¦æœ¬ä¸Šçš„ä¸¤ä¸ªè´¦æˆ·çš„æ“ä½œã€‚ç¬¬ä¸€ï¼Œæ“ä½œå¢å¤šäº†ï¼Œæœ‰æŸ¥è¯¢åˆ é™¤ï¼Œå®ç°ä¸ºåœ¨invokeä¸­è¿›è¡Œåˆ†å‘ï¼Œä»£ç å¦‚ä¸Šâ€¦ç¬¬äºŒï¼Œç‰µæ¶‰åˆ°è´¦æœ¬äº†ï¼Œçœ‹ä¼¼åƒä¸€ä¸ªkey-valueçš„æ•°æ®å­˜å‚¨ï¼Œä»£ç å¦‚ä¸‹</p><pre><code>//å­˜err = stub.PutState(A, []byte(strconv.Itoa(Aval)))//å–Avalbytes, err := stub.GetState(A)</code></pre><p>çŒœæµ‹è‚¯å®šæ˜¯æ•°æ®åº“æ–¹é¢çš„äº†ï¼Œæ›´æ·±å…¥çš„ä¹‹åå†çœ‹ã€‚å°¤å…¶æ˜¯stubï¼Œshim.ChaincodeStubInterfaceã€‚è¿™ä¸ªå¯¹è±¡æ˜¯æ‰€æœ‰è·Ÿä¸Šå±‚æ¥è½¨çš„æ¥å£ï¼Œå…¶å®ç°éœ€è¦æŸ¥çœ‹ã€‚è¿™é‡Œå…ˆç•¥è¿‡</p><ul><li>Example -03</li></ul><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¥½åƒé‡ç‚¹åœ¨ä¸‹é¢è¿™ä¸ªä»£ç </p><pre><code>func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response {  Â·Â·Â·  // Write the state to the ledger - this put is illegal within Run    err = stub.PutState(A, []byte(strconv.Itoa(Aval)))  Â·Â·Â·}</code></pre><p>æ„æ€å¥½åƒæ˜¯åœ¨queryæ–¹æ³•ä¸­ä¸èƒ½è¿›è¡ŒputStateã€‚å»¶ä¼¸ä¸€ä¸‹çš„è¯ï¼Œæ˜¯åªæœ‰åœ¨åŸå§‹invokeæ–¹æ³•ä¸­æ‰èƒ½è¿›è¡ŒputStateï¼Œä¿®æ”¹æ•°æ®åº“ã€‚å½“ç„¶å•¦ï¼Œè¿™ä¸ªå°å†™çš„invokeæ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„</p><ul><li>Example-04</li></ul><p>è¿™ä¸ªä¾‹å­ä¸ºexampleäº†åœ¨é“¾ç ä¸­è°ƒç”¨å…¶ä»–é“¾ç ï¼Œä¸»è¦apiä¸º</p><pre><code>response := stub.InvokeChaincode(chainCodeToCall, invokeArgs, channelID)</code></pre><ul><li>Example-05</li></ul><p>è¿™ä¸ªä¾‹å­ä¹Ÿæ˜¯è°ƒç”¨å…¶ä»–é“¾ç ï¼Œä½†æ˜¯è¯´æ˜äº†è°ƒç”¨çš„é“¾ç å’Œå½“å‰é“¾ç ä¸æ˜¯åŒä¸€ä¸ªchannelä¸Šéœ€è¦æŒ‡æ˜channelã€‚è¿™ä¸ªä¸æ˜¯å¾ˆæ˜ç™½ã€‚</p><p>ä½¿ç”¨InvokeChaincodeæ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°ä¾æ¬¡æ˜¯ è¢«è°ƒç”¨çš„é“¾ç åç§°ï¼Œè°ƒç”¨å‚æ•°(åŒ…æ‹¬è°ƒç”¨æ–¹æ³•å’Œå‚æ•°)ï¼Œ channel name</p><p>çœ‹4ï¼Œ5testå¹¶æ²¡æœ‰çœ‹å‡ºæ¥4 5è°ƒç”¨çš„å·®åˆ«â€¦</p><ul><li><p>Test</p><pre><code>scc := new(SimpleChaincode)stub := shim.NewMockStub(&quot;ex03&quot;, scc)res := stub.MockInvoke(&quot;1&quot;, [][]byte{[]byte(&quot;query&quot;), []byte(&quot;A&quot;), []byte(&quot;345&quot;))if res.Status != shim.OK {    fmt.Println(&quot;Query failed&quot;, string(res.Message))    t.FailNow()}</code></pre></li></ul><p>è¿˜æœ‰ä¸ªå¯åŠ¨ä¸¤ä¸ªé“¾ç çš„</p><pre><code>scc := new(SimpleChaincode)stub := shim.NewMockStub(&quot;ex05&quot;, scc)ccEx2 := new(ex02.SimpleChaincode)stubEx2 := shim.NewMockStub(chaincodeName, ccEx2)checkInit(t, stubEx2, [][]byte{[]byte(&quot;init&quot;), []byte(&quot;a&quot;), []byte(&quot;222&quot;), []byte(&quot;b&quot;), []byte(&quot;333&quot;)})//åœ¨å½“å‰æ¨¡æ‹Ÿpeerï¼Œæ·»åŠ chaincodestub.MockPeerChaincode(chaincodeName, stubEx2)</code></pre><p>çœ‹å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼ŒTutorialsä¼¼ä¹æä¾›äº†4ä¸ªtutorialï¼Œåˆ†åˆ«ä¸ºApplicationå¼€å‘(ä½¿ç”¨çš„node sdk)ã€ç½‘ç»œæ­å»ºã€é“¾ç å¼€å‘ã€é“¾ç æ“ä½œã€‚ä½œä¸ºå…¥é—¨çš„è¯ï¼Œè‚¯å®šè¦éƒ½è¿‡ä¸€éå•¦~</p><p>ç½‘ç»œæ­å»º</p><p>ç¤ºä¾‹ä¸­åŒ…å«2ç»„ï¼Œæ¯ç»„2ä¸ªpeerèŠ‚ç‚¹ï¼Œä»¥åŠ1ä¸ªå•ç‹¬çš„orderæœåŠ¡</p><p>é¦–å…ˆclone fabric-exampleä»“åº“ï¼Œç„¶åæ‰¾åˆ°ä¸‹è½½docker imagesçš„åœ°æ–¹ï¼Œä¸‹è½½docker-imageså®˜æ–¹æ˜¯ä½¿ç”¨curl â€¦ | bash çš„ä¸€è¡Œå‘½ä»¤ï¼Œä¸‹è½½é€Ÿåº¦å¾ˆæ…¢ï¼Œç»è¿‡ç½‘ä¸Šå¾ˆå¤šå¥½å¿ƒäººæç¤ºï¼Œè¯´curl é‚£ä¸ªè¿æ¥å…¶å®æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œç›´æ¥ç”¨ç½‘ç«™æ‰“å¼€é‚£ä¸ªè¿æ¥ï¼Œå¤åˆ¶ç²˜è´´è„šæœ¬åˆ°æœ¬åœ°ï¼Œå‘½å*.shï¼Œç„¶åç›´æ¥è¿è¡Œå°±å¥½äº†ï¼Œè¿™ä¸ªè„šæœ¬å¤§æ¦‚çœ‹ä¸€ä¸‹ï¼Œæœ‰3ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œ2ä¸ªæ–¹æ³•éƒ½æœ‰ä¸‹è½½docker images, è¿˜æœ‰1ä¸ªæ–¹æ³•æ˜¯ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åä¼šä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹çš„binæ–‡ä»¶å¤¹ä¸‹ã€‚biné‡Œé¢çš„å†…å®¹å¦‚ä¸‹</p><pre><code>$ lsconfigtxgen        configtxlator        cryptogen        get-docker-images.sh    orderer            peer</code></pre><p>ç„¶åæŠŠè¿™ä¸ªbinæ–‡ä»¶å¤¹æ‹·è´åˆ°fabric-exampleä¸‹ã€‚</p><pre><code>$ cd first-network$ ./byfn.sh -m generate</code></pre><p>å¦‚æœbiné‡Œé¢å†…å®¹ç¼ºå¤±ï¼Œè¿™é‡Œå°±ä¼šæŠ¥å„ç§å‘½ä»¤ä¸å­˜åœ¨ã€‚å†åˆ™ï¼Œä¸‹è½½çš„fabric-exampleçš„ç‰ˆæœ¬åº”è¯¥å’ŒäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„ç‰ˆæœ¬ä¸€è‡´ï¼Œä¸ç„¶è¿˜æ˜¯ä¼šæŠ¥é”™..å¯ç›´æ¥ä¿®æ”¹ä¸‹è½½è„šæœ¬é‡Œçš„ç‰ˆæœ¬ã€‚</p><pre><code>$ ./byfn.sh -m up</code></pre><p>å…¶ä¸­ï¼Œå¯¹äºç‰ˆæœ¬é—®é¢˜æ˜¯æ˜¯ä¸¥è°¨ã€‚å„ä¸ªç‰ˆæœ¬éƒ½è¦ä¸€æ ·ã€‚å¦å¤–ï¼Œä¸Šé¢æåˆ°çš„é‚£ä¸ªcurl é“¾æ¥çš„é‚£ä¸ªè„šæœ¬ï¼Œåœ¨fabricä»“åº“ä¸‹å…¶å®æ˜¯æœ‰çš„ï¼Œscript/bootstrap.shã€‚å¯ç›´æ¥æ‹·è´ç²˜è´´</p><p>ç„¶åé’ˆå¯¹byfnè„šæœ¬å…·ä½“åˆ†æä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹å’Œç»“æ„çš„å§~</p><p>â˜ï¸ï¼Œ$ ./byfn.sh -m generateçš„åŠŸèƒ½ã€‚</p><ul><li><p>ä½¿ç”¨cryptogenå·¥å…·æ¥ä¸ºèŠ‚ç‚¹ç”ŸæˆåŠ å¯†è¯ä¹¦ã€‚è¿™äº›è¯ä¹¦å¯ä»£è¡¨èŠ‚ç‚¹çš„èº«ä»½ï¼Œè¢«å…è®¸ç­¾ç½²/éªŒè¯èº«ä»½éªŒè¯è¿›è¡Œå®ä½“æ²Ÿé€šå’Œäº¤æ˜“ã€‚</p><ul><li>cryptogené€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œå·¥ä½œï¼Œé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†å„ä¸ªèŠ‚ç‚¹ä¿¡æ¯ã€‚å¦‚crypto-config.yaml<pre><code>OrdererOrgs:  - Name: Orderer    Domain: example.com    # ---------------------------------------------------------------------------    # &quot;Specs&quot; - See PeerOrgs below for complete description    # ---------------------------------------------------------------------------    Specs:      - Hostname: ordererPeerOrgs:# -----------------------------------------------------# Org1# ----------------------------------------------------- Name: Org1  Domain: org1.example.com  Template:      Count: 2  Users:      Count: 1</code></pre>ä½¿ç”¨å‘½ä»¤ä¸ºcryptogen generate â€“config=./crypto-config.yamlï¼ŒæˆåŠŸåä¼šåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆcrypto-configæ–‡ä»¶å¤¹,  å„ä¸ªè¯ä¹¦ä»¥èŠ‚ç‚¹è§’è‰²/Domain/â€¦çš„æ–‡ä»¶å½¢å¼å­˜åœ¨</li></ul></li><li><p>ä½¿ç”¨configtxgen toolæ¥ç”Ÿæˆä¸€äº›éƒ¨ç½²å®ä½“æ‰€éœ€è¦çš„é›¶ä»¶ã€‚ä¹Ÿéœ€è¦é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶å®šä¹‰äº†ç½‘ç»œæ¨¡æ¿ã€‚ä¸»è¦é›¶ä»¶ç±»å‹æœ‰</p><ul><li>orderer genesis block, ordereræœåŠ¡å¯åŠ¨å¿…å¤‡ï¼Œæ³¨æ„çš„æ˜¯æ¯ä¸ªç»„ç»‡çš„æ ¹è¯ä¹¦éƒ½åŒ…å«åœ¨gensis.blockä¸­ã€‚</li><li>channel configuration transaction, è¯¥é…ç½®åœ¨ordereræœåŠ¡å¯åŠ¨åˆ›å»ºchannelæ—¶é…ç½®channelã€‚è¿™é‡Œå°±å·²ç»å½¢æˆäº†channelçš„è¯»å†™ç­–ç•¥ï¼ˆå³å“ªäº›å®ä½“å¯ä»¥è¯»ï¼Œå“ªäº›å®ä½“å¯ä»¥å†™ï¼Œä¸‹åŒï¼‰ã€‚</li><li>and two anchor peer transactions - one for each Peer Org. ç”¨äºæŒ‡å®šåœ¨channelä¸­ï¼Œå½“å‰peerç»„ç»‡ä¸­éƒ½æœ‰å“ªäº›peerç»“ç‚¹ã€‚è¿™é‡Œå°±å·²ç»å½¢æˆäº†ç»„ç»‡çš„è¯»å†™ç­–ç•¥ã€‚</li></ul></li><li><p>æœ€åå°±æ˜¯ upå¯åŠ¨ç½‘ç»œäº†ï¼Œæœ€é‡è¦çš„å‘½ä»¤å³â€¦ docker-compose -f $COMPOSE_FILEâ€¦ï¼Œ æŸ¥çœ‹docker-compose-cli.yamlï¼Œå®šä¹‰äº†6ä¸ªå®¹å™¨æœåŠ¡ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªä¸ºcli, æ‰§è¡Œä¸º./scripts/script.shã€‚æŸ¥çœ‹è¿™ä¸ªè„šæœ¬å¤§æ¦‚ä¸ºåˆ›å»ºchannelã€åŠ å…¥channelã€å‡çº§ç»„ç»‡é…ç½®ã€å®‰è£…éƒ¨ç½²chaincodeã€è°ƒç”¨chaincodeâ€¦åé¢æ¯ä¸€æ­¥åº”è¯¥éƒ½ä¼šè‡ªå·±æä¸€æ¬¡..è¿™é‡Œè¿˜æ˜¯å…ˆè·³è¿‡<br>åˆ°è¿™é‡Œï¼Œæˆ‘å°±æ„Ÿè§‰è„‘å­é‡Œæ”¾ä¸ä¸‹ä¸œè¥¿äº†å·²ç»ï¼Œå¾ˆå°´å°¬â€¦å…ˆè·Ÿç€å‘å¯¼ç»§ç»­èµ°å§</p><p>å—¯,  å¾ˆéš¾å—ã€‚</p><p>å…·ä½“çœ‹äº†ä¸€ä¸‹cliï¼Œ å¤§è‡´æ˜¯å°†è¯ä¹¦ï¼Œscriptç­‰éƒ½ä½œä¸ºæ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨ä¸Šï¼Œç„¶ååœ¨å®¹å™¨ä¸Šè°ƒç”¨scriptæ“ä½œã€‚channelçš„åŠ å…¥ï¼Œä¼¼ä¹æ˜¯é€šè¿‡å„è¯ä¹¦éªŒè¯èº«ä»½ã€‚é“¾ç çš„éƒ¨ç½²è°ƒç”¨éƒ½æ˜¯é€šè¿‡peer chaincode â€¦ å‘½ä»¤è¿›è¡Œ</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> fabric </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>elastic</title>
      <link href="/2017/10/14/elastic/"/>
      <url>/2017/10/14/elastic/</url>
      
        <content type="html"><![CDATA[<h2 id="Elasticsearch-v5-6"><a href="#Elasticsearch-v5-6" class="headerlink" title="Elasticsearch - v5.6"></a>Elasticsearch - v5.6</h2><p>Elasticsearchä½¿ç”¨Luceneè¿›è¡Œç´¢å¼•å’Œæœç´¢ã€‚Luceneï¼Œå…¨æ–‡æ£€ç´¢åŠŸèƒ½åº“ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><ul><li><p>Cluster,é›†ç¾¤</p></li><li><p>Node,èŠ‚ç‚¹</p><p>èŠ‚ç‚¹è·Ÿé›†ç¾¤çš„ç¡®å®šå…³ç³»æ˜¯é€šè¿‡é›†ç¾¤çš„åå­—cluster.name</p></li><li><p>Index,ç´¢å¼•</p></li><li><p>Type,ç±»å‹</p></li><li><p>Document,æ–‡æ¡£</p></li><li><p>Shards/Replicas åˆ†ç‰‡/å‰¯æœ¬</p><p>â­ï¸ åˆ†ç‰‡ä¼˜åŠ¿,æ°´å¹³æ‰©å®¹å’Œæé«˜æ€§èƒ½å’Œåå(åˆ†å¸ƒå¼+å¹¶è¡Œ)ã€‚<br>â­ï¸ å‰¯æœ¬ä¼˜åŠ¿ï¼Œæä¾›é«˜å¯ç”¨æ€§(é›†ç¾¤æƒ…å†µä¸‹åˆ†ç‰‡å’Œå¯¹åº”çš„å‰¯æœ¬å†³ä¸ä¼šåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š)ï¼Œæ‰©å±•æœç´¢é‡å’Œååã€‚<br>â­ï¸ å‰¯æœ¬çš„æ•°é‡åœ¨ç´¢å¼•å»ºç«‹åå¯ä»¥è°ƒæ•´ï¼Œä½†åˆ†ç‰‡æ•°é‡åˆ™ä¸èƒ½å†ä¿®æ”¹ã€‚</p></li></ul><h3 id="å¸¸ç”¨æ¦‚å¿µ"><a href="#å¸¸ç”¨æ¦‚å¿µ" class="headerlink" title="å¸¸ç”¨æ¦‚å¿µ"></a>å¸¸ç”¨æ¦‚å¿µ</h3><ul><li><p>æŸ¥è¯¢ï¼Œè¿‡æ»¤</p><p>æŸ¥è¯¢å’Œè¿‡æ»¤ï¼ŒæŸ¥è¯¢çš„æ„æ€æ˜¯æœ‰å¤šåŒ¹é…ï¼Œè¿”å›ç»“æœåŒ…å«ç›¸å…³åº¦å¾—åˆ†ï¼Œè¿‡æ»¤ä¸ºåŒ¹é…å¦ï¼Œåˆ™ä¸ä¼šè®¡ç®—ç›¸å…³åº¦å¾—åˆ†</p></li><li><p>analyze</p><p>Luceneçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªå…¨æ–‡æ£€ç´¢çš„åŠŸèƒ½åº“ï¼Œå¯¹å­—æ®µæ–‡æœ¬çš„è¯ä¼šè¿›è¡Œåˆ†æï¼Œå»ºç«‹ç´¢å¼•æ—¶ï¼ŒLuceneä¼šä½¿ç”¨ä½ é€‰æ‹©çš„åˆ†æå™¨æ¥å¤„ç†ä½ çš„æ–‡æ¡£å†…å®¹ï¼ŒæŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢çš„å­—æ®µåŒæ ·ä¼šè¢«åŒä¸ªåˆ†æå™¨è¿›è¡Œåˆ†æã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä¸åˆ†æã€‚</p></li><li><p>mapping</p><p>æ˜ å°„å®šä¹‰çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ–‡æ¡£,å’Œå®ƒæ‰€åŒ…å«çš„å­—æ®µ,å­˜å‚¨å’Œç´¢å¼•ï¼Œå­—æ®µåŠŸèƒ½ä¸Šæ¥è¯´ï¼Œæ˜¯è¾“å…¥æ•°æ®åˆ°çœŸæ­£å­˜å‚¨ç»“æ„çš„æ˜ å°„å¤„ç†ï¼ŒåŒ…æ‹¬å­—æ®µåˆ†æå™¨é€‰æ‹©ï¼Œå­—æ®µç±»å‹ç­‰ã€‚</p></li></ul><h3 id="å¸¸ç”¨curl"><a href="#å¸¸ç”¨curl" class="headerlink" title="å¸¸ç”¨curl"></a>å¸¸ç”¨curl</h3><ul><li><p>é›†ç¾¤ç›¸å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢é›†ç¾¤çŠ¶æ€</span><br><span class="line">curl -XGET &apos;localhost:9200/_cat/health?v&amp;pretty&apos;</span><br><span class="line"></span><br><span class="line">//è·å–èŠ‚ç‚¹</span><br><span class="line">curl -XGET &apos;localhost:9200/_cat/nodes?v&amp;pretty&apos;</span><br></pre></td></tr></table></figure></li><li><p>ç´¢å¼•ç›¸å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//è·å¾—æ‰€æœ‰ç´¢å¼•</span><br><span class="line">curl -XGET &apos;localhost:9200/_cat/indices?v&amp;pretty&apos;</span><br><span class="line">//åˆ›å»ºç´¢å¼•</span><br><span class="line">curl -XPUT &apos;localhost:9200/customer?pretty&amp;pretty&apos;</span><br><span class="line">//åˆ é™¤ç´¢å¼•</span><br><span class="line">curl -XDELETE &apos;localhost:9200/customer?pretty&amp;pretty&apos;</span><br><span class="line">//æ·»åŠ ç´¢å¼•æ–‡ä»¶ï¼Œå½“æŒ‡å®šäº†idçš„æ—¶å€™ä½¿ç”¨PUT(/customer/external/2)ï¼Œæ²¡æŒ‡å®šä½¿ç”¨POST</span><br><span class="line">curl -XPOST &apos;localhost:9200/customer/external?pretty&amp;pretty&apos; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Jane Doe&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥è¯¢ç›¸å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//ä½¿ç”¨_search</span><br><span class="line">curl -XGET &apos;localhost:9200/bank/_search?pretty&apos; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">&quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&apos;</span><br></pre></td></tr></table></figure><p>å…³äºæŸ¥è¯¢å’Œè¿‡æ»¤ç›¸å…³çš„apiåœ¨éš”å£æœç´¢dslä¸­æœ‰è¯¦ç»†ä»‹ç»ã€‚</p></li><li><p>analyze ç›¸å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//ä½¿ç”¨ç´¢å¼•æŸå­—æ®µçš„åˆ†æå™¨åˆ†æï¼Œå¯ç”¨äºæŸ¥çœ‹å­—æ®µåœ¨åº•å±‚å…·ä½“ç»“æ„ uriåªèƒ½æ˜¯ç´¢å¼•/_analyze,å­—æ®µåŠ ä¸Štype</span><br><span class="line">GET /test/_analyze?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;field&quot;: &quot;analyze.my_text&quot;,</span><br><span class="line">  &quot;text&quot;:  &quot;John Smith&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç´¢å¼•ç®¡ç†æ“ä½œ"><a href="#ç´¢å¼•ç®¡ç†æ“ä½œ" class="headerlink" title="ç´¢å¼•ç®¡ç†æ“ä½œ"></a>ç´¢å¼•ç®¡ç†æ“ä½œ</h3><ul><li>å…³é—­/æ‰“å¼€ç´¢å¼•ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /storm_2017-10-31/_close</span><br><span class="line">curl -XPOST &apos;localhost:9200/storm_2017-10-31/_close&apos;</span><br><span class="line">curl -XPOST &apos;localhost:9200/storm_2017-10-31/_open&apos;</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤ç´¢å¼•ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE /index_name</span><br><span class="line">curl -XDELETE &apos;localhost:9200/index_name?pretty&amp;pretty&apos;</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ç´¢å¼•å‰¯æœ¬æ•°, å¯ä»¥å°†ä¸€äº›ä¸é‡è¦è€Œä¸”æ¯”è¾ƒè€çš„æ•°æ®è®¾ç½®å‰¯æœ¬æ•°ä¸º0ä»¥èŠ‚çœç£ç›˜ç©ºé—´</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;localhost:9200/&lt;index_name&gt;/_settings&apos; -d &apos;&#123;&quot;number_of_replicas&quot;: 0&#125;&apos;</span><br></pre></td></tr></table></figure><h4 id="ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒå®Œå…¨æŸ¥è¯¢ç¤ºä¾‹"><a href="#ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒå®Œå…¨æŸ¥è¯¢ç¤ºä¾‹" class="headerlink" title="ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒå®Œå…¨æŸ¥è¯¢ç¤ºä¾‹"></a>ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒå®Œå…¨æŸ¥è¯¢ç¤ºä¾‹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;bool&quot;:&#123;</span><br><span class="line">      &quot;must&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;,</span><br><span class="line">      &quot;filter&quot;:[</span><br><span class="line">        &#123;&quot;term&quot;:&#123;&quot;op&quot;: 25677&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;:&#123;&quot;parsed&quot;:true&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;device_addr&quot;: 53784&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;cmd.data.index&quot;: 0&#125;&#125;,</span><br><span class="line">        &#123;&quot;range&quot;:&#123;</span><br><span class="line">          &quot;@timestamp&quot;:&#123;</span><br><span class="line">            &quot;from&quot;:&quot;2017-12-14T07:00:53.000+00:00&quot;,</span><br><span class="line">            &quot;to&quot;:&quot;2017-12-14T10:41:53.000+00:00&quot;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;script_fields&quot;: &#123;</span><br><span class="line">    &quot;gm_data_0&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &quot;if(doc[&apos;op&apos;].value == 25677 &amp;&amp; params[&apos;_source&apos;][&apos;cmd&apos;][&apos;data&apos;] != null) &#123; for(def item : params[&apos;_source&apos;][&apos;cmd&apos;][&apos;data&apos;]) &#123; if(item.index == 0)  return item.data_value;  &#125;&#125; return null;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;:50,</span><br><span class="line">  &quot;from&quot;:0,</span><br><span class="line">  &quot;sort&quot;:&#123;&quot;@timestamp&quot;:&quot;desc&quot;&#125;,</span><br><span class="line">  &quot;timeout&quot;:&quot;51s&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><h4 id="æŸä¸€ç´¢å¼•ä¸ºyellowåŸå› åŠä¿®å¤æ–¹æ³•"><a href="#æŸä¸€ç´¢å¼•ä¸ºyellowåŸå› åŠä¿®å¤æ–¹æ³•" class="headerlink" title="æŸä¸€ç´¢å¼•ä¸ºyellowåŸå› åŠä¿®å¤æ–¹æ³•"></a>æŸä¸€ç´¢å¼•ä¸ºyellowåŸå› åŠä¿®å¤æ–¹æ³•</h4><p><a href="https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/" target="_blank" rel="noopener">åŸæ–‡è¿æ¥</a></p><ul><li>æŸ¥çœ‹æŸä¸€å‰¯æœ¬åˆ†ç‰‡æœªåˆ†é…çš„åŸå› </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason| grep UNASSIGNED</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹èŠ‚ç‚¹ç£ç›˜å ç”¨æ¯”ä¾‹</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s &apos;localhost:9200/_cat/allocation?v&apos;</span><br></pre></td></tr></table></figure><ul><li>è®¾ç½®å½“ç£ç›˜å ç”¨ç‡è¾¾åˆ°å¤šå°‘æ—¶ä¸å†åˆ†é…åˆ†ç‰‡</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &apos;localhost:9200/_cluster/settings&apos; -d</span><br><span class="line">                  &apos;&#123;</span><br><span class="line">                           &quot;transient&quot;: &#123;</span><br><span class="line">                             &quot;cluster.routing.allocation.disk.watermark.low&quot;: &quot;90%&quot;</span><br><span class="line">                                &#125;</span><br><span class="line">                       &#125;&apos;</span><br></pre></td></tr></table></figure><ul><li>å†…å­˜åˆ†é…é—®é¢˜</li></ul><p>ESä¸ºè¿è¡Œåœ¨jvmä¸Šçš„javaè¿›ç¨‹,å¾ˆæœ‰å¯èƒ½æŠ¥OOM,æˆ–è€…æŸ¥çœ‹gcæ—¥å¿—æ—¶å‘ç°å›æ”¶è¾¾åˆ°äº†ç“¶é¢ˆï¼Œè§£å†³æ–¹æ³•æ˜¯åŠ å†…å­˜ï¼Œä½†ç»™ESåŠ å†…å­˜æ˜¯æŒ‡å¢åŠ å †å†…å­˜ï¼Œä½†å †å†…å­˜çš„åˆ†é…æœ€å¥½å°äºæœºå™¨æ€»å†…å­˜çš„ä¸€åŠï¼Œå¹¶ä¸”å°äº32Gã€‚ESä½¿ç”¨çš„å¤§å†…å­˜é™¤äº†å †å†…å­˜å¤–ï¼ŒLuceneä½¿ç”¨æ—¶ä¼šå æ®æ–‡ä»¶ç¼“å­˜ï¼Œæ•…å †å†…å­˜è¶Šå¤§ï¼Œå¯ç”¨çš„ç¼“å­˜ç©ºé—´å°±è¶Šå°ï¼Œç£ç›˜æ¢è¯»çš„é¢‘ç‡å°±è¶Šé«˜ã€‚å †å†…å­˜çš„åˆ†é…è¿˜æ˜¯å°äºæ€»å†…å­˜çš„ä¸€åŠï¼Œç»™æ–‡ä»¶ç¼“å­˜ç•™ç‚¹å†…å­˜æ¯”è¾ƒåˆé€‚ã€‚</p><p>åœ¨æŸ¥è¯¢æ—¶ï¼ŒLuceneä¼šå°†ç´¢å¼•éƒ¨åˆ†åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€ï¼ŒæŸ¥è¯¢çš„æ•°æ®é‡å†³å®šäº†å†…å­˜çš„ä½¿ç”¨ï¼Œæ‰€ä»¥å½“å¤©æ•°å¢åŠ ï¼Œæ•°æ®é‡å¢å¤§çš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å‡ºç°OOMã€‚</p><p>å½“GCå‡ºç°ç“¶é¢ˆæ—¶ï¼Œä¼šå‡ºç°ESæ— æ³•å“åº”çš„æƒ…å†µï¼ŒKibanaä¹Ÿä¼šå‡ºç°å¯¹åº”æç¤º(Status Red)ã€‚</p><p>ä½¿ç”¨ä¸­å‘ç°Kibanaå‡ºç°Status Redï¼Œé¦–å…ˆæŸ¥è¯¢é›†ç¾¤çŠ¶æ€ï¼Œçœ‹èŠ‚ç‚¹æ˜¯å¦å·¥ä½œæ­£å¸¸ï¼Œå…¶æ¬¡æŸ¥çœ‹å„èŠ‚ç‚¹æ—¥å¿—ï¼ŒæŸ¥çœ‹é—®é¢˜ã€‚</p><p>å¦å¤–,swappingçš„æƒ…å†µå¯¹äºæ€§èƒ½æ¥è¯´æ˜¯è‡´å‘½çš„ï¼Œå½“å†…å­˜èµ„æºä¸è¶³æ—¶ï¼ŒLinuxä¼šå°†æŸäº›å†…å®¹è½¬ç§»åˆ°swapping(ç¡¬ç›˜)ä¸Šï¼Œè¦ä½¿ç”¨è¿™éƒ¨åˆ†å†…å®¹çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæåˆ°å†…å­˜ä¸­ï¼Œå†ä½¿ç”¨ã€‚æ‰€ä»¥ESä¸­ï¼Œæœ€å¥½ç¦ç”¨swappingã€‚</p>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>floodlight_sdn</title>
      <link href="/2017/10/14/floodlight-sdn/"/>
      <url>/2017/10/14/floodlight-sdn/</url>
      
        <content type="html"><![CDATA[<h2 id="SDNåŸºæœ¬æ¶æ„"><a href="#SDNåŸºæœ¬æ¶æ„" class="headerlink" title="SDNåŸºæœ¬æ¶æ„"></a>SDNåŸºæœ¬æ¶æ„</h2><ul><li>æ§åˆ¶å±‚</li><li>è½¬å‘å±‚</li><li>åº”ç”¨å±‚</li><li>å—å‘æ¥å£</li><li>åŒ—å‘æ¥å£</li></ul><p>åŸºæœ¬å«ä¹‰å€Ÿâ€SDNæ ¸å¿ƒæŠ€æœ¯å‰–æå’Œå®æˆ˜æŒ‡å—â€ä¹¦çš„ä¾‹å­æ¥è¯´ï¼š</p><blockquote><p>SDNçš„æ¶æ„å¯ä»¥ä¸äººçš„èº«ä½“åšç±»æ¯”ï¼šæ§åˆ¶å±‚å°±æ˜¯äººçš„å¤§è„‘ï¼Œè´Ÿè´£å¯¹äººèº«ä½“çš„æ€»ä½“ç®¡æ§ï¼›è½¬å‘å±‚çš„è®¾å¤‡æ˜¯äººçš„å››è‚¢ï¼Œåœ¨å¤§è„‘çš„æ§åˆ¶ä¸‹è¿›è¡Œå„ç§æ´»åŠ¨ï¼›åº”ç”¨å±‚å¯¹åº”çš„æ˜¯å„ç§åˆ›æ–°çš„æƒ³æ³•ï¼Œå¤§è„‘åœ¨å®ƒä»¬çš„é©±åŠ¨ä¸‹å¯¹å››è‚¢è¿›è¡ŒæŒ‡æŒ¥ä»¥è¾¾åˆ°å…¶æ‰€éœ€çš„æ•ˆæœï¼›å—å‘æ¥å£å’ŒåŒ—å‘æ¥å£åˆ™åˆ†åˆ«ç›¸å½“äºäººä½“å†…çš„ç¥ç»å’Œè„‘ç”µæ³¢ï¼Œè´Ÿè´£å„ç§ä¿¡å·çš„ä¸Šä¼ ä¸‹è¾¾</p></blockquote><p>æ•…ç”±ä¸Šåˆ°ä¸‹çš„é¡ºåºæ˜¯ åº”ç”¨å±‚ -&gt; æ§åˆ¶å±‚ -&gt; è½¬å‘å±‚ï¼Œå—åŒ—ä¹Ÿå› æ­¤å‘½åï¼ŒåŒ—å‘æ¥å£ä¸ºæ§åˆ¶å±‚æä¾›ç»™åº”ç”¨å±‚çš„æ¥å£ï¼Œå—å‘æ¥å£ä¸ºæ§åˆ¶å±‚æä¾›ç»™è½¬å‘å±‚çš„æ¥å£ã€‚</p><h4 id="SDN-äº¤æ¢æœº"><a href="#SDN-äº¤æ¢æœº" class="headerlink" title="SDN äº¤æ¢æœº"></a>SDN äº¤æ¢æœº</h4><p>äº¤æ¢æœºå±äºè½¬å‘å±‚ï¼Œè´Ÿè´£å…·ä½“æ•°æ®è½¬å‘å¤„ç†çš„è®¾å¤‡ã€‚</p><blockquote><p>å…¶å·¥ä½œåŸç†éƒ½æ˜¯åœ¨æ”¶åˆ°æ•°æ®åŒ…æ—¶ï¼Œå°†æ•°æ®åŒ…ä¸­çš„æŸäº›ç‰¹å¾åŸŸä¸è®¾å¤‡è‡ªèº«å­˜å‚¨çš„ä¸€äº›è¡¨é¡¹è¿›è¡Œæ¯”å¯¹ï¼Œå½“å‘ç°åŒ¹é…æ—¶åˆ™æŒ‰ç…§è¡¨é¡¹çš„è¦æ±‚è¿›è¡Œç›¸åº”å¤„ç†ã€‚</p></blockquote><p>è¨€è€Œè¨€ä¹‹äº¤æ¢æœºçš„å·¥ä½œå°±æ˜¯å¯¹æ•°æ®åŒ…è¿›è¡ŒåŒ¹é…å’Œå¤„ç†ï¼Œä½†åŒ¹é…å’Œå¤„ç†çš„å®šä¹‰å¹¶éåœ¨äº¤æ¢æœºä¸­å®ç°ï¼Œè€Œæ˜¯ç”±æ§åˆ¶å™¨ç»Ÿä¸€ä¸‹å‘ï¼Œç»Ÿç§°<strong>æµè¡¨</strong>ã€‚ç®€è¦ä»‹ç»ä¸€ä¸‹OpenFlowæµè¡¨çš„ç»„æˆ: åŒ…å¤´åŸŸ + è®¡æ•°å™¨ + åŠ¨ä½œï¼ŒåŒ…å¤´åŸŸåŒ…æ‹¬ä¸€ç³»åˆ—è¿›è¡ŒåŒ¹é…çš„å‚æ•°ï¼Œå¦‚å…¥ç«¯å£ã€æºMACåœ°å€ï¼Œç›®çš„MACåœ°å€ç­‰ï¼Œè®¡æ•°å™¨åˆ™ç”¨äºç»Ÿè®¡æ•°æ®æµé‡çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŠ¨ä½œç”¨äºæŒ‡ç¤ºäº¤æ¢æœºç»åŒ¹é…åçš„æ•°æ®åŒ…å¦‚ä½•å¤„ç†ï¼Œå¦‚è½¬å‘ã€‚</p><h4 id="å—å‘æ¥å£"><a href="#å—å‘æ¥å£" class="headerlink" title="å—å‘æ¥å£"></a>å—å‘æ¥å£</h4><blockquote><p>SDNäº¤æ¢æœºéœ€è¦åœ¨è¿œç¨‹æ§åˆ¶å™¨çš„ç®¡æ§ä¸‹å·¥ä½œï¼Œä¸ä¹‹ç›¸å…³çš„è®¾å¤‡çŠ¶æ€å’Œæ§åˆ¶æŒ‡ä»¤éƒ½éœ€è¦ç»ç”±SDNçš„å—å‘æ¥å£ä¼ è¾¾ã€‚å½“å‰ï¼Œæœ€çŸ¥åçš„å—å‘æ¥å£è«è¿‡äºONFå€¡å¯¼çš„OpenFlowåè®®ã€‚</p></blockquote><h4 id="åŒ—å‘æ¥å£"><a href="#åŒ—å‘æ¥å£" class="headerlink" title="åŒ—å‘æ¥å£"></a>åŒ—å‘æ¥å£</h4><blockquote><p>SDNåŒ—å‘æ¥å£æ˜¯é€šè¿‡æ§åˆ¶å™¨å‘ä¸Šå±‚ä¸šåŠ¡åº”ç”¨å¼€æ”¾çš„æ¥å£ï¼Œå…¶ç›®æ ‡æ˜¯ä½¿å¾—ä¸šåŠ¡åº”ç”¨èƒ½å¤Ÿä¾¿åˆ©åœ°è°ƒç”¨åº•å±‚çš„ç½‘ç»œèµ„æºå’Œèƒ½åŠ›ã€‚</p></blockquote><blockquote><p>ä¾‹å¦‚REST APIå°±æ˜¯ä¸Šå±‚ä¸šåŠ¡åº”ç”¨çš„å¼€å‘è€…æ¯”è¾ƒå–œæ¬¢çš„æ¥å£å½¢å¼</p></blockquote><p>ä¸Šé¢çš„æ¦‚å¿µä¸‹é¢å°†è¿›ä¸€æ­¥è®¨è®ºï¼Œä½†ä¸»è¦è®°å½•çš„æ˜¯Builderè®¾è®¡æ¨¡å¼çš„æ˜“ç”¨æ€§å’Œä¸å¯å˜å¯¹è±¡çš„production(Buidlerå’Œproductionéƒ½æ˜¯è®¾è®¡æ¨¡å¼ï¼‰ï¼Œproductionçš„å¯¹è±¡çš„ä½¿ç”¨ï¼Œä»£æ›¿äº†å¼ºåˆ¶ç±»å‹å®‰å…¨ç¼–ç çš„åŸå§‹ç±»å‹ï¼Œå¹¶ä¸”äº§ç”Ÿçš„æ˜¯æ›´å¤šçš„å¯è¯»æ€§ä»£ç ï¼Œå†…ç½®çš„é€šé…å½¢å¼ï¼Œä»¥åŠæœ€åæ²¡æœ‰å¿…è¦å»å¤„ç†æ¶ˆæ¯çš„é•¿åº¦ã€‚(è¿™æ®µè¯çš„å¯¹æ¯”æ˜¯Pre-v1.0å’ŒFloodlight v1.0, v1.1, v1.2ï¼Œå¯è§readmeä¸­è¿™æ®µè¯çš„å‰é¢ä»£ç å¯¹æ¯”)</p><p>æ‰€æœ‰çš„è¿æ¥åˆ°Floodloghtçš„switcheséƒ½åŒ…å«ä¸€ä¸ªswitchæè¿°Openflowç‰ˆæœ¬çš„å·¥å‚ã€‚å¯ä»¥æœ‰å¤šç§switch,æ‰€æœ‰éƒ½æ˜¯ä¸åŒç‰ˆæœ¬çš„Openflowï¼Œåœ¨é‚£äº›swicthä¸­ï¼Œcontrollerä¼šå¹•åå¤„ç†ä½çº§åè®®å·®å¼‚ã€‚ä»æ¨¡å—å’Œåº”ç”¨å¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œswitchæ˜¯æš´éœ²å‡ºæ¥çš„IOFSwitch, IOFSwitchçš„æ–¹æ³•ä¹‹ä¸€getOFFactoryèƒ½è¿”å›OpenFlowJ-Loxiå·¥å‚ï¼Œé€‚åˆswitchæè¿°çš„OpenFlowç‰ˆæœ¬ã€‚ä¸€æ—¦ä½ æœ‰äº†æ­£ç¡®çš„å·¥å‚ï¼Œä½ å°±å¯ä»¥é€šè¿‡å…¬å…±çš„OpenFlowJ-Loxiæš´éœ²çš„APIåˆ›å»ºOpenFlowç±»å‹å’Œæ¦‚å¿µã€‚</p><p>å› æ­¤ï¼Œä½ åœ¨ç¼–å†™FlowModså’Œå…¶ä»–ç±»å‹çš„æ—¶å€™ä¸éœ€è¦åˆ‡æ¢Apiã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³æ„å»ºä¸€ä¸ªFlowModï¼Œå‘é€åˆ°ä¸€ä¸ªswitchä¸Šï¼ŒOFSwitchManagerå·²çŸ¥çš„æ¯ä¸€ä¸ªswitchéƒ½æœ‰ä¸€ä¸ªç›¸åŒç‰ˆæœ¬çš„OpenFlowå·¥å‚çš„å¼•ç”¨ã€‚è¿™ä¸ªå¼•ç”¨åœ¨äºåå•†switchå’Œcontrollerä¹‹é—´æœ€åˆçš„æ¡æ‰‹ã€‚æ•…ä¸Šè¿°æ•´ä½“è¿‡ç¨‹æ˜¯ï¼Œä»ä½ çš„switchå¼•ç”¨å·¥å‚ï¼Œåˆ›å»ºbuidlerï¼Œæ„å»ºFlowMod, å¹¶å†™åˆ°switch.å¿½ç•¥OpenFlowç‰ˆæœ¬çš„è¯ï¼Œæ‰€æœ‰OpenFlowå¯¹è±¡çš„æ„é€ å™¨æ˜¯ç›¸åŒçš„APIï¼Œä½†æ˜¯ä½ éœ€è¦çŸ¥é“ä½ å¯ä»¥ä½¿ç”¨çš„æ¯ä¸€ä¸ªOpenFlowç‰ˆæœ¬ï¼Œå¦åˆ™ï¼Œä¾‹å¦‚ä½ å‘Šè¯‰ä¸€ä¸ªOpenFlow1.0çš„switchå»æ‰§è¡Œä¸€äº›ç±»ä¼¼æ·»åŠ ç»„çš„æ“ä½œï¼Œè€Œè¿™ä¸ªæ“ä½œåœ¨1.0ä¸­å¹¶ä¸æ”¯æŒï¼ŒOpenFlowJ-Loxiåº“ä¼šä½¿ç”¨ä¸€ä¸ªUnsupportedOperationExceptionå‹å¥½æé†’ä½ ã€‚</p><p>ä»‹ç»å…¶ä»–ä¸€äº›å¾®å¦™çš„ä¸ºäº†å˜å¾—å¾ˆå¥½å˜åŒ–ã€‚ä¾‹å¦‚ï¼Œè®¸å¤šå¸¸è§çš„ç±»å‹ï¼Œå¦‚äº¤æ¢æœºäº¤æ¢æœºdatapath ids, openflow ports, ip mac åœ°å€è¢«å®šä¹‰åˆ°OpenFlowJ-Loxiåº“ä¸­ï¼Œé€šè¿‡DatapathId, OFPort, IPv4Address/IPv6Address, and MacAddressã€‚ä½ å¯ä»¥æœç´¢org.projectfloodlight.openflow.typesï¼Œèƒ½å‘ç°å¾ˆå¤šå¸¸è§çš„å¯ä»¥è¢«å®šä¹‰åˆ°å•ä¸€ä½ç½®çš„ç±»å‹ï¼Œåƒä¸Šé¢çš„buidlersä¸­çš„producedå¯¹è±¡ï¼Œæ‰€æœ‰çš„ç±»å‹éƒ½æ˜¯ä¸å¯å˜çš„ã€‚</p><p>æ›´å¤šæ–°çš„APIåœ¨Floodlight v1.2ä¸­ï¼Œå‚é˜…OpenFlowJ-Loxiæ–‡æ¡£å’Œä¾‹å­</p>]]></content>
      
      
      <categories>
          
          <category> enjoy </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>elastic_template</title>
      <link href="/2017/10/14/elastic-template/"/>
      <url>/2017/10/14/elastic-template/</url>
      
        <content type="html"><![CDATA[<h2 id="Template-json"><a href="#Template-json" class="headerlink" title="Template.json"></a>Template.json</h2><p>è¿™ä¸ªæ–‡ä»¶å³å®šä¹‰<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html" target="_blank" rel="noopener">Index Templates</a>ã€‚</p><blockquote><p>Index templates allow you to define templates that will automatically be applied when new indices are created.</p></blockquote><h3 id="ç»“æ„åˆ†æ"><a href="#ç»“æ„åˆ†æ" class="headerlink" title="ç»“æ„åˆ†æ"></a>ç»“æ„åˆ†æ</h3><h4 id="å¤–å±‚ç»“æ„ï¼š"><a href="#å¤–å±‚ç»“æ„ï¼š" class="headerlink" title="å¤–å±‚ç»“æ„ï¼š"></a>å¤–å±‚ç»“æ„ï¼š</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;template&quot;: &quot;nginx_elastic_stack_example&quot;,</span><br><span class="line">&quot;settings&quot;: &#123;&#125;</span><br><span class="line">&quot;mappings&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>template: å‡†ç¡®è¯´æ¥ï¼Œåº”è¯¥å«template patternï¼Œä¸ºèƒ½åŒ¹é…åˆ°æ¨¡æ¿çš„index name patternã€‚å¦‚ä¸‹é¢çš„ç¤ºä¾‹</p><p>//The settings and mappings will be applied to any index name that matches the te* pattern.<br>â€œtemplateâ€: â€œte*â€,</p></li><li><p>settings: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html" target="_blank" rel="noopener">å¯è®¾ç½®é¡¹</a>, å¸¸è§çš„è®¾ç½®é¡¹å¦‚</p><p>â€œsettingsâ€ : {</p><pre><code>&quot;index&quot; : {    &quot;number_of_shards&quot; : 3, //å®šä¹‰ä¸€ä¸ªç´¢å¼•çš„ä¸»åˆ†ç‰‡ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯5, è¿™ä¸ªé…ç½®åœ¨ç´¢å¼•åˆ›å»ºåä¸èƒ½ä¿®æ”¹ã€‚    &quot;number_of_replicas&quot; : 2 //æ¯ä¸ªä¸»åˆ†ç‰‡çš„å¤åˆ¶åˆ†ç‰‡ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯1ã€‚è¿™ä¸ªé…ç½®å¯ä»¥éšæ—¶åœ¨æ´»è·ƒçš„ç´¢å¼•ä¸Šä¿®æ”¹ã€‚</code></pre></li></ul>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>ä»¥ä¸Šä¹¦å†™æ ¼å¼ä¹Ÿå¯å†™æˆ</code></pre>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line">     &quot;index.number_of_shards&quot;: 3</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>  å¦å¤–ï¼Œä¸»åˆ†ç‰‡ä¸ªæ•°çš„æ„ä¹‰åœ¨äºï¼Œåˆ†ç‰‡æ˜¯å­˜å‚¨â€™ç´¢å¼•â€™ä¸‹æ–‡æ¡£çš„å®¹å™¨ï¼Œåˆ†ç‰‡çš„ä¸ªæ•°å°±å†³å®šäº†å­˜å‚¨çš„å¤§å°ã€‚</p><ul><li><p>mappings: å¯¹è¿™ä¸ªçš„è§£é‡Šå¼•ç”¨ä¸€ä¸‹åŸæ–‡æ¯”è¾ƒæ°å½“ã€‚</p><blockquote><p>Mapping is the process of defining how a document, and the fields it contains, are stored and indexed.</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">&quot;type1&quot;: &#123;  //å®šä¹‰ç±»å‹type1</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Mapping-ç»“æ„åˆ†æ"><a href="#Mapping-ç»“æ„åˆ†æ" class="headerlink" title="Mapping ç»“æ„åˆ†æ"></a>Mapping ç»“æ„åˆ†æ</h4><blockquote><p>Each index has one or more mapping types, which are used to divide the documents in an index into logical groups</p></blockquote><p>mapping typeåŒ…å«ä»¥ä¸‹å‡ é¡¹ï¼š</p><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html" target="_blank" rel="noopener">Meta-fields</a>ï¼Œæ¥è‡ªæ–‡æ¡£çš„å…ƒæ•°æ®å­—æ®µï¼Œä»¥ä¸‹åˆ’çº¿å¼€å¤´ï¼ŒåŒ…æ‹¬_index, _type, _id, _sourceç­‰..</li><li>propertiesï¼Œåˆ—å‡ºæ–‡æ¡£ä¸­å¯èƒ½åŒ…å«çš„å­—æ®µçš„æ˜ å°„</li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html" target="_blank" rel="noopener">å‚æ•°é¡¹</a>ï¼Œæ§åˆ¶å¦‚ä½•åŠ¨æ€å¤„ç†æ–°çš„å­—æ®µï¼Œå¦‚dynamic_templatesï¼Œanalyzerç­‰..</li></ul><p>å…¶ä¸­ï¼ŒFieldçš„æ•°æ®ç±»å‹å¯ä»¥ä¸ºï¼š</p><ul><li>ç®€å•æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚textï¼Œkeywordï¼Œdateï¼Œlongï¼Œdoubleï¼Œbooleanï¼Œip..å…¶ä¸­ï¼Œkeywordå’Œtextçš„åŒºåˆ«å¯¹åº”çš„æ˜¯index explicitå’Œindex full text contentã€‚</li><li>åµŒå¥—çš„å¯¹è±¡æˆ–<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" target="_blank" rel="noopener">nested</a></li><li>ç‰¹åˆ«çš„ç±»å‹ï¼Œä¾‹å¦‚<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" target="_blank" rel="noopener">geo_point</a>ï¼Œ<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html" target="_blank" rel="noopener">geo_shape</a>ï¼Œ <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html" target="_blank" rel="noopener">completion</a>ã€‚</li></ul><h5 id="Dynamic-Mapping"><a href="#Dynamic-Mapping" class="headerlink" title="Dynamic Mapping"></a>Dynamic Mapping</h5><p>ä½ å¯ä»¥ä¸ç”¨å®šä¹‰mapping,fieldsï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨esçš„searchï¼Œè¿™éƒ½å½’åŠŸäºçš„dynamic mappingã€‚dynamic mappingåŒ…æ‹¬_default_mappingï¼Œ Dynamic field mappingsï¼ŒDynamic templatesã€‚<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html" target="_blank" rel="noopener">å…ˆç²˜å®˜æ–¹é“¾æ¥å§</a></p><ul><li><p>_default_mapping:</p><blockquote><p>The default mapping, which will be used as the base mapping for any new mapping types, can be customised by adding a mapping type with the name _default_ to an indexï¼Œ</p></blockquote><p>å¦‚ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_default_&quot;: &#123;  </span><br><span class="line">      &quot;_all&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;user&quot;: &#123;&#125;, //userç»§æ‰¿è‡ª_default_</span><br><span class="line">    &quot;blogpost&quot;: &#123;  //blogpostç»§æ‰¿è‡ª_default_å¹¶é‡å†™äº†&quot;_all&quot;</span><br><span class="line">      &quot;_all&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>Dynamic field mappings: ä¸€èˆ¬è¯´æ¥ï¼Œå½“æ–‡æ¡£ä¸­å‡ºç°ä¹‹å‰æœªè§è¿‡çš„fieldï¼Œesä¼šè‡ªåŠ¨æ·»åŠ æ–°fieldåˆ°æ˜ å°„ä¸­ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥é€šè¿‡è®¾ç½®è¿›è¡Œdisableï¼Œåœ¨è¿™ä¸ªåŠŸèƒ½æ˜¯enabledçš„å‰æä¸‹ï¼Œesæ·»åŠ æ–°fieldæ—¶ä¼šè½¬æ¢ç±»å‹ï¼Œç”±jsonçš„æ•°æ®ç±»å‹è½¬æ¢åˆ°esçš„æ•°æ®ç±»å‹ï¼Œå¦‚stringâ€“&gt;textæˆ–keywordã€‚å…¶ä¸­ï¼Œæœ‰çš„å¤æ‚ç±»å‹çš„æ£€æµ‹ï¼Œå¯ä»¥è‡ªå®šä¹‰æ£€æµ‹æ ¼å¼ï¼Œä¾‹å¦‚è‡ªå®šä¹‰dateçš„æ•°æ®æ ¼å¼ã€‚å®˜æ–¹æœ‰<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html" target="_blank" rel="noopener">ç¤ºä¾‹</a>ã€‚</p></li><li><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html#dynamic-templates" target="_blank" rel="noopener">Dynamic templates</a>: è¿™ä¸ªé‡åœ¨ä½¿ç”¨ï¼Œæ•…ç›´æ¥è´´ä¸Šäº†é“¾æ¥ï¼Œå®˜æ–¹æœ‰ç¤ºä¾‹ä½¿ç”¨è¯´æ˜ã€‚ä¸Šæ–‡æåˆ°esè‡ªåŠ¨æ·»åŠ æ–°fieldåˆ°æ˜ å°„ä¸­ï¼Œdynamic templatesä¸ºå®šä¹‰ä¸€äº›æ·»åŠ æ¨¡æ¿ï¼Œæ—¢ç„¶æ˜¯æ¨¡æ¿ï¼Œå°±è¦å®šä¹‰åŒ¹é…æ¨¡æ¿çš„ä¸œè¥¿..ä¾‹å¦‚match_mapping_typeä¸ºæŒ‡å®šæ•°æ®ç±»å‹ï¼Œä»¥åŠé€šè¿‡field nameè¿›è¡Œå…¨åŒ¹é…æˆ–æ­£åˆ™åŒ¹é…æˆ–å…¨è™šæ‹Ÿè·¯å¾„åŒ¹é…(å¦‚a.b.*)ï¼Œç„¶åå†åŠ ä¸Šmappingå†³å®šæ·»åŠ çš„æ–°çš„fieldçš„ç‰¹æ€§ã€‚</p></li></ul><h3 id="å‚æ•°å­—æ®µåˆ†æ"><a href="#å‚æ•°å­—æ®µåˆ†æ" class="headerlink" title="å‚æ•°å­—æ®µåˆ†æ"></a>å‚æ•°å­—æ®µåˆ†æ</h3><p>å¾…å®Œå–„è¡¥å…¨.. æš‚ä¸”åˆ—å‡ºç°è¿‡çš„..</p><h4 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h4><ul><li><p>fields: é€‚ç”¨äºå½“ä¸€ä¸ªå­—æ®µæœ‰å¤šç§ç±»å‹ï¼Œå¦‚å½“æœç´¢æ—¶ï¼Œå¸Œæœ›å®ƒæ˜¯ä¸€ä¸ªtextï¼Œå½“æ’åºæˆ–è€…èšåˆæ—¶ï¼Œå¸Œæœ›å®ƒæ˜¯ä¸€ä¸ªkeywordã€‚</p><p>â€œcityâ€: {</p><pre><code>  &quot;type&quot;: &quot;text&quot;,  &quot;fields&quot;: {    &quot;raw&quot;: {      &quot;type&quot;:  &quot;keyword&quot;    }  }}</code></pre></li></ul>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//ç”¨äºæœç´¢æ—¶ä½¿ç”¨city,æ’åºæˆ–èšåˆæ—¶ä½¿ç”¨city.raw,</span><br><span class="line"> &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;Cities&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;city.raw&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>norms: è€—å†…å­˜ï¼Œå¦‚æœä¸å…³å¿ƒscoreï¼Œå°±ç½®ä¸ºfalseï¼Œå°¤å…¶æ˜¯å­—æ®µä»…ä»…ç”¨äºfilteræˆ–aggregation</li></ul><blockquote><p>Norms store various normalization factors that are later used at query time in order to compute the score of a document relatively to a query.</p></blockquote><ul><li>index: å†³å®šfieldçš„valueçš„indexæ–¹å¼ï¼Œå€¼ä¸ºanalyzed(default, treat as full-text field), not_analyzed (treat as keyword field), noã€‚</li><li>ignore_above: Strings longer than the ignore_above setting will not be indexed or stored.</li><li>_all: å°†æ‰€æœ‰valuesçš„å†…å®¹ä»¥ç©ºæ ¼è¿›è¡Œå­˜å‚¨ï¼Œå³_allçš„å†…å®¹å¤§æ¦‚ä¸º[â€œ..â€, â€œ..â€],å¯è¿›è¡Œåˆ†æå’Œç´¢å¼•ï¼Œä½†ä¸èƒ½å­˜å‚¨ã€‚</li><li>dynamicï¼šæ§åˆ¶æ–°å­—æ®µæ˜¯å¦è¢«åŠ¨æ€æ·»åŠ ï¼Œæ‰€è°“æ–°å­—æ®µï¼Œæ˜¯è¾ƒä¹‹å‰æ¶ˆæ¯ç»„æˆçš„å­—æ®µè€Œè¨€ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>elastic_painless</title>
      <link href="/2017/10/14/elastic-painless/"/>
      <url>/2017/10/14/elastic-painless/</url>
      
        <content type="html"><![CDATA[<h2 id="Painless"><a href="#Painless" class="headerlink" title="Painless"></a>Painless</h2><blockquote><p>Painless is a scripting language developed and maintained by Elastic and optimized for Elasticsearch.</p></blockquote><h3 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h3><ul><li><p>def</p><p>åŠ¨æ€æ•°æ®ç±»å‹ï¼Œé»˜è®¤å€¼ä¸ºnullã€‚</p></li><li><p>å…¶ä½™çš„æ•°æ®ç±»å‹ï¼Œå’ŒjavaåŸºæœ¬ç›¸åŒã€‚åŸºæœ¬æ•°æ®ç±»å‹éƒ½æœ‰ï¼Œå¯¹è±¡ç±»å‹çš„ï¼ŒMap,Listä¹Ÿéƒ½æœ‰ã€‚åŸºæœ¬apiä¹Ÿéƒ½æ˜¯javaç›¸åº”çš„api</p></li></ul><p>è·ŸJavaçš„å…³ç³»ã€‚ï¼ˆJava8ï¼‰</p><blockquote><p>Extends Javaâ€™s syntax to provide Groovy-style scripting language features that make scripts easier to write.</p></blockquote><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><ul><li><p>éå†æ•°ç»„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for(def item :  doc[&apos;cmd&apos;].values) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•°æ®å–å‡ºæ¥æ˜¯ä¸ªå¯¹è±¡ï¼Œå¦‚doc[â€˜cmdâ€™],éœ€è¦å–ç›¸åº”çš„å€¼éœ€è¦è°ƒç”¨å¯¹åº”å±æ€§ï¼Œæ•°ç»„çš„è¯åˆ™æ˜¯values,æ•°å€¼çš„è¯value,æ—¥æœŸç±»çš„è¯date</p></li><li><p>dateç±»å‹æ“ä½œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return doc[&apos;begin_at&apos;].date.hourOfDay</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªdateçš„ç±»å‹å¯¹åº”åˆ°javaé‡Œå…·ä½“æ˜¯å•¥.æ²¡ææ¸…æ¥š.æœ‰ç‚¹åƒCalenderçš„å˜ä½“ï¼ŒCalendarèƒ½è·å¾—çš„å±æ€§éƒ½æœ‰</p></li></ul><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>å…³äºè°ƒè¯•ï¼Œä¸€ç›´æ˜¯æˆ‘å¾ˆåœ¨æ„åˆæ— å¥ˆçš„äº‹ã€‚</p><p>Kibanaæ·»åŠ script fieldsçš„è¯ï¼Œä½¿ç”¨Dev Toolså…ˆè¿›è¡Œscriptçš„éªŒè¯ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¯­æ³•é”™ä¹‹ç±»çš„ï¼ŒæˆåŠŸä¹‹åå†æŠŠsciptéƒ¨åˆ†ç²˜è´´è¿›å»ã€‚ç®€å•çš„è½¬æ¢ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;script_fields&quot;: &#123;</span><br><span class="line">    &quot;test_script&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &#123;</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;inline&quot;: &quot;return doc[&apos;begin_at&apos;].date.hourOfDay&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®˜æ–¹è¯´æ˜çš„è°ƒè¯•æ˜¯Debug.explain</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /hockey/player/1?refresh</span><br><span class="line">&#123;&quot;first&quot;:&quot;johnny&quot;,&quot;last&quot;:&quot;gaudreau&quot;,&quot;goals&quot;:[9,27,1],&quot;assists&quot;:[17,46,0],&quot;gp&quot;:[26,82,1]&#125;</span><br><span class="line"></span><br><span class="line">POST /hockey/player/1/_explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;script&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &quot;Debug.explain(doc.goals)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>by responding</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;error&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;script_exception&quot;,</span><br><span class="line">      &quot;to_string&quot;: &quot;[1, 9, 27]&quot;,</span><br><span class="line">      &quot;painless_class&quot;: &quot;org.elasticsearch.index.fielddata.ScriptDocValues.Longs&quot;,</span><br><span class="line">      &quot;java_class&quot;: &quot;org.elasticsearch.index.fielddata.ScriptDocValues$Longs&quot;,</span><br><span class="line">      ...</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;status&quot;: 500</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>elastic_logstash</title>
      <link href="/2017/10/14/elastic-logstash/"/>
      <url>/2017/10/14/elastic-logstash/</url>
      
        <content type="html"><![CDATA[<h2 id="logstash-config"><a href="#logstash-config" class="headerlink" title="logstash_config"></a>logstash_config</h2><p>ç»„æˆéƒ¨åˆ†ä¸ºï¼š input, filter, output<br><a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" target="_blank" rel="noopener">æ–‡æ¡£ä»‹ç»</a></p><h3 id="value"><a href="#value" class="headerlink" title="value"></a>value</h3><blockquote><p>A plugin can require that the value for a setting be a certain type, such as boolean, list, or hash.</p></blockquote><ul><li><p>Array</p><p>users =&gt; [ {id =&gt; 1, name =&gt; bob}, {id =&gt; 2, name =&gt; jane} ]</p></li><li><p>Lists</p><p>path =&gt; [ â€œ/var/log/messagesâ€, â€œ/var/log/*.logâ€ ]</p><pre><code>uris =&gt; [ &quot;http://elastic.co&quot;, &quot;http://example.net&quot; ]</code></pre></li><li><p>Boolean</p><p>ssl_enable =&gt; true</p></li><li><p>Bytes</p><p>my_bytes =&gt; â€œ1113â€   # 1113 bytes</p><pre><code>my_bytes =&gt; &quot;10MiB&quot;  # 10485760 bytesmy_bytes =&gt; &quot;100kib&quot; # 102400 bytesmy_bytes =&gt; &quot;180 mb&quot; # 180000000 bytes</code></pre></li><li><p>Codec</p><p>codec =&gt; â€œjsonâ€</p><pre><code>//æ›´å¤šç±»å‹https://www.elastic.co/guide/en/logstash/current/codec-plugins.html</code></pre></li><li><p>Hash</p><p>match =&gt; {</p><pre><code>  &quot;field1&quot; =&gt; &quot;value1&quot;  &quot;field2&quot; =&gt; &quot;value2&quot;  ...}</code></pre></li><li><p>Number</p><p>port =&gt; 33</p></li><li><p>Password</p><p>my_password =&gt; â€œpasswordâ€</p></li><li><p>URI</p><p>my_uri =&gt; â€œ<a href="http://foo:bar@example.net&quot;" target="_blank" rel="noopener">http://foo:bar@example.net&quot;</a></p></li><li><p>Path</p><p>my_path =&gt; â€œ/tmp/logstashâ€</p></li><li><p>String</p><p>name =&gt; â€œHello worldâ€</p><pre><code>name =&gt; &apos;It\&apos;s a beautiful day&apos;</code></pre></li><li><p>Comments</p><h1 id="this-is-a-comment"><a href="#this-is-a-comment" class="headerlink" title="this is a comment"></a>this is a comment</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input &#123; # comments can appear at the end of a line, too</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><ul><li><p>mutate</p><p>mutate { replace =&gt; { â€œtypeâ€ =&gt; â€œfile_testâ€ } }</p></li><li><p>grok</p><blockquote><p>Parses unstructured event data into fields</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grok &#123;</span><br><span class="line">  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns">patternsçš„é›†åˆ</a></p></li><li><p>date</p><p>date {</p><pre><code>      match =&gt; [ &quot;timestamp&quot; , &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ]}</code></pre></li></ul><ul><li><p>json</p><blockquote><p>Parses JSON events</p></blockquote></li></ul><h5 id="drop-example"><a href="#drop-example" class="headerlink" title="drop example:"></a>drop example:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">            match =&gt; [&quot;message&quot;,&quot;%&#123;TIMESTAMP_ISO8601:logtime&#125; \[%&#123;NUMBER&#125;\] \(\(%&#123;WORD&#125;\)\) %&#123;WORD:loglevel&#125; %&#123;GREEDYDATA:other&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if [loglevel]!= &quot;ERROR&quot; &#123;</span><br><span class="line">            drop &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><p><a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html" target="_blank" rel="noopener">file</a></p><h3 id="output"><a href="#output" class="headerlink" title="output"></a>output</h3><h3 id="filter-1"><a href="#filter-1" class="headerlink" title="filter"></a>filter</h3><ul><li><p>grok</p><pre><code> æ¶ˆæ¯è§£æï¼Œæ¶ˆæ¯ä»¥æŒ‰è¡Œä¸ºå•ä½è¿›è¡Œè§£æã€‚åŸºæœ¬æ ¼å¼ä¸º   grok {match =&gt; { &quot;message&quot; =&gt; &quot;%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}&quot; }  }</code></pre></li></ul><blockquote><p>Grok sits on top of regular expressions, so any regular expressions are valid in grok as well.</p></blockquote><p>   å…¶ä¸­ï¼Œå¯å°†æ­£åˆ™ç»„æˆpatternï¼Œå¦‚â€%{IP:client}â€ IPä¸ºpatternçš„ç±»å‹, clientä¸ºå˜é‡åï¼Œè§£æå‡ºæ¥çš„å˜é‡å¦‚clientå¯åœ¨åé¢è¿›è¡Œä½¿ç”¨ã€‚<br>   <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html#_custom_patterns" target="_blank" rel="noopener">è‡ªå®šä¹‰pattern</a>,æ€»ç»“æ–¹å¼å°±æ˜¯åœ¨æŸæ–‡ä»¶ä¸‹åˆ›å»ºpatternè§£ææ–¹å¼ï¼Œå¦‚</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> # contents of ./patterns/extra:</span><br><span class="line">JAVA_CLASS ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*</span><br></pre></td></tr></table></figure><p>å†åœ¨grokä¸­å¢åŠ å­—æ®µpatterns_dirï¼Œpatterns_dirä¸ºæ–‡ä»¶å¤¹ï¼Œéæ–‡ä»¶ã€‚å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  grok &#123;</span><br><span class="line">  patterns_dir =&gt; [&quot;/Users/xiaoxuez/Library/apache/logstash-5.4.2/patterns&quot;]</span><br><span class="line">  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:timestamp&#125; %&#123;JAVA_CLASS:producer&#125; %&#123;WORD:printer&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹    </p><h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><p> configä¸­è¿˜å¯ä»¥ä½¿ç”¨<a href>ifæ¡ä»¶è¯­å¥</a>ï¼Œå¦‚  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line"> ...</span><br><span class="line"> if ([producer] =~ /[m].*/) &#123;</span><br><span class="line"> # do ..</span><br><span class="line">&#125; else &#123;</span><br><span class="line"> drop &#123; &#125;  #è¯¥æ¡æ¶ˆæ¯ä¸¢æ‰ ä¸è¿›å…¥output</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>   }</p><h1 id="ä¸ºæ­£åˆ™åŒ¹é…è¿ç®—ç¬¦ï¼Œ"><a href="#ä¸ºæ­£åˆ™åŒ¹é…è¿ç®—ç¬¦ï¼Œ" class="headerlink" title="=~  ä¸ºæ­£åˆ™åŒ¹é…è¿ç®—ç¬¦ï¼Œ"></a>=~  ä¸ºæ­£åˆ™åŒ¹é…è¿ç®—ç¬¦ï¼Œ</h1><h2 id="EXAMPLE"><a href="#EXAMPLE" class="headerlink" title="EXAMPLE"></a>EXAMPLE</h2><p>fileä½¿ç”¨æ­£åˆ™åŒ¹é…</p><pre><code>path =&gt; &quot;/var/log/%{type}.%{+yyyy.MM.dd.HH}&quot;</code></pre><p>ä½¿ç”¨å˜é‡ç”¨[]ï¼Œå¦‚[path]</p><h1 id="a-zA-Z-a-zA-Z-æ­£åˆ™åŒ¹é…ç±»å"><a href="#a-zA-Z-a-zA-Z-æ­£åˆ™åŒ¹é…ç±»å" class="headerlink" title="([a-zA-Z]+[.][a-zA-Z]+)[.].  æ­£åˆ™åŒ¹é…ç±»å"></a>([a-zA-Z]+[.][a-zA-Z]+)[.]<em>.</em>  æ­£åˆ™åŒ¹é…ç±»å</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">json&#123;</span><br><span class="line">     source =&gt; &quot;content&quot;</span><br><span class="line">     target =&gt; &quot;content&quot;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> mutate &#123;</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">          &quot;event_type&quot; =&gt; &quot;%&#123;[jsoncontent][type]&#125;&quot;</span><br><span class="line">          &quot;event_msg&quot; =&gt; &quot;%&#123;[jsoncontent][event]&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>â€‹<br>â€‹<br>â€‹    </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  #æ§åˆ¶æ‰“å°çš„</span><br><span class="line">if ([producer] == &quot;STUDIO&quot; ) &#123;</span><br><span class="line">    mutate &#123; replace =&gt; &#123; &quot;type&quot; =&gt; &quot;System_Airguru_Log&quot; &#125; &#125;</span><br><span class="line">&#125; else if ([producer] =~ /[m].*/) &#123;</span><br><span class="line">    json&#123;</span><br><span class="line">          source =&gt; &quot;content&quot;</span><br><span class="line">          target =&gt; &quot;jsoncontent&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      replace =&gt; &#123; &quot;type&quot; =&gt; &quot;Stratege_Airguru_Log&quot; &#125;</span><br><span class="line">      add_field =&gt; &#123;</span><br></pre></td></tr></table></figure><pre><code>                 &quot;event_type&quot; =&gt; &quot;%{[jsoncontent][type]}&quot;                 &quot;event_msg&quot; =&gt; &quot;%{[jsoncontent][event]}&quot;               }      }} else {  drop { }}        </code></pre><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><h4 id="filter-aggregate"><a href="#filter-aggregate" class="headerlink" title="filter-aggregate"></a>filter-aggregate</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; &quot;$&#123;PROJECT&#125;/logs/**/**/worker.log&quot;</span><br><span class="line">    start_position =&gt; &quot;beginning&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">#  if [path] =~ &quot;.log&quot; &#123;</span><br><span class="line">    #æ¶ˆæ¯è§£æï¼Œ</span><br><span class="line">    grok &#123;</span><br><span class="line">id =&gt; &quot;storm_log_filter&quot;</span><br><span class="line">      patterns_dir =&gt; [&quot;$&#123;PROJECT&#125;/patterns&quot;]</span><br><span class="line">      #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;GREEDYDATA:unknow&#125;&quot; &#125;</span><br><span class="line">      #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:time&#125; %&#123;JAVA_CLASS:producer&#125; %&#123;WORD:printer&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class="line">      match =&gt; &#123; &quot;path&quot; =&gt; &quot;.*/%&#123;WORD:topology&#125;\-%&#123;JUST_NUMBER:order&#125;\-%&#123;JUST_NUMBER:submittime&#125;/[0-9]+/worker.log&quot; &#125;</span><br><span class="line">      break_on_match =&gt; false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    aggregate &#123;</span><br><span class="line">     task_id =&gt; &quot;%&#123;topology&#125;-%&#123;order&#125;-%&#123;submittime&#125;&quot;</span><br><span class="line">     code =&gt; &quot;map[&apos;counts&apos;] ||= 0; map[&apos;counts&apos;] += 1;&quot;</span><br><span class="line">     push_map_as_event_on_timeout =&gt; true</span><br><span class="line">     timeout_task_id_field =&gt; &quot;topology_file&quot;</span><br><span class="line">     timeout =&gt; 360 # 10 minutes timeout</span><br><span class="line">     timeout_tags =&gt; [&apos;_aggregatetimeout&apos;]</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>â€‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="filter-basic-grok"><a href="#filter-basic-grok" class="headerlink" title="filter-basic-grok"></a>filter-basic-grok</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; &quot;/Users/xiaoxuez/Library/apache/logstash-5.4.2/test/file_test_log.log&quot;</span><br><span class="line">    start_position =&gt; &quot;beginning&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  if [path] =~ &quot;.log&quot; &#123;</span><br><span class="line">    #æ¶ˆæ¯è§£æï¼Œ</span><br><span class="line">    grok &#123;</span><br><span class="line">      match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TOMCAT_DATESTAMP:time&#125; %&#123;JAVACLASS:producer&#125; %&#123;WORD&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class="line">      break_on_match =&gt; false</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>â€‹<br>â€‹<br>â€‹<br>â€‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  # if ([producer] !~ /[m].*/ or &quot;_grokparsefailure&quot; in [tags]) &#123;</span><br><span class="line">    # drop &#123; &#125;</span><br><span class="line">#  &#125;</span><br><span class="line"></span><br><span class="line">  mutate &#123;</span><br><span class="line">    #  remove_field =&gt; [&quot;message&quot;]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>â€‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  #elasticsearch &#123;</span><br><span class="line">  #  hosts =&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">  #&#125;</span><br><span class="line">  #è¾“å‡ºåˆ° stdout#</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h2><ul><li><p>è°ƒå¼è¿‡ç¨‹ä¸­å‡ºç°è§£ææ–‡ä»¶æ²¡æŠ¥é”™ä¹Ÿæ²¡ä»»ä½•çš„ä¸œè¥¿â€¦</p><p>logstashä¼šç›‘å¬æ–‡ä»¶è¯»å–ä¿¡æ¯è®°å½•çš„ä½ç½®,æ‰€ä»¥è§£æè¿‡çš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–(æš‚ä¸”è¯´æ˜¯å†…å®¹å§ï¼Œå¯èƒ½logstashåªèƒ½ç›‘å¬ä½ç½®æ”¹å˜è€Œä¸èƒ½è¯†åˆ«ä¹‹å‰å†…å®¹æœ‰æ‰€æ”¹å˜ï¼Œè¿™ä¸ªæˆ‘è¿˜æœªéªŒè¯è¿‡..),é‚£ä¹ˆå†æ¬¡è§£æçš„è¯ï¼Œå°†ä¸ä¼šè§£æä»¥å‰è§£æè¿‡çš„å†…å®¹ã€‚è§£å†³æ–¹å¼æ˜¯å°†ç›‘å¬çš„è®°å½•åˆ æ‰ï¼Œè®°å½•å­˜åœ¨äº{logstash}/data/plugins/inputs/file/.sincedb*</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>kibana_plugin_development</title>
      <link href="/2017/10/14/kibana-plugin-development/"/>
      <url>/2017/10/14/kibana-plugin-development/</url>
      
        <content type="html"><![CDATA[<h2 id="Kibanaæ’ä»¶å¼€å‘æŒ‡å—"><a href="#Kibanaæ’ä»¶å¼€å‘æŒ‡å—" class="headerlink" title="Kibanaæ’ä»¶å¼€å‘æŒ‡å—"></a>Kibanaæ’ä»¶å¼€å‘æŒ‡å—</h2><p>æœ¬æ–‡æ¡£å‚è€ƒè‡ªä»¥ä¸‹èµ„æº</p><ul><li><a href="https://trumandu.gitbooks.io/kibana-plugin-development-tutorial/content/" target="_blank" rel="noopener">trumandu-tutorial</a></li><li><a href="https://www.timroes.de/2015/12/02/writing-kibana-4-plugins-basics/" target="_blank" rel="noopener">timroes.de</a></li></ul><h3 id="Kibanaå¼€å‘ç¯å¢ƒæ­å»º"><a href="#Kibanaå¼€å‘ç¯å¢ƒæ­å»º" class="headerlink" title="Kibanaå¼€å‘ç¯å¢ƒæ­å»º"></a>Kibanaå¼€å‘ç¯å¢ƒæ­å»º</h3><ul><li><p>githubä¸Šä¸‹è½½kibanaçš„æºä»£ç ï¼Œåˆ‡æ¢åˆ°å¯¹åº”ç‰ˆæœ¬ï¼Œkibanaçš„ç‰ˆæœ¬å¾ˆé‡è¦ï¼Œkibanaåœ¨å‡çº§çš„è¿‡ç¨‹ä¸­apiæœ‰å¯èƒ½ä¼šå˜åŒ–ï¼Œæ‰€ä»¥æ’ä»¶çš„å¼€å‘éœ€è¦é’ˆå¯¹ç‰¹å®šçš„ç‰ˆæœ¬ï¼Œkibanaå¤šç‰ˆæœ¬çš„è¯ï¼Œæ’ä»¶ä¹Ÿéœ€è¦å¤šç‰ˆæœ¬ã€‚ï¼ˆæœ¬æ–‡å…¨å±€å˜é‡kibanaæ˜¯5.3.4ç‰ˆæœ¬ï¼‰ã€‚</p></li><li><p>npm installå®‰è£…ä¾èµ–ã€‚</p><ul><li><p>å¦‚æœå…¬å¸é˜²ç«å¢™é™åˆ¶ä»githubä¸‹è½½ä¾èµ–çš„è¯ï¼Œgitä¸‹è½½çš„æ–¹å¼å°†sshæ›¿æ¢æˆhttp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git config --global url.&quot;https://&quot;.insteadOf &quot;git://&quot;</span><br><span class="line">//æˆ–è€…åœ¨.gitconfigæ–‡ä»¶ä¸­æ·»åŠ </span><br><span class="line">[url &quot;https://&quot;]</span><br><span class="line">insteadOf = git://</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¾èµ–ä¸‹è½½å¤±è´¥ï¼Œæˆ–æ¬ ç¼ºä¾èµ–ï¼Œæœ‰æç¤ºçš„è¯ï¼ŒæŒ‰ç…§æç¤ºæ¥å•ç‹¬ä¸‹è½½å°±å¥½äº†ï¼Œæ²¡æç¤ºçš„è¯ï¼Œæ„¿è°·æ­Œä¿ä½‘ä½ ã€‚</p></li></ul></li><li><p>npm start, é»˜è®¤dev å¯åŠ¨æ–¹å¼ä¼šä½¿ç”¨ssl,æ‰€ä»¥æ˜¯https,å¦‚æœéœ€è¦ä¿®æ”¹çš„è¯ï¼Œå¯ä»¥ä¿®æ”¹\kibana\src\cli\serve\serve.jsæ–‡ä»¶ã€‚ä¿®æ”¹ä½ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (opts.dev) &#123;</span><br><span class="line">    set(&apos;env&apos;, &apos;development&apos;);</span><br><span class="line">    set(&apos;optimize.lazy&apos;, true);</span><br><span class="line"></span><br><span class="line">    // if (opts.ssl) &#123;</span><br><span class="line">    //   set(&apos;server.ssl.enabled&apos;, true);</span><br><span class="line">    // &#125;</span><br><span class="line"></span><br><span class="line">    // if (opts.ssl &amp;&amp; !has(&apos;server.ssl.certificate&apos;) &amp;&amp; !has(&apos;server.ssl.key&apos;)) &#123;</span><br><span class="line">    //   set(&apos;server.ssl.certificate&apos;, DEV_SSL_CERT_PATH);</span><br><span class="line">    //   set(&apos;server.ssl.key&apos;, DEV_SSL_KEY_PATH);</span><br><span class="line">    // &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="åŠ å…¥æ’ä»¶"><a href="#åŠ å…¥æ’ä»¶" class="headerlink" title="åŠ å…¥æ’ä»¶"></a>åŠ å…¥æ’ä»¶</h3><p>å°†ä»£ç æ”¾åœ¨kibanaçš„pluginsæ–‡ä»¶å¤¹ä¸‹ï¼ŒKibanaä¼šè‡ªåŠ¨watchè¿™äº›æ–‡ä»¶çš„changesã€‚(åªèƒ½ç›´æ¥æŠŠä»£ç /æ–‡ä»¶å¤¹æ”¾è¿‡æ¥ï¼Œå¹¶ä¸èƒ½ç”¨è½¯è¿æ¥)ã€‚</p><p>å½“ä½ ä¿®æ”¹äº†ä»£ç ï¼Œkibanaä¼šè‡ªåŠ¨é‡æ–°æ‰“åŒ…ï¼Œä¼šéœ€è¦ç‚¹æ—¶é—´ï¼Œåœ¨å‘½ä»¤è¡Œçš„consoleä¸Šèƒ½å¤Ÿçœ‹åˆ°å¦‚ä¸‹æç¤º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">restarting server due to changes in</span><br><span class="line"> - &quot;installedPlugins/tr-k4p-clock/index.js&quot;</span><br><span class="line">server log [21:49:59.323] [info][status][plugin:tr-k4p-clock] Status changed from uninitialized to green - Ready</span><br><span class="line">[...]</span><br><span class="line">server log [21:49:59.421] [info][listening] Server running at http://0.0.0.0:5601</span><br><span class="line">optmzr log [21:50:07.177] [info][optimize] Lazy optimization started</span><br><span class="line">optmzr log [21:50:13.834] [info][optimize] Lazy optimization success in 6.66 seconds</span><br></pre></td></tr></table></figure><p>é‡æ–°æ‰“åŒ…åï¼Œåˆ·æ–°æµè§ˆå™¨å°±å¯ä»¥çœ‹åˆ°ä½ çš„ä¿®æ”¹äº†(å°åæ§½ï¼Œåˆ·æ–°kibanaæ˜¯ä¸ªæœ€è€—è´¹æ—¶é—´çš„æ“ä½œ)ã€‚</p><h4 id="åŸºæœ¬æ’ä»¶"><a href="#åŸºæœ¬æ’ä»¶" class="headerlink" title="åŸºæœ¬æ’ä»¶"></a>åŸºæœ¬æ’ä»¶</h4><p>æ¯ä¸ªæ’ä»¶éƒ½æ˜¯ä¸€ä¸ªnpm module,æ‰€ä»¥è‡³å°‘éœ€è¦ä¸¤ä¸ªæ–‡ä»¶ï¼Œpackage.jsonå’Œindex.jsã€‚</p><p>ä¸€ä¸ªpackage.jsonçš„ç¤ºä¾‹å¦‚ä¸‹, æœ€å¥½çš„è¯ï¼Œæ–‡ä»¶å¤¹åç§°ï¼Œnameä¿æŒä¸€è‡´ï¼Œå¦‚ä¸‹å¯ä»¥é€šè¿‡plugins/kibana_gm_cal_vis/è¿›å…¥æ–‡ä»¶å¤¹,å…·ä½“å¯è§indexç¤ºä¾‹,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;kibana_gm_cal_vis&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;0.1.0&quot;,</span><br><span class="line">  &quot;kibana&quot;: &#123;</span><br><span class="line">    &quot;version&quot;: &quot;5.3.4&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªindex.jsçš„ç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(kibana) &#123;</span><br><span class="line">  return new kibana.Plugin(&#123;</span><br><span class="line">    uiExports: &#123;</span><br><span class="line">      visTypes: [&apos;plugins/kibana_gm_cal_vis/gm_cal&apos;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ’ä»¶çš„å®‰è£…"><a href="#æ’ä»¶çš„å®‰è£…" class="headerlink" title="æ’ä»¶çš„å®‰è£…"></a>æ’ä»¶çš„å®‰è£…</h4><p>åœ¨Kibanaä¸Šå®‰è£…æ’ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kibana plugin --install plugin-name -u https://url.to/plugin</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œç›´æ¥æ”¾åœ¨pluginsæ–‡ä»¶å¤¹ä¸‹å°±å¥½äº†ã€‚</p><p>kibana-dockerçš„è¯ï¼Œå¯ä»¥æŠŠæ–‡ä»¶å¤¹æŒ‚è½½åˆ°/usr/share/kibana/plugins/plugin-nameï¼Œä½†æ’ä»¶æ›´æ–°çš„è¯éœ€è¦é‡æ–°runé‡æ–°æŒ‚è½½ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘æ“ä½œæœ‰é—®é¢˜..</p>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>kibana-plugin</title>
      <link href="/2017/10/14/kibana-plugin/"/>
      <url>/2017/10/14/kibana-plugin/</url>
      
        <content type="html"><![CDATA[<h2 id="Kibanaæ’ä»¶ç¬¬ä¸€è§†è§’"><a href="#Kibanaæ’ä»¶ç¬¬ä¸€è§†è§’" class="headerlink" title="Kibanaæ’ä»¶ç¬¬ä¸€è§†è§’"></a>Kibanaæ’ä»¶ç¬¬ä¸€è§†è§’</h2><h3 id="Kibanaæ’ä»¶å¤§æ¦‚ç±»å‹æœ‰"><a href="#Kibanaæ’ä»¶å¤§æ¦‚ç±»å‹æœ‰" class="headerlink" title="Kibanaæ’ä»¶å¤§æ¦‚ç±»å‹æœ‰"></a>Kibanaæ’ä»¶å¤§æ¦‚ç±»å‹æœ‰</h3><ul><li>visTypes è§†å›¾ç»„ä»¶ï¼ŒVisualize</li><li>app åº”ç”¨ç»„ä»¶ï¼Œå¦‚timeline</li><li>hacks, Any module that should be included in every application</li><li>chromeNavControls,</li><li><a href="https://www.elastic.co/guide/en/kibana/current/development-uiexports.html" target="_blank" rel="noopener">æ›´å¤š</a>â€¦</li></ul><h4 id="é¦–è¦ç›®æ ‡æ˜¯visTypes"><a href="#é¦–è¦ç›®æ ‡æ˜¯visTypes" class="headerlink" title="é¦–è¦ç›®æ ‡æ˜¯visTypes"></a>é¦–è¦ç›®æ ‡æ˜¯visTypes</h4><hr><h3 id="å…¨å†›å‡ºå‡»"><a href="#å…¨å†›å‡ºå‡»" class="headerlink" title="å…¨å†›å‡ºå‡»"></a>å…¨å†›å‡ºå‡»</h3><ul><li><p>git clone kibanaï¼Œåˆ‡æ¢åˆ°ä¸eså¯¹åº”çš„ç‰ˆæœ¬</p></li><li><p>npm install,</p><ul><li>gitåˆ‡æ¢ http</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global url.&quot;https://&quot;.insteadOf &quot;git://&quot;</span><br></pre></td></tr></table></figure><ul><li>chromedriverå¤±è´¥</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm ERR! chromedriver@2.32.3 install: `node install.js`</span><br></pre></td></tr></table></figure><p> è§£å†³æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install chromedriver --chromedriver_cdnurl=https://npm.taobao.org/mirrors/chromedriver</span><br></pre></td></tr></table></figure><ul><li>é»˜è®¤dev å¯åŠ¨æ–¹å¼ä¼šä½¿ç”¨ssl,æ‰€ä»¥æ˜¯https,å¦‚æœéœ€è¦ä¿®æ”¹çš„è¯ï¼Œå¯ä»¥ä¿®æ”¹\kibana\src\cli\serve\serve.jsæ–‡ä»¶ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (opts.dev) &#123;</span><br><span class="line">  set(&apos;env&apos;, &apos;development&apos;);</span><br><span class="line">  set(&apos;optimize.lazy&apos;, true);</span><br><span class="line"></span><br><span class="line">  // if (opts.ssl) &#123;</span><br><span class="line">  //   set(&apos;server.ssl.enabled&apos;, true);</span><br><span class="line">  // &#125;</span><br><span class="line"></span><br><span class="line">  // if (opts.ssl &amp;&amp; !has(&apos;server.ssl.certificate&apos;) &amp;&amp; !has(&apos;server.ssl.key&apos;)) &#123;</span><br><span class="line">  //   set(&apos;server.ssl.certificate&apos;, DEV_SSL_CERT_PATH);</span><br><span class="line">  //   set(&apos;server.ssl.key&apos;, DEV_SSL_KEY_PATH);</span><br><span class="line">  // &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>npm start</p></li></ul><h3 id="First-Blood"><a href="#First-Blood" class="headerlink" title="First Blood"></a>First Blood</h3><p>è‡ªå®šä¹‰visTypesçš„è¯ï¼Œåœ¨kibana/pluginsä¸‹æ–°å»ºæ–‡ä»¶å¤¹ï¼Œåœ¨æ–°å»ºçš„æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sao kibana-plugin</span><br></pre></td></tr></table></figure><p>å¯ç”Ÿæˆå¯¹åº”æ–‡ä»¶å¤¹æ ¼å¼ï¼Œå¦‚æœæ˜¯visTypesçš„è¯ï¼Œapp componentï¼Œtranslation filesï¼Œan hack componentï¼Œ a server APIéƒ½é€‰noå°±å¥½äº†</p><ul><li>new TemplateVisTypeå‚æ•°è§£æ</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">return new TemplateVisType(&#123;</span><br><span class="line">    name: &apos;extended_metric&apos;,</span><br><span class="line">    title: &apos;Extended Metric&apos;,</span><br><span class="line">    description: &apos;Based on the core Metric-Plugin but gives you the ability&apos; +</span><br><span class="line">      &apos;to output custom aggregates on metric-results.&apos;,</span><br><span class="line">    icon: &apos;fa-calculator&apos;,</span><br><span class="line">    template: extendedMetricVisTemplate, //è§†å›¾æ¨¡æ¿</span><br><span class="line">    params: &#123; //Optionsé€‰é¡¹</span><br><span class="line">      defaults: &#123;</span><br><span class="line">        handleNoResults: true,</span><br><span class="line">        fontSize: 60,</span><br><span class="line">        outputs: [</span><br><span class="line">          &#123;</span><br><span class="line">            formula: &apos;metrics[0].value * metrics[0].value&apos;,</span><br><span class="line">            label: &apos;Count squared&apos;,</span><br><span class="line">            enabled: true</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      editor: metricVisParamsTemplate //Optionsè§†å›¾æ¨¡æ¿</span><br><span class="line">    &#125;,</span><br><span class="line">    schemas: new Schemas([ //Dataç›¸å…³</span><br><span class="line">      &#123;</span><br><span class="line">        group: &apos;metrics&apos;,</span><br><span class="line">        name: &apos;metric&apos;,</span><br><span class="line">        title: &apos;Metric&apos;,</span><br><span class="line">        min: 1,</span><br><span class="line">        defaults: [</span><br><span class="line">          &#123; type: &apos;count&apos;, schema: &apos;metric&apos; &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ])</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­æ¥æºäº<a href="https://github.com/ommsolutions/kibana_ext_metrics_vis">åœ°å€</a>ï¼Œä¸€ä¸ªvisæ’ä»¶ã€‚</p><p>çœ‹ç€AngularJSçš„è¯­æ³•ï¼Œæˆ‘æƒ³é™é™ã€‚</p><p>ç›®å‰çœ‹èµ·æ¥ï¼ŒvisåŒ…æ‹¬ä¸»è¦çš„å†…å®¹åŒ…æ‹¬</p><ul><li>schema, ä¸ºå·¦è¾¹æ Dataéƒ¨åˆ†ï¼Œé€‰æ‹©å·²æœ‰çš„ç»„ä»¶å³å¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œmetric æ•°å€¼èšåˆè‚¯å®šæ˜¯ Y è½´ï¼›bucket èšåˆè‚¯å®šæ˜¯ X è½´ï¼›è€Œåœ¨æ­¤åŸºç¡€ä¸Šï¼ŒKibana4 è¿˜å¯ä»¥è®© bucket æœ‰ä¸åŒæ•ˆæœï¼Œä¹Ÿå°±æ˜¯ Schema é‡Œçš„ segment(é»˜è®¤), group å’Œ splitã€‚æ ¹æ®æ•ˆæœä¸åŒï¼Œè¿™é‡Œæ˜¯å„æœ‰å¢å‡çš„ï¼Œæ¯”å¦‚é¥¼å›¾å°±ä¸ä¼šæœ‰ groupã€‚</li><li>Options(params),ä¸ºå·¦è¾¹æ Optionséƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ¸²æŸ“html</li><li>æ˜¾ç¤ºå¯è§†åŒ–è§†å›¾html</li><li>controller, ä¸ºhtmlçš„é€»è¾‘éƒ¨åˆ†, V &lt;-&gt; Cæ˜¯åŒå‘ç»‘å®šçš„ã€‚</li></ul><p>å…ˆæ¢³ç†ä¸€ä¸‹éœ€æ±‚ï¼Œæœ€å¥½æ˜¯åœ¨esèšåˆæ•°æ®æ‹¿åˆ°ä¹‹åï¼Œåˆ°viewçš„é‚£å±‚ä¸­é—´å°†æ•°æ®åšä¿®æ”¹ã€‚ç„¶åæˆ‘éœ€è¦æ‰¾åˆ°æ•°æ®å¤„ç†çš„ä»£ç ã€‚æ—¢ç„¶è¿™æ ·ï¼Œå»çœ‹çœ‹åŸå§‹visç»„ä»¶å§ã€‚<a href="https://sunyonggang.gitbooks.io/elkstack-guide-cn/content/kibana/v4/source-code-analysis/visualize_app.html" target="_blank" rel="noopener">å‚è€ƒ</a></p><ul><li>src/core_plugins/kbn_vislib_vis_typesä¸‹æ–¹æ˜¯å„ç»„ä»¶çš„å®šä¹‰éƒ¨åˆ†</li><li>src/ui/public/vislibæ˜¯viså…·ä½“æ¸²æŸ“ï¼Œvisç»„ä»¶çš„controllerå’Œhtmlæ¸²æŸ“ä¸»è¦å°±æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶ä¸‹ï¼Œç„¶è€Œæˆ‘æ²¡æ‰¾åˆ°æ¯”è¾ƒæ˜æ˜¾çš„controller,æ¸²æŸ“ä¸»è¦æ˜¯d3è¿›è¡Œæ¸²æŸ“</li></ul><p>æ„Ÿè§‰å¾ˆèŒ«ç„¶..</p><p>èµ°ä¸ä¸‹å»çš„æ—¶å€™ï¼Œåˆå€’å›æ¥é‡æ–°èµ°ã€‚è§£æä¸€ä¸‹ä¸Šé¢ç²˜çš„ä»£ç ï¼Œé¦–å…ˆæ˜¯TemplateVisTypeã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">export default function TemplateVisTypeFactory(Private) &#123;</span><br><span class="line">  const VisType = Private(VisVisTypeProvider);</span><br><span class="line">  const TemplateRenderbot = Private(TemplateVisTypeTemplateRenderbotProvider);</span><br><span class="line"></span><br><span class="line">// Â·ã€‚ç¬¬ä¸€ï¼Œç»§æ‰¿VisTypeï¼Œå¢åŠ äº†templateæ£€æµ‹</span><br><span class="line">  _.class(TemplateVisType).inherits(VisType);</span><br><span class="line">  function TemplateVisType(opts = &#123;&#125;) &#123;</span><br><span class="line">    TemplateVisType.Super.call(this, opts);</span><br><span class="line"></span><br><span class="line">    this.template = opts.template;</span><br><span class="line">    if (!this.template) &#123;</span><br><span class="line">      throw new Error(&apos;Missing template for TemplateVisType&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">// Â·ã€‚ç¬¬äºŒï¼Œå¢åŠ äº†createRenderbotï¼Œä¸‹é¢ä¼šå¯¹æ¯”çœ‹çœ‹ï¼Œé‡å†™çš„æ„ä¹‰</span><br><span class="line">  TemplateVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class="line">    return new TemplateRenderbot(vis, $el, uiState);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return TemplateVisType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯çœ‹çœ‹VislibVisTypeï¼ŒåŸºæœ¬visç»§æ‰¿çš„æ˜¯è¿™ä¸ªï¼Œè·ŸTemplateVisTypeåº”è¯¥æ˜¯å·®ä¸å¤šçš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">export default function VislibVisTypeFactory(Private) &#123;</span><br><span class="line">...</span><br><span class="line">const updateParams = function (params) &#123;</span><br><span class="line">const updateIfSet = (from, to, prop, func) =&gt; &#123;</span><br><span class="line">      if (from[prop]) &#123;</span><br><span class="line">        to[prop] = func ? func(from[prop]) : from[prop];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br><span class="line">// Â·ã€‚ç¬¬ä¸€ï¼Œç»§æ‰¿VisTypeï¼Œçœ‹åˆ°responseConverteré»˜è®¤æ˜¯è½¬æ¢ä¸ºç‚¹çº¿å›¾æ•°ç»„çš„ã€‚</span><br><span class="line">_.class(VislibVisType).inherits(VisType);</span><br><span class="line">   function VislibVisType(opts = &#123;&#125;) &#123;</span><br><span class="line">     VislibVisType.Super.call(this, opts);</span><br><span class="line"></span><br><span class="line">     if (this.responseConverter == null) &#123;</span><br><span class="line">       this.responseConverter = pointSeries;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     this.listeners = opts.listeners || &#123;&#125;;</span><br><span class="line">   &#125;</span><br><span class="line">// Â·ã€‚ç¬¬äºŒï¼Œå¢åŠ äº†createRenderbot</span><br><span class="line">   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class="line">   // åœ¨è¿”å›æ–°VislibRenderbotå¯¹è±¡ä¹‹å‰ï¼Œå¯¹vis.paramsè¿›è¡Œäº†ç›¸åº”çš„è½¬æ¢å’Œåˆ¤æ–­ï¼Œæ¯”å¦‚æŠŠä¸€äº›paramsä¸‹çš„å±æ€§å¯¹åº”ç§»åˆ°params.seriesParams[0]æˆ–è€…params.valueAxes[0]ï¼Œparams.categoryAxes[0]ä¸‹</span><br><span class="line">    updateParams(vis.params);</span><br><span class="line">    return new VislibRenderbot(vis, $el, uiState);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å•¦ï¼Œå†çœ‹çœ‹ä»–ä»¬éƒ½å®ç°çš„VisTypeçš„åºå±±çœŸé¢ç›®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export default function VisTypeFactory(Private) &#123;</span><br><span class="line">  /**</span><br><span class="line">   * Provides the visualizations for the vislib ğŸ‘ˆå®˜æ–¹æ³¨é‡Šå¾ˆé‡è¦ã€‚å¤§æ¦‚æ„æ€æ˜¯è¾“å…¥å‚æ•°ä¸ºangular module,è¾“å‡ºä¸ºvisçš„class</span><br><span class="line">   *</span><br><span class="line">   * @module vislib</span><br><span class="line">   * @submodule VisTypeFactory</span><br><span class="line">   * @param Private &#123;Object&#125; Loads any function as an angular module</span><br><span class="line">   * @return &#123;Function&#125; Returns an Object of Visualization classes</span><br><span class="line">   */</span><br><span class="line">  return &#123;</span><br><span class="line">    pie: Private(VislibVisualizationsPieChartProvider),</span><br><span class="line">    point_series: Private(VislibVisualizationsPointSeriesProvider)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½ï¼Œå…¶å®ä¸€ç‚¹æ²¡çœ‹åˆ°ï¼Œæ¯”å¦‚ç»§æ‰¿é‚£ä¸ªè¯­æ³•å°±å¾ˆè’™åœˆâ€¦ä¸è¿‡æš‚æ—¶è¿è’™å¸¦çŒœçš„æ€»ç»“ä¸‹å§ã€‚å°±æ˜¯è®²ä¸€ä¸ªangular moduleæåˆ°visçš„classçš„è¿‡ç¨‹ã€‚å…·ä½“æ˜¯æ€ä¹ˆæçš„ï¼Œå¯èƒ½ä¸€ä¼šä¼šçœ‹åˆ°ï¼Œå¯èƒ½ä¸ä¼šã€‚æ¥ä¸‹æ¥çœ‹çœ‹VislibRenderbotçš„ä»£ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//å…·ä½“å°±ä¸è´´äº†ï¼Œä¸»è¦å®šä¹‰äº†å‡ ä¸ªç±»ä¼¼ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ï¼Œå¦‚</span><br><span class="line">VislibRenderbot.prototype._createVis</span><br><span class="line">VislibRenderbot.prototype._getVislibParams</span><br><span class="line">VislibRenderbot.prototype.destroy</span><br><span class="line">VislibRenderbot.prototype.updateParams</span><br><span class="line">//çœ‹åˆ°renderæ–¹æ³•äº†ï¼Œè´´ä¸€ä¸‹å…·ä½“çš„ä»£ç ï¼Œçœ‹èµ·æ¥é‡è¦çš„æ˜¯ï¼ŒbuildChartDataæ–¹æ³•å’ŒvislibViså¯¹è±¡</span><br><span class="line">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class="line">    this.chartData = this.buildChartData(esResponse);</span><br><span class="line">    return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class="line">      this.vislibVis.render(this.chartData, this.uiState);</span><br><span class="line">      this.refreshLegend++;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>å¥½å§..å†å¾€ä¸‹è¿½ï¼Œå¾ˆå¤šå¾ˆå¤š..å°±ä¸æŒ¨ç€è§£é‡Šäº†ï¼Œå¤§æ¦‚è¯´ä¸€ä¸‹ï¼ŒvislibVisç±»ä¸­ä¸»è¦æ˜¯é€‰æ‹©å’Œç»˜åˆ¶å›¾ã€‚åœ¨src/ui/visualizationä¸‹æ˜¯å„ä¸ªç»„ä»¶ç¡®åˆ‡çš„ç»˜å›¾ä»£ç ï¼Œä»–ä»¬éƒ½ç»§æ‰¿è‡ª_chart.js,åœ¨_chart.jsä¸­çœ‹åˆ°renderæ–¹æ³•è°ƒç”¨è‡ªèº«drawæ–¹æ³•ï¼Œæ•…å®ç°_chartçš„ç±»å®ç°drawæ–¹æ³•å³å¯ã€‚å¥½å•¦ï¼Œæºç åˆ†æåœ¨è¿™é‡Œå°±å·®ä¸å¤šäº†ï¼Œå…¶å®è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°è‡ªå·±æƒ³æ‰¾çš„ä¸œè¥¿ã€‚è¿™ä¸ªæ—¶å€™åœ¨githubä¸Šçœ‹åˆ°äº†å¦ä¸€ä¸ªvisçš„æ’ä»¶ã€‚</p><p>Visç±»ä¸­æ˜¯æ¸²æŸ“äº†ï¼Œç„¶årenderçš„å‚æ•°ï¼Œdata -&gt; {Object} Elasticsearch query results, è¦æ‰¾dataä»å“ªé‡Œæ¥çš„è¯ï¼Œå°±å¼€å§‹æ‰¾ç±»ä¼¼vis.renderçš„è°ƒç”¨ï¼Œæœäº†ä¸‹ï¼Œè°ƒç”¨ä½ç½®åœ¨VislibRenderbotçš„_createVisæ–¹æ³•ä¸­ï¼Œæ©ï¼Œè¿™å°±è·Ÿä¸€å¼€å§‹è”ç³»èµ·æ¥äº†ï¼Œåˆå›åˆ°äº†VislibRenderbotä¸Šäº†ã€‚ç„¶åç»§ç»­æ‰¾vislibrenderbotå®ä¾‹åŒ–çš„ä½ç½®ï¼Œæ¥åˆ°äº†src/ui/public/visualize/visualize.jsï¼Œçœ‹èµ·æ¥è¿™åƒæ˜¯é«˜åœ°äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$scope.$watch(&apos;esResp&apos;, prereq(function (resp) &#123;</span><br><span class="line">  if (!resp) return;</span><br><span class="line">  $scope.renderbot.render(resp); //esè¯·æ±‚å›æ¥çš„ç»“æœä¼ ç»™äº†renderbot</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>å€’å›å»çœ‹çœ‹VislibRenderbotçš„ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class="line">  this.chartData = this.buildChartData(esResponse);</span><br><span class="line">  return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class="line">    this.vislibVis.render(this.chartData, this.uiState);</span><br><span class="line">    this.refreshLegend++;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¥½! å¥½åƒç¨å¾®æœ‰ç‚¹çœ‰ç›®äº†ã€‚é€šè¿‡renderæ–¹æ³•æŠŠesçš„æ•°æ®ä¼ ç»™äº†renderbotï¼Œrenderboté€šè¿‡buildChartDataè¿›è¡Œæäº‹å®Œäº†å°±æ˜¯æœ€åçš„chartDataäº†ï¼Œä¹Ÿå°±æ˜¯vis.renderä¸­çš„dataäº†ã€‚</p><p>æ©! ä»”ç»†ä¸€æƒ³ï¼Œå¥½åƒè¿˜æ˜¯æœ‰ç‚¹ä¹±ï¼Œå†æ‹æ‹ã€‚VislibVisTypeçš„æ–¹æ³•createRenderbotè¿”å›çš„æ˜¯VislibRenderbot,ç„¶åVislibRenderbotçš„æ˜¯è·Ÿvisualizeè¿æ¥çš„æ ¸å¿ƒï¼Œåœ¨visualizeä¸­ï¼ŒVislibRenderbotè¿›è¡Œåˆå§‹åŒ–ï¼Œä¼ å…¥vislibVisçš„htmlå…ƒç´ ï¼Œå’Œesè¿”å›çš„data,ç„¶ååœ¨VislibRenderbotå†…éƒ¨è¿›è¡Œç»˜åˆ¶ã€‚é»˜è®¤çš„VislibRenderbotå†…éƒ¨dataä¼šè¿›è¡ŒbuildChartDataè½¬æ¢ã€‚</p><h4 id="ç¤ºä¾‹extended-metric"><a href="#ç¤ºä¾‹extended-metric" class="headerlink" title="ç¤ºä¾‹extended_metric"></a>ç¤ºä¾‹extended_metric</h4><p>ç„¶åå†çœ‹TemplateVisType, è¿™ä¸ªæ˜¯è‡ªå®šä¹‰æ—¶å€™çš„VislibVisTypeï¼Œå¯¹åº”çš„renderbotä¸ºTemplateRenderbot,å®šä¹‰çš„renderä¸ºï¼Œå°±æ˜¯è£¸æ•°æ®ï¼Œåœ¨$scopeä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TemplateRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class="line">  this.$scope.esResponse = esResponse;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ€å¼€å§‹æåˆ°äº†extended_metricæ’ä»¶ï¼Œç„¶åä»¥è¿™ä¸ªä¸ºä¾‹ï¼Œçœ‹çœ‹æ•°æ®çš„æµå‘ã€‚åœ¨controllerä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// watches</span><br><span class="line">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class="line">  if (resp) &#123;</span><br><span class="line">    calcOutputs.length = 0;</span><br><span class="line">    metrics.length = 0;</span><br><span class="line">    for (let key in metrics) &#123;</span><br><span class="line">      if (metrics.hasOwnProperty(key)) &#123;</span><br><span class="line">        delete metrics[key];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å•Šè™½ç„¶æ˜¯æ‰¾åˆ°äº†æ•°æ®çš„æ¥æºå’Œæµå‘ï¼Œå¯æ˜¯ï¼Œåˆæ˜¯Angular.. AngularåŸºç¡€ä¸ºé›¶çš„æˆ‘å¿ƒå¥½ç´¯â€¦ä¸è¿‡ä¹Ÿç®—æ˜¯äº†ç„¶äº†ã€‚ç„¶åå…·ä½“çœ‹çœ‹extended_metricæ’ä»¶æ‹¿åˆ°æ•°æ®ä¹‹ååšçš„äº‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$scope.processTableGroups = function (tableGroups) &#123;</span><br><span class="line">  tableGroups.tables.forEach(function (table) &#123;</span><br><span class="line">    table.columns.forEach(function (column, i) &#123;</span><br><span class="line">      const fieldFormatter = table.aggConfig(column).fieldFormatter();</span><br><span class="line">      let value = table.rows[0][i]; //esæ•°æ®å­˜åœ¨table.rowså†…</span><br><span class="line">      let formattedValue = isInvalid(value) ? &apos;?&apos; : fieldFormatter(value);     //æ•°æ®è½¬æ¢åæ‹¿å‡ºlabel, formattedValue</span><br><span class="line">      const metric = &#123;</span><br><span class="line">        label: column.title,</span><br><span class="line">        value: value,</span><br><span class="line">        formattedValue: formattedValue</span><br><span class="line">      &#125;;</span><br><span class="line">      metrics.push(metric);</span><br><span class="line">      metrics[column.title] = metric;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  updateOutputs();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤æ®µä»£ç æ˜¯ç›¸è¿çš„ï¼Œé¦–å…ˆprocessTableGroupsçš„å‚æ•°æ˜¯tabifyAggResponse($scope.vis, resp)ï¼ŒtabifyAggResponseæ˜¯ä¸€ä¸ªå†…éƒ¨å·²æœ‰çš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯æŠŠesè¿”å›çš„å·²çŸ¥ç»“æ„çš„æ•°æ®ï¼Œè½¬æ¢æˆæ ‡å‡†æ ¼å¼ï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯table,å¦‚æœæ˜¯lineçš„è¯ï¼Œå¯ä»¥çœ‹çœ‹point_series.jsã€‚è½¬æ¢åŒ…æ‹¬å‚æ•°åŒ…æ‹¬æ•°æ®ä¹‹å¤–ï¼Œè¿˜æœ‰vis,è½¬æ¢å®Œæˆå¾—åˆ°çš„æ•°æ®ä¸­åŒ…å«esæ•°æ®ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬é€‰é¡¹å¡ä¸­çš„æ•°æ®ï¼Œå¦‚è®¾ç½®çš„labelç­‰ã€‚</p><h4 id="ç¤ºä¾‹line-sg"><a href="#ç¤ºä¾‹line-sg" class="headerlink" title="ç¤ºä¾‹line_sg"></a>ç¤ºä¾‹line_sg</h4><p>ç¤ºä¾‹<a href="https://github.com/sbeyn/kibana-plugin-line-sg">åœ°å€</a></p><p>ç„¶ååˆ†æä¸€ä¸‹ï¼Œé¡ºä¾¿å·©å›ºä¸€ä¸‹ä¸Šé¢çš„çŸ¥è¯†ã€‚</p><p>åœ¨line_sg.jsä¸­ï¼Œç†Ÿæ‚‰çš„æ§ä»¶ï¼ŒTemplateVisTypeï¼ŒåŒ…å«paramså’Œschemasã€‚</p><p>åœ¨è§†å›¾line_sg.htmlä¸­,ä½¿ç”¨c3ç»˜åˆ¶ï¼Œåªæœ‰å‡ è¡Œä»£ç ï¼Œçœ‹ä¼¼å¾ˆç®€å•ï¼Œæˆ‘æƒ³æ§åˆ¶ç»˜åˆ¶çš„ä»£ç åº”è¯¥åœ¨controllerä¸­ï¼Œç„¶åçœ‹çœ‹_params.html,æ˜¯Optionçš„é€‰é¡¹å¡ï¼Œä¸»è¦åº”è¯¥æ˜¯è§†å›¾çš„é…ç½®ç›¸å…³ã€‚ç„¶åçœ‹çœ‹controller,åœ¨è§†å›¾controllerä¸­ï¼Œå‰é¢å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯å…³äºè¦ç”»çš„å‡†å¤‡å·¥ä½œï¼Œä»¥æ•°æ®æµå‘ä¸ºæ¥å…¥ç‚¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class="line">    if (resp) &#123;</span><br><span class="line">      console.log(resp);</span><br><span class="line">      metrics.length = 0; //é‡ç½®metricsï¼Œé‡ç½®æ•°ç»„çš„æ–¹å¼æ˜¯ä¿®æ”¹length,emmmå­¦åˆ°äº†</span><br><span class="line">      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp)); //è¿˜æ˜¯ä½¿ç”¨çš„æ•°æ®è¡¨æ ¼å½¢å¼ï¼Œä¸ºä»€ä¹ˆå¤§å®¶éƒ½é€‰è¿™ä¸ªè½¬æ¢å½¢å¼ï¼Ÿæˆ‘çŒœå¯èƒ½æ˜¯å› ä¸ºæ•°æ®æ¯”è¾ƒå¥½æ‹¿å‡ºæ¥..æ•°æ®è¿˜æ˜¯é›†ä¸­çš„ï¼Œæ•°æ®æ‹¿å‡ºæ¥ææˆè‡ªå·±æ ¼å¼çš„ï¼Œä¸è§†å›¾ç›¸å…³çš„æ•°æ®éƒ½åœ¨metricsä¸­ï¼Œ</span><br><span class="line">      $scope.showGraph(); //ä»metricsä¸­æ‹¿å‡ºæ•°æ®ï¼Œåšå›¾</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ç¤ºä¾‹æ˜¯ä½¿ç”¨c3æ¥å®Œæˆç»˜åˆ¶çš„ç¤ºä¾‹ï¼Œå› ä¸ºå’Œéœ€æ±‚çš„æ–¹æ³¢åˆšå¥½å¯ä»¥å»åˆï¼Œå°±å…·ä½“ç»†èŠ‚å­¦ä¹ ä¸‹å§ã€‚é¦–å…ˆå°†ä»£ç æ‹·å…¥pluginsæ–‡ä»¶å¤¹ï¼Œå¯åŠ¨kibana,æŸ¥çœ‹æ•ˆæœã€‚å‘ç°ä¸æ€ä¹ˆå¥½çœ‹ï¼Œå¦å¤–é€‰æ‹©chart_types=stepä¼¼ä¹ä¸å·¥ä½œï¼Œçœ‹çœ‹ä»£ç å§ã€‚</p><p>é¦–å…ˆå°è¯•æ˜¯ï¼Œè®¾ç½®paramsä¹‹åï¼Œç‚¹å‡»é‡ç»˜ï¼Œæ²¡æœ‰æ•ˆæœã€‚</p><p>ä»”ç»†çœ‹äº†çœ‹æ’ä»¶çš„ç»˜åˆ¶å’Œc3çš„ä½¿ç”¨ï¼Œçœ‹äº†çœ‹çº¿ä¸Šçš„kibanaï¼Œå‘ç°lineæ˜¯çœŸçš„å¯ä»¥æœ‰step..è€Œä¸”å›¾å½¢æ²¡æœ‰é”™â€¦å…¶å®æœ¬æ¥lineç”»å›¾å°±æœ‰æ–¹æ³¢ã€‚å¥½å§ï¼Œè¿˜æ˜¯å…ˆçœ‹çœ‹è¿™ä¸ªæ’ä»¶ä¸ºä»€ä¹ˆè®¾ç½®paramsä¹‹åï¼Œç‚¹å‡»é‡ç»˜ï¼Œæ²¡æœ‰è§¦å‘é‡ç»˜å§ã€‚ç»“è®ºæ˜¯æ²¡æœ‰ç›‘å¬å˜é‡çš„å˜åŒ–..$scope.$watchã€$watchControllerç­‰ç›‘å¬æ–¹æ³•ï¼Œè™½ç„¶æ²¡æœ‰çœ‹åˆ°å…·ä½“ä»£ç ï¼Œå¤§æ¦‚æ˜¯ï¼Œä¾§è¾¹æ éƒ¨åˆ†æ²¡æœ‰ä¿®æ”¹çš„è¯ï¼Œé‚£ä¸ªé‡ç»˜çš„æŒ‰é’®å°±æ— æ³•ç‚¹å‡»ï¼Œé‚£ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶åº”è¯¥æ˜¯è§¦å‘watchçš„ç›‘å¬äº‹ä»¶çš„ï¼Œæœ‰ä¿®æ”¹ï¼Œå°±ä¼šè§¦å‘ç›‘å¬äº‹ä»¶ï¼Œè¦é‡ç»˜çš„è¯å…¶å®å°±æ˜¯åœ¨ç›‘å¬äº‹ä»¶çš„å›è°ƒä¸­åŠ å…¥è§†å›¾é‡ç»˜çš„éƒ¨åˆ†ï¼Œå…¶å®æ•°æ®ä¼šè‡ªåŠ¨ç»‘å®šï¼Œåªæ˜¯éœ€è¦ä¸ªåˆ·æ–°æœºåˆ¶ã€‚</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">                                                 /===-_---~~~~~~~~~------____</span><br><span class="line">                                                |===-~___                _,-&apos;</span><br><span class="line">                 -==\\                         `//~\\   ~~~~`---.___.-~~</span><br><span class="line">             ______-==|                         | |  \\           _-~`</span><br><span class="line">       __--~~~  ,-/-==\\                        | |   `\        ,&apos;</span><br><span class="line">    _-~       /&apos;    |  \\                      / /      \      /</span><br><span class="line">  .&apos;        /       |   \\                   /&apos; /        \   /&apos;</span><br><span class="line"> /  ____  /         |    \`\.__/-~~ ~ \ _ _/&apos;  /          \/&apos;</span><br><span class="line">/-&apos;~    ~~~~~---__  |     ~-/~         ( )   /&apos;        _--~`</span><br><span class="line">                  \_|      /        _)   ;  ),   __--~~</span><br><span class="line">                    &apos;~~--_/      _-~/-  / \   &apos;-~ \</span><br><span class="line">                   &#123;\__--_/&#125;    / \\_&gt;- )&lt;__\      \</span><br><span class="line">                   /&apos;   (_/  _-~  | |__&gt;--&lt;__|      |</span><br><span class="line">                  |0  0 _/) )-~     | |__&gt;--&lt;__|      |</span><br><span class="line">                  / /~ ,_/       / /__&gt;---&lt;__/      |</span><br><span class="line">                 o o _//        /-~_&gt;---&lt;__-~      /</span><br><span class="line">                 (^(~          /~_&gt;---&lt;__-      _-~</span><br><span class="line">                ,/|           /__&gt;--&lt;__/     _-~</span><br><span class="line">             ,//(&apos;(          |__&gt;--&lt;__|     /                  .----_</span><br><span class="line">            ( ( &apos;))          |__&gt;--&lt;__|    |                 /&apos; _---_~\</span><br><span class="line">         `-)) )) (           |__&gt;--&lt;__|    |               /&apos;  /     ~\`\</span><br><span class="line">        ,/,&apos;//( (             \__&gt;--&lt;__\    \            /&apos;  //        ||</span><br><span class="line">      ,( ( ((, ))              ~-__&gt;--&lt;_~-_  ~--____---~&apos; _/&apos;/        /&apos;</span><br><span class="line">    `~/  )` ) ,/|                 ~-_~&gt;--&lt;_/-__       __-~ _/</span><br><span class="line">  ._-~//( )/ )) `                    ~~-&apos;_/_/ /~~~~~~~__--~</span><br><span class="line">   ;&apos;( &apos;)/ ,)(                              ~~~~~~~~~~</span><br><span class="line">  &apos; &apos;) &apos;( (/</span><br><span class="line">    &apos;   &apos;  `</span><br></pre></td></tr></table></figure><hr><p>åé¢æ•´ç†äº†ä¸‹ï¼Œæ€è·¯ç¨å¾®æ¸…æ™°ä¸€ç‚¹çš„ã€‚</p><p>å¼€å‘æ’ä»¶çš„è¯ï¼Œéƒ½éœ€è¦ä¸€å®šçš„æ¨¡æ¿ï¼Œå®˜æ–¹æ¨èçš„ç”Ÿæˆæ¨¡æ¿çš„è„šæ‰‹æ¶<a href="https://github.com/saojs/sao">sao</a>,å…·ä½“ä½¿ç”¨<a href="https://github.com/elastic/template-kibana-plugin">æ ·ä¾‹</a>ã€‚è¿˜æœ‰æ’ä»¶å¼€å‘çš„<a href="https://www.gitbook.com/book/trumandu/kibana-plugin-development-tutorial/details" target="_blank" rel="noopener">æ•™ç¨‹</a>ã€‚ç¯‡å¹…åŸå› ï¼Œå°±çœå»æ•™ç¨‹ç³»åˆ—ï¼Œä¸»è¦çœ‹çœ‹ç»“æ„ï¼Œæºç ä»€ä¹ˆçš„..</p><h3 id="visTypes"><a href="#visTypes" class="headerlink" title="visTypes"></a>visTypes</h3><p>Visualizeæ’ä»¶çš„å¼€å‘ï¼Œç»„æˆä¸»è¦æ˜¯es6,angular(å¬è¯´angular1å’Œ2å®Œå…¨æ²¡å…³ç³»ï¼Œç‰¹åœ°æŒ‡å‡ºkibanaé‡‡ç”¨çš„æ˜¯angular1)ã€‚kibanaçš„Visualizeç»„ä»¶çš„ç»˜åˆ¶ä¸»è¦æ˜¯é€šè¿‡<a href="https://d3js.org/" target="_blank" rel="noopener">d3</a>è¿™ä¸ªä¼Ÿå¤§çš„å¯è§†åŒ–åº“ã€‚</p><h4 id="æ’ä»¶æ ·ä¾‹"><a href="#æ’ä»¶æ ·ä¾‹" class="headerlink" title="æ’ä»¶æ ·ä¾‹"></a>æ’ä»¶æ ·ä¾‹</h4><p>ä»ä¼—å¤šä¼˜ç§€çš„visæ’ä»¶ä¸­é€‰æ‹©äº†ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„<a href="https://github.com/ommsolutions/kibana_ext_metrics_vis">æ ·ä¾‹</a>æ¥åšåˆ†æ(ä¸»è¦æ˜¯äººå®¶æœ‰å›¾)ã€‚æ•ˆæœå¦‚gifå›¾ï¼Œç”¨æ–‡å­—æ¥è¯´æ˜çš„è¯ï¼Œå°±æ˜¯å®ç°äº†ä¸€ä¸ªå¯è®¡ç®—çš„æ’ä»¶ï¼Œé€‰æ‹©metricå€¼ï¼Œç„¶åå¡«å…¥è®¡ç®—å…¬å¼ï¼Œå¾—å‡ºå€¼ã€‚(å› ä¸ºè§è¯†æœ‰é™ï¼Œä»¥å‰æ€»è¯´åœ¨kibanaä¸­å®ç°è®¡ç®—å¾ˆå¤æ‚ï¼Œç°åœ¨çœ‹æ¥çœŸæ˜¯å•ªå•ª(*10)æ‰“è„¸)ã€‚</p><p>extended_metric_vis.jså¾ˆæ˜æ˜¾ï¼Œæ˜¯è¿™ä¸ªæ’ä»¶çš„å¤§å¤´ã€‚ç¨å¾®ç²˜ä¸€ç‚¹ä»£ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">return new TemplateVisType(&#123;</span><br><span class="line">    name: &apos;extended_metric&apos;,</span><br><span class="line">    title: &apos;Extended Metric&apos;,</span><br><span class="line">    description: &apos;Based on the core Metric-Plugin but gives you the ability&apos; +</span><br><span class="line">      &apos;to output custom aggregates on metric-results.&apos;,</span><br><span class="line">    icon: &apos;fa-calculator&apos;,</span><br><span class="line">    template: extendedMetricVisTemplate, //è§†å›¾æ¨¡æ¿.html</span><br><span class="line">    params: &#123; //Optionsé€‰é¡¹ï¼Œé¢„å®šä¹‰çš„Optionsé€‰é¡¹åŠå€¼ï¼Œåœ¨å¯¹åº”è§†å›¾ä¸­ä¼šæœ‰å…·ä½“ä½¿ç”¨</span><br><span class="line">      defaults: &#123;</span><br><span class="line">        handleNoResults: true,</span><br><span class="line">        fontSize: 60,</span><br><span class="line">        outputs: [</span><br><span class="line">          &#123;</span><br><span class="line">            formula: &apos;metrics[0].value * metrics[0].value&apos;,</span><br><span class="line">            label: &apos;Count squared&apos;,</span><br><span class="line">            enabled: true</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      editor: metricVisParamsTemplate //Optionsé€‰é¡¹å¡è§†å›¾æ¨¡æ¿.html</span><br><span class="line">    &#125;,</span><br><span class="line">    schemas: new Schemas([ //Dataç›¸å…³ï¼Œè¿™é‡Œå°±ä¸æ˜¯è‡ªç”±å‘æŒ¥çš„åœ°ç•Œäº†ï¼Œå±äºåŠå‘½é¢˜ç±»å‹ï¼Œæ ¹æ®è‡ªå·±éœ€è¦çš„æ•°æ®é€‰æ‹©å¯¹åº”ç±»å‹ï¼ŒåŸºæœ¬</span><br><span class="line">    //å°±æ˜¯metricï¼Œbucketçš„ç»„åˆï¼Œä¸€èˆ¬æ¥è¯´ï¼Œmetric æ•°å€¼èšåˆè‚¯å®šæ˜¯ Y è½´ï¼›bucket èšåˆè‚¯å®šæ˜¯ X è½´ï¼›</span><br><span class="line">      &#123;           //è€Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œè¿˜å¯ä»¥è®© bucket æœ‰ä¸åŒæ•ˆæœï¼Œä¹Ÿå°±æ˜¯ Schema é‡Œçš„ segment(é»˜è®¤), group å’Œ splitã€‚</span><br><span class="line">        group: &apos;metrics&apos;,</span><br><span class="line">        name: &apos;metric&apos;,</span><br><span class="line">        title: &apos;Metric&apos;,</span><br><span class="line">        min: 1,</span><br><span class="line">        defaults: [</span><br><span class="line">          &#123; type: &apos;count&apos;, schema: &apos;metric&apos; &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ])</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>å¦‚æœç¨å¾®çœ‹äº†ä¸‹visæ’ä»¶çš„æ•™ç¨‹çš„è¯ï¼Œå°±ä¼šå¾ˆç†Ÿæ‚‰ï¼Œå› ä¸ºæ¨¡æ¿å°±å·®ä¸å¤šæ˜¯è¿™æ ·ï¼Œåˆ©ç”¨TemplateVisTypeç”Ÿæˆå¯¹åº”å®ä¾‹ï¼ŒåŸºæœ¬å¤‡æ³¨éƒ½åœ¨ä»£ç é‡Œäº†ï¼Œå°±ä¸å†å•°å—¦äº†ã€‚</p><p>ç„¶åæ ¹æ®ä¸Šé¢çš„ä»£ç ç›´æ¥çš„æ‰¾åˆ°ä¸¤ä¸ªhtmlï¼Œextended_metric_vis.htmlå’Œextended_metric_vis_params.html, å¾ˆæ˜¾ç¤ºï¼Œå°±æ˜¯view,ä¼šçœ‹åˆ°ä¼Ÿå¤§çš„angularè¿›è¡Œmvcçš„ç®¡ç†ï¼Œç„¶åå»çœ‹c =&gt; extended_metric_vis_controller.jsã€‚è¿™ä¸ªä»£ç é‡Œï¼Œä¸»è¦æ˜¯angularä¸å…¶æ§åˆ¶å™¨çš„ç»‘å®šï¼Œè·³è¿‡è¿™ä¸ªï¼Œè¿›åˆ°æ–¹æ³•é‡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class="line">    if (resp) &#123;</span><br><span class="line">      calcOutputs.length = 0;</span><br><span class="line">      metrics.length = 0;</span><br><span class="line">      //æ¸…ç©ºmetrics</span><br><span class="line">      for (let key in metrics) &#123;</span><br><span class="line">        if (metrics.hasOwnProperty(key)) &#123;</span><br><span class="line">          delete metrics[key];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾ï¼Œè¿™é‡Œæ˜¯æ¥å—esæŸ¥è¯¢ç»“æœçš„ä»£ç ï¼Œç»“è®ºå¾ˆæ˜æ˜¾æ˜¯ï¼Œè·å¾—esæŸ¥è¯¢ç»“æœåªéœ€è¦ç›‘å¬esResponseå˜é‡å°±å¯ä»¥ã€‚ç„¶åçœ‹çœ‹æ‹¿åˆ°ç»“æœçš„å¤„ç†processTableGroupsæ–¹æ³•ã€‚é¦–å…ˆæ˜¯tabifyAggResponseæ˜¯æŒ‰ç…§å·²çŸ¥çš„esæŸ¥è¯¢ç»“æœç»“æ„ç”Ÿæˆä¸è§†å›¾(dataé€‰é¡¹å¡)å¼ºç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œä¸ºä»€ä¹ˆè¯´å¼ºç›¸å…³å‘¢ï¼Œæ¯”å¦‚tabifyAggResponseåçš„ç»“æœä¸»è¦åŒ…æ‹¬columnså’Œrowsï¼Œåˆ†åˆ«æ˜¯dataé€‰é¡¹å¡çš„åˆ†ç»„å’Œå¯¹åº”çš„æ•°æ®ï¼Œå°±æ‹¿è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœæ–°å»ºäº†ä¸¤ä¸ªmetric, columnsé‡Œå°±æ˜¯è¿™ä¸¤ä¸ªmetricçš„å±æ€§ï¼ŒåŒ…å«title(å³è¾“å…¥çš„label)ç­‰ï¼Œå¯¹åº”indexçš„rowsé‡Œçš„æ•°æ®å°±æ˜¯å¯¹åº”metricçš„ç»“æœã€‚è½¬æ¢ä¹‹åï¼Œåœ¨processTableGroupsæ–¹æ³•é‡Œï¼Œåªéœ€è¦æŠŠå¯¹åº”çš„æ•°æ®æ‹¿å‡ºæ¥ç»„åˆä¸‹ï¼Œæ¯”å¦‚ï¼Œä¾‹å­é‡Œå°±æ˜¯ä»¥columnsä¸­çš„titleä¸ºé”®ï¼Œä»¥metricçš„ç»“æœä¸ºå€¼ï¼Œç»„æˆæ•°æ®åˆ°metrics(è£…æ•°æ®çš„å¯¹è±¡ï¼Œä¸‹æ–¹ä¼šç”¨åˆ°)ä¸­ã€‚</p><p>viewæœ‰äº†ï¼Œæ•°æ®ä¹Ÿæœ‰äº†ï¼Œè¿˜å·®æœ€åä¸€æ­¥ï¼Œå°±æ˜¯æ€ä¹ˆæŠŠå…¬å¼å¥—è¿›å»ï¼Ÿåœ¨è¿™é‡Œï¼Œæˆ‘ä¸å¾—ä¸å†æ¬¡æ„Ÿå¹ä¸‹jsçš„ä¼Ÿå¤§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">  const func = Function(&quot;metrics&quot;, &quot;return &quot; + output.formula); //&lt;&lt;&lt;&lt;=è¿™é‡Œæ˜¯äº®ç‚¹</span><br><span class="line">  output.value = func(metrics) || &quot;?&quot;;</span><br><span class="line">&#125; catch (e) &#123;</span><br><span class="line">  output.value = &apos;?&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>output.formulaä¸ºè¾“å…¥çš„å…¬å¼ï¼Œç±»å‹ä¸ºstringï¼Œç„¶åä¸€å¥stringçš„å­—ç¬¦ä¸²å°±å˜æˆæ–¹æ³•äº†ï¼Ÿï¼æ˜¯çš„ã€‚å¾ˆç¥å¥‡ã€‚æœ‰äº†æ–¹æ³•ï¼ŒæŠŠæ•°æ®å¥—è¿›å»ï¼Œç­”æ¡ˆå°±å‡ºæ¥äº†ã€‚</p><p>å¤§æ¦‚å†…å®¹å°±æ˜¯è¿™æ ·ï¼Œå¯èƒ½è¿˜æœ‰äº›ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œæ¯”å¦‚ï¼Œä¿®æ”¹äº†data/optionç‚¹å‡»é‚£ä¹ˆé‡ç»˜çš„æŒ‰é’®ï¼Œé‡æ–°è®¡ç®—ï¼Œéœ€è¦ç›‘å¬å¯¹åº”æ•°æ®ï¼Œå¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//updateOutputsä¸ºè®¡ç®—çš„è¿‡ç¨‹</span><br><span class="line">$scope.$watchCollection(&apos;vis.params.outputs&apos;, updateOutputs);</span><br></pre></td></tr></table></figure><h4 id="æºç æ ·ä¾‹"><a href="#æºç æ ·ä¾‹" class="headerlink" title="æºç æ ·ä¾‹"></a>æºç æ ·ä¾‹</h4><p>æ¥ä¸‹æ¥å°±çœ‹çœ‹ç¨å¾®è‚¤æµ…ç‚¹çš„æºç ï¼Œæ—¶é—´å’Œèƒ½åŠ›ç¡®å®æœ‰é™å•Šã€‚æ¯”å¦‚ä¸Šé¢å‡ºç°è¿‡çš„TemplateVisTypeï¼Œæ•´ä½“ç†è§£ä¸‹ç»“æ„å’Œè¿ä½œã€‚</p><ul><li><p>src/core_plugins/kbn_vislib_vis_types</p><p>è‡ªå¸¦çš„visç»„ä»¶å®šä¹‰çš„åœ°æ–¹ã€‚è¿˜åŒ…æ‹¬optionsé€‰é¡¹å¡çš„html,jsç­‰ç­‰ï¼Œçœ‹çœ‹line.jsçš„éƒ¨åˆ†ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">return new VislibVisType(&#123;</span><br><span class="line">  name: &apos;line&apos;,</span><br><span class="line">  title: &apos;Line&apos;,</span><br><span class="line">  image,</span><br><span class="line">  description: &apos;Emphasize trends&apos;,</span><br><span class="line">  category: VisType.CATEGORY.BASIC,</span><br><span class="line">  params: &#123;</span><br><span class="line">    defaults: &#123;</span><br><span class="line">      grid: &#123;</span><br><span class="line">        categoryLines: false,</span><br><span class="line">        style: &#123;</span><br><span class="line">          color: &apos;#eee&apos;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    positions: [&apos;top&apos;, &apos;left&apos;, &apos;right&apos;, &apos;bottom&apos;],</span><br><span class="line">    ...</span><br><span class="line">    editor: pointSeriesTemplate,</span><br><span class="line">    ...</span><br><span class="line">    schemas: new Schemas([</span><br><span class="line">    &#123;</span><br><span class="line">      group: &apos;metrics&apos;,</span><br><span class="line">      name: &apos;metric&apos;,</span><br><span class="line">      title: &apos;Y-Axis&apos;,</span><br><span class="line">      min: 1,</span><br><span class="line">      aggFilter: [&apos;!geo_centroid&apos;],</span><br><span class="line">      defaults: [</span><br><span class="line">        &#123; schema: &apos;metric&apos;, type: &apos;count&apos; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">   ....</span><br><span class="line">  ])</span><br></pre></td></tr></table></figure><p>å’Œä¸Šæ–¹extended_metric_vis.jsç²˜å‡ºæ¥çš„ä»£ç å¾ˆç›¸ä¼¼å§ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯ä½¿ç”¨çš„TemplateVisTypeï¼Œä¸€ä¸ªæ˜¯VislibVisTypeï¼Œå…¶å®è¿™ä¸¤ä¸ªç±»ä¹Ÿå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯ç»§æ‰¿vis_typeã€‚ä¸è¿‡ä»è¿™ç‚¹ä¸Šæ¥çœ‹ï¼Œå®šä¹‰visç»„ä»¶çš„å¥—è·¯å…¶å®å·®ä¸å¤šï¼ŒåŒºåˆ«å‘¢ï¼Œå°±æ˜¯å®˜æ–¹çš„ç»„ä»¶çš„è¯è§†å›¾ç»˜åˆ¶çš„éƒ¨åˆ†åº”è¯¥æ˜¯å†…å®šçš„ï¼Œç›´æ¥é€‰æ‹©å‡ºæ¥ç»˜åˆ¶å°±å¥½äº†(åœ¨åé¢ä¼šçœ‹åˆ°é€‰æ‹©çš„ä»£ç )ï¼Œä½†æ˜¯è‡ªå®šä¹‰visç»„ä»¶çš„è¯ï¼Œè§†å›¾éƒ¨åˆ†æ˜¯éœ€è¦è‡ªå·±è‡ªå®šä¹‰çš„ï¼Œè€Œä¸æ˜¯é€‰æ‹©åŸæœ‰çš„ï¼Œæ‰€ä»¥è‡ªå®šä¹‰éœ€è¦TemplateVisTypeå¯¹è±¡ï¼Œä¼ å…¥templateè§†å›¾ã€‚</p></li><li><p>src/public/ui/vis/vis_type</p><p>å®šä¹‰åŸºæœ¬å±æ€§å’Œæ–¹æ³•createRenderbotã€‚ç»§æ‰¿è¿™ä¸ªçš„è¯éœ€è¦å®ç°createRenderbotæ–¹æ³•è¿”å›Renderbotå¯¹è±¡ã€‚</p></li><li><p>src/public/ui/vislib_vis_type/vislib_vis_type</p><p>ç»§æ‰¿vis_typeã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">const updateParams = function (params) &#123;</span><br><span class="line">const updateIfSet = (from, to, prop, func) =&gt; &#123;</span><br><span class="line">      if (from[prop]) &#123;</span><br><span class="line">        to[prop] = func ? func(from[prop]) : from[prop];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br><span class="line">// Â·ã€‚ç¬¬ä¸€ï¼Œç»§æ‰¿VisTypeï¼Œçœ‹åˆ°responseConverteré»˜è®¤æ˜¯è½¬æ¢ä¸ºç‚¹çº¿å›¾æ•°ç»„çš„ã€‚</span><br><span class="line">_.class(VislibVisType).inherits(VisType);</span><br><span class="line">  function VislibVisType(opts = &#123;&#125;) &#123;</span><br><span class="line">    VislibVisType.Super.call(this, opts);</span><br><span class="line"></span><br><span class="line">    if (this.responseConverter == null) &#123;</span><br><span class="line">      this.responseConverter = pointSeries;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.listeners = opts.listeners || &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">// Â·ã€‚ç¬¬äºŒï¼Œå®ç°createRenderbot</span><br><span class="line">   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class="line">   // åœ¨è¿”å›æ–°VislibRenderbotå¯¹è±¡ä¹‹å‰ï¼Œå¯¹vis.paramsè¿›è¡Œäº†ç›¸åº”çš„è½¬æ¢å’Œåˆ¤æ–­ï¼Œæ¯”å¦‚æŠŠä¸€äº›paramsä¸‹çš„å±æ€§å¯¹åº”ç§»åˆ°params.seriesParams[0]æˆ–è€…params.valueAxes[0]ï¼Œparams.categoryAxes[0]ä¸‹</span><br><span class="line">    updateParams(vis.params);</span><br><span class="line">    return new VislibRenderbot(vis, $el, uiState);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åŸºæœ¬å°±æ˜¯paramsçš„è½¬æ¢ï¼Œå’Œè¿”å›VislibRenderbotä½œä¸ºRenderbotå¯¹è±¡ï¼Œé‚£ä¹ˆï¼Œä¹…é—»çš„Renderbotçš„ä½œç”¨ï¼Ÿé¢„çŸ¥åäº‹å¦‚ä½•ï¼Œè¯·çœ‹åé¢..</p></li><li><p>src/public/ui/vislib_vis_type/vislib_renderbot</p><p>æ©ï¼ŒRenderbotä¸­å®šä¹‰äº†éœ€å®ç°çš„ä¸€äº›æ–¹æ³•ï¼ŒVislibRenderbotå°±ç»§æ‰¿Renderbotï¼Œæ•…å°±ç›´æ¥çœ‹VislibRenderbotçš„ä»£ç äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class="line">  this.chartData = this.buildChartData(esResponse);</span><br><span class="line">  return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class="line">    this.vislibVis.render(this.chartData, this.uiState); //ç»˜åˆ¶</span><br><span class="line">    this.refreshLegend++;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚renderæ–¹æ³•,é€šè¿‡è°ƒç”¨vislibRenderbot.renderæ–¹æ³•å®ç°ç»˜åˆ¶ã€‚<br>çœ‹åˆ°è¿™é‡Œï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰çœ‹åˆ°åŠ äº†æ³¨é‡Šé‚£å¥ä»£ç ï¼Œç»˜åˆ¶çš„ä¸»è¦å·¥ä½œåº”è¯¥å°±åœ¨è¿™è¡Œä»£ç ï¼Œé‚£ä¹ˆå¥½å¥‡ä¸€ä¸‹this.vislibVisåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‰¾åˆ°this.vislibVisçš„åˆå§‹åŒ–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.vislibVis = new vislib.Vis(this.$el[0], this.vislibParams);</span><br></pre></td></tr></table></figure><p>åœ¨Visä¸­ï¼Œä¸»è¦æ˜¯visConfigå’Œhandler, handlerç»˜åˆ¶ï¼ŒvisConfigé€‰æ‹©ç”Ÿæˆç›¸åº”çš„æ•°æ®ç»“æ„ã€‚å¯¹äºvisConfigçš„ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//src/public/ui/vislib/vis_config.js</span><br><span class="line">const visType = visTypes[visConfigArgs.type];</span><br><span class="line">const typeDefaults = visType(visConfigArgs, this.data); // &lt;= æ•°æ®ç»“æ„æ›´æ”¹</span><br><span class="line"></span><br><span class="line">//visTypes =&gt; src/public/ui/vislib/types</span><br><span class="line">  return &#123;</span><br><span class="line">    histogram: pointSeries.column,</span><br><span class="line">    horizontal_bar: pointSeries.column,</span><br><span class="line">    line: pointSeries.line,</span><br><span class="line">    pie: Private(VislibLibTypesPieProvider),</span><br><span class="line">    area: pointSeries.area,</span><br><span class="line">    point_series: pointSeries.line,</span><br><span class="line">    heatmap: pointSeries.heatmap,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>handlerç»˜åˆ¶,handlerçš„renderæ–¹æ³•ä¸­,å¯ä»¥çœ‹åˆ°chart.render</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// render in handler</span><br><span class="line">render() &#123;</span><br><span class="line">...</span><br><span class="line">const chart = new self.ChartClass(self, this, chartData);</span><br><span class="line">...</span><br><span class="line">chart.render();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ChartClass in handler</span><br><span class="line">this.ChartClass = chartTypes[visConfig.get(&apos;type&apos;)];</span><br><span class="line"></span><br><span class="line">//chartTypes from src/public/ui/vislib/visualizations/vis_types</span><br><span class="line">//è¿™é‡Œé¢æ˜¯è¿›è¡Œå¯è§†åŒ–çš„åœ°æ–¹ï¼Œå¯è§†åŒ–å¯¹è±¡éƒ½ç»§æ‰¿è‡ªChartç±»ï¼Œcomponents/vislib/visualizations/_chart</span><br><span class="line">  Chart.prototype.render = function () &#123;</span><br><span class="line">      var selection = d3.select(this.chartEl);</span><br><span class="line">      selection.selectAll(&apos;*&apos;).remove();</span><br><span class="line">      selection.call(this.draw());</span><br><span class="line">   &#125;;</span><br><span class="line">  //ä¹Ÿå°±æ˜¯è¯´ï¼Œå„ä¸ªå¯è§†åŒ–å¯¹è±¡ï¼Œåªéœ€è¦ç”¨ d3.js æˆ–è€…å…¶ä»–ç»˜å›¾åº“ï¼Œå®Œæˆè‡ªå·±çš„ draw() å‡½æ•°ï¼Œå°±å¯ä»¥äº†ï¼å¯ä»¥åœ¨æœ¬æ–‡ä»¶å¤¹ä¸‹æŸ¥çœ‹å…·ä½“ä¸€äº›ç»˜åˆ¶ä»£ç </span><br></pre></td></tr></table></figure></li><li><p>src/public/visualize/visualize</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$scope.$watch(&apos;esResp&apos;, prereq(function (resp) &#123;</span><br><span class="line">    if (!resp) return;</span><br><span class="line">    $scope.renderbot.render(resp);</span><br><span class="line">  &#125;));</span><br></pre></td></tr></table></figure><p> å¾ˆæ˜æ˜¾ï¼Œvisualize.jsæ˜¯Visualizationçš„å¤§Bossï¼Œé€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œvisualizeä¸vis_typesäº¤äº’ä¸»è¦é€šè¿‡è°ƒç”¨renderbotçš„å„ç§æ–¹æ³•ï¼ŒåŒ…æ‹¬renderã€‚</p></li></ul><p>å¤§è‡´æ€»ç»“ä¸€ä¸‹ï¼Œè¦å®šä¹‰visç»„ä»¶çš„è¯ï¼Œè¿”å›VislibVisTypeæˆ–TemplateVisTypeå¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªç±»å†…éƒ¨éƒ½ä¼šç”Ÿæˆå¯¹åº”çš„renderbotå¯¹è±¡ï¼Œvisualizeä¸é€šè¿‡è°ƒç”¨renderbotå¯¹è±¡è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰ç»„ä»¶çš„è¯ï¼Œè¿”å›çš„TemplateVisTypeå¯¹è±¡éœ€è¦å…·æœ‰templateå±æ€§ï¼Œä¸ºå›¾è¡¨è§†å›¾æ¨¡æ¿(html), å®˜æ–¹è‡ªå¸¦çš„ç»„ä»¶çš„è¯ï¼Œä¼šæ ¹æ®ç±»å‹è¿›è¡Œé€‰æ‹©è§†å›¾ã€‚å¯¹äºè§†å›¾çš„ç»˜åˆ¶(åŒ…æ‹¬ä¿®æ”¹é€‰é¡¹å¡ï¼Œé‡ç»˜)ï¼Œvisualizeä¼šè°ƒç”¨renderbot.renderæ–¹æ³•ï¼ŒVisRenderbotçš„renderæ–¹æ³•å³é‡ç»˜..åœ¨ä¸Šæ–¹ç²˜è´´çš„ä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒTemplateRenderbotçš„renderæ–¹æ³•æ˜¯å°†esResponseæ•°æ®ç»‘å®šåˆ°å½“å‰ä½œç”¨åŸŸçš„esResponseå˜é‡ä¸Šï¼Œæ‰€ä»¥è‡ªå®šä¹‰æ’ä»¶ä¸­è¦å®Œæˆç»˜åˆ¶çš„è¯ï¼Œéœ€è¦ç›‘å¬å½“å‰ä½œç”¨åŸŸçš„esResponseå˜é‡ã€‚</p><p>å¥½å•¦ï¼Œå®˜æ–¹è‡ªå¸¦çš„ç»„ä»¶çš„ä»£ç ä»‹ç»å’Œè‡ªå¼€å‘æ’ä»¶çš„ä»£ç ä»‹ç»å°±åˆ°è¿™é‡Œå°±ç»“æŸå•¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>kibana-timeline</title>
      <link href="/2017/10/14/kibana-timeline/"/>
      <url>/2017/10/14/kibana-timeline/</url>
      
        <content type="html"><![CDATA[<p>åœ¨è·¯å¾„..kibana-5.4.2/src/core_plugins/timelionä¸‹ä¸ºtimelineçš„æºç ã€‚</p><h3 id="fit-functitons"><a href="#fit-functitons" class="headerlink" title="fit-functitons"></a>fit-functitons</h3><p>fitæ–¹æ³•æœ‰average,carry,nearest,scaleå‡ ç§ã€‚</p><h4 id="average"><a href="#average" class="headerlink" title="average"></a>average</h4><p>averageçš„æ–¹æ³•å‚æ•°æœ‰2ï¼ŒdataTuples, targetTuplesã€‚å‰è€…ä¸ºæ•°æ®æ•°æ®ï¼Œåè€…ä¸ºç›®æ ‡æ•°æ®ï¼Œæ•°æ®ç»“æ„éƒ½ä¸º[[time,value],[..]],ç›®æ ‡æ•°æ®çš„è®¾å®šä¸ºä»¥æ—¶é—´åˆ†çš„æ¡¶ï¼Œä¼ å…¥æ—¶æ•°æ®ä¸º[time,null]..</p><p>æ–¹æ³•ä½œç”¨ä¸€ï¼Œéå†æ—¶é—´æ¡¶ï¼Œå–æ•°æ®ä¸­æœ‰åœ¨å½“å‰æ¡¶æ—¶é—´çš„èŒƒå›´å†…çš„æ•°æ®ï¼Œæ±‚å¹³å‡å€¼ï¼Œè‹¥æ¡¶å†…æ— æ•°æ®ï¼Œåˆ™è®°ä¸ºNaN,ç»“æœè®°ä¸ºresultValuesï¼Œéšåå†è¿›è¡ŒNaNå¤„ç†ï¼Œå°†resultValuesä¸­æ‰€æœ‰NaNçš„å€¼éƒ½å–ä»£ä¸ºå€¼ï¼Œå–å€¼çš„å‡½æ•°ä¸º    å–å‰ä¸€æ¬¡æœ‰å€¼çš„æ•°ï¼Œä¸å½“å‰çš„æ•°çš„å·®å€¼ é™¤ä»¥ è¿ç»­NaNçš„ä¸ªæ•°+1ï¼Œå¾—å‡ºè¿™æœŸé—´çš„å¢é•¿ç‡ï¼Œå†ä¾æ¬¡ç»™å…¶ä¸­è¿ç»­çš„nançš„å€¼èµ‹å€¼ä¸ºå‰ä¸€æ¬¡å€¼+å¢é•¿ç‡ã€‚æœ€åresultValuesä¸ç›®æ ‡æ•°æ®ä¸­å–å‡ºæ¥çš„æ—¶é—´æ¡¶ç»„æˆè¿”å›å€¼ã€‚</p><p>æ±‚å¹³å‡å€¼éƒ¨åˆ†çš„ä»£ç å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">while (i &lt; dataTuplesQueue.length &amp;&amp; dataTuplesQueue[i][0] &lt;= time) &#123;</span><br><span class="line">    avgSet.push(dataTuplesQueue[i][1]);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  dataTuplesQueue.splice(0, i);</span><br><span class="line"></span><br><span class="line">  const sum = _lodash2.default.reduce(avgSet, function (sum, num) &#123;</span><br><span class="line">    return sum + num;</span><br><span class="line">  &#125;, 0);</span><br><span class="line">  return avgSet.length ? sum / avgSet.length : NaN;</span><br></pre></td></tr></table></figure><h4 id="carry"><a href="#carry" class="headerlink" title="carry"></a>carry</h4><p>æ–¹æ³•å‚æ•°æœ‰2ï¼ŒdataTuples, targetTuplesã€‚è¦æ±‚dataTuplesçš„é•¿åº¦å¤§äºtargetTuplesçš„ï¼Œå³åŸæœ¬æ•°æ®çš„æ—¶é—´æ¡¶åˆ†å¸ƒå¯†é›†ã€‚ä½œç”¨æ˜¯åœ¨targetTuplesæ—¶é—´æ¡¶é—´ï¼Œè¿”å›dataTuplesæ—¶é—´æ¡¶ä¸­çš„å€¼ã€‚targetTuplesçš„é•¿åº¦æ˜¯å°äºdataTuplesçš„ï¼Œä»ç®—æ³•ä¸Šæ¥çœ‹dataTupleså¤šå‡ºå»äº†çš„å°±æ²¡äº†â€¦</p><h4 id="nearest"><a href="#nearest" class="headerlink" title="nearest"></a>nearest</h4><p>æ—¶é—´æ¡¶é—´éš”ï¼Œå–ç¦»è‡ªå·±æœ€è¿‘çš„ä¸€ä¸ªæ¡¶çš„å€¼ä¸ºå€¼ã€‚</p><h4 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h4><p>é€šè¿‡ä¸Šè¿°ä»£ç å¯è§ï¼Œfitæ–¹æ³•æä¾›çš„ä¸»è¦æ˜¯å¯¹å·²åˆ†å¥½çš„æ•°æ®æ¡¶è¿›è¡Œå†åŠ å·¥ï¼Œä¼ å…¥å‚æ•°ä¸ºåŸæœ‰æ•°æ®æ¡¶ï¼Œå’Œ ç›®æ ‡æ¡¶ï¼Œç›®æ ‡æ¡¶æä¾›äº†æ–°çš„æ—¶é—´æ¡¶ã€‚</p><h4 id="æµ‹è¯•æ–°æ–¹æ³•"><a href="#æµ‹è¯•æ–°æ–¹æ³•" class="headerlink" title="æµ‹è¯•æ–°æ–¹æ³•"></a>æµ‹è¯•æ–°æ–¹æ³•</h4><p>åœ¨fitä¸­æ·»åŠ ä¸€ä¸ªæ–°æ–¹æ³•ï¼Œä¸ºæŸä¸ªæ—¶é—´æ¡¶æ— å€¼ï¼Œåˆ™ä¿æŒä¸Šä¸€æ¬¡çš„å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">var _lodash = require(&apos;lodash&apos;);</span><br><span class="line"></span><br><span class="line">var _lodash2 = _interopRequireDefault(_lodash);</span><br><span class="line"></span><br><span class="line">function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;</span><br><span class="line"></span><br><span class="line">// bug: æ²¡è€ƒè™‘æ²¡å€¼çš„æƒ…å†µï¼Œå°±æ˜¯dataTuplesä¸º[].</span><br><span class="line">module.exports = function (dataTuples, targetTuples) &#123;</span><br><span class="line">  return _lodash2.default.map(targetTuples, function (bucket) &#123;</span><br><span class="line">    const time = bucket[0];</span><br><span class="line">    let i = 0;</span><br><span class="line">    while (i &lt; dataTuples.length - 1 &amp;&amp; dataTuples[i + 1][0] &lt; time) &#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    const closest = dataTuples[i];</span><br><span class="line">    dataTuples.splice(0, i);</span><br><span class="line">    return [bucket[0], closest[1]];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç›®å‰æ˜¯æ·»åŠ åˆ°æºç çš„fit_functionsæ–‡ä»¶å¤¹ä¸‹ï¼Œé‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆã€‚</p><h4 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h4><p>ä»¥fitä¸ºä¾‹ï¼Œtimelineæä¾›çš„å…¶ä½™å¤„ç†æ•°æ®çš„æ–¹æ³•ï¼Œå¦‚ï¼Œmutilplyç­‰éƒ½æ˜¯åœ¨åŸæœ‰æ•°æ®æ¡¶è¿›è¡Œæ“ä½œï¼ŒåŸæœ‰æ•°æ®æ¡¶æ˜¯é€šè¿‡.esç”Ÿæˆï¼Œå¦‚ä½•èƒ½æ§åˆ¶åŸæœ‰æ•°æ®æ¡¶å‘¢ï¼Ÿ</p><h3 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h3><ul><li>åˆ›å»ºä¸€æ¡æ›²çº¿ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;)</span><br></pre></td></tr></table></figure><ul><li>ç»˜ä¸¤æ¡æ›²çº¿ï¼Œoffsetä»£è¡¨æ—¶é—´é—´éš”,offset=-1hä¸ºå‰ä¸€ä¸ªå°æ—¶</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;), .es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;)</span><br></pre></td></tr></table></figure><ul><li>.label()ä¸ºæ›²çº¿æ·»åŠ æè¿°ï¼Œå¦‚ä¸¤æ¡æ›²çº¿å¯åˆ†åˆ«æ·»åŠ å¢åŠ å¯è§†åŒ–ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;)</span><br></pre></td></tr></table></figure><ul><li>title()æ–¹æ³•ä¸ºæ—¶åºå›¾æ·»åŠ æ ‡é¢˜ã€‚ä½¿ç”¨æ–¹æ³•ä¸ºæ·»åŠ åˆ°æœ€å</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;)</span><br></pre></td></tr></table></figure><ul><li>.linesä¸ºæ›²çº¿è®¾ç½®appearanceï¼Œ.lines(fill=1,width=0.5)ä¸ºå¡«å……1ï¼Œå®½åº¦ä¸º1ã€‚é»˜è®¤æ›²çº¿ä¸ºå¡«å……0å®½1</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;)</span><br></pre></td></tr></table></figure><ul><li>.color()ä¸ºæ›²çº¿è®¾ç½®é¢œè‰²ï¼ŒåŒ…æ‹¬å…¶label,å¦‚color(gray)ï¼Œä¹Ÿå¯ç›´æ¥ä½¿ç”¨é¢œè‰²å€¼color(#1E90FF)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;).color(#1E90FF)</span><br></pre></td></tr></table></figure><ul><li>.legend()è®¾ç½®ä½ç½®å’Œå›¾ä¾‹çš„æ ·å¼ã€‚</li></ul><blockquote><p>For this example, place the legend in the north west position of the visualization with two columns by appending .legend(columns=2, position=nw)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;).color(#1E90FF).legend(columns=2, position=nw)</span><br></pre></td></tr></table></figure><ul><li><p>ä½¿ç”¨æ•°å­¦è®¡ç®—</p></li><li><p>max å–æœ€å¤§å€¼, ä½¿ç”¨åœ¨metricä¸­ï¼Œå¦‚metric=max:system.network.in.bytes</p></li><li><p>derivative å–å¯¼æ•°ï¼Œ .esè¿”å›å¯¹è±¡çš„æ–¹æ³•</p></li><li><p>multiply ä¹˜æ³•ï¼Œ å‰é¢çš„åº”è¯¥ä¸ºæ•°å­—åºåˆ—</p></li><li><p>divide é™¤æ³•ï¼Œå‰é¢çš„åº”è¯¥ä¸ºæ•°å­—åºåˆ—</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.in.bytes).derivative().divide(1048576).lines(fill=2, width=1).color(green).label(&quot;Inbound traffic&quot;).title(&quot;Network traffic (MB/s)&quot;), .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.out.bytes).derivative().multiply(-1).divide(1048576).lines(fill=2, width=1).color(blue).label(&quot;Outbound traffic&quot;).legend(columns=2, position=nw)</span><br></pre></td></tr></table></figure><p> //è¿™ä¸ªç¤ºä¾‹ï¼Œæ˜¯ç»˜åˆ¶å‡ºå…¥ç½‘æµï¼Œå…³å¿ƒçš„æ˜¯å˜åŒ–ç‡ï¼Œæ‰€ä»¥å–å¯¼æ•°ï¼Œbytes to megabyteså•ä½æ¢ç®—æ‰€ä»¥é™¤ä»¥1024*1024ï¼Œå†åˆ™ï¼Œå‡ºç›¸å¯¹äºå…¥ï¼Œåœ¨ä¸€å‰¯å›¾ä¸­æ˜¾ç¤ºä¸ºå¢å¼ºè§†å›¾æ„Ÿï¼Œä¾¿ä¸€ä¸ªçš„å€¼&gt;0,ä¸€ä¸ª&lt;0æ¥è¡¨ç¤ºï¼Œæ•…å‡ºçš„çº¿ä¹˜-1</p><ul><li><p>ä½¿ç”¨æ¡ä»¶ if ()ï¼Œ å‚æ•°ä¸º(eq/ne.. , value, then do, else do)//then doã€else doæ²¡æœ‰çš„å°±å†™null</p></li><li><p>eq ==</p></li><li><p>ne !=</p></li><li><p>lt &lt;</p></li><li><p>lte &lt;=</p></li><li><p>gt &gt;</p></li><li><p>gte &gt;=</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;).if(gt,12500000000,.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;),null).label(&apos;warning&apos;).color(&apos;#FFCC11&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;).if(gt,15000000000,.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, =&apos;max:system.memory.actual.used.bytes&apos;),null).label(&apos;severe&apos;).color(&apos;red&apos;)</span><br></pre></td></tr></table></figure><p> //è¿™ä¸ªç¤ºä¾‹å‘¢ï¼Œæ˜¯å¤§äº12500000000çš„ç»˜åˆ¶ä¸€ç§ï¼Œå¤§äº15000000000ç»˜åˆ¶ä¸€ç§ï¼Œçœ‹å¾—å‡ºæ¥ifå¿…é¡»ä½œä¸º.esè¿”å›å¯¹è±¡çš„æ–¹æ³•ï¼Œæ•…æœ‰ä¸¤ç§ä¸åŒåˆ¤æ–­å°±å¾—å†™ä¸¤ä¸ªç›¸åŒçš„.esã€‚</p><ul><li>è¶‹åŠ¿ï¼Œå–æ•°æ®ä¸ªæ•°çš„çª—å£çš„å¹³å‡å€¼è¿çº¿ã€‚å¯¹äºæ¶ˆé™¤æ—¶é—´è¿ç»­æ¥è¯´æ˜¯æå¥½çš„é€‰æ‹©</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.es().if(lt, 500, null).if(gte, 500, 1000)</span><br><span class="line">.es().if(lt, 500, 0, 1000)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- mvavg()ï¼Œå¦‚mvavgï¼ˆ10ï¼‰</span><br></pre></td></tr></table></figure><ul><li>.bars, .lines, .pointæ”¹å˜å±•ç°å½¢å¼çš„ï¼Œ.pointæ˜¯åœ†å½¢</li></ul>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>elastic_kibana</title>
      <link href="/2017/10/14/elastic-kibana/"/>
      <url>/2017/10/14/elastic-kibana/</url>
      
        <content type="html"><![CDATA[<h2 id="ESæ•°ç»„å¯¹è±¡ï¼Œä»¥åŠKibanaç›¸å…³æ“ä½œ"><a href="#ESæ•°ç»„å¯¹è±¡ï¼Œä»¥åŠKibanaç›¸å…³æ“ä½œ" class="headerlink" title="ESæ•°ç»„å¯¹è±¡ï¼Œä»¥åŠKibanaç›¸å…³æ“ä½œ"></a>ESæ•°ç»„å¯¹è±¡ï¼Œä»¥åŠKibanaç›¸å…³æ“ä½œ</h2><p>å¥½ä¹…æœªå†™è¿‡åšå®¢ï¼Œä¸€æ™ƒå°±å¹´åº•ã€‚</p><p>å‰ä¸¤å¤©éœ€æ±‚æ˜¯åœ¨Kibanaé‡Œç”Ÿæˆæ›²çº¿ï¼Œå…³é”®æ˜¯æ•°æ®ç±»å‹æ˜¯æ•°ç»„å¯¹è±¡ã€‚ç¨å¾®èµ°äº†å†™æ­ªè·¯ï¼Œä¸‹é¢ä»æ•°æ®ç±»å‹å¼€å§‹è¯´èµ·ã€‚</p><h3 id="æ•°æ®"><a href="#æ•°æ®" class="headerlink" title="æ•°æ®"></a>æ•°æ®</h3><ul><li><p>mapping:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">properties: &#123;</span><br><span class="line">data_value: &#123;</span><br><span class="line">type: &quot;long&quot;</span><br><span class="line">&#125;,</span><br><span class="line">index: &#123;</span><br><span class="line">type: &quot;long&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//example1:</span><br><span class="line">&#123;data: [&#123;index: 0, data_value: 200&#125;, &#123;index: 1, data_value: 300&#125;]&#125;</span><br><span class="line"></span><br><span class="line">//example2:</span><br><span class="line">&#123;data: [&#123;index: 0, data_value: 200&#125;]&#125;</span><br></pre></td></tr></table></figure><p>å³dataä¸ºæ•°ç»„å¯¹è±¡ï¼Œæ¯æ¬¡å«æœ‰çš„indexçš„æœ‰å¯èƒ½æ˜¯å¤šä¸ªï¼Œæœ‰å¯èƒ½æ˜¯1ä¸ªã€‚</p></li><li><p>æ•°ç»„å¯¹è±¡åœ¨esä¸­çš„å­˜å‚¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//example1:</span><br><span class="line">&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">   index: [0, 1],</span><br><span class="line">   data_value: [200, 300],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ElasticSearchä¸­å¯¹æ•°ç»„å¯¹è±¡çš„è®¿é—®å¯é€šè¿‡data.indexï¼Œdata.data_valueçš„å½¢å¼è¿›è¡Œã€‚ç¤ºä¾‹ä¸­example1çš„å­˜å‚¨å¦‚ä¸Šæ‰€ç¤ºï¼Œ0å’Œ200ï¼Œ1å’Œ300ä¹‹é—´çš„å…³ç³»å…¶å®å°±ä¸å†å­˜åœ¨äº†ã€‚</p><p>å½“æ—¶æˆ‘çš„éœ€æ±‚æ˜¯ï¼Œéœ€è¦å¯¹indexè¿›è¡Œåˆ†æ¡¶ï¼Œé’ˆå¯¹æ¯ä¸ªindexï¼Œæ±‚å‡ºmetricã€‚å¦‚åœ¨index=0çš„æ¡¶é‡Œï¼Œæ±‚data.data_valueçš„max,æ¡¶é‡Œè¾¹åªæœ‰example1å’Œexample2çš„æ•°æ®ï¼Œç†æƒ³ä¸­çš„maxåº”è¯¥æ˜¯200,ä½†æ±‚å‡ºæ¥å‘ç°æ˜¯300â€¦é—®é¢˜å°±åœ¨å­˜å‚¨ä¸Šï¼Œdata.data_valueåœ¨å­˜å‚¨ä¸Šå…¶å®æ˜¯[200, 300],ä¸index=0è¿˜æ˜¯1ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰..</p><p>å¦‚æœéè¦å®ç°å¯¹index=0ä¸‹æ±‚data_valueçš„maxå‘¢?</p></li></ul><h3 id="Scripted-Fields"><a href="#Scripted-Fields" class="headerlink" title="Scripted Fields"></a>Scripted Fields</h3><p>å½“æ—¶éœ€æ±‚æ˜¯åœ¨Kibanaä¸Šå®ç°ï¼Œæ•…ä»¥ä¸‹çš†ä»¥Kibanaä½œä¾‹ï¼Œè‹¥æ˜¯å•çº¯çš„å†™ESçš„æŸ¥è¯¢æˆ–èšåˆè¯­å¥ï¼Œå¯ç›´æ¥å‚è€ƒscriptå†…å®¹ã€‚</p><p><a href="https://www.elastic.co/guide/en/kibana/current/scripted-fields.html" target="_blank" rel="noopener">How to create Kibana Script Fields</a></p><p> åœ¨ESä¸­æ”¯æŒæŸ¥è¯¢è¿”å›ä¸€ä¸ªscript value,å³åœ¨æŸ¥è¯¢æ—¶å°±è¿›è¡Œç›¸åº”çš„scriptè®¡ç®—ã€‚<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-script-fields.html" target="_blank" rel="noopener">elasticsearch script fields starting</a>.</p><p> æ—¢ç„¶æ˜¯scriptï¼Œè‡ªç„¶å°±çµæ´»å¾ˆå¤šï¼Œå¯ä»¥é€šè¿‡æ·»åŠ æ–°çš„å­—æ®µï¼Œå°†ä¸Šé¢çš„æ•°ç»„å¯¹è±¡ä¸­çš„å€¼è½¬æ¢ä¸ºkey-valueæ ¼å¼çš„ï¼Œé‚£ä¹ˆåœ¨èšåˆç»Ÿè®¡æ“ä½œä¸­é€‰æ‹©å¯¹åº”çš„keyå³å¯ã€‚</p><p> å…·ä½“æ“ä½œä¸ºï¼Œåœ¨Kibanaä¸­é€‰æ‹©Managementä¸­çš„Index Patterns,é€‰ä¸­å¯¹åº”index,é€‰æ‹©Scripted fieldï¼Œæ–°å»ºä¸€ä¸ª(Add Scripted Field)ã€‚Nameå¡«å…¥å¦‚data_index_0,Languageé€‰æ‹©painless,Typeé€‰æ‹©ä¸ºnumberã€‚scriptå†…å®¹ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  if(params[&apos;_source&apos;][&apos;data&apos;] != null) &#123;</span><br><span class="line">  for(def item : params[&apos;_source&apos;][&apos;data&apos;]) &#123;</span><br><span class="line">     if(item.index == 0)</span><br><span class="line">       return item.data_value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">return null;</span><br></pre></td></tr></table></figure><p> æœ€åé€‰æ‹©åˆ›å»ºå­—æ®µå³å¯ï¼Œåœ¨Discoveré¡µé¢ä¸­å³å¯çœ‹åˆ°æ¯æ¡æ•°æ®ä¸­éƒ½å¢åŠ äº†data_index_0,å…¶å€¼ä¸ºindex=0æ—¶å¯¹åº”çš„data_valueã€‚è¿™æ ·å°±å°†å¯¹è±¡æ•°ç»„ä¸­çš„æ•°æ®æ¬å‡ºæ¥ä»¥key-valueçš„æ–¹å¼å­˜åœ¨äº†ã€‚å¦å¤–ï¼Œå®˜æ–¹åœ¨ä»‹ç»Scripted Fieldsæ—¶è¯´æ˜å°½é‡ä¸è¦ä½¿ç”¨_sourceå­—æ®µï¼Œä¼šä½¿æœç´¢å˜æ…¢ï¼Œä»¥ååœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æœ€å¥½è¿˜æ˜¯ä½¿ç”¨docã€‚å¦‚è·å¾—data.indexçš„æ–¹å¼ä¸ºdoc[â€˜data.indexâ€™].values,è¿”å›å€¼ä¸ºListã€‚</p>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>elastic-search-dsl</title>
      <link href="/2017/10/14/elastic-search-dsl/"/>
      <url>/2017/10/14/elastic-search-dsl/</url>
      
        <content type="html"><![CDATA[<h2 id="æŸ¥è¯¢ElasticSearch"><a href="#æŸ¥è¯¢ElasticSearch" class="headerlink" title="æŸ¥è¯¢ElasticSearch"></a>æŸ¥è¯¢ElasticSearch</h2><p>åŸºäºä¹¦ ElasticSearchæœåŠ¡å™¨å¼€å‘(ç¬¬äºŒç‰ˆ) å’Œå®˜ç½‘doc(5.5)åšçš„ç›¸åº”æ•´ç†ã€‚</p><p>ç²—ç•¥æ€»ç»“ä¸‹ï¼ŒæŸ¥è¯¢è¯­å¥åˆ†ä¸ºç®€å•æŸ¥è¯¢å’Œå¤åˆæŸ¥è¯¢ï¼Œå¤åˆæŸ¥è¯¢æ˜¯ç”±ç®€å•æŸ¥è¯¢åŒ…è£…ï¼Œç®€å•æŸ¥è¯¢å¯ä½œä¸ºå¤åˆæŸ¥è¯¢çš„å­å¥ï¼Œå¦‚boolæŸ¥è¯¢ç¤ºä¾‹ã€‚ç®€å•æŸ¥è¯¢åˆåˆ†ä¸ºfull-textå’Œexactï¼Œmatchç›¸å…³çš„ä¸ºfull-textæŸ¥è¯¢ï¼ŒæŸ¥è¯¢çš„æ˜¯ç»åˆ†æåçš„å­—æ®µï¼Œtermç›¸å…³ä¸ºç¡®åˆ‡æŸ¥è¯¢ä¸ºå®Œæ•´å­—æ®µã€‚</p><h3 id="ç®€å•æŸ¥è¯¢"><a href="#ç®€å•æŸ¥è¯¢" class="headerlink" title="ç®€å•æŸ¥è¯¢"></a>ç®€å•æŸ¥è¯¢</h3><p>ç®€å•æŸ¥è¯¢ä¸ºé’ˆå¯¹æŸä¸€ç‰¹å®šfieldä¸ºæŸä¸€ç‰¹å®švalueè¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚match, term, rangeã€‚</p><h4 id="match-all"><a href="#match-all" class="headerlink" title="match_all"></a>match_all</h4><p>æŸ¥è¯¢æ‰€æœ‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">       &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="match"><a href="#match" class="headerlink" title="match"></a>match</h4><ul><li>matchå¸ƒå°”æŸ¥è¯¢</li></ul><p>ä¼šå°†valueæ‹¿å‡ºæ¥åŠ ä»¥åˆ†æï¼Œç„¶åæ„å»ºç›¸åº”çš„æŸ¥è¯¢ã€‚åˆ†æå™¨é»˜è®¤ä¸ºåˆ›å»ºç´¢å¼•æ—¶ç›¸åŒçš„åˆ†æå™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// æŸ¥è¯¢messageå­—æ®µæœ‰&quot;this&quot; or &quot;is&quot; or &quot;a&quot; or &quot;test&quot;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">       &quot;match&quot; : &#123;</span><br><span class="line">           &quot;message&quot; : &quot;this is a test&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¾‹ï¼Œåˆ†æåå°†äº§ç”Ÿ4ä¸ªtextï¼Œ ç±»ä¼¼ä¸ºå¤šæ¡ä»¶ï¼Œä½¿ç”¨operatorå¯è®¾ç½®å¤šæ¡ä»¶çš„è¿æ¥çº½å¸¦ï¼Œor/andï¼Œé»˜è®¤æ˜¯orã€‚minimum_should_matchå‚æ•°ä¸ºè®¾ç½®æ»¡è¶³æ¡ä»¶æœ€å°æ•°ã€‚analyzerå‚æ•°è®¾ç½®åˆ†æå™¨ã€‚å¦å¤–ï¼Œè¿˜æ”¯æŒç›¸å…³fuzzinessæ¨¡ç³ŠæŸ¥è¯¢ï¼Œä»¥åŠé«˜é¢‘è¯/ä½é¢‘è¯æŸ¥è¯¢ï¼Œè¿™ä¸ªè·Ÿä¹¦ä¸Šçš„å·®ä¸å¤š(3.3.5)ã€‚</p><ul><li>match_phrase</li></ul><p>è·Ÿmatchå¸ƒå°”æŸ¥è¯¢ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼Œä»åˆ†æåçš„æ–‡æœ¬ä¸­æ„å»ºçŸ­è¯­æŸ¥è¯¢ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢this testä¹‹é—´å…è®¸æœ‰2ä¸ªè¯æ¡çš„çŸ­è¯­ã€‚åˆ™äº¦èƒ½åŒ¹é…åˆ°&quot;this is a test&quot;</span><br><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_phrase&quot; : &#123;</span><br><span class="line">            &quot;message&quot; : &#123;</span><br><span class="line">                &quot;query&quot;: &quot;this test&quot;,</span><br><span class="line">                &quot;slop&quot;:2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>match_phrase_prefix</li></ul><p>åœ¨match_phraseçš„åŸºç¡€ä¸Šå¢åŠ äº†å…è®¸æŸ¥è¯¢æ–‡æœ¬çš„æœ€åä¸€ä¸ªè¯æ¡åªåšå‰ç¼€åŒ¹é…ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">      &quot;match_phrase_prefix&quot; : &#123;</span><br><span class="line">          &quot;message&quot; : &quot;this is a t&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>multi match query</li></ul><p>ä¸matchæŸ¥è¯¢ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºå¯ä»¥åœ¨å¤šä¸ªfieldä¸­è¿›è¡ŒæŸ¥è¯¢ï¼ˆæŸ¥è¯¢å†…å®¹è¿˜æ˜¯ä¸€ä¸ªï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot; : &#123;</span><br><span class="line">      &quot;query&quot;:    &quot;this is a test&quot;,</span><br><span class="line">      &quot;fields&quot;: [ &quot;subject&quot;, &quot;message&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>common terms query</li></ul><p>å¸¸ç”¨è¯æŸ¥è¯¢ï¼Œå³å°†åˆ†æè¿‡åçš„è¯åˆ†ä¸ºé«˜é¢‘è¯å’Œä½é¢‘è¯è¿›è¡ŒæŸ¥è¯¢â€¦</p><ul><li>query string query</li></ul><p>æ”¯æŒLuceneæŸ¥è¯¢è¯­æ³•ã€‚</p><ul><li>simple query string query</li></ul><p>è·Ÿä¸Šé¢çš„query string queryå·®ä¸å¤šï¼Œä¸åŒçš„æ˜¯é”™è¯¯æ—¶ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œç›´æ¥ä¸¢å¼ƒæŸ¥è¯¢æ— æ•ˆçš„éƒ¨åˆ†ã€‚</p><h4 id="term"><a href="#term" class="headerlink" title="term"></a>term</h4><p>termæŸ¥è¯¢çš„è¯ï¼Œå°±æ˜¯ç¡®åˆ‡çš„ï¼Œæœªç»åˆ†æçš„è¯æ¡ã€‚</p><ul><li>term query</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//åŒ¹é…titleå­—æ®µä¸­å«æœ‰crimeä¸€è¯çš„æ–‡æ¡£</span><br><span class="line"> &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot; : &#123; &quot;title&quot; : &quot;crime&quot; &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>terms query</li></ul><p>å¤šè¯æ¡æŸ¥è¯¢ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">     &quot;terms&quot; : &#123;</span><br><span class="line">        &quot;user&quot; : [&quot;kimchy&quot;, &quot;elasticsearch&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="range-query"><a href="#range-query" class="headerlink" title="range query"></a>range query</h4><p>èŒƒå›´æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢ageåœ¨10åˆ°20å²ä¹‹å‰çš„æ–‡æ¡£</span><br><span class="line"> &quot;query&quot;: &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">            &quot;age&quot; : &#123;</span><br><span class="line">                &quot;gte&quot; : 10,</span><br><span class="line">                &quot;lte&quot; : 20</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //gte : Greater-than or equal to</span><br><span class="line">    //gt :  Greater-than</span><br><span class="line">    //lte : Less-than or equal to</span><br><span class="line">//lt : Less-than</span><br></pre></td></tr></table></figure><h4 id="exist-query"><a href="#exist-query" class="headerlink" title="exist query"></a>exist query</h4><p>ä¼šæ»¤æ‰ç»™å®šå­—æ®µä¸Šæ²¡æœ‰å€¼çš„æ–‡æ¡£,å³è¿”å›çš„æ–‡æ¡£å†ç»™å®šå­—æ®µä¸Šä¸€å®šæœ‰å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">       &quot;exists&quot; : &#123; &quot;field&quot; : &quot;user&quot; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="prefix-query"><a href="#prefix-query" class="headerlink" title="prefix query"></a>prefix query</h4><p>å‰ç¼€æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢userä»¥kiå¼€å¤´çš„æ–‡æ¡£</span><br><span class="line">&#123; &quot;query&quot;: &#123;</span><br><span class="line">    &quot;prefix&quot; : &#123; &quot;user&quot; : &quot;ki&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Wildcard-query"><a href="#Wildcard-query" class="headerlink" title="Wildcard query"></a>Wildcard query</h4><p>é€šé…ç¬¦æŸ¥è¯¢ï¼Œ*ï¼Œ?.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">       &quot;wildcard&quot; : &#123; &quot;user&quot; : &quot;ki*y&quot; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="regexp-query"><a href="#regexp-query" class="headerlink" title="regexp query"></a>regexp query</h4><p>æ­£åˆ™åŒ¹é…</p><h4 id="type-query"><a href="#type-query" class="headerlink" title="type query"></a>type query</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">       &quot;type&quot; : &#123;</span><br><span class="line">           &quot;value&quot; : &quot;my_type&quot;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="ids-query"><a href="#ids-query" class="headerlink" title="ids query"></a>ids query</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;ids&quot; : &#123;</span><br><span class="line">    &quot;type&quot; : &quot;my_type&quot;,</span><br><span class="line">    &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="constant-score-query"><a href="#constant-score-query" class="headerlink" title="constant score query"></a>constant score query</h4><p>ä¸ºæŸ¥è¯¢/è¿‡æ»¤è¿”å›çš„æ–‡æ¡£è¿”å›ä¸€ä¸ªå¸¸é‡å¾—åˆ†ã€‚</p><h3 id="å¤åˆæŸ¥è¯¢"><a href="#å¤åˆæŸ¥è¯¢" class="headerlink" title="å¤åˆæŸ¥è¯¢"></a>å¤åˆæŸ¥è¯¢</h3><p>ç”±ç®€å•æŸ¥è¯¢åŒ…è£…æˆ–ç»„åˆæŸ¥è¯¢ï¼Œæ¥è¿›è¡Œå¤šä¸ªæŸ¥è¯¢çš„é€»è¾‘ç»„åˆï¼Œå¦‚boolã€‚</p><ul><li>bool query</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// æŸ¥è¯¢useråŒ…å«kimchyçš„ï¼Œ tagåŒ…å«techçš„ï¼Œageåœ¨10åˆ°20ä¹‹å¤–çš„ï¼Œ æ¡ä»¶tagä¸­æœ‰wowå’Œelasticsearchè‡³å°‘æœ‰1ä¸ªæ¡ä»¶æ»¡è¶³</span><br><span class="line"> &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;must&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;tag&quot; : &quot;tech&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;age&quot; : &#123; &quot;gte&quot; : 10, &quot;lte&quot; : 20 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot; : [</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;elasticsearch&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; : 1,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>dis max query</li></ul><p>æœ€å¤§åˆ†æŸ¥è¯¢</p><ul><li>function_score</li></ul><blockquote><p>The function_score allows you to modify the score of documents that are retrieved by a query.</p></blockquote><ul><li>boosting</li></ul><blockquote><p>The boosting query can be used to effectively demote results that match a given query.</p></blockquote><ul><li>indices query</li></ul><p>ç´¢å¼•æŸ¥è¯¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">       &quot;indices&quot; : &#123;</span><br><span class="line">           &quot;indices&quot; : [&quot;index1&quot;, &quot;index2&quot;],</span><br><span class="line">           &quot;query&quot; : &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class="line">           &quot;no_match_query&quot; : &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;kow&quot; &#125; &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="script-query"><a href="#script-query" class="headerlink" title="script query"></a>script query</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot; : &#123;</span><br><span class="line">            &quot;must&quot; : &#123;</span><br><span class="line">                &quot;script&quot; : &#123;</span><br><span class="line">                    &quot;script&quot; : &#123;</span><br><span class="line">                        &quot;inline&quot; : &quot;doc[&apos;num1&apos;].value &gt; params.param1&quot;,</span><br><span class="line">                        &quot;lang&quot;   : &quot;painless&quot;,</span><br><span class="line">                        &quot;params&quot; : &#123;</span><br><span class="line">                            &quot;param1&quot; : 5</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="ç»“æ„åŒ–"><a href="#ç»“æ„åŒ–" class="headerlink" title="ç»“æ„åŒ–"></a>ç»“æ„åŒ–</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        ARGUMENT: VALUE,</span><br><span class="line">        ARGUMENT: VALUE</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹å®šfieldæ—¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        FIELD_NAME: &#123;</span><br><span class="line">            ARGUMENT: VALUE,</span><br><span class="line">            ARGUMENT: VALUE,...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤åˆqueryæ—¶ åŒ…ä¸Šç®€å•ç»“æ„çš„ã€‚å¦‚boolé‡ŒåŒ…matchå’Œrange</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">        &quot;must&quot;:     &#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;elasticsearch&quot; &#125;&#125;,</span><br><span class="line">        &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;name&quot;:  &quot;mary&quot; &#125;&#125;,</span><br><span class="line">        &quot;should&quot;:   &#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;full text&quot; &#125;&#125;,</span><br><span class="line">        &quot;filter&quot;:   &#123; &quot;range&quot;: &#123; &quot;age&quot; : &#123; &quot;gt&quot; : 30 &#125;&#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bool + bool</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">        &quot;must&quot;: &#123; &quot;match&quot;:   &#123; &quot;email&quot;: &quot;business opportunity&quot; &#125;&#125;,</span><br><span class="line">        &quot;should&quot;: [</span><br><span class="line">            &#123; &quot;match&quot;:       &#123; &quot;starred&quot;: true &#125;&#125;,</span><br><span class="line">            &#123; &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must&quot;:      &#123; &quot;match&quot;: &#123; &quot;folder&quot;: &quot;inbox&quot; &#125;&#125;,</span><br><span class="line">                &quot;must_not&quot;:  &#123; &quot;match&quot;: &#123; &quot;spam&quot;: true &#125;&#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;minimum_should_match&quot;: 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>curl -XGET â€˜localhost:9200/storm*/_analyze?field=message_infos.event.specificTypeâ€™ -d â€˜FRESH_AIR_VOLUME_LESSâ€™</p>]]></content>
      
      
      <categories>
          
          <category> elk </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>maven</title>
      <link href="/2017/10/14/maven/"/>
      <url>/2017/10/14/maven/</url>
      
        <content type="html"><![CDATA[<h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><h3 id="åæ ‡"><a href="#åæ ‡" class="headerlink" title="åæ ‡"></a>åæ ‡</h3><p>maven çš„æ‰€æœ‰æ„ä»¶å‡é€šè¿‡åæ ‡è¿›è¡Œç»„ç»‡å’Œç®¡ç†ã€‚maven çš„åæ ‡é€šè¿‡ 5 ä¸ªå…ƒç´ è¿›è¡Œå®šä¹‰ï¼Œå…¶ä¸­ groupIdã€artifactIdã€version æ˜¯å¿…é¡»çš„ï¼Œpackaging æ˜¯å¯é€‰çš„ï¼ˆé»˜è®¤ä¸ºjarï¼‰ï¼Œclassifier æ˜¯ä¸èƒ½ç›´æ¥å®šä¹‰çš„ã€‚</p><ul><li>groupIdï¼šå®šä¹‰å½“å‰ Maven é¡¹ç›®æ‰€å±çš„å®é™…é¡¹ç›®ï¼Œè·Ÿ Java åŒ…åç±»ä¼¼ï¼Œé€šå¸¸ä¸åŸŸååå‘ä¸€ä¸€å¯¹åº”ã€‚</li><li>artifactIdï¼šå®šä¹‰å½“å‰ Maven é¡¹ç›®çš„ä¸€ä¸ªæ¨¡å—ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMaven ç”Ÿæˆçš„æ„ä»¶ï¼Œå…¶æ–‡ä»¶åä¼šä»¥ artifactId å¼€å¤´ï¼Œå¦‚ hibernate-core-3.6.5.Final.jarã€‚</li><li>versionï¼šå®šä¹‰é¡¹ç›®ç‰ˆæœ¬ã€‚</li><li>packagingï¼šå®šä¹‰é¡¹ç›®æ‰“åŒ…æ–¹å¼ï¼Œå¦‚ jarï¼Œwarï¼Œpomï¼Œzip â€¦â€¦ï¼Œé»˜è®¤ä¸º jarã€‚</li><li>classifierï¼šå®šä¹‰é¡¹ç›®çš„é™„å±æ„ä»¶ï¼Œå¦‚ hibernate-core-3.6.6.Final-sources.jarï¼Œhibernate-core-3.6.6.Final-javadoc.jarï¼Œå…¶ä¸­ sources å’Œ javadoc å°±æ˜¯è¿™ä¸¤ä¸ªé™„å±æ„ä»¶çš„ classifierã€‚classifier ä¸èƒ½ç›´æ¥å®šä¹‰ï¼Œé€šå¸¸ç”±é™„åŠ çš„æ’ä»¶å¸®åŠ©ç”Ÿæˆã€‚</li></ul><h3 id="Mavenæä¾›çš„ä¸€äº›ç®¡ç†ä¾èµ–åŠŸèƒ½"><a href="#Mavenæä¾›çš„ä¸€äº›ç®¡ç†ä¾èµ–åŠŸèƒ½" class="headerlink" title="Mavenæä¾›çš„ä¸€äº›ç®¡ç†ä¾èµ–åŠŸèƒ½"></a>Mavenæä¾›çš„ä¸€äº›ç®¡ç†ä¾èµ–åŠŸèƒ½</h3><ul><li>Dependency mediation: å½“å‡ºç°ä¾èµ–é¡¹ç›®ä¸ºå¤šä¸ªç‰ˆæœ¬æ—¶ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ã€‚å¦‚æœä¸¤ä¸ªç‰ˆæœ¬åœ¨ä¾èµ–æ ‘ä¸Šå¤„äºç›¸åŒæ·±åº¦æ—¶ï¼Œå…ˆå®šä¹‰çš„ä¾èµ–ç‰ˆæœ¬å°†ä¼šè¢«ä½¿ç”¨ã€‚</li><li>Dependency management: ä¾èµ–ä¼ é€’æ—¶ï¼Œä¼šä½¿ç”¨ç›´æ¥æŒ‡å®šçš„ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼ŒB &lt; C, åœ¨Cä¸­å®šä¹‰ä¾èµ–æ—¶åœ¨å®ƒçš„dependencyManagementéƒ¨åˆ†ç›´æ¥æŒ‡å®šBçš„ç‰ˆæœ¬ï¼Œåœ¨Cè¢«ä¾èµ–æ—¶ï¼Œå°†ä¼šä½¿ç”¨å¯¹åº”Bçš„ç‰ˆæœ¬ã€‚</li><li>Dependency scope: æŒ‰æ„å»ºé˜¶æ®µåŒ…å«ä¾èµ–</li><li>Excluded dependencies: ä¼ é€’ä¾èµ–æ—¶å¯åœ¨â€œexclusionâ€å…ƒç´ ä¸­æ’é™¤ä¾èµ–ã€‚ä¾‹å¦‚ï¼ŒBæ˜¯Açš„ä¾èµ–ï¼ŒCæ˜¯Bçš„ä¾èµ–ï¼ŒAå¯ä»¥æ’é™¤Cä½œä¸ºä¾èµ–</li><li>Optional dependencies: ä¾èµ–ä¼ é€’æ—¶ï¼Œå¯ä½¿ç”¨â€optionalâ€å°†ä¾èµ–æ ‡è®°ä¸ºå¯é€‰é¡¹ã€‚ä¾‹å¦‚ï¼ŒBæ˜¯Açš„ä¾èµ–ï¼ŒCæ˜¯Bçš„ä¾èµ–ï¼Œç„¶åBæ ‡è®°Cæ˜¯å¯é€‰é¡¹çš„ï¼Œé‚£ä¹ˆAå°†ä¸ä¼šä½¿ç”¨Cã€‚</li></ul><p>ç²˜è´´ä¸€ä¸‹åˆ«äººçš„å¤§ç™½è¯ï¼š</p><h4 id="ä¾èµ–å†²çª"><a href="#ä¾èµ–å†²çª" class="headerlink" title="ä¾èµ–å†²çª"></a>ä¾èµ–å†²çª</h4><p>é€šå¸¸æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä¼ é€’æ€§ä¾èµ–ï¼Œå½“å¤šä¸ªä¼ é€’æ€§ä¾èµ–ä¸­æœ‰å¯¹åŒä¸€æ„ä»¶ä¸åŒç‰ˆæœ¬çš„ä¾èµ–æ—¶ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p><ul><li>çŸ­è·¯å¾„ä¼˜å…ˆï¼šå‡å¦‚æœ‰ä»¥ä¸‹ä¾èµ–ï¼šA -&gt; B -&gt; C -&gt;X(ç‰ˆæœ¬ 1.0) å’Œ A -&gt; D -&gt; X(ç‰ˆæœ¬ 2.0)ï¼Œåˆ™ä¼˜å…ˆè§£æè¾ƒçŸ­è·¯å¾„çš„ X(ç‰ˆæœ¬ 2.0)ï¼›</li><li>å…ˆå£°æ˜ä¼˜å…ˆï¼šè‹¥è·¯å¾„é•¿åº¦ç›¸åŒï¼Œåˆ™è°å…ˆå£°æ˜ï¼Œè°è¢«è§£æã€‚</li></ul><h4 id="ä¾èµ–æ’é™¤"><a href="#ä¾èµ–æ’é™¤" class="headerlink" title="ä¾èµ–æ’é™¤"></a>ä¾èµ–æ’é™¤</h4><p>é’ˆå¯¹ä¾èµ–å†²çªä¸­çš„â€œçŸ­è·¯å¾„ä¼˜å…ˆâ€ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨é•¿è·¯å¾„çš„ä¾èµ–æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ—¶å¯ä»¥ä½¿ç”¨ä¾èµ–æ’é™¤ <exclusions> å…ƒç´ ï¼Œæ˜¾ç¤ºæ’é™¤çŸ­è·¯å¾„ä¾èµ–ã€‚åœ¨éå†²çªçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•åŒæ ·æœ‰æ•ˆã€‚</exclusions></p><h4 id="ä¾èµ–å½’ç±»"><a href="#ä¾èµ–å½’ç±»" class="headerlink" title="ä¾èµ–å½’ç±»"></a>ä¾èµ–å½’ç±»</h4><p>é€šå¸¸åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¼šåŒæ—¶ä¾èµ–åŒä¸€ä¸ªæ„ä»¶çš„ä¸åŒæ¨¡å—ï¼Œå¦‚ spring-orm-3.2.0ï¼Œspring-context-3.2.0ï¼Œä¸”å¤šä¸ªæ¨¡å—ç‰ˆæœ¬ç›¸åŒï¼Œä¸ºäº†ç»´æŠ¤å’Œå‡çº§æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶åŒä¸€ç®¡ç†ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨åˆ° Maven å±æ€§ï¼Œç±»ä¼¼äºå˜é‡çš„æ¦‚å¿µã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;springframework.version&gt;3.2.0.RELEASE&lt;/springframework.version&gt;</span><br><span class="line"> &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line"> &lt;dependencies&gt;</span><br><span class="line">     &lt;dependency&gt;</span><br><span class="line">         &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">         &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;</span><br><span class="line">         &lt;version&gt;$&#123;springframework.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;springframework.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><p>â€“</p><h2 id="Maven-Test"><a href="#Maven-Test" class="headerlink" title="Maven Test"></a>Maven Test</h2><ol><li><p>æ–°å»ºæµ‹è¯•ç±»ï¼Œnew JUnit Case Test</p></li><li><p>æ–°å»ºç±»æ—¶é€‰æ‹©çš„å‡ ä¸ªæ–¹æ³•çš„è§£é‡Šã€‚    </p><ul><li>setUpï¼š æµ‹è¯•å‰çš„åˆå§‹åŒ–å·¥ä½œ</li><li>tearDown: æµ‹è¯•å®Œæˆååƒåœ¾å›æ”¶å·¥ä½œ</li><li>constructor: æ„é€ æ–¹æ³•</li></ul></li><li><p>å‡ ç§æ ‡æ³¨çš„ä»‹ç»ã€‚</p><ul><li>@Test,è¡¨ç¤ºè¿™ä¸ªæ˜¯æµ‹è¯•æ–¹æ³•</li><li>@Before,è¿™ä¸ªæ–¹æ³•ä¼šåœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•å‰éƒ½æ‰§è¡Œä¸€æ¬¡</li><li>@After,è¿™ä¸ªæ–¹æ³•ä¼šåœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•åéƒ½æ‰§è¡Œä¸€æ¬¡</li><li>@Ignore, è¡¨ç¤ºè¿™ä¸ªæ–¹æ³•åœ¨æµ‹è¯•çš„æ—¶å€™ä¼šè¢«å¿½ç•¥</li><li>@BeforeClass, åªåœ¨æµ‹è¯•ç”¨ä¾‹åˆå§‹åŒ–æ—¶æ‰§è¡Œ</li><li>@AfterClass,ï¼Œå½“æ‰€æœ‰æµ‹è¯•æ‰§è¡Œå®Œæ¯•ä¹‹åè¿›è¡Œæ”¶å°¾å·¥ä½œ</li><li>æ¯ä¸ªæµ‹è¯•ç±»åªèƒ½æœ‰ä¸€ä¸ªæ–¹æ³•è¢«æ ‡æ³¨ä¸º @BeforeClass æˆ– @AfterClass ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•å¿…é¡»æ˜¯ Public å’Œ Static çš„ã€‚</li><li>@Test(timeout  =   1000 )  é™æ—¶æµ‹è¯•</li><li>@Test(expected  =  ArithmeticException. class ) å¼‚å¸¸æµ‹è¯•</li><li>å‚æ•°åŒ–æµ‹è¯•ï¼Œè¿™ä¸ªä»¥ä»£ç æ¥è§£é‡Šæ€ä¹ˆç”¨ã€‚ä¸‹é¢çš„æµ‹è¯•æ•°æ®æ˜¯3ç»„ï¼Œä¼šæœ‰3æ¬¡ç»“æœã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class SquareTest &#123;</span><br><span class="line"></span><br><span class="line">private static Calculator calculator = new Calculator();</span><br><span class="line">private int param;</span><br><span class="line">private int result;</span><br><span class="line"></span><br><span class="line">@Parameters</span><br><span class="line">      public   static  Collection data()  &#123;</span><br><span class="line">          return  Arrays.asList( new  Object[][] &#123;</span><br><span class="line">                  &#123; 2 ,  4 &#125; ,</span><br><span class="line">                  &#123; 0 ,  0 &#125; ,</span><br><span class="line">                  &#123;ï¼ 3 ,  9 &#125; ,</span><br><span class="line">         &#125; );</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">// æ„é€ å‡½æ•°ï¼Œå¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">public SquareTest(int param, int result) &#123;</span><br><span class="line">this.param = param;</span><br><span class="line">this.result = result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void square() &#123;</span><br><span class="line">calculator.square(param);</span><br><span class="line">assertEquals(result, calculator.getResult());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨mvn testè¿›è¡Œæµ‹è¯•</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
