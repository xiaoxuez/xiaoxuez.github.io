{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/cactus/source/css/rtl.styl","path":"css/rtl.styl","modified":1,"renderable":1},{"_id":"themes/cactus/source/css/style.styl","path":"css/style.styl","modified":1,"renderable":1},{"_id":"themes/cactus/source/images/apple-touch-icon.png","path":"images/apple-touch-icon.png","modified":1,"renderable":1},{"_id":"themes/cactus/source/images/favicon-192x192.png","path":"images/favicon-192x192.png","modified":1,"renderable":1},{"_id":"themes/cactus/source/js/main.js","path":"js/main.js","modified":1,"renderable":1},{"_id":"themes/cactus/source/images/favicon.ico","path":"images/favicon.ico","modified":1,"renderable":1},{"_id":"themes/cactus/source/js/search.js","path":"js/search.js","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/clipboard/clipboard.min.js","path":"lib/clipboard/clipboard.min.js","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff","path":"lib/vazir-font/Vazir-Black.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff2","path":"lib/vazir-font/Vazir-Black.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff","path":"lib/vazir-font/Vazir-Bold.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff2","path":"lib/vazir-font/Vazir-Bold.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff2","path":"lib/vazir-font/Vazir-Light.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff","path":"lib/vazir-font/Vazir-Light.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff","path":"lib/vazir-font/Vazir-Medium.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff2","path":"lib/vazir-font/Vazir-Medium.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff","path":"lib/vazir-font/Vazir-Thin.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff2","path":"lib/vazir-font/Vazir-Thin.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/font-face.css","path":"lib/vazir-font/font-face.css","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff","path":"lib/vazir-font/Vazir.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff2","path":"lib/vazir-font/Vazir.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/images/logo.png","path":"images/logo.png","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/jquery/jquery.min.js","path":"lib/jquery/jquery.min.js","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.ttf","path":"lib/vazir-font/Vazir-Black.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.eot","path":"lib/vazir-font/Vazir-Black.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.eot","path":"lib/vazir-font/Vazir-Bold.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.ttf","path":"lib/vazir-font/Vazir-Bold.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.eot","path":"lib/vazir-font/Vazir-Light.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.ttf","path":"lib/vazir-font/Vazir-Light.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.eot","path":"lib/vazir-font/Vazir-Medium.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.ttf","path":"lib/vazir-font/Vazir-Medium.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.eot","path":"lib/vazir-font/Vazir-Thin.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.ttf","path":"lib/vazir-font/Vazir-Thin.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.eot","path":"lib/vazir-font/Vazir.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.ttf","path":"lib/vazir-font/Vazir.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.eot","path":"lib/font-awesome/webfonts/fa-regular-400.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.ttf","path":"lib/font-awesome/webfonts/fa-regular-400.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff","path":"lib/font-awesome/webfonts/fa-regular-400.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/justified-gallery/css/justifiedGallery.min.css","path":"lib/justified-gallery/css/justifiedGallery.min.css","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/justified-gallery/js/jquery.justifiedGallery.min.js","path":"lib/justified-gallery/js/jquery.justifiedGallery.min.js","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff","path":"lib/font-awesome/webfonts/fa-brands-400.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.ttf","path":"lib/font-awesome/webfonts/fa-brands-400.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff","path":"lib/font-awesome/webfonts/fa-solid-900.woff","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.eot","path":"lib/font-awesome/webfonts/fa-brands-400.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.svg","path":"lib/font-awesome/webfonts/fa-regular-400.svg","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.eot","path":"lib/font-awesome/webfonts/fa-solid-900.eot","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Italic.ttf","path":"lib/meslo-LG/MesloLGM-Italic.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGM-BoldItalic.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGS-BoldItalic.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.ttf","path":"lib/font-awesome/webfonts/fa-solid-900.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGL-BoldItalic.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Italic.ttf","path":"lib/meslo-LG/MesloLGS-Italic.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Italic.ttf","path":"lib/meslo-LG/MesloLGL-Italic.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Bold.ttf","path":"lib/meslo-LG/MesloLGS-Bold.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Bold.ttf","path":"lib/meslo-LG/MesloLGM-Bold.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Regular.ttf","path":"lib/meslo-LG/MesloLGM-Regular.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Regular.ttf","path":"lib/meslo-LG/MesloLGS-Regular.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Regular.ttf","path":"lib/meslo-LG/MesloLGL-Regular.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Bold.ttf","path":"lib/meslo-LG/MesloLGL-Bold.ttf","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.svg","path":"lib/font-awesome/webfonts/fa-solid-900.svg","modified":1,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.svg","path":"lib/font-awesome/webfonts/fa-brands-400.svg","modified":1,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"7625da6180505b0dd4bee6c710cd4e805ea54598","modified":1571037787793},{"_id":"themes/cactus/.gitignore","hash":"c5345a2c5fa6c136dbe2020a405e541b4755a259","modified":1570532430816},{"_id":"themes/cactus/LICENSE","hash":"346ece39a983b0e7858c11f785cd846cef9eb875","modified":1570532430817},{"_id":"themes/cactus/.stylintrc","hash":"eb5f48e83657928cb0cbee031373b2cd36ca0083","modified":1570532430816},{"_id":"themes/cactus/README.md","hash":"859d11941c46be4f7b4a6d62297ccbeb4f732bc9","modified":1570532430817},{"_id":"themes/cactus/.jshintrc","hash":"2548bd6ce44422edc7e6f9f68061ab47f26c4f57","modified":1570532430816},{"_id":"themes/cactus/gulpfile.js","hash":"2bae290993507026a509665ee5a5326b616f8d68","modified":1570532430817},{"_id":"themes/cactus/_config.yml","hash":"7ef7291bd08dc0556ee8821bb0630e06f20fe816","modified":1571039430082},{"_id":"themes/cactus/package.json","hash":"5bbdbc429e9d46acf97baf7ac5654edde0781064","modified":1570532430823},{"_id":"source/_data/projects.json","hash":"40a1da9035cf239083c12e2b5e09782d638f9ca0","modified":1571205336932},{"_id":"source/about/index.md","hash":"3d13a37e2e8a753b914f63c3976462a4eda66b9a","modified":1570531791007},{"_id":"source/_posts/blockchain.md","hash":"4fdaaf77252b7e65b1e35c827ddfea467bc028ec","modified":1571035161716},{"_id":"source/_posts/btc-data-dat.md","hash":"378493b252d088b981bbfb94f2731d6790eae703","modified":1571037923831},{"_id":"source/_posts/btc-wallet.md","hash":"a95da1f60477f13b77e7660952adf3f9e7a5b732","modified":1571037934654},{"_id":"source/_posts/btc.md","hash":"3ed71a152011912a3cc0956a706e9345ddf95b59","modified":1571037920084},{"_id":"source/_posts/cosmos-ibc-store.md","hash":"0f9bb7f986032e5ce95afd4845fe2238f403c8a7","modified":1574750033483},{"_id":"source/_posts/cosmos-store.md","hash":"e93de32c561f8063edb3c71951d777e808b59ebe","modified":1574757732994},{"_id":"source/_posts/crypto.md","hash":"bf45c6d1a98fb40e0cb3266bc7cc56bac50c0ae1","modified":1571034958550},{"_id":"source/_posts/dai-code.md","hash":"effaeea3e72463b421ee174d3dc738eaae018412","modified":1571035982933},{"_id":"source/_posts/dai.md","hash":"9df45f0506cd009fa51e80675455aa77af65a997","modified":1571035965726},{"_id":"source/_posts/elastic-kibana.md","hash":"e1cb784d4a54124aeab07afb3022be36dc9ff5ce","modified":1571034077808},{"_id":"source/_posts/elastic-painless.md","hash":"b6f95c2d48b41a804cc4cfd98f4e1caa26df5933","modified":1571034088123},{"_id":"source/_posts/elastic-logstash.md","hash":"e93671cd3dbdd03b2b5bb7c4b93be785faa0cc3e","modified":1571034083703},{"_id":"source/_posts/elastic-search-dsl.md","hash":"38cf3bf890f7f2629d67c374ac9e739198217cfb","modified":1571034092299},{"_id":"source/_posts/elastic-template.md","hash":"c5d7868b591a1e1dba06080f566203b4013e006e","modified":1571104858965},{"_id":"source/_posts/elastic.md","hash":"531416411b5b3b41f42fd834f3edca87ac0d2f74","modified":1571034100972},{"_id":"source/_posts/eth-build.md","hash":"50f2ff0a1ee7e6194511e019b31c0a3fcede86d6","modified":1571035799618},{"_id":"source/_posts/eth-casper.md","hash":"9203bedadd0010e497e8c292f56f6e512ab01af0","modified":1571035913874},{"_id":"source/_posts/eos-code.md","hash":"e952727e2295ddec83ba046af6b499e29053c795","modified":1571035581817},{"_id":"source/_posts/eos.md","hash":"ca654f0706331f39ceeaca0445f819a52b888c9e","modified":1571035463967},{"_id":"source/_posts/eth-erc.md","hash":"0c4f3dfc1184881c1f9ab4454493175f423347aa","modified":1571036017089},{"_id":"source/_posts/eth-jsre-api.md","hash":"0e8e9b0c119944a5982fe4d0e546303009896bf4","modified":1571036056741},{"_id":"source/_posts/eth-p2p-udp.md","hash":"251b4ea11293c3f973d3e256f5880e601caf934a","modified":1571036085669},{"_id":"source/_posts/eth-contract.md","hash":"5a98f52a5c96dd8cfdf341eeb4e2cdf482cdd422","modified":1571035895621},{"_id":"source/_posts/eth-rlp.md","hash":"3f50fadf253c353323020c33239da4818f7d529a","modified":1571035730308},{"_id":"source/_posts/eth-state.md","hash":"a246a7791f93400df8df5974f9b5834f9d9fc5cc","modified":1571036120646},{"_id":"source/_posts/eth.md","hash":"9109abb33549552cfaf63bd055dec020e68b46a6","modified":1571035845748},{"_id":"source/_posts/fabric-pbft.md","hash":"4a24b928fe75631200acfd31e89bab0b94e951bb","modified":1571036990625},{"_id":"source/_posts/fabric-code-consensus-event.md","hash":"f3fa0043a2d98ce238a0f52f32221e52d1ca3fff","modified":1571036984048},{"_id":"source/_posts/fabric-performance.md","hash":"8c5e8b519d86d3a6f16b6ac7828cf2caaf9fd8d5","modified":1571036907722},{"_id":"source/_posts/fabric-example.md","hash":"5c1ee2bce0c3c4fa69a163723c09f64634e973d7","modified":1571036779696},{"_id":"source/_posts/fabric_peer.jpg","hash":"c9c7d0e437a9f0b5a8d3bd54939af0f98a2e2c63","modified":1571036444856},{"_id":"source/_posts/floodlight-sdn.md","hash":"9a1d290bb5fd9f529111b949329fcc09a9b29cbd","modified":1571034107845},{"_id":"source/_posts/fabric.md","hash":"bebf5d4ec354ced6907fe7fb9bc839b3f23a7227","modified":1571036697064},{"_id":"source/_posts/fabric_macro.jpg","hash":"c926c6151cf76b28be6b08e2d9fe527b9ec0c933","modified":1571036444855},{"_id":"source/_posts/how-to-set-up-a-blog.md","hash":"bd0f83dfabe914d2c4d19af3a1d410376d5005f8","modified":1571020277620},{"_id":"source/_posts/kibana-plugin-development.md","hash":"cfa5d34b8f2baa4ca93df93c1437002394d83bcd","modified":1571034117352},{"_id":"source/_posts/kibana-plugin.md","hash":"5cb56e0f54392161522b0bcb5ed64ca327f95fc5","modified":1571034124369},{"_id":"source/_posts/kibana-timeline.md","hash":"d69d7f026c9c3c37f4194b083209f469320698c5","modified":1571034130627},{"_id":"source/_posts/web3j.md","hash":"91a246b50b08c46b2baf61afb182c78dd50d9e61","modified":1571036154674},{"_id":"source/_posts/zilliqa.md","hash":"dc4e632e2c512656b3f344e7caf133c7c995cda3","modified":1571035225020},{"_id":"source/_posts/wallet-connection.md","hash":"fc12cd8e5fed041ff6b1387a94f70ef1026325e4","modified":1571034873925},{"_id":"source/_posts/maven.md","hash":"8775be53ed73bfb3ebb736f68214828589f6cdbb","modified":1571034177697},{"_id":"source/_posts/zilliqa-network.md","hash":"78316e5e5b52d395a05b579472286964c2560fe1","modified":1571035279167},{"_id":"source/categories/index.md","hash":"16c18d7a4433fb5c7c44ebe660ca6c1ad2693f38","modified":1571021903348},{"_id":"source/search/index.md","hash":"82aa576fd412f51d6e4965a0f4a5e3f4fb8bd4e5","modified":1571032024769},{"_id":"themes/cactus/languages/ca.yml","hash":"b79dd2c21dc6697c635e92db1f661a4b8d5d2305","modified":1570532430817},{"_id":"themes/cactus/languages/default.yml","hash":"703548ad90034d4e5207a27eb50f726dc27e4c0c","modified":1570532430818},{"_id":"themes/cactus/languages/en.yml","hash":"703548ad90034d4e5207a27eb50f726dc27e4c0c","modified":1570532430818},{"_id":"themes/cactus/languages/es.yml","hash":"2b1fc8b0d636123e9ee39017fa20053bd1913a5a","modified":1570532430818},{"_id":"themes/cactus/languages/fr.yml","hash":"4fea266d3c522903f3eee4fffee6e66c44775005","modified":1570532430818},{"_id":"themes/cactus/languages/fa.yml","hash":"63f32e50953af1c4bd0308a4fca5862b5287c2cb","modified":1570532430818},{"_id":"themes/cactus/languages/it.yml","hash":"62800bcae1f2d2454f87f4bcf4d7593848424f61","modified":1570532430818},{"_id":"themes/cactus/languages/nl.yml","hash":"ac0573352ad2c737a7686bcca498b985e7bd6447","modified":1570532430818},{"_id":"themes/cactus/languages/pl.yml","hash":"8a2d6dc874d86c38d42c2c861c39590647b5d536","modified":1570532430818},{"_id":"themes/cactus/languages/pt-br.yml","hash":"4859aba788a050c2d5d0b997693b0c8c24b349f7","modified":1570532430819},{"_id":"themes/cactus/languages/ru.yml","hash":"81b57fcd1977ef534f4bf303dbc1b4710cc7f057","modified":1570532430819},{"_id":"themes/cactus/languages/tr.yml","hash":"2702914007e6bade9d6861078c0e179ac05bf48c","modified":1570532430819},{"_id":"themes/cactus/languages/vi.yml","hash":"f84893c3ec3e45875c90069e14b17ed3016ed973","modified":1570532430819},{"_id":"themes/cactus/languages/zh-CN.yml","hash":"8f81faaad9a0615b09dbc23868484a55ec958f6f","modified":1570532430819},{"_id":"themes/cactus/languages/zh-TW.yml","hash":"2f4e050c9b35a67f4a7278cec3a949533c2ac16a","modified":1570532430819},{"_id":"themes/cactus/layout/archive.ejs","hash":"53de8817e37be01b3ba8fa5ca31b9cafa2f3c011","modified":1570532430822},{"_id":"themes/cactus/layout/index.ejs","hash":"6a1d161481c7d5418496128aa7cf470160536949","modified":1571039598265},{"_id":"themes/cactus/layout/layout.ejs","hash":"8504004f2ed78914f806c6699d9bd722318cbe56","modified":1570532430822},{"_id":"themes/cactus/layout/page.ejs","hash":"c5465d5315a7544aa466b01fd8cfb62917a8bb1d","modified":1570532430823},{"_id":"themes/cactus/scripts/merge-configs.js","hash":"2048c3415d96b17b9d84aa44bc0c25f1210525f8","modified":1570532430823},{"_id":"themes/cactus/scripts/meta.js","hash":"fa6055a39851c9953d033e70c1614547b94dce60","modified":1570532430823},{"_id":"themes/cactus/scripts/page_title.js","hash":"fa662dbdb82779af1b95e35ed7ccdf4866a53dee","modified":1570532430824},{"_id":"themes/cactus/scripts/thumbnail.js","hash":"df8829fd8c3119650037eba5ec11bdce06acff9d","modified":1570532430824},{"_id":"themes/cactus/layout/post.ejs","hash":"a7d164ce888a60cd3eddd9c04bc6762428fa66bb","modified":1570532430823},{"_id":"source/_posts/eth-code-tx-event.md","hash":"90bca5b44575c2d2264e8f87aa4ef0c7457dcd9d","modified":1571035701961},{"_id":"themes/cactus/layout/_partial/comments.ejs","hash":"4cf8d0059e5f8bc8ae1dd1a426293583fd398052","modified":1570532430819},{"_id":"themes/cactus/layout/_partial/footer.ejs","hash":"c3a80e347cb11022baf5e65fb4d0209b8d205693","modified":1570532430820},{"_id":"themes/cactus/layout/_partial/head.ejs","hash":"b7db191b7ad066b1f3f9c34d8a4b77e1ee815215","modified":1570532430820},{"_id":"themes/cactus/layout/_partial/header.ejs","hash":"6b534801486f6baa989bd351915a9156b838b777","modified":1570532430820},{"_id":"themes/cactus/layout/_partial/pagination.ejs","hash":"23bf862b3b8a3cd831850504d9b5a24d21b005e7","modified":1570532430820},{"_id":"themes/cactus/layout/_partial/scripts.ejs","hash":"83d912956b00537e0b20a9905f14885ff3899ed4","modified":1570532430822},{"_id":"themes/cactus/layout/_partial/search.ejs","hash":"8b4bf9cf5db0ce762a31fc3baae0f2fc004bece4","modified":1570532430822},{"_id":"themes/cactus/layout/_partial/styles.ejs","hash":"be1b54388eb02176dd4722285dda19e3dce2e62e","modified":1570532430822},{"_id":"themes/cactus/source/_data/projects.json","hash":"e866bb8ed316a0709f581ee3076e1166b51c0c4d","modified":1570850595121},{"_id":"themes/cactus/source/css/_extend.styl","hash":"2c8751d132e62f5f068dc3a184d160670737ba1f","modified":1570532430824},{"_id":"themes/cactus/source/css/_fonts.styl","hash":"354809b5a64e8a47a66c66fd1a28ac597c1460a6","modified":1570532430825},{"_id":"themes/cactus/source/css/_mixins.styl","hash":"1a9e309523df9685e8d088dcff0a809c58e2c392","modified":1570532430835},{"_id":"themes/cactus/source/css/_variables.styl","hash":"95a10a7ee9f2d5f272813286eee0d3202cb0fcea","modified":1570862178459},{"_id":"themes/cactus/source/css/_util.styl","hash":"2bfeb2e2605dd5235693b00c71a212646d2e0410","modified":1570532430837},{"_id":"themes/cactus/source/css/rtl.styl","hash":"98355abe9ef3a398a5b4cb40d3d33bf86ac8d1d4","modified":1570532430837},{"_id":"themes/cactus/source/css/style.styl","hash":"9a946631f0e59addc57c39bd7f2081b3e9256ab1","modified":1570532430837},{"_id":"themes/cactus/source/images/apple-touch-icon.png","hash":"57e2def34682655f41a0be2d083f16765ba7858b","modified":1570532430837},{"_id":"themes/cactus/source/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1570532430838},{"_id":"themes/cactus/source/js/main.js","hash":"584c5a69ac81a483a1c4377a2e2cf326c2795e7b","modified":1570532430840},{"_id":"themes/cactus/source/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1570532430838},{"_id":"themes/cactus/source/js/search.js","hash":"a74d0c601f820160825a2e4ad13618074d714933","modified":1570532430840},{"_id":"themes/cactus/layout/_partial/post/category.ejs","hash":"b5bfa049f17868fb09d9d2a7e1d5279fa0381d37","modified":1570532430821},{"_id":"themes/cactus/layout/_partial/post/actions_mobile.ejs","hash":"79b234ff3c264e66b2e71c819228e62bf92b48e4","modified":1570532430820},{"_id":"themes/cactus/layout/_partial/post/actions_desktop.ejs","hash":"38aadd1ed890303dde582b722486138afee09b0a","modified":1570532430820},{"_id":"themes/cactus/layout/_partial/post/date.ejs","hash":"6f2d1aa9562df343b797d25705f1945323c465fb","modified":1570532430821},{"_id":"themes/cactus/layout/_partial/post/gallery.ejs","hash":"9aecd8908e8a684f33dc20c02497c0f1774137c7","modified":1570532430821},{"_id":"themes/cactus/layout/_partial/post/share.ejs","hash":"847a400e79b775246ca9067e40c3f104d571413d","modified":1570532430821},{"_id":"themes/cactus/layout/_partial/post/tag.ejs","hash":"e08fae30da060f49c087f6c121868b08eb55c795","modified":1570532430821},{"_id":"themes/cactus/layout/_partial/post/title.ejs","hash":"a060f1c6e3718494a6b1d0e1981ea0bf4e549828","modified":1570532430822},{"_id":"themes/cactus/source/css/_colors/classic.styl","hash":"0f0ec41a4165814ce69688425d5ac4d701b7cc70","modified":1570532430824},{"_id":"themes/cactus/source/css/_colors/dark.styl","hash":"9c9655b42b85f754b8a573a1d4634c23c680e1bf","modified":1570532430824},{"_id":"themes/cactus/source/css/_colors/light.styl","hash":"d09f781cb02394850737b3a9efc6693307d5bf09","modified":1570532430824},{"_id":"themes/cactus/source/css/_colors/white.styl","hash":"2b25ad24573bded8b42f9d80112eab9fadbed1a5","modified":1570532430824},{"_id":"themes/cactus/source/css/_highlight/agate.styl","hash":"53027913ed8d4f75ac3e49e76aad824f0df62da3","modified":1570532430825},{"_id":"themes/cactus/source/css/_highlight/androidstudio.styl","hash":"2af0861725f97f0ee2ded67c3d2d4548c62b2d16","modified":1570532430825},{"_id":"themes/cactus/source/css/_highlight/arduino-light.styl","hash":"15e8572585cd708221c513dea4bdd89d8fe56c10","modified":1570532430825},{"_id":"themes/cactus/source/css/_highlight/arta.styl","hash":"b3e81e3e694ceb8deed178adb8b91013c5120e30","modified":1570532430825},{"_id":"themes/cactus/source/css/_highlight/ascetic.styl","hash":"32cff3bef6fac3760fe78f203096477052a90552","modified":1570532430825},{"_id":"themes/cactus/source/css/_highlight/atelier-dune-dark.styl","hash":"c196ff0ee064af0e507823694ae39020addfc280","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-cave-dark.styl","hash":"ce63dd8548688d88254405eedfa75b1d7c82449e","modified":1570532430825},{"_id":"themes/cactus/source/css/_highlight/atelier-cave-light.styl","hash":"a5be0744a7ecf4a08f600ade4cfd555afc67bc15","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-dune-light.styl","hash":"931435fbc6f974e8ce9e32722680035d248a9dc1","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-estuary-dark.styl","hash":"0bb16a4eff93688f40787abc2f9e56e7d5cc93e7","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-estuary-light.styl","hash":"344276ca9b27e51d4c907f76afe5d13cf8e60bdf","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-forest-dark.styl","hash":"effbc5d75fa87203c847039869c22031b40d5b7d","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-forest-light.styl","hash":"95228d9f2102fad425536aac44b80b2cba1f5950","modified":1570532430826},{"_id":"themes/cactus/source/css/_highlight/atelier-heath-dark.styl","hash":"9a2e9a1d0a01bbdf158560c3ed1c134e098b2c68","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-heath-light.styl","hash":"8c8c2e445abef85273be966d59770e9ced6aac21","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-lakeside-dark.styl","hash":"10ee3882fca7b97a37bd309d2d35fce9868647bb","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-lakeside-light.styl","hash":"2c54cb9bdb259ae3b5b29f63ac2469ed34b08578","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-plateau-dark.styl","hash":"84c80e6f67f62fce958d25817c277d2360272617","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-plateau-light.styl","hash":"d1a05fdd1ededc9063d181ab25bad55a164aeb4a","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-savanna-dark.styl","hash":"e32c1c70def8060fce5e790979a126da650ac642","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-savanna-light.styl","hash":"f8244c93711c7cb59dd79d2df966806b30d171ea","modified":1570532430827},{"_id":"themes/cactus/source/css/_highlight/atelier-seaside-dark.styl","hash":"2edf385215bbe1985b1a10106525d362667d28c2","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/atelier-seaside-light.styl","hash":"0597342da6e2d0c5bdcc7d42dabb07322b1a4177","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/atelier-sulphurpool-dark.styl","hash":"538a14321193cd8abf2ddc484306631e54149ffb","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/atelier-sulphurpool-light.styl","hash":"efa52713efc468abeeb2b9299704371583b857de","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/brown-paper.styl","hash":"c2326ba20a5020a66ca7895258d18833327d4334","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/color-brewer.styl","hash":"2a439d6214430e2f45dd4939b4dfe1fe1a20aa0f","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/codepen-embed.styl","hash":"8b7b34484f76a6c2c3b1a9e49abb9b382f439ae8","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/dark.styl","hash":"f5e6e75958de59e87fc6be3a1668e870e20bc836","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/brown-papersq.png","hash":"3a1332ede3a75a3d24f60b6ed69035b72da5e182","modified":1570532430828},{"_id":"themes/cactus/source/css/_highlight/darkula.styl","hash":"9717efa9194837ba3fb4d762997d33075dcf8bfa","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/docco.styl","hash":"b1c176378bb275f2e8caa759f36294e42d614bf1","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/far.styl","hash":"aaac3028f5e33123cd123a583cddc9290c45ec8e","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/foundation.styl","hash":"bf8ddc94b4ad995b8b8805b5a4cf95004553fdac","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/github-gist.styl","hash":"48211a03d33e7f7ada0b261162bea06676155a71","modified":1570532430829},{"_id":"themes/cactus/source/css/_highlight/googlecode.styl","hash":"bda816beee7b439814b514e6869dc678822be1bc","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/github.styl","hash":"3336aeba324c6d34a6fd41fef9b47bc598f7064c","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/grayscale.styl","hash":"bf37d8b8d1e602126c51526f0cc28807440228ed","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/gruvbox-dark.styl","hash":"76b744c14fd5600bea64731c05df97c2df75523f","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/highlightjs.styl","hash":"0e198b7a59191c7a39b641a4ddd22c948edb9358","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/hopscotch.styl","hash":"1378a6bc67a32c0cbff72ab771268b53f9aa586d","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/hybrid.styl","hash":"b8eb5c69d12f2ee5ebc50265ae271699d7f1a8d3","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/index.styl","hash":"002d5596f6379cc87dbd43d9145bc764aa666be1","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/idea.styl","hash":"a02967cb51c16a34e0ee895d33ded2b823d35b21","modified":1570532430830},{"_id":"themes/cactus/source/css/_highlight/kimbie.dark.styl","hash":"45dbb168f22d739d0109745d2decd66b5f94e786","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/kimbie.styl","hash":"51b889ca7c6fe178cfbbe28d875a6ea427184441","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/kimbie.light.styl","hash":"61f8baed25be05288c8604d5070afbcd9f183f49","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/ir-black.styl","hash":"53e5d74326a4527b92272bbd6946d4fec92720e8","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/magula.styl","hash":"16d323f989b1420a0f72ef989242ece9bf17a456","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/mono-blue.styl","hash":"4c89a6ae29de67c0700585af82a60607e85df928","modified":1570532430831},{"_id":"themes/cactus/source/css/_highlight/monokai-sublime.styl","hash":"c385b11345894be7e6ce3c5f08663e199933b8e4","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/monokai.styl","hash":"f87be027848ea6bee623a08ad1e17b2f5b7937ee","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/obsidian.styl","hash":"199e28326be8590883f0813ebbd54fcfaa4750fd","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/paraiso-dark.styl","hash":"f1537bd868579fa018ecdbfd2eb922dcf3ba2cac","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/paraiso-light.styl","hash":"d224d1df0eb3395d9eea1344cee945c228af2911","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/paraiso.styl","hash":"75f181eece6b71d033ea0c8d6cf00ae7efb9e29b","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/pojoaque.jpg","hash":"c5fe6533b88b21f8d90d3d03954c6b29baa67791","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/pojoaque.styl","hash":"4e7b6b046b8575ac749f6aec4e953a62ada27a36","modified":1570532430832},{"_id":"themes/cactus/source/css/_highlight/railscasts.styl","hash":"b6674db9210e0c4444e4835fff2d1361f3ebd64c","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/rainbow.styl","hash":"c0cf97aae3e10fdcd10414547a711c9effbc39b8","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/school-book.png","hash":"711ec983c874e093bb89eb77afcbdf6741fa61ee","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/school-book.styl","hash":"d43560fe519a931ce6da7d57416d7aa148441b83","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/solarized-dark.styl","hash":"90c9da5aa594383697e5b18892a7f95beb053f55","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/sunburst.styl","hash":"af3eec0fd56151e55bbd49c31b151f36717611d8","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/solarized-light.styl","hash":"aa0dd3fd25c464183b59c5575c9bee8756b397f2","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-blue.styl","hash":"f24c17d0ab815dcfaab3438cb9fe2ab4839f5e0d","modified":1570532430833},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-eighties.styl","hash":"28d751075ebabf7d0327a36f725076fe82fdf626","modified":1570532430834},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-bright.styl","hash":"7674fecb6d27350727dc0d2dc93bc018382ebbd0","modified":1570532430834},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night.styl","hash":"16ba09b2db501e4e3e2e7d62595d9bf935bf27c4","modified":1570532430834},{"_id":"themes/cactus/source/css/_highlight/vs.styl","hash":"959a746f4b37aacb5d1d6ff1d57e0c045289d75d","modified":1570532430834},{"_id":"themes/cactus/source/css/_highlight/tomorrow.styl","hash":"15779cf6846725c7c35fc56cac39047d7e0aec1c","modified":1570532430834},{"_id":"themes/cactus/source/css/_highlight/xcode.styl","hash":"5e8532ae8366dcf6a4ef5e4813dc3d42ab3d0a50","modified":1570532430834},{"_id":"themes/cactus/source/css/_highlight/zenburn.styl","hash":"68ff9332ccc03f9389b15b713415cde016f8088f","modified":1570532430834},{"_id":"themes/cactus/source/css/_partial/archive.styl","hash":"ef8fc52337c4c7b010cad7c427cb78009b30f9d8","modified":1570532430835},{"_id":"themes/cactus/source/css/_partial/article.styl","hash":"c6a3c395ceb4aacba8c995bcde7b58a7ca501919","modified":1570532430835},{"_id":"themes/cactus/source/css/_partial/categories.styl","hash":"a43f00e61b3507f130b8a3f8108a4eeca147c2a0","modified":1570532430835},{"_id":"themes/cactus/source/css/_partial/comments.styl","hash":"1e90f1fb9d4c155df518cacb5a537e9de9c042c1","modified":1570532430835},{"_id":"themes/cactus/source/css/_partial/footer.styl","hash":"d9b13e402808175dc90761cc4fdfe3d4808034f8","modified":1570532430835},{"_id":"themes/cactus/source/css/_partial/header.styl","hash":"b64021d680f856d24dc17bc8f53674bfe2e241e4","modified":1570532430835},{"_id":"themes/cactus/source/css/_partial/pagination.styl","hash":"950bf517bbe7adb9a9aa4eb5ddec74ffc7598787","modified":1570532430836},{"_id":"themes/cactus/source/css/_partial/index.styl","hash":"59c99f4ea3a73bf47ce030df166c5e33d5de31fb","modified":1570532430836},{"_id":"themes/cactus/source/css/_partial/tags.styl","hash":"d571d5c7c960300d29c5f0ec3fe1140322ecd6b3","modified":1570532430836},{"_id":"themes/cactus/source/css/_partial/search.styl","hash":"159be002780c62a77f46947cf854a7342fba24f4","modified":1570532430836},{"_id":"themes/cactus/source/css/_partial/tooltip.styl","hash":"2daff581ec3efaec840cbfdee512195919c32629","modified":1570532430836},{"_id":"themes/cactus/source/lib/clipboard/clipboard.min.js","hash":"ee60ca5ba9401456105ef703a98092369b579c80","modified":1570532430840},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff","hash":"37443d0040f0d7af381c955e4c15919a15d0349e","modified":1570532430877},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff2","hash":"0a257c8b60e0f20802c1dc8daeed2d3cb0d44f17","modified":1570532430878},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff","hash":"df15fd1e74b6f4a50bea57e2b44d9627f38495b5","modified":1570532430880},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff2","hash":"62447a951d48b21c4696ae72df4bc4adef636e26","modified":1570532430880},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff2","hash":"ef07a250766fea840c1049e67c0405d9216ee0a8","modified":1570532430882},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff","hash":"32ae5c0d1d5943c8bb8e0f6ab07c3269c6f8b8a8","modified":1570532430882},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff","hash":"f5653059b2a5929516e4aab02329a978600b9b67","modified":1570532430885},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff2","hash":"668400ae92700965f03f2371faaee0ab8c8347c3","modified":1570532430885},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff","hash":"ad4d46a99a1daf6353c86c79ac3a2b030213859c","modified":1570532430887},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff2","hash":"c3be79b553ec394db71268d604b1d29183b867dc","modified":1570532430887},{"_id":"themes/cactus/source/lib/vazir-font/font-face.css","hash":"8f2bf6b59ae1f2ed4c2fead6cea4b8314fcf62e5","modified":1570532430889},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff","hash":"bbee70033f0f5882e9869e417b69c6a38f56f187","modified":1570532430889},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff2","hash":"30ce165216db078951a690a6ad665b9b78f5dd81","modified":1570532430889},{"_id":"themes/cactus/source/images/logo.png","hash":"0e3029251dfda26adee2761f71377297e8c26871","modified":1570532430839},{"_id":"themes/cactus/source/lib/jquery/jquery.min.js","hash":"0dc32db4aa9c5f03f3b38c47d883dbd4fed13aae","modified":1570532430857},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.ttf","hash":"594dc3344ad14903c247615427d1009709f0f5a4","modified":1570532430877},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.eot","hash":"13d026ff857c853cbd0dc519b6e58669db309441","modified":1570532430876},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.eot","hash":"f76ec625e15522ff60d21f7a9a3b71c65bc27556","modified":1570532430878},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.ttf","hash":"2e6c9df9f775373fb1988ae8529aa8f05313dae6","modified":1570532430879},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.eot","hash":"3edffd7bb61eee8cd46b57225f9f9e5264e3362b","modified":1570532430881},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.ttf","hash":"9f1e2934098a6a4a7c5584c8f3fa24a707070da3","modified":1570532430882},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.eot","hash":"1f5a73db7947ef22c8a2bb19d6449b80496c03c4","modified":1570532430883},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.ttf","hash":"295f7e02c9b157e7ea63ad09613b00ceab85c5cd","modified":1570532430884},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.eot","hash":"08e1503d1181188690fd9c81860d6c890c1465f6","modified":1570532430885},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.ttf","hash":"a6aa450ee6e0f85786474ca6b04827ef97e81af4","modified":1570532430886},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.eot","hash":"31a9219c25fe1991fb745ec8dbbcf45c6094a702","modified":1570532430888},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.ttf","hash":"f22b219824026e490a581ddb3b36b07997dff0e3","modified":1570532430888},{"_id":"themes/cactus/source/css/_partial/post/actions_desktop.styl","hash":"dc726537928fc0d7703e73c0a5e4b82ad1731d59","modified":1570532430836},{"_id":"themes/cactus/source/css/_partial/post/actions_mobile.styl","hash":"0d2966c1d870392476864af8ee3ba312ba30cb82","modified":1570532430836},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.eot","hash":"42ff503f20e97503cef8e5b2ec10ae07699d7c01","modified":1570532430848},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"9784edb76f8a2ed595ea4bf74d46cda4eff3b303","modified":1570532430849},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.ttf","hash":"c140085833a38abec6b7df99d4ccac93eb266031","modified":1570532430849},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff","hash":"7b3f44b4d3028f3c87ddf0f4bd62511c9bf4a87e","modified":1570532430849},{"_id":"themes/cactus/source/lib/justified-gallery/css/justifiedGallery.min.css","hash":"92bb6e468a1db7fbd99ccb960e15e28572254263","modified":1570532430857},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"92da6e3c7121e21cdfde25ef08797a3937a683e1","modified":1570532430856},{"_id":"themes/cactus/source/lib/justified-gallery/js/jquery.justifiedGallery.min.js","hash":"82ab395176c927ffbb2f7c95132ee0a06cd5d64a","modified":1570532430857},{"_id":"themes/cactus/source/lib/font-awesome/css/all.min.css","hash":"cf1a3fd771900af34f2af22142beecfb47367548","modified":1570532430841},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"d902f8db3e021155f177f698a252fb98d6e61768","modified":1570532430847},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff","hash":"f9d835a0f9248b1bb33d66968e87c4a50103ed8d","modified":1570532430847},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.ttf","hash":"19e302760e39e25a5f8d90d6cd0164ef6cd74f8c","modified":1570532430847},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff","hash":"80d33a73cbb60e206ef6f5c898988641576c7dda","modified":1570532430856},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.eot","hash":"644ece8263d2f96b087eebf7f6d4e309e5898eb5","modified":1570532430842},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.svg","hash":"33e86c0ad6fb9c5c0c8c2af4cb2d790c6b14a8aa","modified":1570532430849},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.eot","hash":"10740942ec6b3f4985529d343402d0bf32f9f847","modified":1570532430851},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Italic.ttf","hash":"93ebc5098cf57a32b7b8d297681f31692c09bdfa","modified":1570532430872},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-BoldItalic.ttf","hash":"b542b9591fbf33925d93f0695b6e123a9f0cfd43","modified":1570532430871},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-BoldItalic.ttf","hash":"926035f0156cccf1b0ca507347f39bf9c510f51e","modified":1570532430874},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.ttf","hash":"c445864a9646948e0d7ff44930ad732ee61427d8","modified":1570532430856},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-BoldItalic.ttf","hash":"b7d24ab1e4fad720f31a2b0cca1904ce1740d846","modified":1570532430865},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Italic.ttf","hash":"9d757cc9f928fc83b2133283dd639c12b11d94ad","modified":1570532430875},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Italic.ttf","hash":"9a23c6898b0943bd3d96c04df9a0f66e919451d8","modified":1570532430867},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Bold.ttf","hash":"f9918fb93d6ab6850f5d38069a999c311af78816","modified":1570532430873},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Bold.ttf","hash":"58be4b7760e9a84daa81929d046f9a15c4fd1c1a","modified":1570532430869},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Regular.ttf","hash":"20ce1fc7ae1254558ca044ae48283faaa58897e5","modified":1570532430872},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Regular.ttf","hash":"de559f8d70d5b1ab2810597bfd0b1b9506f3ef01","modified":1570532430876},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Regular.ttf","hash":"6c090d6bff3928fbf8a5f4104e58ed7f421aea7c","modified":1570532430868},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Bold.ttf","hash":"34f7db59f1d023294e69976aa20b7d52b86165a4","modified":1570532430864},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.svg","hash":"ed6c1ed8f24df909f40fe5e5c652d7ff9570c821","modified":1570532430854},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.svg","hash":"b0bb9e6ac7709206b9510f1718516d89aead5b21","modified":1570532430846},{"_id":"public/search.xml","hash":"f1f60d7de6977e5eb105e83c8f462de957288004","modified":1574757867447},{"_id":"public/categories/index.html","hash":"8cc0ed311e949de5fff13f12e35cfe6dc6c894ac","modified":1574757868702},{"_id":"public/search/index.html","hash":"677c135cabc8fa1a66564b9dc4ff4d3df0466934","modified":1574757868702},{"_id":"public/about/index.html","hash":"ed233f8174fb7a2581e1a24d2c9e29cee3a2d156","modified":1574757868793},{"_id":"public/2019/04/14/fabric-pbft/index.html","hash":"a8bc862ade4549b5589a6af4656772bc774c5b5a","modified":1574757868794},{"_id":"public/archives/index.html","hash":"65f02e4276f3074218c79ca93c4874586cbe3251","modified":1574757868794},{"_id":"public/archives/2017/index.html","hash":"431a807fa92513de08ec3b8c7ec822e1c07d5785","modified":1574757868794},{"_id":"public/archives/page/2/index.html","hash":"f828bc58248e35c36a62c97fec5cd7af3ca0de84","modified":1574757868794},{"_id":"public/archives/page/3/index.html","hash":"d727341d5f2bcb403feb9a20c82c8f5f2b9911aa","modified":1574757868795},{"_id":"public/archives/page/4/index.html","hash":"ee467f3f7559906796af17174130733ee4e480ba","modified":1574757868795},{"_id":"public/archives/2017/10/index.html","hash":"44e2a2cc76e3c651c8fb37ba5321976e688bcfbb","modified":1574757868795},{"_id":"public/archives/2019/index.html","hash":"e0b59a2670c815df27e73fae963673a066b47fa6","modified":1574757868795},{"_id":"public/archives/2017/page/2/index.html","hash":"d724eadafa65f11b15aa420289b9ae987ec4ba8d","modified":1574757868795},{"_id":"public/archives/2019/page/2/index.html","hash":"38e57e26fc1c7cac532af2402c190866df0cca6f","modified":1574757868795},{"_id":"public/archives/2017/10/page/2/index.html","hash":"0ba62977bf6f6903b0d972a42861432a5fff813d","modified":1574757868795},{"_id":"public/archives/2019/page/3/index.html","hash":"357d45fdef5cd976778d140eadf2adbc943ad479","modified":1574757868795},{"_id":"public/archives/2019/10/index.html","hash":"19c9e9c717ddb6050c365541a23a290423214e27","modified":1574757868795},{"_id":"public/archives/2019/04/index.html","hash":"7c3eaac62d82ae7be30131992c633ec0d0c51d19","modified":1574757868795},{"_id":"public/archives/2019/10/page/2/index.html","hash":"dede62b49d663f7d8e36a074a45ca0555e4a5c72","modified":1574757868795},{"_id":"public/archives/2019/10/page/3/index.html","hash":"761cc0376abf523049fb13c5e5d236c07eefa582","modified":1574757868795},{"_id":"public/categories/eth/index.html","hash":"e6e81be707b74416b1a3de7a44be2e242933b767","modified":1574757868795},{"_id":"public/categories/eth/page/2/index.html","hash":"1276da36c1d86c329d8953272379de0bc171d615","modified":1574757868795},{"_id":"public/categories/eos/index.html","hash":"52ca49b5a35d3df54782aedb5e783f31327ee74d","modified":1574757868795},{"_id":"public/categories/btc/index.html","hash":"f3f639b2af4dc550b9929dad43f87b2e52aa31c4","modified":1574757868795},{"_id":"public/categories/fabric/index.html","hash":"3b92b56426a717360a1e6ca10bfe2b69b9327475","modified":1574757868796},{"_id":"public/categories/enjoy/index.html","hash":"d61228099c615c450fe218343a5e5b625009cd44","modified":1574757868797},{"_id":"public/categories/blockchain/index.html","hash":"4148b34a9ce567a0aa5f5ac857440b412f9a1643","modified":1574757868797},{"_id":"public/categories/java/index.html","hash":"04df84c093830474f9ac2018a63a5612235f7ade","modified":1574757868797},{"_id":"public/index.html","hash":"461116f39168d517eb18658f55f7b15923eaaf24","modified":1574757868797},{"_id":"public/categories/elk/index.html","hash":"852aeeff2ea608e70a71649a17de29cee6e252e6","modified":1574757868797},{"_id":"public/categories/zilliqa/index.html","hash":"1c404cbacb8f9f1510d6eea25728fff3c00be943","modified":1574757868798},{"_id":"public/categories/enjoyment/index.html","hash":"4ed0cdc478ceb9e26b30a8c2b80cf52bfb757424","modified":1574757868798},{"_id":"public/page/3/index.html","hash":"4235c68bb50222a342b45c0cccf6e5747b0620a1","modified":1574757868798},{"_id":"public/page/4/index.html","hash":"86b0e8c71bf6580f6de86f9afb9b1d36c8d5310c","modified":1574757868798},{"_id":"public/page/2/index.html","hash":"81a6fb693a7a29baa32866c254c9798993a861cc","modified":1574757868798},{"_id":"public/2019/10/14/web3j/index.html","hash":"28c983ef22864e2bc158e8d2ceaa6790b9c60657","modified":1574757868798},{"_id":"public/2019/10/14/fabric-performance/index.html","hash":"f83678e47f90936d7ab1c51b76ba78c3c39914d5","modified":1574757868798},{"_id":"public/2019/10/14/eth-state/index.html","hash":"3c4042e5b3856fa61403bf5f19f4298c621753ca","modified":1574757868798},{"_id":"public/2019/10/14/fabric/index.html","hash":"3a559e7bd6bf99da2dffd089d440d54d38e8a3fa","modified":1574757868798},{"_id":"public/2019/10/14/eth-p2p-udp/index.html","hash":"8de41395b76125fc9e123931d08f893cc00d4118","modified":1574757868798},{"_id":"public/2019/10/14/eth-erc/index.html","hash":"91d3607963ca5a306dc4b5239497955ea2b989c7","modified":1574757868798},{"_id":"public/2019/10/14/dai-code/index.html","hash":"425fb4e8af5cd9efaf4974fefac7c0deb8cafc13","modified":1574757868798},{"_id":"public/2019/10/14/dai/index.html","hash":"13bfa1cb15402df33ff4257b679f17243a43f62f","modified":1574757868798},{"_id":"public/2019/10/14/eth-casper/index.html","hash":"1511d84cee3c02ec1ffe9906e561bee07f67a4ab","modified":1574757868798},{"_id":"public/2019/10/14/eth-contract/index.html","hash":"486cd8d6078872fd13db99a68c65d783a0600e84","modified":1574757868798},{"_id":"public/2019/10/14/eth/index.html","hash":"653b90e65b60e1d6444f469df3643f8e6e5c7c93","modified":1574757868798},{"_id":"public/2019/10/14/eth-build/index.html","hash":"f1d794c9a6e2f7f42f632d7772fb87a2eb098b31","modified":1574757868798},{"_id":"public/2019/10/14/eth-rlp/index.html","hash":"3b35312cc70f8cc853955a3b4fd5dc5c217a4770","modified":1574757868798},{"_id":"public/2019/10/14/eos-code/index.html","hash":"82e8dd59caaf93140928b334bb7230dd469e3566","modified":1574757868798},{"_id":"public/2019/10/14/eth-jsre-api/index.html","hash":"ff8bba961707f1a7187ec4e75fc41f0aa9f31ecd","modified":1574757868798},{"_id":"public/2019/10/14/eth-code-tx-event/index.html","hash":"98b670b1eb90c72a747213ef9575ad951dbab87a","modified":1574757868798},{"_id":"public/2019/10/14/eos/index.html","hash":"41ff40b0727a1d1a44dae338477fa2438fbf9639","modified":1574757868798},{"_id":"public/2019/10/14/zilliqa-network/index.html","hash":"cc12732a508dc0b0d3039c1a8fa9e44e3e475652","modified":1574757868799},{"_id":"public/2019/10/14/zilliqa/index.html","hash":"dd4e18a03ff77733344f98714283dbdacba2c785","modified":1574757868799},{"_id":"public/2019/10/14/blockchain/index.html","hash":"1482fc38ba4eb8d0feecbb7529bf90372bf84225","modified":1574757868799},{"_id":"public/2019/10/14/crypto/index.html","hash":"5fe2a958dc3d27926644875647951948f3360bb1","modified":1574757868799},{"_id":"public/2019/10/14/wallet-connection/index.html","hash":"2431253e79e5f327da12229178fe798736de61b1","modified":1574757868799},{"_id":"public/2019/10/12/how-to-set-up-a-blog/index.html","hash":"5efbce3b62e5c81c5e5ee36a511bd54edea1f4b1","modified":1574757868799},{"_id":"public/2019/04/14/btc-data-dat/index.html","hash":"786bacebf19eb2b2f908dee743d8ed7c85d91b4c","modified":1574757868799},{"_id":"public/2019/04/14/btc-wallet/index.html","hash":"336f947b75b8eafe44b4b5f38b37997b19339547","modified":1574757868799},{"_id":"public/2019/04/14/fabric-code-consensus-event/index.html","hash":"f1aaaf21efd4405ab74388f0a969cbdef1620fee","modified":1574757868799},{"_id":"public/2019/04/14/btc/index.html","hash":"8a91e1d6c6088671f3cc94bfd6eefc2e2b717ea5","modified":1574757868799},{"_id":"public/2019/04/11/fabric-example/index.html","hash":"eab142873876401918f392bc8242056fe7c68df2","modified":1574757868799},{"_id":"public/2017/10/14/elastic/index.html","hash":"0386377b0f248c15451681b92b3824b7b064ba60","modified":1574757868799},{"_id":"public/2017/10/14/elastic-painless/index.html","hash":"7704940d5adbdac1a8dfaacf100155dd87c7ce55","modified":1574757868799},{"_id":"public/2017/10/14/floodlight-sdn/index.html","hash":"547f03517e27c3448d654bfd103e3cc56f5205a4","modified":1574757868799},{"_id":"public/2017/10/14/elastic-template/index.html","hash":"f88ad8afb757f32ffa472e530beb2e206e3b5339","modified":1574757868799},{"_id":"public/2017/10/14/kibana-plugin-development/index.html","hash":"cd4eeb4629c6d4d56fd568b99ccae93f7137f669","modified":1574757868799},{"_id":"public/2017/10/14/elastic-logstash/index.html","hash":"5b7a16d97a58d688032182c02a315ac29139142e","modified":1574757868799},{"_id":"public/2017/10/14/kibana-plugin/index.html","hash":"6a639dde58dab588eca74271c834f89d77884e47","modified":1574757868799},{"_id":"public/2017/10/14/kibana-timeline/index.html","hash":"025c49b07015178f65f61793f10d951befe3611c","modified":1574757868799},{"_id":"public/2017/10/14/elastic-kibana/index.html","hash":"1d5f702da78f55029c448348e9743afea23396bf","modified":1574757868800},{"_id":"public/2017/10/14/elastic-search-dsl/index.html","hash":"a4beb7016f0f2f9d2e038230a6e979aaab8e1561","modified":1574757868800},{"_id":"public/2017/10/14/maven/index.html","hash":"038f6b62802f125d1fe447b41c66a147db3335a9","modified":1574757868800},{"_id":"public/2019/11/25/cosmos-ibc-store/index.html","hash":"c20f72e2e158bfb645b1f2ee85fecf21b1f66a25","modified":1574757868810},{"_id":"public/archives/page/5/index.html","hash":"0ca84b0fcd9e81a0e659e8e3ea5731c38c360b21","modified":1574757868810},{"_id":"public/archives/2019/page/4/index.html","hash":"392aab3bcfe1e4b01061e2fea43b63f743226d6a","modified":1574757868810},{"_id":"public/archives/2019/11/index.html","hash":"4856d4eb1b638cb67bfdc6146a3907cd1acb79ca","modified":1574757868810},{"_id":"public/categories/cosmos/index.html","hash":"a74d464759527ef96d1d16b63883018f1c4317b3","modified":1574757868810},{"_id":"public/page/5/index.html","hash":"f90925efe6a28126c5c62825b50dbac0079c50d0","modified":1574757868810},{"_id":"public/2019/11/26/cosmos-store/index.html","hash":"28b903dc5f8cae04ee0e0f3cafd379c47041aa77","modified":1574757868810},{"_id":"public/images/apple-touch-icon.png","hash":"57e2def34682655f41a0be2d083f16765ba7858b","modified":1574757868810},{"_id":"public/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1574757868810},{"_id":"public/lib/vazir-font/Vazir-Bold.woff","hash":"df15fd1e74b6f4a50bea57e2b44d9627f38495b5","modified":1574757868810},{"_id":"public/lib/vazir-font/Vazir-Black.woff2","hash":"0a257c8b60e0f20802c1dc8daeed2d3cb0d44f17","modified":1574757868810},{"_id":"public/lib/vazir-font/Vazir-Black.woff","hash":"37443d0040f0d7af381c955e4c15919a15d0349e","modified":1574757868810},{"_id":"public/lib/vazir-font/Vazir-Bold.woff2","hash":"62447a951d48b21c4696ae72df4bc4adef636e26","modified":1574757868810},{"_id":"public/lib/vazir-font/Vazir-Light.woff2","hash":"ef07a250766fea840c1049e67c0405d9216ee0a8","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir-Light.woff","hash":"32ae5c0d1d5943c8bb8e0f6ab07c3269c6f8b8a8","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir-Medium.woff","hash":"f5653059b2a5929516e4aab02329a978600b9b67","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir-Thin.woff","hash":"ad4d46a99a1daf6353c86c79ac3a2b030213859c","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir-Thin.woff2","hash":"c3be79b553ec394db71268d604b1d29183b867dc","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir-Medium.woff2","hash":"668400ae92700965f03f2371faaee0ab8c8347c3","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir.woff","hash":"bbee70033f0f5882e9869e417b69c6a38f56f187","modified":1574757868811},{"_id":"public/lib/vazir-font/Vazir.woff2","hash":"30ce165216db078951a690a6ad665b9b78f5dd81","modified":1574757868811},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff","hash":"7b3f44b4d3028f3c87ddf0f4bd62511c9bf4a87e","modified":1574757868811},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.eot","hash":"42ff503f20e97503cef8e5b2ec10ae07699d7c01","modified":1574757868811},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.ttf","hash":"c140085833a38abec6b7df99d4ccac93eb266031","modified":1574757868811},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"9784edb76f8a2ed595ea4bf74d46cda4eff3b303","modified":1574757868811},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"92da6e3c7121e21cdfde25ef08797a3937a683e1","modified":1574757868811},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"d902f8db3e021155f177f698a252fb98d6e61768","modified":1574757868811},{"_id":"public/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1574757869289},{"_id":"public/lib/vazir-font/Vazir-Black.ttf","hash":"594dc3344ad14903c247615427d1009709f0f5a4","modified":1574757869290},{"_id":"public/lib/vazir-font/Vazir-Black.eot","hash":"13d026ff857c853cbd0dc519b6e58669db309441","modified":1574757869290},{"_id":"public/lib/vazir-font/Vazir-Bold.eot","hash":"f76ec625e15522ff60d21f7a9a3b71c65bc27556","modified":1574757869290},{"_id":"public/lib/vazir-font/Vazir-Light.eot","hash":"3edffd7bb61eee8cd46b57225f9f9e5264e3362b","modified":1574757869290},{"_id":"public/lib/vazir-font/Vazir-Light.ttf","hash":"9f1e2934098a6a4a7c5584c8f3fa24a707070da3","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir-Medium.eot","hash":"1f5a73db7947ef22c8a2bb19d6449b80496c03c4","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir-Medium.ttf","hash":"295f7e02c9b157e7ea63ad09613b00ceab85c5cd","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir-Thin.eot","hash":"08e1503d1181188690fd9c81860d6c890c1465f6","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir.eot","hash":"31a9219c25fe1991fb745ec8dbbcf45c6094a702","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir-Bold.ttf","hash":"2e6c9df9f775373fb1988ae8529aa8f05313dae6","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir-Thin.ttf","hash":"a6aa450ee6e0f85786474ca6b04827ef97e81af4","modified":1574757869291},{"_id":"public/lib/vazir-font/Vazir.ttf","hash":"f22b219824026e490a581ddb3b36b07997dff0e3","modified":1574757869292},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff","hash":"f9d835a0f9248b1bb33d66968e87c4a50103ed8d","modified":1574757869292},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.ttf","hash":"19e302760e39e25a5f8d90d6cd0164ef6cd74f8c","modified":1574757869292},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff","hash":"80d33a73cbb60e206ef6f5c898988641576c7dda","modified":1574757869292},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.eot","hash":"644ece8263d2f96b087eebf7f6d4e309e5898eb5","modified":1574757869293},{"_id":"public/css/rtl.css","hash":"c2c2bc4ce311b3129275e009e903088b45e7ed77","modified":1574757869300},{"_id":"public/js/main.js","hash":"584c5a69ac81a483a1c4377a2e2cf326c2795e7b","modified":1574757869301},{"_id":"public/js/search.js","hash":"a74d0c601f820160825a2e4ad13618074d714933","modified":1574757869301},{"_id":"public/lib/vazir-font/font-face.css","hash":"8f2bf6b59ae1f2ed4c2fead6cea4b8314fcf62e5","modified":1574757869301},{"_id":"public/lib/justified-gallery/css/justifiedGallery.min.css","hash":"92bb6e468a1db7fbd99ccb960e15e28572254263","modified":1574757869302},{"_id":"public/css/style.css","hash":"ca4e1956edbd7224ad77186c4fab4f07ae4dedb5","modified":1574757869302},{"_id":"public/lib/clipboard/clipboard.min.js","hash":"ee60ca5ba9401456105ef703a98092369b579c80","modified":1574757869311},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.svg","hash":"33e86c0ad6fb9c5c0c8c2af4cb2d790c6b14a8aa","modified":1574757869311},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.eot","hash":"10740942ec6b3f4985529d343402d0bf32f9f847","modified":1574757869311},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.ttf","hash":"c445864a9646948e0d7ff44930ad732ee61427d8","modified":1574757869311},{"_id":"public/lib/justified-gallery/js/jquery.justifiedGallery.min.js","hash":"82ab395176c927ffbb2f7c95132ee0a06cd5d64a","modified":1574757869321},{"_id":"public/images/logo.png","hash":"0e3029251dfda26adee2761f71377297e8c26871","modified":1574757869321},{"_id":"public/lib/meslo-LG/MesloLGM-BoldItalic.ttf","hash":"b542b9591fbf33925d93f0695b6e123a9f0cfd43","modified":1574757869367},{"_id":"public/lib/meslo-LG/MesloLGL-BoldItalic.ttf","hash":"b7d24ab1e4fad720f31a2b0cca1904ce1740d846","modified":1574757869368},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"cf1a3fd771900af34f2af22142beecfb47367548","modified":1574757869371},{"_id":"public/lib/meslo-LG/MesloLGS-BoldItalic.ttf","hash":"926035f0156cccf1b0ca507347f39bf9c510f51e","modified":1574757869371},{"_id":"public/lib/meslo-LG/MesloLGM-Italic.ttf","hash":"93ebc5098cf57a32b7b8d297681f31692c09bdfa","modified":1574757869371},{"_id":"public/lib/meslo-LG/MesloLGS-Italic.ttf","hash":"9d757cc9f928fc83b2133283dd639c12b11d94ad","modified":1574757869371},{"_id":"public/lib/meslo-LG/MesloLGL-Italic.ttf","hash":"9a23c6898b0943bd3d96c04df9a0f66e919451d8","modified":1574757869372},{"_id":"public/lib/meslo-LG/MesloLGM-Bold.ttf","hash":"58be4b7760e9a84daa81929d046f9a15c4fd1c1a","modified":1574757869377},{"_id":"public/lib/meslo-LG/MesloLGL-Regular.ttf","hash":"6c090d6bff3928fbf8a5f4104e58ed7f421aea7c","modified":1574757869377},{"_id":"public/lib/meslo-LG/MesloLGL-Bold.ttf","hash":"34f7db59f1d023294e69976aa20b7d52b86165a4","modified":1574757869377},{"_id":"public/lib/meslo-LG/MesloLGS-Regular.ttf","hash":"de559f8d70d5b1ab2810597bfd0b1b9506f3ef01","modified":1574757869379},{"_id":"public/lib/meslo-LG/MesloLGM-Regular.ttf","hash":"20ce1fc7ae1254558ca044ae48283faaa58897e5","modified":1574757869381},{"_id":"public/lib/meslo-LG/MesloLGS-Bold.ttf","hash":"f9918fb93d6ab6850f5d38069a999c311af78816","modified":1574757869381},{"_id":"public/lib/jquery/jquery.min.js","hash":"0dc32db4aa9c5f03f3b38c47d883dbd4fed13aae","modified":1574757869383},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.svg","hash":"b0bb9e6ac7709206b9510f1718516d89aead5b21","modified":1574757869384},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.svg","hash":"ed6c1ed8f24df909f40fe5e5c652d7ff9570c821","modified":1574757869385}],"Category":[{"name":"btc","_id":"ck3fm69sg0004t6xv1be7s3d4"},{"name":"cosmos","_id":"ck3fm69sw0009t6xvkndkd51t"},{"name":"blockchain","_id":"ck3fm69tc000gt6xv4i87p24p"},{"name":"eth","_id":"ck3fm69tg000lt6xvu8visr1f"},{"name":"elk","_id":"ck3fm69tl000pt6xvbnuymqxi"},{"name":"eos","_id":"ck3fm69ut001ht6xvwn2qjqlv"},{"name":"fabric","_id":"ck3fm69uv001kt6xvvpu3me62"},{"name":"enjoy","_id":"ck3fm69v1001rt6xvnah1dc9l"},{"name":"enjoyment","_id":"ck3fm69v3001ut6xvf3tlgbyy"},{"name":"java","_id":"ck3fm69v4001wt6xvaua0bvbr"},{"name":"zilliqa","_id":"ck3fm69xa002jt6xvgdhxo4vu"}],"Data":[{"_id":"projects","data":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}],"Page":[{"title":"about","date":"2019-10-08T07:30:25.000Z","_content":"\n\n","source":"about/index.md","raw":"---\ntitle: about\ndate: 2019-10-08 15:30:25\n---\n\n\n","updated":"2019-10-08T10:49:51.007Z","path":"about/index.html","comments":1,"layout":"page","_id":"ck3fm69ry0000t6xv0j4hjcxp","content":"","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":""},{"title":"categories","date":"2019-10-12T03:37:20.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2019-10-12 11:37:20\ntype: \"categories\"\n---\n","updated":"2019-10-14T02:58:23.348Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ck3fm69s90002t6xv8ogcngo6","content":"","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":""},{"title":"search","date":"2019-10-10T05:56:44.000Z","type":"search","_content":"","source":"search/index.md","raw":"---\ntitle: search\ndate: 2019-10-10 13:56:44\ntype: search\n---\n","updated":"2019-10-14T05:47:04.769Z","path":"search/index.html","comments":1,"layout":"page","_id":"ck3fm69sk0005t6xv8b1gsqfr","content":"","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":""}],"Post":[{"title":"btc_wallet","date":"2019-04-14T06:41:55.000Z","_content":"\n### gocoin\n\n> <https://github.com/piotrnar/gocoin>\n>\n> **Gocoin** is a full **Bitcoin** solution written in Go language (golang).\n>\n> The software architecture is focused on maximum performance of the node and cold storage security of the wallet.\n>\n> The **wallet** is designed to be used offline. It is deterministic and password seeded. As long as you remember the password, you do not need any backups ever. Wallet can be used without the client, but with the provided **balio** tool instead.\n>\n> The **client** (p2p node) is an application independent from the **wallet**. It keeps the entire UTXO set in RAM, providing the best block processing performance on the market.\n\n\n\n#### blockdb\n\n- cache, blockblock\n- channelchannelflush channel db\n\n\n\n#### unspent_db\n\nutxo\n\n- map, keytxid, vtxidoutskey8txid328\n- updatetxidouts\n- ()\n\n\n\n#### wallet/db.go\n\naddr - utxo - balance\n\n```\nvar (\n\tAllBalancesP2KH, AllBalancesP2SH, AllBalancesP2WKH map[[20]byte]*OneAllAddrBal\n\tAllBalancesP2WSH                                   map[[32]byte]*OneAllAddrBal\n)\n\ntype OneAllAddrInp [utxo.UtxoIdxLen + 4]byte\n\ntype OneAllAddrBal struct {\n\tValue   uint64 // Highest bit of it means P2SH\n\tunsp    []OneAllAddrInp\n\tunspMap map[OneAllAddrInp]bool\n}\n\n```\n\nmapkeyaddrOneAllAddrInptxid8(unspend_dbmapkey)+n(out)\n\noutscript\n\n```\nif out.IsP2KH() {\n\t\tcopy(uidx[:], out.PKScr[3:23])\n\t\trec = AllBalancesP2KH[uidx]\n\t\tif rec == nil {\n\t\t\trec = &OneAllAddrBal{}\n\t\t\tAllBalancesP2KH[uidx] = rec\n\t\t}\n} else if out.IsP2SH() {\n\tcopy(uidx[:], out.PKScr[2:22])\n\trec = AllBalancesP2SH[uidx]\n\tif rec == nil {\n\t\trec = &OneAllAddrBal{}\n\t\tAllBalancesP2SH[uidx] = rec\n\t}\n} else if out.IsP2WPKH() {\n\tcopy(uidx[:], out.PKScr[2:22])\n\trec = AllBalancesP2WKH[uidx]\n\tif rec == nil {\n\t\trec = &OneAllAddrBal{}\n\t\tAllBalancesP2WKH[uidx] = rec\n\t}\n} else if out.IsP2WSH() {\n\tvar uidx [32]byte\n\tcopy(uidx[:], out.PKScr[2:34])\n\trec = AllBalancesP2WSH[uidx]\n\tif rec == nil {\n\t\trec = &OneAllAddrBal{}\n\t\tAllBalancesP2WSH[uidx] = rec\n\t}\n} else {\n\tcontinue\n}\n\n\n\nfunc (out *UtxoTxOut) IsP2KH() bool {\n\treturn len(out.PKScr) == 25 && out.PKScr[0] == 0x76 && out.PKScr[1] == 0xa9 &&\n\t\tout.PKScr[2] == 0x14 && out.PKScr[23] == 0x88 && out.PKScr[24] == 0xac\n}\n\nfunc (r *UtxoTxOut) IsP2SH() bool {\n\treturn len(r.PKScr) == 23 && r.PKScr[0] == 0xa9 && r.PKScr[1] == 0x14 && r.PKScr[22] == 0x87\n}\n\nfunc (r *UtxoTxOut) IsP2WPKH() bool {\n\treturn len(r.PKScr) == 22 && r.PKScr[0] == 0 && r.PKScr[1] == 20\n}\n\nfunc (r *UtxoTxOut) IsP2WSH() bool {\n\treturn len(r.PKScr) == 34 && r.PKScr[0] == 0 && r.PKScr[1] == 32\n}\n\n```\n\n\n\n\n\n#### \n\npeertrusttrust\n\n()eth()utxoundo, utxodoing\n\nlib/chain/blockdb.go,chain_accept.go\n\n\n\n\n\n```\n// Returns true if b1 has more POW than b2\nfunc (b1 *BlockTreeNode) MorePOW(b2 *BlockTreeNode) bool {\n\tvar b1sum, b2sum float64\n\tfor b1.Height > b2.Height {\n\t\tb1sum += btc.GetDifficulty(b1.Bits())\n\t\tb1 = b1.Parent\n\t}\n\tfor b2.Height > b1.Height {\n\t\tb2sum += btc.GetDifficulty(b2.Bits())\n\t\tb2 = b2.Parent\n\t}\n\tfor b1 != b2 {\n\t\tb1sum += btc.GetDifficulty(b1.Bits())\n\t\tb2sum += btc.GetDifficulty(b2.Bits())\n\t\tb1 = b1.Parent\n\t\tb2 = b2.Parent\n\t}\n\treturn b1sum > b2sum\n}\n\n```\n\n\n\n\n\n#### \n\ninputscript\n\n*P2PKH*inputpk+sigpk\n\nP2SH scriptpk\n\nout\n","source":"_posts/btc-wallet.md","raw":"---\ntitle: btc_wallet\ncategories:\n  - btc\ndate: 2019-4-14 14:41:55\ntags:\n---\n\n### gocoin\n\n> <https://github.com/piotrnar/gocoin>\n>\n> **Gocoin** is a full **Bitcoin** solution written in Go language (golang).\n>\n> The software architecture is focused on maximum performance of the node and cold storage security of the wallet.\n>\n> The **wallet** is designed to be used offline. It is deterministic and password seeded. As long as you remember the password, you do not need any backups ever. Wallet can be used without the client, but with the provided **balio** tool instead.\n>\n> The **client** (p2p node) is an application independent from the **wallet**. It keeps the entire UTXO set in RAM, providing the best block processing performance on the market.\n\n\n\n#### blockdb\n\n- cache, blockblock\n- channelchannelflush channel db\n\n\n\n#### unspent_db\n\nutxo\n\n- map, keytxid, vtxidoutskey8txid328\n- updatetxidouts\n- ()\n\n\n\n#### wallet/db.go\n\naddr - utxo - balance\n\n```\nvar (\n\tAllBalancesP2KH, AllBalancesP2SH, AllBalancesP2WKH map[[20]byte]*OneAllAddrBal\n\tAllBalancesP2WSH                                   map[[32]byte]*OneAllAddrBal\n)\n\ntype OneAllAddrInp [utxo.UtxoIdxLen + 4]byte\n\ntype OneAllAddrBal struct {\n\tValue   uint64 // Highest bit of it means P2SH\n\tunsp    []OneAllAddrInp\n\tunspMap map[OneAllAddrInp]bool\n}\n\n```\n\nmapkeyaddrOneAllAddrInptxid8(unspend_dbmapkey)+n(out)\n\noutscript\n\n```\nif out.IsP2KH() {\n\t\tcopy(uidx[:], out.PKScr[3:23])\n\t\trec = AllBalancesP2KH[uidx]\n\t\tif rec == nil {\n\t\t\trec = &OneAllAddrBal{}\n\t\t\tAllBalancesP2KH[uidx] = rec\n\t\t}\n} else if out.IsP2SH() {\n\tcopy(uidx[:], out.PKScr[2:22])\n\trec = AllBalancesP2SH[uidx]\n\tif rec == nil {\n\t\trec = &OneAllAddrBal{}\n\t\tAllBalancesP2SH[uidx] = rec\n\t}\n} else if out.IsP2WPKH() {\n\tcopy(uidx[:], out.PKScr[2:22])\n\trec = AllBalancesP2WKH[uidx]\n\tif rec == nil {\n\t\trec = &OneAllAddrBal{}\n\t\tAllBalancesP2WKH[uidx] = rec\n\t}\n} else if out.IsP2WSH() {\n\tvar uidx [32]byte\n\tcopy(uidx[:], out.PKScr[2:34])\n\trec = AllBalancesP2WSH[uidx]\n\tif rec == nil {\n\t\trec = &OneAllAddrBal{}\n\t\tAllBalancesP2WSH[uidx] = rec\n\t}\n} else {\n\tcontinue\n}\n\n\n\nfunc (out *UtxoTxOut) IsP2KH() bool {\n\treturn len(out.PKScr) == 25 && out.PKScr[0] == 0x76 && out.PKScr[1] == 0xa9 &&\n\t\tout.PKScr[2] == 0x14 && out.PKScr[23] == 0x88 && out.PKScr[24] == 0xac\n}\n\nfunc (r *UtxoTxOut) IsP2SH() bool {\n\treturn len(r.PKScr) == 23 && r.PKScr[0] == 0xa9 && r.PKScr[1] == 0x14 && r.PKScr[22] == 0x87\n}\n\nfunc (r *UtxoTxOut) IsP2WPKH() bool {\n\treturn len(r.PKScr) == 22 && r.PKScr[0] == 0 && r.PKScr[1] == 20\n}\n\nfunc (r *UtxoTxOut) IsP2WSH() bool {\n\treturn len(r.PKScr) == 34 && r.PKScr[0] == 0 && r.PKScr[1] == 32\n}\n\n```\n\n\n\n\n\n#### \n\npeertrusttrust\n\n()eth()utxoundo, utxodoing\n\nlib/chain/blockdb.go,chain_accept.go\n\n\n\n\n\n```\n// Returns true if b1 has more POW than b2\nfunc (b1 *BlockTreeNode) MorePOW(b2 *BlockTreeNode) bool {\n\tvar b1sum, b2sum float64\n\tfor b1.Height > b2.Height {\n\t\tb1sum += btc.GetDifficulty(b1.Bits())\n\t\tb1 = b1.Parent\n\t}\n\tfor b2.Height > b1.Height {\n\t\tb2sum += btc.GetDifficulty(b2.Bits())\n\t\tb2 = b2.Parent\n\t}\n\tfor b1 != b2 {\n\t\tb1sum += btc.GetDifficulty(b1.Bits())\n\t\tb2sum += btc.GetDifficulty(b2.Bits())\n\t\tb1 = b1.Parent\n\t\tb2 = b2.Parent\n\t}\n\treturn b1sum > b2sum\n}\n\n```\n\n\n\n\n\n#### \n\ninputscript\n\n*P2PKH*inputpk+sigpk\n\nP2SH scriptpk\n\nout\n","slug":"btc-wallet","published":1,"updated":"2019-10-14T07:25:34.654Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69s20001t6xv2z74fwdn","content":"<h3 id=\"gocoin\"><a href=\"#gocoin\" class=\"headerlink\" title=\"gocoin\"></a>gocoin</h3><blockquote>\n<p><a href=\"https://github.com/piotrnar/gocoin\">https://github.com/piotrnar/gocoin</a></p>\n<p><strong>Gocoin</strong> is a full <strong>Bitcoin</strong> solution written in Go language (golang).</p>\n<p>The software architecture is focused on maximum performance of the node and cold storage security of the wallet.</p>\n<p>The <strong>wallet</strong> is designed to be used offline. It is deterministic and password seeded. As long as you remember the password, you do not need any backups ever. Wallet can be used without the client, but with the provided <strong>balio</strong> tool instead.</p>\n<p>The <strong>client</strong> (p2p node) is an application independent from the <strong>wallet</strong>. It keeps the entire UTXO set in RAM, providing the best block processing performance on the market.</p>\n</blockquote>\n<h4 id=\"blockdb\"><a href=\"#blockdb\" class=\"headerlink\" title=\"blockdb\"></a>blockdb</h4><ul>\n<li>cache, blockblock</li>\n<li>channelchannelflush channel db</li>\n</ul>\n<h4 id=\"unspent-db\"><a href=\"#unspent-db\" class=\"headerlink\" title=\"unspent_db\"></a>unspent_db</h4><p>utxo</p>\n<ul>\n<li>map, keytxid, vtxidoutskey8txid328</li>\n<li>updatetxidouts</li>\n<li>()</li>\n</ul>\n<h4 id=\"wallet-db-go\"><a href=\"#wallet-db-go\" class=\"headerlink\" title=\"wallet/db.go\"></a>wallet/db.go</h4><p>addr - utxo - balance</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var (</span><br><span class=\"line\">\tAllBalancesP2KH, AllBalancesP2SH, AllBalancesP2WKH map[[20]byte]*OneAllAddrBal</span><br><span class=\"line\">\tAllBalancesP2WSH                                   map[[32]byte]*OneAllAddrBal</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type OneAllAddrInp [utxo.UtxoIdxLen + 4]byte</span><br><span class=\"line\"></span><br><span class=\"line\">type OneAllAddrBal struct &#123;</span><br><span class=\"line\">\tValue   uint64 // Highest bit of it means P2SH</span><br><span class=\"line\">\tunsp    []OneAllAddrInp</span><br><span class=\"line\">\tunspMap map[OneAllAddrInp]bool</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>mapkeyaddrOneAllAddrInptxid8(unspend_dbmapkey)+n(out)</p>\n<p>outscript</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if out.IsP2KH() &#123;</span><br><span class=\"line\">\t\tcopy(uidx[:], out.PKScr[3:23])</span><br><span class=\"line\">\t\trec = AllBalancesP2KH[uidx]</span><br><span class=\"line\">\t\tif rec == nil &#123;</span><br><span class=\"line\">\t\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\t\tAllBalancesP2KH[uidx] = rec</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125; else if out.IsP2SH() &#123;</span><br><span class=\"line\">\tcopy(uidx[:], out.PKScr[2:22])</span><br><span class=\"line\">\trec = AllBalancesP2SH[uidx]</span><br><span class=\"line\">\tif rec == nil &#123;</span><br><span class=\"line\">\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\tAllBalancesP2SH[uidx] = rec</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; else if out.IsP2WPKH() &#123;</span><br><span class=\"line\">\tcopy(uidx[:], out.PKScr[2:22])</span><br><span class=\"line\">\trec = AllBalancesP2WKH[uidx]</span><br><span class=\"line\">\tif rec == nil &#123;</span><br><span class=\"line\">\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\tAllBalancesP2WKH[uidx] = rec</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; else if out.IsP2WSH() &#123;</span><br><span class=\"line\">\tvar uidx [32]byte</span><br><span class=\"line\">\tcopy(uidx[:], out.PKScr[2:34])</span><br><span class=\"line\">\trec = AllBalancesP2WSH[uidx]</span><br><span class=\"line\">\tif rec == nil &#123;</span><br><span class=\"line\">\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\tAllBalancesP2WSH[uidx] = rec</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; else &#123;</span><br><span class=\"line\">\tcontinue</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func (out *UtxoTxOut) IsP2KH() bool &#123;</span><br><span class=\"line\">\treturn len(out.PKScr) == 25 &amp;&amp; out.PKScr[0] == 0x76 &amp;&amp; out.PKScr[1] == 0xa9 &amp;&amp;</span><br><span class=\"line\">\t\tout.PKScr[2] == 0x14 &amp;&amp; out.PKScr[23] == 0x88 &amp;&amp; out.PKScr[24] == 0xac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (r *UtxoTxOut) IsP2SH() bool &#123;</span><br><span class=\"line\">\treturn len(r.PKScr) == 23 &amp;&amp; r.PKScr[0] == 0xa9 &amp;&amp; r.PKScr[1] == 0x14 &amp;&amp; r.PKScr[22] == 0x87</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (r *UtxoTxOut) IsP2WPKH() bool &#123;</span><br><span class=\"line\">\treturn len(r.PKScr) == 22 &amp;&amp; r.PKScr[0] == 0 &amp;&amp; r.PKScr[1] == 20</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (r *UtxoTxOut) IsP2WSH() bool &#123;</span><br><span class=\"line\">\treturn len(r.PKScr) == 34 &amp;&amp; r.PKScr[0] == 0 &amp;&amp; r.PKScr[1] == 32</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>peertrusttrust</p>\n<p>()eth()utxoundo, utxodoing</p>\n<p>lib/chain/blockdb.go,chain_accept.go</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Returns true if b1 has more POW than b2</span><br><span class=\"line\">func (b1 *BlockTreeNode) MorePOW(b2 *BlockTreeNode) bool &#123;</span><br><span class=\"line\">\tvar b1sum, b2sum float64</span><br><span class=\"line\">\tfor b1.Height &gt; b2.Height &#123;</span><br><span class=\"line\">\t\tb1sum += btc.GetDifficulty(b1.Bits())</span><br><span class=\"line\">\t\tb1 = b1.Parent</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor b2.Height &gt; b1.Height &#123;</span><br><span class=\"line\">\t\tb2sum += btc.GetDifficulty(b2.Bits())</span><br><span class=\"line\">\t\tb2 = b2.Parent</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor b1 != b2 &#123;</span><br><span class=\"line\">\t\tb1sum += btc.GetDifficulty(b1.Bits())</span><br><span class=\"line\">\t\tb2sum += btc.GetDifficulty(b2.Bits())</span><br><span class=\"line\">\t\tb1 = b1.Parent</span><br><span class=\"line\">\t\tb2 = b2.Parent</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn b1sum &gt; b2sum</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>inputscript</p>\n<p><em>P2PKH</em>inputpk+sigpk</p>\n<p>P2SH scriptpk</p>\n<p>out</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h3 id=\"gocoin\"><a href=\"#gocoin\" class=\"headerlink\" title=\"gocoin\"></a>gocoin</h3><blockquote>\n<p><a href=\"https://github.com/piotrnar/gocoin\">https://github.com/piotrnar/gocoin</a></p>\n<p><strong>Gocoin</strong> is a full <strong>Bitcoin</strong> solution written in Go language (golang).</p>\n<p>The software architecture is focused on maximum performance of the node and cold storage security of the wallet.</p>\n<p>The <strong>wallet</strong> is designed to be used offline. It is deterministic and password seeded. As long as you remember the password, you do not need any backups ever. Wallet can be used without the client, but with the provided <strong>balio</strong> tool instead.</p>\n<p>The <strong>client</strong> (p2p node) is an application independent from the <strong>wallet</strong>. It keeps the entire UTXO set in RAM, providing the best block processing performance on the market.</p>\n</blockquote>\n<h4 id=\"blockdb\"><a href=\"#blockdb\" class=\"headerlink\" title=\"blockdb\"></a>blockdb</h4><ul>\n<li>cache, blockblock</li>\n<li>channelchannelflush channel db</li>\n</ul>\n<h4 id=\"unspent-db\"><a href=\"#unspent-db\" class=\"headerlink\" title=\"unspent_db\"></a>unspent_db</h4><p>utxo</p>\n<ul>\n<li>map, keytxid, vtxidoutskey8txid328</li>\n<li>updatetxidouts</li>\n<li>()</li>\n</ul>\n<h4 id=\"wallet-db-go\"><a href=\"#wallet-db-go\" class=\"headerlink\" title=\"wallet/db.go\"></a>wallet/db.go</h4><p>addr - utxo - balance</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var (</span><br><span class=\"line\">\tAllBalancesP2KH, AllBalancesP2SH, AllBalancesP2WKH map[[20]byte]*OneAllAddrBal</span><br><span class=\"line\">\tAllBalancesP2WSH                                   map[[32]byte]*OneAllAddrBal</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type OneAllAddrInp [utxo.UtxoIdxLen + 4]byte</span><br><span class=\"line\"></span><br><span class=\"line\">type OneAllAddrBal struct &#123;</span><br><span class=\"line\">\tValue   uint64 // Highest bit of it means P2SH</span><br><span class=\"line\">\tunsp    []OneAllAddrInp</span><br><span class=\"line\">\tunspMap map[OneAllAddrInp]bool</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>mapkeyaddrOneAllAddrInptxid8(unspend_dbmapkey)+n(out)</p>\n<p>outscript</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if out.IsP2KH() &#123;</span><br><span class=\"line\">\t\tcopy(uidx[:], out.PKScr[3:23])</span><br><span class=\"line\">\t\trec = AllBalancesP2KH[uidx]</span><br><span class=\"line\">\t\tif rec == nil &#123;</span><br><span class=\"line\">\t\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\t\tAllBalancesP2KH[uidx] = rec</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125; else if out.IsP2SH() &#123;</span><br><span class=\"line\">\tcopy(uidx[:], out.PKScr[2:22])</span><br><span class=\"line\">\trec = AllBalancesP2SH[uidx]</span><br><span class=\"line\">\tif rec == nil &#123;</span><br><span class=\"line\">\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\tAllBalancesP2SH[uidx] = rec</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; else if out.IsP2WPKH() &#123;</span><br><span class=\"line\">\tcopy(uidx[:], out.PKScr[2:22])</span><br><span class=\"line\">\trec = AllBalancesP2WKH[uidx]</span><br><span class=\"line\">\tif rec == nil &#123;</span><br><span class=\"line\">\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\tAllBalancesP2WKH[uidx] = rec</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; else if out.IsP2WSH() &#123;</span><br><span class=\"line\">\tvar uidx [32]byte</span><br><span class=\"line\">\tcopy(uidx[:], out.PKScr[2:34])</span><br><span class=\"line\">\trec = AllBalancesP2WSH[uidx]</span><br><span class=\"line\">\tif rec == nil &#123;</span><br><span class=\"line\">\t\trec = &amp;OneAllAddrBal&#123;&#125;</span><br><span class=\"line\">\t\tAllBalancesP2WSH[uidx] = rec</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125; else &#123;</span><br><span class=\"line\">\tcontinue</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func (out *UtxoTxOut) IsP2KH() bool &#123;</span><br><span class=\"line\">\treturn len(out.PKScr) == 25 &amp;&amp; out.PKScr[0] == 0x76 &amp;&amp; out.PKScr[1] == 0xa9 &amp;&amp;</span><br><span class=\"line\">\t\tout.PKScr[2] == 0x14 &amp;&amp; out.PKScr[23] == 0x88 &amp;&amp; out.PKScr[24] == 0xac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (r *UtxoTxOut) IsP2SH() bool &#123;</span><br><span class=\"line\">\treturn len(r.PKScr) == 23 &amp;&amp; r.PKScr[0] == 0xa9 &amp;&amp; r.PKScr[1] == 0x14 &amp;&amp; r.PKScr[22] == 0x87</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (r *UtxoTxOut) IsP2WPKH() bool &#123;</span><br><span class=\"line\">\treturn len(r.PKScr) == 22 &amp;&amp; r.PKScr[0] == 0 &amp;&amp; r.PKScr[1] == 20</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (r *UtxoTxOut) IsP2WSH() bool &#123;</span><br><span class=\"line\">\treturn len(r.PKScr) == 34 &amp;&amp; r.PKScr[0] == 0 &amp;&amp; r.PKScr[1] == 32</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>peertrusttrust</p>\n<p>()eth()utxoundo, utxodoing</p>\n<p>lib/chain/blockdb.go,chain_accept.go</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Returns true if b1 has more POW than b2</span><br><span class=\"line\">func (b1 *BlockTreeNode) MorePOW(b2 *BlockTreeNode) bool &#123;</span><br><span class=\"line\">\tvar b1sum, b2sum float64</span><br><span class=\"line\">\tfor b1.Height &gt; b2.Height &#123;</span><br><span class=\"line\">\t\tb1sum += btc.GetDifficulty(b1.Bits())</span><br><span class=\"line\">\t\tb1 = b1.Parent</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor b2.Height &gt; b1.Height &#123;</span><br><span class=\"line\">\t\tb2sum += btc.GetDifficulty(b2.Bits())</span><br><span class=\"line\">\t\tb2 = b2.Parent</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor b1 != b2 &#123;</span><br><span class=\"line\">\t\tb1sum += btc.GetDifficulty(b1.Bits())</span><br><span class=\"line\">\t\tb2sum += btc.GetDifficulty(b2.Bits())</span><br><span class=\"line\">\t\tb1 = b1.Parent</span><br><span class=\"line\">\t\tb2 = b2.Parent</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn b1sum &gt; b2sum</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>inputscript</p>\n<p><em>P2PKH</em>inputpk+sigpk</p>\n<p>P2SH scriptpk</p>\n<p>out</p>\n"},{"title":"cosmos-ibc-store","date":"2019-11-25T06:18:49.000Z","_content":"\n## Cosmos-ibc\n\ncosmos ibc\n\nkey-value\n\ncosmos-sdkfedekunze/ibc - 94ffaeb9f746d13b68678423d4aee0828f652fd4\n\n\n\n+ Client\n\n| Key                              | Value          |                                                    |\n| -------------------------------- | -------------- | ------------------------------------------------------ |\n| client/`clientID`/roots/`height` | Hash-root      | merkle                             |\n| client/`clientID`/consensusState | consensusState | root |\n| clients/`clientID`/state         | bool           | clientID()                   |\n| clients/`clientID`/type          | []byte         | (tendermint)                         |\n\nclient//\n\n\n\n+ Connection\n\n| Key                            | Value                                   |                |\n| ------------------------------ | --------------------------------------- | ------------------ |\n| connections/`connectionID`     | Connection(state/clientID/counterParty) |            |\n| clients/`clientID`/connections | []connectionIDs                         | clientID |\n|                                |                                         |                    |\n\n+ Channel\n\nPath = ports/`portID`/channel/`channelID`\n\n| Key                   | Value                                         |      |\n| --------------------- | :-------------------------------------------- | -------- |\n| Path                  | Channel(state/ordering/counterParty/connHops) |  |\n| Path/nextSequenceSend | Sequenceuint64                            |          |\n| Path/nextSequenceRecv | Sequenceuint64                            |          |\n\n\n\n+ Packet\n\n","source":"_posts/cosmos-ibc-store.md","raw":"---\ntitle: cosmos-ibc-store\ncategories:\n  - cosmos\ndate: 2019-11-25 14:18:49\ntags:\n---\n\n## Cosmos-ibc\n\ncosmos ibc\n\nkey-value\n\ncosmos-sdkfedekunze/ibc - 94ffaeb9f746d13b68678423d4aee0828f652fd4\n\n\n\n+ Client\n\n| Key                              | Value          |                                                    |\n| -------------------------------- | -------------- | ------------------------------------------------------ |\n| client/`clientID`/roots/`height` | Hash-root      | merkle                             |\n| client/`clientID`/consensusState | consensusState | root |\n| clients/`clientID`/state         | bool           | clientID()                   |\n| clients/`clientID`/type          | []byte         | (tendermint)                         |\n\nclient//\n\n\n\n+ Connection\n\n| Key                            | Value                                   |                |\n| ------------------------------ | --------------------------------------- | ------------------ |\n| connections/`connectionID`     | Connection(state/clientID/counterParty) |            |\n| clients/`clientID`/connections | []connectionIDs                         | clientID |\n|                                |                                         |                    |\n\n+ Channel\n\nPath = ports/`portID`/channel/`channelID`\n\n| Key                   | Value                                         |      |\n| --------------------- | :-------------------------------------------- | -------- |\n| Path                  | Channel(state/ordering/counterParty/connHops) |  |\n| Path/nextSequenceSend | Sequenceuint64                            |          |\n| Path/nextSequenceRecv | Sequenceuint64                            |          |\n\n\n\n+ Packet\n\n","slug":"cosmos-ibc-store","published":1,"updated":"2019-11-26T06:33:53.483Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69sa0003t6xv6cp9rp4p","content":"<h2 id=\"Cosmos-ibc\"><a href=\"#Cosmos-ibc\" class=\"headerlink\" title=\"Cosmos-ibc\"></a>Cosmos-ibc</h2><p>cosmos ibc</p>\n<p>key-value</p>\n<p>cosmos-sdkfedekunze/ibc - 94ffaeb9f746d13b68678423d4aee0828f652fd4</p>\n<ul>\n<li>Client</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Value</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>client/<code>clientID</code>/roots/<code>height</code></td>\n<td>Hash-root</td>\n<td>merkle</td>\n</tr>\n<tr>\n<td>client/<code>clientID</code>/consensusState</td>\n<td>consensusState</td>\n<td>root</td>\n</tr>\n<tr>\n<td>clients/<code>clientID</code>/state</td>\n<td>bool</td>\n<td>clientID()</td>\n</tr>\n<tr>\n<td>clients/<code>clientID</code>/type</td>\n<td>[]byte</td>\n<td>(tendermint)</td>\n</tr>\n</tbody></table>\n<p>client//</p>\n<ul>\n<li>Connection</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Value</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>connections/<code>connectionID</code></td>\n<td>Connection(state/clientID/counterParty)</td>\n<td></td>\n</tr>\n<tr>\n<td>clients/<code>clientID</code>/connections</td>\n<td>[]connectionIDs</td>\n<td>clientID</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<ul>\n<li>Channel</li>\n</ul>\n<p>Path = ports/<code>portID</code>/channel/<code>channelID</code></p>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th align=\"left\">Value</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Path</td>\n<td align=\"left\">Channel(state/ordering/counterParty/connHops)</td>\n<td></td>\n</tr>\n<tr>\n<td>Path/nextSequenceSend</td>\n<td align=\"left\">Sequenceuint64</td>\n<td></td>\n</tr>\n<tr>\n<td>Path/nextSequenceRecv</td>\n<td align=\"left\">Sequenceuint64</td>\n<td></td>\n</tr>\n</tbody></table>\n<ul>\n<li>Packet</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Cosmos-ibc\"><a href=\"#Cosmos-ibc\" class=\"headerlink\" title=\"Cosmos-ibc\"></a>Cosmos-ibc</h2><p>cosmos ibc</p>\n<p>key-value</p>\n<p>cosmos-sdkfedekunze/ibc - 94ffaeb9f746d13b68678423d4aee0828f652fd4</p>\n<ul>\n<li>Client</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Value</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>client/<code>clientID</code>/roots/<code>height</code></td>\n<td>Hash-root</td>\n<td>merkle</td>\n</tr>\n<tr>\n<td>client/<code>clientID</code>/consensusState</td>\n<td>consensusState</td>\n<td>root</td>\n</tr>\n<tr>\n<td>clients/<code>clientID</code>/state</td>\n<td>bool</td>\n<td>clientID()</td>\n</tr>\n<tr>\n<td>clients/<code>clientID</code>/type</td>\n<td>[]byte</td>\n<td>(tendermint)</td>\n</tr>\n</tbody></table>\n<p>client//</p>\n<ul>\n<li>Connection</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Value</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>connections/<code>connectionID</code></td>\n<td>Connection(state/clientID/counterParty)</td>\n<td></td>\n</tr>\n<tr>\n<td>clients/<code>clientID</code>/connections</td>\n<td>[]connectionIDs</td>\n<td>clientID</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<ul>\n<li>Channel</li>\n</ul>\n<p>Path = ports/<code>portID</code>/channel/<code>channelID</code></p>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th align=\"left\">Value</th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Path</td>\n<td align=\"left\">Channel(state/ordering/counterParty/connHops)</td>\n<td></td>\n</tr>\n<tr>\n<td>Path/nextSequenceSend</td>\n<td align=\"left\">Sequenceuint64</td>\n<td></td>\n</tr>\n<tr>\n<td>Path/nextSequenceRecv</td>\n<td align=\"left\">Sequenceuint64</td>\n<td></td>\n</tr>\n</tbody></table>\n<ul>\n<li>Packet</li>\n</ul>\n"},{"title":"cosmos-store","date":"2019-11-26T06:34:13.000Z","_content":"\n\n\n###  Cosmos state\n\n apiapikeyvalueproofproofvalue\n\n\n\ncosms-sdk`x/`\n\n`store/rootmulti/store.go`..  rootroot\n\n#### \n\n`store/rootmulti/store.go`\n\n```\ntype Store struct {\n\t\tdb           dbm.DB  //db\n\t\tlastCommitID types.CommitID\n\t\tpruningOpts  types.PruningOptions\n\t\tstoresParams map[types.StoreKey]storeParams //1\n\t\tstores       map[types.StoreKey]types.CommitKVStore //2\n\t\tkeysByName   map[string]types.StoreKey  //3\n\t\tlazyLoading  bool\n\n\t\ttraceWriter  io.Writer\n\t\ttraceContext types.TraceContext\n\n\t\tinterBlockCache types.MultiStorePersistentCache\n}\n```\n\n123map3keystringvalueKeyKey12 key1valuestoreParams2`types.CommitKVStore``types.CommitKVStore``store/transient/store.go``store/iavl/store.go`iavl...gaiastoreiavl`ival`\n\n\n\n#####  ival\n\n`store/iavl/store.go`tree.....\n\n... tree..\n\n```\n//store/iavl/store_test.go\n\nvar (\n\ttreeData = map[string]string{\n\t\t\"hello\": \"goodbye\",\n\t\t\"aloha\": \"shalom\",\n\t}\n\tnMoreData = 0\n)\n\nfunc newAlohaTree(t *testing.T, db dbm.DB) (*iavl.MutableTree, types.CommitID) {\n\ttree := iavl.NewMutableTree(db, cacheSize)\n\tfor k, v := range treeData {\n\t\ttree.Set([]byte(k), []byte(v))  //\"hello\" => \"goodbye\"; \"aloha\" =>\"shalom\"\n\t}\n\tfor i := 0; i < nMoreData; i++ {\n\t\tkey := cmn.RandBytes(12)\n\t\tvalue := cmn.RandBytes(50)\n\t\ttree.Set(key, value)\n\t}\n\thash, ver, err := tree.SaveVersion()\n\trequire.Nil(t, err)\n\treturn tree, types.CommitID{Version: ver, Hash: hash}\n}\n\n\nfunc TestGetImmutable(t *testing.T) {\n\tdb := dbm.NewMemDB()\n\ttree, cID := newAlohaTree(t, db)   //treekey-valuesaveVersion\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//version=1\n\tstore := UnsafeNewStore(tree, 10, 10)\n\t//\ttreekey=\"hello\"value\"goodbye\"\"adios\"\n\trequire.True(t, tree.Set([]byte(\"hello\"), []byte(\"adios\")))  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\thash, ver, err := tree.SaveVersion()  //verversion=2\n\tcID = types.CommitID{Version: ver, Hash: hash}  //hash => root\n\trequire.Nil(t, err)\n\t_, err = store.GetImmutable(cID.Version + 1)\n\trequire.Error(t, err)   //version=3err\n\n\tnewStore, err := store.GetImmutable(cID.Version - 1)  //version=1\n\trequire.NoError(t, err)                           //hellovaluegoodbye\n\trequire.Equal(t, newStore.Get([]byte(\"hello\")), []byte(\"goodbye\"))\n\n\tnewStore, err = store.GetImmutable(cID.Version)   //version=2\n\trequire.NoError(t, err)\t\t\t\t\t\t\t\t\t\t\t\t\t//hellovalueadios\n\trequire.Equal(t, newStore.Get([]byte(\"hello\")), []byte(\"adios\"))\n\n  //abci Querykey=helloversion=2value\n\tres := newStore.Query(abci.RequestQuery{Data: []byte(\"hello\"), Height: cID.Version, Path: \"/key\", Prove: true})\n\trequire.Equal(t, res.Value, []byte(\"adios\"))\n\trequire.NotNil(t, res.Proof)\n\n\trequire.Panics(t, func() { newStore.Set(nil, nil) })\n\trequire.Panics(t, func() { newStore.Delete(nil) })\n\trequire.Panics(t, func() { newStore.Commit() })\n}\n\n```\n\n\n\n##### rootmulti\n\n`rootmulti/store`\n\n`store/rootmulti/store_test.go`\n\n```\nfunc TestHashStableWithEmptyCommit(t *testing.T) {\n\tvar db dbm.DB = dbm.NewMemDB()\n\tms := newMultiStoreWithMounts(db)\n\terr := ms.LoadLatestVersion()\n\trequire.Nil(t, err)\n\n\tcommitID := types.CommitID{}\n\tcheckStore(t, ms, commitID, commitID)\n\n\tk, v := []byte(\"wind\"), []byte(\"blows\")\n  //key=store1store1\n\tstore1 := ms.getStoreByName(\"store1\").(types.KVStore)\n\t//store1k-v\n\tstore1.Set(k, v)\n\n //ms.Commit, store1.SaveVersion\n\tcID := ms.Commit()\n\trequire.Equal(t, int64(1), cID.Version)\n\thash := cID.Hash\n\t// make an empty commit, it should update version, but not affect hash\n\tcID = ms.Commit()\n\trequire.Equal(t, int64(2), cID.Version)\n\trequire.Equal(t, hash, cID.Hash)\n}\n```\n\n``store/rootmulti/store_test.go`\n\n\n\nkeykeyroothashrootmultiroot-hashapphash\n\n\n\nkey-valuekey-value(store-key)roothashroothashapphashapphash\n\n\n\n\n\n","source":"_posts/cosmos-store.md","raw":"---\ntitle: cosmos-store\ncategories:\n  - cosmos\ndate: 2019-11-26 14:34:13\ntags:\n---\n\n\n\n###  Cosmos state\n\n apiapikeyvalueproofproofvalue\n\n\n\ncosms-sdk`x/`\n\n`store/rootmulti/store.go`..  rootroot\n\n#### \n\n`store/rootmulti/store.go`\n\n```\ntype Store struct {\n\t\tdb           dbm.DB  //db\n\t\tlastCommitID types.CommitID\n\t\tpruningOpts  types.PruningOptions\n\t\tstoresParams map[types.StoreKey]storeParams //1\n\t\tstores       map[types.StoreKey]types.CommitKVStore //2\n\t\tkeysByName   map[string]types.StoreKey  //3\n\t\tlazyLoading  bool\n\n\t\ttraceWriter  io.Writer\n\t\ttraceContext types.TraceContext\n\n\t\tinterBlockCache types.MultiStorePersistentCache\n}\n```\n\n123map3keystringvalueKeyKey12 key1valuestoreParams2`types.CommitKVStore``types.CommitKVStore``store/transient/store.go``store/iavl/store.go`iavl...gaiastoreiavl`ival`\n\n\n\n#####  ival\n\n`store/iavl/store.go`tree.....\n\n... tree..\n\n```\n//store/iavl/store_test.go\n\nvar (\n\ttreeData = map[string]string{\n\t\t\"hello\": \"goodbye\",\n\t\t\"aloha\": \"shalom\",\n\t}\n\tnMoreData = 0\n)\n\nfunc newAlohaTree(t *testing.T, db dbm.DB) (*iavl.MutableTree, types.CommitID) {\n\ttree := iavl.NewMutableTree(db, cacheSize)\n\tfor k, v := range treeData {\n\t\ttree.Set([]byte(k), []byte(v))  //\"hello\" => \"goodbye\"; \"aloha\" =>\"shalom\"\n\t}\n\tfor i := 0; i < nMoreData; i++ {\n\t\tkey := cmn.RandBytes(12)\n\t\tvalue := cmn.RandBytes(50)\n\t\ttree.Set(key, value)\n\t}\n\thash, ver, err := tree.SaveVersion()\n\trequire.Nil(t, err)\n\treturn tree, types.CommitID{Version: ver, Hash: hash}\n}\n\n\nfunc TestGetImmutable(t *testing.T) {\n\tdb := dbm.NewMemDB()\n\ttree, cID := newAlohaTree(t, db)   //treekey-valuesaveVersion\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//version=1\n\tstore := UnsafeNewStore(tree, 10, 10)\n\t//\ttreekey=\"hello\"value\"goodbye\"\"adios\"\n\trequire.True(t, tree.Set([]byte(\"hello\"), []byte(\"adios\")))  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\thash, ver, err := tree.SaveVersion()  //verversion=2\n\tcID = types.CommitID{Version: ver, Hash: hash}  //hash => root\n\trequire.Nil(t, err)\n\t_, err = store.GetImmutable(cID.Version + 1)\n\trequire.Error(t, err)   //version=3err\n\n\tnewStore, err := store.GetImmutable(cID.Version - 1)  //version=1\n\trequire.NoError(t, err)                           //hellovaluegoodbye\n\trequire.Equal(t, newStore.Get([]byte(\"hello\")), []byte(\"goodbye\"))\n\n\tnewStore, err = store.GetImmutable(cID.Version)   //version=2\n\trequire.NoError(t, err)\t\t\t\t\t\t\t\t\t\t\t\t\t//hellovalueadios\n\trequire.Equal(t, newStore.Get([]byte(\"hello\")), []byte(\"adios\"))\n\n  //abci Querykey=helloversion=2value\n\tres := newStore.Query(abci.RequestQuery{Data: []byte(\"hello\"), Height: cID.Version, Path: \"/key\", Prove: true})\n\trequire.Equal(t, res.Value, []byte(\"adios\"))\n\trequire.NotNil(t, res.Proof)\n\n\trequire.Panics(t, func() { newStore.Set(nil, nil) })\n\trequire.Panics(t, func() { newStore.Delete(nil) })\n\trequire.Panics(t, func() { newStore.Commit() })\n}\n\n```\n\n\n\n##### rootmulti\n\n`rootmulti/store`\n\n`store/rootmulti/store_test.go`\n\n```\nfunc TestHashStableWithEmptyCommit(t *testing.T) {\n\tvar db dbm.DB = dbm.NewMemDB()\n\tms := newMultiStoreWithMounts(db)\n\terr := ms.LoadLatestVersion()\n\trequire.Nil(t, err)\n\n\tcommitID := types.CommitID{}\n\tcheckStore(t, ms, commitID, commitID)\n\n\tk, v := []byte(\"wind\"), []byte(\"blows\")\n  //key=store1store1\n\tstore1 := ms.getStoreByName(\"store1\").(types.KVStore)\n\t//store1k-v\n\tstore1.Set(k, v)\n\n //ms.Commit, store1.SaveVersion\n\tcID := ms.Commit()\n\trequire.Equal(t, int64(1), cID.Version)\n\thash := cID.Hash\n\t// make an empty commit, it should update version, but not affect hash\n\tcID = ms.Commit()\n\trequire.Equal(t, int64(2), cID.Version)\n\trequire.Equal(t, hash, cID.Hash)\n}\n```\n\n``store/rootmulti/store_test.go`\n\n\n\nkeykeyroothashrootmultiroot-hashapphash\n\n\n\nkey-valuekey-value(store-key)roothashroothashapphashapphash\n\n\n\n\n\n","slug":"cosmos-store","published":1,"updated":"2019-11-26T08:42:12.994Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69so0006t6xvnm6lw2hr","content":"<h3 id=\"Cosmos-state\"><a href=\"#Cosmos-state\" class=\"headerlink\" title=\"Cosmos state\"></a>Cosmos state</h3><p> apiapikeyvalueproofproofvalue</p>\n<p></p>\n<p>cosms-sdk<code>x/</code></p>\n<p><code>store/rootmulti/store.go</code>..  rootroot</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>store/rootmulti/store.go</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Store struct &#123;</span><br><span class=\"line\">\t\tdb           dbm.DB  //db</span><br><span class=\"line\">\t\tlastCommitID types.CommitID</span><br><span class=\"line\">\t\tpruningOpts  types.PruningOptions</span><br><span class=\"line\">\t\tstoresParams map[types.StoreKey]storeParams //1</span><br><span class=\"line\">\t\tstores       map[types.StoreKey]types.CommitKVStore //2</span><br><span class=\"line\">\t\tkeysByName   map[string]types.StoreKey  //3</span><br><span class=\"line\">\t\tlazyLoading  bool</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ttraceWriter  io.Writer</span><br><span class=\"line\">\t\ttraceContext types.TraceContext</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tinterBlockCache types.MultiStorePersistentCache</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>123map3keystringvalueKeyKey12 key1valuestoreParams2<code>types.CommitKVStore</code><code>types.CommitKVStore</code><code>store/transient/store.go</code><code>store/iavl/store.go</code>iavlgaiastoreiavl<code>ival</code></p>\n<h5 id=\"ival\"><a href=\"#ival\" class=\"headerlink\" title=\"ival\"></a>ival</h5><p><code>store/iavl/store.go</code>tree..</p>\n<p> tree..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//store/iavl/store_test.go</span><br><span class=\"line\"></span><br><span class=\"line\">var (</span><br><span class=\"line\">\ttreeData = map[string]string&#123;</span><br><span class=\"line\">\t\t&quot;hello&quot;: &quot;goodbye&quot;,</span><br><span class=\"line\">\t\t&quot;aloha&quot;: &quot;shalom&quot;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnMoreData = 0</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func newAlohaTree(t *testing.T, db dbm.DB) (*iavl.MutableTree, types.CommitID) &#123;</span><br><span class=\"line\">\ttree := iavl.NewMutableTree(db, cacheSize)</span><br><span class=\"line\">\tfor k, v := range treeData &#123;</span><br><span class=\"line\">\t\ttree.Set([]byte(k), []byte(v))  //&quot;hello&quot; =&gt; &quot;goodbye&quot;; &quot;aloha&quot; =&gt;&quot;shalom&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor i := 0; i &lt; nMoreData; i++ &#123;</span><br><span class=\"line\">\t\tkey := cmn.RandBytes(12)</span><br><span class=\"line\">\t\tvalue := cmn.RandBytes(50)</span><br><span class=\"line\">\t\ttree.Set(key, value)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\thash, ver, err := tree.SaveVersion()</span><br><span class=\"line\">\trequire.Nil(t, err)</span><br><span class=\"line\">\treturn tree, types.CommitID&#123;Version: ver, Hash: hash&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func TestGetImmutable(t *testing.T) &#123;</span><br><span class=\"line\">\tdb := dbm.NewMemDB()</span><br><span class=\"line\">\ttree, cID := newAlohaTree(t, db)   //treekey-valuesaveVersion</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//version=1</span><br><span class=\"line\">\tstore := UnsafeNewStore(tree, 10, 10)</span><br><span class=\"line\">\t//\ttreekey=&quot;hello&quot;value&quot;goodbye&quot;&quot;adios&quot;</span><br><span class=\"line\">\trequire.True(t, tree.Set([]byte(&quot;hello&quot;), []byte(&quot;adios&quot;)))  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\thash, ver, err := tree.SaveVersion()  //verversion=2</span><br><span class=\"line\">\tcID = types.CommitID&#123;Version: ver, Hash: hash&#125;  //hash =&gt; root</span><br><span class=\"line\">\trequire.Nil(t, err)</span><br><span class=\"line\">\t_, err = store.GetImmutable(cID.Version + 1)</span><br><span class=\"line\">\trequire.Error(t, err)   //version=3err</span><br><span class=\"line\"></span><br><span class=\"line\">\tnewStore, err := store.GetImmutable(cID.Version - 1)  //version=1</span><br><span class=\"line\">\trequire.NoError(t, err)                           //hellovaluegoodbye</span><br><span class=\"line\">\trequire.Equal(t, newStore.Get([]byte(&quot;hello&quot;)), []byte(&quot;goodbye&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">\tnewStore, err = store.GetImmutable(cID.Version)   //version=2</span><br><span class=\"line\">\trequire.NoError(t, err)\t\t\t\t\t\t\t\t\t\t\t\t\t//hellovalueadios</span><br><span class=\"line\">\trequire.Equal(t, newStore.Get([]byte(&quot;hello&quot;)), []byte(&quot;adios&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">  //abci Querykey=helloversion=2value</span><br><span class=\"line\">\tres := newStore.Query(abci.RequestQuery&#123;Data: []byte(&quot;hello&quot;), Height: cID.Version, Path: &quot;/key&quot;, Prove: true&#125;)</span><br><span class=\"line\">\trequire.Equal(t, res.Value, []byte(&quot;adios&quot;))</span><br><span class=\"line\">\trequire.NotNil(t, res.Proof)</span><br><span class=\"line\"></span><br><span class=\"line\">\trequire.Panics(t, func() &#123; newStore.Set(nil, nil) &#125;)</span><br><span class=\"line\">\trequire.Panics(t, func() &#123; newStore.Delete(nil) &#125;)</span><br><span class=\"line\">\trequire.Panics(t, func() &#123; newStore.Commit() &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"rootmulti\"><a href=\"#rootmulti\" class=\"headerlink\" title=\"rootmulti\"></a>rootmulti</h5><p><code>rootmulti/store</code></p>\n<p><code>store/rootmulti/store_test.go</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func TestHashStableWithEmptyCommit(t *testing.T) &#123;</span><br><span class=\"line\">\tvar db dbm.DB = dbm.NewMemDB()</span><br><span class=\"line\">\tms := newMultiStoreWithMounts(db)</span><br><span class=\"line\">\terr := ms.LoadLatestVersion()</span><br><span class=\"line\">\trequire.Nil(t, err)</span><br><span class=\"line\"></span><br><span class=\"line\">\tcommitID := types.CommitID&#123;&#125;</span><br><span class=\"line\">\tcheckStore(t, ms, commitID, commitID)</span><br><span class=\"line\"></span><br><span class=\"line\">\tk, v := []byte(&quot;wind&quot;), []byte(&quot;blows&quot;)</span><br><span class=\"line\">  //key=store1store1</span><br><span class=\"line\">\tstore1 := ms.getStoreByName(&quot;store1&quot;).(types.KVStore)</span><br><span class=\"line\">\t//store1k-v</span><br><span class=\"line\">\tstore1.Set(k, v)</span><br><span class=\"line\"></span><br><span class=\"line\"> //ms.Commit, store1.SaveVersion</span><br><span class=\"line\">\tcID := ms.Commit()</span><br><span class=\"line\">\trequire.Equal(t, int64(1), cID.Version)</span><br><span class=\"line\">\thash := cID.Hash</span><br><span class=\"line\">\t// make an empty commit, it should update version, but not affect hash</span><br><span class=\"line\">\tcID = ms.Commit()</span><br><span class=\"line\">\trequire.Equal(t, int64(2), cID.Version)</span><br><span class=\"line\">\trequire.Equal(t, hash, cID.Hash)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>``store/rootmulti/store_test.go`</p>\n<p>keykeyroothashrootmultiroot-hashapphash</p>\n<p>key-valuekey-value(store-key)roothashroothashapphashapphash</p>\n<p></p>\n<p></p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h3 id=\"Cosmos-state\"><a href=\"#Cosmos-state\" class=\"headerlink\" title=\"Cosmos state\"></a>Cosmos state</h3><p> apiapikeyvalueproofproofvalue</p>\n<p></p>\n<p>cosms-sdk<code>x/</code></p>\n<p><code>store/rootmulti/store.go</code>..  rootroot</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>store/rootmulti/store.go</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Store struct &#123;</span><br><span class=\"line\">\t\tdb           dbm.DB  //db</span><br><span class=\"line\">\t\tlastCommitID types.CommitID</span><br><span class=\"line\">\t\tpruningOpts  types.PruningOptions</span><br><span class=\"line\">\t\tstoresParams map[types.StoreKey]storeParams //1</span><br><span class=\"line\">\t\tstores       map[types.StoreKey]types.CommitKVStore //2</span><br><span class=\"line\">\t\tkeysByName   map[string]types.StoreKey  //3</span><br><span class=\"line\">\t\tlazyLoading  bool</span><br><span class=\"line\"></span><br><span class=\"line\">\t\ttraceWriter  io.Writer</span><br><span class=\"line\">\t\ttraceContext types.TraceContext</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tinterBlockCache types.MultiStorePersistentCache</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>123map3keystringvalueKeyKey12 key1valuestoreParams2<code>types.CommitKVStore</code><code>types.CommitKVStore</code><code>store/transient/store.go</code><code>store/iavl/store.go</code>iavlgaiastoreiavl<code>ival</code></p>\n<h5 id=\"ival\"><a href=\"#ival\" class=\"headerlink\" title=\"ival\"></a>ival</h5><p><code>store/iavl/store.go</code>tree..</p>\n<p> tree..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//store/iavl/store_test.go</span><br><span class=\"line\"></span><br><span class=\"line\">var (</span><br><span class=\"line\">\ttreeData = map[string]string&#123;</span><br><span class=\"line\">\t\t&quot;hello&quot;: &quot;goodbye&quot;,</span><br><span class=\"line\">\t\t&quot;aloha&quot;: &quot;shalom&quot;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnMoreData = 0</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func newAlohaTree(t *testing.T, db dbm.DB) (*iavl.MutableTree, types.CommitID) &#123;</span><br><span class=\"line\">\ttree := iavl.NewMutableTree(db, cacheSize)</span><br><span class=\"line\">\tfor k, v := range treeData &#123;</span><br><span class=\"line\">\t\ttree.Set([]byte(k), []byte(v))  //&quot;hello&quot; =&gt; &quot;goodbye&quot;; &quot;aloha&quot; =&gt;&quot;shalom&quot;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfor i := 0; i &lt; nMoreData; i++ &#123;</span><br><span class=\"line\">\t\tkey := cmn.RandBytes(12)</span><br><span class=\"line\">\t\tvalue := cmn.RandBytes(50)</span><br><span class=\"line\">\t\ttree.Set(key, value)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\thash, ver, err := tree.SaveVersion()</span><br><span class=\"line\">\trequire.Nil(t, err)</span><br><span class=\"line\">\treturn tree, types.CommitID&#123;Version: ver, Hash: hash&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func TestGetImmutable(t *testing.T) &#123;</span><br><span class=\"line\">\tdb := dbm.NewMemDB()</span><br><span class=\"line\">\ttree, cID := newAlohaTree(t, db)   //treekey-valuesaveVersion</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//version=1</span><br><span class=\"line\">\tstore := UnsafeNewStore(tree, 10, 10)</span><br><span class=\"line\">\t//\ttreekey=&quot;hello&quot;value&quot;goodbye&quot;&quot;adios&quot;</span><br><span class=\"line\">\trequire.True(t, tree.Set([]byte(&quot;hello&quot;), []byte(&quot;adios&quot;)))  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">\thash, ver, err := tree.SaveVersion()  //verversion=2</span><br><span class=\"line\">\tcID = types.CommitID&#123;Version: ver, Hash: hash&#125;  //hash =&gt; root</span><br><span class=\"line\">\trequire.Nil(t, err)</span><br><span class=\"line\">\t_, err = store.GetImmutable(cID.Version + 1)</span><br><span class=\"line\">\trequire.Error(t, err)   //version=3err</span><br><span class=\"line\"></span><br><span class=\"line\">\tnewStore, err := store.GetImmutable(cID.Version - 1)  //version=1</span><br><span class=\"line\">\trequire.NoError(t, err)                           //hellovaluegoodbye</span><br><span class=\"line\">\trequire.Equal(t, newStore.Get([]byte(&quot;hello&quot;)), []byte(&quot;goodbye&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">\tnewStore, err = store.GetImmutable(cID.Version)   //version=2</span><br><span class=\"line\">\trequire.NoError(t, err)\t\t\t\t\t\t\t\t\t\t\t\t\t//hellovalueadios</span><br><span class=\"line\">\trequire.Equal(t, newStore.Get([]byte(&quot;hello&quot;)), []byte(&quot;adios&quot;))</span><br><span class=\"line\"></span><br><span class=\"line\">  //abci Querykey=helloversion=2value</span><br><span class=\"line\">\tres := newStore.Query(abci.RequestQuery&#123;Data: []byte(&quot;hello&quot;), Height: cID.Version, Path: &quot;/key&quot;, Prove: true&#125;)</span><br><span class=\"line\">\trequire.Equal(t, res.Value, []byte(&quot;adios&quot;))</span><br><span class=\"line\">\trequire.NotNil(t, res.Proof)</span><br><span class=\"line\"></span><br><span class=\"line\">\trequire.Panics(t, func() &#123; newStore.Set(nil, nil) &#125;)</span><br><span class=\"line\">\trequire.Panics(t, func() &#123; newStore.Delete(nil) &#125;)</span><br><span class=\"line\">\trequire.Panics(t, func() &#123; newStore.Commit() &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"rootmulti\"><a href=\"#rootmulti\" class=\"headerlink\" title=\"rootmulti\"></a>rootmulti</h5><p><code>rootmulti/store</code></p>\n<p><code>store/rootmulti/store_test.go</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func TestHashStableWithEmptyCommit(t *testing.T) &#123;</span><br><span class=\"line\">\tvar db dbm.DB = dbm.NewMemDB()</span><br><span class=\"line\">\tms := newMultiStoreWithMounts(db)</span><br><span class=\"line\">\terr := ms.LoadLatestVersion()</span><br><span class=\"line\">\trequire.Nil(t, err)</span><br><span class=\"line\"></span><br><span class=\"line\">\tcommitID := types.CommitID&#123;&#125;</span><br><span class=\"line\">\tcheckStore(t, ms, commitID, commitID)</span><br><span class=\"line\"></span><br><span class=\"line\">\tk, v := []byte(&quot;wind&quot;), []byte(&quot;blows&quot;)</span><br><span class=\"line\">  //key=store1store1</span><br><span class=\"line\">\tstore1 := ms.getStoreByName(&quot;store1&quot;).(types.KVStore)</span><br><span class=\"line\">\t//store1k-v</span><br><span class=\"line\">\tstore1.Set(k, v)</span><br><span class=\"line\"></span><br><span class=\"line\"> //ms.Commit, store1.SaveVersion</span><br><span class=\"line\">\tcID := ms.Commit()</span><br><span class=\"line\">\trequire.Equal(t, int64(1), cID.Version)</span><br><span class=\"line\">\thash := cID.Hash</span><br><span class=\"line\">\t// make an empty commit, it should update version, but not affect hash</span><br><span class=\"line\">\tcID = ms.Commit()</span><br><span class=\"line\">\trequire.Equal(t, int64(2), cID.Version)</span><br><span class=\"line\">\trequire.Equal(t, hash, cID.Hash)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>``store/rootmulti/store_test.go`</p>\n<p>keykeyroothashrootmultiroot-hashapphash</p>\n<p>key-valuekey-value(store-key)roothashroothashapphashapphash</p>\n<p></p>\n<p></p>\n"},{"title":"crypto","date":"2019-10-14T06:34:52.000Z","_content":"\n## \n\n#### \n\n\n\n\n\n- \n- \n- \n\n\n\n#### \n\n- \n- \n\nP + P + P + P .. = k*P = QPQkPQP,QkkQ\n\n#### \n\n\n\nECDSABLS.. (<u>emm.</u>.) BLSBLSVRFDFINITY~\n\n#### \n\n\n\nhttps\n\n()()\n\n\n\n#### \n\n\n\nAB\n\n- \n- \n- \n- \n\n\n\n\n\n![img](https://images2015.cnblogs.com/blog/802212/201703/802212-20170307221220969-754021676.png)\n\n\n\n##### MAC \n\nMACMAC\n\nMACMAC()\n\n\n### \n\n\n\n#### \n\nABBAAAA\n\nABBAA\n\nABAAA\n\n\n\n\n\n\n\n- \n- \n\n\n\n#### \n\n\n\nk*P = QPkPQPQ,kkq\n\n\n\n- \n- \n\n\n\n\n\n- \n- \n\n\n\n\n\n- \n- \n\n\n\n#### \n\n- ABABBA128256(2128256)\n- merklemerkle\n- \n\n\n\n#### \n\n(m)nm>=n3/2, 5/3\n\n`3`nmmnm/n12/3, 3/5\n","source":"_posts/crypto.md","raw":"---\ntitle: crypto\ncategories:\n  - blockchain\ndate: 2019-10-14 14:34:52\ntags:\n---\n\n## \n\n#### \n\n\n\n\n\n- \n- \n- \n\n\n\n#### \n\n- \n- \n\nP + P + P + P .. = k*P = QPQkPQP,QkkQ\n\n#### \n\n\n\nECDSABLS.. (<u>emm.</u>.) BLSBLSVRFDFINITY~\n\n#### \n\n\n\nhttps\n\n()()\n\n\n\n#### \n\n\n\nAB\n\n- \n- \n- \n- \n\n\n\n\n\n![img](https://images2015.cnblogs.com/blog/802212/201703/802212-20170307221220969-754021676.png)\n\n\n\n##### MAC \n\nMACMAC\n\nMACMAC()\n\n\n### \n\n\n\n#### \n\nABBAAAA\n\nABBAA\n\nABAAA\n\n\n\n\n\n\n\n- \n- \n\n\n\n#### \n\n\n\nk*P = QPkPQPQ,kkq\n\n\n\n- \n- \n\n\n\n\n\n- \n- \n\n\n\n\n\n- \n- \n\n\n\n#### \n\n- ABABBA128256(2128256)\n- merklemerkle\n- \n\n\n\n#### \n\n(m)nm>=n3/2, 5/3\n\n`3`nmmnm/n12/3, 3/5\n","slug":"crypto","published":1,"updated":"2019-10-14T06:35:58.550Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ss0007t6xvswwfzn4s","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li></li>\n<li></li>\n</ul>\n<p>P + P + P + P .. = k*P = QPQkPQP,QkkQ</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>ECDSABLS.. (<u>emm.</u>.) BLSBLSVRFDFINITY~</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>https</p>\n<p>()()</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>AB</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<p><img src=\"https://images2015.cnblogs.com/blog/802212/201703/802212-20170307221220969-754021676.png\" alt=\"img\"></p>\n<h5 id=\"MAC-\"><a href=\"#MAC-\" class=\"headerlink\" title=\"MAC \"></a>MAC </h5><p>MACMAC</p>\n<p>MACMAC()</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ABBAAAA</p>\n<p>ABBAA</p>\n<p>ABAAA</p>\n<p></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>k*P = QPkPQPQ,kkq</p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>ABABBA128256(2128256)</li>\n<li>merklemerkle</li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>(m)nm&gt;=n3/2, 5/3</p>\n<p><code>3</code>nmmnm/n12/3, 3/5</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li></li>\n<li></li>\n</ul>\n<p>P + P + P + P .. = k*P = QPQkPQP,QkkQ</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>ECDSABLS.. (<u>emm.</u>.) BLSBLSVRFDFINITY~</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>https</p>\n<p>()()</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>AB</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<p><img src=\"https://images2015.cnblogs.com/blog/802212/201703/802212-20170307221220969-754021676.png\" alt=\"img\"></p>\n<h5 id=\"MAC-\"><a href=\"#MAC-\" class=\"headerlink\" title=\"MAC \"></a>MAC </h5><p>MACMAC</p>\n<p>MACMAC()</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ABBAAAA</p>\n<p>ABBAA</p>\n<p>ABAAA</p>\n<p></p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>k*P = QPkPQPQ,kkq</p>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>ABABBA128256(2128256)</li>\n<li>merklemerkle</li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>(m)nm&gt;=n3/2, 5/3</p>\n<p><code>3</code>nmmnm/n12/3, 3/5</p>\n"},{"title":"dai_code","date":"2019-10-14T06:52:07.000Z","_content":"\n## dai\n\n![](<https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png>)\n\nvat****vatvat****filefilevatfileP427L-9Y552-5433E-8DSR3-58Z68\n\n```\n    function file(bytes32 what, uint data) external note auth {\n        if (what == \"Line\") Line = data;\n        else revert();\n    }\n    function file(bytes32 ilk, bytes32 what, uint data) external note auth {\n        if (what == \"spot\") ilks[ilk].spot = data;\n        else if (what == \"line\") ilks[ilk].line = data;\n        else if (what == \"dust\") ilks[ilk].dust = data;\n        else revert();\n    }\n```\n\nvatCDP\n\ncatcat.bite\n\nvowvowflopflap\n\nflipcat\n\nflopflapvow\n\n\n\n### vat\n\n\n\n```\n//id\nmapping (bytes32 => Ilk)                       public ilks;  \n//id =>  => \nmapping (bytes32 => mapping (address => Urn )) public urns;  \n//id =>  => \nmapping (bytes32 => mapping (address => uint)) public gem;  \n// => dai\nmapping (address => uint256)                   public dai;  \n// =>  \nmapping (address => uint256)                   public sin;\n\n struct Urn {\n        uint256 ink;   // \n        uint256 art;   // dai\n }\n //id\n struct Ilk {\n        uint256 Art;   // dai\n        uint256 rate;  // \n        uint256 spot;  // \n        uint256 line;  // \n        uint256 dust;  // \n } //ratespotink * spot >= art * rate\n\n```\n\nfrob\n\n```\n//bytes32 i ilk address u cdpv w daidink dart\nfunction frob(bytes32 i, address u, address v, address w, int dink, int dart) external note {\n    // system is live\n    require(live == 1);\n\n    Urn memory urn = urns[i][u];\n    Ilk memory ilk = ilks[i];\n    // ilk has been initialised\n    require(ilk.rate != 0);\n\n    urn.ink = add(urn.ink, dink);\n    urn.art = add(urn.art, dart);\n    ilk.Art = add(ilk.Art, dart);\n\n    int dtab = mul(ilk.rate, dart);\n    uint tab = mul(urn.art, ilk.rate);\n    debt     = add(debt, dtab); //dai\n\n    //dart <=0,  dart >0, \n\n    // either debt has decreased, or debt ceilings are not exceeded\n    require(either(dart <= 0, both(mul(ilk.Art, ilk.rate) <= ilk.line, debt <= Line)));\n    // urn is either less risky than before, or it is safe\n    require(either(both(dart <= 0, dink >= 0), tab <= mul(urn.ink, ilk.spot)));\n    // urn is either more safe, or the owner consents\n    require(either(both(dart <= 0, dink >= 0), wish(u, msg.sender)));\n    // collateral src consents\n    require(either(dink <= 0, wish(v, msg.sender)));\n    // debt dst consents\n    require(either(dart >= 0, wish(w, msg.sender)));\n    // urn has no debt, or a non-dusty amount\n    require(either(urn.art == 0, tab >= ilk.dust));\n\n    gem[i][v] = sub(gem[i][v], dink);\n    dai[w]    = add(dai[w],    dtab);\n    urns[i][u] = urn;\n    ilks[i]    = ilk;\n}\n```\n\ncdpdart>0dart<0\n\n/dink >=0, dart >0dart * ratedink * spot\n\n-  < line, <Line\n\n-  <= raterate > 1dart\n- uuuxcdp\n-  >  dust\n\n/(gem)/dai\n\n### cat\n\n```\n function bite(bytes32 ilk, address urn) external returns (uint id) {\n        VatLike.Ilk memory i = vat.ilks(ilk);\n        VatLike.Urn memory u = vat.urns(ilk, urn);\n\n        require(live == 1);\n        // *  <  * ()\n        //\n        require(mul(u.ink, i.spot) < mul(u.art, i.rate));\n        //\n        uint lot = min(u.ink, ilks[ilk].lump);\n        //   *  /  \n        uint art = min(u.art, mul(lot, u.art) / u.ink);\n        // * ()\n        uint tab = mul(art, i.rate);\n\n        require(lot <= 2**255 && art <= 2**255);\n        //,(gem)\n        vat.grab(ilk, urn, address(this), address(vow), -int(lot), -int(art));\n        //\n        vow.fess(tab);\n        //\n        id = Kicker(ilks[ilk].flip).kick({ urn: urn\n                                         , gal: address(vow)\n                                         , tab: rmul(tab, ilks[ilk].chop) //: dai *  / 10 ** 27\n                                         , lot: lot //\n                                         , bid: 0\n                                         });\n\n        emit Bite(ilk, urn, lot, art, tab, ilks[ilk].flip, id);\n    }\n```\n\n\n\n##### example\n\njoin/join/vat.slip\n\n```\n    function join(address usr, uint wad) external note {\n        require(int(wad) >= 0);\n        vat.slip(ilk, usr, int(wad)); //gem[ilk][usr] = wad\n        require(gem.transferFrom(msg.sender, address(this), wad));\n    }\n```\n\n\n\n```\nvat.init(\"gold\");\ngemA = new GemJoin(address(vat), \"gold\", address(gold));\nvat.file(\"gold\", \"spot\", ray(1 ether)); //ray: 10 ** 9\nvat.file(\"gold\", \"line\", rad(1000 ether)); //rad: 10 ** 27\nvat.file(\"Line\",         rad(1000 ether));\ncat.file(\"gold\", \"chop\", ray(1 ether));\n```\n\n\n\n```\naddress urn = address(this);\n//\ngemA.join(urn,                             500 ether);\nvat.file(\"gold\", 'spot', ray(2.5 ether));\nvat.frob(\"gold\", me, me, me, 40 ether, 100 ether);\n//rate (10 ** 9)\n// 40 * (10 ** 18) * 2.5 * (10 ** 9) >=? 100 * (10 ** 18) * (10 ** 9),\n//vat.urn[gold][me]= ink(40) art(100)\n\n vat.file(\"gold\", 'spot', ray(2 ether));  //\n cat.file(\"gold\", \"chop\", ray(1.1 ether));\n cat.file(\"gold\", \"lump\", 30 ether);\n\n //\n uint auction = cat.bite(\"gold\", address(this));\n //40 * (10 ** 18) * 2 * (10 ** 9) >=? 100 * (10 ** 18) * (10 ** 9) \n //lot=min(u.ink, ilks[ilk].lump) = 30 ether\n // art = min(u.art, mul(lot, u.art) / u.ink); = 75 ether\n //vat.urn[gold][me] = ink(10 ether), art(25 ether)\n //\t\t\t\t\t\ttab = art * rate\n //kicktabrmul(tab, ilks[ilk].chop) (75 * (10 ** 18) * (10 ** 9)) * 1.1 * (10 ** 18) / 10 ** 27 = 82.5 * (10 ** 18) 85 ether\n```\n","source":"_posts/dai-code.md","raw":"---\ntitle: dai_code\ncategories:\n  - eth\ndate: 2019-10-14 14:52:07\ntags:\n---\n\n## dai\n\n![](<https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png>)\n\nvat****vatvat****filefilevatfileP427L-9Y552-5433E-8DSR3-58Z68\n\n```\n    function file(bytes32 what, uint data) external note auth {\n        if (what == \"Line\") Line = data;\n        else revert();\n    }\n    function file(bytes32 ilk, bytes32 what, uint data) external note auth {\n        if (what == \"spot\") ilks[ilk].spot = data;\n        else if (what == \"line\") ilks[ilk].line = data;\n        else if (what == \"dust\") ilks[ilk].dust = data;\n        else revert();\n    }\n```\n\nvatCDP\n\ncatcat.bite\n\nvowvowflopflap\n\nflipcat\n\nflopflapvow\n\n\n\n### vat\n\n\n\n```\n//id\nmapping (bytes32 => Ilk)                       public ilks;  \n//id =>  => \nmapping (bytes32 => mapping (address => Urn )) public urns;  \n//id =>  => \nmapping (bytes32 => mapping (address => uint)) public gem;  \n// => dai\nmapping (address => uint256)                   public dai;  \n// =>  \nmapping (address => uint256)                   public sin;\n\n struct Urn {\n        uint256 ink;   // \n        uint256 art;   // dai\n }\n //id\n struct Ilk {\n        uint256 Art;   // dai\n        uint256 rate;  // \n        uint256 spot;  // \n        uint256 line;  // \n        uint256 dust;  // \n } //ratespotink * spot >= art * rate\n\n```\n\nfrob\n\n```\n//bytes32 i ilk address u cdpv w daidink dart\nfunction frob(bytes32 i, address u, address v, address w, int dink, int dart) external note {\n    // system is live\n    require(live == 1);\n\n    Urn memory urn = urns[i][u];\n    Ilk memory ilk = ilks[i];\n    // ilk has been initialised\n    require(ilk.rate != 0);\n\n    urn.ink = add(urn.ink, dink);\n    urn.art = add(urn.art, dart);\n    ilk.Art = add(ilk.Art, dart);\n\n    int dtab = mul(ilk.rate, dart);\n    uint tab = mul(urn.art, ilk.rate);\n    debt     = add(debt, dtab); //dai\n\n    //dart <=0,  dart >0, \n\n    // either debt has decreased, or debt ceilings are not exceeded\n    require(either(dart <= 0, both(mul(ilk.Art, ilk.rate) <= ilk.line, debt <= Line)));\n    // urn is either less risky than before, or it is safe\n    require(either(both(dart <= 0, dink >= 0), tab <= mul(urn.ink, ilk.spot)));\n    // urn is either more safe, or the owner consents\n    require(either(both(dart <= 0, dink >= 0), wish(u, msg.sender)));\n    // collateral src consents\n    require(either(dink <= 0, wish(v, msg.sender)));\n    // debt dst consents\n    require(either(dart >= 0, wish(w, msg.sender)));\n    // urn has no debt, or a non-dusty amount\n    require(either(urn.art == 0, tab >= ilk.dust));\n\n    gem[i][v] = sub(gem[i][v], dink);\n    dai[w]    = add(dai[w],    dtab);\n    urns[i][u] = urn;\n    ilks[i]    = ilk;\n}\n```\n\ncdpdart>0dart<0\n\n/dink >=0, dart >0dart * ratedink * spot\n\n-  < line, <Line\n\n-  <= raterate > 1dart\n- uuuxcdp\n-  >  dust\n\n/(gem)/dai\n\n### cat\n\n```\n function bite(bytes32 ilk, address urn) external returns (uint id) {\n        VatLike.Ilk memory i = vat.ilks(ilk);\n        VatLike.Urn memory u = vat.urns(ilk, urn);\n\n        require(live == 1);\n        // *  <  * ()\n        //\n        require(mul(u.ink, i.spot) < mul(u.art, i.rate));\n        //\n        uint lot = min(u.ink, ilks[ilk].lump);\n        //   *  /  \n        uint art = min(u.art, mul(lot, u.art) / u.ink);\n        // * ()\n        uint tab = mul(art, i.rate);\n\n        require(lot <= 2**255 && art <= 2**255);\n        //,(gem)\n        vat.grab(ilk, urn, address(this), address(vow), -int(lot), -int(art));\n        //\n        vow.fess(tab);\n        //\n        id = Kicker(ilks[ilk].flip).kick({ urn: urn\n                                         , gal: address(vow)\n                                         , tab: rmul(tab, ilks[ilk].chop) //: dai *  / 10 ** 27\n                                         , lot: lot //\n                                         , bid: 0\n                                         });\n\n        emit Bite(ilk, urn, lot, art, tab, ilks[ilk].flip, id);\n    }\n```\n\n\n\n##### example\n\njoin/join/vat.slip\n\n```\n    function join(address usr, uint wad) external note {\n        require(int(wad) >= 0);\n        vat.slip(ilk, usr, int(wad)); //gem[ilk][usr] = wad\n        require(gem.transferFrom(msg.sender, address(this), wad));\n    }\n```\n\n\n\n```\nvat.init(\"gold\");\ngemA = new GemJoin(address(vat), \"gold\", address(gold));\nvat.file(\"gold\", \"spot\", ray(1 ether)); //ray: 10 ** 9\nvat.file(\"gold\", \"line\", rad(1000 ether)); //rad: 10 ** 27\nvat.file(\"Line\",         rad(1000 ether));\ncat.file(\"gold\", \"chop\", ray(1 ether));\n```\n\n\n\n```\naddress urn = address(this);\n//\ngemA.join(urn,                             500 ether);\nvat.file(\"gold\", 'spot', ray(2.5 ether));\nvat.frob(\"gold\", me, me, me, 40 ether, 100 ether);\n//rate (10 ** 9)\n// 40 * (10 ** 18) * 2.5 * (10 ** 9) >=? 100 * (10 ** 18) * (10 ** 9),\n//vat.urn[gold][me]= ink(40) art(100)\n\n vat.file(\"gold\", 'spot', ray(2 ether));  //\n cat.file(\"gold\", \"chop\", ray(1.1 ether));\n cat.file(\"gold\", \"lump\", 30 ether);\n\n //\n uint auction = cat.bite(\"gold\", address(this));\n //40 * (10 ** 18) * 2 * (10 ** 9) >=? 100 * (10 ** 18) * (10 ** 9) \n //lot=min(u.ink, ilks[ilk].lump) = 30 ether\n // art = min(u.art, mul(lot, u.art) / u.ink); = 75 ether\n //vat.urn[gold][me] = ink(10 ether), art(25 ether)\n //\t\t\t\t\t\ttab = art * rate\n //kicktabrmul(tab, ilks[ilk].chop) (75 * (10 ** 18) * (10 ** 9)) * 1.1 * (10 ** 18) / 10 ** 27 = 82.5 * (10 ** 18) 85 ether\n```\n","slug":"dai-code","published":1,"updated":"2019-10-14T06:53:02.933Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69su0008t6xvxv3i6uc9","content":"<h2 id=\"dai\"><a href=\"#dai\" class=\"headerlink\" title=\"dai\"></a>dai</h2><p><img src=\"https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png\" alt=\"\"></p>\n<p>vat<strong></strong>vatvat<strong></strong>filefilevatfileP427L-9Y552-5433E-8DSR3-58Z68</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function file(bytes32 what, uint data) external note auth &#123;</span><br><span class=\"line\">    if (what == &quot;Line&quot;) Line = data;</span><br><span class=\"line\">    else revert();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">function file(bytes32 ilk, bytes32 what, uint data) external note auth &#123;</span><br><span class=\"line\">    if (what == &quot;spot&quot;) ilks[ilk].spot = data;</span><br><span class=\"line\">    else if (what == &quot;line&quot;) ilks[ilk].line = data;</span><br><span class=\"line\">    else if (what == &quot;dust&quot;) ilks[ilk].dust = data;</span><br><span class=\"line\">    else revert();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>vatCDP</p>\n<p>catcat.bite</p>\n<p>vowvowflopflap</p>\n<p>flipcat</p>\n<p>flopflapvow</p>\n<h3 id=\"vat\"><a href=\"#vat\" class=\"headerlink\" title=\"vat\"></a>vat</h3><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//id</span><br><span class=\"line\">mapping (bytes32 =&gt; Ilk)                       public ilks;  </span><br><span class=\"line\">//id =&gt;  =&gt; </span><br><span class=\"line\">mapping (bytes32 =&gt; mapping (address =&gt; Urn )) public urns;  </span><br><span class=\"line\">//id =&gt;  =&gt; </span><br><span class=\"line\">mapping (bytes32 =&gt; mapping (address =&gt; uint)) public gem;  </span><br><span class=\"line\">// =&gt; dai</span><br><span class=\"line\">mapping (address =&gt; uint256)                   public dai;  </span><br><span class=\"line\">// =&gt;  </span><br><span class=\"line\">mapping (address =&gt; uint256)                   public sin;</span><br><span class=\"line\"></span><br><span class=\"line\"> struct Urn &#123;</span><br><span class=\"line\">        uint256 ink;   // </span><br><span class=\"line\">        uint256 art;   // dai</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> //id</span><br><span class=\"line\"> struct Ilk &#123;</span><br><span class=\"line\">        uint256 Art;   // dai</span><br><span class=\"line\">        uint256 rate;  // </span><br><span class=\"line\">        uint256 spot;  // </span><br><span class=\"line\">        uint256 line;  // </span><br><span class=\"line\">        uint256 dust;  // </span><br><span class=\"line\"> &#125; //ratespotink * spot &gt;= art * rate</span><br></pre></td></tr></table></figure>\n\n<p>frob</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//bytes32 i ilk address u cdpv w daidink dart</span><br><span class=\"line\">function frob(bytes32 i, address u, address v, address w, int dink, int dart) external note &#123;</span><br><span class=\"line\">    // system is live</span><br><span class=\"line\">    require(live == 1);</span><br><span class=\"line\"></span><br><span class=\"line\">    Urn memory urn = urns[i][u];</span><br><span class=\"line\">    Ilk memory ilk = ilks[i];</span><br><span class=\"line\">    // ilk has been initialised</span><br><span class=\"line\">    require(ilk.rate != 0);</span><br><span class=\"line\"></span><br><span class=\"line\">    urn.ink = add(urn.ink, dink);</span><br><span class=\"line\">    urn.art = add(urn.art, dart);</span><br><span class=\"line\">    ilk.Art = add(ilk.Art, dart);</span><br><span class=\"line\"></span><br><span class=\"line\">    int dtab = mul(ilk.rate, dart);</span><br><span class=\"line\">    uint tab = mul(urn.art, ilk.rate);</span><br><span class=\"line\">    debt     = add(debt, dtab); //dai</span><br><span class=\"line\"></span><br><span class=\"line\">    //dart &lt;=0,  dart &gt;0, </span><br><span class=\"line\"></span><br><span class=\"line\">    // either debt has decreased, or debt ceilings are not exceeded</span><br><span class=\"line\">    require(either(dart &lt;= 0, both(mul(ilk.Art, ilk.rate) &lt;= ilk.line, debt &lt;= Line)));</span><br><span class=\"line\">    // urn is either less risky than before, or it is safe</span><br><span class=\"line\">    require(either(both(dart &lt;= 0, dink &gt;= 0), tab &lt;= mul(urn.ink, ilk.spot)));</span><br><span class=\"line\">    // urn is either more safe, or the owner consents</span><br><span class=\"line\">    require(either(both(dart &lt;= 0, dink &gt;= 0), wish(u, msg.sender)));</span><br><span class=\"line\">    // collateral src consents</span><br><span class=\"line\">    require(either(dink &lt;= 0, wish(v, msg.sender)));</span><br><span class=\"line\">    // debt dst consents</span><br><span class=\"line\">    require(either(dart &gt;= 0, wish(w, msg.sender)));</span><br><span class=\"line\">    // urn has no debt, or a non-dusty amount</span><br><span class=\"line\">    require(either(urn.art == 0, tab &gt;= ilk.dust));</span><br><span class=\"line\"></span><br><span class=\"line\">    gem[i][v] = sub(gem[i][v], dink);</span><br><span class=\"line\">    dai[w]    = add(dai[w],    dtab);</span><br><span class=\"line\">    urns[i][u] = urn;</span><br><span class=\"line\">    ilks[i]    = ilk;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>cdpdart&gt;0dart&lt;0</p>\n<p>/dink &gt;=0, dart &gt;0dart * ratedink * spot</p>\n<ul>\n<li><p> &lt; line, &lt;Line</p>\n</li>\n<li><p> &lt;= raterate &gt; 1dart</p>\n</li>\n<li><p>uuuxcdp</p>\n</li>\n<li><p> &gt;  dust</p>\n</li>\n</ul>\n<p>/(gem)/dai</p>\n<h3 id=\"cat\"><a href=\"#cat\" class=\"headerlink\" title=\"cat\"></a>cat</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function bite(bytes32 ilk, address urn) external returns (uint id) &#123;</span><br><span class=\"line\">       VatLike.Ilk memory i = vat.ilks(ilk);</span><br><span class=\"line\">       VatLike.Urn memory u = vat.urns(ilk, urn);</span><br><span class=\"line\"></span><br><span class=\"line\">       require(live == 1);</span><br><span class=\"line\">       // *  &lt;  * ()</span><br><span class=\"line\">       //</span><br><span class=\"line\">       require(mul(u.ink, i.spot) &lt; mul(u.art, i.rate));</span><br><span class=\"line\">       //</span><br><span class=\"line\">       uint lot = min(u.ink, ilks[ilk].lump);</span><br><span class=\"line\">       //   *  /  </span><br><span class=\"line\">       uint art = min(u.art, mul(lot, u.art) / u.ink);</span><br><span class=\"line\">       // * ()</span><br><span class=\"line\">       uint tab = mul(art, i.rate);</span><br><span class=\"line\"></span><br><span class=\"line\">       require(lot &lt;= 2**255 &amp;&amp; art &lt;= 2**255);</span><br><span class=\"line\">       //,(gem)</span><br><span class=\"line\">       vat.grab(ilk, urn, address(this), address(vow), -int(lot), -int(art));</span><br><span class=\"line\">       //</span><br><span class=\"line\">       vow.fess(tab);</span><br><span class=\"line\">       //</span><br><span class=\"line\">       id = Kicker(ilks[ilk].flip).kick(&#123; urn: urn</span><br><span class=\"line\">                                        , gal: address(vow)</span><br><span class=\"line\">                                        , tab: rmul(tab, ilks[ilk].chop) //: dai *  / 10 ** 27</span><br><span class=\"line\">                                        , lot: lot //</span><br><span class=\"line\">                                        , bid: 0</span><br><span class=\"line\">                                        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">       emit Bite(ilk, urn, lot, art, tab, ilks[ilk].flip, id);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"example\"><a href=\"#example\" class=\"headerlink\" title=\"example\"></a>example</h5><p>join/join/vat.slip</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function join(address usr, uint wad) external note &#123;</span><br><span class=\"line\">    require(int(wad) &gt;= 0);</span><br><span class=\"line\">    vat.slip(ilk, usr, int(wad)); //gem[ilk][usr] = wad</span><br><span class=\"line\">    require(gem.transferFrom(msg.sender, address(this), wad));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vat.init(&quot;gold&quot;);</span><br><span class=\"line\">gemA = new GemJoin(address(vat), &quot;gold&quot;, address(gold));</span><br><span class=\"line\">vat.file(&quot;gold&quot;, &quot;spot&quot;, ray(1 ether)); //ray: 10 ** 9</span><br><span class=\"line\">vat.file(&quot;gold&quot;, &quot;line&quot;, rad(1000 ether)); //rad: 10 ** 27</span><br><span class=\"line\">vat.file(&quot;Line&quot;,         rad(1000 ether));</span><br><span class=\"line\">cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1 ether));</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">address urn = address(this);</span><br><span class=\"line\">//</span><br><span class=\"line\">gemA.join(urn,                             500 ether);</span><br><span class=\"line\">vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2.5 ether));</span><br><span class=\"line\">vat.frob(&quot;gold&quot;, me, me, me, 40 ether, 100 ether);</span><br><span class=\"line\">//rate (10 ** 9)</span><br><span class=\"line\">// 40 * (10 ** 18) * 2.5 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9),</span><br><span class=\"line\">//vat.urn[gold][me]= ink(40) art(100)</span><br><span class=\"line\"></span><br><span class=\"line\"> vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2 ether));  //</span><br><span class=\"line\"> cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1.1 ether));</span><br><span class=\"line\"> cat.file(&quot;gold&quot;, &quot;lump&quot;, 30 ether);</span><br><span class=\"line\"></span><br><span class=\"line\"> //</span><br><span class=\"line\"> uint auction = cat.bite(&quot;gold&quot;, address(this));</span><br><span class=\"line\"> //40 * (10 ** 18) * 2 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9) </span><br><span class=\"line\"> //lot=min(u.ink, ilks[ilk].lump) = 30 ether</span><br><span class=\"line\"> // art = min(u.art, mul(lot, u.art) / u.ink); = 75 ether</span><br><span class=\"line\"> //vat.urn[gold][me] = ink(10 ether), art(25 ether)</span><br><span class=\"line\"> //\t\t\t\t\t\ttab = art * rate</span><br><span class=\"line\"> //kicktabrmul(tab, ilks[ilk].chop) (75 * (10 ** 18) * (10 ** 9)) * 1.1 * (10 ** 18) / 10 ** 27 = 82.5 * (10 ** 18) 85 ether</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"dai\"><a href=\"#dai\" class=\"headerlink\" title=\"dai\"></a>dai</h2><p><img src=\"https://user-images.githubusercontent.com/5028/58217074-3ec06880-7d55-11e9-91e2-c9bec7172bc4.png\" alt=\"\"></p>\n<p>vat<strong></strong>vatvat<strong></strong>filefilevatfileP427L-9Y552-5433E-8DSR3-58Z68</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function file(bytes32 what, uint data) external note auth &#123;</span><br><span class=\"line\">    if (what == &quot;Line&quot;) Line = data;</span><br><span class=\"line\">    else revert();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">function file(bytes32 ilk, bytes32 what, uint data) external note auth &#123;</span><br><span class=\"line\">    if (what == &quot;spot&quot;) ilks[ilk].spot = data;</span><br><span class=\"line\">    else if (what == &quot;line&quot;) ilks[ilk].line = data;</span><br><span class=\"line\">    else if (what == &quot;dust&quot;) ilks[ilk].dust = data;</span><br><span class=\"line\">    else revert();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>vatCDP</p>\n<p>catcat.bite</p>\n<p>vowvowflopflap</p>\n<p>flipcat</p>\n<p>flopflapvow</p>\n<h3 id=\"vat\"><a href=\"#vat\" class=\"headerlink\" title=\"vat\"></a>vat</h3><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//id</span><br><span class=\"line\">mapping (bytes32 =&gt; Ilk)                       public ilks;  </span><br><span class=\"line\">//id =&gt;  =&gt; </span><br><span class=\"line\">mapping (bytes32 =&gt; mapping (address =&gt; Urn )) public urns;  </span><br><span class=\"line\">//id =&gt;  =&gt; </span><br><span class=\"line\">mapping (bytes32 =&gt; mapping (address =&gt; uint)) public gem;  </span><br><span class=\"line\">// =&gt; dai</span><br><span class=\"line\">mapping (address =&gt; uint256)                   public dai;  </span><br><span class=\"line\">// =&gt;  </span><br><span class=\"line\">mapping (address =&gt; uint256)                   public sin;</span><br><span class=\"line\"></span><br><span class=\"line\"> struct Urn &#123;</span><br><span class=\"line\">        uint256 ink;   // </span><br><span class=\"line\">        uint256 art;   // dai</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> //id</span><br><span class=\"line\"> struct Ilk &#123;</span><br><span class=\"line\">        uint256 Art;   // dai</span><br><span class=\"line\">        uint256 rate;  // </span><br><span class=\"line\">        uint256 spot;  // </span><br><span class=\"line\">        uint256 line;  // </span><br><span class=\"line\">        uint256 dust;  // </span><br><span class=\"line\"> &#125; //ratespotink * spot &gt;= art * rate</span><br></pre></td></tr></table></figure>\n\n<p>frob</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//bytes32 i ilk address u cdpv w daidink dart</span><br><span class=\"line\">function frob(bytes32 i, address u, address v, address w, int dink, int dart) external note &#123;</span><br><span class=\"line\">    // system is live</span><br><span class=\"line\">    require(live == 1);</span><br><span class=\"line\"></span><br><span class=\"line\">    Urn memory urn = urns[i][u];</span><br><span class=\"line\">    Ilk memory ilk = ilks[i];</span><br><span class=\"line\">    // ilk has been initialised</span><br><span class=\"line\">    require(ilk.rate != 0);</span><br><span class=\"line\"></span><br><span class=\"line\">    urn.ink = add(urn.ink, dink);</span><br><span class=\"line\">    urn.art = add(urn.art, dart);</span><br><span class=\"line\">    ilk.Art = add(ilk.Art, dart);</span><br><span class=\"line\"></span><br><span class=\"line\">    int dtab = mul(ilk.rate, dart);</span><br><span class=\"line\">    uint tab = mul(urn.art, ilk.rate);</span><br><span class=\"line\">    debt     = add(debt, dtab); //dai</span><br><span class=\"line\"></span><br><span class=\"line\">    //dart &lt;=0,  dart &gt;0, </span><br><span class=\"line\"></span><br><span class=\"line\">    // either debt has decreased, or debt ceilings are not exceeded</span><br><span class=\"line\">    require(either(dart &lt;= 0, both(mul(ilk.Art, ilk.rate) &lt;= ilk.line, debt &lt;= Line)));</span><br><span class=\"line\">    // urn is either less risky than before, or it is safe</span><br><span class=\"line\">    require(either(both(dart &lt;= 0, dink &gt;= 0), tab &lt;= mul(urn.ink, ilk.spot)));</span><br><span class=\"line\">    // urn is either more safe, or the owner consents</span><br><span class=\"line\">    require(either(both(dart &lt;= 0, dink &gt;= 0), wish(u, msg.sender)));</span><br><span class=\"line\">    // collateral src consents</span><br><span class=\"line\">    require(either(dink &lt;= 0, wish(v, msg.sender)));</span><br><span class=\"line\">    // debt dst consents</span><br><span class=\"line\">    require(either(dart &gt;= 0, wish(w, msg.sender)));</span><br><span class=\"line\">    // urn has no debt, or a non-dusty amount</span><br><span class=\"line\">    require(either(urn.art == 0, tab &gt;= ilk.dust));</span><br><span class=\"line\"></span><br><span class=\"line\">    gem[i][v] = sub(gem[i][v], dink);</span><br><span class=\"line\">    dai[w]    = add(dai[w],    dtab);</span><br><span class=\"line\">    urns[i][u] = urn;</span><br><span class=\"line\">    ilks[i]    = ilk;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>cdpdart&gt;0dart&lt;0</p>\n<p>/dink &gt;=0, dart &gt;0dart * ratedink * spot</p>\n<ul>\n<li><p> &lt; line, &lt;Line</p>\n</li>\n<li><p> &lt;= raterate &gt; 1dart</p>\n</li>\n<li><p>uuuxcdp</p>\n</li>\n<li><p> &gt;  dust</p>\n</li>\n</ul>\n<p>/(gem)/dai</p>\n<h3 id=\"cat\"><a href=\"#cat\" class=\"headerlink\" title=\"cat\"></a>cat</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function bite(bytes32 ilk, address urn) external returns (uint id) &#123;</span><br><span class=\"line\">       VatLike.Ilk memory i = vat.ilks(ilk);</span><br><span class=\"line\">       VatLike.Urn memory u = vat.urns(ilk, urn);</span><br><span class=\"line\"></span><br><span class=\"line\">       require(live == 1);</span><br><span class=\"line\">       // *  &lt;  * ()</span><br><span class=\"line\">       //</span><br><span class=\"line\">       require(mul(u.ink, i.spot) &lt; mul(u.art, i.rate));</span><br><span class=\"line\">       //</span><br><span class=\"line\">       uint lot = min(u.ink, ilks[ilk].lump);</span><br><span class=\"line\">       //   *  /  </span><br><span class=\"line\">       uint art = min(u.art, mul(lot, u.art) / u.ink);</span><br><span class=\"line\">       // * ()</span><br><span class=\"line\">       uint tab = mul(art, i.rate);</span><br><span class=\"line\"></span><br><span class=\"line\">       require(lot &lt;= 2**255 &amp;&amp; art &lt;= 2**255);</span><br><span class=\"line\">       //,(gem)</span><br><span class=\"line\">       vat.grab(ilk, urn, address(this), address(vow), -int(lot), -int(art));</span><br><span class=\"line\">       //</span><br><span class=\"line\">       vow.fess(tab);</span><br><span class=\"line\">       //</span><br><span class=\"line\">       id = Kicker(ilks[ilk].flip).kick(&#123; urn: urn</span><br><span class=\"line\">                                        , gal: address(vow)</span><br><span class=\"line\">                                        , tab: rmul(tab, ilks[ilk].chop) //: dai *  / 10 ** 27</span><br><span class=\"line\">                                        , lot: lot //</span><br><span class=\"line\">                                        , bid: 0</span><br><span class=\"line\">                                        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">       emit Bite(ilk, urn, lot, art, tab, ilks[ilk].flip, id);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"example\"><a href=\"#example\" class=\"headerlink\" title=\"example\"></a>example</h5><p>join/join/vat.slip</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function join(address usr, uint wad) external note &#123;</span><br><span class=\"line\">    require(int(wad) &gt;= 0);</span><br><span class=\"line\">    vat.slip(ilk, usr, int(wad)); //gem[ilk][usr] = wad</span><br><span class=\"line\">    require(gem.transferFrom(msg.sender, address(this), wad));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vat.init(&quot;gold&quot;);</span><br><span class=\"line\">gemA = new GemJoin(address(vat), &quot;gold&quot;, address(gold));</span><br><span class=\"line\">vat.file(&quot;gold&quot;, &quot;spot&quot;, ray(1 ether)); //ray: 10 ** 9</span><br><span class=\"line\">vat.file(&quot;gold&quot;, &quot;line&quot;, rad(1000 ether)); //rad: 10 ** 27</span><br><span class=\"line\">vat.file(&quot;Line&quot;,         rad(1000 ether));</span><br><span class=\"line\">cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1 ether));</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">address urn = address(this);</span><br><span class=\"line\">//</span><br><span class=\"line\">gemA.join(urn,                             500 ether);</span><br><span class=\"line\">vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2.5 ether));</span><br><span class=\"line\">vat.frob(&quot;gold&quot;, me, me, me, 40 ether, 100 ether);</span><br><span class=\"line\">//rate (10 ** 9)</span><br><span class=\"line\">// 40 * (10 ** 18) * 2.5 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9),</span><br><span class=\"line\">//vat.urn[gold][me]= ink(40) art(100)</span><br><span class=\"line\"></span><br><span class=\"line\"> vat.file(&quot;gold&quot;, &apos;spot&apos;, ray(2 ether));  //</span><br><span class=\"line\"> cat.file(&quot;gold&quot;, &quot;chop&quot;, ray(1.1 ether));</span><br><span class=\"line\"> cat.file(&quot;gold&quot;, &quot;lump&quot;, 30 ether);</span><br><span class=\"line\"></span><br><span class=\"line\"> //</span><br><span class=\"line\"> uint auction = cat.bite(&quot;gold&quot;, address(this));</span><br><span class=\"line\"> //40 * (10 ** 18) * 2 * (10 ** 9) &gt;=? 100 * (10 ** 18) * (10 ** 9) </span><br><span class=\"line\"> //lot=min(u.ink, ilks[ilk].lump) = 30 ether</span><br><span class=\"line\"> // art = min(u.art, mul(lot, u.art) / u.ink); = 75 ether</span><br><span class=\"line\"> //vat.urn[gold][me] = ink(10 ether), art(25 ether)</span><br><span class=\"line\"> //\t\t\t\t\t\ttab = art * rate</span><br><span class=\"line\"> //kicktabrmul(tab, ilks[ilk].chop) (75 * (10 ** 18) * (10 ** 9)) * 1.1 * (10 ** 18) / 10 ** 27 = 82.5 * (10 ** 18) 85 ether</span><br></pre></td></tr></table></figure>\n\n"},{"title":"elastic_kibana","date":"2017-10-14T05:54:17.000Z","_content":"\n## ESKibana\n\n\n\nKibana\n\n### \n\n- mapping:\n\n  ```\n  data: {\n  \tproperties: {\n  \t\tdata_value: {\n  \t\t\ttype: \"long\"\n  \t\t},\n  \t\tindex: {\n  \t\t\ttype: \"long\"\n  \t\t},\n  \t}\n  }\n  ```\n\n- \n\n  ```\n  //example1:\n  {data: [{index: 0, data_value: 200}, {index: 1, data_value: 300}]}\n\n  //example2:\n  {data: [{index: 0, data_value: 200}]}\n  ```\n\n  dataindex1\n\n- es\n\n  ```\n   //example1:\n   {\n     data: {\n     \t index: [0, 1],\n     \t data_value: [200, 300],\n     }\n   }\n  ```\n\n  ElasticSearchdata.indexdata.data\\_valueexample102001300\n\n  indexindexmetricindex=0data.data\\_valuemax,example1example2max200,300...data.data_value[200, 300],index=01..\n\n  index=0data_valuemax?\n\n\n\n### Scripted Fields\n\nKibanaKibanaESscript\n\n[How to create Kibana Script Fields](https://www.elastic.co/guide/en/kibana/current/scripted-fields.html)\n\n ESscript value,script[elasticsearch script fields starting](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-script-fields.html).\n\n scriptkey-valuekey\n\n KibanaManagementIndex Patterns,index,Scripted field(Add Scripted Field)Namedata\\_index\\_0,Languagepainless,Typenumberscript\n\n```\n  if(params['_source']['data'] != null) {\n\t  for(def item : params['_source']['data']) {\n\t     if(item.index == 0)\n\t       return item.data_value;\n\t  }\n\t}\nreturn null;\n```\n\n Discoverdata\\_index\\_0,index=0data_valuekey-valueScripted Fields\\_sourcedocdata.indexdoc['data.index'].values,List\n","source":"_posts/elastic-kibana.md","raw":"---\ntitle: elastic_kibana\ndate: 2017-10-14 13:54:17\ncategories:\n- elk\n---\n\n## ESKibana\n\n\n\nKibana\n\n### \n\n- mapping:\n\n  ```\n  data: {\n  \tproperties: {\n  \t\tdata_value: {\n  \t\t\ttype: \"long\"\n  \t\t},\n  \t\tindex: {\n  \t\t\ttype: \"long\"\n  \t\t},\n  \t}\n  }\n  ```\n\n- \n\n  ```\n  //example1:\n  {data: [{index: 0, data_value: 200}, {index: 1, data_value: 300}]}\n\n  //example2:\n  {data: [{index: 0, data_value: 200}]}\n  ```\n\n  dataindex1\n\n- es\n\n  ```\n   //example1:\n   {\n     data: {\n     \t index: [0, 1],\n     \t data_value: [200, 300],\n     }\n   }\n  ```\n\n  ElasticSearchdata.indexdata.data\\_valueexample102001300\n\n  indexindexmetricindex=0data.data\\_valuemax,example1example2max200,300...data.data_value[200, 300],index=01..\n\n  index=0data_valuemax?\n\n\n\n### Scripted Fields\n\nKibanaKibanaESscript\n\n[How to create Kibana Script Fields](https://www.elastic.co/guide/en/kibana/current/scripted-fields.html)\n\n ESscript value,script[elasticsearch script fields starting](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-script-fields.html).\n\n scriptkey-valuekey\n\n KibanaManagementIndex Patterns,index,Scripted field(Add Scripted Field)Namedata\\_index\\_0,Languagepainless,Typenumberscript\n\n```\n  if(params['_source']['data'] != null) {\n\t  for(def item : params['_source']['data']) {\n\t     if(item.index == 0)\n\t       return item.data_value;\n\t  }\n\t}\nreturn null;\n```\n\n Discoverdata\\_index\\_0,index=0data_valuekey-valueScripted Fields\\_sourcedocdata.indexdoc['data.index'].values,List\n","slug":"elastic-kibana","published":1,"updated":"2019-10-14T06:21:17.808Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69sy000at6xvf53jnzum","content":"<h2 id=\"ESKibana\"><a href=\"#ESKibana\" class=\"headerlink\" title=\"ESKibana\"></a>ESKibana</h2><p></p>\n<p>Kibana</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>mapping:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data: &#123;</span><br><span class=\"line\">\tproperties: &#123;</span><br><span class=\"line\">\t\tdata_value: &#123;</span><br><span class=\"line\">\t\t\ttype: &quot;long&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\tindex: &#123;</span><br><span class=\"line\">\t\t\ttype: &quot;long&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//example1:</span><br><span class=\"line\">&#123;data: [&#123;index: 0, data_value: 200&#125;, &#123;index: 1, data_value: 300&#125;]&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//example2:</span><br><span class=\"line\">&#123;data: [&#123;index: 0, data_value: 200&#125;]&#125;</span><br></pre></td></tr></table></figure>\n\n<p>dataindex1</p>\n</li>\n<li><p>es</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//example1:</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  data: &#123;</span><br><span class=\"line\">  \t index: [0, 1],</span><br><span class=\"line\">  \t data_value: [200, 300],</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ElasticSearchdata.indexdata.data_valueexample102001300</p>\n<p>indexindexmetricindex=0data.data_valuemax,example1example2max200,300data.data_value[200, 300],index=01..</p>\n<p>index=0data_valuemax?</p>\n</li>\n</ul>\n<h3 id=\"Scripted-Fields\"><a href=\"#Scripted-Fields\" class=\"headerlink\" title=\"Scripted Fields\"></a>Scripted Fields</h3><p>KibanaKibanaESscript</p>\n<p><a href=\"https://www.elastic.co/guide/en/kibana/current/scripted-fields.html\" target=\"_blank\" rel=\"noopener\">How to create Kibana Script Fields</a></p>\n<p> ESscript value,script<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-script-fields.html\" target=\"_blank\" rel=\"noopener\">elasticsearch script fields starting</a>.</p>\n<p> scriptkey-valuekey</p>\n<p> KibanaManagementIndex Patterns,index,Scripted field(Add Scripted Field)Namedata_index_0,Languagepainless,Typenumberscript</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  if(params[&apos;_source&apos;][&apos;data&apos;] != null) &#123;</span><br><span class=\"line\">\t  for(def item : params[&apos;_source&apos;][&apos;data&apos;]) &#123;</span><br><span class=\"line\">\t     if(item.index == 0)</span><br><span class=\"line\">\t       return item.data_value;</span><br><span class=\"line\">\t  &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">return null;</span><br></pre></td></tr></table></figure>\n\n<p> Discoverdata_index_0,index=0data_valuekey-valueScripted Fields_sourcedocdata.indexdoc[data.index].values,List</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"ESKibana\"><a href=\"#ESKibana\" class=\"headerlink\" title=\"ESKibana\"></a>ESKibana</h2><p></p>\n<p>Kibana</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>mapping:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data: &#123;</span><br><span class=\"line\">\tproperties: &#123;</span><br><span class=\"line\">\t\tdata_value: &#123;</span><br><span class=\"line\">\t\t\ttype: &quot;long&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t\tindex: &#123;</span><br><span class=\"line\">\t\t\ttype: &quot;long&quot;</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//example1:</span><br><span class=\"line\">&#123;data: [&#123;index: 0, data_value: 200&#125;, &#123;index: 1, data_value: 300&#125;]&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//example2:</span><br><span class=\"line\">&#123;data: [&#123;index: 0, data_value: 200&#125;]&#125;</span><br></pre></td></tr></table></figure>\n\n<p>dataindex1</p>\n</li>\n<li><p>es</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//example1:</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  data: &#123;</span><br><span class=\"line\">  \t index: [0, 1],</span><br><span class=\"line\">  \t data_value: [200, 300],</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ElasticSearchdata.indexdata.data_valueexample102001300</p>\n<p>indexindexmetricindex=0data.data_valuemax,example1example2max200,300data.data_value[200, 300],index=01..</p>\n<p>index=0data_valuemax?</p>\n</li>\n</ul>\n<h3 id=\"Scripted-Fields\"><a href=\"#Scripted-Fields\" class=\"headerlink\" title=\"Scripted Fields\"></a>Scripted Fields</h3><p>KibanaKibanaESscript</p>\n<p><a href=\"https://www.elastic.co/guide/en/kibana/current/scripted-fields.html\" target=\"_blank\" rel=\"noopener\">How to create Kibana Script Fields</a></p>\n<p> ESscript value,script<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-script-fields.html\" target=\"_blank\" rel=\"noopener\">elasticsearch script fields starting</a>.</p>\n<p> scriptkey-valuekey</p>\n<p> KibanaManagementIndex Patterns,index,Scripted field(Add Scripted Field)Namedata_index_0,Languagepainless,Typenumberscript</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  if(params[&apos;_source&apos;][&apos;data&apos;] != null) &#123;</span><br><span class=\"line\">\t  for(def item : params[&apos;_source&apos;][&apos;data&apos;]) &#123;</span><br><span class=\"line\">\t     if(item.index == 0)</span><br><span class=\"line\">\t       return item.data_value;</span><br><span class=\"line\">\t  &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">return null;</span><br></pre></td></tr></table></figure>\n\n<p> Discoverdata_index_0,index=0data_valuekey-valueScripted Fields_sourcedocdata.indexdoc[data.index].values,List</p>\n"},{"title":"elastic_painless","date":"2017-10-14T05:55:33.000Z","_content":"\n## Painless\n\n> Painless is a scripting language developed and maintained by Elastic and optimized for Elasticsearch.\n\n### \n\n- def\n\n  null\n\n- javaMap,Listapijavaapi\n\nJavaJava8\n\n> Extends Javas syntax to provide Groovy-style scripting language features that make scripts easier to write.\n\n\n\n### \n\n- \n\n  ```\n  \tfor(def item :  doc['cmd'].values) {\n\n  \t}\n\n  ```\n\n  doc['cmd'],values,value,date\n\n- date\n\n  ```\n   return doc['begin_at'].date.hourOfDay\n  ```\n\n  datejava..CalenderCalendar\n\n### \n\n\n\nKibanascript fieldsDev Toolsscriptscipt\n\n```\nGET /test/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"script_fields\": {\n    \"test_script\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"inline\": \"return doc['begin_at'].date.hourOfDay\"\n      }\n    }\n  },\n  \"size\": 1\n}\n\n```\n\nDebug.explain\n\n```\nPUT /hockey/player/1?refresh\n{\"first\":\"johnny\",\"last\":\"gaudreau\",\"goals\":[9,27,1],\"assists\":[17,46,0],\"gp\":[26,82,1]}\n\nPOST /hockey/player/1/_explain\n{\n  \"query\": {\n    \"script\": {\n      \"script\": \"Debug.explain(doc.goals)\"\n    }\n  }\n}\n\n```\n\nby responding\n\n```\n{\n   \"error\": {\n      \"type\": \"script_exception\",\n      \"to_string\": \"[1, 9, 27]\",\n      \"painless_class\": \"org.elasticsearch.index.fielddata.ScriptDocValues.Longs\",\n      \"java_class\": \"org.elasticsearch.index.fielddata.ScriptDocValues$Longs\",\n      ...\n   },\n   \"status\": 500\n}\n```\n","source":"_posts/elastic-painless.md","raw":"---\ntitle: elastic_painless\ndate: 2017-10-14 13:55:33\ncategories:\n- elk\n---\n\n## Painless\n\n> Painless is a scripting language developed and maintained by Elastic and optimized for Elasticsearch.\n\n### \n\n- def\n\n  null\n\n- javaMap,Listapijavaapi\n\nJavaJava8\n\n> Extends Javas syntax to provide Groovy-style scripting language features that make scripts easier to write.\n\n\n\n### \n\n- \n\n  ```\n  \tfor(def item :  doc['cmd'].values) {\n\n  \t}\n\n  ```\n\n  doc['cmd'],values,value,date\n\n- date\n\n  ```\n   return doc['begin_at'].date.hourOfDay\n  ```\n\n  datejava..CalenderCalendar\n\n### \n\n\n\nKibanascript fieldsDev Toolsscriptscipt\n\n```\nGET /test/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"script_fields\": {\n    \"test_script\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"inline\": \"return doc['begin_at'].date.hourOfDay\"\n      }\n    }\n  },\n  \"size\": 1\n}\n\n```\n\nDebug.explain\n\n```\nPUT /hockey/player/1?refresh\n{\"first\":\"johnny\",\"last\":\"gaudreau\",\"goals\":[9,27,1],\"assists\":[17,46,0],\"gp\":[26,82,1]}\n\nPOST /hockey/player/1/_explain\n{\n  \"query\": {\n    \"script\": {\n      \"script\": \"Debug.explain(doc.goals)\"\n    }\n  }\n}\n\n```\n\nby responding\n\n```\n{\n   \"error\": {\n      \"type\": \"script_exception\",\n      \"to_string\": \"[1, 9, 27]\",\n      \"painless_class\": \"org.elasticsearch.index.fielddata.ScriptDocValues.Longs\",\n      \"java_class\": \"org.elasticsearch.index.fielddata.ScriptDocValues$Longs\",\n      ...\n   },\n   \"status\": 500\n}\n```\n","slug":"elastic-painless","published":1,"updated":"2019-10-14T06:21:28.123Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69t3000bt6xv9zo3a3ma","content":"<h2 id=\"Painless\"><a href=\"#Painless\" class=\"headerlink\" title=\"Painless\"></a>Painless</h2><blockquote>\n<p>Painless is a scripting language developed and maintained by Elastic and optimized for Elasticsearch.</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>def</p>\n<p>null</p>\n</li>\n<li><p>javaMap,Listapijavaapi</p>\n</li>\n</ul>\n<p>JavaJava8</p>\n<blockquote>\n<p>Extends Javas syntax to provide Groovy-style scripting language features that make scripts easier to write.</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for(def item :  doc[&apos;cmd&apos;].values) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>doc[cmd],values,value,date</p>\n</li>\n<li><p>date</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return doc[&apos;begin_at&apos;].date.hourOfDay</span><br></pre></td></tr></table></figure>\n\n<p>datejava..CalenderCalendar</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>Kibanascript fieldsDev Toolsscriptscipt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;script_fields&quot;: &#123;</span><br><span class=\"line\">    &quot;test_script&quot;: &#123;</span><br><span class=\"line\">      &quot;script&quot;: &#123;</span><br><span class=\"line\">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class=\"line\">        &quot;inline&quot;: &quot;return doc[&apos;begin_at&apos;].date.hourOfDay&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;size&quot;: 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Debug.explain</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /hockey/player/1?refresh</span><br><span class=\"line\">&#123;&quot;first&quot;:&quot;johnny&quot;,&quot;last&quot;:&quot;gaudreau&quot;,&quot;goals&quot;:[9,27,1],&quot;assists&quot;:[17,46,0],&quot;gp&quot;:[26,82,1]&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /hockey/player/1/_explain</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;script&quot;: &#123;</span><br><span class=\"line\">      &quot;script&quot;: &quot;Debug.explain(doc.goals)&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>by responding</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;error&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;script_exception&quot;,</span><br><span class=\"line\">      &quot;to_string&quot;: &quot;[1, 9, 27]&quot;,</span><br><span class=\"line\">      &quot;painless_class&quot;: &quot;org.elasticsearch.index.fielddata.ScriptDocValues.Longs&quot;,</span><br><span class=\"line\">      &quot;java_class&quot;: &quot;org.elasticsearch.index.fielddata.ScriptDocValues$Longs&quot;,</span><br><span class=\"line\">      ...</span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   &quot;status&quot;: 500</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Painless\"><a href=\"#Painless\" class=\"headerlink\" title=\"Painless\"></a>Painless</h2><blockquote>\n<p>Painless is a scripting language developed and maintained by Elastic and optimized for Elasticsearch.</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>def</p>\n<p>null</p>\n</li>\n<li><p>javaMap,Listapijavaapi</p>\n</li>\n</ul>\n<p>JavaJava8</p>\n<blockquote>\n<p>Extends Javas syntax to provide Groovy-style scripting language features that make scripts easier to write.</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for(def item :  doc[&apos;cmd&apos;].values) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>doc[cmd],values,value,date</p>\n</li>\n<li><p>date</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return doc[&apos;begin_at&apos;].date.hourOfDay</span><br></pre></td></tr></table></figure>\n\n<p>datejava..CalenderCalendar</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>Kibanascript fieldsDev Toolsscriptscipt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /test/_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;script_fields&quot;: &#123;</span><br><span class=\"line\">    &quot;test_script&quot;: &#123;</span><br><span class=\"line\">      &quot;script&quot;: &#123;</span><br><span class=\"line\">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class=\"line\">        &quot;inline&quot;: &quot;return doc[&apos;begin_at&apos;].date.hourOfDay&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;size&quot;: 1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Debug.explain</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PUT /hockey/player/1?refresh</span><br><span class=\"line\">&#123;&quot;first&quot;:&quot;johnny&quot;,&quot;last&quot;:&quot;gaudreau&quot;,&quot;goals&quot;:[9,27,1],&quot;assists&quot;:[17,46,0],&quot;gp&quot;:[26,82,1]&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">POST /hockey/player/1/_explain</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;script&quot;: &#123;</span><br><span class=\"line\">      &quot;script&quot;: &quot;Debug.explain(doc.goals)&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>by responding</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">   &quot;error&quot;: &#123;</span><br><span class=\"line\">      &quot;type&quot;: &quot;script_exception&quot;,</span><br><span class=\"line\">      &quot;to_string&quot;: &quot;[1, 9, 27]&quot;,</span><br><span class=\"line\">      &quot;painless_class&quot;: &quot;org.elasticsearch.index.fielddata.ScriptDocValues.Longs&quot;,</span><br><span class=\"line\">      &quot;java_class&quot;: &quot;org.elasticsearch.index.fielddata.ScriptDocValues$Longs&quot;,</span><br><span class=\"line\">      ...</span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   &quot;status&quot;: 500</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n"},{"title":"elastic_logstash","date":"2017-10-14T05:55:27.000Z","_content":"\n## logstash_config\n\n input, filter, output\n[](https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html)\n\n### value\n\n> A plugin can require that the value for a setting be a certain type, such as boolean, list, or hash.\n\n- Array\n\n  users => [ {id => 1, name => bob}, {id => 2, name => jane} ]\n\n- Lists\n\n  path => [ \"/var/log/messages\", \"/var/log/*.log\" ]\n    \t\turis => [ \"http://elastic.co\", \"http://example.net\" ]\n\n- Boolean\n\n  ssl_enable => true\n\n- Bytes\n\n  my_bytes => \"1113\"   # 1113 bytes\n  \t  my_bytes => \"10MiB\"  # 10485760 bytes\n  \t  my_bytes => \"100kib\" # 102400 bytes\n  \t  my_bytes => \"180 mb\" # 180000000 bytes\n\n- Codec\n\n  codec => \"json\"\n  \t  //https://www.elastic.co/guide/en/logstash/current/codec-plugins.html\n\n- Hash\n\n  match => {\n  \t  \"field1\" => \"value1\"\n  \t  \"field2\" => \"value2\"\n  \t  ...\n  \t}\n\n- Number\n\n  port => 33\n\n- Password\n\n  my_password => \"password\"\n\n- URI\n\n  my_uri => \"http://foo:bar@example.net\"\n\n- Path\n\n  my_path => \"/tmp/logstash\"\n\n- String\n\n  name => \"Hello world\"\n    \t\t  name => 'It\\'s a beautiful day'\n\n- Comments\n\n  # this is a comment\n\n  ```\n  \tinput { # comments can appear at the end of a line, too\n  \t  # ...\n  \t}\n  ```\n\n### filter\n\n- mutate\n\n  mutate { replace => { \"type\" => \"file_test\" } }\n\n- grok\n\n  > Parses unstructured event data into fields\n\n  ```\n  grok {\n    match => { \"message\" => \"%{COMBINEDAPACHELOG}\" }\n  }\n  ```\n\n  [patterns](https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns)\n\n- date\n\n  date {\n    \t\t  match => [ \"timestamp\" , \"dd/MMM/yyyy:HH:mm:ss Z\" ]\n  \t  }\n\n\n- json\n\n  > Parses JSON events\n\n\n\n##### drop example:\n\n```\nfilter {\n\t    grok {\n            match => [\"message\",\"%{TIMESTAMP_ISO8601:logtime} \\[%{NUMBER}\\] \\(\\(%{WORD}\\)\\) %{WORD:loglevel} %{GREEDYDATA:other}\"]\n    }\n\n    if [loglevel]!= \"ERROR\" {\n            drop {}\n    }\n}\n```\n\n### input\n\n[file](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html)\n\n### output\n\n### filter\n\n- grok\n  \t \n\n    \t grok {\n      match => { \"message\" => \"%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}\" }\n    \t}\n\n\n  > Grok sits on top of regular expressions, so any regular expressions are valid in grok as well.\n\n   pattern\"%{IP:client}\" IPpattern, clientclient    \n   [pattern](https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html#_custom_patterns),pattern\n\n\n  ```\n   # contents of ./patterns/extra:\n  JAVA_CLASS ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*\n  ```\n\ngrokpatterns\\_dirpatterns\\_dir\n\n```\n  grok {\n\t  patterns_dir => [\"/Users/xiaoxuez/Library/apache/logstash-5.4.2/patterns\"]\n\t  match => { \"message\" => \"%{TIMESTAMP_ISO8601:timestamp} %{JAVA_CLASS:producer} %{WORD:printer} %{GREEDYDATA:content}\" }\n}\n```\n\n    \n\n### config\n\n config[if]()  \n\n```\nfilter {\n \t...\n \tif ([producer] =~ /[m].*/) {\n \t\t# do ..\n\t} else {\n\t\t drop { }  # output\n\t}\n```\n\n   }\n\n# =~  \n\n\n\n## EXAMPLE\n\nfile\n\n \t path => \"/var/log/%{type}.%{+yyyy.MM.dd.HH}\"\n\n[][path]\n\n# ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*  \n\n```\n  json{\n       source => \"content\"\n       target => \"content\"\n   }\n\n   mutate {\n\t         add_field => {\n\t           \"event_type\" => \"%{[jsoncontent][type]}\"\n\t           \"event_msg\" => \"%{[jsoncontent][event]}\"\n\t         }\n       }\n```\n\n\t\t\n\t\t      \n    \n\n```\n  #\nif ([producer] == \"STUDIO\" ) {\n    mutate { replace => { \"type\" => \"System_Airguru_Log\" } }\n} else if ([producer] =~ /[m].*/) {\n    json{\n          source => \"content\"\n          target => \"jsoncontent\"\n      }\n    mutate {\n      replace => { \"type\" => \"Stratege_Airguru_Log\" }\n      add_field => {\n```\n\n  \t\t           \"event_type\" => \"%{[jsoncontent][type]}\"\n  \t\t           \"event_msg\" => \"%{[jsoncontent][event]}\"\n  \t\t         }\n          }\n    } else {\n      drop { }\n    }\t\t\n\n\n\n### Example\n\n#### filter-aggregate\n\n```\ninput {\n  file {\n    path => \"${PROJECT}/logs/**/**/worker.log\"\n    start_position => \"beginning\"\n  }\n}\n\nfilter {\n#  if [path] =~ \".log\" {\n    #\n    grok {\n\t\t\tid => \"storm_log_filter\"\n      patterns_dir => [\"${PROJECT}/patterns\"]\n      #match => { \"message\" => \"%{GREEDYDATA:unknow}\" }\n      #match => { \"message\" => \"%{TIMESTAMP_ISO8601:time} %{JAVA_CLASS:producer} %{WORD:printer} %{GREEDYDATA:content}\" }\n      match => { \"path\" => \".*/%{WORD:topology}\\-%{JUST_NUMBER:order}\\-%{JUST_NUMBER:submittime}/[0-9]+/worker.log\" }\n      break_on_match => false\n    }\n\n    aggregate {\n     task_id => \"%{topology}-%{order}-%{submittime}\"\n     code => \"map['counts'] ||= 0; map['counts'] += 1;\"\n     push_map_as_event_on_timeout => true\n     timeout_task_id_field => \"topology_file\"\n     timeout => 360 # 10 minutes timeout\n     timeout_tags => ['_aggregatetimeout']\n   }\n```\n\n\n\n```\n#  }\n\n}\n\noutput {\n  stdout { codec => rubydebug }\n}\n```\n\n#### filter-basic-grok\n\n```\ninput {\n  file {\n    path => \"/Users/xiaoxuez/Library/apache/logstash-5.4.2/test/file_test_log.log\"\n    start_position => \"beginning\"\n  }\n}\n\nfilter {\n  if [path] =~ \".log\" {\n    #\n    grok {\n      match => { \"message\" => \"%{TOMCAT_DATESTAMP:time} %{JAVACLASS:producer} %{WORD} %{GREEDYDATA:content}\" }\n      break_on_match => false\n    }\n```\n\n\n\n\n\n\n```\n    # if ([producer] !~ /[m].*/ or \"_grokparsefailure\" in [tags]) {\n      # drop { }\n  #  }\n\n    mutate {\n      #  remove_field => [\"message\"]\n    }\n```\n\n\n\n```\n  }\n\n}\n\noutput {\n  #elasticsearch {\n  #  hosts => [\"localhost:9200\"]\n  #}\n  # stdout#\n  stdout { codec => rubydebug }\n}\n```\n\n## \n\n- ...\n\n  logstash,(logstash..),{logstash}/data/plugins/inputs/file/.sincedb*\n","source":"_posts/elastic-logstash.md","raw":"---\ntitle: elastic_logstash\ndate: 2017-10-14 13:55:27\ncategories:\n- elk\n---\n\n## logstash_config\n\n input, filter, output\n[](https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html)\n\n### value\n\n> A plugin can require that the value for a setting be a certain type, such as boolean, list, or hash.\n\n- Array\n\n  users => [ {id => 1, name => bob}, {id => 2, name => jane} ]\n\n- Lists\n\n  path => [ \"/var/log/messages\", \"/var/log/*.log\" ]\n    \t\turis => [ \"http://elastic.co\", \"http://example.net\" ]\n\n- Boolean\n\n  ssl_enable => true\n\n- Bytes\n\n  my_bytes => \"1113\"   # 1113 bytes\n  \t  my_bytes => \"10MiB\"  # 10485760 bytes\n  \t  my_bytes => \"100kib\" # 102400 bytes\n  \t  my_bytes => \"180 mb\" # 180000000 bytes\n\n- Codec\n\n  codec => \"json\"\n  \t  //https://www.elastic.co/guide/en/logstash/current/codec-plugins.html\n\n- Hash\n\n  match => {\n  \t  \"field1\" => \"value1\"\n  \t  \"field2\" => \"value2\"\n  \t  ...\n  \t}\n\n- Number\n\n  port => 33\n\n- Password\n\n  my_password => \"password\"\n\n- URI\n\n  my_uri => \"http://foo:bar@example.net\"\n\n- Path\n\n  my_path => \"/tmp/logstash\"\n\n- String\n\n  name => \"Hello world\"\n    \t\t  name => 'It\\'s a beautiful day'\n\n- Comments\n\n  # this is a comment\n\n  ```\n  \tinput { # comments can appear at the end of a line, too\n  \t  # ...\n  \t}\n  ```\n\n### filter\n\n- mutate\n\n  mutate { replace => { \"type\" => \"file_test\" } }\n\n- grok\n\n  > Parses unstructured event data into fields\n\n  ```\n  grok {\n    match => { \"message\" => \"%{COMBINEDAPACHELOG}\" }\n  }\n  ```\n\n  [patterns](https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns)\n\n- date\n\n  date {\n    \t\t  match => [ \"timestamp\" , \"dd/MMM/yyyy:HH:mm:ss Z\" ]\n  \t  }\n\n\n- json\n\n  > Parses JSON events\n\n\n\n##### drop example:\n\n```\nfilter {\n\t    grok {\n            match => [\"message\",\"%{TIMESTAMP_ISO8601:logtime} \\[%{NUMBER}\\] \\(\\(%{WORD}\\)\\) %{WORD:loglevel} %{GREEDYDATA:other}\"]\n    }\n\n    if [loglevel]!= \"ERROR\" {\n            drop {}\n    }\n}\n```\n\n### input\n\n[file](https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html)\n\n### output\n\n### filter\n\n- grok\n  \t \n\n    \t grok {\n      match => { \"message\" => \"%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}\" }\n    \t}\n\n\n  > Grok sits on top of regular expressions, so any regular expressions are valid in grok as well.\n\n   pattern\"%{IP:client}\" IPpattern, clientclient    \n   [pattern](https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html#_custom_patterns),pattern\n\n\n  ```\n   # contents of ./patterns/extra:\n  JAVA_CLASS ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*\n  ```\n\ngrokpatterns\\_dirpatterns\\_dir\n\n```\n  grok {\n\t  patterns_dir => [\"/Users/xiaoxuez/Library/apache/logstash-5.4.2/patterns\"]\n\t  match => { \"message\" => \"%{TIMESTAMP_ISO8601:timestamp} %{JAVA_CLASS:producer} %{WORD:printer} %{GREEDYDATA:content}\" }\n}\n```\n\n    \n\n### config\n\n config[if]()  \n\n```\nfilter {\n \t...\n \tif ([producer] =~ /[m].*/) {\n \t\t# do ..\n\t} else {\n\t\t drop { }  # output\n\t}\n```\n\n   }\n\n# =~  \n\n\n\n## EXAMPLE\n\nfile\n\n \t path => \"/var/log/%{type}.%{+yyyy.MM.dd.HH}\"\n\n[][path]\n\n# ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*  \n\n```\n  json{\n       source => \"content\"\n       target => \"content\"\n   }\n\n   mutate {\n\t         add_field => {\n\t           \"event_type\" => \"%{[jsoncontent][type]}\"\n\t           \"event_msg\" => \"%{[jsoncontent][event]}\"\n\t         }\n       }\n```\n\n\t\t\n\t\t      \n    \n\n```\n  #\nif ([producer] == \"STUDIO\" ) {\n    mutate { replace => { \"type\" => \"System_Airguru_Log\" } }\n} else if ([producer] =~ /[m].*/) {\n    json{\n          source => \"content\"\n          target => \"jsoncontent\"\n      }\n    mutate {\n      replace => { \"type\" => \"Stratege_Airguru_Log\" }\n      add_field => {\n```\n\n  \t\t           \"event_type\" => \"%{[jsoncontent][type]}\"\n  \t\t           \"event_msg\" => \"%{[jsoncontent][event]}\"\n  \t\t         }\n          }\n    } else {\n      drop { }\n    }\t\t\n\n\n\n### Example\n\n#### filter-aggregate\n\n```\ninput {\n  file {\n    path => \"${PROJECT}/logs/**/**/worker.log\"\n    start_position => \"beginning\"\n  }\n}\n\nfilter {\n#  if [path] =~ \".log\" {\n    #\n    grok {\n\t\t\tid => \"storm_log_filter\"\n      patterns_dir => [\"${PROJECT}/patterns\"]\n      #match => { \"message\" => \"%{GREEDYDATA:unknow}\" }\n      #match => { \"message\" => \"%{TIMESTAMP_ISO8601:time} %{JAVA_CLASS:producer} %{WORD:printer} %{GREEDYDATA:content}\" }\n      match => { \"path\" => \".*/%{WORD:topology}\\-%{JUST_NUMBER:order}\\-%{JUST_NUMBER:submittime}/[0-9]+/worker.log\" }\n      break_on_match => false\n    }\n\n    aggregate {\n     task_id => \"%{topology}-%{order}-%{submittime}\"\n     code => \"map['counts'] ||= 0; map['counts'] += 1;\"\n     push_map_as_event_on_timeout => true\n     timeout_task_id_field => \"topology_file\"\n     timeout => 360 # 10 minutes timeout\n     timeout_tags => ['_aggregatetimeout']\n   }\n```\n\n\n\n```\n#  }\n\n}\n\noutput {\n  stdout { codec => rubydebug }\n}\n```\n\n#### filter-basic-grok\n\n```\ninput {\n  file {\n    path => \"/Users/xiaoxuez/Library/apache/logstash-5.4.2/test/file_test_log.log\"\n    start_position => \"beginning\"\n  }\n}\n\nfilter {\n  if [path] =~ \".log\" {\n    #\n    grok {\n      match => { \"message\" => \"%{TOMCAT_DATESTAMP:time} %{JAVACLASS:producer} %{WORD} %{GREEDYDATA:content}\" }\n      break_on_match => false\n    }\n```\n\n\n\n\n\n\n```\n    # if ([producer] !~ /[m].*/ or \"_grokparsefailure\" in [tags]) {\n      # drop { }\n  #  }\n\n    mutate {\n      #  remove_field => [\"message\"]\n    }\n```\n\n\n\n```\n  }\n\n}\n\noutput {\n  #elasticsearch {\n  #  hosts => [\"localhost:9200\"]\n  #}\n  # stdout#\n  stdout { codec => rubydebug }\n}\n```\n\n## \n\n- ...\n\n  logstash,(logstash..),{logstash}/data/plugins/inputs/file/.sincedb*\n","slug":"elastic-logstash","published":1,"updated":"2019-10-14T06:21:23.703Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69t8000et6xvr1hw6pbw","content":"<h2 id=\"logstash-config\"><a href=\"#logstash-config\" class=\"headerlink\" title=\"logstash_config\"></a>logstash_config</h2><p> input, filter, output<br><a href=\"https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h3 id=\"value\"><a href=\"#value\" class=\"headerlink\" title=\"value\"></a>value</h3><blockquote>\n<p>A plugin can require that the value for a setting be a certain type, such as boolean, list, or hash.</p>\n</blockquote>\n<ul>\n<li><p>Array</p>\n<p>users =&gt; [ {id =&gt; 1, name =&gt; bob}, {id =&gt; 2, name =&gt; jane} ]</p>\n</li>\n<li><p>Lists</p>\n<p>path =&gt; [ /var/log/messages, /var/log/*.log ]</p>\n<pre><code>uris =&gt; [ &quot;http://elastic.co&quot;, &quot;http://example.net&quot; ]</code></pre></li>\n<li><p>Boolean</p>\n<p>ssl_enable =&gt; true</p>\n</li>\n<li><p>Bytes</p>\n<p>my_bytes =&gt; 1113   # 1113 bytes</p>\n<pre><code>my_bytes =&gt; &quot;10MiB&quot;  # 10485760 bytes\nmy_bytes =&gt; &quot;100kib&quot; # 102400 bytes\nmy_bytes =&gt; &quot;180 mb&quot; # 180000000 bytes</code></pre></li>\n<li><p>Codec</p>\n<p>codec =&gt; json</p>\n<pre><code>//https://www.elastic.co/guide/en/logstash/current/codec-plugins.html</code></pre></li>\n<li><p>Hash</p>\n<p>match =&gt; {</p>\n<pre><code>  &quot;field1&quot; =&gt; &quot;value1&quot;\n  &quot;field2&quot; =&gt; &quot;value2&quot;\n  ...\n}</code></pre></li>\n<li><p>Number</p>\n<p>port =&gt; 33</p>\n</li>\n<li><p>Password</p>\n<p>my_password =&gt; password</p>\n</li>\n<li><p>URI</p>\n<p>my_uri =&gt; <a href=\"http://foo:bar@example.net&quot;\" target=\"_blank\" rel=\"noopener\">http://foo:bar@example.net&quot;</a></p>\n</li>\n<li><p>Path</p>\n<p>my_path =&gt; /tmp/logstash</p>\n</li>\n<li><p>String</p>\n<p>name =&gt; Hello world</p>\n<pre><code>name =&gt; &apos;It\\&apos;s a beautiful day&apos;</code></pre></li>\n<li><p>Comments</p>\n<h1 id=\"this-is-a-comment\"><a href=\"#this-is-a-comment\" class=\"headerlink\" title=\"this is a comment\"></a>this is a comment</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123; # comments can appear at the end of a line, too</span><br><span class=\"line\">  # ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"filter\"><a href=\"#filter\" class=\"headerlink\" title=\"filter\"></a>filter</h3><ul>\n<li><p>mutate</p>\n<p>mutate { replace =&gt; { type =&gt; file_test } }</p>\n</li>\n<li><p>grok</p>\n<blockquote>\n<p>Parses unstructured event data into fields</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grok &#123;</span><br><span class=\"line\">  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns\">patterns</a></p>\n</li>\n<li><p>date</p>\n<p>date {</p>\n<pre><code>      match =&gt; [ &quot;timestamp&quot; , &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ]\n}</code></pre></li>\n</ul>\n<ul>\n<li><p>json</p>\n<blockquote>\n<p>Parses JSON events</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"drop-example\"><a href=\"#drop-example\" class=\"headerlink\" title=\"drop example:\"></a>drop example:</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filter &#123;</span><br><span class=\"line\">\t    grok &#123;</span><br><span class=\"line\">            match =&gt; [&quot;message&quot;,&quot;%&#123;TIMESTAMP_ISO8601:logtime&#125; \\[%&#123;NUMBER&#125;\\] \\(\\(%&#123;WORD&#125;\\)\\) %&#123;WORD:loglevel&#125; %&#123;GREEDYDATA:other&#125;&quot;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    if [loglevel]!= &quot;ERROR&quot; &#123;</span><br><span class=\"line\">            drop &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"input\"><a href=\"#input\" class=\"headerlink\" title=\"input\"></a>input</h3><p><a href=\"https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html\" target=\"_blank\" rel=\"noopener\">file</a></p>\n<h3 id=\"output\"><a href=\"#output\" class=\"headerlink\" title=\"output\"></a>output</h3><h3 id=\"filter-1\"><a href=\"#filter-1\" class=\"headerlink\" title=\"filter\"></a>filter</h3><ul>\n<li><p>grok</p>\n<pre><code> \n\n   grok {\nmatch =&gt; { &quot;message&quot; =&gt; &quot;%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}&quot; }\n  }</code></pre></li>\n</ul>\n<blockquote>\n<p>Grok sits on top of regular expressions, so any regular expressions are valid in grok as well.</p>\n</blockquote>\n<p>   pattern%{IP:client} IPpattern, clientclient<br>   <a href=\"https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html#_custom_patterns\" target=\"_blank\" rel=\"noopener\">pattern</a>,pattern</p>\n  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> # contents of ./patterns/extra:</span><br><span class=\"line\">JAVA_CLASS ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*</span><br></pre></td></tr></table></figure>\n\n<p>grokpatterns_dirpatterns_dir</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  grok &#123;</span><br><span class=\"line\">\t  patterns_dir =&gt; [&quot;/Users/xiaoxuez/Library/apache/logstash-5.4.2/patterns&quot;]</span><br><span class=\"line\">\t  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:timestamp&#125; %&#123;JAVA_CLASS:producer&#125; %&#123;WORD:printer&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>    </p>\n<h3 id=\"config\"><a href=\"#config\" class=\"headerlink\" title=\"config\"></a>config</h3><p> config<a href>if</a>  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filter &#123;</span><br><span class=\"line\"> \t...</span><br><span class=\"line\"> \tif ([producer] =~ /[m].*/) &#123;</span><br><span class=\"line\"> \t\t# do ..</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\t drop &#123; &#125;  # output</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>   }</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"=~  \"></a>=~  </h1><h2 id=\"EXAMPLE\"><a href=\"#EXAMPLE\" class=\"headerlink\" title=\"EXAMPLE\"></a>EXAMPLE</h2><p>file</p>\n<pre><code>path =&gt; &quot;/var/log/%{type}.%{+yyyy.MM.dd.HH}&quot;</code></pre><p>[][path]</p>\n<h1 id=\"a-zA-Z-a-zA-Z-\"><a href=\"#a-zA-Z-a-zA-Z-\" class=\"headerlink\" title=\"([a-zA-Z]+[.][a-zA-Z]+)[.].  \"></a>([a-zA-Z]+[.][a-zA-Z]+)[.]<em>.</em>  </h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">json&#123;</span><br><span class=\"line\">     source =&gt; &quot;content&quot;</span><br><span class=\"line\">     target =&gt; &quot;content&quot;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> mutate &#123;</span><br><span class=\"line\">        add_field =&gt; &#123;</span><br><span class=\"line\">          &quot;event_type&quot; =&gt; &quot;%&#123;[jsoncontent][type]&#125;&quot;</span><br><span class=\"line\">          &quot;event_msg&quot; =&gt; &quot;%&#123;[jsoncontent][event]&#125;&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br></pre></td></tr></table></figure>\n\n<p><br><br>    </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  #</span><br><span class=\"line\">if ([producer] == &quot;STUDIO&quot; ) &#123;</span><br><span class=\"line\">    mutate &#123; replace =&gt; &#123; &quot;type&quot; =&gt; &quot;System_Airguru_Log&quot; &#125; &#125;</span><br><span class=\"line\">&#125; else if ([producer] =~ /[m].*/) &#123;</span><br><span class=\"line\">    json&#123;</span><br><span class=\"line\">          source =&gt; &quot;content&quot;</span><br><span class=\"line\">          target =&gt; &quot;jsoncontent&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    mutate &#123;</span><br><span class=\"line\">      replace =&gt; &#123; &quot;type&quot; =&gt; &quot;Stratege_Airguru_Log&quot; &#125;</span><br><span class=\"line\">      add_field =&gt; &#123;</span><br></pre></td></tr></table></figure>\n\n<pre><code>                 &quot;event_type&quot; =&gt; &quot;%{[jsoncontent][type]}&quot;\n                 &quot;event_msg&quot; =&gt; &quot;%{[jsoncontent][event]}&quot;\n               }\n      }\n} else {\n  drop { }\n}        </code></pre><h3 id=\"Example\"><a href=\"#Example\" class=\"headerlink\" title=\"Example\"></a>Example</h3><h4 id=\"filter-aggregate\"><a href=\"#filter-aggregate\" class=\"headerlink\" title=\"filter-aggregate\"></a>filter-aggregate</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">  file &#123;</span><br><span class=\"line\">    path =&gt; &quot;$&#123;PROJECT&#125;/logs/**/**/worker.log&quot;</span><br><span class=\"line\">    start_position =&gt; &quot;beginning&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123;</span><br><span class=\"line\">#  if [path] =~ &quot;.log&quot; &#123;</span><br><span class=\"line\">    #</span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">\t\t\tid =&gt; &quot;storm_log_filter&quot;</span><br><span class=\"line\">      patterns_dir =&gt; [&quot;$&#123;PROJECT&#125;/patterns&quot;]</span><br><span class=\"line\">      #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;GREEDYDATA:unknow&#125;&quot; &#125;</span><br><span class=\"line\">      #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:time&#125; %&#123;JAVA_CLASS:producer&#125; %&#123;WORD:printer&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class=\"line\">      match =&gt; &#123; &quot;path&quot; =&gt; &quot;.*/%&#123;WORD:topology&#125;\\-%&#123;JUST_NUMBER:order&#125;\\-%&#123;JUST_NUMBER:submittime&#125;/[0-9]+/worker.log&quot; &#125;</span><br><span class=\"line\">      break_on_match =&gt; false</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    aggregate &#123;</span><br><span class=\"line\">     task_id =&gt; &quot;%&#123;topology&#125;-%&#123;order&#125;-%&#123;submittime&#125;&quot;</span><br><span class=\"line\">     code =&gt; &quot;map[&apos;counts&apos;] ||= 0; map[&apos;counts&apos;] += 1;&quot;</span><br><span class=\"line\">     push_map_as_event_on_timeout =&gt; true</span><br><span class=\"line\">     timeout_task_id_field =&gt; &quot;topology_file&quot;</span><br><span class=\"line\">     timeout =&gt; 360 # 10 minutes timeout</span><br><span class=\"line\">     timeout_tags =&gt; [&apos;_aggregatetimeout&apos;]</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"filter-basic-grok\"><a href=\"#filter-basic-grok\" class=\"headerlink\" title=\"filter-basic-grok\"></a>filter-basic-grok</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">  file &#123;</span><br><span class=\"line\">    path =&gt; &quot;/Users/xiaoxuez/Library/apache/logstash-5.4.2/test/file_test_log.log&quot;</span><br><span class=\"line\">    start_position =&gt; &quot;beginning&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123;</span><br><span class=\"line\">  if [path] =~ &quot;.log&quot; &#123;</span><br><span class=\"line\">    #</span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">      match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TOMCAT_DATESTAMP:time&#125; %&#123;JAVACLASS:producer&#125; %&#123;WORD&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class=\"line\">      break_on_match =&gt; false</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><br><br><br></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  # if ([producer] !~ /[m].*/ or &quot;_grokparsefailure&quot; in [tags]) &#123;</span><br><span class=\"line\">    # drop &#123; &#125;</span><br><span class=\"line\">#  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    #  remove_field =&gt; [&quot;message&quot;]</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  #elasticsearch &#123;</span><br><span class=\"line\">  #  hosts =&gt; [&quot;localhost:9200&quot;]</span><br><span class=\"line\">  #&#125;</span><br><span class=\"line\">  # stdout#</span><br><span class=\"line\">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><p></p>\n<p>logstash,(logstash..),{logstash}/data/plugins/inputs/file/.sincedb*</p>\n</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"logstash-config\"><a href=\"#logstash-config\" class=\"headerlink\" title=\"logstash_config\"></a>logstash_config</h2><p> input, filter, output<br><a href=\"https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h3 id=\"value\"><a href=\"#value\" class=\"headerlink\" title=\"value\"></a>value</h3><blockquote>\n<p>A plugin can require that the value for a setting be a certain type, such as boolean, list, or hash.</p>\n</blockquote>\n<ul>\n<li><p>Array</p>\n<p>users =&gt; [ {id =&gt; 1, name =&gt; bob}, {id =&gt; 2, name =&gt; jane} ]</p>\n</li>\n<li><p>Lists</p>\n<p>path =&gt; [ /var/log/messages, /var/log/*.log ]</p>\n<pre><code>uris =&gt; [ &quot;http://elastic.co&quot;, &quot;http://example.net&quot; ]</code></pre></li>\n<li><p>Boolean</p>\n<p>ssl_enable =&gt; true</p>\n</li>\n<li><p>Bytes</p>\n<p>my_bytes =&gt; 1113   # 1113 bytes</p>\n<pre><code>my_bytes =&gt; &quot;10MiB&quot;  # 10485760 bytes\nmy_bytes =&gt; &quot;100kib&quot; # 102400 bytes\nmy_bytes =&gt; &quot;180 mb&quot; # 180000000 bytes</code></pre></li>\n<li><p>Codec</p>\n<p>codec =&gt; json</p>\n<pre><code>//https://www.elastic.co/guide/en/logstash/current/codec-plugins.html</code></pre></li>\n<li><p>Hash</p>\n<p>match =&gt; {</p>\n<pre><code>  &quot;field1&quot; =&gt; &quot;value1&quot;\n  &quot;field2&quot; =&gt; &quot;value2&quot;\n  ...\n}</code></pre></li>\n<li><p>Number</p>\n<p>port =&gt; 33</p>\n</li>\n<li><p>Password</p>\n<p>my_password =&gt; password</p>\n</li>\n<li><p>URI</p>\n<p>my_uri =&gt; <a href=\"http://foo:bar@example.net&quot;\" target=\"_blank\" rel=\"noopener\">http://foo:bar@example.net&quot;</a></p>\n</li>\n<li><p>Path</p>\n<p>my_path =&gt; /tmp/logstash</p>\n</li>\n<li><p>String</p>\n<p>name =&gt; Hello world</p>\n<pre><code>name =&gt; &apos;It\\&apos;s a beautiful day&apos;</code></pre></li>\n<li><p>Comments</p>\n<h1 id=\"this-is-a-comment\"><a href=\"#this-is-a-comment\" class=\"headerlink\" title=\"this is a comment\"></a>this is a comment</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123; # comments can appear at the end of a line, too</span><br><span class=\"line\">  # ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"filter\"><a href=\"#filter\" class=\"headerlink\" title=\"filter\"></a>filter</h3><ul>\n<li><p>mutate</p>\n<p>mutate { replace =&gt; { type =&gt; file_test } }</p>\n</li>\n<li><p>grok</p>\n<blockquote>\n<p>Parses unstructured event data into fields</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grok &#123;</span><br><span class=\"line\">  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns\">patterns</a></p>\n</li>\n<li><p>date</p>\n<p>date {</p>\n<pre><code>      match =&gt; [ &quot;timestamp&quot; , &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ]\n}</code></pre></li>\n</ul>\n<ul>\n<li><p>json</p>\n<blockquote>\n<p>Parses JSON events</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"drop-example\"><a href=\"#drop-example\" class=\"headerlink\" title=\"drop example:\"></a>drop example:</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filter &#123;</span><br><span class=\"line\">\t    grok &#123;</span><br><span class=\"line\">            match =&gt; [&quot;message&quot;,&quot;%&#123;TIMESTAMP_ISO8601:logtime&#125; \\[%&#123;NUMBER&#125;\\] \\(\\(%&#123;WORD&#125;\\)\\) %&#123;WORD:loglevel&#125; %&#123;GREEDYDATA:other&#125;&quot;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    if [loglevel]!= &quot;ERROR&quot; &#123;</span><br><span class=\"line\">            drop &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"input\"><a href=\"#input\" class=\"headerlink\" title=\"input\"></a>input</h3><p><a href=\"https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html\" target=\"_blank\" rel=\"noopener\">file</a></p>\n<h3 id=\"output\"><a href=\"#output\" class=\"headerlink\" title=\"output\"></a>output</h3><h3 id=\"filter-1\"><a href=\"#filter-1\" class=\"headerlink\" title=\"filter\"></a>filter</h3><ul>\n<li><p>grok</p>\n<pre><code> \n\n   grok {\nmatch =&gt; { &quot;message&quot; =&gt; &quot;%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}&quot; }\n  }</code></pre></li>\n</ul>\n<blockquote>\n<p>Grok sits on top of regular expressions, so any regular expressions are valid in grok as well.</p>\n</blockquote>\n<p>   pattern%{IP:client} IPpattern, clientclient<br>   <a href=\"https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html#_custom_patterns\" target=\"_blank\" rel=\"noopener\">pattern</a>,pattern</p>\n  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> # contents of ./patterns/extra:</span><br><span class=\"line\">JAVA_CLASS ([a-zA-Z]+[.][a-zA-Z]+)[.]*.*</span><br></pre></td></tr></table></figure>\n\n<p>grokpatterns_dirpatterns_dir</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  grok &#123;</span><br><span class=\"line\">\t  patterns_dir =&gt; [&quot;/Users/xiaoxuez/Library/apache/logstash-5.4.2/patterns&quot;]</span><br><span class=\"line\">\t  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:timestamp&#125; %&#123;JAVA_CLASS:producer&#125; %&#123;WORD:printer&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>    </p>\n<h3 id=\"config\"><a href=\"#config\" class=\"headerlink\" title=\"config\"></a>config</h3><p> config<a href>if</a>  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filter &#123;</span><br><span class=\"line\"> \t...</span><br><span class=\"line\"> \tif ([producer] =~ /[m].*/) &#123;</span><br><span class=\"line\"> \t\t# do ..</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\t drop &#123; &#125;  # output</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>   }</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"=~  \"></a>=~  </h1><h2 id=\"EXAMPLE\"><a href=\"#EXAMPLE\" class=\"headerlink\" title=\"EXAMPLE\"></a>EXAMPLE</h2><p>file</p>\n<pre><code>path =&gt; &quot;/var/log/%{type}.%{+yyyy.MM.dd.HH}&quot;</code></pre><p>[][path]</p>\n<h1 id=\"a-zA-Z-a-zA-Z-\"><a href=\"#a-zA-Z-a-zA-Z-\" class=\"headerlink\" title=\"([a-zA-Z]+[.][a-zA-Z]+)[.].  \"></a>([a-zA-Z]+[.][a-zA-Z]+)[.]<em>.</em>  </h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">json&#123;</span><br><span class=\"line\">     source =&gt; &quot;content&quot;</span><br><span class=\"line\">     target =&gt; &quot;content&quot;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> mutate &#123;</span><br><span class=\"line\">        add_field =&gt; &#123;</span><br><span class=\"line\">          &quot;event_type&quot; =&gt; &quot;%&#123;[jsoncontent][type]&#125;&quot;</span><br><span class=\"line\">          &quot;event_msg&quot; =&gt; &quot;%&#123;[jsoncontent][event]&#125;&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     &#125;</span><br></pre></td></tr></table></figure>\n\n<p><br><br>    </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  #</span><br><span class=\"line\">if ([producer] == &quot;STUDIO&quot; ) &#123;</span><br><span class=\"line\">    mutate &#123; replace =&gt; &#123; &quot;type&quot; =&gt; &quot;System_Airguru_Log&quot; &#125; &#125;</span><br><span class=\"line\">&#125; else if ([producer] =~ /[m].*/) &#123;</span><br><span class=\"line\">    json&#123;</span><br><span class=\"line\">          source =&gt; &quot;content&quot;</span><br><span class=\"line\">          target =&gt; &quot;jsoncontent&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    mutate &#123;</span><br><span class=\"line\">      replace =&gt; &#123; &quot;type&quot; =&gt; &quot;Stratege_Airguru_Log&quot; &#125;</span><br><span class=\"line\">      add_field =&gt; &#123;</span><br></pre></td></tr></table></figure>\n\n<pre><code>                 &quot;event_type&quot; =&gt; &quot;%{[jsoncontent][type]}&quot;\n                 &quot;event_msg&quot; =&gt; &quot;%{[jsoncontent][event]}&quot;\n               }\n      }\n} else {\n  drop { }\n}        </code></pre><h3 id=\"Example\"><a href=\"#Example\" class=\"headerlink\" title=\"Example\"></a>Example</h3><h4 id=\"filter-aggregate\"><a href=\"#filter-aggregate\" class=\"headerlink\" title=\"filter-aggregate\"></a>filter-aggregate</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">  file &#123;</span><br><span class=\"line\">    path =&gt; &quot;$&#123;PROJECT&#125;/logs/**/**/worker.log&quot;</span><br><span class=\"line\">    start_position =&gt; &quot;beginning&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123;</span><br><span class=\"line\">#  if [path] =~ &quot;.log&quot; &#123;</span><br><span class=\"line\">    #</span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">\t\t\tid =&gt; &quot;storm_log_filter&quot;</span><br><span class=\"line\">      patterns_dir =&gt; [&quot;$&#123;PROJECT&#125;/patterns&quot;]</span><br><span class=\"line\">      #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;GREEDYDATA:unknow&#125;&quot; &#125;</span><br><span class=\"line\">      #match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TIMESTAMP_ISO8601:time&#125; %&#123;JAVA_CLASS:producer&#125; %&#123;WORD:printer&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class=\"line\">      match =&gt; &#123; &quot;path&quot; =&gt; &quot;.*/%&#123;WORD:topology&#125;\\-%&#123;JUST_NUMBER:order&#125;\\-%&#123;JUST_NUMBER:submittime&#125;/[0-9]+/worker.log&quot; &#125;</span><br><span class=\"line\">      break_on_match =&gt; false</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    aggregate &#123;</span><br><span class=\"line\">     task_id =&gt; &quot;%&#123;topology&#125;-%&#123;order&#125;-%&#123;submittime&#125;&quot;</span><br><span class=\"line\">     code =&gt; &quot;map[&apos;counts&apos;] ||= 0; map[&apos;counts&apos;] += 1;&quot;</span><br><span class=\"line\">     push_map_as_event_on_timeout =&gt; true</span><br><span class=\"line\">     timeout_task_id_field =&gt; &quot;topology_file&quot;</span><br><span class=\"line\">     timeout =&gt; 360 # 10 minutes timeout</span><br><span class=\"line\">     timeout_tags =&gt; [&apos;_aggregatetimeout&apos;]</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"filter-basic-grok\"><a href=\"#filter-basic-grok\" class=\"headerlink\" title=\"filter-basic-grok\"></a>filter-basic-grok</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">input &#123;</span><br><span class=\"line\">  file &#123;</span><br><span class=\"line\">    path =&gt; &quot;/Users/xiaoxuez/Library/apache/logstash-5.4.2/test/file_test_log.log&quot;</span><br><span class=\"line\">    start_position =&gt; &quot;beginning&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">filter &#123;</span><br><span class=\"line\">  if [path] =~ &quot;.log&quot; &#123;</span><br><span class=\"line\">    #</span><br><span class=\"line\">    grok &#123;</span><br><span class=\"line\">      match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;TOMCAT_DATESTAMP:time&#125; %&#123;JAVACLASS:producer&#125; %&#123;WORD&#125; %&#123;GREEDYDATA:content&#125;&quot; &#125;</span><br><span class=\"line\">      break_on_match =&gt; false</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><br><br><br></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  # if ([producer] !~ /[m].*/ or &quot;_grokparsefailure&quot; in [tags]) &#123;</span><br><span class=\"line\">    # drop &#123; &#125;</span><br><span class=\"line\">#  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  mutate &#123;</span><br><span class=\"line\">    #  remove_field =&gt; [&quot;message&quot;]</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">output &#123;</span><br><span class=\"line\">  #elasticsearch &#123;</span><br><span class=\"line\">  #  hosts =&gt; [&quot;localhost:9200&quot;]</span><br><span class=\"line\">  #&#125;</span><br><span class=\"line\">  # stdout#</span><br><span class=\"line\">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ul>\n<li><p></p>\n<p>logstash,(logstash..),{logstash}/data/plugins/inputs/file/.sincedb*</p>\n</li>\n</ul>\n"},{"title":"elastic-search-dsl","date":"2017-10-14T05:52:37.000Z","_content":"\n\n## ElasticSearch\n\n ElasticSearch() doc(5.5)\n\nboolfull-textexactmatchfull-textterm\n\n### \n\nfieldvaluematch, term, range\n\n#### match_all\n\n\n\n```\n \"query\": {\n        \"match_all\": {}\n    }\n```\n\n#### match\n\n- match\n\nvalue\n\n```\n\t// message\"this\" or \"is\" or \"a\" or \"test\"\n\t\"query\": {\n        \"match\" : {\n            \"message\" : \"this is a test\"\n        }\n    }\n```\n\n4text operatoror/andorminimum\\_should\\_matchanalyzerfuzziness/(3.3.5)\n\n- match_phrase\n\nmatch\n\n```\n//this test2\"this is a test\"\n\"query\": {\n        \"match_phrase\" : {\n            \"message\" : {\n                \"query\": \"this test\",\n                \"slop\":2\n            }\n        }\n    }\n```\n\n- match\\_phrase\\_prefix\n\nmatch\\_phrase\n\n```\n  \"query\": {\n        \"match_phrase_prefix\" : {\n            \"message\" : \"this is a t\"\n        }\n    }\n```\n\n- multi match query\n\nmatchfield\n\n```\n\t\"query\": {\n\t    \"multi_match\" : {\n\t      \"query\":    \"this is a test\",\n\t      \"fields\": [ \"subject\", \"message\" ]\n\t    }\n\t  }\n```\n\n- common terms query\n\n...\n\n- query string query\n\nLucene\n\n- simple query string query\n\nquery string query\n\n#### term\n\nterm\n\n- term query\n\n```\n//titlecrime\n \"query\": {\n    \"term\" : { \"title\" : \"crime\" }\n  }\n```\n\n- terms query\n\n\n\n```\n\"query\": {\n     \"terms\" : {\n        \"user\" : [\"kimchy\", \"elasticsearch\"]\n        }\n    }\n```\n\n#### range query\n\n\n\n```\n//age1020\n \"query\": {\n        \"range\" : {\n            \"age\" : {\n                \"gte\" : 10,\n                \"lte\" : 20\n            }\n        }\n    }\n    //gte : Greater-than or equal to\n    //gt :  Greater-than\n    //lte : Less-than or equal to\n\t//lt : Less-than\n```\n\n#### exist query\n\n,\n\n```\n \"query\": {\n        \"exists\" : { \"field\" : \"user\" }\n    }\n```\n\n#### prefix query\n\n\n\n```\n\t//userki\n\t{ \"query\": {\n\t    \"prefix\" : { \"user\" : \"ki\" }\n\t  }\n\t}\n```\n\n#### Wildcard query\n\n*?.\n\n```\n \"query\": {\n        \"wildcard\" : { \"user\" : \"ki*y\" }\n    }\n```\n\n#### regexp query\n\n\n\n#### type query\n\n```\n \"query\": {\n        \"type\" : {\n            \"value\" : \"my_type\"\n        }\n    }\n```\n\n#### ids query\n\n```\n        \"ids\" : {\n            \"type\" : \"my_type\",\n            \"values\" : [\"1\", \"4\", \"100\"]\n        }\n```\n\n#### constant score query\n\n/\n\n### \n\nbool\n\n- bool query\n\n```\n// userkimchy tagtechage1020 tagwowelasticsearch1\n \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"user\" : \"kimchy\" }\n      },\n      \"filter\": {\n        \"term\" : { \"tag\" : \"tech\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"age\" : { \"gte\" : 10, \"lte\" : 20 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"tag\" : \"wow\" } },\n        { \"term\" : { \"tag\" : \"elasticsearch\" } }\n      ],\n      \"minimum_should_match\" : 1,\n    }\n  }\n```\n\n- dis max query\n\n\n\n- function_score\n\n> The function_score allows you to modify the score of documents that are retrieved by a query.\n\n- boosting\n\n> The boosting query can be used to effectively demote results that match a given query.\n\n- indices query\n\n\n\n```\n \"query\": {\n        \"indices\" : {\n            \"indices\" : [\"index1\", \"index2\"],\n            \"query\" : { \"term\" : { \"tag\" : \"wow\" } },\n            \"no_match_query\" : { \"term\" : { \"tag\" : \"kow\" } }\n        }\n    }\n```\n\n#### script query\n\n```\n\"query\": {\n        \"bool\" : {\n            \"must\" : {\n                \"script\" : {\n                    \"script\" : {\n                        \"inline\" : \"doc['num1'].value > params.param1\",\n                        \"lang\"   : \"painless\",\n                        \"params\" : {\n                            \"param1\" : 5\n                        }\n                    }\n                }\n            }\n        }\n    }\n```\n\n#### \n\n```\n{\n    QUERY_NAME: {\n        ARGUMENT: VALUE,\n        ARGUMENT: VALUE\n    }\n}\n\n```\n\nfield\n\n```\n{\n    QUERY_NAME: {\n        FIELD_NAME: {\n            ARGUMENT: VALUE,\n            ARGUMENT: VALUE,...\n        }\n    }\n}\n\n```\n\nquery boolmatchrange\n\n```\n{\n    \"bool\": {\n        \"must\":     { \"match\": { \"tweet\": \"elasticsearch\" }},\n        \"must_not\": { \"match\": { \"name\":  \"mary\" }},\n        \"should\":   { \"match\": { \"tweet\": \"full text\" }},\n        \"filter\":   { \"range\": { \"age\" : { \"gt\" : 30 }} }\n    }\n}\n\n```\n\nbool + bool\n\n```\n{\n    \"bool\": {\n        \"must\": { \"match\":   { \"email\": \"business opportunity\" }},\n        \"should\": [\n            { \"match\":       { \"starred\": true }},\n            { \"bool\": {\n                \"must\":      { \"match\": { \"folder\": \"inbox\" }},\n                \"must_not\":  { \"match\": { \"spam\": true }}\n            }}\n        ],\n        \"minimum_should_match\": 1\n    }\n}\n\n```\n\ncurl -XGET 'localhost:9200/storm*/_analyze?field=message_infos.event.specificType' -d 'FRESH_AIR_VOLUME_LESS'\n","source":"_posts/elastic-search-dsl.md","raw":"---\ntitle: elastic-search-dsl\ndate: 2017-10-14 13:52:37\ncategories:\n- elk\n---\n\n\n## ElasticSearch\n\n ElasticSearch() doc(5.5)\n\nboolfull-textexactmatchfull-textterm\n\n### \n\nfieldvaluematch, term, range\n\n#### match_all\n\n\n\n```\n \"query\": {\n        \"match_all\": {}\n    }\n```\n\n#### match\n\n- match\n\nvalue\n\n```\n\t// message\"this\" or \"is\" or \"a\" or \"test\"\n\t\"query\": {\n        \"match\" : {\n            \"message\" : \"this is a test\"\n        }\n    }\n```\n\n4text operatoror/andorminimum\\_should\\_matchanalyzerfuzziness/(3.3.5)\n\n- match_phrase\n\nmatch\n\n```\n//this test2\"this is a test\"\n\"query\": {\n        \"match_phrase\" : {\n            \"message\" : {\n                \"query\": \"this test\",\n                \"slop\":2\n            }\n        }\n    }\n```\n\n- match\\_phrase\\_prefix\n\nmatch\\_phrase\n\n```\n  \"query\": {\n        \"match_phrase_prefix\" : {\n            \"message\" : \"this is a t\"\n        }\n    }\n```\n\n- multi match query\n\nmatchfield\n\n```\n\t\"query\": {\n\t    \"multi_match\" : {\n\t      \"query\":    \"this is a test\",\n\t      \"fields\": [ \"subject\", \"message\" ]\n\t    }\n\t  }\n```\n\n- common terms query\n\n...\n\n- query string query\n\nLucene\n\n- simple query string query\n\nquery string query\n\n#### term\n\nterm\n\n- term query\n\n```\n//titlecrime\n \"query\": {\n    \"term\" : { \"title\" : \"crime\" }\n  }\n```\n\n- terms query\n\n\n\n```\n\"query\": {\n     \"terms\" : {\n        \"user\" : [\"kimchy\", \"elasticsearch\"]\n        }\n    }\n```\n\n#### range query\n\n\n\n```\n//age1020\n \"query\": {\n        \"range\" : {\n            \"age\" : {\n                \"gte\" : 10,\n                \"lte\" : 20\n            }\n        }\n    }\n    //gte : Greater-than or equal to\n    //gt :  Greater-than\n    //lte : Less-than or equal to\n\t//lt : Less-than\n```\n\n#### exist query\n\n,\n\n```\n \"query\": {\n        \"exists\" : { \"field\" : \"user\" }\n    }\n```\n\n#### prefix query\n\n\n\n```\n\t//userki\n\t{ \"query\": {\n\t    \"prefix\" : { \"user\" : \"ki\" }\n\t  }\n\t}\n```\n\n#### Wildcard query\n\n*?.\n\n```\n \"query\": {\n        \"wildcard\" : { \"user\" : \"ki*y\" }\n    }\n```\n\n#### regexp query\n\n\n\n#### type query\n\n```\n \"query\": {\n        \"type\" : {\n            \"value\" : \"my_type\"\n        }\n    }\n```\n\n#### ids query\n\n```\n        \"ids\" : {\n            \"type\" : \"my_type\",\n            \"values\" : [\"1\", \"4\", \"100\"]\n        }\n```\n\n#### constant score query\n\n/\n\n### \n\nbool\n\n- bool query\n\n```\n// userkimchy tagtechage1020 tagwowelasticsearch1\n \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"user\" : \"kimchy\" }\n      },\n      \"filter\": {\n        \"term\" : { \"tag\" : \"tech\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"age\" : { \"gte\" : 10, \"lte\" : 20 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"tag\" : \"wow\" } },\n        { \"term\" : { \"tag\" : \"elasticsearch\" } }\n      ],\n      \"minimum_should_match\" : 1,\n    }\n  }\n```\n\n- dis max query\n\n\n\n- function_score\n\n> The function_score allows you to modify the score of documents that are retrieved by a query.\n\n- boosting\n\n> The boosting query can be used to effectively demote results that match a given query.\n\n- indices query\n\n\n\n```\n \"query\": {\n        \"indices\" : {\n            \"indices\" : [\"index1\", \"index2\"],\n            \"query\" : { \"term\" : { \"tag\" : \"wow\" } },\n            \"no_match_query\" : { \"term\" : { \"tag\" : \"kow\" } }\n        }\n    }\n```\n\n#### script query\n\n```\n\"query\": {\n        \"bool\" : {\n            \"must\" : {\n                \"script\" : {\n                    \"script\" : {\n                        \"inline\" : \"doc['num1'].value > params.param1\",\n                        \"lang\"   : \"painless\",\n                        \"params\" : {\n                            \"param1\" : 5\n                        }\n                    }\n                }\n            }\n        }\n    }\n```\n\n#### \n\n```\n{\n    QUERY_NAME: {\n        ARGUMENT: VALUE,\n        ARGUMENT: VALUE\n    }\n}\n\n```\n\nfield\n\n```\n{\n    QUERY_NAME: {\n        FIELD_NAME: {\n            ARGUMENT: VALUE,\n            ARGUMENT: VALUE,...\n        }\n    }\n}\n\n```\n\nquery boolmatchrange\n\n```\n{\n    \"bool\": {\n        \"must\":     { \"match\": { \"tweet\": \"elasticsearch\" }},\n        \"must_not\": { \"match\": { \"name\":  \"mary\" }},\n        \"should\":   { \"match\": { \"tweet\": \"full text\" }},\n        \"filter\":   { \"range\": { \"age\" : { \"gt\" : 30 }} }\n    }\n}\n\n```\n\nbool + bool\n\n```\n{\n    \"bool\": {\n        \"must\": { \"match\":   { \"email\": \"business opportunity\" }},\n        \"should\": [\n            { \"match\":       { \"starred\": true }},\n            { \"bool\": {\n                \"must\":      { \"match\": { \"folder\": \"inbox\" }},\n                \"must_not\":  { \"match\": { \"spam\": true }}\n            }}\n        ],\n        \"minimum_should_match\": 1\n    }\n}\n\n```\n\ncurl -XGET 'localhost:9200/storm*/_analyze?field=message_infos.event.specificType' -d 'FRESH_AIR_VOLUME_LESS'\n","slug":"elastic-search-dsl","published":1,"updated":"2019-10-14T06:21:32.299Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ta000ft6xvjpqm06lj","content":"<h2 id=\"ElasticSearch\"><a href=\"#ElasticSearch\" class=\"headerlink\" title=\"ElasticSearch\"></a>ElasticSearch</h2><p> ElasticSearch() doc(5.5)</p>\n<p>boolfull-textexactmatchfull-textterm</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>fieldvaluematch, term, range</p>\n<h4 id=\"match-all\"><a href=\"#match-all\" class=\"headerlink\" title=\"match_all\"></a>match_all</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"match\"><a href=\"#match\" class=\"headerlink\" title=\"match\"></a>match</h4><ul>\n<li>match</li>\n</ul>\n<p>value</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// message&quot;this&quot; or &quot;is&quot; or &quot;a&quot; or &quot;test&quot;</span><br><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;match&quot; : &#123;</span><br><span class=\"line\">           &quot;message&quot; : &quot;this is a test&quot;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p>4text operatoror/andorminimum_should_matchanalyzerfuzziness/(3.3.5)</p>\n<ul>\n<li>match_phrase</li>\n</ul>\n<p>match</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//this test2&quot;this is a test&quot;</span><br><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_phrase&quot; : &#123;</span><br><span class=\"line\">            &quot;message&quot; : &#123;</span><br><span class=\"line\">                &quot;query&quot;: &quot;this test&quot;,</span><br><span class=\"line\">                &quot;slop&quot;:2</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>match_phrase_prefix</li>\n</ul>\n<p>match_phrase</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">      &quot;match_phrase_prefix&quot; : &#123;</span><br><span class=\"line\">          &quot;message&quot; : &quot;this is a t&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>multi match query</li>\n</ul>\n<p>matchfield</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot; : &#123;</span><br><span class=\"line\">      &quot;query&quot;:    &quot;this is a test&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [ &quot;subject&quot;, &quot;message&quot; ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>common terms query</li>\n</ul>\n<p></p>\n<ul>\n<li>query string query</li>\n</ul>\n<p>Lucene</p>\n<ul>\n<li>simple query string query</li>\n</ul>\n<p>query string query</p>\n<h4 id=\"term\"><a href=\"#term\" class=\"headerlink\" title=\"term\"></a>term</h4><p>term</p>\n<ul>\n<li>term query</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//titlecrime</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot; : &#123; &quot;title&quot; : &quot;crime&quot; &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>terms query</li>\n</ul>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">     &quot;terms&quot; : &#123;</span><br><span class=\"line\">        &quot;user&quot; : [&quot;kimchy&quot;, &quot;elasticsearch&quot;]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"range-query\"><a href=\"#range-query\" class=\"headerlink\" title=\"range query\"></a>range query</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//age1020</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">            &quot;age&quot; : &#123;</span><br><span class=\"line\">                &quot;gte&quot; : 10,</span><br><span class=\"line\">                &quot;lte&quot; : 20</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //gte : Greater-than or equal to</span><br><span class=\"line\">    //gt :  Greater-than</span><br><span class=\"line\">    //lte : Less-than or equal to</span><br><span class=\"line\">\t//lt : Less-than</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"exist-query\"><a href=\"#exist-query\" class=\"headerlink\" title=\"exist query\"></a>exist query</h4><p>,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;exists&quot; : &#123; &quot;field&quot; : &quot;user&quot; &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"prefix-query\"><a href=\"#prefix-query\" class=\"headerlink\" title=\"prefix query\"></a>prefix query</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//userki</span><br><span class=\"line\">&#123; &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;prefix&quot; : &#123; &quot;user&quot; : &quot;ki&quot; &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Wildcard-query\"><a href=\"#Wildcard-query\" class=\"headerlink\" title=\"Wildcard query\"></a>Wildcard query</h4><p>*?.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;wildcard&quot; : &#123; &quot;user&quot; : &quot;ki*y&quot; &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"regexp-query\"><a href=\"#regexp-query\" class=\"headerlink\" title=\"regexp query\"></a>regexp query</h4><p></p>\n<h4 id=\"type-query\"><a href=\"#type-query\" class=\"headerlink\" title=\"type query\"></a>type query</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;type&quot; : &#123;</span><br><span class=\"line\">           &quot;value&quot; : &quot;my_type&quot;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ids-query\"><a href=\"#ids-query\" class=\"headerlink\" title=\"ids query\"></a>ids query</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;ids&quot; : &#123;</span><br><span class=\"line\">    &quot;type&quot; : &quot;my_type&quot;,</span><br><span class=\"line\">    &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"constant-score-query\"><a href=\"#constant-score-query\" class=\"headerlink\" title=\"constant score query\"></a>constant score query</h4><p>/</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>bool</p>\n<ul>\n<li>bool query</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// userkimchy tagtechage1020 tagwowelasticsearch1</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\">      &quot;must&quot; : &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;tag&quot; : &quot;tech&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;age&quot; : &#123; &quot;gte&quot; : 10, &quot;lte&quot; : 20 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot; : [</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;elasticsearch&quot; &#125; &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot; : 1,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>dis max query</li>\n</ul>\n<p></p>\n<ul>\n<li>function_score</li>\n</ul>\n<blockquote>\n<p>The function_score allows you to modify the score of documents that are retrieved by a query.</p>\n</blockquote>\n<ul>\n<li>boosting</li>\n</ul>\n<blockquote>\n<p>The boosting query can be used to effectively demote results that match a given query.</p>\n</blockquote>\n<ul>\n<li>indices query</li>\n</ul>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;indices&quot; : &#123;</span><br><span class=\"line\">           &quot;indices&quot; : [&quot;index1&quot;, &quot;index2&quot;],</span><br><span class=\"line\">           &quot;query&quot; : &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class=\"line\">           &quot;no_match_query&quot; : &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;kow&quot; &#125; &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"script-query\"><a href=\"#script-query\" class=\"headerlink\" title=\"script query\"></a>script query</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot; : &#123;</span><br><span class=\"line\">            &quot;must&quot; : &#123;</span><br><span class=\"line\">                &quot;script&quot; : &#123;</span><br><span class=\"line\">                    &quot;script&quot; : &#123;</span><br><span class=\"line\">                        &quot;inline&quot; : &quot;doc[&apos;num1&apos;].value &gt; params.param1&quot;,</span><br><span class=\"line\">                        &quot;lang&quot;   : &quot;painless&quot;,</span><br><span class=\"line\">                        &quot;params&quot; : &#123;</span><br><span class=\"line\">                            &quot;param1&quot; : 5</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    QUERY_NAME: &#123;</span><br><span class=\"line\">        ARGUMENT: VALUE,</span><br><span class=\"line\">        ARGUMENT: VALUE</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>field</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    QUERY_NAME: &#123;</span><br><span class=\"line\">        FIELD_NAME: &#123;</span><br><span class=\"line\">            ARGUMENT: VALUE,</span><br><span class=\"line\">            ARGUMENT: VALUE,...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>query boolmatchrange</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">        &quot;must&quot;:     &#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;elasticsearch&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;name&quot;:  &quot;mary&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;should&quot;:   &#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;full text&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;filter&quot;:   &#123; &quot;range&quot;: &#123; &quot;age&quot; : &#123; &quot;gt&quot; : 30 &#125;&#125; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>bool + bool</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">        &quot;must&quot;: &#123; &quot;match&quot;:   &#123; &quot;email&quot;: &quot;business opportunity&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;should&quot;: [</span><br><span class=\"line\">            &#123; &quot;match&quot;:       &#123; &quot;starred&quot;: true &#125;&#125;,</span><br><span class=\"line\">            &#123; &quot;bool&quot;: &#123;</span><br><span class=\"line\">                &quot;must&quot;:      &#123; &quot;match&quot;: &#123; &quot;folder&quot;: &quot;inbox&quot; &#125;&#125;,</span><br><span class=\"line\">                &quot;must_not&quot;:  &#123; &quot;match&quot;: &#123; &quot;spam&quot;: true &#125;&#125;</span><br><span class=\"line\">            &#125;&#125;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        &quot;minimum_should_match&quot;: 1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>curl -XGET localhost:9200/storm*/_analyze?field=message_infos.event.specificType -d FRESH_AIR_VOLUME_LESS</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"ElasticSearch\"><a href=\"#ElasticSearch\" class=\"headerlink\" title=\"ElasticSearch\"></a>ElasticSearch</h2><p> ElasticSearch() doc(5.5)</p>\n<p>boolfull-textexactmatchfull-textterm</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>fieldvaluematch, term, range</p>\n<h4 id=\"match-all\"><a href=\"#match-all\" class=\"headerlink\" title=\"match_all\"></a>match_all</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;match_all&quot;: &#123;&#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"match\"><a href=\"#match\" class=\"headerlink\" title=\"match\"></a>match</h4><ul>\n<li>match</li>\n</ul>\n<p>value</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// message&quot;this&quot; or &quot;is&quot; or &quot;a&quot; or &quot;test&quot;</span><br><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;match&quot; : &#123;</span><br><span class=\"line\">           &quot;message&quot; : &quot;this is a test&quot;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p>4text operatoror/andorminimum_should_matchanalyzerfuzziness/(3.3.5)</p>\n<ul>\n<li>match_phrase</li>\n</ul>\n<p>match</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//this test2&quot;this is a test&quot;</span><br><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;match_phrase&quot; : &#123;</span><br><span class=\"line\">            &quot;message&quot; : &#123;</span><br><span class=\"line\">                &quot;query&quot;: &quot;this test&quot;,</span><br><span class=\"line\">                &quot;slop&quot;:2</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>match_phrase_prefix</li>\n</ul>\n<p>match_phrase</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">      &quot;match_phrase_prefix&quot; : &#123;</span><br><span class=\"line\">          &quot;message&quot; : &quot;this is a t&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>multi match query</li>\n</ul>\n<p>matchfield</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;multi_match&quot; : &#123;</span><br><span class=\"line\">      &quot;query&quot;:    &quot;this is a test&quot;,</span><br><span class=\"line\">      &quot;fields&quot;: [ &quot;subject&quot;, &quot;message&quot; ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>common terms query</li>\n</ul>\n<p></p>\n<ul>\n<li>query string query</li>\n</ul>\n<p>Lucene</p>\n<ul>\n<li>simple query string query</li>\n</ul>\n<p>query string query</p>\n<h4 id=\"term\"><a href=\"#term\" class=\"headerlink\" title=\"term\"></a>term</h4><p>term</p>\n<ul>\n<li>term query</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//titlecrime</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;term&quot; : &#123; &quot;title&quot; : &quot;crime&quot; &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>terms query</li>\n</ul>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">     &quot;terms&quot; : &#123;</span><br><span class=\"line\">        &quot;user&quot; : [&quot;kimchy&quot;, &quot;elasticsearch&quot;]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"range-query\"><a href=\"#range-query\" class=\"headerlink\" title=\"range query\"></a>range query</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//age1020</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">            &quot;age&quot; : &#123;</span><br><span class=\"line\">                &quot;gte&quot; : 10,</span><br><span class=\"line\">                &quot;lte&quot; : 20</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //gte : Greater-than or equal to</span><br><span class=\"line\">    //gt :  Greater-than</span><br><span class=\"line\">    //lte : Less-than or equal to</span><br><span class=\"line\">\t//lt : Less-than</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"exist-query\"><a href=\"#exist-query\" class=\"headerlink\" title=\"exist query\"></a>exist query</h4><p>,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;exists&quot; : &#123; &quot;field&quot; : &quot;user&quot; &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"prefix-query\"><a href=\"#prefix-query\" class=\"headerlink\" title=\"prefix query\"></a>prefix query</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//userki</span><br><span class=\"line\">&#123; &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;prefix&quot; : &#123; &quot;user&quot; : &quot;ki&quot; &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Wildcard-query\"><a href=\"#Wildcard-query\" class=\"headerlink\" title=\"Wildcard query\"></a>Wildcard query</h4><p>*?.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;wildcard&quot; : &#123; &quot;user&quot; : &quot;ki*y&quot; &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"regexp-query\"><a href=\"#regexp-query\" class=\"headerlink\" title=\"regexp query\"></a>regexp query</h4><p></p>\n<h4 id=\"type-query\"><a href=\"#type-query\" class=\"headerlink\" title=\"type query\"></a>type query</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;type&quot; : &#123;</span><br><span class=\"line\">           &quot;value&quot; : &quot;my_type&quot;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ids-query\"><a href=\"#ids-query\" class=\"headerlink\" title=\"ids query\"></a>ids query</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;ids&quot; : &#123;</span><br><span class=\"line\">    &quot;type&quot; : &quot;my_type&quot;,</span><br><span class=\"line\">    &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"constant-score-query\"><a href=\"#constant-score-query\" class=\"headerlink\" title=\"constant score query\"></a>constant score query</h4><p>/</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>bool</p>\n<ul>\n<li>bool query</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// userkimchy tagtechage1020 tagwowelasticsearch1</span><br><span class=\"line\"> &quot;query&quot;: &#123;</span><br><span class=\"line\">    &quot;bool&quot; : &#123;</span><br><span class=\"line\">      &quot;must&quot; : &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;filter&quot;: &#123;</span><br><span class=\"line\">        &quot;term&quot; : &#123; &quot;tag&quot; : &quot;tech&quot; &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;must_not&quot; : &#123;</span><br><span class=\"line\">        &quot;range&quot; : &#123;</span><br><span class=\"line\">          &quot;age&quot; : &#123; &quot;gte&quot; : 10, &quot;lte&quot; : 20 &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &quot;should&quot; : [</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class=\"line\">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;elasticsearch&quot; &#125; &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      &quot;minimum_should_match&quot; : 1,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>dis max query</li>\n</ul>\n<p></p>\n<ul>\n<li>function_score</li>\n</ul>\n<blockquote>\n<p>The function_score allows you to modify the score of documents that are retrieved by a query.</p>\n</blockquote>\n<ul>\n<li>boosting</li>\n</ul>\n<blockquote>\n<p>The boosting query can be used to effectively demote results that match a given query.</p>\n</blockquote>\n<ul>\n<li>indices query</li>\n</ul>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">       &quot;indices&quot; : &#123;</span><br><span class=\"line\">           &quot;indices&quot; : [&quot;index1&quot;, &quot;index2&quot;],</span><br><span class=\"line\">           &quot;query&quot; : &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class=\"line\">           &quot;no_match_query&quot; : &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;kow&quot; &#125; &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"script-query\"><a href=\"#script-query\" class=\"headerlink\" title=\"script query\"></a>script query</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;query&quot;: &#123;</span><br><span class=\"line\">        &quot;bool&quot; : &#123;</span><br><span class=\"line\">            &quot;must&quot; : &#123;</span><br><span class=\"line\">                &quot;script&quot; : &#123;</span><br><span class=\"line\">                    &quot;script&quot; : &#123;</span><br><span class=\"line\">                        &quot;inline&quot; : &quot;doc[&apos;num1&apos;].value &gt; params.param1&quot;,</span><br><span class=\"line\">                        &quot;lang&quot;   : &quot;painless&quot;,</span><br><span class=\"line\">                        &quot;params&quot; : &#123;</span><br><span class=\"line\">                            &quot;param1&quot; : 5</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    QUERY_NAME: &#123;</span><br><span class=\"line\">        ARGUMENT: VALUE,</span><br><span class=\"line\">        ARGUMENT: VALUE</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>field</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    QUERY_NAME: &#123;</span><br><span class=\"line\">        FIELD_NAME: &#123;</span><br><span class=\"line\">            ARGUMENT: VALUE,</span><br><span class=\"line\">            ARGUMENT: VALUE,...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>query boolmatchrange</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">        &quot;must&quot;:     &#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;elasticsearch&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;name&quot;:  &quot;mary&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;should&quot;:   &#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;full text&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;filter&quot;:   &#123; &quot;range&quot;: &#123; &quot;age&quot; : &#123; &quot;gt&quot; : 30 &#125;&#125; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>bool + bool</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;bool&quot;: &#123;</span><br><span class=\"line\">        &quot;must&quot;: &#123; &quot;match&quot;:   &#123; &quot;email&quot;: &quot;business opportunity&quot; &#125;&#125;,</span><br><span class=\"line\">        &quot;should&quot;: [</span><br><span class=\"line\">            &#123; &quot;match&quot;:       &#123; &quot;starred&quot;: true &#125;&#125;,</span><br><span class=\"line\">            &#123; &quot;bool&quot;: &#123;</span><br><span class=\"line\">                &quot;must&quot;:      &#123; &quot;match&quot;: &#123; &quot;folder&quot;: &quot;inbox&quot; &#125;&#125;,</span><br><span class=\"line\">                &quot;must_not&quot;:  &#123; &quot;match&quot;: &#123; &quot;spam&quot;: true &#125;&#125;</span><br><span class=\"line\">            &#125;&#125;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        &quot;minimum_should_match&quot;: 1</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>curl -XGET localhost:9200/storm*/_analyze?field=message_infos.event.specificType -d FRESH_AIR_VOLUME_LESS</p>\n"},{"title":"elastic_template","date":"2017-10-14T05:55:58.000Z","_content":"\n## Template.json\n\n[Index Templates](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html)\n\n> Index templates allow you to define templates that will automatically be applied when new indices are created.\n\n### \n\n#### \n\n```\n{\n\t\"template\": \"nginx_elastic_stack_example\",\n\t\"settings\": {}\n\t\"mappings\": {}\n}\n```\n\n- template: template patternindex name pattern\n\n  //The settings and mappings will be applied to any index name that matches the te* pattern.\n  \"template\": \"te*\",\n\n- settings: [](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html), \n\n  \"settings\" : {\n          \"index\" : {\n              \"number_of_shards\" : 3, //5, \n              \"number_of_replicas\" : 2 //1\n\n\n  ```\n      }\n  }\n  ```\n\n     \n\n  ```\n     \"settings\" : {\n          \"index.number_of_shards\": 3\n      }\n  ```\n\n  ''\n\n- mappings: \n\n  > Mapping is the process of defining how a document, and the fields it contains, are stored and indexed.\n\n  ```\n  \"mappings\": {\n  \t\"type1\": {  //type1\n  \t}\n  }\n  ```\n\n#### Mapping \n\n> Each index has one or more mapping types, which are used to divide the documents in an index into logical groups\n\nmapping type\n\n- [Meta-fields](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html)_index, \\_type, \\_id, _source..\n- properties\n- [](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html)dynamic_templatesanalyzer..\n\nField\n\n- textkeyworddatelongdoublebooleanip..keywordtextindex explicitindex full text content\n- [nested](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)\n- [geo_point](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html)[geo_shape](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html) [completion](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html)\n\n\n\n##### Dynamic Mapping\n\nmapping,fields essearchdynamic mappingdynamic mapping\\_default\\_mapping Dynamic field mappingsDynamic templates[](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html)\n\n- \\_default\\_mapping:\n\n  > The default mapping, which will be used as the base mapping for any new mapping types, can be customised by adding a mapping type with the name \\_default_ to an index\n\n  \n\n  ```\n  \"mappings\": {\n      \"_default_\": {  \n        \"_all\": {\n          \"enabled\": false\n        }\n      },\n      \"user\": {}, //user_default_\n      \"blogpost\": {  //blogpost_default_\"_all\"\n        \"_all\": {\n          \"enabled\": true\n        }\n      }\n    }\n  ```\n\n- Dynamic field mappings: fieldesfielddisableenabledesfieldjsonesstring-->textkeyworddate[](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html)\n\n- [Dynamic templates](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html#dynamic-templates): esfielddynamic templates..match\\_mapping\\_typefield name(a.b.*)mappingfield\n\n### \n\n.. ..\n\n#### Mapping\n\n- fields: textkeyword\n\n  \"city\": {\n            \"type\": \"text\",\n            \"fields\": {\n              \"raw\": {\n                \"type\":  \"keyword\"\n              }\n            }\n          }\n\n\n  ```\n  //city,city.raw,\n   \"aggs\": {\n      \"Cities\": {\n        \"terms\": {\n          \"field\": \"city.raw\"\n        }\n      }\n    }\n  ```\n\n- norms: scorefalsefilteraggregation\n\n> Norms store various normalization factors that are later used at query time in order to compute the score of a document relatively to a query.\n\n- index: fieldvalueindexanalyzed(default, treat as full-text field), not_analyzed (treat as keyword field), no\n- ignore\\_above: Strings longer than the ignore_above setting will not be indexed or stored.\n- \\_all: values\\_all[\"..\", \"..\"],\n- dynamic\n","source":"_posts/elastic-template.md","raw":"---\ntitle: elastic_template\ndate: 2017-10-14 13:55:58\ncategories:\n- elk\n---\n\n## Template.json\n\n[Index Templates](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html)\n\n> Index templates allow you to define templates that will automatically be applied when new indices are created.\n\n### \n\n#### \n\n```\n{\n\t\"template\": \"nginx_elastic_stack_example\",\n\t\"settings\": {}\n\t\"mappings\": {}\n}\n```\n\n- template: template patternindex name pattern\n\n  //The settings and mappings will be applied to any index name that matches the te* pattern.\n  \"template\": \"te*\",\n\n- settings: [](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html), \n\n  \"settings\" : {\n          \"index\" : {\n              \"number_of_shards\" : 3, //5, \n              \"number_of_replicas\" : 2 //1\n\n\n  ```\n      }\n  }\n  ```\n\n     \n\n  ```\n     \"settings\" : {\n          \"index.number_of_shards\": 3\n      }\n  ```\n\n  ''\n\n- mappings: \n\n  > Mapping is the process of defining how a document, and the fields it contains, are stored and indexed.\n\n  ```\n  \"mappings\": {\n  \t\"type1\": {  //type1\n  \t}\n  }\n  ```\n\n#### Mapping \n\n> Each index has one or more mapping types, which are used to divide the documents in an index into logical groups\n\nmapping type\n\n- [Meta-fields](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html)_index, \\_type, \\_id, _source..\n- properties\n- [](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html)dynamic_templatesanalyzer..\n\nField\n\n- textkeyworddatelongdoublebooleanip..keywordtextindex explicitindex full text content\n- [nested](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)\n- [geo_point](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html)[geo_shape](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html) [completion](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html)\n\n\n\n##### Dynamic Mapping\n\nmapping,fields essearchdynamic mappingdynamic mapping\\_default\\_mapping Dynamic field mappingsDynamic templates[](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html)\n\n- \\_default\\_mapping:\n\n  > The default mapping, which will be used as the base mapping for any new mapping types, can be customised by adding a mapping type with the name \\_default_ to an index\n\n  \n\n  ```\n  \"mappings\": {\n      \"_default_\": {  \n        \"_all\": {\n          \"enabled\": false\n        }\n      },\n      \"user\": {}, //user_default_\n      \"blogpost\": {  //blogpost_default_\"_all\"\n        \"_all\": {\n          \"enabled\": true\n        }\n      }\n    }\n  ```\n\n- Dynamic field mappings: fieldesfielddisableenabledesfieldjsonesstring-->textkeyworddate[](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html)\n\n- [Dynamic templates](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html#dynamic-templates): esfielddynamic templates..match\\_mapping\\_typefield name(a.b.*)mappingfield\n\n### \n\n.. ..\n\n#### Mapping\n\n- fields: textkeyword\n\n  \"city\": {\n            \"type\": \"text\",\n            \"fields\": {\n              \"raw\": {\n                \"type\":  \"keyword\"\n              }\n            }\n          }\n\n\n  ```\n  //city,city.raw,\n   \"aggs\": {\n      \"Cities\": {\n        \"terms\": {\n          \"field\": \"city.raw\"\n        }\n      }\n    }\n  ```\n\n- norms: scorefalsefilteraggregation\n\n> Norms store various normalization factors that are later used at query time in order to compute the score of a document relatively to a query.\n\n- index: fieldvalueindexanalyzed(default, treat as full-text field), not_analyzed (treat as keyword field), no\n- ignore\\_above: Strings longer than the ignore_above setting will not be indexed or stored.\n- \\_all: values\\_all[\"..\", \"..\"],\n- dynamic\n","slug":"elastic-template","published":1,"updated":"2019-10-15T02:00:58.965Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69td000it6xvndl9kj9z","content":"<h2 id=\"Template-json\"><a href=\"#Template-json\" class=\"headerlink\" title=\"Template.json\"></a>Template.json</h2><p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html\" target=\"_blank\" rel=\"noopener\">Index Templates</a></p>\n<blockquote>\n<p>Index templates allow you to define templates that will automatically be applied when new indices are created.</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t&quot;template&quot;: &quot;nginx_elastic_stack_example&quot;,</span><br><span class=\"line\">\t&quot;settings&quot;: &#123;&#125;</span><br><span class=\"line\">\t&quot;mappings&quot;: &#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>template: template patternindex name pattern</p>\n<p>//The settings and mappings will be applied to any index name that matches the te* pattern.<br>template: te*,</p>\n</li>\n<li><p>settings: <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html\" target=\"_blank\" rel=\"noopener\"></a>, </p>\n<p>settings : {</p>\n<pre><code>&quot;index&quot; : {\n    &quot;number_of_shards&quot; : 3, //5, \n    &quot;number_of_replicas&quot; : 2 //1</code></pre></li>\n</ul>\n  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<pre><code></code></pre>  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;settings&quot; : &#123;</span><br><span class=\"line\">     &quot;index.number_of_shards&quot;: 3</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>  </p>\n<ul>\n<li><p>mappings: </p>\n<blockquote>\n<p>Mapping is the process of defining how a document, and the fields it contains, are stored and indexed.</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;mappings&quot;: &#123;</span><br><span class=\"line\">\t&quot;type1&quot;: &#123;  //type1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Mapping-\"><a href=\"#Mapping-\" class=\"headerlink\" title=\"Mapping \"></a>Mapping </h4><blockquote>\n<p>Each index has one or more mapping types, which are used to divide the documents in an index into logical groups</p>\n</blockquote>\n<p>mapping type</p>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html\" target=\"_blank\" rel=\"noopener\">Meta-fields</a>_index, _type, _id, _source..</li>\n<li>properties</li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html\" target=\"_blank\" rel=\"noopener\"></a>dynamic_templatesanalyzer..</li>\n</ul>\n<p>Field</p>\n<ul>\n<li>textkeyworddatelongdoublebooleanip..keywordtextindex explicitindex full text content</li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html\" target=\"_blank\" rel=\"noopener\">nested</a></li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html\" target=\"_blank\" rel=\"noopener\">geo_point</a><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html\" target=\"_blank\" rel=\"noopener\">geo_shape</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html\" target=\"_blank\" rel=\"noopener\">completion</a></li>\n</ul>\n<h5 id=\"Dynamic-Mapping\"><a href=\"#Dynamic-Mapping\" class=\"headerlink\" title=\"Dynamic Mapping\"></a>Dynamic Mapping</h5><p>mapping,fields essearchdynamic mappingdynamic mapping_default_mapping Dynamic field mappingsDynamic templates<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li><p>_default_mapping:</p>\n<blockquote>\n<p>The default mapping, which will be used as the base mapping for any new mapping types, can be customised by adding a mapping type with the name _default_ to an index</p>\n</blockquote>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;_default_&quot;: &#123;  </span><br><span class=\"line\">      &quot;_all&quot;: &#123;</span><br><span class=\"line\">        &quot;enabled&quot;: false</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;user&quot;: &#123;&#125;, //user_default_</span><br><span class=\"line\">    &quot;blogpost&quot;: &#123;  //blogpost_default_&quot;_all&quot;</span><br><span class=\"line\">      &quot;_all&quot;: &#123;</span><br><span class=\"line\">        &quot;enabled&quot;: true</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Dynamic field mappings: fieldesfielddisableenabledesfieldjsonesstring&gt;textkeyworddate<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n</li>\n<li><p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html#dynamic-templates\" target=\"_blank\" rel=\"noopener\">Dynamic templates</a>: esfielddynamic templates..match_mapping_typefield name(a.b.*)mappingfield</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>.. ..</p>\n<h4 id=\"Mapping\"><a href=\"#Mapping\" class=\"headerlink\" title=\"Mapping\"></a>Mapping</h4><ul>\n<li><p>fields: textkeyword</p>\n<p>city: {</p>\n<pre><code>  &quot;type&quot;: &quot;text&quot;,\n  &quot;fields&quot;: {\n    &quot;raw&quot;: {\n      &quot;type&quot;:  &quot;keyword&quot;\n    }\n  }\n}</code></pre></li>\n</ul>\n  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//city,city.raw,</span><br><span class=\"line\"> &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;Cities&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;city.raw&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>norms: scorefalsefilteraggregation</li>\n</ul>\n<blockquote>\n<p>Norms store various normalization factors that are later used at query time in order to compute the score of a document relatively to a query.</p>\n</blockquote>\n<ul>\n<li>index: fieldvalueindexanalyzed(default, treat as full-text field), not_analyzed (treat as keyword field), no</li>\n<li>ignore_above: Strings longer than the ignore_above setting will not be indexed or stored.</li>\n<li>_all: values_all[.., ..],</li>\n<li>dynamic</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Template-json\"><a href=\"#Template-json\" class=\"headerlink\" title=\"Template.json\"></a>Template.json</h2><p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html\" target=\"_blank\" rel=\"noopener\">Index Templates</a></p>\n<blockquote>\n<p>Index templates allow you to define templates that will automatically be applied when new indices are created.</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t&quot;template&quot;: &quot;nginx_elastic_stack_example&quot;,</span><br><span class=\"line\">\t&quot;settings&quot;: &#123;&#125;</span><br><span class=\"line\">\t&quot;mappings&quot;: &#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>template: template patternindex name pattern</p>\n<p>//The settings and mappings will be applied to any index name that matches the te* pattern.<br>template: te*,</p>\n</li>\n<li><p>settings: <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules.html\" target=\"_blank\" rel=\"noopener\"></a>, </p>\n<p>settings : {</p>\n<pre><code>&quot;index&quot; : {\n    &quot;number_of_shards&quot; : 3, //5, \n    &quot;number_of_replicas&quot; : 2 //1</code></pre></li>\n</ul>\n  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<pre><code></code></pre>  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;settings&quot; : &#123;</span><br><span class=\"line\">     &quot;index.number_of_shards&quot;: 3</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>  </p>\n<ul>\n<li><p>mappings: </p>\n<blockquote>\n<p>Mapping is the process of defining how a document, and the fields it contains, are stored and indexed.</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;mappings&quot;: &#123;</span><br><span class=\"line\">\t&quot;type1&quot;: &#123;  //type1</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Mapping-\"><a href=\"#Mapping-\" class=\"headerlink\" title=\"Mapping \"></a>Mapping </h4><blockquote>\n<p>Each index has one or more mapping types, which are used to divide the documents in an index into logical groups</p>\n</blockquote>\n<p>mapping type</p>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html\" target=\"_blank\" rel=\"noopener\">Meta-fields</a>_index, _type, _id, _source..</li>\n<li>properties</li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html\" target=\"_blank\" rel=\"noopener\"></a>dynamic_templatesanalyzer..</li>\n</ul>\n<p>Field</p>\n<ul>\n<li>textkeyworddatelongdoublebooleanip..keywordtextindex explicitindex full text content</li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html\" target=\"_blank\" rel=\"noopener\">nested</a></li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html\" target=\"_blank\" rel=\"noopener\">geo_point</a><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html\" target=\"_blank\" rel=\"noopener\">geo_shape</a> <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html\" target=\"_blank\" rel=\"noopener\">completion</a></li>\n</ul>\n<h5 id=\"Dynamic-Mapping\"><a href=\"#Dynamic-Mapping\" class=\"headerlink\" title=\"Dynamic Mapping\"></a>Dynamic Mapping</h5><p>mapping,fields essearchdynamic mappingdynamic mapping_default_mapping Dynamic field mappingsDynamic templates<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li><p>_default_mapping:</p>\n<blockquote>\n<p>The default mapping, which will be used as the base mapping for any new mapping types, can be customised by adding a mapping type with the name _default_ to an index</p>\n</blockquote>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;mappings&quot;: &#123;</span><br><span class=\"line\">    &quot;_default_&quot;: &#123;  </span><br><span class=\"line\">      &quot;_all&quot;: &#123;</span><br><span class=\"line\">        &quot;enabled&quot;: false</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &quot;user&quot;: &#123;&#125;, //user_default_</span><br><span class=\"line\">    &quot;blogpost&quot;: &#123;  //blogpost_default_&quot;_all&quot;</span><br><span class=\"line\">      &quot;_all&quot;: &#123;</span><br><span class=\"line\">        &quot;enabled&quot;: true</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Dynamic field mappings: fieldesfielddisableenabledesfieldjsonesstring&gt;textkeyworddate<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n</li>\n<li><p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html#dynamic-templates\" target=\"_blank\" rel=\"noopener\">Dynamic templates</a>: esfielddynamic templates..match_mapping_typefield name(a.b.*)mappingfield</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>.. ..</p>\n<h4 id=\"Mapping\"><a href=\"#Mapping\" class=\"headerlink\" title=\"Mapping\"></a>Mapping</h4><ul>\n<li><p>fields: textkeyword</p>\n<p>city: {</p>\n<pre><code>  &quot;type&quot;: &quot;text&quot;,\n  &quot;fields&quot;: {\n    &quot;raw&quot;: {\n      &quot;type&quot;:  &quot;keyword&quot;\n    }\n  }\n}</code></pre></li>\n</ul>\n  <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//city,city.raw,</span><br><span class=\"line\"> &quot;aggs&quot;: &#123;</span><br><span class=\"line\">    &quot;Cities&quot;: &#123;</span><br><span class=\"line\">      &quot;terms&quot;: &#123;</span><br><span class=\"line\">        &quot;field&quot;: &quot;city.raw&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>norms: scorefalsefilteraggregation</li>\n</ul>\n<blockquote>\n<p>Norms store various normalization factors that are later used at query time in order to compute the score of a document relatively to a query.</p>\n</blockquote>\n<ul>\n<li>index: fieldvalueindexanalyzed(default, treat as full-text field), not_analyzed (treat as keyword field), no</li>\n<li>ignore_above: Strings longer than the ignore_above setting will not be indexed or stored.</li>\n<li>_all: values_all[.., ..],</li>\n<li>dynamic</li>\n</ul>\n"},{"title":"elastic","date":"2017-10-14T05:59:47.000Z","_content":"\n## Elasticsearch - v5.6\n\nElasticsearchLuceneLucene\n\n### \n\n- Cluster,\n\n- Node,\n\n  cluster.name\n\n- Index,\n\n- Type,\n\n- Document,\n\n- Shards/Replicas /\n\n   ,(+)    \n   ()    \n   \n\n### \n\n- \n\n  \n\n- analyze\n\n  LuceneLucene\n\n- mapping\n\n  ,,\n\n### curl\n\n- \n\n  ```\n  //\n  curl -XGET 'localhost:9200/_cat/health?v&pretty'\n\n  //\n  curl -XGET 'localhost:9200/_cat/nodes?v&pretty'\n  ```\n\n- \n\n  ```\n  //\n  curl -XGET 'localhost:9200/_cat/indices?v&pretty'\n  //\n  curl -XPUT 'localhost:9200/customer?pretty&pretty'\n  //\n  curl -XDELETE 'localhost:9200/customer?pretty&pretty'\n  //idPUT(/customer/external/2)POST\n  curl -XPOST 'localhost:9200/customer/external?pretty&pretty' -H 'Content-Type: application/json' -d'\n  {\n    \"name\": \"Jane Doe\"\n  }'\n\n  ```\n\n\n\n- \n\n  ```\n  //_search\n  curl -XGET 'localhost:9200/bank/_search?pretty' -H 'Content-Type: application/json' -d'\n  {\n  \"query\": { \"match_all\": {} }\n  }\n  '\n  ```\n\n  apidsl\n\n- analyze \n\n  ```\n  // uri/_analyze,type\n  GET /test/_analyze?pretty\n  {\n    \"field\": \"analyze.my_text\",\n    \"text\":  \"John Smith\"\n  }\n  ```\n\n### \n\n- /\n\n```\n \tPOST /storm_2017-10-31/_close\n \tcurl -XPOST 'localhost:9200/storm_2017-10-31/_close'\n \tcurl -XPOST 'localhost:9200/storm_2017-10-31/_open'\n```\n\n- \n\n```\n \tDELETE /index_name\n \tcurl -XDELETE 'localhost:9200/index_name?pretty&pretty'\n\n```\n\n- , 0\n\n```\n \tcurl -XPUT 'localhost:9200/<index_name>/_settings' -d '{\"number_of_replicas\": 0}'\n\n```\n\n\n\n#### \n\n```\n\t{\n  \"query\":{\n    \"bool\":{\n      \"must\":{\"match_all\":{}},\n      \"filter\":[\n        {\"term\":{\"op\": 25677}},\n        {\"term\":{\"parsed\":true}},\n        {\"term\": {\"device_addr\": 53784}},\n        {\"term\": {\"cmd.data.index\": 0}},\n        {\"range\":{\n          \"@timestamp\":{\n            \"from\":\"2017-12-14T07:00:53.000+00:00\",\n            \"to\":\"2017-12-14T10:41:53.000+00:00\"\n            }}\n        }\n      ]\n    }\n  },\n  \"script_fields\": {\n    \"gm_data_0\": {\n      \"script\": \"if(doc['op'].value == 25677 && params['_source']['cmd']['data'] != null) { for(def item : params['_source']['cmd']['data']) { if(item.index == 0)  return item.data_value;  }} return null;\"\n    }\n  },\n  \"size\":50,\n  \"from\":0,\n  \"sort\":{\"@timestamp\":\"desc\"},\n  \"timeout\":\"51s\"\n}\n```\n\n### \n\n#### yellow\n\n[](https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/)\n\n- \n\n```\ncurl -XGET localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason| grep UNASSIGNED\n```\n\n- \n\n```\ncurl -s 'localhost:9200/_cat/allocation?v'\n```\n\n- \n\n```\n    curl -XPUT 'localhost:9200/_cluster/settings' -d\n                      '{\n                               \"transient\": {\n                                 \"cluster.routing.allocation.disk.watermark.low\": \"90%\"\n                                    }\n                           }'\n```\n\n- \n\nESjvmjava,OOM,gcES32GESLucene\n\nLuceneOOM\n\nGCESKibana(Status Red)\n\nKibanaStatus Red\n\n,swappingLinuxswapping()ESswapping\n","source":"_posts/elastic.md","raw":"---\ntitle: elastic\ndate: 2017-10-14 13:59:47\ncategories:\n- elk\n---\n\n## Elasticsearch - v5.6\n\nElasticsearchLuceneLucene\n\n### \n\n- Cluster,\n\n- Node,\n\n  cluster.name\n\n- Index,\n\n- Type,\n\n- Document,\n\n- Shards/Replicas /\n\n   ,(+)    \n   ()    \n   \n\n### \n\n- \n\n  \n\n- analyze\n\n  LuceneLucene\n\n- mapping\n\n  ,,\n\n### curl\n\n- \n\n  ```\n  //\n  curl -XGET 'localhost:9200/_cat/health?v&pretty'\n\n  //\n  curl -XGET 'localhost:9200/_cat/nodes?v&pretty'\n  ```\n\n- \n\n  ```\n  //\n  curl -XGET 'localhost:9200/_cat/indices?v&pretty'\n  //\n  curl -XPUT 'localhost:9200/customer?pretty&pretty'\n  //\n  curl -XDELETE 'localhost:9200/customer?pretty&pretty'\n  //idPUT(/customer/external/2)POST\n  curl -XPOST 'localhost:9200/customer/external?pretty&pretty' -H 'Content-Type: application/json' -d'\n  {\n    \"name\": \"Jane Doe\"\n  }'\n\n  ```\n\n\n\n- \n\n  ```\n  //_search\n  curl -XGET 'localhost:9200/bank/_search?pretty' -H 'Content-Type: application/json' -d'\n  {\n  \"query\": { \"match_all\": {} }\n  }\n  '\n  ```\n\n  apidsl\n\n- analyze \n\n  ```\n  // uri/_analyze,type\n  GET /test/_analyze?pretty\n  {\n    \"field\": \"analyze.my_text\",\n    \"text\":  \"John Smith\"\n  }\n  ```\n\n### \n\n- /\n\n```\n \tPOST /storm_2017-10-31/_close\n \tcurl -XPOST 'localhost:9200/storm_2017-10-31/_close'\n \tcurl -XPOST 'localhost:9200/storm_2017-10-31/_open'\n```\n\n- \n\n```\n \tDELETE /index_name\n \tcurl -XDELETE 'localhost:9200/index_name?pretty&pretty'\n\n```\n\n- , 0\n\n```\n \tcurl -XPUT 'localhost:9200/<index_name>/_settings' -d '{\"number_of_replicas\": 0}'\n\n```\n\n\n\n#### \n\n```\n\t{\n  \"query\":{\n    \"bool\":{\n      \"must\":{\"match_all\":{}},\n      \"filter\":[\n        {\"term\":{\"op\": 25677}},\n        {\"term\":{\"parsed\":true}},\n        {\"term\": {\"device_addr\": 53784}},\n        {\"term\": {\"cmd.data.index\": 0}},\n        {\"range\":{\n          \"@timestamp\":{\n            \"from\":\"2017-12-14T07:00:53.000+00:00\",\n            \"to\":\"2017-12-14T10:41:53.000+00:00\"\n            }}\n        }\n      ]\n    }\n  },\n  \"script_fields\": {\n    \"gm_data_0\": {\n      \"script\": \"if(doc['op'].value == 25677 && params['_source']['cmd']['data'] != null) { for(def item : params['_source']['cmd']['data']) { if(item.index == 0)  return item.data_value;  }} return null;\"\n    }\n  },\n  \"size\":50,\n  \"from\":0,\n  \"sort\":{\"@timestamp\":\"desc\"},\n  \"timeout\":\"51s\"\n}\n```\n\n### \n\n#### yellow\n\n[](https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/)\n\n- \n\n```\ncurl -XGET localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason| grep UNASSIGNED\n```\n\n- \n\n```\ncurl -s 'localhost:9200/_cat/allocation?v'\n```\n\n- \n\n```\n    curl -XPUT 'localhost:9200/_cluster/settings' -d\n                      '{\n                               \"transient\": {\n                                 \"cluster.routing.allocation.disk.watermark.low\": \"90%\"\n                                    }\n                           }'\n```\n\n- \n\nESjvmjava,OOM,gcES32GESLucene\n\nLuceneOOM\n\nGCESKibana(Status Red)\n\nKibanaStatus Red\n\n,swappingLinuxswapping()ESswapping\n","slug":"elastic","published":1,"updated":"2019-10-14T06:21:40.972Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69tf000jt6xv8e6xhjer","content":"<h2 id=\"Elasticsearch-v5-6\"><a href=\"#Elasticsearch-v5-6\" class=\"headerlink\" title=\"Elasticsearch - v5.6\"></a>Elasticsearch - v5.6</h2><p>ElasticsearchLuceneLucene</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>Cluster,</p>\n</li>\n<li><p>Node,</p>\n<p>cluster.name</p>\n</li>\n<li><p>Index,</p>\n</li>\n<li><p>Type,</p>\n</li>\n<li><p>Document,</p>\n</li>\n<li><p>Shards/Replicas /</p>\n<p> ,(+)<br> ()<br> </p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p></p>\n<p></p>\n</li>\n<li><p>analyze</p>\n<p>LuceneLucene</p>\n</li>\n<li><p>mapping</p>\n<p>,,</p>\n</li>\n</ul>\n<h3 id=\"curl\"><a href=\"#curl\" class=\"headerlink\" title=\"curl\"></a>curl</h3><ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/_cat/health?v&amp;pretty&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/_cat/nodes?v&amp;pretty&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/_cat/indices?v&amp;pretty&apos;</span><br><span class=\"line\">//</span><br><span class=\"line\">curl -XPUT &apos;localhost:9200/customer?pretty&amp;pretty&apos;</span><br><span class=\"line\">//</span><br><span class=\"line\">curl -XDELETE &apos;localhost:9200/customer?pretty&amp;pretty&apos;</span><br><span class=\"line\">//idPUT(/customer/external/2)POST</span><br><span class=\"line\">curl -XPOST &apos;localhost:9200/customer/external?pretty&amp;pretty&apos; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;: &quot;Jane Doe&quot;</span><br><span class=\"line\">&#125;&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//_search</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/bank/_search?pretty&apos; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&apos;</span><br></pre></td></tr></table></figure>\n\n<p>apidsl</p>\n</li>\n<li><p>analyze </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// uri/_analyze,type</span><br><span class=\"line\">GET /test/_analyze?pretty</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;field&quot;: &quot;analyze.my_text&quot;,</span><br><span class=\"line\">  &quot;text&quot;:  &quot;John Smith&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>/</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /storm_2017-10-31/_close</span><br><span class=\"line\">curl -XPOST &apos;localhost:9200/storm_2017-10-31/_close&apos;</span><br><span class=\"line\">curl -XPOST &apos;localhost:9200/storm_2017-10-31/_open&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /index_name</span><br><span class=\"line\">curl -XDELETE &apos;localhost:9200/index_name?pretty&amp;pretty&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>, 0</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT &apos;localhost:9200/&lt;index_name&gt;/_settings&apos; -d &apos;&#123;&quot;number_of_replicas&quot;: 0&#125;&apos;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t&#123;</span><br><span class=\"line\">  &quot;query&quot;:&#123;</span><br><span class=\"line\">    &quot;bool&quot;:&#123;</span><br><span class=\"line\">      &quot;must&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;,</span><br><span class=\"line\">      &quot;filter&quot;:[</span><br><span class=\"line\">        &#123;&quot;term&quot;:&#123;&quot;op&quot;: 25677&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;:&#123;&quot;parsed&quot;:true&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;device_addr&quot;: 53784&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;cmd.data.index&quot;: 0&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;range&quot;:&#123;</span><br><span class=\"line\">          &quot;@timestamp&quot;:&#123;</span><br><span class=\"line\">            &quot;from&quot;:&quot;2017-12-14T07:00:53.000+00:00&quot;,</span><br><span class=\"line\">            &quot;to&quot;:&quot;2017-12-14T10:41:53.000+00:00&quot;</span><br><span class=\"line\">            &#125;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;script_fields&quot;: &#123;</span><br><span class=\"line\">    &quot;gm_data_0&quot;: &#123;</span><br><span class=\"line\">      &quot;script&quot;: &quot;if(doc[&apos;op&apos;].value == 25677 &amp;&amp; params[&apos;_source&apos;][&apos;cmd&apos;][&apos;data&apos;] != null) &#123; for(def item : params[&apos;_source&apos;][&apos;cmd&apos;][&apos;data&apos;]) &#123; if(item.index == 0)  return item.data_value;  &#125;&#125; return null;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;size&quot;:50,</span><br><span class=\"line\">  &quot;from&quot;:0,</span><br><span class=\"line\">  &quot;sort&quot;:&#123;&quot;@timestamp&quot;:&quot;desc&quot;&#125;,</span><br><span class=\"line\">  &quot;timeout&quot;:&quot;51s&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"yellow\"><a href=\"#yellow\" class=\"headerlink\" title=\"yellow\"></a>yellow</h4><p><a href=\"https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XGET localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason| grep UNASSIGNED</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -s &apos;localhost:9200/_cat/allocation?v&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT &apos;localhost:9200/_cluster/settings&apos; -d</span><br><span class=\"line\">                  &apos;&#123;</span><br><span class=\"line\">                           &quot;transient&quot;: &#123;</span><br><span class=\"line\">                             &quot;cluster.routing.allocation.disk.watermark.low&quot;: &quot;90%&quot;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                       &#125;&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<p>ESjvmjava,OOM,gcES32GESLucene</p>\n<p>LuceneOOM</p>\n<p>GCESKibana(Status Red)</p>\n<p>KibanaStatus Red</p>\n<p>,swappingLinuxswapping()ESswapping</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Elasticsearch-v5-6\"><a href=\"#Elasticsearch-v5-6\" class=\"headerlink\" title=\"Elasticsearch - v5.6\"></a>Elasticsearch - v5.6</h2><p>ElasticsearchLuceneLucene</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>Cluster,</p>\n</li>\n<li><p>Node,</p>\n<p>cluster.name</p>\n</li>\n<li><p>Index,</p>\n</li>\n<li><p>Type,</p>\n</li>\n<li><p>Document,</p>\n</li>\n<li><p>Shards/Replicas /</p>\n<p> ,(+)<br> ()<br> </p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p></p>\n<p></p>\n</li>\n<li><p>analyze</p>\n<p>LuceneLucene</p>\n</li>\n<li><p>mapping</p>\n<p>,,</p>\n</li>\n</ul>\n<h3 id=\"curl\"><a href=\"#curl\" class=\"headerlink\" title=\"curl\"></a>curl</h3><ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/_cat/health?v&amp;pretty&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/_cat/nodes?v&amp;pretty&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/_cat/indices?v&amp;pretty&apos;</span><br><span class=\"line\">//</span><br><span class=\"line\">curl -XPUT &apos;localhost:9200/customer?pretty&amp;pretty&apos;</span><br><span class=\"line\">//</span><br><span class=\"line\">curl -XDELETE &apos;localhost:9200/customer?pretty&amp;pretty&apos;</span><br><span class=\"line\">//idPUT(/customer/external/2)POST</span><br><span class=\"line\">curl -XPOST &apos;localhost:9200/customer/external?pretty&amp;pretty&apos; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;: &quot;Jane Doe&quot;</span><br><span class=\"line\">&#125;&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//_search</span><br><span class=\"line\">curl -XGET &apos;localhost:9200/bank/_search?pretty&apos; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&apos;</span><br></pre></td></tr></table></figure>\n\n<p>apidsl</p>\n</li>\n<li><p>analyze </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// uri/_analyze,type</span><br><span class=\"line\">GET /test/_analyze?pretty</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;field&quot;: &quot;analyze.my_text&quot;,</span><br><span class=\"line\">  &quot;text&quot;:  &quot;John Smith&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li>/</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /storm_2017-10-31/_close</span><br><span class=\"line\">curl -XPOST &apos;localhost:9200/storm_2017-10-31/_close&apos;</span><br><span class=\"line\">curl -XPOST &apos;localhost:9200/storm_2017-10-31/_open&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE /index_name</span><br><span class=\"line\">curl -XDELETE &apos;localhost:9200/index_name?pretty&amp;pretty&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>, 0</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT &apos;localhost:9200/&lt;index_name&gt;/_settings&apos; -d &apos;&#123;&quot;number_of_replicas&quot;: 0&#125;&apos;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t&#123;</span><br><span class=\"line\">  &quot;query&quot;:&#123;</span><br><span class=\"line\">    &quot;bool&quot;:&#123;</span><br><span class=\"line\">      &quot;must&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;,</span><br><span class=\"line\">      &quot;filter&quot;:[</span><br><span class=\"line\">        &#123;&quot;term&quot;:&#123;&quot;op&quot;: 25677&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;:&#123;&quot;parsed&quot;:true&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;device_addr&quot;: 53784&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;term&quot;: &#123;&quot;cmd.data.index&quot;: 0&#125;&#125;,</span><br><span class=\"line\">        &#123;&quot;range&quot;:&#123;</span><br><span class=\"line\">          &quot;@timestamp&quot;:&#123;</span><br><span class=\"line\">            &quot;from&quot;:&quot;2017-12-14T07:00:53.000+00:00&quot;,</span><br><span class=\"line\">            &quot;to&quot;:&quot;2017-12-14T10:41:53.000+00:00&quot;</span><br><span class=\"line\">            &#125;&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;script_fields&quot;: &#123;</span><br><span class=\"line\">    &quot;gm_data_0&quot;: &#123;</span><br><span class=\"line\">      &quot;script&quot;: &quot;if(doc[&apos;op&apos;].value == 25677 &amp;&amp; params[&apos;_source&apos;][&apos;cmd&apos;][&apos;data&apos;] != null) &#123; for(def item : params[&apos;_source&apos;][&apos;cmd&apos;][&apos;data&apos;]) &#123; if(item.index == 0)  return item.data_value;  &#125;&#125; return null;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;size&quot;:50,</span><br><span class=\"line\">  &quot;from&quot;:0,</span><br><span class=\"line\">  &quot;sort&quot;:&#123;&quot;@timestamp&quot;:&quot;desc&quot;&#125;,</span><br><span class=\"line\">  &quot;timeout&quot;:&quot;51s&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h4 id=\"yellow\"><a href=\"#yellow\" class=\"headerlink\" title=\"yellow\"></a>yellow</h4><p><a href=\"https://www.datadoghq.com/blog/elasticsearch-unassigned-shards/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XGET localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason| grep UNASSIGNED</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -s &apos;localhost:9200/_cat/allocation?v&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -XPUT &apos;localhost:9200/_cluster/settings&apos; -d</span><br><span class=\"line\">                  &apos;&#123;</span><br><span class=\"line\">                           &quot;transient&quot;: &#123;</span><br><span class=\"line\">                             &quot;cluster.routing.allocation.disk.watermark.low&quot;: &quot;90%&quot;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                       &#125;&apos;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<p>ESjvmjava,OOM,gcES32GESLucene</p>\n<p>LuceneOOM</p>\n<p>GCESKibana(Status Red)</p>\n<p>KibanaStatus Red</p>\n<p>,swappingLinuxswapping()ESswapping</p>\n"},{"title":"eth_casper","date":"2019-10-14T06:51:46.000Z","_content":"\n## Casper\n\n\n\n#### CasperPOSCasper\n\n- Casper the Friendly Finality GadgetFFG\n- Casper the Friendly GHOST: Correct-by-ConstructionCBC/TFG\n\n\n\nPOS\n\n-  the Friendly GHOST\n- BFTTendermint\n\nCasper TFGBFTPOW+POSPOWPOS\n\n\n\n[casper](https://ethfans.org/posts/Vitalik-on-the-first-test-of-sharding),[casper](https://ethresear.ch/t/cross-links-between-main-chain-and-shards/1860),[ppt](https://ethfans.org/posts/you-want-to-be-casper-sharding-validator)\n\n#### Casper vs Tendermint\n\nBFTPoSJae Kwon2014**Tendermint**\n\n**Tendermint**\n\nTendermint\n\n\n\n1/3\n\n/\n\n1-3\n\n\n\n\n\n**Casper**PoSTendermint\n\n**Casper**CasperPoS\n\n**Casper** **Tendermint**TendermintTendermint PoS\n\n**Casper**\n\nCasper\n\n\n\nCasper\n\nCasper\n\n\n","source":"_posts/eth-casper.md","raw":"---\ntitle: eth_casper\ncategories:\n  - eth\ndate: 2019-10-14 14:51:46\ntags:\n---\n\n## Casper\n\n\n\n#### CasperPOSCasper\n\n- Casper the Friendly Finality GadgetFFG\n- Casper the Friendly GHOST: Correct-by-ConstructionCBC/TFG\n\n\n\nPOS\n\n-  the Friendly GHOST\n- BFTTendermint\n\nCasper TFGBFTPOW+POSPOWPOS\n\n\n\n[casper](https://ethfans.org/posts/Vitalik-on-the-first-test-of-sharding),[casper](https://ethresear.ch/t/cross-links-between-main-chain-and-shards/1860),[ppt](https://ethfans.org/posts/you-want-to-be-casper-sharding-validator)\n\n#### Casper vs Tendermint\n\nBFTPoSJae Kwon2014**Tendermint**\n\n**Tendermint**\n\nTendermint\n\n\n\n1/3\n\n/\n\n1-3\n\n\n\n\n\n**Casper**PoSTendermint\n\n**Casper**CasperPoS\n\n**Casper** **Tendermint**TendermintTendermint PoS\n\n**Casper**\n\nCasper\n\n\n\nCasper\n\nCasper\n\n\n","slug":"eth-casper","published":1,"updated":"2019-10-14T06:51:53.874Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ti000mt6xv2flevczd","content":"<h2 id=\"Casper\"><a href=\"#Casper\" class=\"headerlink\" title=\"Casper\"></a>Casper</h2><h4 id=\"CasperPOSCasper\"><a href=\"#CasperPOSCasper\" class=\"headerlink\" title=\"CasperPOSCasper\"></a>CasperPOSCasper</h4><ul>\n<li>Casper the Friendly Finality GadgetFFG</li>\n<li>Casper the Friendly GHOST: Correct-by-ConstructionCBC/TFG</li>\n</ul>\n<p>POS</p>\n<ul>\n<li> the Friendly GHOST</li>\n<li>BFTTendermint</li>\n</ul>\n<p>Casper TFGBFTPOW+POSPOWPOS</p>\n<p><a href=\"https://ethfans.org/posts/Vitalik-on-the-first-test-of-sharding\" target=\"_blank\" rel=\"noopener\">casper</a>,<a href=\"https://ethresear.ch/t/cross-links-between-main-chain-and-shards/1860\" target=\"_blank\" rel=\"noopener\">casper</a>,<a href=\"https://ethfans.org/posts/you-want-to-be-casper-sharding-validator\" target=\"_blank\" rel=\"noopener\">ppt</a></p>\n<h4 id=\"Casper-vs-Tendermint\"><a href=\"#Casper-vs-Tendermint\" class=\"headerlink\" title=\"Casper vs Tendermint\"></a>Casper vs Tendermint</h4><p>BFTPoSJae Kwon2014<strong>Tendermint</strong></p>\n<p><strong>Tendermint</strong></p>\n<p>Tendermint</p>\n<p></p>\n<p>1/3</p>\n<p>/</p>\n<p>1-3</p>\n<p></p>\n<p></p>\n<p><strong>Casper</strong>PoSTendermint</p>\n<p><strong>Casper</strong>CasperPoS</p>\n<p><strong>Casper</strong> <strong>Tendermint</strong>TendermintTendermint PoS</p>\n<p><strong>Casper</strong></p>\n<p>Casper</p>\n<p></p>\n<p>Casper</p>\n<p>Casper</p>\n<p></p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Casper\"><a href=\"#Casper\" class=\"headerlink\" title=\"Casper\"></a>Casper</h2><h4 id=\"CasperPOSCasper\"><a href=\"#CasperPOSCasper\" class=\"headerlink\" title=\"CasperPOSCasper\"></a>CasperPOSCasper</h4><ul>\n<li>Casper the Friendly Finality GadgetFFG</li>\n<li>Casper the Friendly GHOST: Correct-by-ConstructionCBC/TFG</li>\n</ul>\n<p>POS</p>\n<ul>\n<li> the Friendly GHOST</li>\n<li>BFTTendermint</li>\n</ul>\n<p>Casper TFGBFTPOW+POSPOWPOS</p>\n<p><a href=\"https://ethfans.org/posts/Vitalik-on-the-first-test-of-sharding\" target=\"_blank\" rel=\"noopener\">casper</a>,<a href=\"https://ethresear.ch/t/cross-links-between-main-chain-and-shards/1860\" target=\"_blank\" rel=\"noopener\">casper</a>,<a href=\"https://ethfans.org/posts/you-want-to-be-casper-sharding-validator\" target=\"_blank\" rel=\"noopener\">ppt</a></p>\n<h4 id=\"Casper-vs-Tendermint\"><a href=\"#Casper-vs-Tendermint\" class=\"headerlink\" title=\"Casper vs Tendermint\"></a>Casper vs Tendermint</h4><p>BFTPoSJae Kwon2014<strong>Tendermint</strong></p>\n<p><strong>Tendermint</strong></p>\n<p>Tendermint</p>\n<p></p>\n<p>1/3</p>\n<p>/</p>\n<p>1-3</p>\n<p></p>\n<p></p>\n<p><strong>Casper</strong>PoSTendermint</p>\n<p><strong>Casper</strong>CasperPoS</p>\n<p><strong>Casper</strong> <strong>Tendermint</strong>TendermintTendermint PoS</p>\n<p><strong>Casper</strong></p>\n<p>Casper</p>\n<p></p>\n<p>Casper</p>\n<p>Casper</p>\n<p></p>\n"},{"title":"eos","date":"2019-10-14T06:43:53.000Z","_content":"\n## EOS\n\n### EOS\n\n- EOS730-40\n- EOS(constitution)\n- EOSdAppdApp\n\n\n\n### EOS App\n\n![](https://upload-images.jianshu.io/upload_images/3866441-75058ee05f7b7f8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)\n\n- IPFS\n\n  \n\n- \n\n        API\n\n- \n\n  CPU ****\n\n\n\n### EOS \n\n![EOS](https://github.com/EOSIO/eos/wiki/assets/Single-Host-Testnet-No-keosd.png)\n\n\n\n- `keosd`\n- `cleos`:nodeos REST \n- `nodeos` EOS \n\n\n\n\n\n- `producer_plugin`\n- `wallet_plugin` keosd \n- `wallet_api_plugin`\n- `chain_api_plugin`\n- `http_plugin`http  http \n- `account_history_api_plugin`\n\n\n\n `cleos`  `nodeos`  `nodeos` `nodeos`\n\n\n\n### (BFT-DPOS)\n\n210.50.5s6126(21)2115\n\n24\n\n\n\n**** 63s 126EOS 30 \n\nEOS  21  100 \n\n****\n\nDPOS[](https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper)\n\nDPOS(Byzantin Fault Tolerance) 15\n\n\n\n### \n\nBlock.oneGalaxy Digital3.25[http://EOS.IO](https://link.zhihu.com/?target=http%3A//EOS.IO)DAPPEOS\n\n![EOSDapp](https://pic2.zhimg.com/80/v2-1b8fb0ef655fcc6e3c70a8da6d3a379d_hd.jpg)\n","source":"_posts/eos.md","raw":"---\ntitle: eos\ncategories:\n  - eos\ndate: 2019-10-14 14:43:53\ntags:\n---\n\n## EOS\n\n### EOS\n\n- EOS730-40\n- EOS(constitution)\n- EOSdAppdApp\n\n\n\n### EOS App\n\n![](https://upload-images.jianshu.io/upload_images/3866441-75058ee05f7b7f8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)\n\n- IPFS\n\n  \n\n- \n\n        API\n\n- \n\n  CPU ****\n\n\n\n### EOS \n\n![EOS](https://github.com/EOSIO/eos/wiki/assets/Single-Host-Testnet-No-keosd.png)\n\n\n\n- `keosd`\n- `cleos`:nodeos REST \n- `nodeos` EOS \n\n\n\n\n\n- `producer_plugin`\n- `wallet_plugin` keosd \n- `wallet_api_plugin`\n- `chain_api_plugin`\n- `http_plugin`http  http \n- `account_history_api_plugin`\n\n\n\n `cleos`  `nodeos`  `nodeos` `nodeos`\n\n\n\n### (BFT-DPOS)\n\n210.50.5s6126(21)2115\n\n24\n\n\n\n**** 63s 126EOS 30 \n\nEOS  21  100 \n\n****\n\nDPOS[](https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper)\n\nDPOS(Byzantin Fault Tolerance) 15\n\n\n\n### \n\nBlock.oneGalaxy Digital3.25[http://EOS.IO](https://link.zhihu.com/?target=http%3A//EOS.IO)DAPPEOS\n\n![EOSDapp](https://pic2.zhimg.com/80/v2-1b8fb0ef655fcc6e3c70a8da6d3a379d_hd.jpg)\n","slug":"eos","published":1,"updated":"2019-10-14T06:44:23.967Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69tj000nt6xvp9nabogf","content":"<h2 id=\"EOS\"><a href=\"#EOS\" class=\"headerlink\" title=\"EOS\"></a>EOS</h2><h3 id=\"EOS\"><a href=\"#EOS\" class=\"headerlink\" title=\"EOS\"></a>EOS</h3><ul>\n<li>EOS730-40</li>\n<li>EOS(constitution)</li>\n<li>EOSdAppdApp</li>\n</ul>\n<h3 id=\"EOS-App\"><a href=\"#EOS-App\" class=\"headerlink\" title=\"EOS App\"></a>EOS App</h3><p><img src=\"https://upload-images.jianshu.io/upload_images/3866441-75058ee05f7b7f8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700\" alt=\"\"></p>\n<ul>\n<li><p>IPFS</p>\n<p></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p>        API</p>\n<ul>\n<li><p></p>\n<p>CPU <strong></strong></p>\n</li>\n</ul>\n<h3 id=\"EOS-\"><a href=\"#EOS-\" class=\"headerlink\" title=\"EOS \"></a>EOS </h3><p><img src=\"https://github.com/EOSIO/eos/wiki/assets/Single-Host-Testnet-No-keosd.png\" alt=\"EOS\"></p>\n<p></p>\n<ul>\n<li><code>keosd</code></li>\n<li><code>cleos</code>:nodeos REST </li>\n<li><code>nodeos</code> EOS </li>\n</ul>\n<p></p>\n<ul>\n<li><code>producer_plugin</code></li>\n<li><code>wallet_plugin</code> keosd </li>\n<li><code>wallet_api_plugin</code></li>\n<li><code>chain_api_plugin</code></li>\n<li><code>http_plugin</code>http  http </li>\n<li><code>account_history_api_plugin</code></li>\n</ul>\n<p> <code>cleos</code>  <code>nodeos</code>  <code>nodeos</code> <code>nodeos</code></p>\n<h3 id=\"-BFT-DPOS\"><a href=\"#-BFT-DPOS\" class=\"headerlink\" title=\"(BFT-DPOS)\"></a>(BFT-DPOS)</h3><p>210.50.5s6126(21)2115</p>\n<p>24</p>\n<p><strong></strong> 63s 126EOS 30 </p>\n<p>EOS  21  100 </p>\n<p><strong></strong></p>\n<p>DPOS<a href=\"https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>DPOS(Byzantin Fault Tolerance) 15</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Block.oneGalaxy Digital3.25<a href=\"https://link.zhihu.com/?target=http%3A//EOS.IO\" target=\"_blank\" rel=\"noopener\">http://EOS.IO</a>DAPPEOS</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-1b8fb0ef655fcc6e3c70a8da6d3a379d_hd.jpg\" alt=\"EOSDapp\"></p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"EOS\"><a href=\"#EOS\" class=\"headerlink\" title=\"EOS\"></a>EOS</h2><h3 id=\"EOS\"><a href=\"#EOS\" class=\"headerlink\" title=\"EOS\"></a>EOS</h3><ul>\n<li>EOS730-40</li>\n<li>EOS(constitution)</li>\n<li>EOSdAppdApp</li>\n</ul>\n<h3 id=\"EOS-App\"><a href=\"#EOS-App\" class=\"headerlink\" title=\"EOS App\"></a>EOS App</h3><p><img src=\"https://upload-images.jianshu.io/upload_images/3866441-75058ee05f7b7f8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700\" alt=\"\"></p>\n<ul>\n<li><p>IPFS</p>\n<p></p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p>        API</p>\n<ul>\n<li><p></p>\n<p>CPU <strong></strong></p>\n</li>\n</ul>\n<h3 id=\"EOS-\"><a href=\"#EOS-\" class=\"headerlink\" title=\"EOS \"></a>EOS </h3><p><img src=\"https://github.com/EOSIO/eos/wiki/assets/Single-Host-Testnet-No-keosd.png\" alt=\"EOS\"></p>\n<p></p>\n<ul>\n<li><code>keosd</code></li>\n<li><code>cleos</code>:nodeos REST </li>\n<li><code>nodeos</code> EOS </li>\n</ul>\n<p></p>\n<ul>\n<li><code>producer_plugin</code></li>\n<li><code>wallet_plugin</code> keosd </li>\n<li><code>wallet_api_plugin</code></li>\n<li><code>chain_api_plugin</code></li>\n<li><code>http_plugin</code>http  http </li>\n<li><code>account_history_api_plugin</code></li>\n</ul>\n<p> <code>cleos</code>  <code>nodeos</code>  <code>nodeos</code> <code>nodeos</code></p>\n<h3 id=\"-BFT-DPOS\"><a href=\"#-BFT-DPOS\" class=\"headerlink\" title=\"(BFT-DPOS)\"></a>(BFT-DPOS)</h3><p>210.50.5s6126(21)2115</p>\n<p>24</p>\n<p><strong></strong> 63s 126EOS 30 </p>\n<p>EOS  21  100 </p>\n<p><strong></strong></p>\n<p>DPOS<a href=\"https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>DPOS(Byzantin Fault Tolerance) 15</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Block.oneGalaxy Digital3.25<a href=\"https://link.zhihu.com/?target=http%3A//EOS.IO\" target=\"_blank\" rel=\"noopener\">http://EOS.IO</a>DAPPEOS</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-1b8fb0ef655fcc6e3c70a8da6d3a379d_hd.jpg\" alt=\"EOSDapp\"></p>\n"},{"title":"eth_jsre_api","date":"2019-10-14T06:53:56.000Z","_content":"## jsreapi\n\nottogojsconsolescript\n\n\n\n\n\napi,..backend.goGetAPIs()apinamespaceServicePublicEthereumAPItest`eth.test()`\n\n```\nfunc (s *PublicBlockChainAPI) Test(ctx context.Context) error {\n   fmt.Println(\"test\")\n   return nil\n}\n\n```\n\njs\n\njs\n\ngojsweb3ext.go\n\n```\nconst Eth_JS = `\nweb3._extend({\n\tproperty: 'eth',\n\tmethods: [\n\t\tnew web3._extend.Method({\n\t\t\tname: 'test',\n\t\t\tcall: 'eth_test',\n\t\t\tparams: 0\n\t\t}),\n\t]\n\t...\n\t`\n```\n\n`make all`\n\n\n\njsweb3.js\n\n```\nvar methods = function () {\n    var test = new Method({\n        name: 'test',\n        call: 'eth_test',\n        params: 0\n    });\n    var getStorageAt = new Method({\n        name: 'getStorageAt',\n        call: 'eth_getStorageAt',\n        params: 3,\n        inputFormatter: [null, utils.toHex, formatters.inputDefaultBlockNumberFormatter]\n    });\n\t...\n\t return [\n\t \ttest\n\t ]\n\n}\n```\n\njsgobindata.go\n\ndeps.gogo:generatebindata.go.\n\nbindata.gogo-bindata\n\n```\ngo get github.com/jteeuwen/go-bindata\ngo install github.com/jteeuwen/go-bindata/go-bindata\n```\n\nbindata.goIDE\n\n```\ncd $GOPATH/src/github.com/ethereum/go-ethereum/internal/jsre/deps\ngo-bindata -nometadata -pkg deps -o bindata.go bignumber.js web3.js\ngofmt -w -s bindata.go\n```\n\n`make all`\n\n\n\n\n\njsgetStorageAtinputFormatternullutils.toHexencodehexformatter2formatter\n\n```\nvar inputDefaultBlockNumberFormatter = function (blockNumber) {\n    if (blockNumber === undefined) {\n        return config.defaultBlock;\n    }\n    return inputBlockNumberFormatter(blockNumber);\n};\n\nvar inputTransactionFormatter = function (options){\n\n    options.from = options.from || config.defaultAccount;\n    options.from = inputAddressFormatter(options.from);\n\n    if (options.to) { // it might be contract creation\n        options.to = inputAddressFormatter(options.to);\n    }\n\n    ['gasPrice', 'gas', 'value', 'nonce'].filter(function (key) {\n        return options[key] !== undefined;\n    }).forEach(function(key){\n        options[key] = utils.fromDecimal(options[key]);\n    });\n\n    return options;\n};\n```\n","source":"_posts/eth-jsre-api.md","raw":"---\ntitle: eth_jsre_api\ncategories:\n  - eth\ndate: 2019-10-14 14:53:56\ntags:\n---\n## jsreapi\n\nottogojsconsolescript\n\n\n\n\n\napi,..backend.goGetAPIs()apinamespaceServicePublicEthereumAPItest`eth.test()`\n\n```\nfunc (s *PublicBlockChainAPI) Test(ctx context.Context) error {\n   fmt.Println(\"test\")\n   return nil\n}\n\n```\n\njs\n\njs\n\ngojsweb3ext.go\n\n```\nconst Eth_JS = `\nweb3._extend({\n\tproperty: 'eth',\n\tmethods: [\n\t\tnew web3._extend.Method({\n\t\t\tname: 'test',\n\t\t\tcall: 'eth_test',\n\t\t\tparams: 0\n\t\t}),\n\t]\n\t...\n\t`\n```\n\n`make all`\n\n\n\njsweb3.js\n\n```\nvar methods = function () {\n    var test = new Method({\n        name: 'test',\n        call: 'eth_test',\n        params: 0\n    });\n    var getStorageAt = new Method({\n        name: 'getStorageAt',\n        call: 'eth_getStorageAt',\n        params: 3,\n        inputFormatter: [null, utils.toHex, formatters.inputDefaultBlockNumberFormatter]\n    });\n\t...\n\t return [\n\t \ttest\n\t ]\n\n}\n```\n\njsgobindata.go\n\ndeps.gogo:generatebindata.go.\n\nbindata.gogo-bindata\n\n```\ngo get github.com/jteeuwen/go-bindata\ngo install github.com/jteeuwen/go-bindata/go-bindata\n```\n\nbindata.goIDE\n\n```\ncd $GOPATH/src/github.com/ethereum/go-ethereum/internal/jsre/deps\ngo-bindata -nometadata -pkg deps -o bindata.go bignumber.js web3.js\ngofmt -w -s bindata.go\n```\n\n`make all`\n\n\n\n\n\njsgetStorageAtinputFormatternullutils.toHexencodehexformatter2formatter\n\n```\nvar inputDefaultBlockNumberFormatter = function (blockNumber) {\n    if (blockNumber === undefined) {\n        return config.defaultBlock;\n    }\n    return inputBlockNumberFormatter(blockNumber);\n};\n\nvar inputTransactionFormatter = function (options){\n\n    options.from = options.from || config.defaultAccount;\n    options.from = inputAddressFormatter(options.from);\n\n    if (options.to) { // it might be contract creation\n        options.to = inputAddressFormatter(options.to);\n    }\n\n    ['gasPrice', 'gas', 'value', 'nonce'].filter(function (key) {\n        return options[key] !== undefined;\n    }).forEach(function(key){\n        options[key] = utils.fromDecimal(options[key]);\n    });\n\n    return options;\n};\n```\n","slug":"eth-jsre-api","published":1,"updated":"2019-10-14T06:54:16.741Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69tm000qt6xvso7pmbeq","content":"<h2 id=\"jsreapi\"><a href=\"#jsreapi\" class=\"headerlink\" title=\"jsreapi\"></a>jsreapi</h2><p>ottogojsconsolescript</p>\n<p></p>\n<p>api,..backend.goGetAPIs()apinamespaceServicePublicEthereumAPItest<code>eth.test()</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (s *PublicBlockChainAPI) Test(ctx context.Context) error &#123;</span><br><span class=\"line\">   fmt.Println(&quot;test&quot;)</span><br><span class=\"line\">   return nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>js</p>\n<p>js</p>\n<p>gojsweb3ext.go</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const Eth_JS = `</span><br><span class=\"line\">web3._extend(&#123;</span><br><span class=\"line\">\tproperty: &apos;eth&apos;,</span><br><span class=\"line\">\tmethods: [</span><br><span class=\"line\">\t\tnew web3._extend.Method(&#123;</span><br><span class=\"line\">\t\t\tname: &apos;test&apos;,</span><br><span class=\"line\">\t\t\tcall: &apos;eth_test&apos;,</span><br><span class=\"line\">\t\t\tparams: 0</span><br><span class=\"line\">\t\t&#125;),</span><br><span class=\"line\">\t]</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t`</span><br></pre></td></tr></table></figure>\n\n<p><code>make all</code></p>\n<p>jsweb3.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var methods = function () &#123;</span><br><span class=\"line\">    var test = new Method(&#123;</span><br><span class=\"line\">        name: &apos;test&apos;,</span><br><span class=\"line\">        call: &apos;eth_test&apos;,</span><br><span class=\"line\">        params: 0</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    var getStorageAt = new Method(&#123;</span><br><span class=\"line\">        name: &apos;getStorageAt&apos;,</span><br><span class=\"line\">        call: &apos;eth_getStorageAt&apos;,</span><br><span class=\"line\">        params: 3,</span><br><span class=\"line\">        inputFormatter: [null, utils.toHex, formatters.inputDefaultBlockNumberFormatter]</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t return [</span><br><span class=\"line\">\t \ttest</span><br><span class=\"line\">\t ]</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>jsgobindata.go</p>\n<p>deps.gogo:generatebindata.go.</p>\n<p>bindata.gogo-bindata</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go get github.com/jteeuwen/go-bindata</span><br><span class=\"line\">go install github.com/jteeuwen/go-bindata/go-bindata</span><br></pre></td></tr></table></figure>\n\n<p>bindata.goIDE</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd $GOPATH/src/github.com/ethereum/go-ethereum/internal/jsre/deps</span><br><span class=\"line\">go-bindata -nometadata -pkg deps -o bindata.go bignumber.js web3.js</span><br><span class=\"line\">gofmt -w -s bindata.go</span><br></pre></td></tr></table></figure>\n\n<p><code>make all</code></p>\n<p>jsgetStorageAtinputFormatternullutils.toHexencodehexformatter2formatter</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var inputDefaultBlockNumberFormatter = function (blockNumber) &#123;</span><br><span class=\"line\">    if (blockNumber === undefined) &#123;</span><br><span class=\"line\">        return config.defaultBlock;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return inputBlockNumberFormatter(blockNumber);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">var inputTransactionFormatter = function (options)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    options.from = options.from || config.defaultAccount;</span><br><span class=\"line\">    options.from = inputAddressFormatter(options.from);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (options.to) &#123; // it might be contract creation</span><br><span class=\"line\">        options.to = inputAddressFormatter(options.to);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [&apos;gasPrice&apos;, &apos;gas&apos;, &apos;value&apos;, &apos;nonce&apos;].filter(function (key) &#123;</span><br><span class=\"line\">        return options[key] !== undefined;</span><br><span class=\"line\">    &#125;).forEach(function(key)&#123;</span><br><span class=\"line\">        options[key] = utils.fromDecimal(options[key]);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    return options;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"jsreapi\"><a href=\"#jsreapi\" class=\"headerlink\" title=\"jsreapi\"></a>jsreapi</h2><p>ottogojsconsolescript</p>\n<p></p>\n<p>api,..backend.goGetAPIs()apinamespaceServicePublicEthereumAPItest<code>eth.test()</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (s *PublicBlockChainAPI) Test(ctx context.Context) error &#123;</span><br><span class=\"line\">   fmt.Println(&quot;test&quot;)</span><br><span class=\"line\">   return nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>js</p>\n<p>js</p>\n<p>gojsweb3ext.go</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const Eth_JS = `</span><br><span class=\"line\">web3._extend(&#123;</span><br><span class=\"line\">\tproperty: &apos;eth&apos;,</span><br><span class=\"line\">\tmethods: [</span><br><span class=\"line\">\t\tnew web3._extend.Method(&#123;</span><br><span class=\"line\">\t\t\tname: &apos;test&apos;,</span><br><span class=\"line\">\t\t\tcall: &apos;eth_test&apos;,</span><br><span class=\"line\">\t\t\tparams: 0</span><br><span class=\"line\">\t\t&#125;),</span><br><span class=\"line\">\t]</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t`</span><br></pre></td></tr></table></figure>\n\n<p><code>make all</code></p>\n<p>jsweb3.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var methods = function () &#123;</span><br><span class=\"line\">    var test = new Method(&#123;</span><br><span class=\"line\">        name: &apos;test&apos;,</span><br><span class=\"line\">        call: &apos;eth_test&apos;,</span><br><span class=\"line\">        params: 0</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    var getStorageAt = new Method(&#123;</span><br><span class=\"line\">        name: &apos;getStorageAt&apos;,</span><br><span class=\"line\">        call: &apos;eth_getStorageAt&apos;,</span><br><span class=\"line\">        params: 3,</span><br><span class=\"line\">        inputFormatter: [null, utils.toHex, formatters.inputDefaultBlockNumberFormatter]</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t return [</span><br><span class=\"line\">\t \ttest</span><br><span class=\"line\">\t ]</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>jsgobindata.go</p>\n<p>deps.gogo:generatebindata.go.</p>\n<p>bindata.gogo-bindata</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go get github.com/jteeuwen/go-bindata</span><br><span class=\"line\">go install github.com/jteeuwen/go-bindata/go-bindata</span><br></pre></td></tr></table></figure>\n\n<p>bindata.goIDE</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd $GOPATH/src/github.com/ethereum/go-ethereum/internal/jsre/deps</span><br><span class=\"line\">go-bindata -nometadata -pkg deps -o bindata.go bignumber.js web3.js</span><br><span class=\"line\">gofmt -w -s bindata.go</span><br></pre></td></tr></table></figure>\n\n<p><code>make all</code></p>\n<p>jsgetStorageAtinputFormatternullutils.toHexencodehexformatter2formatter</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var inputDefaultBlockNumberFormatter = function (blockNumber) &#123;</span><br><span class=\"line\">    if (blockNumber === undefined) &#123;</span><br><span class=\"line\">        return config.defaultBlock;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return inputBlockNumberFormatter(blockNumber);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">var inputTransactionFormatter = function (options)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    options.from = options.from || config.defaultAccount;</span><br><span class=\"line\">    options.from = inputAddressFormatter(options.from);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (options.to) &#123; // it might be contract creation</span><br><span class=\"line\">        options.to = inputAddressFormatter(options.to);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    [&apos;gasPrice&apos;, &apos;gas&apos;, &apos;value&apos;, &apos;nonce&apos;].filter(function (key) &#123;</span><br><span class=\"line\">        return options[key] !== undefined;</span><br><span class=\"line\">    &#125;).forEach(function(key)&#123;</span><br><span class=\"line\">        options[key] = utils.fromDecimal(options[key]);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    return options;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n"},{"title":"eth_state","date":"2019-10-14T06:54:57.000Z","_content":"\n#### state trie\n\n\n\nstate/Trie\n\n```\n// Trie is a Ethereum Merkle Trie.\ntype Trie interface {\n\tTryGet(key []byte) ([]byte, error)\n\tTryUpdate(key, value []byte) error\n\tTryDelete(key []byte) error\n\tCommit(onleaf trie.LeafCallback) (common.Hash, error)\n\tHash() common.Hash\n\tNodeIterator(startKey []byte) trie.NodeIterator\n\tGetKey([]byte) []byte // TODO(fjl): remove this when SecureTrie is removed\n\tProve(key []byte, fromLevel uint, proofDb ethdb.Putter) error\n}\n```\n\nTrieGetPut/TrieCommit\n\nTrieSecureTriecachedTrieSecureTriecachedTrieTrieSecureTrietrietrie/Trie()trie/TrieTrie\n\n\n\nstate/Database\n\n```\n// Database wraps access to tries and contract code.\ntype Database interface {\n\t// OpenTrie opens the main account trie.\n\tOpenTrie(root common.Hash) (Trie, error)\n\n\t// OpenStorageTrie opens the storage trie of an account.\n\tOpenStorageTrie(addrHash, root common.Hash) (Trie, error)\n\n\t// CopyTrie returns an independent copy of the given trie.\n\tCopyTrie(Trie) Trie\n\n\t// ContractCode retrieves a particular contract's code.\n\tContractCode(addrHash, codeHash common.Hash) ([]byte, error)\n\n\t// ContractCodeSize retrieves a particular contracts code's size.\n\tContractCodeSize(addrHash, codeHash common.Hash) (int, error)\n\n\t// TrieDB retrieves the low level trie database used for data storage.\n\tTrieDB() *trie.Database\n}\n```\n\nstate/DatabaseTriedbdb\n\ntrie.Databaseleveldbleveldbkey-value\n\n\n\n\n\ntrieTrieDatabase\n\nstateTrie(= =)..  Databasestatetrie/Trietrie/DatabasecachingDB\n\n\n\n\n\n#### \n\nstatedbkey-valuevaluestateObjectstateObjectdatastatedbDatabaseTriekey-valuevaluestateObjectdata(Account)triekeyaddrstate(setBalancegetBalance)stateObjectdataCommit\n\nstatedbstateObjectdataaccountvalueaccountstatedb`SetState``GetState`\n\n```\nvar (\n\tstateAddr = common.BytesToAddress([]byte{1, 1, 1, 1, 2})\n\tkey  = common.BytesToHash([]byte(\"names_service\"))\n)\nfunc TestSingleTrie(t *testing.T) {\n\tdb := ethdb.NewMemDatabase()\n\tstate, _ := state.New(common.Hash{}, state.NewDatabase(db))\n\tstate.SetState(stateAddr, key, common.BytesToHash([]byte{0, 0, 0}))\n\tstate.IntermediateRoot(false)\n\thash := state.GetState(stateAddr, key)\n\tif hash != common.BytesToHash([]byte{0, 0, 0}) {\n\t\tt.Error(\"unexpected err\")\n\t}\n}\n```\n\n\n\nsetStatevaluehashsetStatetrie/databasekeysetStatevaluegetStatekeyvaluevaluestateObject.datahash\n\ntrie/Database/\n\n```\n//\nfunc (db *Database) Node(hash common.Hash) ([]byte, error)\n//\nfunc (db *Database) InsertBlob(hash common.Hash, blob []byte)\n\n```\n\n\n\n/\n\n```\n// ContractCode retrieves a particular contract's code.\nfunc (db *cachingDB) ContractCode(addrHash, codeHash common.Hash) ([]byte, error) {\n\tcode, err := db.db.Node(codeHash)\n\tif err == nil {\n\t\tdb.codeSizeCache.Add(codeHash, len(code))\n\t}\n\treturn code, err\n}\n\nfunc (s *StateDB) Commit(deleteEmptyObjects bool) (root common.Hash, err error) {\n  ...\n     // Write any contract code associated with the state object\n     if stateObject.code != nil && stateObject.dirtyCode {\n\t\t  s.db.TrieDB().InsertBlob(common.BytesToHash(stateObject.CodeHash()), stateObject.code)\n\t\t  stateObject.dirtyCode = false\n\t  }\n   ...\n}\n```\n\n\n\nTrie\n\n```\nfunc TestSingleTrie(t *testing.T) {\n\tdb := ethdb.NewMemDatabase()\n\tstate, _ := state.New(common.Hash{}, state.NewDatabase(db))\n\tstate.SetState(stateAddr, key, common.BytesToHash([]byte{0, 0, 0}))\n\tstate.IntermediateRoot(false)\n\thash := state.GetState(stateAddr, key)\n\tif hash != common.BytesToHash([]byte{0, 0, 0}) {\n\t\tt.Error(\"unexpected err\")\n\t}\n\n\n\terr = trie.TryUpdate([]byte(\"anny\"), []byte(\"0xccccc\"))\n\tif err != nil {\n\t\tt.Error(\"update err, \", err)\n\t}\n\tt.Log(trie.Hash())\n\ttrie.Commit(nil)\n\tt.Log(trie.Hash())\n\terr = trie.TryUpdate([]byte(\"anny\"), []byte(\"0xccccb\"))\n\tif err != nil {\n\t\tt.Error(\"update err, \", err)\n\t}\n\terr = trie.TryUpdate([]byte(\"jim\"), []byte(\"0xbbbbbc\"))\n\tif err != nil {\n\t\tt.Error(\"update err, \", err)\n\t}\n\ttrie.Commit(nil)\n\tt.Log(trie.Hash())\n\tstate.SetState(stateAddr, key, trie.Hash())\n\thash = state.GetState(stateAddr, key)\n\tif hash != trie.Hash() {\n\t\tt.Error(\"unexpected err\")\n\t}\n\ttrie1, err := state.Database().OpenStorageTrie(common.Hash{}, hash)\n\tif err != nil {\n\t\tt.Error(\"unexpected err\", err)\n\t}\n\tvalue, err := trie1.TryGet([]byte(\"anny\"))\n\tif err != nil {\n\t\tt.Error(\"unexpected err\", err)\n\t}\n\tif string(value) != \"0xccccb\" {\n\t\tt.Error(\"unexpected err\")\n\t}\n}\n```\n","source":"_posts/eth-state.md","raw":"---\ntitle: eth_state\ncategories:\n  - eth\ndate: 2019-10-14 14:54:57\ntags:\n---\n\n#### state trie\n\n\n\nstate/Trie\n\n```\n// Trie is a Ethereum Merkle Trie.\ntype Trie interface {\n\tTryGet(key []byte) ([]byte, error)\n\tTryUpdate(key, value []byte) error\n\tTryDelete(key []byte) error\n\tCommit(onleaf trie.LeafCallback) (common.Hash, error)\n\tHash() common.Hash\n\tNodeIterator(startKey []byte) trie.NodeIterator\n\tGetKey([]byte) []byte // TODO(fjl): remove this when SecureTrie is removed\n\tProve(key []byte, fromLevel uint, proofDb ethdb.Putter) error\n}\n```\n\nTrieGetPut/TrieCommit\n\nTrieSecureTriecachedTrieSecureTriecachedTrieTrieSecureTrietrietrie/Trie()trie/TrieTrie\n\n\n\nstate/Database\n\n```\n// Database wraps access to tries and contract code.\ntype Database interface {\n\t// OpenTrie opens the main account trie.\n\tOpenTrie(root common.Hash) (Trie, error)\n\n\t// OpenStorageTrie opens the storage trie of an account.\n\tOpenStorageTrie(addrHash, root common.Hash) (Trie, error)\n\n\t// CopyTrie returns an independent copy of the given trie.\n\tCopyTrie(Trie) Trie\n\n\t// ContractCode retrieves a particular contract's code.\n\tContractCode(addrHash, codeHash common.Hash) ([]byte, error)\n\n\t// ContractCodeSize retrieves a particular contracts code's size.\n\tContractCodeSize(addrHash, codeHash common.Hash) (int, error)\n\n\t// TrieDB retrieves the low level trie database used for data storage.\n\tTrieDB() *trie.Database\n}\n```\n\nstate/DatabaseTriedbdb\n\ntrie.Databaseleveldbleveldbkey-value\n\n\n\n\n\ntrieTrieDatabase\n\nstateTrie(= =)..  Databasestatetrie/Trietrie/DatabasecachingDB\n\n\n\n\n\n#### \n\nstatedbkey-valuevaluestateObjectstateObjectdatastatedbDatabaseTriekey-valuevaluestateObjectdata(Account)triekeyaddrstate(setBalancegetBalance)stateObjectdataCommit\n\nstatedbstateObjectdataaccountvalueaccountstatedb`SetState``GetState`\n\n```\nvar (\n\tstateAddr = common.BytesToAddress([]byte{1, 1, 1, 1, 2})\n\tkey  = common.BytesToHash([]byte(\"names_service\"))\n)\nfunc TestSingleTrie(t *testing.T) {\n\tdb := ethdb.NewMemDatabase()\n\tstate, _ := state.New(common.Hash{}, state.NewDatabase(db))\n\tstate.SetState(stateAddr, key, common.BytesToHash([]byte{0, 0, 0}))\n\tstate.IntermediateRoot(false)\n\thash := state.GetState(stateAddr, key)\n\tif hash != common.BytesToHash([]byte{0, 0, 0}) {\n\t\tt.Error(\"unexpected err\")\n\t}\n}\n```\n\n\n\nsetStatevaluehashsetStatetrie/databasekeysetStatevaluegetStatekeyvaluevaluestateObject.datahash\n\ntrie/Database/\n\n```\n//\nfunc (db *Database) Node(hash common.Hash) ([]byte, error)\n//\nfunc (db *Database) InsertBlob(hash common.Hash, blob []byte)\n\n```\n\n\n\n/\n\n```\n// ContractCode retrieves a particular contract's code.\nfunc (db *cachingDB) ContractCode(addrHash, codeHash common.Hash) ([]byte, error) {\n\tcode, err := db.db.Node(codeHash)\n\tif err == nil {\n\t\tdb.codeSizeCache.Add(codeHash, len(code))\n\t}\n\treturn code, err\n}\n\nfunc (s *StateDB) Commit(deleteEmptyObjects bool) (root common.Hash, err error) {\n  ...\n     // Write any contract code associated with the state object\n     if stateObject.code != nil && stateObject.dirtyCode {\n\t\t  s.db.TrieDB().InsertBlob(common.BytesToHash(stateObject.CodeHash()), stateObject.code)\n\t\t  stateObject.dirtyCode = false\n\t  }\n   ...\n}\n```\n\n\n\nTrie\n\n```\nfunc TestSingleTrie(t *testing.T) {\n\tdb := ethdb.NewMemDatabase()\n\tstate, _ := state.New(common.Hash{}, state.NewDatabase(db))\n\tstate.SetState(stateAddr, key, common.BytesToHash([]byte{0, 0, 0}))\n\tstate.IntermediateRoot(false)\n\thash := state.GetState(stateAddr, key)\n\tif hash != common.BytesToHash([]byte{0, 0, 0}) {\n\t\tt.Error(\"unexpected err\")\n\t}\n\n\n\terr = trie.TryUpdate([]byte(\"anny\"), []byte(\"0xccccc\"))\n\tif err != nil {\n\t\tt.Error(\"update err, \", err)\n\t}\n\tt.Log(trie.Hash())\n\ttrie.Commit(nil)\n\tt.Log(trie.Hash())\n\terr = trie.TryUpdate([]byte(\"anny\"), []byte(\"0xccccb\"))\n\tif err != nil {\n\t\tt.Error(\"update err, \", err)\n\t}\n\terr = trie.TryUpdate([]byte(\"jim\"), []byte(\"0xbbbbbc\"))\n\tif err != nil {\n\t\tt.Error(\"update err, \", err)\n\t}\n\ttrie.Commit(nil)\n\tt.Log(trie.Hash())\n\tstate.SetState(stateAddr, key, trie.Hash())\n\thash = state.GetState(stateAddr, key)\n\tif hash != trie.Hash() {\n\t\tt.Error(\"unexpected err\")\n\t}\n\ttrie1, err := state.Database().OpenStorageTrie(common.Hash{}, hash)\n\tif err != nil {\n\t\tt.Error(\"unexpected err\", err)\n\t}\n\tvalue, err := trie1.TryGet([]byte(\"anny\"))\n\tif err != nil {\n\t\tt.Error(\"unexpected err\", err)\n\t}\n\tif string(value) != \"0xccccb\" {\n\t\tt.Error(\"unexpected err\")\n\t}\n}\n```\n","slug":"eth-state","published":1,"updated":"2019-10-14T06:55:20.646Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69to000rt6xvlnk8foeu","content":"<h4 id=\"state-trie\"><a href=\"#state-trie\" class=\"headerlink\" title=\"state trie\"></a>state trie</h4><p>state/Trie</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Trie is a Ethereum Merkle Trie.</span><br><span class=\"line\">type Trie interface &#123;</span><br><span class=\"line\">\tTryGet(key []byte) ([]byte, error)</span><br><span class=\"line\">\tTryUpdate(key, value []byte) error</span><br><span class=\"line\">\tTryDelete(key []byte) error</span><br><span class=\"line\">\tCommit(onleaf trie.LeafCallback) (common.Hash, error)</span><br><span class=\"line\">\tHash() common.Hash</span><br><span class=\"line\">\tNodeIterator(startKey []byte) trie.NodeIterator</span><br><span class=\"line\">\tGetKey([]byte) []byte // TODO(fjl): remove this when SecureTrie is removed</span><br><span class=\"line\">\tProve(key []byte, fromLevel uint, proofDb ethdb.Putter) error</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>TrieGetPut/TrieCommit</p>\n<p>TrieSecureTriecachedTrieSecureTriecachedTrieTrieSecureTrietrietrie/Trie()trie/TrieTrie</p>\n<p>state/Database</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Database wraps access to tries and contract code.</span><br><span class=\"line\">type Database interface &#123;</span><br><span class=\"line\">\t// OpenTrie opens the main account trie.</span><br><span class=\"line\">\tOpenTrie(root common.Hash) (Trie, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// OpenStorageTrie opens the storage trie of an account.</span><br><span class=\"line\">\tOpenStorageTrie(addrHash, root common.Hash) (Trie, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// CopyTrie returns an independent copy of the given trie.</span><br><span class=\"line\">\tCopyTrie(Trie) Trie</span><br><span class=\"line\"></span><br><span class=\"line\">\t// ContractCode retrieves a particular contract&apos;s code.</span><br><span class=\"line\">\tContractCode(addrHash, codeHash common.Hash) ([]byte, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// ContractCodeSize retrieves a particular contracts code&apos;s size.</span><br><span class=\"line\">\tContractCodeSize(addrHash, codeHash common.Hash) (int, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// TrieDB retrieves the low level trie database used for data storage.</span><br><span class=\"line\">\tTrieDB() *trie.Database</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>state/DatabaseTriedbdb</p>\n<p>trie.Databaseleveldbleveldbkey-value</p>\n<p>trieTrieDatabase</p>\n<p>stateTrie(= =)..  Databasestatetrie/Trietrie/DatabasecachingDB</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>statedbkey-valuevaluestateObjectstateObjectdatastatedbDatabaseTriekey-valuevaluestateObjectdata(Account)triekeyaddrstate(setBalancegetBalance)stateObjectdataCommit</p>\n<p>statedbstateObjectdataaccountvalueaccountstatedb<code>SetState</code><code>GetState</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var (</span><br><span class=\"line\">\tstateAddr = common.BytesToAddress([]byte&#123;1, 1, 1, 1, 2&#125;)</span><br><span class=\"line\">\tkey  = common.BytesToHash([]byte(&quot;names_service&quot;))</span><br><span class=\"line\">)</span><br><span class=\"line\">func TestSingleTrie(t *testing.T) &#123;</span><br><span class=\"line\">\tdb := ethdb.NewMemDatabase()</span><br><span class=\"line\">\tstate, _ := state.New(common.Hash&#123;&#125;, state.NewDatabase(db))</span><br><span class=\"line\">\tstate.SetState(stateAddr, key, common.BytesToHash([]byte&#123;0, 0, 0&#125;))</span><br><span class=\"line\">\tstate.IntermediateRoot(false)</span><br><span class=\"line\">\thash := state.GetState(stateAddr, key)</span><br><span class=\"line\">\tif hash != common.BytesToHash([]byte&#123;0, 0, 0&#125;) &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>setStatevaluehashsetStatetrie/databasekeysetStatevaluegetStatekeyvaluevaluestateObject.datahash</p>\n<p>trie/Database/</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">func (db *Database) Node(hash common.Hash) ([]byte, error)</span><br><span class=\"line\">//</span><br><span class=\"line\">func (db *Database) InsertBlob(hash common.Hash, blob []byte)</span><br></pre></td></tr></table></figure>\n\n<p>/</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ContractCode retrieves a particular contract&apos;s code.</span><br><span class=\"line\">func (db *cachingDB) ContractCode(addrHash, codeHash common.Hash) ([]byte, error) &#123;</span><br><span class=\"line\">\tcode, err := db.db.Node(codeHash)</span><br><span class=\"line\">\tif err == nil &#123;</span><br><span class=\"line\">\t\tdb.codeSizeCache.Add(codeHash, len(code))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn code, err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (s *StateDB) Commit(deleteEmptyObjects bool) (root common.Hash, err error) &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">     // Write any contract code associated with the state object</span><br><span class=\"line\">     if stateObject.code != nil &amp;&amp; stateObject.dirtyCode &#123;</span><br><span class=\"line\">\t\t  s.db.TrieDB().InsertBlob(common.BytesToHash(stateObject.CodeHash()), stateObject.code)</span><br><span class=\"line\">\t\t  stateObject.dirtyCode = false</span><br><span class=\"line\">\t  &#125;</span><br><span class=\"line\">   ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Trie</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func TestSingleTrie(t *testing.T) &#123;</span><br><span class=\"line\">\tdb := ethdb.NewMemDatabase()</span><br><span class=\"line\">\tstate, _ := state.New(common.Hash&#123;&#125;, state.NewDatabase(db))</span><br><span class=\"line\">\tstate.SetState(stateAddr, key, common.BytesToHash([]byte&#123;0, 0, 0&#125;))</span><br><span class=\"line\">\tstate.IntermediateRoot(false)</span><br><span class=\"line\">\thash := state.GetState(stateAddr, key)</span><br><span class=\"line\">\tif hash != common.BytesToHash([]byte&#123;0, 0, 0&#125;) &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\terr = trie.TryUpdate([]byte(&quot;anny&quot;), []byte(&quot;0xccccc&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;update err, &quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tt.Log(trie.Hash())</span><br><span class=\"line\">\ttrie.Commit(nil)</span><br><span class=\"line\">\tt.Log(trie.Hash())</span><br><span class=\"line\">\terr = trie.TryUpdate([]byte(&quot;anny&quot;), []byte(&quot;0xccccb&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;update err, &quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\terr = trie.TryUpdate([]byte(&quot;jim&quot;), []byte(&quot;0xbbbbbc&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;update err, &quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ttrie.Commit(nil)</span><br><span class=\"line\">\tt.Log(trie.Hash())</span><br><span class=\"line\">\tstate.SetState(stateAddr, key, trie.Hash())</span><br><span class=\"line\">\thash = state.GetState(stateAddr, key)</span><br><span class=\"line\">\tif hash != trie.Hash() &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ttrie1, err := state.Database().OpenStorageTrie(common.Hash&#123;&#125;, hash)</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvalue, err := trie1.TryGet([]byte(&quot;anny&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif string(value) != &quot;0xccccb&quot; &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h4 id=\"state-trie\"><a href=\"#state-trie\" class=\"headerlink\" title=\"state trie\"></a>state trie</h4><p>state/Trie</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Trie is a Ethereum Merkle Trie.</span><br><span class=\"line\">type Trie interface &#123;</span><br><span class=\"line\">\tTryGet(key []byte) ([]byte, error)</span><br><span class=\"line\">\tTryUpdate(key, value []byte) error</span><br><span class=\"line\">\tTryDelete(key []byte) error</span><br><span class=\"line\">\tCommit(onleaf trie.LeafCallback) (common.Hash, error)</span><br><span class=\"line\">\tHash() common.Hash</span><br><span class=\"line\">\tNodeIterator(startKey []byte) trie.NodeIterator</span><br><span class=\"line\">\tGetKey([]byte) []byte // TODO(fjl): remove this when SecureTrie is removed</span><br><span class=\"line\">\tProve(key []byte, fromLevel uint, proofDb ethdb.Putter) error</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>TrieGetPut/TrieCommit</p>\n<p>TrieSecureTriecachedTrieSecureTriecachedTrieTrieSecureTrietrietrie/Trie()trie/TrieTrie</p>\n<p>state/Database</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Database wraps access to tries and contract code.</span><br><span class=\"line\">type Database interface &#123;</span><br><span class=\"line\">\t// OpenTrie opens the main account trie.</span><br><span class=\"line\">\tOpenTrie(root common.Hash) (Trie, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// OpenStorageTrie opens the storage trie of an account.</span><br><span class=\"line\">\tOpenStorageTrie(addrHash, root common.Hash) (Trie, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// CopyTrie returns an independent copy of the given trie.</span><br><span class=\"line\">\tCopyTrie(Trie) Trie</span><br><span class=\"line\"></span><br><span class=\"line\">\t// ContractCode retrieves a particular contract&apos;s code.</span><br><span class=\"line\">\tContractCode(addrHash, codeHash common.Hash) ([]byte, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// ContractCodeSize retrieves a particular contracts code&apos;s size.</span><br><span class=\"line\">\tContractCodeSize(addrHash, codeHash common.Hash) (int, error)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// TrieDB retrieves the low level trie database used for data storage.</span><br><span class=\"line\">\tTrieDB() *trie.Database</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>state/DatabaseTriedbdb</p>\n<p>trie.Databaseleveldbleveldbkey-value</p>\n<p>trieTrieDatabase</p>\n<p>stateTrie(= =)..  Databasestatetrie/Trietrie/DatabasecachingDB</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>statedbkey-valuevaluestateObjectstateObjectdatastatedbDatabaseTriekey-valuevaluestateObjectdata(Account)triekeyaddrstate(setBalancegetBalance)stateObjectdataCommit</p>\n<p>statedbstateObjectdataaccountvalueaccountstatedb<code>SetState</code><code>GetState</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var (</span><br><span class=\"line\">\tstateAddr = common.BytesToAddress([]byte&#123;1, 1, 1, 1, 2&#125;)</span><br><span class=\"line\">\tkey  = common.BytesToHash([]byte(&quot;names_service&quot;))</span><br><span class=\"line\">)</span><br><span class=\"line\">func TestSingleTrie(t *testing.T) &#123;</span><br><span class=\"line\">\tdb := ethdb.NewMemDatabase()</span><br><span class=\"line\">\tstate, _ := state.New(common.Hash&#123;&#125;, state.NewDatabase(db))</span><br><span class=\"line\">\tstate.SetState(stateAddr, key, common.BytesToHash([]byte&#123;0, 0, 0&#125;))</span><br><span class=\"line\">\tstate.IntermediateRoot(false)</span><br><span class=\"line\">\thash := state.GetState(stateAddr, key)</span><br><span class=\"line\">\tif hash != common.BytesToHash([]byte&#123;0, 0, 0&#125;) &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>setStatevaluehashsetStatetrie/databasekeysetStatevaluegetStatekeyvaluevaluestateObject.datahash</p>\n<p>trie/Database/</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">func (db *Database) Node(hash common.Hash) ([]byte, error)</span><br><span class=\"line\">//</span><br><span class=\"line\">func (db *Database) InsertBlob(hash common.Hash, blob []byte)</span><br></pre></td></tr></table></figure>\n\n<p>/</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ContractCode retrieves a particular contract&apos;s code.</span><br><span class=\"line\">func (db *cachingDB) ContractCode(addrHash, codeHash common.Hash) ([]byte, error) &#123;</span><br><span class=\"line\">\tcode, err := db.db.Node(codeHash)</span><br><span class=\"line\">\tif err == nil &#123;</span><br><span class=\"line\">\t\tdb.codeSizeCache.Add(codeHash, len(code))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn code, err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (s *StateDB) Commit(deleteEmptyObjects bool) (root common.Hash, err error) &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">     // Write any contract code associated with the state object</span><br><span class=\"line\">     if stateObject.code != nil &amp;&amp; stateObject.dirtyCode &#123;</span><br><span class=\"line\">\t\t  s.db.TrieDB().InsertBlob(common.BytesToHash(stateObject.CodeHash()), stateObject.code)</span><br><span class=\"line\">\t\t  stateObject.dirtyCode = false</span><br><span class=\"line\">\t  &#125;</span><br><span class=\"line\">   ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Trie</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func TestSingleTrie(t *testing.T) &#123;</span><br><span class=\"line\">\tdb := ethdb.NewMemDatabase()</span><br><span class=\"line\">\tstate, _ := state.New(common.Hash&#123;&#125;, state.NewDatabase(db))</span><br><span class=\"line\">\tstate.SetState(stateAddr, key, common.BytesToHash([]byte&#123;0, 0, 0&#125;))</span><br><span class=\"line\">\tstate.IntermediateRoot(false)</span><br><span class=\"line\">\thash := state.GetState(stateAddr, key)</span><br><span class=\"line\">\tif hash != common.BytesToHash([]byte&#123;0, 0, 0&#125;) &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\terr = trie.TryUpdate([]byte(&quot;anny&quot;), []byte(&quot;0xccccc&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;update err, &quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tt.Log(trie.Hash())</span><br><span class=\"line\">\ttrie.Commit(nil)</span><br><span class=\"line\">\tt.Log(trie.Hash())</span><br><span class=\"line\">\terr = trie.TryUpdate([]byte(&quot;anny&quot;), []byte(&quot;0xccccb&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;update err, &quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\terr = trie.TryUpdate([]byte(&quot;jim&quot;), []byte(&quot;0xbbbbbc&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;update err, &quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ttrie.Commit(nil)</span><br><span class=\"line\">\tt.Log(trie.Hash())</span><br><span class=\"line\">\tstate.SetState(stateAddr, key, trie.Hash())</span><br><span class=\"line\">\thash = state.GetState(stateAddr, key)</span><br><span class=\"line\">\tif hash != trie.Hash() &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ttrie1, err := state.Database().OpenStorageTrie(common.Hash&#123;&#125;, hash)</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tvalue, err := trie1.TryGet([]byte(&quot;anny&quot;))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tif string(value) != &quot;0xccccb&quot; &#123;</span><br><span class=\"line\">\t\tt.Error(&quot;unexpected err&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n"},{"title":"fabric_pbft","date":"2019-04-14T07:06:52.000Z","_content":"\n#### fabric consensus pbft VS neo dbft\n\n\n\n#### pbft\n\n**pbft3pre-prepare, prepare, commit**\n\n3\n\n-  pre-preparepre-prepare\n- pre-prepareprepare\n- prepare(f+1)f+1****commitcommit\n- 1commitf+1\n\n\n\n#### dbft\n\ndbftd\n\n**prepare, prepare-response**\n\n- prepareprepare\n- prepareprepare-response\n- prepare-response\n\n\n\nneodbftprepareresponse\n","source":"_posts/fabric-pbft.md","raw":"---\ntitle: fabric_pbft\ncategories:\n  - fabric\ndate: 2019-4-14 15:06:52\ntags:\n---\n\n#### fabric consensus pbft VS neo dbft\n\n\n\n#### pbft\n\n**pbft3pre-prepare, prepare, commit**\n\n3\n\n-  pre-preparepre-prepare\n- pre-prepareprepare\n- prepare(f+1)f+1****commitcommit\n- 1commitf+1\n\n\n\n#### dbft\n\ndbftd\n\n**prepare, prepare-response**\n\n- prepareprepare\n- prepareprepare-response\n- prepare-response\n\n\n\nneodbftprepareresponse\n","slug":"fabric-pbft","published":1,"updated":"2019-10-14T07:09:50.625Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69tt000tt6xvauuq95uf","content":"<h4 id=\"fabric-consensus-pbft-VS-neo-dbft\"><a href=\"#fabric-consensus-pbft-VS-neo-dbft\" class=\"headerlink\" title=\"fabric consensus pbft VS neo dbft\"></a>fabric consensus pbft VS neo dbft</h4><h4 id=\"pbft\"><a href=\"#pbft\" class=\"headerlink\" title=\"pbft\"></a>pbft</h4><p><strong>pbft3pre-prepare, prepare, commit</strong></p>\n<p>3</p>\n<ul>\n<li> pre-preparepre-prepare</li>\n<li>pre-prepareprepare</li>\n<li>prepare(f+1)f+1<strong></strong>commitcommit</li>\n<li>1commitf+1</li>\n</ul>\n<h4 id=\"dbft\"><a href=\"#dbft\" class=\"headerlink\" title=\"dbft\"></a>dbft</h4><p>dbftd</p>\n<p><strong>prepare, prepare-response</strong></p>\n<ul>\n<li>prepareprepare</li>\n<li>prepareprepare-response</li>\n<li>prepare-response</li>\n</ul>\n<p>neodbftprepareresponse</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h4 id=\"fabric-consensus-pbft-VS-neo-dbft\"><a href=\"#fabric-consensus-pbft-VS-neo-dbft\" class=\"headerlink\" title=\"fabric consensus pbft VS neo dbft\"></a>fabric consensus pbft VS neo dbft</h4><h4 id=\"pbft\"><a href=\"#pbft\" class=\"headerlink\" title=\"pbft\"></a>pbft</h4><p><strong>pbft3pre-prepare, prepare, commit</strong></p>\n<p>3</p>\n<ul>\n<li> pre-preparepre-prepare</li>\n<li>pre-prepareprepare</li>\n<li>prepare(f+1)f+1<strong></strong>commitcommit</li>\n<li>1commitf+1</li>\n</ul>\n<h4 id=\"dbft\"><a href=\"#dbft\" class=\"headerlink\" title=\"dbft\"></a>dbft</h4><p>dbftd</p>\n<p><strong>prepare, prepare-response</strong></p>\n<ul>\n<li>prepareprepare</li>\n<li>prepareprepare-response</li>\n<li>prepare-response</li>\n</ul>\n<p>neodbftprepareresponse</p>\n"},{"title":"fabric_code_consensus_event","date":"2019-04-14T07:07:25.000Z","_content":"\n## fabric consensus event\n\n fabric/consensus/...\n\npbft\n\n\n\n#### Manager \n\n\n\n```\n//ReceiverMagager\ntype Manager interface {\n\tInject(Event)         //Manager\n\tQueue() chan<- Event  //\n\tSetReceiver(Receiver) //Receiver\n\tStart()               // Manager\n\tHalt()                // manager\n}\n```\n\n\n\n##### Receiver\n\n```\ntype Receiver interface {\n\t//Receiver,Event\n\tProcessEvent(e Event) Event\n}\n```\n\n\n\n##### Manager\n\n```\ntype managerImpl struct {\n\tthreaded  //exitHalt\n\treceiver Receiver  //\n\tevents   chan Event //\n}\n```\n\nmanager..\n\n```\nfunc (em *managerImpl) Start() {\n    //\n\tgo em.eventLoop()\n}\nfunc (em *managerImpl) eventLoop() {\n\tfor {\n\t\tselect {\n\t\tcase next := <-em.events:\n\t\t\tem.Inject(next)\n\t\tcase <-em.exit:\n\t\t\tlogger.Debug(\"eventLoop told to exit\")\n\t\t\treturn\n\t\t}\n\t}\n}\n//Eventreceiver\nfunc (em *managerImpl) Inject(event Event) {\n\tif em.receiver != nil {\n\t\tSendEvent(em.receiver, event)\n\t}\n}\n//receiver.PeoceesEvent\nfunc SendEvent(receiver Receiver, event Event) {\n\tnext := event\n\tfor {\n\t\t// ProcessEvent\n\t\tnext = receiver.ProcessEvent(next)\n\t\tif next == nil {\n\t\t\tbreak\n\t\t}\n\t}\n}\n```\n\nProcessEventEventreceiverProcessEventProcessEvent\n\n\n\n#### Timer\n\ngotimetimertimerresetstop\n\ngotimetimetimerstopreset\n\n> ```\n> Stop does not close the channel, to prevent a read from the channel succeeding incorrectly\n> ```\n\nstoptimertickerstop\n\n\n\neventTimer\n\n\n\n```\n// newTimer creates a new instance of timerImpl\nfunc newTimerImpl(manager Manager) Timer {\n\tet := &timerImpl{\n\t\tstartChan: make(chan *timerStart),\n\t\tstopChan:  make(chan struct{}),\n\t\tthreaded:  threaded{make(chan struct{})},\n\t\tmanager:   manager,\n\t}\n\tgo et.loop()\n\treturn et\n}\n```\n\nmanagereventeventmanager.receivermanager\n\n```\nfunc (et *timerImpl) loop() {\n\tvar eventDestChan chan<- Event //\n\tvar event Event //\n\n\tfor {\n\t\tselect {\n\t\tcase start := <-et.startChan:\n\t\t\t//start.durationstart.event\n\t\t\tif et.timerChan != nil {\n\t\t\t\tif start.hard {\n\t\t\t\t\tlogger.Debug(\"Resetting a running timer\")\n\t\t\t\t} else {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t}\n\t\t\tlogger.Debug(\"Starting timer\")\n\t\t\tet.timerChan = time.After(start.duration)\n\t\t\tif eventDestChan != nil {\n\t\t\t\tlogger.Debug(\"Timer cleared pending event\")\n\t\t\t}\n\t\t\tevent = start.event\n\t\t\teventDestChan = nil\n\t\tcase <-et.stopChan:\n\t\t\t//\n\t\t\tif et.timerChan == nil && eventDestChan == nil {\n\t\t\t\tlogger.Debug(\"Attempting to stop an unfired idle timer\")\n\t\t\t}\n\t\t\tet.timerChan = nil\n\t\t\tlogger.Debug(\"Stopping timer\")\n\t\t\tif eventDestChan != nil {\n\t\t\t\tlogger.Debug(\"Timer cleared pending event\")\n\t\t\t}\n\t\t\teventDestChan = nil\n\t\t\tevent = nil\n\t\tcase <-et.timerChan:\n\t\t\t//\n\t\t\tlogger.Debug(\"Event timer fired\")\n\t\t\tet.timerChan = nil\n\t\t\teventDestChan = et.manager.Queue()\n\t\tcase eventDestChan <- event:\n\t\t\t//eventevent eventDestChan <- event\n\t\t\tlogger.Debug(\"Timer event delivered\")\n\t\t\teventDestChan = nil\n\t\tcase <-et.exit:\n\t\t\t//\n\t\t\tlogger.Debug(\"Halting timer\")\n\t\t\treturn\n\t\t}\n\t}\n\n```\n\neventselect**nilselectnil**eventDestChannil, case eventDestChan <- eventeventDestChannilselect\n","source":"_posts/fabric-code-consensus-event.md","raw":"---\ntitle: fabric_code_consensus_event\ncategories:\n  - fabric\ndate: 2019-4-14 15:07:25\ntags:\n---\n\n## fabric consensus event\n\n fabric/consensus/...\n\npbft\n\n\n\n#### Manager \n\n\n\n```\n//ReceiverMagager\ntype Manager interface {\n\tInject(Event)         //Manager\n\tQueue() chan<- Event  //\n\tSetReceiver(Receiver) //Receiver\n\tStart()               // Manager\n\tHalt()                // manager\n}\n```\n\n\n\n##### Receiver\n\n```\ntype Receiver interface {\n\t//Receiver,Event\n\tProcessEvent(e Event) Event\n}\n```\n\n\n\n##### Manager\n\n```\ntype managerImpl struct {\n\tthreaded  //exitHalt\n\treceiver Receiver  //\n\tevents   chan Event //\n}\n```\n\nmanager..\n\n```\nfunc (em *managerImpl) Start() {\n    //\n\tgo em.eventLoop()\n}\nfunc (em *managerImpl) eventLoop() {\n\tfor {\n\t\tselect {\n\t\tcase next := <-em.events:\n\t\t\tem.Inject(next)\n\t\tcase <-em.exit:\n\t\t\tlogger.Debug(\"eventLoop told to exit\")\n\t\t\treturn\n\t\t}\n\t}\n}\n//Eventreceiver\nfunc (em *managerImpl) Inject(event Event) {\n\tif em.receiver != nil {\n\t\tSendEvent(em.receiver, event)\n\t}\n}\n//receiver.PeoceesEvent\nfunc SendEvent(receiver Receiver, event Event) {\n\tnext := event\n\tfor {\n\t\t// ProcessEvent\n\t\tnext = receiver.ProcessEvent(next)\n\t\tif next == nil {\n\t\t\tbreak\n\t\t}\n\t}\n}\n```\n\nProcessEventEventreceiverProcessEventProcessEvent\n\n\n\n#### Timer\n\ngotimetimertimerresetstop\n\ngotimetimetimerstopreset\n\n> ```\n> Stop does not close the channel, to prevent a read from the channel succeeding incorrectly\n> ```\n\nstoptimertickerstop\n\n\n\neventTimer\n\n\n\n```\n// newTimer creates a new instance of timerImpl\nfunc newTimerImpl(manager Manager) Timer {\n\tet := &timerImpl{\n\t\tstartChan: make(chan *timerStart),\n\t\tstopChan:  make(chan struct{}),\n\t\tthreaded:  threaded{make(chan struct{})},\n\t\tmanager:   manager,\n\t}\n\tgo et.loop()\n\treturn et\n}\n```\n\nmanagereventeventmanager.receivermanager\n\n```\nfunc (et *timerImpl) loop() {\n\tvar eventDestChan chan<- Event //\n\tvar event Event //\n\n\tfor {\n\t\tselect {\n\t\tcase start := <-et.startChan:\n\t\t\t//start.durationstart.event\n\t\t\tif et.timerChan != nil {\n\t\t\t\tif start.hard {\n\t\t\t\t\tlogger.Debug(\"Resetting a running timer\")\n\t\t\t\t} else {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t}\n\t\t\tlogger.Debug(\"Starting timer\")\n\t\t\tet.timerChan = time.After(start.duration)\n\t\t\tif eventDestChan != nil {\n\t\t\t\tlogger.Debug(\"Timer cleared pending event\")\n\t\t\t}\n\t\t\tevent = start.event\n\t\t\teventDestChan = nil\n\t\tcase <-et.stopChan:\n\t\t\t//\n\t\t\tif et.timerChan == nil && eventDestChan == nil {\n\t\t\t\tlogger.Debug(\"Attempting to stop an unfired idle timer\")\n\t\t\t}\n\t\t\tet.timerChan = nil\n\t\t\tlogger.Debug(\"Stopping timer\")\n\t\t\tif eventDestChan != nil {\n\t\t\t\tlogger.Debug(\"Timer cleared pending event\")\n\t\t\t}\n\t\t\teventDestChan = nil\n\t\t\tevent = nil\n\t\tcase <-et.timerChan:\n\t\t\t//\n\t\t\tlogger.Debug(\"Event timer fired\")\n\t\t\tet.timerChan = nil\n\t\t\teventDestChan = et.manager.Queue()\n\t\tcase eventDestChan <- event:\n\t\t\t//eventevent eventDestChan <- event\n\t\t\tlogger.Debug(\"Timer event delivered\")\n\t\t\teventDestChan = nil\n\t\tcase <-et.exit:\n\t\t\t//\n\t\t\tlogger.Debug(\"Halting timer\")\n\t\t\treturn\n\t\t}\n\t}\n\n```\n\neventselect**nilselectnil**eventDestChannil, case eventDestChan <- eventeventDestChannilselect\n","slug":"fabric-code-consensus-event","published":1,"updated":"2019-10-14T07:09:44.048Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69tz000wt6xvsu6r1yui","content":"<h2 id=\"fabric-consensus-event\"><a href=\"#fabric-consensus-event\" class=\"headerlink\" title=\"fabric consensus event\"></a>fabric consensus event</h2><p> fabric/consensus/</p>\n<p>pbft</p>\n<h4 id=\"Manager-\"><a href=\"#Manager-\" class=\"headerlink\" title=\"Manager \"></a>Manager </h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//ReceiverMagager</span><br><span class=\"line\">type Manager interface &#123;</span><br><span class=\"line\">\tInject(Event)         //Manager</span><br><span class=\"line\">\tQueue() chan&lt;- Event  //</span><br><span class=\"line\">\tSetReceiver(Receiver) //Receiver</span><br><span class=\"line\">\tStart()               // Manager</span><br><span class=\"line\">\tHalt()                // manager</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Receiver\"><a href=\"#Receiver\" class=\"headerlink\" title=\"Receiver\"></a>Receiver</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Receiver interface &#123;</span><br><span class=\"line\">\t//Receiver,Event</span><br><span class=\"line\">\tProcessEvent(e Event) Event</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Manager\"><a href=\"#Manager\" class=\"headerlink\" title=\"Manager\"></a>Manager</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type managerImpl struct &#123;</span><br><span class=\"line\">\tthreaded  //exitHalt</span><br><span class=\"line\">\treceiver Receiver  //</span><br><span class=\"line\">\tevents   chan Event //</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>manager..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (em *managerImpl) Start() &#123;</span><br><span class=\"line\">    //</span><br><span class=\"line\">\tgo em.eventLoop()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (em *managerImpl) eventLoop() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase next := &lt;-em.events:</span><br><span class=\"line\">\t\t\tem.Inject(next)</span><br><span class=\"line\">\t\tcase &lt;-em.exit:</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;eventLoop told to exit&quot;)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//Eventreceiver</span><br><span class=\"line\">func (em *managerImpl) Inject(event Event) &#123;</span><br><span class=\"line\">\tif em.receiver != nil &#123;</span><br><span class=\"line\">\t\tSendEvent(em.receiver, event)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//receiver.PeoceesEvent</span><br><span class=\"line\">func SendEvent(receiver Receiver, event Event) &#123;</span><br><span class=\"line\">\tnext := event</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\t// ProcessEvent</span><br><span class=\"line\">\t\tnext = receiver.ProcessEvent(next)</span><br><span class=\"line\">\t\tif next == nil &#123;</span><br><span class=\"line\">\t\t\tbreak</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ProcessEventEventreceiverProcessEventProcessEvent</p>\n<h4 id=\"Timer\"><a href=\"#Timer\" class=\"headerlink\" title=\"Timer\"></a>Timer</h4><p>gotimetimertimerresetstop</p>\n<p>gotimetimetimerstopreset</p>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; Stop does not close the channel, to prevent a read from the channel succeeding incorrectly</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>stoptimertickerstop</p>\n<p>eventTimer</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// newTimer creates a new instance of timerImpl</span><br><span class=\"line\">func newTimerImpl(manager Manager) Timer &#123;</span><br><span class=\"line\">\tet := &amp;timerImpl&#123;</span><br><span class=\"line\">\t\tstartChan: make(chan *timerStart),</span><br><span class=\"line\">\t\tstopChan:  make(chan struct&#123;&#125;),</span><br><span class=\"line\">\t\tthreaded:  threaded&#123;make(chan struct&#123;&#125;)&#125;,</span><br><span class=\"line\">\t\tmanager:   manager,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgo et.loop()</span><br><span class=\"line\">\treturn et</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>managereventeventmanager.receivermanager</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (et *timerImpl) loop() &#123;</span><br><span class=\"line\">\tvar eventDestChan chan&lt;- Event //</span><br><span class=\"line\">\tvar event Event //</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase start := &lt;-et.startChan:</span><br><span class=\"line\">\t\t\t//start.durationstart.event</span><br><span class=\"line\">\t\t\tif et.timerChan != nil &#123;</span><br><span class=\"line\">\t\t\t\tif start.hard &#123;</span><br><span class=\"line\">\t\t\t\t\tlogger.Debug(&quot;Resetting a running timer&quot;)</span><br><span class=\"line\">\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\tcontinue</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Starting timer&quot;)</span><br><span class=\"line\">\t\t\tet.timerChan = time.After(start.duration)</span><br><span class=\"line\">\t\t\tif eventDestChan != nil &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Debug(&quot;Timer cleared pending event&quot;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tevent = start.event</span><br><span class=\"line\">\t\t\teventDestChan = nil</span><br><span class=\"line\">\t\tcase &lt;-et.stopChan:</span><br><span class=\"line\">\t\t\t//</span><br><span class=\"line\">\t\t\tif et.timerChan == nil &amp;&amp; eventDestChan == nil &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Debug(&quot;Attempting to stop an unfired idle timer&quot;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tet.timerChan = nil</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Stopping timer&quot;)</span><br><span class=\"line\">\t\t\tif eventDestChan != nil &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Debug(&quot;Timer cleared pending event&quot;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\teventDestChan = nil</span><br><span class=\"line\">\t\t\tevent = nil</span><br><span class=\"line\">\t\tcase &lt;-et.timerChan:</span><br><span class=\"line\">\t\t\t//</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Event timer fired&quot;)</span><br><span class=\"line\">\t\t\tet.timerChan = nil</span><br><span class=\"line\">\t\t\teventDestChan = et.manager.Queue()</span><br><span class=\"line\">\t\tcase eventDestChan &lt;- event:</span><br><span class=\"line\">\t\t\t//eventevent eventDestChan &lt;- event</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Timer event delivered&quot;)</span><br><span class=\"line\">\t\t\teventDestChan = nil</span><br><span class=\"line\">\t\tcase &lt;-et.exit:</span><br><span class=\"line\">\t\t\t//</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Halting timer&quot;)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>eventselect<strong>nilselectnil</strong>eventDestChannil, case eventDestChan &lt;- eventeventDestChannilselect</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"fabric-consensus-event\"><a href=\"#fabric-consensus-event\" class=\"headerlink\" title=\"fabric consensus event\"></a>fabric consensus event</h2><p> fabric/consensus/</p>\n<p>pbft</p>\n<h4 id=\"Manager-\"><a href=\"#Manager-\" class=\"headerlink\" title=\"Manager \"></a>Manager </h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//ReceiverMagager</span><br><span class=\"line\">type Manager interface &#123;</span><br><span class=\"line\">\tInject(Event)         //Manager</span><br><span class=\"line\">\tQueue() chan&lt;- Event  //</span><br><span class=\"line\">\tSetReceiver(Receiver) //Receiver</span><br><span class=\"line\">\tStart()               // Manager</span><br><span class=\"line\">\tHalt()                // manager</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Receiver\"><a href=\"#Receiver\" class=\"headerlink\" title=\"Receiver\"></a>Receiver</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Receiver interface &#123;</span><br><span class=\"line\">\t//Receiver,Event</span><br><span class=\"line\">\tProcessEvent(e Event) Event</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Manager\"><a href=\"#Manager\" class=\"headerlink\" title=\"Manager\"></a>Manager</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type managerImpl struct &#123;</span><br><span class=\"line\">\tthreaded  //exitHalt</span><br><span class=\"line\">\treceiver Receiver  //</span><br><span class=\"line\">\tevents   chan Event //</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>manager..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (em *managerImpl) Start() &#123;</span><br><span class=\"line\">    //</span><br><span class=\"line\">\tgo em.eventLoop()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func (em *managerImpl) eventLoop() &#123;</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase next := &lt;-em.events:</span><br><span class=\"line\">\t\t\tem.Inject(next)</span><br><span class=\"line\">\t\tcase &lt;-em.exit:</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;eventLoop told to exit&quot;)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//Eventreceiver</span><br><span class=\"line\">func (em *managerImpl) Inject(event Event) &#123;</span><br><span class=\"line\">\tif em.receiver != nil &#123;</span><br><span class=\"line\">\t\tSendEvent(em.receiver, event)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//receiver.PeoceesEvent</span><br><span class=\"line\">func SendEvent(receiver Receiver, event Event) &#123;</span><br><span class=\"line\">\tnext := event</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\t// ProcessEvent</span><br><span class=\"line\">\t\tnext = receiver.ProcessEvent(next)</span><br><span class=\"line\">\t\tif next == nil &#123;</span><br><span class=\"line\">\t\t\tbreak</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ProcessEventEventreceiverProcessEventProcessEvent</p>\n<h4 id=\"Timer\"><a href=\"#Timer\" class=\"headerlink\" title=\"Timer\"></a>Timer</h4><p>gotimetimertimerresetstop</p>\n<p>gotimetimetimerstopreset</p>\n<blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; Stop does not close the channel, to prevent a read from the channel succeeding incorrectly</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>stoptimertickerstop</p>\n<p>eventTimer</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// newTimer creates a new instance of timerImpl</span><br><span class=\"line\">func newTimerImpl(manager Manager) Timer &#123;</span><br><span class=\"line\">\tet := &amp;timerImpl&#123;</span><br><span class=\"line\">\t\tstartChan: make(chan *timerStart),</span><br><span class=\"line\">\t\tstopChan:  make(chan struct&#123;&#125;),</span><br><span class=\"line\">\t\tthreaded:  threaded&#123;make(chan struct&#123;&#125;)&#125;,</span><br><span class=\"line\">\t\tmanager:   manager,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgo et.loop()</span><br><span class=\"line\">\treturn et</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>managereventeventmanager.receivermanager</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (et *timerImpl) loop() &#123;</span><br><span class=\"line\">\tvar eventDestChan chan&lt;- Event //</span><br><span class=\"line\">\tvar event Event //</span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase start := &lt;-et.startChan:</span><br><span class=\"line\">\t\t\t//start.durationstart.event</span><br><span class=\"line\">\t\t\tif et.timerChan != nil &#123;</span><br><span class=\"line\">\t\t\t\tif start.hard &#123;</span><br><span class=\"line\">\t\t\t\t\tlogger.Debug(&quot;Resetting a running timer&quot;)</span><br><span class=\"line\">\t\t\t\t&#125; else &#123;</span><br><span class=\"line\">\t\t\t\t\tcontinue</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Starting timer&quot;)</span><br><span class=\"line\">\t\t\tet.timerChan = time.After(start.duration)</span><br><span class=\"line\">\t\t\tif eventDestChan != nil &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Debug(&quot;Timer cleared pending event&quot;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tevent = start.event</span><br><span class=\"line\">\t\t\teventDestChan = nil</span><br><span class=\"line\">\t\tcase &lt;-et.stopChan:</span><br><span class=\"line\">\t\t\t//</span><br><span class=\"line\">\t\t\tif et.timerChan == nil &amp;&amp; eventDestChan == nil &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Debug(&quot;Attempting to stop an unfired idle timer&quot;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tet.timerChan = nil</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Stopping timer&quot;)</span><br><span class=\"line\">\t\t\tif eventDestChan != nil &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Debug(&quot;Timer cleared pending event&quot;)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\teventDestChan = nil</span><br><span class=\"line\">\t\t\tevent = nil</span><br><span class=\"line\">\t\tcase &lt;-et.timerChan:</span><br><span class=\"line\">\t\t\t//</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Event timer fired&quot;)</span><br><span class=\"line\">\t\t\tet.timerChan = nil</span><br><span class=\"line\">\t\t\teventDestChan = et.manager.Queue()</span><br><span class=\"line\">\t\tcase eventDestChan &lt;- event:</span><br><span class=\"line\">\t\t\t//eventevent eventDestChan &lt;- event</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Timer event delivered&quot;)</span><br><span class=\"line\">\t\t\teventDestChan = nil</span><br><span class=\"line\">\t\tcase &lt;-et.exit:</span><br><span class=\"line\">\t\t\t//</span><br><span class=\"line\">\t\t\tlogger.Debug(&quot;Halting timer&quot;)</span><br><span class=\"line\">\t\t\treturn</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<p>eventselect<strong>nilselectnil</strong>eventDestChannil, case eventDestChan &lt;- eventeventDestChannilselect</p>\n"},{"title":"fabric_performance","date":"2019-10-14T07:08:12.000Z","_content":"\n\n\n## \n\n##### \n\n- order: kafkakafka\n- peer \n- http  peerorder\n- 12\n\n##### \n\n- 148g\n- 248g\n- 348g\n- kafka\n\n:  512KB2.9KB173\n\n##### \n\n| 1         | 2        | 3                   |\n| ------------- | ------------ | ----------------------- |\n| order * 3 | peer * 1 | http  * 1 |\n\n\n\n|  |  |\n| ------------ | ------------ |\n| 1400         | -            |\n\n**** http peerorderorderkafka()order()**0**\n\n\n\n#### \n\n\n\n1500KB29KB500\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1500         | 1500     | -            |\n\n\n\n#### \n\npeer\n\n##### \n\n| 1         | 2                      | 3                   |\n| ------------- | -------------------------- | ----------------------- |\n| order * 3 | peer * 1peer * 1 | http  * 2 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1000         | 8000*2   | 1800         |\n\n****\n\npeerpeer..\n\nhttp peer\n\n\n\n#### \n\n\n\n- 448g\n- 548g\n\n##### \n\n| 1         | 2        | 3        | 4                   | 5                   |\n| ------------- | ------------ | ------------ | ----------------------- | ----------------------- |\n| order * 3 | peer * 1 | peer * 1 | http  * 1 | http  * 1 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1300         | 1400 * 2 | 2200         |\n\n****\n\n\n\n1peer...\n\n\n\n#### \n\norder1816g17002peer1peer..\n\nkafka.. \n\n\n\n#### \n\npeerpeer23816g\n\n##### \n\n| 1816g   | 2816g  | 4                   |\n| ------------- | ------------ | ----------------------- |\n| order * 3 | peer * 1 | http  * 1 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1800         | 1800     | -            |\n\n##### \n\n| 1816g   | 2816g  | 3816g  | 4                   | 5                   |\n| ------------- | ------------ | ------------ | ----------------------- | ----------------------- |\n| order * 3 | peer * 1 | peer * 1 | http  * 1 | http  * 1 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 2600         | 1700 * 2 | 3500         |\n\n****\n\n1peer1800\n\n1peer22600http3500\n\n\n\n### \n\n()peertps816gpeerpeertps18002600\n\npeer()\n","source":"_posts/fabric-performance.md","raw":"---\ntitle: fabric_performance\ncategories:\n  - fabric\ndate: 2019-10-14 15:08:12\ntags:\n---\n\n\n\n## \n\n##### \n\n- order: kafkakafka\n- peer \n- http  peerorder\n- 12\n\n##### \n\n- 148g\n- 248g\n- 348g\n- kafka\n\n:  512KB2.9KB173\n\n##### \n\n| 1         | 2        | 3                   |\n| ------------- | ------------ | ----------------------- |\n| order * 3 | peer * 1 | http  * 1 |\n\n\n\n|  |  |\n| ------------ | ------------ |\n| 1400         | -            |\n\n**** http peerorderorderkafka()order()**0**\n\n\n\n#### \n\n\n\n1500KB29KB500\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1500         | 1500     | -            |\n\n\n\n#### \n\npeer\n\n##### \n\n| 1         | 2                      | 3                   |\n| ------------- | -------------------------- | ----------------------- |\n| order * 3 | peer * 1peer * 1 | http  * 2 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1000         | 8000*2   | 1800         |\n\n****\n\npeerpeer..\n\nhttp peer\n\n\n\n#### \n\n\n\n- 448g\n- 548g\n\n##### \n\n| 1         | 2        | 3        | 4                   | 5                   |\n| ------------- | ------------ | ------------ | ----------------------- | ----------------------- |\n| order * 3 | peer * 1 | peer * 1 | http  * 1 | http  * 1 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1300         | 1400 * 2 | 2200         |\n\n****\n\n\n\n1peer...\n\n\n\n#### \n\norder1816g17002peer1peer..\n\nkafka.. \n\n\n\n#### \n\npeerpeer23816g\n\n##### \n\n| 1816g   | 2816g  | 4                   |\n| ------------- | ------------ | ----------------------- |\n| order * 3 | peer * 1 | http  * 1 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 1800         | 1800     | -            |\n\n##### \n\n| 1816g   | 2816g  | 3816g  | 4                   | 5                   |\n| ------------- | ------------ | ------------ | ----------------------- | ----------------------- |\n| order * 3 | peer * 1 | peer * 1 | http  * 1 | http  * 1 |\n\n\n\n|  |  |  |\n| ------------ | -------- | ------------ |\n| 2600         | 1700 * 2 | 3500         |\n\n****\n\n1peer1800\n\n1peer22600http3500\n\n\n\n### \n\n()peertps816gpeerpeertps18002600\n\npeer()\n","slug":"fabric-performance","published":1,"updated":"2019-10-14T07:08:27.722Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69u3000yt6xvl3p0o8tn","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li>order: kafkakafka</li>\n<li>peer </li>\n<li>http  peerorder</li>\n<li>12</li>\n</ul>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li>148g</li>\n<li>248g</li>\n<li>348g</li>\n<li>kafka</li>\n</ul>\n<p>:  512KB2.9KB173</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1400</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<p><strong></strong> http peerorderorderkafka()order()<strong>0</strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>1500KB29KB500</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1500</td>\n<td>1500</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>peer</p>\n<h5 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1peer * 1</td>\n<td>http  * 2</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1000</td>\n<td>8000*2</td>\n<td>1800</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>peerpeer..</p>\n<p>http peer</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>448g</li>\n<li>548g</li>\n</ul>\n<h5 id=\"-2\"><a href=\"#-2\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n<th>4</th>\n<th>5</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1300</td>\n<td>1400 * 2</td>\n<td>2200</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p></p>\n<p>1peer</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>order1816g17002peer1peer..</p>\n<p>kafka.. </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>peerpeer23816g</p>\n<h5 id=\"-3\"><a href=\"#-3\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1816g</th>\n<th>2816g</th>\n<th>4</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1800</td>\n<td>1800</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<h5 id=\"-4\"><a href=\"#-4\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1816g</th>\n<th>2816g</th>\n<th>3816g</th>\n<th>4</th>\n<th>5</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>2600</td>\n<td>1700 * 2</td>\n<td>3500</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>1peer1800</p>\n<p>1peer22600http3500</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>()peertps816gpeerpeertps18002600</p>\n<p>peer()</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li>order: kafkakafka</li>\n<li>peer </li>\n<li>http  peerorder</li>\n<li>12</li>\n</ul>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li>148g</li>\n<li>248g</li>\n<li>348g</li>\n<li>kafka</li>\n</ul>\n<p>:  512KB2.9KB173</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1400</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<p><strong></strong> http peerorderorderkafka()order()<strong>0</strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<p>1500KB29KB500</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1500</td>\n<td>1500</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>peer</p>\n<h5 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1peer * 1</td>\n<td>http  * 2</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1000</td>\n<td>8000*2</td>\n<td>1800</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>peerpeer..</p>\n<p>http peer</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>448g</li>\n<li>548g</li>\n</ul>\n<h5 id=\"-2\"><a href=\"#-2\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1</th>\n<th>2</th>\n<th>3</th>\n<th>4</th>\n<th>5</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1300</td>\n<td>1400 * 2</td>\n<td>2200</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p></p>\n<p>1peer</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>order1816g17002peer1peer..</p>\n<p>kafka.. </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>peerpeer23816g</p>\n<h5 id=\"-3\"><a href=\"#-3\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1816g</th>\n<th>2816g</th>\n<th>4</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1800</td>\n<td>1800</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<h5 id=\"-4\"><a href=\"#-4\" class=\"headerlink\" title=\"\"></a></h5><table>\n<thead>\n<tr>\n<th>1816g</th>\n<th>2816g</th>\n<th>3816g</th>\n<th>4</th>\n<th>5</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>order * 3</td>\n<td>peer * 1</td>\n<td>peer * 1</td>\n<td>http  * 1</td>\n<td>http  * 1</td>\n</tr>\n</tbody></table>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>2600</td>\n<td>1700 * 2</td>\n<td>3500</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>1peer1800</p>\n<p>1peer22600http3500</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>()peertps816gpeerpeertps18002600</p>\n<p>peer()</p>\n"},{"title":"floodlight_sdn","date":"2017-10-14T05:56:22.000Z","_content":"\n## SDN\n\n- \n- \n- \n- \n- \n\n\"SDN\"\n\n> SDN\n\n  ->  -> \n\n#### SDN \n\n\n\n> \n\n****OpenFlow:  +  + MACMAC\n\n#### \n\n> SDNSDNONFOpenFlow\n\n#### \n\n> SDN\n\n> REST API\n\nBuilderproduction(Buidlerproductionproduction(Pre-v1.0Floodlight v1.0, v1.1, v1.2readme)\n\nFloodloghtswitchesswitchOpenflowswitch,OpenflowswicthcontrollerswitchIOFSwitch, IOFSwitchgetOFFactoryOpenFlowJ-LoxiswitchOpenFlowOpenFlowJ-LoxiAPIOpenFlow\n\nFlowModsApiFlowModswitchOFSwitchManagerswitchOpenFlowswitchcontrollerswitchbuidlerFlowMod, switch.OpenFlowOpenFlowAPIOpenFlowOpenFlow1.0switch1.0OpenFlowJ-LoxiUnsupportedOperationException\n\ndatapath ids, openflow ports, ip mac OpenFlowJ-LoxiDatapathId, OFPort, IPv4Address/IPv6Address, and MacAddressorg.projectfloodlight.openflow.typesbuidlersproduced\n\nAPIFloodlight v1.2OpenFlowJ-Loxi\n","source":"_posts/floodlight-sdn.md","raw":"---\ntitle: floodlight_sdn\ndate: 2017-10-14 13:56:22\ncategories:\n- enjoy\n---\n\n## SDN\n\n- \n- \n- \n- \n- \n\n\"SDN\"\n\n> SDN\n\n  ->  -> \n\n#### SDN \n\n\n\n> \n\n****OpenFlow:  +  + MACMAC\n\n#### \n\n> SDNSDNONFOpenFlow\n\n#### \n\n> SDN\n\n> REST API\n\nBuilderproduction(Buidlerproductionproduction(Pre-v1.0Floodlight v1.0, v1.1, v1.2readme)\n\nFloodloghtswitchesswitchOpenflowswitch,OpenflowswicthcontrollerswitchIOFSwitch, IOFSwitchgetOFFactoryOpenFlowJ-LoxiswitchOpenFlowOpenFlowJ-LoxiAPIOpenFlow\n\nFlowModsApiFlowModswitchOFSwitchManagerswitchOpenFlowswitchcontrollerswitchbuidlerFlowMod, switch.OpenFlowOpenFlowAPIOpenFlowOpenFlow1.0switch1.0OpenFlowJ-LoxiUnsupportedOperationException\n\ndatapath ids, openflow ports, ip mac OpenFlowJ-LoxiDatapathId, OFPort, IPv4Address/IPv6Address, and MacAddressorg.projectfloodlight.openflow.typesbuidlersproduced\n\nAPIFloodlight v1.2OpenFlowJ-Loxi\n","slug":"floodlight-sdn","published":1,"updated":"2019-10-14T06:21:47.845Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69u50011t6xvixx4owv1","content":"<h2 id=\"SDN\"><a href=\"#SDN\" class=\"headerlink\" title=\"SDN\"></a>SDN</h2><ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p>SDN</p>\n<blockquote>\n<p>SDN</p>\n</blockquote>\n<p>  -&gt;  -&gt; </p>\n<h4 id=\"SDN-\"><a href=\"#SDN-\" class=\"headerlink\" title=\"SDN \"></a>SDN </h4><p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><strong></strong>OpenFlow:  +  + MACMAC</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>SDNSDNONFOpenFlow</p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>SDN</p>\n</blockquote>\n<blockquote>\n<p>REST API</p>\n</blockquote>\n<p>Builderproduction(Buidlerproductionproduction(Pre-v1.0Floodlight v1.0, v1.1, v1.2readme)</p>\n<p>FloodloghtswitchesswitchOpenflowswitch,OpenflowswicthcontrollerswitchIOFSwitch, IOFSwitchgetOFFactoryOpenFlowJ-LoxiswitchOpenFlowOpenFlowJ-LoxiAPIOpenFlow</p>\n<p>FlowModsApiFlowModswitchOFSwitchManagerswitchOpenFlowswitchcontrollerswitchbuidlerFlowMod, switch.OpenFlowOpenFlowAPIOpenFlowOpenFlow1.0switch1.0OpenFlowJ-LoxiUnsupportedOperationException</p>\n<p>datapath ids, openflow ports, ip mac OpenFlowJ-LoxiDatapathId, OFPort, IPv4Address/IPv6Address, and MacAddressorg.projectfloodlight.openflow.typesbuidlersproduced</p>\n<p>APIFloodlight v1.2OpenFlowJ-Loxi</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"SDN\"><a href=\"#SDN\" class=\"headerlink\" title=\"SDN\"></a>SDN</h2><ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p>SDN</p>\n<blockquote>\n<p>SDN</p>\n</blockquote>\n<p>  -&gt;  -&gt; </p>\n<h4 id=\"SDN-\"><a href=\"#SDN-\" class=\"headerlink\" title=\"SDN \"></a>SDN </h4><p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><strong></strong>OpenFlow:  +  + MACMAC</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>SDNSDNONFOpenFlow</p>\n</blockquote>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><blockquote>\n<p>SDN</p>\n</blockquote>\n<blockquote>\n<p>REST API</p>\n</blockquote>\n<p>Builderproduction(Buidlerproductionproduction(Pre-v1.0Floodlight v1.0, v1.1, v1.2readme)</p>\n<p>FloodloghtswitchesswitchOpenflowswitch,OpenflowswicthcontrollerswitchIOFSwitch, IOFSwitchgetOFFactoryOpenFlowJ-LoxiswitchOpenFlowOpenFlowJ-LoxiAPIOpenFlow</p>\n<p>FlowModsApiFlowModswitchOFSwitchManagerswitchOpenFlowswitchcontrollerswitchbuidlerFlowMod, switch.OpenFlowOpenFlowAPIOpenFlowOpenFlow1.0switch1.0OpenFlowJ-LoxiUnsupportedOperationException</p>\n<p>datapath ids, openflow ports, ip mac OpenFlowJ-LoxiDatapathId, OFPort, IPv4Address/IPv6Address, and MacAddressorg.projectfloodlight.openflow.typesbuidlersproduced</p>\n<p>APIFloodlight v1.2OpenFlowJ-Loxi</p>\n"},{"title":"how to set up a blog","date":"2019-10-12T03:32:16.000Z","_content":"## \n\n<font size=\"1\">3()</font>\n\n### \n\nGithub Pages + Travis + Hexo\n\n\n\n### Hexo\n\nHexoNode.js \n\n##### \n\ngitnodejs\n\n```\nnpm install -g hexo-cli \n```\n\nhexo-clihexo\n\n```\nhexo init [dir]\n```\n\n\n\n\n\n```\n.\n _config.yml\n package.json\n scaffolds   //\n source   //\n themes  //\n```\n\nhexo\n\n```\nhexo --help\nUsage: hexo <command>\n\nCommands:\n  clean     Remove generated files and cache.\n  config    Get or set configurations.\n  deploy    Deploy your website.\n  generate  Generate static files.\n  help      Get help on a command.\n  init      Create a new Hexo folder.\n  list      List the information of the site\n  migrate   Migrate your site from other system to Hexo.\n  new       Create a new post.\n  publish   Moves a draft post from _drafts to _posts folder.\n  render    Render files with renderer plugins.\n  server    Start the server.\n```\n\ngenerate`public`servernode\n\n hexoserverserver` npm install hexo-server --save`\n\ntheme[cactus](https://github.com/probberechts/hexo-theme-cactus)\n\n\n\n### Github Pages\n\n> [GitHub Pages](https://pages.github.com/) is designed to host your personal, organization, or project pages from a GitHub repository.\n>\n>  Your site is published at https://xiaoxuez.github.io/\n\ngithubgithub`https://username.github.io`\n\n<font size=2></font>\n\nsettingGithub Pagesusername.github.iomaster\n\n\n\n### Travis\n\n[travis]([https://travis-ci.com](https://travis-ci.com/))\n\n`public``public`Github Pages`public`\n\ntravispush`hexo generate``public`push\n\ntravis[](https://docs.travis-ci.com/)\n\n`.travis.yaml`\n\n```\nsudo: false\nlanguage: node_js\nnode_js:\n  - 10 # use nodejs v10 LTS\ncache: npm\nbranches:\n  only:\n    - resource # build master branch only\nscript:\n  - hexo generate # generate static files\ndeploy:\n  provider: pages\n  skip-cleanup: true\n  github-token: $GH_TOKEN\n  keep-history: true\n  on:\n    branch: resource  //resource\n  local-dir: public\n  target_branch: master  //master\n\n```\n\ntarget_branch`gh-pages``xiaoxuez.github.io`master`hexo generate``public`msterdeploy[](https://docs.travis-ci.com/user/deployment/pages/)\n\ngithubtravis[](https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line)Token[travis](https://docs.travis-ci.com/user/environment-variables#defining-variables-in-repository-settings)\n\n\n\ngithubpersonal settingsApplicaitonstravistravis\n\n\n","source":"_posts/how-to-set-up-a-blog.md","raw":"---\ntitle: how to set up a blog\ndate: 2019-10-12 11:32:16\ntags:\ncategories:\n- enjoyment\n---\n## \n\n<font size=\"1\">3()</font>\n\n### \n\nGithub Pages + Travis + Hexo\n\n\n\n### Hexo\n\nHexoNode.js \n\n##### \n\ngitnodejs\n\n```\nnpm install -g hexo-cli \n```\n\nhexo-clihexo\n\n```\nhexo init [dir]\n```\n\n\n\n\n\n```\n.\n _config.yml\n package.json\n scaffolds   //\n source   //\n themes  //\n```\n\nhexo\n\n```\nhexo --help\nUsage: hexo <command>\n\nCommands:\n  clean     Remove generated files and cache.\n  config    Get or set configurations.\n  deploy    Deploy your website.\n  generate  Generate static files.\n  help      Get help on a command.\n  init      Create a new Hexo folder.\n  list      List the information of the site\n  migrate   Migrate your site from other system to Hexo.\n  new       Create a new post.\n  publish   Moves a draft post from _drafts to _posts folder.\n  render    Render files with renderer plugins.\n  server    Start the server.\n```\n\ngenerate`public`servernode\n\n hexoserverserver` npm install hexo-server --save`\n\ntheme[cactus](https://github.com/probberechts/hexo-theme-cactus)\n\n\n\n### Github Pages\n\n> [GitHub Pages](https://pages.github.com/) is designed to host your personal, organization, or project pages from a GitHub repository.\n>\n>  Your site is published at https://xiaoxuez.github.io/\n\ngithubgithub`https://username.github.io`\n\n<font size=2></font>\n\nsettingGithub Pagesusername.github.iomaster\n\n\n\n### Travis\n\n[travis]([https://travis-ci.com](https://travis-ci.com/))\n\n`public``public`Github Pages`public`\n\ntravispush`hexo generate``public`push\n\ntravis[](https://docs.travis-ci.com/)\n\n`.travis.yaml`\n\n```\nsudo: false\nlanguage: node_js\nnode_js:\n  - 10 # use nodejs v10 LTS\ncache: npm\nbranches:\n  only:\n    - resource # build master branch only\nscript:\n  - hexo generate # generate static files\ndeploy:\n  provider: pages\n  skip-cleanup: true\n  github-token: $GH_TOKEN\n  keep-history: true\n  on:\n    branch: resource  //resource\n  local-dir: public\n  target_branch: master  //master\n\n```\n\ntarget_branch`gh-pages``xiaoxuez.github.io`master`hexo generate``public`msterdeploy[](https://docs.travis-ci.com/user/deployment/pages/)\n\ngithubtravis[](https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line)Token[travis](https://docs.travis-ci.com/user/environment-variables#defining-variables-in-repository-settings)\n\n\n\ngithubpersonal settingsApplicaitonstravistravis\n\n\n","slug":"how-to-set-up-a-blog","published":1,"updated":"2019-10-14T02:31:17.620Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69u70013t6xv76lf3sqm","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><font size=\"1\">3()</font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Github Pages + Travis + Hexo</p>\n<h3 id=\"Hexo\"><a href=\"#Hexo\" class=\"headerlink\" title=\"Hexo\"></a>Hexo</h3><p>HexoNode.js </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>gitnodejs</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>\n\n<p>hexo-clihexo</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo init [dir]</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\"> _config.yml</span><br><span class=\"line\"> package.json</span><br><span class=\"line\"> scaffolds   //</span><br><span class=\"line\"> source   //</span><br><span class=\"line\"> themes  //</span><br></pre></td></tr></table></figure>\n\n<p>hexo</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo --help</span><br><span class=\"line\">Usage: hexo &lt;command&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  clean     Remove generated files and cache.</span><br><span class=\"line\">  config    Get or set configurations.</span><br><span class=\"line\">  deploy    Deploy your website.</span><br><span class=\"line\">  generate  Generate static files.</span><br><span class=\"line\">  help      Get help on a command.</span><br><span class=\"line\">  init      Create a new Hexo folder.</span><br><span class=\"line\">  list      List the information of the site</span><br><span class=\"line\">  migrate   Migrate your site from other system to Hexo.</span><br><span class=\"line\">  new       Create a new post.</span><br><span class=\"line\">  publish   Moves a draft post from _drafts to _posts folder.</span><br><span class=\"line\">  render    Render files with renderer plugins.</span><br><span class=\"line\">  server    Start the server.</span><br></pre></td></tr></table></figure>\n\n<p>generate<code>public</code>servernode</p>\n<p> hexoserverserver<code>npm install hexo-server --save</code></p>\n<p>theme<a href=\"https://github.com/probberechts/hexo-theme-cactus\">cactus</a></p>\n<h3 id=\"Github-Pages\"><a href=\"#Github-Pages\" class=\"headerlink\" title=\"Github Pages\"></a>Github Pages</h3><blockquote>\n<p><a href=\"https://pages.github.com/\" target=\"_blank\" rel=\"noopener\">GitHub Pages</a> is designed to host your personal, organization, or project pages from a GitHub repository.</p>\n<p> Your site is published at <a href=\"https://xiaoxuez.github.io/\" target=\"_blank\" rel=\"noopener\">https://xiaoxuez.github.io/</a></p>\n</blockquote>\n<p>githubgithub<code>https://username.github.io</code></p>\n<p><font size=\"2\"></font></p>\n<p>settingGithub Pagesusername.github.iomaster</p>\n<h3 id=\"Travis\"><a href=\"#Travis\" class=\"headerlink\" title=\"Travis\"></a>Travis</h3><p><a href=\"[https://travis-ci.com](https://travis-ci.com/)\">travis</a></p>\n<p><code>public</code><code>public</code>Github Pages<code>public</code></p>\n<p>travispush<code>hexo generate</code><code>public</code>push</p>\n<p>travis<a href=\"https://docs.travis-ci.com/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p><code>.travis.yaml</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo: false</span><br><span class=\"line\">language: node_js</span><br><span class=\"line\">node_js:</span><br><span class=\"line\">  - 10 # use nodejs v10 LTS</span><br><span class=\"line\">cache: npm</span><br><span class=\"line\">branches:</span><br><span class=\"line\">  only:</span><br><span class=\"line\">    - resource # build master branch only</span><br><span class=\"line\">script:</span><br><span class=\"line\">  - hexo generate # generate static files</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  provider: pages</span><br><span class=\"line\">  skip-cleanup: true</span><br><span class=\"line\">  github-token: $GH_TOKEN</span><br><span class=\"line\">  keep-history: true</span><br><span class=\"line\">  on:</span><br><span class=\"line\">    branch: resource  //resource</span><br><span class=\"line\">  local-dir: public</span><br><span class=\"line\">  target_branch: master  //master</span><br></pre></td></tr></table></figure>\n\n<p>target_branch<code>gh-pages</code><code>xiaoxuez.github.io</code>master<code>hexo generate</code><code>public</code>msterdeploy<a href=\"https://docs.travis-ci.com/user/deployment/pages/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>githubtravis<a href=\"https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line\" target=\"_blank\" rel=\"noopener\"></a>Token<a href=\"https://docs.travis-ci.com/user/environment-variables#defining-variables-in-repository-settings\" target=\"_blank\" rel=\"noopener\">travis</a></p>\n<p></p>\n<p>githubpersonal settingsApplicaitonstravistravis</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><font size=\"1\">3()</font></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>Github Pages + Travis + Hexo</p>\n<h3 id=\"Hexo\"><a href=\"#Hexo\" class=\"headerlink\" title=\"Hexo\"></a>Hexo</h3><p>HexoNode.js </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>gitnodejs</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>\n\n<p>hexo-clihexo</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo init [dir]</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\"> _config.yml</span><br><span class=\"line\"> package.json</span><br><span class=\"line\"> scaffolds   //</span><br><span class=\"line\"> source   //</span><br><span class=\"line\"> themes  //</span><br></pre></td></tr></table></figure>\n\n<p>hexo</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo --help</span><br><span class=\"line\">Usage: hexo &lt;command&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  clean     Remove generated files and cache.</span><br><span class=\"line\">  config    Get or set configurations.</span><br><span class=\"line\">  deploy    Deploy your website.</span><br><span class=\"line\">  generate  Generate static files.</span><br><span class=\"line\">  help      Get help on a command.</span><br><span class=\"line\">  init      Create a new Hexo folder.</span><br><span class=\"line\">  list      List the information of the site</span><br><span class=\"line\">  migrate   Migrate your site from other system to Hexo.</span><br><span class=\"line\">  new       Create a new post.</span><br><span class=\"line\">  publish   Moves a draft post from _drafts to _posts folder.</span><br><span class=\"line\">  render    Render files with renderer plugins.</span><br><span class=\"line\">  server    Start the server.</span><br></pre></td></tr></table></figure>\n\n<p>generate<code>public</code>servernode</p>\n<p> hexoserverserver<code>npm install hexo-server --save</code></p>\n<p>theme<a href=\"https://github.com/probberechts/hexo-theme-cactus\">cactus</a></p>\n<h3 id=\"Github-Pages\"><a href=\"#Github-Pages\" class=\"headerlink\" title=\"Github Pages\"></a>Github Pages</h3><blockquote>\n<p><a href=\"https://pages.github.com/\" target=\"_blank\" rel=\"noopener\">GitHub Pages</a> is designed to host your personal, organization, or project pages from a GitHub repository.</p>\n<p> Your site is published at <a href=\"https://xiaoxuez.github.io/\" target=\"_blank\" rel=\"noopener\">https://xiaoxuez.github.io/</a></p>\n</blockquote>\n<p>githubgithub<code>https://username.github.io</code></p>\n<p><font size=\"2\"></font></p>\n<p>settingGithub Pagesusername.github.iomaster</p>\n<h3 id=\"Travis\"><a href=\"#Travis\" class=\"headerlink\" title=\"Travis\"></a>Travis</h3><p><a href=\"[https://travis-ci.com](https://travis-ci.com/)\">travis</a></p>\n<p><code>public</code><code>public</code>Github Pages<code>public</code></p>\n<p>travispush<code>hexo generate</code><code>public</code>push</p>\n<p>travis<a href=\"https://docs.travis-ci.com/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p><code>.travis.yaml</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo: false</span><br><span class=\"line\">language: node_js</span><br><span class=\"line\">node_js:</span><br><span class=\"line\">  - 10 # use nodejs v10 LTS</span><br><span class=\"line\">cache: npm</span><br><span class=\"line\">branches:</span><br><span class=\"line\">  only:</span><br><span class=\"line\">    - resource # build master branch only</span><br><span class=\"line\">script:</span><br><span class=\"line\">  - hexo generate # generate static files</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  provider: pages</span><br><span class=\"line\">  skip-cleanup: true</span><br><span class=\"line\">  github-token: $GH_TOKEN</span><br><span class=\"line\">  keep-history: true</span><br><span class=\"line\">  on:</span><br><span class=\"line\">    branch: resource  //resource</span><br><span class=\"line\">  local-dir: public</span><br><span class=\"line\">  target_branch: master  //master</span><br></pre></td></tr></table></figure>\n\n<p>target_branch<code>gh-pages</code><code>xiaoxuez.github.io</code>master<code>hexo generate</code><code>public</code>msterdeploy<a href=\"https://docs.travis-ci.com/user/deployment/pages/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>githubtravis<a href=\"https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line\" target=\"_blank\" rel=\"noopener\"></a>Token<a href=\"https://docs.travis-ci.com/user/environment-variables#defining-variables-in-repository-settings\" target=\"_blank\" rel=\"noopener\">travis</a></p>\n<p></p>\n<p>githubpersonal settingsApplicaitonstravistravis</p>\n"},{"title":"kibana_plugin_development","date":"2017-10-14T05:55:13.000Z","_content":"## Kibana\n\n\n\n- [trumandu-tutorial](https://trumandu.gitbooks.io/kibana-plugin-development-tutorial/content/)\n- [timroes.de](https://www.timroes.de/2015/12/02/writing-kibana-4-plugins-basics/)\n\n### Kibana\n\n- githubkibanakibanakibanaapikibanakibana5.3.4\n\n- npm install\n\n  - githubgitsshhttp\n\n    ```\n    git config --global url.\"https://\".insteadOf \"git://\"\n    //.gitconfig\n    [url \"https://\"]\n    insteadOf = git://\n    ```\n\n  - \n\n- npm start, dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js\n\n  ```\n  if (opts.dev) {\n      set('env', 'development');\n      set('optimize.lazy', true);\n\n      // if (opts.ssl) {\n      //   set('server.ssl.enabled', true);\n      // }\n\n      // if (opts.ssl && !has('server.ssl.certificate') && !has('server.ssl.key')) {\n      //   set('server.ssl.certificate', DEV_SSL_CERT_PATH);\n      //   set('server.ssl.key', DEV_SSL_KEY_PATH);\n      // }\n    }\n  ```\n\n### \n\nkibanapluginsKibanawatchchanges(/)\n\nkibanaconsole\n\n```\nrestarting server due to changes in\n - \"installedPlugins/tr-k4p-clock/index.js\"\nserver log [21:49:59.323] [info][status][plugin:tr-k4p-clock] Status changed from uninitialized to green - Ready\n[...]\nserver log [21:49:59.421] [info][listening] Server running at http://0.0.0.0:5601\noptmzr log [21:50:07.177] [info][optimize] Lazy optimization started\noptmzr log [21:50:13.834] [info][optimize] Lazy optimization success in 6.66 seconds\n```\n\n(kibana)\n\n#### \n\nnpm module,package.jsonindex.js\n\npackage.json, nameplugins/kibana\\_gm\\_cal\\_vis/,index,\n\n```\n{\n  \"name\": \"kibana_gm_cal_vis\",\n  \"version\": \"0.1.0\",\n  \"kibana\": {\n    \"version\": \"5.3.4\"\n  }\n}\n```\n\nindex.js\n\n```\nmodule.exports = function(kibana) {\n  return new kibana.Plugin({\n    uiExports: {\n      visTypes: ['plugins/kibana_gm_cal_vis/gm_cal']\n    }\n  });\n};\n```\n\n#### \n\nKibana\n\n```\nbin/kibana plugin --install plugin-name -u https://url.to/plugin\n```\n\nplugins\n\nkibana-docker/usr/share/kibana/plugins/plugin-namerun..\n","source":"_posts/kibana-plugin-development.md","raw":"---\ntitle: kibana_plugin_development\ndate: 2017-10-14 13:55:13\ncategories:\n- elk\n---\n## Kibana\n\n\n\n- [trumandu-tutorial](https://trumandu.gitbooks.io/kibana-plugin-development-tutorial/content/)\n- [timroes.de](https://www.timroes.de/2015/12/02/writing-kibana-4-plugins-basics/)\n\n### Kibana\n\n- githubkibanakibanakibanaapikibanakibana5.3.4\n\n- npm install\n\n  - githubgitsshhttp\n\n    ```\n    git config --global url.\"https://\".insteadOf \"git://\"\n    //.gitconfig\n    [url \"https://\"]\n    insteadOf = git://\n    ```\n\n  - \n\n- npm start, dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js\n\n  ```\n  if (opts.dev) {\n      set('env', 'development');\n      set('optimize.lazy', true);\n\n      // if (opts.ssl) {\n      //   set('server.ssl.enabled', true);\n      // }\n\n      // if (opts.ssl && !has('server.ssl.certificate') && !has('server.ssl.key')) {\n      //   set('server.ssl.certificate', DEV_SSL_CERT_PATH);\n      //   set('server.ssl.key', DEV_SSL_KEY_PATH);\n      // }\n    }\n  ```\n\n### \n\nkibanapluginsKibanawatchchanges(/)\n\nkibanaconsole\n\n```\nrestarting server due to changes in\n - \"installedPlugins/tr-k4p-clock/index.js\"\nserver log [21:49:59.323] [info][status][plugin:tr-k4p-clock] Status changed from uninitialized to green - Ready\n[...]\nserver log [21:49:59.421] [info][listening] Server running at http://0.0.0.0:5601\noptmzr log [21:50:07.177] [info][optimize] Lazy optimization started\noptmzr log [21:50:13.834] [info][optimize] Lazy optimization success in 6.66 seconds\n```\n\n(kibana)\n\n#### \n\nnpm module,package.jsonindex.js\n\npackage.json, nameplugins/kibana\\_gm\\_cal\\_vis/,index,\n\n```\n{\n  \"name\": \"kibana_gm_cal_vis\",\n  \"version\": \"0.1.0\",\n  \"kibana\": {\n    \"version\": \"5.3.4\"\n  }\n}\n```\n\nindex.js\n\n```\nmodule.exports = function(kibana) {\n  return new kibana.Plugin({\n    uiExports: {\n      visTypes: ['plugins/kibana_gm_cal_vis/gm_cal']\n    }\n  });\n};\n```\n\n#### \n\nKibana\n\n```\nbin/kibana plugin --install plugin-name -u https://url.to/plugin\n```\n\nplugins\n\nkibana-docker/usr/share/kibana/plugins/plugin-namerun..\n","slug":"kibana-plugin-development","published":1,"updated":"2019-10-14T06:21:57.352Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ua0016t6xvqq43x12d","content":"<h2 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h2><p></p>\n<ul>\n<li><a href=\"https://trumandu.gitbooks.io/kibana-plugin-development-tutorial/content/\" target=\"_blank\" rel=\"noopener\">trumandu-tutorial</a></li>\n<li><a href=\"https://www.timroes.de/2015/12/02/writing-kibana-4-plugins-basics/\" target=\"_blank\" rel=\"noopener\">timroes.de</a></li>\n</ul>\n<h3 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h3><ul>\n<li><p>githubkibanakibanakibanaapikibanakibana5.3.4</p>\n</li>\n<li><p>npm install</p>\n<ul>\n<li><p>githubgitsshhttp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global url.&quot;https://&quot;.insteadOf &quot;git://&quot;</span><br><span class=\"line\">//.gitconfig</span><br><span class=\"line\">[url &quot;https://&quot;]</span><br><span class=\"line\">insteadOf = git://</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n</li>\n</ul>\n</li>\n<li><p>npm start, dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (opts.dev) &#123;</span><br><span class=\"line\">    set(&apos;env&apos;, &apos;development&apos;);</span><br><span class=\"line\">    set(&apos;optimize.lazy&apos;, true);</span><br><span class=\"line\"></span><br><span class=\"line\">    // if (opts.ssl) &#123;</span><br><span class=\"line\">    //   set(&apos;server.ssl.enabled&apos;, true);</span><br><span class=\"line\">    // &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // if (opts.ssl &amp;&amp; !has(&apos;server.ssl.certificate&apos;) &amp;&amp; !has(&apos;server.ssl.key&apos;)) &#123;</span><br><span class=\"line\">    //   set(&apos;server.ssl.certificate&apos;, DEV_SSL_CERT_PATH);</span><br><span class=\"line\">    //   set(&apos;server.ssl.key&apos;, DEV_SSL_KEY_PATH);</span><br><span class=\"line\">    // &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>kibanapluginsKibanawatchchanges(/)</p>\n<p>kibanaconsole</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">restarting server due to changes in</span><br><span class=\"line\"> - &quot;installedPlugins/tr-k4p-clock/index.js&quot;</span><br><span class=\"line\">server log [21:49:59.323] [info][status][plugin:tr-k4p-clock] Status changed from uninitialized to green - Ready</span><br><span class=\"line\">[...]</span><br><span class=\"line\">server log [21:49:59.421] [info][listening] Server running at http://0.0.0.0:5601</span><br><span class=\"line\">optmzr log [21:50:07.177] [info][optimize] Lazy optimization started</span><br><span class=\"line\">optmzr log [21:50:13.834] [info][optimize] Lazy optimization success in 6.66 seconds</span><br></pre></td></tr></table></figure>\n\n<p>(kibana)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>npm module,package.jsonindex.js</p>\n<p>package.json, nameplugins/kibana_gm_cal_vis/,index,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;: &quot;kibana_gm_cal_vis&quot;,</span><br><span class=\"line\">  &quot;version&quot;: &quot;0.1.0&quot;,</span><br><span class=\"line\">  &quot;kibana&quot;: &#123;</span><br><span class=\"line\">    &quot;version&quot;: &quot;5.3.4&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>index.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">module.exports = function(kibana) &#123;</span><br><span class=\"line\">  return new kibana.Plugin(&#123;</span><br><span class=\"line\">    uiExports: &#123;</span><br><span class=\"line\">      visTypes: [&apos;plugins/kibana_gm_cal_vis/gm_cal&apos;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Kibana</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/kibana plugin --install plugin-name -u https://url.to/plugin</span><br></pre></td></tr></table></figure>\n\n<p>plugins</p>\n<p>kibana-docker/usr/share/kibana/plugins/plugin-namerun..</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h2><p></p>\n<ul>\n<li><a href=\"https://trumandu.gitbooks.io/kibana-plugin-development-tutorial/content/\" target=\"_blank\" rel=\"noopener\">trumandu-tutorial</a></li>\n<li><a href=\"https://www.timroes.de/2015/12/02/writing-kibana-4-plugins-basics/\" target=\"_blank\" rel=\"noopener\">timroes.de</a></li>\n</ul>\n<h3 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h3><ul>\n<li><p>githubkibanakibanakibanaapikibanakibana5.3.4</p>\n</li>\n<li><p>npm install</p>\n<ul>\n<li><p>githubgitsshhttp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global url.&quot;https://&quot;.insteadOf &quot;git://&quot;</span><br><span class=\"line\">//.gitconfig</span><br><span class=\"line\">[url &quot;https://&quot;]</span><br><span class=\"line\">insteadOf = git://</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n</li>\n</ul>\n</li>\n<li><p>npm start, dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (opts.dev) &#123;</span><br><span class=\"line\">    set(&apos;env&apos;, &apos;development&apos;);</span><br><span class=\"line\">    set(&apos;optimize.lazy&apos;, true);</span><br><span class=\"line\"></span><br><span class=\"line\">    // if (opts.ssl) &#123;</span><br><span class=\"line\">    //   set(&apos;server.ssl.enabled&apos;, true);</span><br><span class=\"line\">    // &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // if (opts.ssl &amp;&amp; !has(&apos;server.ssl.certificate&apos;) &amp;&amp; !has(&apos;server.ssl.key&apos;)) &#123;</span><br><span class=\"line\">    //   set(&apos;server.ssl.certificate&apos;, DEV_SSL_CERT_PATH);</span><br><span class=\"line\">    //   set(&apos;server.ssl.key&apos;, DEV_SSL_KEY_PATH);</span><br><span class=\"line\">    // &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>kibanapluginsKibanawatchchanges(/)</p>\n<p>kibanaconsole</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">restarting server due to changes in</span><br><span class=\"line\"> - &quot;installedPlugins/tr-k4p-clock/index.js&quot;</span><br><span class=\"line\">server log [21:49:59.323] [info][status][plugin:tr-k4p-clock] Status changed from uninitialized to green - Ready</span><br><span class=\"line\">[...]</span><br><span class=\"line\">server log [21:49:59.421] [info][listening] Server running at http://0.0.0.0:5601</span><br><span class=\"line\">optmzr log [21:50:07.177] [info][optimize] Lazy optimization started</span><br><span class=\"line\">optmzr log [21:50:13.834] [info][optimize] Lazy optimization success in 6.66 seconds</span><br></pre></td></tr></table></figure>\n\n<p>(kibana)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>npm module,package.jsonindex.js</p>\n<p>package.json, nameplugins/kibana_gm_cal_vis/,index,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;name&quot;: &quot;kibana_gm_cal_vis&quot;,</span><br><span class=\"line\">  &quot;version&quot;: &quot;0.1.0&quot;,</span><br><span class=\"line\">  &quot;kibana&quot;: &#123;</span><br><span class=\"line\">    &quot;version&quot;: &quot;5.3.4&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>index.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">module.exports = function(kibana) &#123;</span><br><span class=\"line\">  return new kibana.Plugin(&#123;</span><br><span class=\"line\">    uiExports: &#123;</span><br><span class=\"line\">      visTypes: [&apos;plugins/kibana_gm_cal_vis/gm_cal&apos;]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Kibana</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/kibana plugin --install plugin-name -u https://url.to/plugin</span><br></pre></td></tr></table></figure>\n\n<p>plugins</p>\n<p>kibana-docker/usr/share/kibana/plugins/plugin-namerun..</p>\n"},{"title":"kibana-timeline","date":"2017-10-14T05:54:37.000Z","_content":"..kibana-5.4.2/src/core_plugins/timeliontimeline\n\n### fit-functitons\n\nfitaverage,carry,nearest,scale\n\n#### average\n\naverage2dataTuples, targetTuples[[time,value],[..]],[time,null]..\n\nNaN,resultValuesNaNresultValuesNaN\t  NaN+1nan+resultValues\n\n\n\n```\n  while (i < dataTuplesQueue.length && dataTuplesQueue[i][0] <= time) {\n      avgSet.push(dataTuplesQueue[i][1]);\n      i++;\n    }\n    dataTuplesQueue.splice(0, i);\n\n    const sum = _lodash2.default.reduce(avgSet, function (sum, num) {\n      return sum + num;\n    }, 0);\n    return avgSet.length ? sum / avgSet.length : NaN;\n```\n\n#### carry\n\n2dataTuples, targetTuplesdataTuplestargetTuplestargetTuplesdataTuplestargetTuplesdataTuplesdataTuples...\n\n#### nearest\n\n\n\n#### \n\nfit \n\n#### \n\nfit\n\n```\n'use strict';\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n// bug: dataTuples[].\nmodule.exports = function (dataTuples, targetTuples) {\n  return _lodash2.default.map(targetTuples, function (bucket) {\n    const time = bucket[0];\n    let i = 0;\n    while (i < dataTuples.length - 1 && dataTuples[i + 1][0] < time) {\n        i++;\n    }\n    const closest = dataTuples[i];\n    dataTuples.splice(0, i);\n    return [bucket[0], closest[1]];\n  });\n};\n```\n\nfit_functions\n\n#### Question\n\nfittimelinemutilply.es\n\n### Timeline\n\n- \n\n```\n.es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct')\n\n```\n\n- offset,offset=-1h\n\n```\n.es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct'), .es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct')\n\n```\n\n- .label()\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour'), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour')\n\n```\n\n- title()\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour'), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time')\n```\n\n- .linesappearance.lines(fill=1,width=0.5)1101\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour').lines(fill=1,width=0.5), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time')\n\n```\n\n- .color()label,color(gray)color(#1E90FF)\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour').lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time').color(#1E90FF)\n```\n\n- .legend()\n\n> For this example, place the legend in the north west position of the visualization with two columns by appending .legend(columns=2, position=nw)\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour').lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time').color(#1E90FF).legend(columns=2, position=nw)\n\n```\n\n- \n\n- max , metricmetric=max:system.network.in.bytes\n- derivative  .es\n- multiply  \n- divide \n\n```\n .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.in.bytes).derivative().divide(1048576).lines(fill=2, width=1).color(green).label(\"Inbound traffic\").title(\"Network traffic (MB/s)\"), .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.out.bytes).derivative().multiply(-1).divide(1048576).lines(fill=2, width=1).color(blue).label(\"Outbound traffic\").legend(columns=2, position=nw)\n\n```\n\n //bytes to megabytes1024*1024>0,<0-1\n\n-  if () (eq/ne.. , value, then do, else do)//then doelse donull\n\n- eq ==\n- ne !=\n- lt <\n- lte <=\n- gt >\n- gte >=\n\n```\n .es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes'), .es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes').if(gt,12500000000,.es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes'),null).label('warning').color('#FFCC11'), .es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes').if(gt,15000000000,.es(index=metricbeat-*, timefield='@timestamp', ='max:system.memory.actual.used.bytes'),null).label('severe').color('red')\n```\n\n //1250000000015000000000if.es.es\n\n- \n\n```\n.es().if(lt, 500, null).if(gte, 500, 1000)\n.es().if(lt, 500, 0, 1000)\n```\n\n```\n- mvavg()mvavg10\n```\n\n\n\n- .bars, .lines, .point.point\n","source":"_posts/kibana-timeline.md","raw":"---\ntitle: kibana-timeline\ndate: 2017-10-14 13:54:37\ncategories:\n- elk\n---\n..kibana-5.4.2/src/core_plugins/timeliontimeline\n\n### fit-functitons\n\nfitaverage,carry,nearest,scale\n\n#### average\n\naverage2dataTuples, targetTuples[[time,value],[..]],[time,null]..\n\nNaN,resultValuesNaNresultValuesNaN\t  NaN+1nan+resultValues\n\n\n\n```\n  while (i < dataTuplesQueue.length && dataTuplesQueue[i][0] <= time) {\n      avgSet.push(dataTuplesQueue[i][1]);\n      i++;\n    }\n    dataTuplesQueue.splice(0, i);\n\n    const sum = _lodash2.default.reduce(avgSet, function (sum, num) {\n      return sum + num;\n    }, 0);\n    return avgSet.length ? sum / avgSet.length : NaN;\n```\n\n#### carry\n\n2dataTuples, targetTuplesdataTuplestargetTuplestargetTuplesdataTuplestargetTuplesdataTuplesdataTuples...\n\n#### nearest\n\n\n\n#### \n\nfit \n\n#### \n\nfit\n\n```\n'use strict';\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n// bug: dataTuples[].\nmodule.exports = function (dataTuples, targetTuples) {\n  return _lodash2.default.map(targetTuples, function (bucket) {\n    const time = bucket[0];\n    let i = 0;\n    while (i < dataTuples.length - 1 && dataTuples[i + 1][0] < time) {\n        i++;\n    }\n    const closest = dataTuples[i];\n    dataTuples.splice(0, i);\n    return [bucket[0], closest[1]];\n  });\n};\n```\n\nfit_functions\n\n#### Question\n\nfittimelinemutilply.es\n\n### Timeline\n\n- \n\n```\n.es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct')\n\n```\n\n- offset,offset=-1h\n\n```\n.es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct'), .es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct')\n\n```\n\n- .label()\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour'), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour')\n\n```\n\n- title()\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour'), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time')\n```\n\n- .linesappearance.lines(fill=1,width=0.5)1101\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour').lines(fill=1,width=0.5), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time')\n\n```\n\n- .color()label,color(gray)color(#1E90FF)\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour').lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time').color(#1E90FF)\n```\n\n- .legend()\n\n> For this example, place the legend in the north west position of the visualization with two columns by appending .legend(columns=2, position=nw)\n\n```\n.es(offset=-1h,index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('last hour').lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield='@timestamp', metric='avg:system.cpu.user.pct').label('current hour').title('CPU usage over time').color(#1E90FF).legend(columns=2, position=nw)\n\n```\n\n- \n\n- max , metricmetric=max:system.network.in.bytes\n- derivative  .es\n- multiply  \n- divide \n\n```\n .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.in.bytes).derivative().divide(1048576).lines(fill=2, width=1).color(green).label(\"Inbound traffic\").title(\"Network traffic (MB/s)\"), .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.out.bytes).derivative().multiply(-1).divide(1048576).lines(fill=2, width=1).color(blue).label(\"Outbound traffic\").legend(columns=2, position=nw)\n\n```\n\n //bytes to megabytes1024*1024>0,<0-1\n\n-  if () (eq/ne.. , value, then do, else do)//then doelse donull\n\n- eq ==\n- ne !=\n- lt <\n- lte <=\n- gt >\n- gte >=\n\n```\n .es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes'), .es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes').if(gt,12500000000,.es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes'),null).label('warning').color('#FFCC11'), .es(index=metricbeat-*, timefield='@timestamp', metric='max:system.memory.actual.used.bytes').if(gt,15000000000,.es(index=metricbeat-*, timefield='@timestamp', ='max:system.memory.actual.used.bytes'),null).label('severe').color('red')\n```\n\n //1250000000015000000000if.es.es\n\n- \n\n```\n.es().if(lt, 500, null).if(gte, 500, 1000)\n.es().if(lt, 500, 0, 1000)\n```\n\n```\n- mvavg()mvavg10\n```\n\n\n\n- .bars, .lines, .point.point\n","slug":"kibana-timeline","published":1,"updated":"2019-10-14T06:22:10.627Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69uf0017t6xvmp2qho78","content":"<p>..kibana-5.4.2/src/core_plugins/timeliontimeline</p>\n<h3 id=\"fit-functitons\"><a href=\"#fit-functitons\" class=\"headerlink\" title=\"fit-functitons\"></a>fit-functitons</h3><p>fitaverage,carry,nearest,scale</p>\n<h4 id=\"average\"><a href=\"#average\" class=\"headerlink\" title=\"average\"></a>average</h4><p>average2dataTuples, targetTuples[[time,value],[..]],[time,null]..</p>\n<p>NaN,resultValuesNaNresultValuesNaN      NaN+1nan+resultValues</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while (i &lt; dataTuplesQueue.length &amp;&amp; dataTuplesQueue[i][0] &lt;= time) &#123;</span><br><span class=\"line\">    avgSet.push(dataTuplesQueue[i][1]);</span><br><span class=\"line\">    i++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  dataTuplesQueue.splice(0, i);</span><br><span class=\"line\"></span><br><span class=\"line\">  const sum = _lodash2.default.reduce(avgSet, function (sum, num) &#123;</span><br><span class=\"line\">    return sum + num;</span><br><span class=\"line\">  &#125;, 0);</span><br><span class=\"line\">  return avgSet.length ? sum / avgSet.length : NaN;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"carry\"><a href=\"#carry\" class=\"headerlink\" title=\"carry\"></a>carry</h4><p>2dataTuples, targetTuplesdataTuplestargetTuplestargetTuplesdataTuplestargetTuplesdataTuplesdataTuples</p>\n<h4 id=\"nearest\"><a href=\"#nearest\" class=\"headerlink\" title=\"nearest\"></a>nearest</h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>fit </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>fit</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;use strict&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">var _lodash = require(&apos;lodash&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">var _lodash2 = _interopRequireDefault(_lodash);</span><br><span class=\"line\"></span><br><span class=\"line\">function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// bug: dataTuples[].</span><br><span class=\"line\">module.exports = function (dataTuples, targetTuples) &#123;</span><br><span class=\"line\">  return _lodash2.default.map(targetTuples, function (bucket) &#123;</span><br><span class=\"line\">    const time = bucket[0];</span><br><span class=\"line\">    let i = 0;</span><br><span class=\"line\">    while (i &lt; dataTuples.length - 1 &amp;&amp; dataTuples[i + 1][0] &lt; time) &#123;</span><br><span class=\"line\">        i++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    const closest = dataTuples[i];</span><br><span class=\"line\">    dataTuples.splice(0, i);</span><br><span class=\"line\">    return [bucket[0], closest[1]];</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>fit_functions</p>\n<h4 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h4><p>fittimelinemutilply.es</p>\n<h3 id=\"Timeline\"><a href=\"#Timeline\" class=\"headerlink\" title=\"Timeline\"></a>Timeline</h3><ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>offset,offset=-1h</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;), .es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.label()</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>title()</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.linesappearance.lines(fill=1,width=0.5)1101</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.color()label,color(gray)color(#1E90FF)</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;).color(#1E90FF)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.legend()</li>\n</ul>\n<blockquote>\n<p>For this example, place the legend in the north west position of the visualization with two columns by appending .legend(columns=2, position=nw)</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;).color(#1E90FF).legend(columns=2, position=nw)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p></p>\n</li>\n<li><p>max , metricmetric=max:system.network.in.bytes</p>\n</li>\n<li><p>derivative  .es</p>\n</li>\n<li><p>multiply  </p>\n</li>\n<li><p>divide </p>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.in.bytes).derivative().divide(1048576).lines(fill=2, width=1).color(green).label(&quot;Inbound traffic&quot;).title(&quot;Network traffic (MB/s)&quot;), .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.out.bytes).derivative().multiply(-1).divide(1048576).lines(fill=2, width=1).color(blue).label(&quot;Outbound traffic&quot;).legend(columns=2, position=nw)</span><br></pre></td></tr></table></figure>\n\n<p> //bytes to megabytes1024*1024&gt;0,&lt;0-1</p>\n<ul>\n<li><p> if () (eq/ne.. , value, then do, else do)//then doelse donull</p>\n</li>\n<li><p>eq ==</p>\n</li>\n<li><p>ne !=</p>\n</li>\n<li><p>lt &lt;</p>\n</li>\n<li><p>lte &lt;=</p>\n</li>\n<li><p>gt &gt;</p>\n</li>\n<li><p>gte &gt;=</p>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;).if(gt,12500000000,.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;),null).label(&apos;warning&apos;).color(&apos;#FFCC11&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;).if(gt,15000000000,.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, =&apos;max:system.memory.actual.used.bytes&apos;),null).label(&apos;severe&apos;).color(&apos;red&apos;)</span><br></pre></td></tr></table></figure>\n\n<p> //1250000000015000000000if.es.es</p>\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es().if(lt, 500, null).if(gte, 500, 1000)</span><br><span class=\"line\">.es().if(lt, 500, 0, 1000)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- mvavg()mvavg10</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.bars, .lines, .point.point</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<p>..kibana-5.4.2/src/core_plugins/timeliontimeline</p>\n<h3 id=\"fit-functitons\"><a href=\"#fit-functitons\" class=\"headerlink\" title=\"fit-functitons\"></a>fit-functitons</h3><p>fitaverage,carry,nearest,scale</p>\n<h4 id=\"average\"><a href=\"#average\" class=\"headerlink\" title=\"average\"></a>average</h4><p>average2dataTuples, targetTuples[[time,value],[..]],[time,null]..</p>\n<p>NaN,resultValuesNaNresultValuesNaN      NaN+1nan+resultValues</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while (i &lt; dataTuplesQueue.length &amp;&amp; dataTuplesQueue[i][0] &lt;= time) &#123;</span><br><span class=\"line\">    avgSet.push(dataTuplesQueue[i][1]);</span><br><span class=\"line\">    i++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  dataTuplesQueue.splice(0, i);</span><br><span class=\"line\"></span><br><span class=\"line\">  const sum = _lodash2.default.reduce(avgSet, function (sum, num) &#123;</span><br><span class=\"line\">    return sum + num;</span><br><span class=\"line\">  &#125;, 0);</span><br><span class=\"line\">  return avgSet.length ? sum / avgSet.length : NaN;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"carry\"><a href=\"#carry\" class=\"headerlink\" title=\"carry\"></a>carry</h4><p>2dataTuples, targetTuplesdataTuplestargetTuplestargetTuplesdataTuplestargetTuplesdataTuplesdataTuples</p>\n<h4 id=\"nearest\"><a href=\"#nearest\" class=\"headerlink\" title=\"nearest\"></a>nearest</h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>fit </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>fit</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;use strict&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">var _lodash = require(&apos;lodash&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">var _lodash2 = _interopRequireDefault(_lodash);</span><br><span class=\"line\"></span><br><span class=\"line\">function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// bug: dataTuples[].</span><br><span class=\"line\">module.exports = function (dataTuples, targetTuples) &#123;</span><br><span class=\"line\">  return _lodash2.default.map(targetTuples, function (bucket) &#123;</span><br><span class=\"line\">    const time = bucket[0];</span><br><span class=\"line\">    let i = 0;</span><br><span class=\"line\">    while (i &lt; dataTuples.length - 1 &amp;&amp; dataTuples[i + 1][0] &lt; time) &#123;</span><br><span class=\"line\">        i++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    const closest = dataTuples[i];</span><br><span class=\"line\">    dataTuples.splice(0, i);</span><br><span class=\"line\">    return [bucket[0], closest[1]];</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>fit_functions</p>\n<h4 id=\"Question\"><a href=\"#Question\" class=\"headerlink\" title=\"Question\"></a>Question</h4><p>fittimelinemutilply.es</p>\n<h3 id=\"Timeline\"><a href=\"#Timeline\" class=\"headerlink\" title=\"Timeline\"></a>Timeline</h3><ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>offset,offset=-1h</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;), .es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.label()</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>title()</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.linesappearance.lines(fill=1,width=0.5)1101</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.color()label,color(gray)color(#1E90FF)</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;).color(#1E90FF)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.legend()</li>\n</ul>\n<blockquote>\n<p>For this example, place the legend in the north west position of the visualization with two columns by appending .legend(columns=2, position=nw)</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(offset=-1h,index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;last hour&apos;).lines(fill=1,width=0.5).color(gray), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;avg:system.cpu.user.pct&apos;).label(&apos;current hour&apos;).title(&apos;CPU usage over time&apos;).color(#1E90FF).legend(columns=2, position=nw)</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p></p>\n</li>\n<li><p>max , metricmetric=max:system.network.in.bytes</p>\n</li>\n<li><p>derivative  .es</p>\n</li>\n<li><p>multiply  </p>\n</li>\n<li><p>divide </p>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.in.bytes).derivative().divide(1048576).lines(fill=2, width=1).color(green).label(&quot;Inbound traffic&quot;).title(&quot;Network traffic (MB/s)&quot;), .es(index=metricbeat*, timefield=@timestamp, metric=max:system.network.out.bytes).derivative().multiply(-1).divide(1048576).lines(fill=2, width=1).color(blue).label(&quot;Outbound traffic&quot;).legend(columns=2, position=nw)</span><br></pre></td></tr></table></figure>\n\n<p> //bytes to megabytes1024*1024&gt;0,&lt;0-1</p>\n<ul>\n<li><p> if () (eq/ne.. , value, then do, else do)//then doelse donull</p>\n</li>\n<li><p>eq ==</p>\n</li>\n<li><p>ne !=</p>\n</li>\n<li><p>lt &lt;</p>\n</li>\n<li><p>lte &lt;=</p>\n</li>\n<li><p>gt &gt;</p>\n</li>\n<li><p>gte &gt;=</p>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;).if(gt,12500000000,.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;),null).label(&apos;warning&apos;).color(&apos;#FFCC11&apos;), .es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, metric=&apos;max:system.memory.actual.used.bytes&apos;).if(gt,15000000000,.es(index=metricbeat-*, timefield=&apos;@timestamp&apos;, =&apos;max:system.memory.actual.used.bytes&apos;),null).label(&apos;severe&apos;).color(&apos;red&apos;)</span><br></pre></td></tr></table></figure>\n\n<p> //1250000000015000000000if.es.es</p>\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.es().if(lt, 500, null).if(gte, 500, 1000)</span><br><span class=\"line\">.es().if(lt, 500, 0, 1000)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- mvavg()mvavg10</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>.bars, .lines, .point.point</li>\n</ul>\n"},{"title":"web3j","date":"2019-10-14T06:55:36.000Z","_content":"## web3j\n\n\n\n#### \n\n- JavaJSON-RPCEthereum\n- JSON-RPC\n- GethParity\n- \n- Solidity ABIJava\n\n\n\nJSON-RPC\n\nweb3j\n\n\n\nweb3jjavaTransactionReceipt\n\n```\n    public RemoteCall<TransactionReceipt> addUser(byte[] name, String addr, byte[] pk_pre, byte[] pk_bk) {\n        final Function function = new Function(\n                FUNC_ADDUSER,\n                Arrays.<Type>asList(new org.web3j.abi.datatypes.generated.Bytes32(name),\n                        new org.web3j.abi.datatypes.Address(addr),\n                        new org.web3j.abi.datatypes.generated.Bytes32(pk_pre),\n                        new org.web3j.abi.datatypes.generated.Bytes32(pk_bk)),\n                Collections.<TypeReference<?>>emptyList());\n        return executeRemoteCallTransaction(function);\n    }\n```\n\nexecuteRemoteCallTransaction\n\n```\n    TransactionReceipt executeTransaction(String data, BigInteger weiValue, String funcName) throws TransactionException, IOException {\n        TransactionReceipt receipt = this.send(this.contractAddress, data, weiValue, this.gasProvider.getGasPrice(funcName), this.gasProvider.getGasLimit(funcName));\n        if (!receipt.isStatusOK()) {\n            throw new TransactionException(String.format(\"Transaction has failed with status: %s. Gas used: %d. (not-enough gas?)\", receipt.getStatus(), receipt.getGasUsed()));\n        } else {\n            return receipt;\n        }\n    }\n```\n\nnot-enough gasreceiptstatus\n\nsendtransactionManager\n\n\n\n```\n   protected TransactionReceipt executeTransaction(BigInteger gasPrice, BigInteger gasLimit, String to, String data, BigInteger value) throws IOException, TransactionException {\n        EthSendTransaction ethSendTransaction = this.sendTransaction(gasPrice, gasLimit, to, data, value);\n        return this.processResponse(ethSendTransaction);\n    }\n```\n\nprocessResponsethis.transactionReceiptProcessor.waitForTransactionReceiptTransactionManagerPollingTransactionReceiptProcessor..\n\n```\n private TransactionReceipt getTransactionReceipt(String transactionHash, long sleepDuration, int attempts) throws IOException, TransactionException {\n        Optional<TransactionReceipt> receiptOptional = this.sendTransactionReceiptRequest(transactionHash);\n\n        for(int i = 0; i < attempts; ++i) {\n            if (receiptOptional.isPresent()) {\n                return (TransactionReceipt)receiptOptional.get();\n            }\n\n            try {\n                Thread.sleep(sleepDuration);\n            } catch (InterruptedException var8) {\n                throw new TransactionException(var8);\n            }\n\n            receiptOptional = this.sendTransactionReceiptRequest(transactionHash);\n        }\n\n        throw new TransactionException(\"Transaction receipt was not generated after \" + sleepDuration * (long)attempts / 1000L + \" seconds for transaction: \" + transactionHash);\n    }\n```\n\n**sleepDurationsleepDuration15s, 40**\n","source":"_posts/web3j.md","raw":"---\ntitle: web3j\ncategories:\n  - eth\ndate: 2019-10-14 14:55:36\ntags:\n---\n## web3j\n\n\n\n#### \n\n- JavaJSON-RPCEthereum\n- JSON-RPC\n- GethParity\n- \n- Solidity ABIJava\n\n\n\nJSON-RPC\n\nweb3j\n\n\n\nweb3jjavaTransactionReceipt\n\n```\n    public RemoteCall<TransactionReceipt> addUser(byte[] name, String addr, byte[] pk_pre, byte[] pk_bk) {\n        final Function function = new Function(\n                FUNC_ADDUSER,\n                Arrays.<Type>asList(new org.web3j.abi.datatypes.generated.Bytes32(name),\n                        new org.web3j.abi.datatypes.Address(addr),\n                        new org.web3j.abi.datatypes.generated.Bytes32(pk_pre),\n                        new org.web3j.abi.datatypes.generated.Bytes32(pk_bk)),\n                Collections.<TypeReference<?>>emptyList());\n        return executeRemoteCallTransaction(function);\n    }\n```\n\nexecuteRemoteCallTransaction\n\n```\n    TransactionReceipt executeTransaction(String data, BigInteger weiValue, String funcName) throws TransactionException, IOException {\n        TransactionReceipt receipt = this.send(this.contractAddress, data, weiValue, this.gasProvider.getGasPrice(funcName), this.gasProvider.getGasLimit(funcName));\n        if (!receipt.isStatusOK()) {\n            throw new TransactionException(String.format(\"Transaction has failed with status: %s. Gas used: %d. (not-enough gas?)\", receipt.getStatus(), receipt.getGasUsed()));\n        } else {\n            return receipt;\n        }\n    }\n```\n\nnot-enough gasreceiptstatus\n\nsendtransactionManager\n\n\n\n```\n   protected TransactionReceipt executeTransaction(BigInteger gasPrice, BigInteger gasLimit, String to, String data, BigInteger value) throws IOException, TransactionException {\n        EthSendTransaction ethSendTransaction = this.sendTransaction(gasPrice, gasLimit, to, data, value);\n        return this.processResponse(ethSendTransaction);\n    }\n```\n\nprocessResponsethis.transactionReceiptProcessor.waitForTransactionReceiptTransactionManagerPollingTransactionReceiptProcessor..\n\n```\n private TransactionReceipt getTransactionReceipt(String transactionHash, long sleepDuration, int attempts) throws IOException, TransactionException {\n        Optional<TransactionReceipt> receiptOptional = this.sendTransactionReceiptRequest(transactionHash);\n\n        for(int i = 0; i < attempts; ++i) {\n            if (receiptOptional.isPresent()) {\n                return (TransactionReceipt)receiptOptional.get();\n            }\n\n            try {\n                Thread.sleep(sleepDuration);\n            } catch (InterruptedException var8) {\n                throw new TransactionException(var8);\n            }\n\n            receiptOptional = this.sendTransactionReceiptRequest(transactionHash);\n        }\n\n        throw new TransactionException(\"Transaction receipt was not generated after \" + sleepDuration * (long)attempts / 1000L + \" seconds for transaction: \" + transactionHash);\n    }\n```\n\n**sleepDurationsleepDuration15s, 40**\n","slug":"web3j","published":1,"updated":"2019-10-14T06:55:54.674Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69uk001at6xvky7tryyj","content":"<h2 id=\"web3j\"><a href=\"#web3j\" class=\"headerlink\" title=\"web3j\"></a>web3j</h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>JavaJSON-RPCEthereum</li>\n<li>JSON-RPC</li>\n<li>GethParity</li>\n<li></li>\n<li>Solidity ABIJava</li>\n</ul>\n<p>JSON-RPC</p>\n<p>web3j</p>\n<p></p>\n<p>web3jjavaTransactionReceipt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public RemoteCall&lt;TransactionReceipt&gt; addUser(byte[] name, String addr, byte[] pk_pre, byte[] pk_bk) &#123;</span><br><span class=\"line\">    final Function function = new Function(</span><br><span class=\"line\">            FUNC_ADDUSER,</span><br><span class=\"line\">            Arrays.&lt;Type&gt;asList(new org.web3j.abi.datatypes.generated.Bytes32(name),</span><br><span class=\"line\">                    new org.web3j.abi.datatypes.Address(addr),</span><br><span class=\"line\">                    new org.web3j.abi.datatypes.generated.Bytes32(pk_pre),</span><br><span class=\"line\">                    new org.web3j.abi.datatypes.generated.Bytes32(pk_bk)),</span><br><span class=\"line\">            Collections.&lt;TypeReference&lt;?&gt;&gt;emptyList());</span><br><span class=\"line\">    return executeRemoteCallTransaction(function);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>executeRemoteCallTransaction</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TransactionReceipt executeTransaction(String data, BigInteger weiValue, String funcName) throws TransactionException, IOException &#123;</span><br><span class=\"line\">    TransactionReceipt receipt = this.send(this.contractAddress, data, weiValue, this.gasProvider.getGasPrice(funcName), this.gasProvider.getGasLimit(funcName));</span><br><span class=\"line\">    if (!receipt.isStatusOK()) &#123;</span><br><span class=\"line\">        throw new TransactionException(String.format(&quot;Transaction has failed with status: %s. Gas used: %d. (not-enough gas?)&quot;, receipt.getStatus(), receipt.getGasUsed()));</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        return receipt;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>not-enough gasreceiptstatus</p>\n<p>sendtransactionManager</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">protected TransactionReceipt executeTransaction(BigInteger gasPrice, BigInteger gasLimit, String to, String data, BigInteger value) throws IOException, TransactionException &#123;</span><br><span class=\"line\">     EthSendTransaction ethSendTransaction = this.sendTransaction(gasPrice, gasLimit, to, data, value);</span><br><span class=\"line\">     return this.processResponse(ethSendTransaction);</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>processResponsethis.transactionReceiptProcessor.waitForTransactionReceiptTransactionManagerPollingTransactionReceiptProcessor..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private TransactionReceipt getTransactionReceipt(String transactionHash, long sleepDuration, int attempts) throws IOException, TransactionException &#123;</span><br><span class=\"line\">       Optional&lt;TransactionReceipt&gt; receiptOptional = this.sendTransactionReceiptRequest(transactionHash);</span><br><span class=\"line\"></span><br><span class=\"line\">       for(int i = 0; i &lt; attempts; ++i) &#123;</span><br><span class=\"line\">           if (receiptOptional.isPresent()) &#123;</span><br><span class=\"line\">               return (TransactionReceipt)receiptOptional.get();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           try &#123;</span><br><span class=\"line\">               Thread.sleep(sleepDuration);</span><br><span class=\"line\">           &#125; catch (InterruptedException var8) &#123;</span><br><span class=\"line\">               throw new TransactionException(var8);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           receiptOptional = this.sendTransactionReceiptRequest(transactionHash);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       throw new TransactionException(&quot;Transaction receipt was not generated after &quot; + sleepDuration * (long)attempts / 1000L + &quot; seconds for transaction: &quot; + transactionHash);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>sleepDurationsleepDuration15s, 40</strong></p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"web3j\"><a href=\"#web3j\" class=\"headerlink\" title=\"web3j\"></a>web3j</h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>JavaJSON-RPCEthereum</li>\n<li>JSON-RPC</li>\n<li>GethParity</li>\n<li></li>\n<li>Solidity ABIJava</li>\n</ul>\n<p>JSON-RPC</p>\n<p>web3j</p>\n<p></p>\n<p>web3jjavaTransactionReceipt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public RemoteCall&lt;TransactionReceipt&gt; addUser(byte[] name, String addr, byte[] pk_pre, byte[] pk_bk) &#123;</span><br><span class=\"line\">    final Function function = new Function(</span><br><span class=\"line\">            FUNC_ADDUSER,</span><br><span class=\"line\">            Arrays.&lt;Type&gt;asList(new org.web3j.abi.datatypes.generated.Bytes32(name),</span><br><span class=\"line\">                    new org.web3j.abi.datatypes.Address(addr),</span><br><span class=\"line\">                    new org.web3j.abi.datatypes.generated.Bytes32(pk_pre),</span><br><span class=\"line\">                    new org.web3j.abi.datatypes.generated.Bytes32(pk_bk)),</span><br><span class=\"line\">            Collections.&lt;TypeReference&lt;?&gt;&gt;emptyList());</span><br><span class=\"line\">    return executeRemoteCallTransaction(function);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>executeRemoteCallTransaction</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TransactionReceipt executeTransaction(String data, BigInteger weiValue, String funcName) throws TransactionException, IOException &#123;</span><br><span class=\"line\">    TransactionReceipt receipt = this.send(this.contractAddress, data, weiValue, this.gasProvider.getGasPrice(funcName), this.gasProvider.getGasLimit(funcName));</span><br><span class=\"line\">    if (!receipt.isStatusOK()) &#123;</span><br><span class=\"line\">        throw new TransactionException(String.format(&quot;Transaction has failed with status: %s. Gas used: %d. (not-enough gas?)&quot;, receipt.getStatus(), receipt.getGasUsed()));</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        return receipt;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>not-enough gasreceiptstatus</p>\n<p>sendtransactionManager</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">protected TransactionReceipt executeTransaction(BigInteger gasPrice, BigInteger gasLimit, String to, String data, BigInteger value) throws IOException, TransactionException &#123;</span><br><span class=\"line\">     EthSendTransaction ethSendTransaction = this.sendTransaction(gasPrice, gasLimit, to, data, value);</span><br><span class=\"line\">     return this.processResponse(ethSendTransaction);</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n\n<p>processResponsethis.transactionReceiptProcessor.waitForTransactionReceiptTransactionManagerPollingTransactionReceiptProcessor..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private TransactionReceipt getTransactionReceipt(String transactionHash, long sleepDuration, int attempts) throws IOException, TransactionException &#123;</span><br><span class=\"line\">       Optional&lt;TransactionReceipt&gt; receiptOptional = this.sendTransactionReceiptRequest(transactionHash);</span><br><span class=\"line\"></span><br><span class=\"line\">       for(int i = 0; i &lt; attempts; ++i) &#123;</span><br><span class=\"line\">           if (receiptOptional.isPresent()) &#123;</span><br><span class=\"line\">               return (TransactionReceipt)receiptOptional.get();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           try &#123;</span><br><span class=\"line\">               Thread.sleep(sleepDuration);</span><br><span class=\"line\">           &#125; catch (InterruptedException var8) &#123;</span><br><span class=\"line\">               throw new TransactionException(var8);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">           receiptOptional = this.sendTransactionReceiptRequest(transactionHash);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       throw new TransactionException(&quot;Transaction receipt was not generated after &quot; + sleepDuration * (long)attempts / 1000L + &quot; seconds for transaction: &quot; + transactionHash);</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>sleepDurationsleepDuration15s, 40</strong></p>\n"},{"title":"wallet_connection","date":"2019-10-14T06:31:54.000Z","_content":"\n## wallet connection\n\nkotlin<https://github.com/WalletConnect/kotlin-walletconnect-lib>\n\nas...\n\n- gradlekotlin\n\n  ```\n    classpath 'com.android.tools.build:gradle:3.4.1'\n  ```\n\n  build.gradle\n\n- sample:appmodule\n\n  settings.gradle\n\n  ```\n  include ':lib' , ':sample:app'\n  ```\n\n- \n\n  ```\n  allprojects {\n      repositories {\n          mavenLocal()\n          maven { url 'http://maven.aliyun.com/nexus/content/repositories/central' }\n          maven { url 'http://maven.aliyun.com/nexus/content/groups/public' }\n          maven { url 'http://maven.aliyun.com/nexus/content/repositories/google' }\n          maven { url 'http://maven.aliyun.com/nexus/content/repositories/gradle-plugin' }\n          maven { url \"https://maven.google.com\" }\n          /**fabric*/\n          maven { url 'http://s3.amazonaws.com/fabric-artifacts/public' }\n      }\n  }\n  ~\n  ```\n\n   init.gradle~/.gradle\n\n- \n\n\n\n\n\ntest\n\n```\nclass WalletConnectBridgeRepositoryIntegrationTest {\n\n\n    /**\n     * Integration test that can be used with the wallet connect example dapp\n     */\n    @Test\n    fun approveSession() {\n        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()\n        val moshi = Moshi.Builder().build()\n        val sessionDir = File(\"build/tmp/\").apply { mkdirs() }\n        val sessionStore = FileWCSessionStore(File(sessionDir, \"test_store.json\").apply { createNewFile() }, moshi)\n        //wc:33...\n        val config = Session.Config.fromWCUri(\"wc:79870fae-c04f-479e-8241-085e96603f2b@1?bridge=http%3A%2F%2F192.168.20.18%3A8000%2Fapi%2Fv1%2Fws&key=db8147b92d96a62cb1a2181dd3f9076cfd8eceaeba01feb8becfb965754e6f3e\")\n        val session = WCSession(\n            config,\n            MoshiPayloadAdapter(moshi),\n            sessionStore,\n            OkHttpTransport.Builder(client, moshi),\n            Session.PeerMeta(name = \"WC Unit Test\")\n        )\n        session.addCallback(object : Session.Callback {\n            //\n            override fun onStatus(status: Session.Status) {\n                System.out.println(\"onStatus: $status\")\n            }\n            //\n            override fun onMethodCall(call: Session.MethodCall) {\n\n                if (call is Session.MethodCall.SessionRequest) {\n                    //Session.MethodCall.SessionRequest\n                    //\n                    session.approve(listOf(\"0x32C772DCCF8DCddd3e271B213a0027c22C98Fd1e\"), 1L)\n                } else if (call is Session.MethodCall.SendTransaction) {\n                    //Session.MethodCall.SessionRequest\n                    // call.to, call.from, call.data \n                    session.approveRequest(call.id, \"ok\")\n                } else if(call is Session.MethodCall.Custom) {\n                    //\n                    //call.params call.method\n                    session.approveRequest(call.id, \"ok\")\n                }\n            }\n        })\n        //\n        session.init()\n        Thread.sleep(2000000)\n    }\n\n\n    @Test\n    fun approveSession1() {\n        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()\n        val moshi = Moshi.Builder().build()\n        val sessionDir = File(\"build/tmp/\").apply { mkdirs() }\n        val sessionStore = FileWCSessionStore(File(sessionDir, \"test_store.json\").apply { createNewFile() }, moshi)\n        val key = ByteArray(32).also { Random().nextBytes(it) }.toNoPrefixHexString()\n        val topic  = ByteArray(32).also { Random().nextBytes(it) }.toNoPrefixHexString()\n        println(\"topic: \" + topic)\n        println(\"key : $key\")\n        val config = Session.Config(topic, \"http://192.168.20.18:5000\", key)\n        val session = WCSession(\n                config,\n                MoshiPayloadAdapter(moshi),\n                sessionStore,\n                OkHttpTransport.Builder(client, moshi),\n                Session.PeerMeta(name = \"WC Unit Test\")\n        )\n        session.addCallback(object : Session.Callback {\n            override fun onStatus(status: Session.Status) {\n                System.out.println(\"onStatus: $status\")\n            }\n\n            override fun onMethodCall(call: Session.MethodCall) {\n                System.out.println(\"onMethodCall: $call\")\n            }\n        })\n        session.offer()\n        Thread.sleep(5000)\n        println(\"==========================\")\n        val id = Random().nextLong()\n        println(\"id: \"+ id)\n        val p = session.performMethodCall(Session.MethodCall.Custom(id, \"tttt\",  listOf(1,2,\"3\",4,\"5\")), callback = { resp ->\n            println(resp)\n        })\n        println(p)\n        Thread.sleep(100000)\n        session.kill()\n        Thread.sleep(200000)\n    }\n\n}\n\n```\n","source":"_posts/wallet-connection.md","raw":"---\ntitle: wallet_connection\ndate: 2019-10-14 14:31:54\ntags:\ncategories:\n- blockchain\n---\n\n## wallet connection\n\nkotlin<https://github.com/WalletConnect/kotlin-walletconnect-lib>\n\nas...\n\n- gradlekotlin\n\n  ```\n    classpath 'com.android.tools.build:gradle:3.4.1'\n  ```\n\n  build.gradle\n\n- sample:appmodule\n\n  settings.gradle\n\n  ```\n  include ':lib' , ':sample:app'\n  ```\n\n- \n\n  ```\n  allprojects {\n      repositories {\n          mavenLocal()\n          maven { url 'http://maven.aliyun.com/nexus/content/repositories/central' }\n          maven { url 'http://maven.aliyun.com/nexus/content/groups/public' }\n          maven { url 'http://maven.aliyun.com/nexus/content/repositories/google' }\n          maven { url 'http://maven.aliyun.com/nexus/content/repositories/gradle-plugin' }\n          maven { url \"https://maven.google.com\" }\n          /**fabric*/\n          maven { url 'http://s3.amazonaws.com/fabric-artifacts/public' }\n      }\n  }\n  ~\n  ```\n\n   init.gradle~/.gradle\n\n- \n\n\n\n\n\ntest\n\n```\nclass WalletConnectBridgeRepositoryIntegrationTest {\n\n\n    /**\n     * Integration test that can be used with the wallet connect example dapp\n     */\n    @Test\n    fun approveSession() {\n        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()\n        val moshi = Moshi.Builder().build()\n        val sessionDir = File(\"build/tmp/\").apply { mkdirs() }\n        val sessionStore = FileWCSessionStore(File(sessionDir, \"test_store.json\").apply { createNewFile() }, moshi)\n        //wc:33...\n        val config = Session.Config.fromWCUri(\"wc:79870fae-c04f-479e-8241-085e96603f2b@1?bridge=http%3A%2F%2F192.168.20.18%3A8000%2Fapi%2Fv1%2Fws&key=db8147b92d96a62cb1a2181dd3f9076cfd8eceaeba01feb8becfb965754e6f3e\")\n        val session = WCSession(\n            config,\n            MoshiPayloadAdapter(moshi),\n            sessionStore,\n            OkHttpTransport.Builder(client, moshi),\n            Session.PeerMeta(name = \"WC Unit Test\")\n        )\n        session.addCallback(object : Session.Callback {\n            //\n            override fun onStatus(status: Session.Status) {\n                System.out.println(\"onStatus: $status\")\n            }\n            //\n            override fun onMethodCall(call: Session.MethodCall) {\n\n                if (call is Session.MethodCall.SessionRequest) {\n                    //Session.MethodCall.SessionRequest\n                    //\n                    session.approve(listOf(\"0x32C772DCCF8DCddd3e271B213a0027c22C98Fd1e\"), 1L)\n                } else if (call is Session.MethodCall.SendTransaction) {\n                    //Session.MethodCall.SessionRequest\n                    // call.to, call.from, call.data \n                    session.approveRequest(call.id, \"ok\")\n                } else if(call is Session.MethodCall.Custom) {\n                    //\n                    //call.params call.method\n                    session.approveRequest(call.id, \"ok\")\n                }\n            }\n        })\n        //\n        session.init()\n        Thread.sleep(2000000)\n    }\n\n\n    @Test\n    fun approveSession1() {\n        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()\n        val moshi = Moshi.Builder().build()\n        val sessionDir = File(\"build/tmp/\").apply { mkdirs() }\n        val sessionStore = FileWCSessionStore(File(sessionDir, \"test_store.json\").apply { createNewFile() }, moshi)\n        val key = ByteArray(32).also { Random().nextBytes(it) }.toNoPrefixHexString()\n        val topic  = ByteArray(32).also { Random().nextBytes(it) }.toNoPrefixHexString()\n        println(\"topic: \" + topic)\n        println(\"key : $key\")\n        val config = Session.Config(topic, \"http://192.168.20.18:5000\", key)\n        val session = WCSession(\n                config,\n                MoshiPayloadAdapter(moshi),\n                sessionStore,\n                OkHttpTransport.Builder(client, moshi),\n                Session.PeerMeta(name = \"WC Unit Test\")\n        )\n        session.addCallback(object : Session.Callback {\n            override fun onStatus(status: Session.Status) {\n                System.out.println(\"onStatus: $status\")\n            }\n\n            override fun onMethodCall(call: Session.MethodCall) {\n                System.out.println(\"onMethodCall: $call\")\n            }\n        })\n        session.offer()\n        Thread.sleep(5000)\n        println(\"==========================\")\n        val id = Random().nextLong()\n        println(\"id: \"+ id)\n        val p = session.performMethodCall(Session.MethodCall.Custom(id, \"tttt\",  listOf(1,2,\"3\",4,\"5\")), callback = { resp ->\n            println(resp)\n        })\n        println(p)\n        Thread.sleep(100000)\n        session.kill()\n        Thread.sleep(200000)\n    }\n\n}\n\n```\n","slug":"wallet-connection","published":1,"updated":"2019-10-14T06:34:33.925Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69um001bt6xveobfk3fd","content":"<h2 id=\"wallet-connection\"><a href=\"#wallet-connection\" class=\"headerlink\" title=\"wallet connection\"></a>wallet connection</h2><p>kotlin<a href=\"https://github.com/WalletConnect/kotlin-walletconnect-lib\">https://github.com/WalletConnect/kotlin-walletconnect-lib</a></p>\n<p>as</p>\n<ul>\n<li><p>gradlekotlin</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">classpath &apos;com.android.tools.build:gradle:3.4.1&apos;</span><br></pre></td></tr></table></figure>\n\n<p>build.gradle</p>\n</li>\n<li><p>sample:appmodule</p>\n<p>settings.gradle</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include &apos;:lib&apos; , &apos;:sample:app&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">allprojects &#123;</span><br><span class=\"line\">    repositories &#123;</span><br><span class=\"line\">        mavenLocal()</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/central&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/groups/public&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/google&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/gradle-plugin&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &quot;https://maven.google.com&quot; &#125;</span><br><span class=\"line\">        /**fabric*/</span><br><span class=\"line\">        maven &#123; url &apos;http://s3.amazonaws.com/fabric-artifacts/public&apos; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">~</span><br></pre></td></tr></table></figure>\n\n<p> init.gradle~/.gradle</p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p></p>\n<p>test</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class WalletConnectBridgeRepositoryIntegrationTest &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * Integration test that can be used with the wallet connect example dapp</span><br><span class=\"line\">     */</span><br><span class=\"line\">    @Test</span><br><span class=\"line\">    fun approveSession() &#123;</span><br><span class=\"line\">        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()</span><br><span class=\"line\">        val moshi = Moshi.Builder().build()</span><br><span class=\"line\">        val sessionDir = File(&quot;build/tmp/&quot;).apply &#123; mkdirs() &#125;</span><br><span class=\"line\">        val sessionStore = FileWCSessionStore(File(sessionDir, &quot;test_store.json&quot;).apply &#123; createNewFile() &#125;, moshi)</span><br><span class=\"line\">        //wc:33...</span><br><span class=\"line\">        val config = Session.Config.fromWCUri(&quot;wc:79870fae-c04f-479e-8241-085e96603f2b@1?bridge=http%3A%2F%2F192.168.20.18%3A8000%2Fapi%2Fv1%2Fws&amp;key=db8147b92d96a62cb1a2181dd3f9076cfd8eceaeba01feb8becfb965754e6f3e&quot;)</span><br><span class=\"line\">        val session = WCSession(</span><br><span class=\"line\">            config,</span><br><span class=\"line\">            MoshiPayloadAdapter(moshi),</span><br><span class=\"line\">            sessionStore,</span><br><span class=\"line\">            OkHttpTransport.Builder(client, moshi),</span><br><span class=\"line\">            Session.PeerMeta(name = &quot;WC Unit Test&quot;)</span><br><span class=\"line\">        )</span><br><span class=\"line\">        session.addCallback(object : Session.Callback &#123;</span><br><span class=\"line\">            //</span><br><span class=\"line\">            override fun onStatus(status: Session.Status) &#123;</span><br><span class=\"line\">                System.out.println(&quot;onStatus: $status&quot;)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            //</span><br><span class=\"line\">            override fun onMethodCall(call: Session.MethodCall) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                if (call is Session.MethodCall.SessionRequest) &#123;</span><br><span class=\"line\">                    //Session.MethodCall.SessionRequest</span><br><span class=\"line\">                    //</span><br><span class=\"line\">                    session.approve(listOf(&quot;0x32C772DCCF8DCddd3e271B213a0027c22C98Fd1e&quot;), 1L)</span><br><span class=\"line\">                &#125; else if (call is Session.MethodCall.SendTransaction) &#123;</span><br><span class=\"line\">                    //Session.MethodCall.SessionRequest</span><br><span class=\"line\">                    // call.to, call.from, call.data </span><br><span class=\"line\">                    session.approveRequest(call.id, &quot;ok&quot;)</span><br><span class=\"line\">                &#125; else if(call is Session.MethodCall.Custom) &#123;</span><br><span class=\"line\">                    //</span><br><span class=\"line\">                    //call.params call.method</span><br><span class=\"line\">                    session.approveRequest(call.id, &quot;ok&quot;)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        //</span><br><span class=\"line\">        session.init()</span><br><span class=\"line\">        Thread.sleep(2000000)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    @Test</span><br><span class=\"line\">    fun approveSession1() &#123;</span><br><span class=\"line\">        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()</span><br><span class=\"line\">        val moshi = Moshi.Builder().build()</span><br><span class=\"line\">        val sessionDir = File(&quot;build/tmp/&quot;).apply &#123; mkdirs() &#125;</span><br><span class=\"line\">        val sessionStore = FileWCSessionStore(File(sessionDir, &quot;test_store.json&quot;).apply &#123; createNewFile() &#125;, moshi)</span><br><span class=\"line\">        val key = ByteArray(32).also &#123; Random().nextBytes(it) &#125;.toNoPrefixHexString()</span><br><span class=\"line\">        val topic  = ByteArray(32).also &#123; Random().nextBytes(it) &#125;.toNoPrefixHexString()</span><br><span class=\"line\">        println(&quot;topic: &quot; + topic)</span><br><span class=\"line\">        println(&quot;key : $key&quot;)</span><br><span class=\"line\">        val config = Session.Config(topic, &quot;http://192.168.20.18:5000&quot;, key)</span><br><span class=\"line\">        val session = WCSession(</span><br><span class=\"line\">                config,</span><br><span class=\"line\">                MoshiPayloadAdapter(moshi),</span><br><span class=\"line\">                sessionStore,</span><br><span class=\"line\">                OkHttpTransport.Builder(client, moshi),</span><br><span class=\"line\">                Session.PeerMeta(name = &quot;WC Unit Test&quot;)</span><br><span class=\"line\">        )</span><br><span class=\"line\">        session.addCallback(object : Session.Callback &#123;</span><br><span class=\"line\">            override fun onStatus(status: Session.Status) &#123;</span><br><span class=\"line\">                System.out.println(&quot;onStatus: $status&quot;)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            override fun onMethodCall(call: Session.MethodCall) &#123;</span><br><span class=\"line\">                System.out.println(&quot;onMethodCall: $call&quot;)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        session.offer()</span><br><span class=\"line\">        Thread.sleep(5000)</span><br><span class=\"line\">        println(&quot;==========================&quot;)</span><br><span class=\"line\">        val id = Random().nextLong()</span><br><span class=\"line\">        println(&quot;id: &quot;+ id)</span><br><span class=\"line\">        val p = session.performMethodCall(Session.MethodCall.Custom(id, &quot;tttt&quot;,  listOf(1,2,&quot;3&quot;,4,&quot;5&quot;)), callback = &#123; resp -&gt;</span><br><span class=\"line\">            println(resp)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        println(p)</span><br><span class=\"line\">        Thread.sleep(100000)</span><br><span class=\"line\">        session.kill()</span><br><span class=\"line\">        Thread.sleep(200000)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"wallet-connection\"><a href=\"#wallet-connection\" class=\"headerlink\" title=\"wallet connection\"></a>wallet connection</h2><p>kotlin<a href=\"https://github.com/WalletConnect/kotlin-walletconnect-lib\">https://github.com/WalletConnect/kotlin-walletconnect-lib</a></p>\n<p>as</p>\n<ul>\n<li><p>gradlekotlin</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">classpath &apos;com.android.tools.build:gradle:3.4.1&apos;</span><br></pre></td></tr></table></figure>\n\n<p>build.gradle</p>\n</li>\n<li><p>sample:appmodule</p>\n<p>settings.gradle</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include &apos;:lib&apos; , &apos;:sample:app&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">allprojects &#123;</span><br><span class=\"line\">    repositories &#123;</span><br><span class=\"line\">        mavenLocal()</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/central&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/groups/public&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/google&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &apos;http://maven.aliyun.com/nexus/content/repositories/gradle-plugin&apos; &#125;</span><br><span class=\"line\">        maven &#123; url &quot;https://maven.google.com&quot; &#125;</span><br><span class=\"line\">        /**fabric*/</span><br><span class=\"line\">        maven &#123; url &apos;http://s3.amazonaws.com/fabric-artifacts/public&apos; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">~</span><br></pre></td></tr></table></figure>\n\n<p> init.gradle~/.gradle</p>\n</li>\n<li><p></p>\n</li>\n</ul>\n<p></p>\n<p>test</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class WalletConnectBridgeRepositoryIntegrationTest &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * Integration test that can be used with the wallet connect example dapp</span><br><span class=\"line\">     */</span><br><span class=\"line\">    @Test</span><br><span class=\"line\">    fun approveSession() &#123;</span><br><span class=\"line\">        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()</span><br><span class=\"line\">        val moshi = Moshi.Builder().build()</span><br><span class=\"line\">        val sessionDir = File(&quot;build/tmp/&quot;).apply &#123; mkdirs() &#125;</span><br><span class=\"line\">        val sessionStore = FileWCSessionStore(File(sessionDir, &quot;test_store.json&quot;).apply &#123; createNewFile() &#125;, moshi)</span><br><span class=\"line\">        //wc:33...</span><br><span class=\"line\">        val config = Session.Config.fromWCUri(&quot;wc:79870fae-c04f-479e-8241-085e96603f2b@1?bridge=http%3A%2F%2F192.168.20.18%3A8000%2Fapi%2Fv1%2Fws&amp;key=db8147b92d96a62cb1a2181dd3f9076cfd8eceaeba01feb8becfb965754e6f3e&quot;)</span><br><span class=\"line\">        val session = WCSession(</span><br><span class=\"line\">            config,</span><br><span class=\"line\">            MoshiPayloadAdapter(moshi),</span><br><span class=\"line\">            sessionStore,</span><br><span class=\"line\">            OkHttpTransport.Builder(client, moshi),</span><br><span class=\"line\">            Session.PeerMeta(name = &quot;WC Unit Test&quot;)</span><br><span class=\"line\">        )</span><br><span class=\"line\">        session.addCallback(object : Session.Callback &#123;</span><br><span class=\"line\">            //</span><br><span class=\"line\">            override fun onStatus(status: Session.Status) &#123;</span><br><span class=\"line\">                System.out.println(&quot;onStatus: $status&quot;)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            //</span><br><span class=\"line\">            override fun onMethodCall(call: Session.MethodCall) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                if (call is Session.MethodCall.SessionRequest) &#123;</span><br><span class=\"line\">                    //Session.MethodCall.SessionRequest</span><br><span class=\"line\">                    //</span><br><span class=\"line\">                    session.approve(listOf(&quot;0x32C772DCCF8DCddd3e271B213a0027c22C98Fd1e&quot;), 1L)</span><br><span class=\"line\">                &#125; else if (call is Session.MethodCall.SendTransaction) &#123;</span><br><span class=\"line\">                    //Session.MethodCall.SessionRequest</span><br><span class=\"line\">                    // call.to, call.from, call.data </span><br><span class=\"line\">                    session.approveRequest(call.id, &quot;ok&quot;)</span><br><span class=\"line\">                &#125; else if(call is Session.MethodCall.Custom) &#123;</span><br><span class=\"line\">                    //</span><br><span class=\"line\">                    //call.params call.method</span><br><span class=\"line\">                    session.approveRequest(call.id, &quot;ok&quot;)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        //</span><br><span class=\"line\">        session.init()</span><br><span class=\"line\">        Thread.sleep(2000000)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    @Test</span><br><span class=\"line\">    fun approveSession1() &#123;</span><br><span class=\"line\">        val client = OkHttpClient.Builder().pingInterval(1000, TimeUnit.MILLISECONDS).build()</span><br><span class=\"line\">        val moshi = Moshi.Builder().build()</span><br><span class=\"line\">        val sessionDir = File(&quot;build/tmp/&quot;).apply &#123; mkdirs() &#125;</span><br><span class=\"line\">        val sessionStore = FileWCSessionStore(File(sessionDir, &quot;test_store.json&quot;).apply &#123; createNewFile() &#125;, moshi)</span><br><span class=\"line\">        val key = ByteArray(32).also &#123; Random().nextBytes(it) &#125;.toNoPrefixHexString()</span><br><span class=\"line\">        val topic  = ByteArray(32).also &#123; Random().nextBytes(it) &#125;.toNoPrefixHexString()</span><br><span class=\"line\">        println(&quot;topic: &quot; + topic)</span><br><span class=\"line\">        println(&quot;key : $key&quot;)</span><br><span class=\"line\">        val config = Session.Config(topic, &quot;http://192.168.20.18:5000&quot;, key)</span><br><span class=\"line\">        val session = WCSession(</span><br><span class=\"line\">                config,</span><br><span class=\"line\">                MoshiPayloadAdapter(moshi),</span><br><span class=\"line\">                sessionStore,</span><br><span class=\"line\">                OkHttpTransport.Builder(client, moshi),</span><br><span class=\"line\">                Session.PeerMeta(name = &quot;WC Unit Test&quot;)</span><br><span class=\"line\">        )</span><br><span class=\"line\">        session.addCallback(object : Session.Callback &#123;</span><br><span class=\"line\">            override fun onStatus(status: Session.Status) &#123;</span><br><span class=\"line\">                System.out.println(&quot;onStatus: $status&quot;)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            override fun onMethodCall(call: Session.MethodCall) &#123;</span><br><span class=\"line\">                System.out.println(&quot;onMethodCall: $call&quot;)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        session.offer()</span><br><span class=\"line\">        Thread.sleep(5000)</span><br><span class=\"line\">        println(&quot;==========================&quot;)</span><br><span class=\"line\">        val id = Random().nextLong()</span><br><span class=\"line\">        println(&quot;id: &quot;+ id)</span><br><span class=\"line\">        val p = session.performMethodCall(Session.MethodCall.Custom(id, &quot;tttt&quot;,  listOf(1,2,&quot;3&quot;,4,&quot;5&quot;)), callback = &#123; resp -&gt;</span><br><span class=\"line\">            println(resp)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        println(p)</span><br><span class=\"line\">        Thread.sleep(100000)</span><br><span class=\"line\">        session.kill()</span><br><span class=\"line\">        Thread.sleep(200000)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n"},{"title":"maven","date":"2017-10-14T05:52:37.000Z","_content":"\n## Maven\n\n### \n\nmaven maven  5  groupIdartifactIdversion packaging jarclassifier \n\n- groupId Maven  Java \n- artifactId Maven Maven  artifactId  hibernate-core-3.6.5.Final.jar\n- version\n- packaging jarwarpomzip  jar\n- classifier hibernate-core-3.6.6.Final-sources.jarhibernate-core-3.6.6.Final-javadoc.jar sources  javadoc  classifierclassifier \n\n### Maven\n\n- Dependency mediation: \n- Dependency management: B < C, CdependencyManagementBCB\n- Dependency scope: \n- Excluded dependencies: exclusionBACBAC\n- Optional dependencies: \"optional\"BACBBCAC\n\n\n\n#### \n\n\n\n- A -> B -> C ->X( 1.0)  A -> D -> X( 2.0) X( 2.0)\n- \n\n#### \n\n <exclusions> \n\n#### \n\n spring-orm-3.2.0spring-context-3.2.0 Maven \n\n```\n <properties>\n     <springframework.version>3.2.0.RELEASE</springframework.version>\n  </properties>\n\n  <dependencies>\n      <dependency>\n          <groupId>org.springframework</groupId>\n          <artifactId>spring-orm</artifactId>\n          <version>${springframework.version}</version>\n     </dependency>\n     <dependency>\n         <groupId>org.springframework</groupId>\n         <artifactId>spring-context</artifactId>\n         <version>${springframework.version}</version>\n     </dependency>\n </dependencies>\n\n```\n\n--\n\n## Maven Test\n\n1. new JUnit Case Test\n\n2.     \n\n   - setUp \n   - tearDown: \n   - constructor: \n\n3. \n\n   - @Test,\n   - @Before,\n   - @After,\n   - @Ignore, \n   - @BeforeClass, \n   - @AfterClass,\n   -  @BeforeClass  @AfterClass  Public  Static \n   - @Test(timeout  =   1000 )  \n   - @Test(expected  =  ArithmeticException. class ) \n   - 33\n\n   ```\n   \tpublic class SquareTest {\n\n   \t\tprivate static Calculator calculator = new Calculator();\n   \t\tprivate int param;\n   \t\tprivate int result;\n\n   \t\t@Parameters\n   \t      public   static  Collection data()  {\n   \t          return  Arrays.asList( new  Object[][] {\n   \t                  { 2 ,  4 } ,\n   \t                  { 0 ,  0 } ,\n   \t                  { 3 ,  9 } ,\n   \t         } );\n   \t     }\n\n   \t\t// \n   \t\tpublic SquareTest(int param, int result) {\n   \t\t\tthis.param = param;\n   \t\t\tthis.result = result;\n   \t\t}\n\n   \t\t@Test\n   \t\tpublic void square() {\n   \t\t\tcalculator.square(param);\n   \t\t\tassertEquals(result, calculator.getResult());\n   \t\t}\n\n   \t}\n   ```\n\n4. mvn test\n","source":"_posts/maven.md","raw":"---\ntitle: maven\ndate: 2017-10-14 13:52:37\ncategories:\n- java\n---\n\n## Maven\n\n### \n\nmaven maven  5  groupIdartifactIdversion packaging jarclassifier \n\n- groupId Maven  Java \n- artifactId Maven Maven  artifactId  hibernate-core-3.6.5.Final.jar\n- version\n- packaging jarwarpomzip  jar\n- classifier hibernate-core-3.6.6.Final-sources.jarhibernate-core-3.6.6.Final-javadoc.jar sources  javadoc  classifierclassifier \n\n### Maven\n\n- Dependency mediation: \n- Dependency management: B < C, CdependencyManagementBCB\n- Dependency scope: \n- Excluded dependencies: exclusionBACBAC\n- Optional dependencies: \"optional\"BACBBCAC\n\n\n\n#### \n\n\n\n- A -> B -> C ->X( 1.0)  A -> D -> X( 2.0) X( 2.0)\n- \n\n#### \n\n <exclusions> \n\n#### \n\n spring-orm-3.2.0spring-context-3.2.0 Maven \n\n```\n <properties>\n     <springframework.version>3.2.0.RELEASE</springframework.version>\n  </properties>\n\n  <dependencies>\n      <dependency>\n          <groupId>org.springframework</groupId>\n          <artifactId>spring-orm</artifactId>\n          <version>${springframework.version}</version>\n     </dependency>\n     <dependency>\n         <groupId>org.springframework</groupId>\n         <artifactId>spring-context</artifactId>\n         <version>${springframework.version}</version>\n     </dependency>\n </dependencies>\n\n```\n\n--\n\n## Maven Test\n\n1. new JUnit Case Test\n\n2.     \n\n   - setUp \n   - tearDown: \n   - constructor: \n\n3. \n\n   - @Test,\n   - @Before,\n   - @After,\n   - @Ignore, \n   - @BeforeClass, \n   - @AfterClass,\n   -  @BeforeClass  @AfterClass  Public  Static \n   - @Test(timeout  =   1000 )  \n   - @Test(expected  =  ArithmeticException. class ) \n   - 33\n\n   ```\n   \tpublic class SquareTest {\n\n   \t\tprivate static Calculator calculator = new Calculator();\n   \t\tprivate int param;\n   \t\tprivate int result;\n\n   \t\t@Parameters\n   \t      public   static  Collection data()  {\n   \t          return  Arrays.asList( new  Object[][] {\n   \t                  { 2 ,  4 } ,\n   \t                  { 0 ,  0 } ,\n   \t                  { 3 ,  9 } ,\n   \t         } );\n   \t     }\n\n   \t\t// \n   \t\tpublic SquareTest(int param, int result) {\n   \t\t\tthis.param = param;\n   \t\t\tthis.result = result;\n   \t\t}\n\n   \t\t@Test\n   \t\tpublic void square() {\n   \t\t\tcalculator.square(param);\n   \t\t\tassertEquals(result, calculator.getResult());\n   \t\t}\n\n   \t}\n   ```\n\n4. mvn test\n","slug":"maven","published":1,"updated":"2019-10-14T06:22:57.697Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69up001et6xvze4lg28j","content":"<h2 id=\"Maven\"><a href=\"#Maven\" class=\"headerlink\" title=\"Maven\"></a>Maven</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>maven maven  5  groupIdartifactIdversion packaging jarclassifier </p>\n<ul>\n<li>groupId Maven  Java </li>\n<li>artifactId Maven Maven  artifactId  hibernate-core-3.6.5.Final.jar</li>\n<li>version</li>\n<li>packaging jarwarpomzip  jar</li>\n<li>classifier hibernate-core-3.6.6.Final-sources.jarhibernate-core-3.6.6.Final-javadoc.jar sources  javadoc  classifierclassifier </li>\n</ul>\n<h3 id=\"Maven\"><a href=\"#Maven\" class=\"headerlink\" title=\"Maven\"></a>Maven</h3><ul>\n<li>Dependency mediation: </li>\n<li>Dependency management: B &lt; C, CdependencyManagementBCB</li>\n<li>Dependency scope: </li>\n<li>Excluded dependencies: exclusionBACBAC</li>\n<li>Optional dependencies: optionalBACBBCAC</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>A -&gt; B -&gt; C -&gt;X( 1.0)  A -&gt; D -&gt; X( 2.0) X( 2.0)</li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> <exclusions> </exclusions></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> spring-orm-3.2.0spring-context-3.2.0 Maven </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">    &lt;springframework.version&gt;3.2.0.RELEASE&lt;/springframework.version&gt;</span><br><span class=\"line\"> &lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;dependencies&gt;</span><br><span class=\"line\">     &lt;dependency&gt;</span><br><span class=\"line\">         &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class=\"line\">         &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;</span><br><span class=\"line\">         &lt;version&gt;$&#123;springframework.version&#125;&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;$&#123;springframework.version&#125;&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h2 id=\"Maven-Test\"><a href=\"#Maven-Test\" class=\"headerlink\" title=\"Maven Test\"></a>Maven Test</h2><ol>\n<li><p>new JUnit Case Test</p>\n</li>\n<li><p>    </p>\n<ul>\n<li>setUp </li>\n<li>tearDown: </li>\n<li>constructor: </li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>@Test,</li>\n<li>@Before,</li>\n<li>@After,</li>\n<li>@Ignore, </li>\n<li>@BeforeClass, </li>\n<li>@AfterClass,</li>\n<li> @BeforeClass  @AfterClass  Public  Static </li>\n<li>@Test(timeout  =   1000 )  </li>\n<li>@Test(expected  =  ArithmeticException. class ) </li>\n<li>33</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class SquareTest &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprivate static Calculator calculator = new Calculator();</span><br><span class=\"line\">\tprivate int param;</span><br><span class=\"line\">\tprivate int result;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Parameters</span><br><span class=\"line\">      public   static  Collection data()  &#123;</span><br><span class=\"line\">          return  Arrays.asList( new  Object[][] &#123;</span><br><span class=\"line\">                  &#123; 2 ,  4 &#125; ,</span><br><span class=\"line\">                  &#123; 0 ,  0 &#125; ,</span><br><span class=\"line\">                  &#123; 3 ,  9 &#125; ,</span><br><span class=\"line\">         &#125; );</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// </span><br><span class=\"line\">\tpublic SquareTest(int param, int result) &#123;</span><br><span class=\"line\">\t\tthis.param = param;</span><br><span class=\"line\">\t\tthis.result = result;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Test</span><br><span class=\"line\">\tpublic void square() &#123;</span><br><span class=\"line\">\t\tcalculator.square(param);</span><br><span class=\"line\">\t\tassertEquals(result, calculator.getResult());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>mvn test</p>\n</li>\n</ol>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Maven\"><a href=\"#Maven\" class=\"headerlink\" title=\"Maven\"></a>Maven</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>maven maven  5  groupIdartifactIdversion packaging jarclassifier </p>\n<ul>\n<li>groupId Maven  Java </li>\n<li>artifactId Maven Maven  artifactId  hibernate-core-3.6.5.Final.jar</li>\n<li>version</li>\n<li>packaging jarwarpomzip  jar</li>\n<li>classifier hibernate-core-3.6.6.Final-sources.jarhibernate-core-3.6.6.Final-javadoc.jar sources  javadoc  classifierclassifier </li>\n</ul>\n<h3 id=\"Maven\"><a href=\"#Maven\" class=\"headerlink\" title=\"Maven\"></a>Maven</h3><ul>\n<li>Dependency mediation: </li>\n<li>Dependency management: B &lt; C, CdependencyManagementBCB</li>\n<li>Dependency scope: </li>\n<li>Excluded dependencies: exclusionBACBAC</li>\n<li>Optional dependencies: optionalBACBBCAC</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>A -&gt; B -&gt; C -&gt;X( 1.0)  A -&gt; D -&gt; X( 2.0) X( 2.0)</li>\n<li></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> <exclusions> </exclusions></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> spring-orm-3.2.0spring-context-3.2.0 Maven </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">    &lt;springframework.version&gt;3.2.0.RELEASE&lt;/springframework.version&gt;</span><br><span class=\"line\"> &lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;dependencies&gt;</span><br><span class=\"line\">     &lt;dependency&gt;</span><br><span class=\"line\">         &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class=\"line\">         &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;</span><br><span class=\"line\">         &lt;version&gt;$&#123;springframework.version&#125;&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;$&#123;springframework.version&#125;&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h2 id=\"Maven-Test\"><a href=\"#Maven-Test\" class=\"headerlink\" title=\"Maven Test\"></a>Maven Test</h2><ol>\n<li><p>new JUnit Case Test</p>\n</li>\n<li><p>    </p>\n<ul>\n<li>setUp </li>\n<li>tearDown: </li>\n<li>constructor: </li>\n</ul>\n</li>\n<li><p></p>\n<ul>\n<li>@Test,</li>\n<li>@Before,</li>\n<li>@After,</li>\n<li>@Ignore, </li>\n<li>@BeforeClass, </li>\n<li>@AfterClass,</li>\n<li> @BeforeClass  @AfterClass  Public  Static </li>\n<li>@Test(timeout  =   1000 )  </li>\n<li>@Test(expected  =  ArithmeticException. class ) </li>\n<li>33</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class SquareTest &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\tprivate static Calculator calculator = new Calculator();</span><br><span class=\"line\">\tprivate int param;</span><br><span class=\"line\">\tprivate int result;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Parameters</span><br><span class=\"line\">      public   static  Collection data()  &#123;</span><br><span class=\"line\">          return  Arrays.asList( new  Object[][] &#123;</span><br><span class=\"line\">                  &#123; 2 ,  4 &#125; ,</span><br><span class=\"line\">                  &#123; 0 ,  0 &#125; ,</span><br><span class=\"line\">                  &#123; 3 ,  9 &#125; ,</span><br><span class=\"line\">         &#125; );</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// </span><br><span class=\"line\">\tpublic SquareTest(int param, int result) &#123;</span><br><span class=\"line\">\t\tthis.param = param;</span><br><span class=\"line\">\t\tthis.result = result;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t@Test</span><br><span class=\"line\">\tpublic void square() &#123;</span><br><span class=\"line\">\t\tcalculator.square(param);</span><br><span class=\"line\">\t\tassertEquals(result, calculator.getResult());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>mvn test</p>\n</li>\n</ol>\n"},{"title":"blockchain","date":"2019-10-14T06:36:24.000Z","_content":"\n## \n\n\n\n4VR\n\n************....\n\n****Nodejs,Go\n\n****http/rpcjson/rpcB/SServer\n\n\n\n#### \n\n\n\n- POW POW\n- POSPoS\n- DPOS  \n- PBFT \n\n\n\n#### \n\n\"\"\n\n\n\n#### \n\nQ\n\n> P2P)\n\n1. P2PBT(BitTorrent)P2P;\n2. \n3. ACQS\n4. \n5. \n\n\n\n#### \n\nPOW/POS100tx/sDPOSPBFT(100)1000tx/s\n\n\n\n#### Token\n\n\n\n- ICO  Initial Coin OfferICO\n\n\n\n#### /\n\n****\n\n\n\n> \n\n\n\n> \n\n\n\n51%\n\n#### \n\n[github](https://github.com/cryptonomex/graphene)\n\n\n\n### bft\n\n\n\nZyzzyva1BFT[18,34][9,32,40]Zyzzyva[13]\n\n\n\nZyzzyva   [9,32,40]\n\n\n\nBFT[3,9,10,21,32,40]Zyzzyva - Zyzzyva[11,20,24]\n\nZyzzyvaZyzzyva\n\n\n\n#### \n\n3f+1replicasviewsviewreplicaleader\n\nleader, leaderreplicas, replicas13f+1historyapplication-level2f+1 ~ 3f2f+1commit certificatereplicas2f+1replicascommit certificate\n\nreplicasleaderviewleader\n\n[16] 4MACout-of MAC \n\n\n\n#### \n\n2inn\n\nCP INTERVALBFT[9,10,17,32,40][16]f + 1Zyzzyva122CP INTERVAL\n\n\n### IPFS\n\nIPFSDHTBitTorrentGitSFSSFSSFSbody\n\n IPFS IPFS IPFS\n\nIPFS; IPFSIPFS IPFS\n\n- \n  \n- \n  \n- \n  DHT\n- \n  Merkle DAG\n- \n  BitSwap\n- \n  Git\n- \n  ;Go\n\n\n\nIPFS\n\n### P2P\n\nP2Ppeerpeer\n\nDHTDHTChordPastryKad\n\nDHTtrieKKadKId\n\nKKKadIDTargetId\n\n\n#### \n\n[P2P](http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi/)\n\n[DHTBT](https://github.com/shiyanhui/dht)\n\n\n\n\n\n\n\n\n\n1. https://github.com/imfly/bitcoin-on-nodejs/blob/master/\n","source":"_posts/blockchain.md","raw":"---\ntitle: blockchain\ncategories:\n  - blockchain\ndate: 2019-10-14 14:36:24\ntags:\n---\n\n## \n\n\n\n4VR\n\n************....\n\n****Nodejs,Go\n\n****http/rpcjson/rpcB/SServer\n\n\n\n#### \n\n\n\n- POW POW\n- POSPoS\n- DPOS  \n- PBFT \n\n\n\n#### \n\n\"\"\n\n\n\n#### \n\nQ\n\n> P2P)\n\n1. P2PBT(BitTorrent)P2P;\n2. \n3. ACQS\n4. \n5. \n\n\n\n#### \n\nPOW/POS100tx/sDPOSPBFT(100)1000tx/s\n\n\n\n#### Token\n\n\n\n- ICO  Initial Coin OfferICO\n\n\n\n#### /\n\n****\n\n\n\n> \n\n\n\n> \n\n\n\n51%\n\n#### \n\n[github](https://github.com/cryptonomex/graphene)\n\n\n\n### bft\n\n\n\nZyzzyva1BFT[18,34][9,32,40]Zyzzyva[13]\n\n\n\nZyzzyva   [9,32,40]\n\n\n\nBFT[3,9,10,21,32,40]Zyzzyva - Zyzzyva[11,20,24]\n\nZyzzyvaZyzzyva\n\n\n\n#### \n\n3f+1replicasviewsviewreplicaleader\n\nleader, leaderreplicas, replicas13f+1historyapplication-level2f+1 ~ 3f2f+1commit certificatereplicas2f+1replicascommit certificate\n\nreplicasleaderviewleader\n\n[16] 4MACout-of MAC \n\n\n\n#### \n\n2inn\n\nCP INTERVALBFT[9,10,17,32,40][16]f + 1Zyzzyva122CP INTERVAL\n\n\n### IPFS\n\nIPFSDHTBitTorrentGitSFSSFSSFSbody\n\n IPFS IPFS IPFS\n\nIPFS; IPFSIPFS IPFS\n\n- \n  \n- \n  \n- \n  DHT\n- \n  Merkle DAG\n- \n  BitSwap\n- \n  Git\n- \n  ;Go\n\n\n\nIPFS\n\n### P2P\n\nP2Ppeerpeer\n\nDHTDHTChordPastryKad\n\nDHTtrieKKadKId\n\nKKKadIDTargetId\n\n\n#### \n\n[P2P](http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi/)\n\n[DHTBT](https://github.com/shiyanhui/dht)\n\n\n\n\n\n\n\n\n\n1. https://github.com/imfly/bitcoin-on-nodejs/blob/master/\n","slug":"blockchain","published":1,"updated":"2019-10-14T06:39:21.716Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69wr001zt6xv3i73t48z","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>4VR</p>\n<p><strong></strong><strong></strong><strong></strong>....</p>\n<p><strong></strong>Nodejs,Go</p>\n<p><strong></strong>http/rpcjson/rpcB/SServer</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>POW POW</li>\n<li>POSPoS</li>\n<li>DPOS  </li>\n<li>PBFT </li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Q</p>\n<blockquote>\n<p>P2P)</p>\n</blockquote>\n<ol>\n<li>P2PBT(BitTorrent)P2P;</li>\n<li></li>\n<li>ACQS</li>\n<li></li>\n<li></li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>POW/POS100tx/sDPOSPBFT(100)1000tx/s</p>\n<h4 id=\"Token\"><a href=\"#Token\" class=\"headerlink\" title=\"Token\"></a>Token</h4><p></p>\n<ul>\n<li>ICO  Initial Coin OfferICO</li>\n</ul>\n<h4 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h4><p><strong></strong></p>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p></p>\n<p>51%</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://github.com/cryptonomex/graphene\">github</a></p>\n<h3 id=\"bft\"><a href=\"#bft\" class=\"headerlink\" title=\"bft\"></a>bft</h3><p>Zyzzyva1BFT[18,34][9,32,40]Zyzzyva[13]</p>\n<p>Zyzzyva   [9,32,40]</p>\n<p>BFT[3,9,10,21,32,40]Zyzzyva - Zyzzyva[11,20,24]</p>\n<p>ZyzzyvaZyzzyva</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>3f+1replicasviewsviewreplicaleader</p>\n<p>leader, leaderreplicas, replicas13f+1historyapplication-level2f+1 ~ 3f2f+1commit certificatereplicas2f+1replicascommit certificate</p>\n<p>replicasleaderviewleader</p>\n<p>[16] 4MACout-of MAC </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>2inn</p>\n<p>CP INTERVALBFT[9,10,17,32,40][16]f + 1Zyzzyva122CP INTERVAL</p>\n<h3 id=\"IPFS\"><a href=\"#IPFS\" class=\"headerlink\" title=\"IPFS\"></a>IPFS</h3><p>IPFSDHTBitTorrentGitSFSSFSSFSbody</p>\n<p> IPFS IPFS IPFS</p>\n<p>IPFS; IPFSIPFS IPFS</p>\n<ul>\n<li><br></li>\n<li><br></li>\n<li><br>DHT</li>\n<li><br>Merkle DAG</li>\n<li><br>BitSwap</li>\n<li><br>Git</li>\n<li><br>;Go</li>\n</ul>\n<p>IPFS</p>\n<h3 id=\"P2P\"><a href=\"#P2P\" class=\"headerlink\" title=\"P2P\"></a>P2P</h3><p>P2Ppeerpeer</p>\n<p>DHTDHTChordPastryKad</p>\n<p>DHTtrieKKadKId</p>\n<p>KKKadIDTargetId</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi/\" target=\"_blank\" rel=\"noopener\">P2P</a></p>\n<p><a href=\"https://github.com/shiyanhui/dht\">DHTBT</a></p>\n<p></p>\n<ol>\n<li><a href=\"https://github.com/imfly/bitcoin-on-nodejs/blob/master/\">https://github.com/imfly/bitcoin-on-nodejs/blob/master/</a></li>\n</ol>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>4VR</p>\n<p><strong></strong><strong></strong><strong></strong>....</p>\n<p><strong></strong>Nodejs,Go</p>\n<p><strong></strong>http/rpcjson/rpcB/SServer</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ul>\n<li>POW POW</li>\n<li>POSPoS</li>\n<li>DPOS  </li>\n<li>PBFT </li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>Q</p>\n<blockquote>\n<p>P2P)</p>\n</blockquote>\n<ol>\n<li>P2PBT(BitTorrent)P2P;</li>\n<li></li>\n<li>ACQS</li>\n<li></li>\n<li></li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>POW/POS100tx/sDPOSPBFT(100)1000tx/s</p>\n<h4 id=\"Token\"><a href=\"#Token\" class=\"headerlink\" title=\"Token\"></a>Token</h4><p></p>\n<ul>\n<li>ICO  Initial Coin OfferICO</li>\n</ul>\n<h4 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h4><p><strong></strong></p>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<p></p>\n<p>51%</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://github.com/cryptonomex/graphene\">github</a></p>\n<h3 id=\"bft\"><a href=\"#bft\" class=\"headerlink\" title=\"bft\"></a>bft</h3><p>Zyzzyva1BFT[18,34][9,32,40]Zyzzyva[13]</p>\n<p>Zyzzyva   [9,32,40]</p>\n<p>BFT[3,9,10,21,32,40]Zyzzyva - Zyzzyva[11,20,24]</p>\n<p>ZyzzyvaZyzzyva</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>3f+1replicasviewsviewreplicaleader</p>\n<p>leader, leaderreplicas, replicas13f+1historyapplication-level2f+1 ~ 3f2f+1commit certificatereplicas2f+1replicascommit certificate</p>\n<p>replicasleaderviewleader</p>\n<p>[16] 4MACout-of MAC </p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>2inn</p>\n<p>CP INTERVALBFT[9,10,17,32,40][16]f + 1Zyzzyva122CP INTERVAL</p>\n<h3 id=\"IPFS\"><a href=\"#IPFS\" class=\"headerlink\" title=\"IPFS\"></a>IPFS</h3><p>IPFSDHTBitTorrentGitSFSSFSSFSbody</p>\n<p> IPFS IPFS IPFS</p>\n<p>IPFS; IPFSIPFS IPFS</p>\n<ul>\n<li><br></li>\n<li><br></li>\n<li><br>DHT</li>\n<li><br>Merkle DAG</li>\n<li><br>BitSwap</li>\n<li><br>Git</li>\n<li><br>;Go</li>\n</ul>\n<p>IPFS</p>\n<h3 id=\"P2P\"><a href=\"#P2P\" class=\"headerlink\" title=\"P2P\"></a>P2P</h3><p>P2Ppeerpeer</p>\n<p>DHTDHTChordPastryKad</p>\n<p>DHTtrieKKadKId</p>\n<p>KKKadIDTargetId</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"http://qjpcpu.github.io/blog/2018/01/30/shen-ru-ethereumyuan-ma-p2pmo-kuai-jie-dian-fa-xian-ji-zhi/\" target=\"_blank\" rel=\"noopener\">P2P</a></p>\n<p><a href=\"https://github.com/shiyanhui/dht\">DHTBT</a></p>\n<p></p>\n<ol>\n<li><a href=\"https://github.com/imfly/bitcoin-on-nodejs/blob/master/\">https://github.com/imfly/bitcoin-on-nodejs/blob/master/</a></li>\n</ol>\n"},{"title":"btc_data_dat","date":"2019-04-14T07:16:51.000Z","_content":"\n\n\n## btc dat\n\nBitcoin coredatindexindexldb \n\ndatldbdat/ \n\n\n\n https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage \n\n\n\nldb \n\n ```\n  'b' + 32-byte block hash -> block index record. Each record stores: \n\n       * The block header \n\n       * The height. \n\n       * The number of transactions. \n\n       * To what extent this block is validated. \n\n       * In which file, and where in that file, the block data is stored. \n\n       * In which file, and where in that file, the undo data is stored. \n\n ```\n\ndat \n\n```\n/*\n@Time : 2019/4/4 6:57\n@Author : xiaoxuez\n*/\n\npackage main\n\nimport (\n   \"encoding/binary\"\n   \"encoding/hex\"\n   \"errors\"\n   \"flag\"\n   \"fmt\"\n   \"io\"\n   \"os\"\n   \"path\"\n   \"sync\"\n\n   \"git.wokoworks.com/blockchain/btc-explorer/db\"\n   \"git.wokoworks.com/blockchain/btc-explorer/log\"\n)\n\ntype readBlockChain struct {\n   height    uint64\n   blockHash [32]byte\n}\n\nvar indexLDB *db.LDBDatabase\nvar blSourceDir string\nvar blDirtyDir string\n\nfunc main() {\n   log.InitHandler(log.Root(), log.LvlTrace, \"logs/reorder.log\")\n   var err error\n   flag.StringVar(&blSourceDir, \"old\", \"/Users/xiaoxuez/btc_test_db/mainnet/\", \"xx\")\n   flag.StringVar(&blDirtyDir, \"new\", \"/Users/xiaoxuez/btc_test_db/reorder\", \"xx\")\n   flag.Parse()\n   //bmdb, err = db.NewLDBDatabase(\"/Users/xiaoxuez/btc_test_db/mainnet/index\", 0, 0)\n   indexLDB, err = db.NewLDBDatabase(path.Join(blSourceDir, \"index\"), 0, 0)\n   if err != nil {\n      panic(err)\n   }\n   //len must < 24\n   var data = []readBlockChain{\n      {\n         height:    0,\n         blockHash: hexToHash(\"00000000000003a20def7a05a77361b9657ff954b2f2080e135ea6f5970da215\"), // 20-1\n      },\n      {\n         height:    20 * 10000,\n         blockHash: hexToHash(\"0000000000000009c2e82d884ec07b4aafb64ca3ef83baca2b6b0b5eb72c8f02\"), // 25-1\n      },\n      //{\n      // height:    25 * 10000,\n      // blockHash: hexToHash(\"000000000000000067ecc744b5ae34eebbde14d21ca4db51652e4d67e155f07e\"), // 30-1\n      //},\n      //{\n      // height:    30 * 10000,\n      // blockHash: hexToHash(\"000000000000000002045664f89a1077d0c6c0aaa6dd89b485208cf92d6bbd30\"), // 35-1\n      //},\n      //{\n      // height:    35 * 10000,\n      // blockHash: hexToHash(\"0000000000000000030034b661aed920a9bdf6bbfa6d2e7a021f78481882fa39\"), // 40-1\n      //},\n      //{\n      // height:    40 * 10000,\n      // blockHash: hexToHash(\"0000000000000000024c4a35f0485bab79ce341cdd5cc6b15186d9b5b57bf3da\"), // 45-1\n      //},\n      //{\n      // height:    45 * 10000,\n      // blockHash: hexToHash(\"0000000000000000007962066dcd6675830883516bcf40047d42740a85eb2919\"), // 50\n      //},\n      //{\n      // height:    50 * 10000,\n      // blockHash: hexToHash(\"00000000000000000013dad60a42a3401a8f37ca02f1c00ac5923e674566a3ae\"), // 55\n      //},\n   }\n   if len(data) > 24 {\n      log.Error(\"parallel number must < 24\", \"actual \", len(data))\n      return\n   }\n   var wg sync.WaitGroup\n   for index, v := range data {\n      wg.Add(1)\n      go func(index int, v readBlockChain) {\n         rwBlocks(v.blockHash[:], v.height, fmt.Sprint(index), func() { wg.Done() })\n      }(index, v)\n   }\n   wg.Wait()\n}\n\nfunc rwBlocks(startBlock []byte, endHeight uint64, prefix string, callback func()) {\n   defer callback()\n   fileCache := make(map[uint64]*os.File, 0)\n   blockHash := startBlock\n   reverWriter := NewReverseWriter(blDirtyDir, 138*1024*1024, prefix)\n   defer reverWriter.Flush()\n   count := 0\n   for {\n      content, height, err := rwBlock(fileCache, blockHash)\n      if err != nil {\n         log.Error(\"rw block\", \"err\", err.Error())\n         return\n      }\n      blockHash = content[12:44]\n      err = reverWriter.Insert(content)\n      if err != nil {\n         fmt.Println(\"writer err\", err)\n         return\n      }\n      if height == endHeight {\n         log.Info(\"finish to save block height\", \"height\", height)\n         return\n      }\n      if height%3000 == 0 {\n         log.Trace(\"====>\", \"height\", height, \"parent block hash\", hashToHex(blockHash))\n      }\n      count++\n   }\n   log.Info(\"write file end\", \"count\", count)\n}\n\nfunc rwBlock(fileCache map[uint64]*os.File, block []byte) ([]byte, uint64, error) {\n   value, err := indexLDB.Get(append([]byte(\"b\"), block...))\n   if err != nil {\n      return []byte{}, 0, errors.New(fmt.Sprintf(\"%s%s\", err.Error(), hashToHex(block)))\n   }\n   bm := parseBlockMeta(value)\n   file, ok := fileCache[bm.file]\n   if !ok {\n      file, err = os.Open(idx2fname(blSourceDir, uint32(bm.file)))\n      if err != nil {\n         return []byte{}, 0, err\n      }\n      fileCache[bm.file] = file\n   }\n   file.Seek(int64(bm.dataPos-8), io.SeekStart)\n   res, err := readBlockFromFile(file)\n\n   if err != nil {\n      return []byte{}, 0, err\n   }\n   binary.LittleEndian.PutUint32(res[:4], uint32(bm.height))\n   return res, bm.height, err\n}\n\nfunc readBlockFromFile(f *os.File) (res []byte, e error) {\n   var buf [4]byte\n   _, e = f.Read(buf[:])\n   _, e = f.Read(buf[:])\n   if e != nil {\n      return\n   }\n   le := uint32(lsb2uint(buf[:]))\n   if le < 81 {\n      e = errors.New(fmt.Sprintf(\"Incorrect block size %d\", le))\n      return\n   }\n\n   res = make([]byte, le+8)\n   copy(res[4:8], buf[:])\n   _, e = f.Read(res[8:])\n   if e != nil {\n      return\n   }\n   return\n}\nfunc idx2fname(dir string, fidx uint32) (s string) {\n   if fidx == 0xffffffff {\n      return \"blk99999.dat\"\n   }\n   return fmt.Sprintf(\"%s/blk%05d.dat\", dir, fidx)\n}\nfunc lsb2uint(lt []byte) (res uint64) {\n   for i := 0; i < len(lt); i++ {\n      res |= uint64(lt[i]) << uint(i*8)\n   }\n   return\n}\n\ntype blockMeta struct {\n   version uint64\n   height  uint64\n   status  uint64\n   nTx     uint64\n   file    uint64\n   dataPos uint64\n   undoPos uint64\n}\n\nfunc parseBlockMeta(raw []byte) (bm blockMeta) {\n   var pos uint64\n   var i uint64\n   bm.version, i = readRawData(raw[pos:])\n   pos += i\n   bm.height, i = readRawData(raw[pos:])\n   pos += i\n   bm.status, i = readRawData(raw[pos:])\n   pos += i\n   bm.nTx, i = readRawData(raw[pos:])\n   pos += i\n   bm.file, i = readRawData(raw[pos:])\n   pos += i\n   bm.dataPos, i = readRawData(raw[pos:])\n   pos += i\n   bm.undoPos, i = readRawData(raw[pos:])\n   return\n}\n\nfunc readRawData(raw []byte) (uint64, uint64) {\n   var n uint64\n   var pos uint64\n   for {\n      data := raw[pos]\n      pos += 1\n      n = (n << 7) | (uint64(data) & 0x7f)\n      if data&0x80 == 0 {\n         return n, pos\n      }\n      n += 1\n   }\n}\n\nfunc hashToHex(hash []byte) (s string) {\n   for i := 0; i < 32; i++ {\n      s += fmt.Sprintf(\"%02x\", hash[31-i])\n   }\n   return\n}\n\nfunc hexToHash(s string) (res [32]byte) {\n   d, e := hex.DecodeString(s)\n   if e != nil {\n      return\n   }\n   if len(d) != 32 {\n      return\n   }\n   for i := 0; i < 32; i++ {\n      res[31-i] = d[i]\n   }\n   return\n}\n\ntype ReverseWriter struct {\n   Dir          string\n   CacheMaxSize int\n   len          int\n   cache        []byte\n   seek         int\n   index        int\n   Prefix       string\n}\n\nfunc NewReverseWriter(dir string, cacheSize int, prefix string) *ReverseWriter {\n   rw := &ReverseWriter{Dir: dir, CacheMaxSize: cacheSize, Prefix: prefix}\n   rw.init()\n   return rw\n}\n\nfunc (rw *ReverseWriter) init() {\n   rw.len = 0\n   rw.cache = make([]byte, rw.CacheMaxSize)\n   rw.seek = rw.CacheMaxSize\n}\n\nfunc (rw *ReverseWriter) Insert(content []byte) error {\n   if rw.len+len(content) > rw.CacheMaxSize {\n      err := rw.writeToFile()\n      if err != nil {\n         return err\n      }\n      rw.index++\n      rw.init()\n   }\n   copy(rw.cache[rw.seek-len(content):rw.seek], content)\n   rw.seek = rw.seek - len(content)\n   rw.len += len(content)\n   return nil\n}\n\nfunc (rw *ReverseWriter) writeToFile() error {\n   if rw.len == 0 {\n      return nil\n   }\n   writer, err := os.OpenFile(fmt.Sprintf(\"%s/%sblk%05d.dat\", rw.Dir, rw.Prefix, rw.index), os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0666)\n   if err != nil {\n      return err\n   }\n   _, err = writer.Write(rw.cache[rw.seek:])\n   return err\n}\n\nfunc (rw *ReverseWriter) Flush() error {\n   err := rw.writeToFile()\n   rw.index++\n   rw.init()\n   return err\n}\n\n\n\n#!/usr/bin/env bash\n\n# shell is funny\n\nread -p \"Are you sure:(y/n) \" an\nif [[ ${an} != \"y\" ]]; then exit; fi\n\ncd /Users/woko/bitcoin\n\nfunction rename_2() {\n    index=0\n    for name in $(ls | grep .dat) ; do\n        if [[ -f ${name} ]]; then\n            rename=$(echo ${index}|awk '{printf(\"blk%05d.dat\",$0)}')\n            echo ${name} \" ==> \" ${rename}\n            mv ${name} ${rename}\n            ((index=index+1))\n        fi\n    done\n}\n\nfunction rename_1() {\n    count=0\n    for (( i = 0; i < 10; ++i )); do\n        index=$(ls ${count}*.dat | wc -l)\n        for name in $(ls ${count}*.dat) ; do\n            if [[ -f ${name} ]]; then\n                ((index=index-1))\n                rename=$(echo \"${count} ${index}\"|awk '{printf(\"%02dblk%05d.dat\",$1,$2)}')\n                echo ${name} \" ==> \" ${rename}\n                mv ${name} ${rename}\n            fi\n        done\n        ((count=count+1))\n        echo \"--------------\"\n    done\n}\n\nrename_1\necho \"==============\"\nrename_2\n\n```\n\n","source":"_posts/btc-data-dat.md","raw":"---\ntitle: btc_data_dat\ncategories:\n  - btc\ndate: 2019-4-14 15:16:51\ntags:\n---\n\n\n\n## btc dat\n\nBitcoin coredatindexindexldb \n\ndatldbdat/ \n\n\n\n https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage \n\n\n\nldb \n\n ```\n  'b' + 32-byte block hash -> block index record. Each record stores: \n\n       * The block header \n\n       * The height. \n\n       * The number of transactions. \n\n       * To what extent this block is validated. \n\n       * In which file, and where in that file, the block data is stored. \n\n       * In which file, and where in that file, the undo data is stored. \n\n ```\n\ndat \n\n```\n/*\n@Time : 2019/4/4 6:57\n@Author : xiaoxuez\n*/\n\npackage main\n\nimport (\n   \"encoding/binary\"\n   \"encoding/hex\"\n   \"errors\"\n   \"flag\"\n   \"fmt\"\n   \"io\"\n   \"os\"\n   \"path\"\n   \"sync\"\n\n   \"git.wokoworks.com/blockchain/btc-explorer/db\"\n   \"git.wokoworks.com/blockchain/btc-explorer/log\"\n)\n\ntype readBlockChain struct {\n   height    uint64\n   blockHash [32]byte\n}\n\nvar indexLDB *db.LDBDatabase\nvar blSourceDir string\nvar blDirtyDir string\n\nfunc main() {\n   log.InitHandler(log.Root(), log.LvlTrace, \"logs/reorder.log\")\n   var err error\n   flag.StringVar(&blSourceDir, \"old\", \"/Users/xiaoxuez/btc_test_db/mainnet/\", \"xx\")\n   flag.StringVar(&blDirtyDir, \"new\", \"/Users/xiaoxuez/btc_test_db/reorder\", \"xx\")\n   flag.Parse()\n   //bmdb, err = db.NewLDBDatabase(\"/Users/xiaoxuez/btc_test_db/mainnet/index\", 0, 0)\n   indexLDB, err = db.NewLDBDatabase(path.Join(blSourceDir, \"index\"), 0, 0)\n   if err != nil {\n      panic(err)\n   }\n   //len must < 24\n   var data = []readBlockChain{\n      {\n         height:    0,\n         blockHash: hexToHash(\"00000000000003a20def7a05a77361b9657ff954b2f2080e135ea6f5970da215\"), // 20-1\n      },\n      {\n         height:    20 * 10000,\n         blockHash: hexToHash(\"0000000000000009c2e82d884ec07b4aafb64ca3ef83baca2b6b0b5eb72c8f02\"), // 25-1\n      },\n      //{\n      // height:    25 * 10000,\n      // blockHash: hexToHash(\"000000000000000067ecc744b5ae34eebbde14d21ca4db51652e4d67e155f07e\"), // 30-1\n      //},\n      //{\n      // height:    30 * 10000,\n      // blockHash: hexToHash(\"000000000000000002045664f89a1077d0c6c0aaa6dd89b485208cf92d6bbd30\"), // 35-1\n      //},\n      //{\n      // height:    35 * 10000,\n      // blockHash: hexToHash(\"0000000000000000030034b661aed920a9bdf6bbfa6d2e7a021f78481882fa39\"), // 40-1\n      //},\n      //{\n      // height:    40 * 10000,\n      // blockHash: hexToHash(\"0000000000000000024c4a35f0485bab79ce341cdd5cc6b15186d9b5b57bf3da\"), // 45-1\n      //},\n      //{\n      // height:    45 * 10000,\n      // blockHash: hexToHash(\"0000000000000000007962066dcd6675830883516bcf40047d42740a85eb2919\"), // 50\n      //},\n      //{\n      // height:    50 * 10000,\n      // blockHash: hexToHash(\"00000000000000000013dad60a42a3401a8f37ca02f1c00ac5923e674566a3ae\"), // 55\n      //},\n   }\n   if len(data) > 24 {\n      log.Error(\"parallel number must < 24\", \"actual \", len(data))\n      return\n   }\n   var wg sync.WaitGroup\n   for index, v := range data {\n      wg.Add(1)\n      go func(index int, v readBlockChain) {\n         rwBlocks(v.blockHash[:], v.height, fmt.Sprint(index), func() { wg.Done() })\n      }(index, v)\n   }\n   wg.Wait()\n}\n\nfunc rwBlocks(startBlock []byte, endHeight uint64, prefix string, callback func()) {\n   defer callback()\n   fileCache := make(map[uint64]*os.File, 0)\n   blockHash := startBlock\n   reverWriter := NewReverseWriter(blDirtyDir, 138*1024*1024, prefix)\n   defer reverWriter.Flush()\n   count := 0\n   for {\n      content, height, err := rwBlock(fileCache, blockHash)\n      if err != nil {\n         log.Error(\"rw block\", \"err\", err.Error())\n         return\n      }\n      blockHash = content[12:44]\n      err = reverWriter.Insert(content)\n      if err != nil {\n         fmt.Println(\"writer err\", err)\n         return\n      }\n      if height == endHeight {\n         log.Info(\"finish to save block height\", \"height\", height)\n         return\n      }\n      if height%3000 == 0 {\n         log.Trace(\"====>\", \"height\", height, \"parent block hash\", hashToHex(blockHash))\n      }\n      count++\n   }\n   log.Info(\"write file end\", \"count\", count)\n}\n\nfunc rwBlock(fileCache map[uint64]*os.File, block []byte) ([]byte, uint64, error) {\n   value, err := indexLDB.Get(append([]byte(\"b\"), block...))\n   if err != nil {\n      return []byte{}, 0, errors.New(fmt.Sprintf(\"%s%s\", err.Error(), hashToHex(block)))\n   }\n   bm := parseBlockMeta(value)\n   file, ok := fileCache[bm.file]\n   if !ok {\n      file, err = os.Open(idx2fname(blSourceDir, uint32(bm.file)))\n      if err != nil {\n         return []byte{}, 0, err\n      }\n      fileCache[bm.file] = file\n   }\n   file.Seek(int64(bm.dataPos-8), io.SeekStart)\n   res, err := readBlockFromFile(file)\n\n   if err != nil {\n      return []byte{}, 0, err\n   }\n   binary.LittleEndian.PutUint32(res[:4], uint32(bm.height))\n   return res, bm.height, err\n}\n\nfunc readBlockFromFile(f *os.File) (res []byte, e error) {\n   var buf [4]byte\n   _, e = f.Read(buf[:])\n   _, e = f.Read(buf[:])\n   if e != nil {\n      return\n   }\n   le := uint32(lsb2uint(buf[:]))\n   if le < 81 {\n      e = errors.New(fmt.Sprintf(\"Incorrect block size %d\", le))\n      return\n   }\n\n   res = make([]byte, le+8)\n   copy(res[4:8], buf[:])\n   _, e = f.Read(res[8:])\n   if e != nil {\n      return\n   }\n   return\n}\nfunc idx2fname(dir string, fidx uint32) (s string) {\n   if fidx == 0xffffffff {\n      return \"blk99999.dat\"\n   }\n   return fmt.Sprintf(\"%s/blk%05d.dat\", dir, fidx)\n}\nfunc lsb2uint(lt []byte) (res uint64) {\n   for i := 0; i < len(lt); i++ {\n      res |= uint64(lt[i]) << uint(i*8)\n   }\n   return\n}\n\ntype blockMeta struct {\n   version uint64\n   height  uint64\n   status  uint64\n   nTx     uint64\n   file    uint64\n   dataPos uint64\n   undoPos uint64\n}\n\nfunc parseBlockMeta(raw []byte) (bm blockMeta) {\n   var pos uint64\n   var i uint64\n   bm.version, i = readRawData(raw[pos:])\n   pos += i\n   bm.height, i = readRawData(raw[pos:])\n   pos += i\n   bm.status, i = readRawData(raw[pos:])\n   pos += i\n   bm.nTx, i = readRawData(raw[pos:])\n   pos += i\n   bm.file, i = readRawData(raw[pos:])\n   pos += i\n   bm.dataPos, i = readRawData(raw[pos:])\n   pos += i\n   bm.undoPos, i = readRawData(raw[pos:])\n   return\n}\n\nfunc readRawData(raw []byte) (uint64, uint64) {\n   var n uint64\n   var pos uint64\n   for {\n      data := raw[pos]\n      pos += 1\n      n = (n << 7) | (uint64(data) & 0x7f)\n      if data&0x80 == 0 {\n         return n, pos\n      }\n      n += 1\n   }\n}\n\nfunc hashToHex(hash []byte) (s string) {\n   for i := 0; i < 32; i++ {\n      s += fmt.Sprintf(\"%02x\", hash[31-i])\n   }\n   return\n}\n\nfunc hexToHash(s string) (res [32]byte) {\n   d, e := hex.DecodeString(s)\n   if e != nil {\n      return\n   }\n   if len(d) != 32 {\n      return\n   }\n   for i := 0; i < 32; i++ {\n      res[31-i] = d[i]\n   }\n   return\n}\n\ntype ReverseWriter struct {\n   Dir          string\n   CacheMaxSize int\n   len          int\n   cache        []byte\n   seek         int\n   index        int\n   Prefix       string\n}\n\nfunc NewReverseWriter(dir string, cacheSize int, prefix string) *ReverseWriter {\n   rw := &ReverseWriter{Dir: dir, CacheMaxSize: cacheSize, Prefix: prefix}\n   rw.init()\n   return rw\n}\n\nfunc (rw *ReverseWriter) init() {\n   rw.len = 0\n   rw.cache = make([]byte, rw.CacheMaxSize)\n   rw.seek = rw.CacheMaxSize\n}\n\nfunc (rw *ReverseWriter) Insert(content []byte) error {\n   if rw.len+len(content) > rw.CacheMaxSize {\n      err := rw.writeToFile()\n      if err != nil {\n         return err\n      }\n      rw.index++\n      rw.init()\n   }\n   copy(rw.cache[rw.seek-len(content):rw.seek], content)\n   rw.seek = rw.seek - len(content)\n   rw.len += len(content)\n   return nil\n}\n\nfunc (rw *ReverseWriter) writeToFile() error {\n   if rw.len == 0 {\n      return nil\n   }\n   writer, err := os.OpenFile(fmt.Sprintf(\"%s/%sblk%05d.dat\", rw.Dir, rw.Prefix, rw.index), os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0666)\n   if err != nil {\n      return err\n   }\n   _, err = writer.Write(rw.cache[rw.seek:])\n   return err\n}\n\nfunc (rw *ReverseWriter) Flush() error {\n   err := rw.writeToFile()\n   rw.index++\n   rw.init()\n   return err\n}\n\n\n\n#!/usr/bin/env bash\n\n# shell is funny\n\nread -p \"Are you sure:(y/n) \" an\nif [[ ${an} != \"y\" ]]; then exit; fi\n\ncd /Users/woko/bitcoin\n\nfunction rename_2() {\n    index=0\n    for name in $(ls | grep .dat) ; do\n        if [[ -f ${name} ]]; then\n            rename=$(echo ${index}|awk '{printf(\"blk%05d.dat\",$0)}')\n            echo ${name} \" ==> \" ${rename}\n            mv ${name} ${rename}\n            ((index=index+1))\n        fi\n    done\n}\n\nfunction rename_1() {\n    count=0\n    for (( i = 0; i < 10; ++i )); do\n        index=$(ls ${count}*.dat | wc -l)\n        for name in $(ls ${count}*.dat) ; do\n            if [[ -f ${name} ]]; then\n                ((index=index-1))\n                rename=$(echo \"${count} ${index}\"|awk '{printf(\"%02dblk%05d.dat\",$1,$2)}')\n                echo ${name} \" ==> \" ${rename}\n                mv ${name} ${rename}\n            fi\n        done\n        ((count=count+1))\n        echo \"--------------\"\n    done\n}\n\nrename_1\necho \"==============\"\nrename_2\n\n```\n\n","slug":"btc-data-dat","published":1,"updated":"2019-10-14T07:25:23.831Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ws0020t6xvh0q0kffa","content":"<h2 id=\"btc-dat\"><a href=\"#btc-dat\" class=\"headerlink\" title=\"btc dat\"></a>btc dat</h2><p>Bitcoin coredatindexindexldb </p>\n<p>datldbdat/ </p>\n<p> <a href=\"https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage\" target=\"_blank\" rel=\"noopener\">https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage</a> </p>\n<p>ldb </p>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;b&apos; + 32-byte block hash -&gt; block index record. Each record stores: </span><br><span class=\"line\"></span><br><span class=\"line\">     * The block header </span><br><span class=\"line\"></span><br><span class=\"line\">     * The height. </span><br><span class=\"line\"></span><br><span class=\"line\">     * The number of transactions. </span><br><span class=\"line\"></span><br><span class=\"line\">     * To what extent this block is validated. </span><br><span class=\"line\"></span><br><span class=\"line\">     * In which file, and where in that file, the block data is stored. </span><br><span class=\"line\"></span><br><span class=\"line\">     * In which file, and where in that file, the undo data is stored.</span><br></pre></td></tr></table></figure>\n\n<p>dat </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*</span><br><span class=\"line\">@Time : 2019/4/4 6:57</span><br><span class=\"line\">@Author : xiaoxuez</span><br><span class=\"line\">*/</span><br><span class=\"line\"></span><br><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">   &quot;encoding/binary&quot;</span><br><span class=\"line\">   &quot;encoding/hex&quot;</span><br><span class=\"line\">   &quot;errors&quot;</span><br><span class=\"line\">   &quot;flag&quot;</span><br><span class=\"line\">   &quot;fmt&quot;</span><br><span class=\"line\">   &quot;io&quot;</span><br><span class=\"line\">   &quot;os&quot;</span><br><span class=\"line\">   &quot;path&quot;</span><br><span class=\"line\">   &quot;sync&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">   &quot;git.wokoworks.com/blockchain/btc-explorer/db&quot;</span><br><span class=\"line\">   &quot;git.wokoworks.com/blockchain/btc-explorer/log&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type readBlockChain struct &#123;</span><br><span class=\"line\">   height    uint64</span><br><span class=\"line\">   blockHash [32]byte</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var indexLDB *db.LDBDatabase</span><br><span class=\"line\">var blSourceDir string</span><br><span class=\"line\">var blDirtyDir string</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">   log.InitHandler(log.Root(), log.LvlTrace, &quot;logs/reorder.log&quot;)</span><br><span class=\"line\">   var err error</span><br><span class=\"line\">   flag.StringVar(&amp;blSourceDir, &quot;old&quot;, &quot;/Users/xiaoxuez/btc_test_db/mainnet/&quot;, &quot;xx&quot;)</span><br><span class=\"line\">   flag.StringVar(&amp;blDirtyDir, &quot;new&quot;, &quot;/Users/xiaoxuez/btc_test_db/reorder&quot;, &quot;xx&quot;)</span><br><span class=\"line\">   flag.Parse()</span><br><span class=\"line\">   //bmdb, err = db.NewLDBDatabase(&quot;/Users/xiaoxuez/btc_test_db/mainnet/index&quot;, 0, 0)</span><br><span class=\"line\">   indexLDB, err = db.NewLDBDatabase(path.Join(blSourceDir, &quot;index&quot;), 0, 0)</span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      panic(err)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   //len must &lt; 24</span><br><span class=\"line\">   var data = []readBlockChain&#123;</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         height:    0,</span><br><span class=\"line\">         blockHash: hexToHash(&quot;00000000000003a20def7a05a77361b9657ff954b2f2080e135ea6f5970da215&quot;), // 20-1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         height:    20 * 10000,</span><br><span class=\"line\">         blockHash: hexToHash(&quot;0000000000000009c2e82d884ec07b4aafb64ca3ef83baca2b6b0b5eb72c8f02&quot;), // 25-1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    25 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;000000000000000067ecc744b5ae34eebbde14d21ca4db51652e4d67e155f07e&quot;), // 30-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    30 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;000000000000000002045664f89a1077d0c6c0aaa6dd89b485208cf92d6bbd30&quot;), // 35-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    35 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;0000000000000000030034b661aed920a9bdf6bbfa6d2e7a021f78481882fa39&quot;), // 40-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    40 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;0000000000000000024c4a35f0485bab79ce341cdd5cc6b15186d9b5b57bf3da&quot;), // 45-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    45 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;0000000000000000007962066dcd6675830883516bcf40047d42740a85eb2919&quot;), // 50</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    50 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;00000000000000000013dad60a42a3401a8f37ca02f1c00ac5923e674566a3ae&quot;), // 55</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   if len(data) &gt; 24 &#123;</span><br><span class=\"line\">      log.Error(&quot;parallel number must &lt; 24&quot;, &quot;actual &quot;, len(data))</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   var wg sync.WaitGroup</span><br><span class=\"line\">   for index, v := range data &#123;</span><br><span class=\"line\">      wg.Add(1)</span><br><span class=\"line\">      go func(index int, v readBlockChain) &#123;</span><br><span class=\"line\">         rwBlocks(v.blockHash[:], v.height, fmt.Sprint(index), func() &#123; wg.Done() &#125;)</span><br><span class=\"line\">      &#125;(index, v)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   wg.Wait()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func rwBlocks(startBlock []byte, endHeight uint64, prefix string, callback func()) &#123;</span><br><span class=\"line\">   defer callback()</span><br><span class=\"line\">   fileCache := make(map[uint64]*os.File, 0)</span><br><span class=\"line\">   blockHash := startBlock</span><br><span class=\"line\">   reverWriter := NewReverseWriter(blDirtyDir, 138*1024*1024, prefix)</span><br><span class=\"line\">   defer reverWriter.Flush()</span><br><span class=\"line\">   count := 0</span><br><span class=\"line\">   for &#123;</span><br><span class=\"line\">      content, height, err := rwBlock(fileCache, blockHash)</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         log.Error(&quot;rw block&quot;, &quot;err&quot;, err.Error())</span><br><span class=\"line\">         return</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      blockHash = content[12:44]</span><br><span class=\"line\">      err = reverWriter.Insert(content)</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         fmt.Println(&quot;writer err&quot;, err)</span><br><span class=\"line\">         return</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if height == endHeight &#123;</span><br><span class=\"line\">         log.Info(&quot;finish to save block height&quot;, &quot;height&quot;, height)</span><br><span class=\"line\">         return</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if height%3000 == 0 &#123;</span><br><span class=\"line\">         log.Trace(&quot;====&gt;&quot;, &quot;height&quot;, height, &quot;parent block hash&quot;, hashToHex(blockHash))</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      count++</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   log.Info(&quot;write file end&quot;, &quot;count&quot;, count)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func rwBlock(fileCache map[uint64]*os.File, block []byte) ([]byte, uint64, error) &#123;</span><br><span class=\"line\">   value, err := indexLDB.Get(append([]byte(&quot;b&quot;), block...))</span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      return []byte&#123;&#125;, 0, errors.New(fmt.Sprintf(&quot;%s%s&quot;, err.Error(), hashToHex(block)))</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   bm := parseBlockMeta(value)</span><br><span class=\"line\">   file, ok := fileCache[bm.file]</span><br><span class=\"line\">   if !ok &#123;</span><br><span class=\"line\">      file, err = os.Open(idx2fname(blSourceDir, uint32(bm.file)))</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         return []byte&#123;&#125;, 0, err</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      fileCache[bm.file] = file</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   file.Seek(int64(bm.dataPos-8), io.SeekStart)</span><br><span class=\"line\">   res, err := readBlockFromFile(file)</span><br><span class=\"line\"></span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      return []byte&#123;&#125;, 0, err</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   binary.LittleEndian.PutUint32(res[:4], uint32(bm.height))</span><br><span class=\"line\">   return res, bm.height, err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func readBlockFromFile(f *os.File) (res []byte, e error) &#123;</span><br><span class=\"line\">   var buf [4]byte</span><br><span class=\"line\">   _, e = f.Read(buf[:])</span><br><span class=\"line\">   _, e = f.Read(buf[:])</span><br><span class=\"line\">   if e != nil &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   le := uint32(lsb2uint(buf[:]))</span><br><span class=\"line\">   if le &lt; 81 &#123;</span><br><span class=\"line\">      e = errors.New(fmt.Sprintf(&quot;Incorrect block size %d&quot;, le))</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   res = make([]byte, le+8)</span><br><span class=\"line\">   copy(res[4:8], buf[:])</span><br><span class=\"line\">   _, e = f.Read(res[8:])</span><br><span class=\"line\">   if e != nil &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func idx2fname(dir string, fidx uint32) (s string) &#123;</span><br><span class=\"line\">   if fidx == 0xffffffff &#123;</span><br><span class=\"line\">      return &quot;blk99999.dat&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return fmt.Sprintf(&quot;%s/blk%05d.dat&quot;, dir, fidx)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func lsb2uint(lt []byte) (res uint64) &#123;</span><br><span class=\"line\">   for i := 0; i &lt; len(lt); i++ &#123;</span><br><span class=\"line\">      res |= uint64(lt[i]) &lt;&lt; uint(i*8)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type blockMeta struct &#123;</span><br><span class=\"line\">   version uint64</span><br><span class=\"line\">   height  uint64</span><br><span class=\"line\">   status  uint64</span><br><span class=\"line\">   nTx     uint64</span><br><span class=\"line\">   file    uint64</span><br><span class=\"line\">   dataPos uint64</span><br><span class=\"line\">   undoPos uint64</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func parseBlockMeta(raw []byte) (bm blockMeta) &#123;</span><br><span class=\"line\">   var pos uint64</span><br><span class=\"line\">   var i uint64</span><br><span class=\"line\">   bm.version, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.height, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.status, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.nTx, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.file, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.dataPos, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.undoPos, i = readRawData(raw[pos:])</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func readRawData(raw []byte) (uint64, uint64) &#123;</span><br><span class=\"line\">   var n uint64</span><br><span class=\"line\">   var pos uint64</span><br><span class=\"line\">   for &#123;</span><br><span class=\"line\">      data := raw[pos]</span><br><span class=\"line\">      pos += 1</span><br><span class=\"line\">      n = (n &lt;&lt; 7) | (uint64(data) &amp; 0x7f)</span><br><span class=\"line\">      if data&amp;0x80 == 0 &#123;</span><br><span class=\"line\">         return n, pos</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      n += 1</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func hashToHex(hash []byte) (s string) &#123;</span><br><span class=\"line\">   for i := 0; i &lt; 32; i++ &#123;</span><br><span class=\"line\">      s += fmt.Sprintf(&quot;%02x&quot;, hash[31-i])</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func hexToHash(s string) (res [32]byte) &#123;</span><br><span class=\"line\">   d, e := hex.DecodeString(s)</span><br><span class=\"line\">   if e != nil &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   if len(d) != 32 &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   for i := 0; i &lt; 32; i++ &#123;</span><br><span class=\"line\">      res[31-i] = d[i]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type ReverseWriter struct &#123;</span><br><span class=\"line\">   Dir          string</span><br><span class=\"line\">   CacheMaxSize int</span><br><span class=\"line\">   len          int</span><br><span class=\"line\">   cache        []byte</span><br><span class=\"line\">   seek         int</span><br><span class=\"line\">   index        int</span><br><span class=\"line\">   Prefix       string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func NewReverseWriter(dir string, cacheSize int, prefix string) *ReverseWriter &#123;</span><br><span class=\"line\">   rw := &amp;ReverseWriter&#123;Dir: dir, CacheMaxSize: cacheSize, Prefix: prefix&#125;</span><br><span class=\"line\">   rw.init()</span><br><span class=\"line\">   return rw</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) init() &#123;</span><br><span class=\"line\">   rw.len = 0</span><br><span class=\"line\">   rw.cache = make([]byte, rw.CacheMaxSize)</span><br><span class=\"line\">   rw.seek = rw.CacheMaxSize</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) Insert(content []byte) error &#123;</span><br><span class=\"line\">   if rw.len+len(content) &gt; rw.CacheMaxSize &#123;</span><br><span class=\"line\">      err := rw.writeToFile()</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         return err</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      rw.index++</span><br><span class=\"line\">      rw.init()</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   copy(rw.cache[rw.seek-len(content):rw.seek], content)</span><br><span class=\"line\">   rw.seek = rw.seek - len(content)</span><br><span class=\"line\">   rw.len += len(content)</span><br><span class=\"line\">   return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) writeToFile() error &#123;</span><br><span class=\"line\">   if rw.len == 0 &#123;</span><br><span class=\"line\">      return nil</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   writer, err := os.OpenFile(fmt.Sprintf(&quot;%s/%sblk%05d.dat&quot;, rw.Dir, rw.Prefix, rw.index), os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0666)</span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      return err</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   _, err = writer.Write(rw.cache[rw.seek:])</span><br><span class=\"line\">   return err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) Flush() error &#123;</span><br><span class=\"line\">   err := rw.writeToFile()</span><br><span class=\"line\">   rw.index++</span><br><span class=\"line\">   rw.init()</span><br><span class=\"line\">   return err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#!/usr/bin/env bash</span><br><span class=\"line\"></span><br><span class=\"line\"># shell is funny</span><br><span class=\"line\"></span><br><span class=\"line\">read -p &quot;Are you sure:(y/n) &quot; an</span><br><span class=\"line\">if [[ $&#123;an&#125; != &quot;y&quot; ]]; then exit; fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd /Users/woko/bitcoin</span><br><span class=\"line\"></span><br><span class=\"line\">function rename_2() &#123;</span><br><span class=\"line\">    index=0</span><br><span class=\"line\">    for name in $(ls | grep .dat) ; do</span><br><span class=\"line\">        if [[ -f $&#123;name&#125; ]]; then</span><br><span class=\"line\">            rename=$(echo $&#123;index&#125;|awk &apos;&#123;printf(&quot;blk%05d.dat&quot;,$0)&#125;&apos;)</span><br><span class=\"line\">            echo $&#123;name&#125; &quot; ==&gt; &quot; $&#123;rename&#125;</span><br><span class=\"line\">            mv $&#123;name&#125; $&#123;rename&#125;</span><br><span class=\"line\">            ((index=index+1))</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function rename_1() &#123;</span><br><span class=\"line\">    count=0</span><br><span class=\"line\">    for (( i = 0; i &lt; 10; ++i )); do</span><br><span class=\"line\">        index=$(ls $&#123;count&#125;*.dat | wc -l)</span><br><span class=\"line\">        for name in $(ls $&#123;count&#125;*.dat) ; do</span><br><span class=\"line\">            if [[ -f $&#123;name&#125; ]]; then</span><br><span class=\"line\">                ((index=index-1))</span><br><span class=\"line\">                rename=$(echo &quot;$&#123;count&#125; $&#123;index&#125;&quot;|awk &apos;&#123;printf(&quot;%02dblk%05d.dat&quot;,$1,$2)&#125;&apos;)</span><br><span class=\"line\">                echo $&#123;name&#125; &quot; ==&gt; &quot; $&#123;rename&#125;</span><br><span class=\"line\">                mv $&#123;name&#125; $&#123;rename&#125;</span><br><span class=\"line\">            fi</span><br><span class=\"line\">        done</span><br><span class=\"line\">        ((count=count+1))</span><br><span class=\"line\">        echo &quot;--------------&quot;</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">rename_1</span><br><span class=\"line\">echo &quot;==============&quot;</span><br><span class=\"line\">rename_2</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"btc-dat\"><a href=\"#btc-dat\" class=\"headerlink\" title=\"btc dat\"></a>btc dat</h2><p>Bitcoin coredatindexindexldb </p>\n<p>datldbdat/ </p>\n<p> <a href=\"https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage\" target=\"_blank\" rel=\"noopener\">https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage</a> </p>\n<p>ldb </p>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;b&apos; + 32-byte block hash -&gt; block index record. Each record stores: </span><br><span class=\"line\"></span><br><span class=\"line\">     * The block header </span><br><span class=\"line\"></span><br><span class=\"line\">     * The height. </span><br><span class=\"line\"></span><br><span class=\"line\">     * The number of transactions. </span><br><span class=\"line\"></span><br><span class=\"line\">     * To what extent this block is validated. </span><br><span class=\"line\"></span><br><span class=\"line\">     * In which file, and where in that file, the block data is stored. </span><br><span class=\"line\"></span><br><span class=\"line\">     * In which file, and where in that file, the undo data is stored.</span><br></pre></td></tr></table></figure>\n\n<p>dat </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*</span><br><span class=\"line\">@Time : 2019/4/4 6:57</span><br><span class=\"line\">@Author : xiaoxuez</span><br><span class=\"line\">*/</span><br><span class=\"line\"></span><br><span class=\"line\">package main</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">   &quot;encoding/binary&quot;</span><br><span class=\"line\">   &quot;encoding/hex&quot;</span><br><span class=\"line\">   &quot;errors&quot;</span><br><span class=\"line\">   &quot;flag&quot;</span><br><span class=\"line\">   &quot;fmt&quot;</span><br><span class=\"line\">   &quot;io&quot;</span><br><span class=\"line\">   &quot;os&quot;</span><br><span class=\"line\">   &quot;path&quot;</span><br><span class=\"line\">   &quot;sync&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">   &quot;git.wokoworks.com/blockchain/btc-explorer/db&quot;</span><br><span class=\"line\">   &quot;git.wokoworks.com/blockchain/btc-explorer/log&quot;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">type readBlockChain struct &#123;</span><br><span class=\"line\">   height    uint64</span><br><span class=\"line\">   blockHash [32]byte</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">var indexLDB *db.LDBDatabase</span><br><span class=\"line\">var blSourceDir string</span><br><span class=\"line\">var blDirtyDir string</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">   log.InitHandler(log.Root(), log.LvlTrace, &quot;logs/reorder.log&quot;)</span><br><span class=\"line\">   var err error</span><br><span class=\"line\">   flag.StringVar(&amp;blSourceDir, &quot;old&quot;, &quot;/Users/xiaoxuez/btc_test_db/mainnet/&quot;, &quot;xx&quot;)</span><br><span class=\"line\">   flag.StringVar(&amp;blDirtyDir, &quot;new&quot;, &quot;/Users/xiaoxuez/btc_test_db/reorder&quot;, &quot;xx&quot;)</span><br><span class=\"line\">   flag.Parse()</span><br><span class=\"line\">   //bmdb, err = db.NewLDBDatabase(&quot;/Users/xiaoxuez/btc_test_db/mainnet/index&quot;, 0, 0)</span><br><span class=\"line\">   indexLDB, err = db.NewLDBDatabase(path.Join(blSourceDir, &quot;index&quot;), 0, 0)</span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      panic(err)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   //len must &lt; 24</span><br><span class=\"line\">   var data = []readBlockChain&#123;</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         height:    0,</span><br><span class=\"line\">         blockHash: hexToHash(&quot;00000000000003a20def7a05a77361b9657ff954b2f2080e135ea6f5970da215&quot;), // 20-1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">         height:    20 * 10000,</span><br><span class=\"line\">         blockHash: hexToHash(&quot;0000000000000009c2e82d884ec07b4aafb64ca3ef83baca2b6b0b5eb72c8f02&quot;), // 25-1</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    25 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;000000000000000067ecc744b5ae34eebbde14d21ca4db51652e4d67e155f07e&quot;), // 30-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    30 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;000000000000000002045664f89a1077d0c6c0aaa6dd89b485208cf92d6bbd30&quot;), // 35-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    35 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;0000000000000000030034b661aed920a9bdf6bbfa6d2e7a021f78481882fa39&quot;), // 40-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    40 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;0000000000000000024c4a35f0485bab79ce341cdd5cc6b15186d9b5b57bf3da&quot;), // 45-1</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    45 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;0000000000000000007962066dcd6675830883516bcf40047d42740a85eb2919&quot;), // 50</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">      //&#123;</span><br><span class=\"line\">      // height:    50 * 10000,</span><br><span class=\"line\">      // blockHash: hexToHash(&quot;00000000000000000013dad60a42a3401a8f37ca02f1c00ac5923e674566a3ae&quot;), // 55</span><br><span class=\"line\">      //&#125;,</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   if len(data) &gt; 24 &#123;</span><br><span class=\"line\">      log.Error(&quot;parallel number must &lt; 24&quot;, &quot;actual &quot;, len(data))</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   var wg sync.WaitGroup</span><br><span class=\"line\">   for index, v := range data &#123;</span><br><span class=\"line\">      wg.Add(1)</span><br><span class=\"line\">      go func(index int, v readBlockChain) &#123;</span><br><span class=\"line\">         rwBlocks(v.blockHash[:], v.height, fmt.Sprint(index), func() &#123; wg.Done() &#125;)</span><br><span class=\"line\">      &#125;(index, v)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   wg.Wait()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func rwBlocks(startBlock []byte, endHeight uint64, prefix string, callback func()) &#123;</span><br><span class=\"line\">   defer callback()</span><br><span class=\"line\">   fileCache := make(map[uint64]*os.File, 0)</span><br><span class=\"line\">   blockHash := startBlock</span><br><span class=\"line\">   reverWriter := NewReverseWriter(blDirtyDir, 138*1024*1024, prefix)</span><br><span class=\"line\">   defer reverWriter.Flush()</span><br><span class=\"line\">   count := 0</span><br><span class=\"line\">   for &#123;</span><br><span class=\"line\">      content, height, err := rwBlock(fileCache, blockHash)</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         log.Error(&quot;rw block&quot;, &quot;err&quot;, err.Error())</span><br><span class=\"line\">         return</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      blockHash = content[12:44]</span><br><span class=\"line\">      err = reverWriter.Insert(content)</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         fmt.Println(&quot;writer err&quot;, err)</span><br><span class=\"line\">         return</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if height == endHeight &#123;</span><br><span class=\"line\">         log.Info(&quot;finish to save block height&quot;, &quot;height&quot;, height)</span><br><span class=\"line\">         return</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      if height%3000 == 0 &#123;</span><br><span class=\"line\">         log.Trace(&quot;====&gt;&quot;, &quot;height&quot;, height, &quot;parent block hash&quot;, hashToHex(blockHash))</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      count++</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   log.Info(&quot;write file end&quot;, &quot;count&quot;, count)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func rwBlock(fileCache map[uint64]*os.File, block []byte) ([]byte, uint64, error) &#123;</span><br><span class=\"line\">   value, err := indexLDB.Get(append([]byte(&quot;b&quot;), block...))</span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      return []byte&#123;&#125;, 0, errors.New(fmt.Sprintf(&quot;%s%s&quot;, err.Error(), hashToHex(block)))</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   bm := parseBlockMeta(value)</span><br><span class=\"line\">   file, ok := fileCache[bm.file]</span><br><span class=\"line\">   if !ok &#123;</span><br><span class=\"line\">      file, err = os.Open(idx2fname(blSourceDir, uint32(bm.file)))</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         return []byte&#123;&#125;, 0, err</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      fileCache[bm.file] = file</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   file.Seek(int64(bm.dataPos-8), io.SeekStart)</span><br><span class=\"line\">   res, err := readBlockFromFile(file)</span><br><span class=\"line\"></span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      return []byte&#123;&#125;, 0, err</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   binary.LittleEndian.PutUint32(res[:4], uint32(bm.height))</span><br><span class=\"line\">   return res, bm.height, err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func readBlockFromFile(f *os.File) (res []byte, e error) &#123;</span><br><span class=\"line\">   var buf [4]byte</span><br><span class=\"line\">   _, e = f.Read(buf[:])</span><br><span class=\"line\">   _, e = f.Read(buf[:])</span><br><span class=\"line\">   if e != nil &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   le := uint32(lsb2uint(buf[:]))</span><br><span class=\"line\">   if le &lt; 81 &#123;</span><br><span class=\"line\">      e = errors.New(fmt.Sprintf(&quot;Incorrect block size %d&quot;, le))</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   res = make([]byte, le+8)</span><br><span class=\"line\">   copy(res[4:8], buf[:])</span><br><span class=\"line\">   _, e = f.Read(res[8:])</span><br><span class=\"line\">   if e != nil &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func idx2fname(dir string, fidx uint32) (s string) &#123;</span><br><span class=\"line\">   if fidx == 0xffffffff &#123;</span><br><span class=\"line\">      return &quot;blk99999.dat&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return fmt.Sprintf(&quot;%s/blk%05d.dat&quot;, dir, fidx)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func lsb2uint(lt []byte) (res uint64) &#123;</span><br><span class=\"line\">   for i := 0; i &lt; len(lt); i++ &#123;</span><br><span class=\"line\">      res |= uint64(lt[i]) &lt;&lt; uint(i*8)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type blockMeta struct &#123;</span><br><span class=\"line\">   version uint64</span><br><span class=\"line\">   height  uint64</span><br><span class=\"line\">   status  uint64</span><br><span class=\"line\">   nTx     uint64</span><br><span class=\"line\">   file    uint64</span><br><span class=\"line\">   dataPos uint64</span><br><span class=\"line\">   undoPos uint64</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func parseBlockMeta(raw []byte) (bm blockMeta) &#123;</span><br><span class=\"line\">   var pos uint64</span><br><span class=\"line\">   var i uint64</span><br><span class=\"line\">   bm.version, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.height, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.status, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.nTx, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.file, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.dataPos, i = readRawData(raw[pos:])</span><br><span class=\"line\">   pos += i</span><br><span class=\"line\">   bm.undoPos, i = readRawData(raw[pos:])</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func readRawData(raw []byte) (uint64, uint64) &#123;</span><br><span class=\"line\">   var n uint64</span><br><span class=\"line\">   var pos uint64</span><br><span class=\"line\">   for &#123;</span><br><span class=\"line\">      data := raw[pos]</span><br><span class=\"line\">      pos += 1</span><br><span class=\"line\">      n = (n &lt;&lt; 7) | (uint64(data) &amp; 0x7f)</span><br><span class=\"line\">      if data&amp;0x80 == 0 &#123;</span><br><span class=\"line\">         return n, pos</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      n += 1</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func hashToHex(hash []byte) (s string) &#123;</span><br><span class=\"line\">   for i := 0; i &lt; 32; i++ &#123;</span><br><span class=\"line\">      s += fmt.Sprintf(&quot;%02x&quot;, hash[31-i])</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func hexToHash(s string) (res [32]byte) &#123;</span><br><span class=\"line\">   d, e := hex.DecodeString(s)</span><br><span class=\"line\">   if e != nil &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   if len(d) != 32 &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   for i := 0; i &lt; 32; i++ &#123;</span><br><span class=\"line\">      res[31-i] = d[i]</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">type ReverseWriter struct &#123;</span><br><span class=\"line\">   Dir          string</span><br><span class=\"line\">   CacheMaxSize int</span><br><span class=\"line\">   len          int</span><br><span class=\"line\">   cache        []byte</span><br><span class=\"line\">   seek         int</span><br><span class=\"line\">   index        int</span><br><span class=\"line\">   Prefix       string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func NewReverseWriter(dir string, cacheSize int, prefix string) *ReverseWriter &#123;</span><br><span class=\"line\">   rw := &amp;ReverseWriter&#123;Dir: dir, CacheMaxSize: cacheSize, Prefix: prefix&#125;</span><br><span class=\"line\">   rw.init()</span><br><span class=\"line\">   return rw</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) init() &#123;</span><br><span class=\"line\">   rw.len = 0</span><br><span class=\"line\">   rw.cache = make([]byte, rw.CacheMaxSize)</span><br><span class=\"line\">   rw.seek = rw.CacheMaxSize</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) Insert(content []byte) error &#123;</span><br><span class=\"line\">   if rw.len+len(content) &gt; rw.CacheMaxSize &#123;</span><br><span class=\"line\">      err := rw.writeToFile()</span><br><span class=\"line\">      if err != nil &#123;</span><br><span class=\"line\">         return err</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      rw.index++</span><br><span class=\"line\">      rw.init()</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   copy(rw.cache[rw.seek-len(content):rw.seek], content)</span><br><span class=\"line\">   rw.seek = rw.seek - len(content)</span><br><span class=\"line\">   rw.len += len(content)</span><br><span class=\"line\">   return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) writeToFile() error &#123;</span><br><span class=\"line\">   if rw.len == 0 &#123;</span><br><span class=\"line\">      return nil</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   writer, err := os.OpenFile(fmt.Sprintf(&quot;%s/%sblk%05d.dat&quot;, rw.Dir, rw.Prefix, rw.index), os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0666)</span><br><span class=\"line\">   if err != nil &#123;</span><br><span class=\"line\">      return err</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   _, err = writer.Write(rw.cache[rw.seek:])</span><br><span class=\"line\">   return err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (rw *ReverseWriter) Flush() error &#123;</span><br><span class=\"line\">   err := rw.writeToFile()</span><br><span class=\"line\">   rw.index++</span><br><span class=\"line\">   rw.init()</span><br><span class=\"line\">   return err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#!/usr/bin/env bash</span><br><span class=\"line\"></span><br><span class=\"line\"># shell is funny</span><br><span class=\"line\"></span><br><span class=\"line\">read -p &quot;Are you sure:(y/n) &quot; an</span><br><span class=\"line\">if [[ $&#123;an&#125; != &quot;y&quot; ]]; then exit; fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd /Users/woko/bitcoin</span><br><span class=\"line\"></span><br><span class=\"line\">function rename_2() &#123;</span><br><span class=\"line\">    index=0</span><br><span class=\"line\">    for name in $(ls | grep .dat) ; do</span><br><span class=\"line\">        if [[ -f $&#123;name&#125; ]]; then</span><br><span class=\"line\">            rename=$(echo $&#123;index&#125;|awk &apos;&#123;printf(&quot;blk%05d.dat&quot;,$0)&#125;&apos;)</span><br><span class=\"line\">            echo $&#123;name&#125; &quot; ==&gt; &quot; $&#123;rename&#125;</span><br><span class=\"line\">            mv $&#123;name&#125; $&#123;rename&#125;</span><br><span class=\"line\">            ((index=index+1))</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function rename_1() &#123;</span><br><span class=\"line\">    count=0</span><br><span class=\"line\">    for (( i = 0; i &lt; 10; ++i )); do</span><br><span class=\"line\">        index=$(ls $&#123;count&#125;*.dat | wc -l)</span><br><span class=\"line\">        for name in $(ls $&#123;count&#125;*.dat) ; do</span><br><span class=\"line\">            if [[ -f $&#123;name&#125; ]]; then</span><br><span class=\"line\">                ((index=index-1))</span><br><span class=\"line\">                rename=$(echo &quot;$&#123;count&#125; $&#123;index&#125;&quot;|awk &apos;&#123;printf(&quot;%02dblk%05d.dat&quot;,$1,$2)&#125;&apos;)</span><br><span class=\"line\">                echo $&#123;name&#125; &quot; ==&gt; &quot; $&#123;rename&#125;</span><br><span class=\"line\">                mv $&#123;name&#125; $&#123;rename&#125;</span><br><span class=\"line\">            fi</span><br><span class=\"line\">        done</span><br><span class=\"line\">        ((count=count+1))</span><br><span class=\"line\">        echo &quot;--------------&quot;</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">rename_1</span><br><span class=\"line\">echo &quot;==============&quot;</span><br><span class=\"line\">rename_2</span><br></pre></td></tr></table></figure>\n\n"},{"title":"btc","date":"2019-04-14T06:37:56.000Z","_content":"\n### \n\n\n\n[](https://github.com/liuchengxu/blockchain-tutorial)[](http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html)\n\n\n\n(ledger)\n\n\n\n\n\n\n\n##### \n\n\n\n\n\n1. \n2. \n3. \n\n\n\n101\n\n\n\n##### \n\n\n\n1. \n2. coinbase\n\n\n\n- \n- \n- \n- \n\n\n\n1. s()\n2. 2\n\n\n\n\n\n\n\n##### \n\n\n\n5121601602635\n\n\n\n\n\n\n\n- hash()\n- \n- \n- \n\n\n\n1. \n2. \n3. \n\n\n\n 1MB50020002000 Hash61\n\n\n\n\n\n\n\n```\ntype TXInput struct {\n    Txid      []byte  //txidID\n    Vout      int  //\n    Signature []byte //\n    PubKey    []byte //\n}\n```\n\n\n\n```\ntype TXOutput struct {\n    Value      int  \n    PubKeyHash []byte //\n}\n```\n\n\n\n..\n\n1. coinbasecoinbasecoinbase **RIPEMD16(SHA256(PubKey))** \n2. ()\n3. \n4. \n5. \n6. \n\n\n\n~\n\n- \n\n- Base58,   `PubKeyHash` \n\n- \n\n  1. \n  2. \n  3. \n\n   \n\n\n\n\n\n##### UTXO\n\nUTXO()\n\n\n\n##### Merkle\n\nMerkle11Merkle\n\nMerkle Merkle  Merkle \n\n\n\n##### P2PKH\n\n *Script* *Pay to Public Key Hash(P2PKH)*****\n\n\n\n##### \n\nBitcoin Core\"bucket\"\n\n1. blocks, \n2. chainstate, \n\nBitcoin Core block\n\n\n\n##### \n\nfull-fledged\n\n P2PPeer-to-Peer\n\n \n\n\n\n\n\n-   ASIC PoW  PoS \n-  \n- SPV SPV  Simplified Payment Verification SPV  SPV SPV \n","source":"_posts/btc.md","raw":"---\ntitle: btc\ncategories:\n  - btc\ndate: 2019-4-14 14:37:56\ntags:\n---\n\n### \n\n\n\n[](https://github.com/liuchengxu/blockchain-tutorial)[](http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html)\n\n\n\n(ledger)\n\n\n\n\n\n\n\n##### \n\n\n\n\n\n1. \n2. \n3. \n\n\n\n101\n\n\n\n##### \n\n\n\n1. \n2. coinbase\n\n\n\n- \n- \n- \n- \n\n\n\n1. s()\n2. 2\n\n\n\n\n\n\n\n##### \n\n\n\n5121601602635\n\n\n\n\n\n\n\n- hash()\n- \n- \n- \n\n\n\n1. \n2. \n3. \n\n\n\n 1MB50020002000 Hash61\n\n\n\n\n\n\n\n```\ntype TXInput struct {\n    Txid      []byte  //txidID\n    Vout      int  //\n    Signature []byte //\n    PubKey    []byte //\n}\n```\n\n\n\n```\ntype TXOutput struct {\n    Value      int  \n    PubKeyHash []byte //\n}\n```\n\n\n\n..\n\n1. coinbasecoinbasecoinbase **RIPEMD16(SHA256(PubKey))** \n2. ()\n3. \n4. \n5. \n6. \n\n\n\n~\n\n- \n\n- Base58,   `PubKeyHash` \n\n- \n\n  1. \n  2. \n  3. \n\n   \n\n\n\n\n\n##### UTXO\n\nUTXO()\n\n\n\n##### Merkle\n\nMerkle11Merkle\n\nMerkle Merkle  Merkle \n\n\n\n##### P2PKH\n\n *Script* *Pay to Public Key Hash(P2PKH)*****\n\n\n\n##### \n\nBitcoin Core\"bucket\"\n\n1. blocks, \n2. chainstate, \n\nBitcoin Core block\n\n\n\n##### \n\nfull-fledged\n\n P2PPeer-to-Peer\n\n \n\n\n\n\n\n-   ASIC PoW  PoS \n-  \n- SPV SPV  Simplified Payment Verification SPV  SPV SPV \n","slug":"btc","published":1,"updated":"2019-10-14T07:25:20.084Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69wu0021t6xv33u3pm35","content":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://github.com/liuchengxu/blockchain-tutorial\"></a><a href=\"http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>(ledger)</p>\n<p></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p></p>\n<p>101</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<ol>\n<li></li>\n<li>coinbase</li>\n</ol>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ol>\n<li>s()</li>\n<li>2</li>\n</ol>\n<p></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<p>5121601602635</p>\n<p></p>\n<p></p>\n<ul>\n<li>hash()</li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p> 1MB50020002000 Hash61</p>\n<p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type TXInput struct &#123;</span><br><span class=\"line\">    Txid      []byte  //txidID</span><br><span class=\"line\">    Vout      int  //</span><br><span class=\"line\">    Signature []byte //</span><br><span class=\"line\">    PubKey    []byte //</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type TXOutput struct &#123;</span><br><span class=\"line\">    Value      int  </span><br><span class=\"line\">    PubKeyHash []byte //</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>..</p>\n<ol>\n<li>coinbasecoinbasecoinbase <strong>RIPEMD16(SHA256(PubKey))</strong> </li>\n<li>()</li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p>~</p>\n<ul>\n<li><p></p>\n</li>\n<li><p>Base58,   <code>PubKeyHash</code> </p>\n</li>\n<li><p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p> </p>\n</li>\n</ul>\n<h5 id=\"UTXO\"><a href=\"#UTXO\" class=\"headerlink\" title=\"UTXO\"></a>UTXO</h5><p>UTXO()</p>\n<h5 id=\"Merkle\"><a href=\"#Merkle\" class=\"headerlink\" title=\"Merkle\"></a>Merkle</h5><p>Merkle11Merkle</p>\n<p>Merkle Merkle  Merkle </p>\n<h5 id=\"P2PKH\"><a href=\"#P2PKH\" class=\"headerlink\" title=\"P2PKH\"></a>P2PKH</h5><p> <em>Script</em> <em>Pay to Public Key Hash(P2PKH)</em><strong></strong></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>Bitcoin Corebucket</p>\n<ol>\n<li>blocks, </li>\n<li>chainstate, </li>\n</ol>\n<p>Bitcoin Core block</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>full-fledged</p>\n<p> P2PPeer-to-Peer</p>\n<p> </p>\n<p></p>\n<ul>\n<li>  ASIC PoW  PoS </li>\n<li> </li>\n<li>SPV SPV  Simplified Payment Verification SPV  SPV SPV </li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"https://github.com/liuchengxu/blockchain-tutorial\"></a><a href=\"http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>(ledger)</p>\n<p></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p></p>\n<p>101</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<ol>\n<li></li>\n<li>coinbase</li>\n</ol>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ol>\n<li>s()</li>\n<li>2</li>\n</ol>\n<p></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<p>5121601602635</p>\n<p></p>\n<p></p>\n<ul>\n<li>hash()</li>\n<li></li>\n<li></li>\n<li></li>\n</ul>\n<p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p> 1MB50020002000 Hash61</p>\n<p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type TXInput struct &#123;</span><br><span class=\"line\">    Txid      []byte  //txidID</span><br><span class=\"line\">    Vout      int  //</span><br><span class=\"line\">    Signature []byte //</span><br><span class=\"line\">    PubKey    []byte //</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type TXOutput struct &#123;</span><br><span class=\"line\">    Value      int  </span><br><span class=\"line\">    PubKeyHash []byte //</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>..</p>\n<ol>\n<li>coinbasecoinbasecoinbase <strong>RIPEMD16(SHA256(PubKey))</strong> </li>\n<li>()</li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p>~</p>\n<ul>\n<li><p></p>\n</li>\n<li><p>Base58,   <code>PubKeyHash</code> </p>\n</li>\n<li><p></p>\n<ol>\n<li></li>\n<li></li>\n<li></li>\n</ol>\n<p> </p>\n</li>\n</ul>\n<h5 id=\"UTXO\"><a href=\"#UTXO\" class=\"headerlink\" title=\"UTXO\"></a>UTXO</h5><p>UTXO()</p>\n<h5 id=\"Merkle\"><a href=\"#Merkle\" class=\"headerlink\" title=\"Merkle\"></a>Merkle</h5><p>Merkle11Merkle</p>\n<p>Merkle Merkle  Merkle </p>\n<h5 id=\"P2PKH\"><a href=\"#P2PKH\" class=\"headerlink\" title=\"P2PKH\"></a>P2PKH</h5><p> <em>Script</em> <em>Pay to Public Key Hash(P2PKH)</em><strong></strong></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>Bitcoin Corebucket</p>\n<ol>\n<li>blocks, </li>\n<li>chainstate, </li>\n</ol>\n<p>Bitcoin Core block</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>full-fledged</p>\n<p> P2PPeer-to-Peer</p>\n<p> </p>\n<p></p>\n<ul>\n<li>  ASIC PoW  PoS </li>\n<li> </li>\n<li>SPV SPV  Simplified Payment Verification SPV  SPV SPV </li>\n</ul>\n"},{"title":"eth_build","date":"2019-10-14T06:49:01.000Z","_content":"go-ethereumgethgethgo-ethereum..gethWhisperSwarmgethCLI\n\n\n\n\n\nmac\n\n[]( )go-ethereum\n\ngogo1.7.+,make geth..brew install gogo1.10.+make geth..1.9.+...\n\n\n\nmakemakemakefilemakefilemake all/make gethgocmd/cmd/bin\n\n\n\nmakecmd/bin\n\n\n\n33 datadir node1 Data directory for the databases and keystore3\n\n```\nxiaoxuez$ ls\nnode1\tnode2\tnode3\nxiaoxuez$ geth --datadir node1 account new\n```\n\n\n\n.jsonpuppethpuppethcmd/makemake etheruemethereummake all~  \n\n```\nbuild/env.sh go run build/ci.go install ./cmd/puppeth/\n```\n\npuppeth\n\n```\n$ puppeth\n+-----------------------------------------------------------+\n| Welcome to puppeth, your Ethereum private network manager |\n|                                                           |\n| This tool lets you create a new Ethereum network down to  |\n| the genesis block, bootnodes, miners and ethstats servers |\n| without the hassle that it would normally entail.         |\n|                                                           |\n| Puppeth uses SSH to dial in to remote servers, and builds |\n| its network components out of Docker containers using the |\n| docker-compose toolset.                                   |\n+-----------------------------------------------------------+\n\nPlease specify a network name to administer (no spaces or hyphens, please)\n> helloworldprivate\n\nSweet, you can set this via --network=helloworldprivate next time!\n\nINFO [04-10|13:45:58] Administering Ethereum network           name=helloworldprivate\nWARN [04-10|13:45:58] No previous configurations found         path=/Users/xiaoxuez/.puppeth/helloworldprivate\n\nWhat would you like to do? (default = stats)\n 1. Show network stats\n 2. Configure new genesis\n 3. Track new remote server\n 4. Deploy network components\n> 2\n\nWhich consensus engine to use? (default = clique) #pow,poa,(, )\n 1. Ethash - proof-of-work\n 2. Clique - proof-of-authority\n> 2\n\nHow many seconds should blocks take? (default = 15)  #5s\n> 5\n\nWhich accounts are allowed to seal? (mandatory at least one)  #\n> 0x1186c97871079e86e9adcf11f56b90caa3619ea4\n> 0x34c72adc7499cce01530dc27e67810a79fdbd8ea\n> 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74\n> 0x\n\nWhich accounts should be pre-funded? (advisable at least one)  #\n> 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74\n> 0x34c72adc7499cce01530dc27e67810a79fdbd8ea\n> 0x1186c97871079e86e9adcf11f56b90caa3619ea4\n> 0x\n\nSpecify your chain/network ID if you want an explicit one (default = random) #ID, ,ID\n>\nINFO [04-10|13:47:49] Configured new genesis block\n\nWhat would you like to do? (default = stats)\n 1. Show network stats\n 2. Manage existing genesis\n 3. Track new remote server\n 4. Deploy network components\n> 2\n\n 1. Modify existing fork rules\n 2. Export genesis configuration\n 3. Remove genesis configuration\n> 2\n\nWhich file to save the genesis into? (default = helloworldprivate.json)\n>\nINFO [04-10|13:48:00] Exported existing genesis block\n\nWhat would you like to do? (default = stats)\n 1. Show network stats\n 2. Manage existing genesis\n 3. Track new remote server\n 4. Deploy network components\n> ^C\n$ ls  #.json\nhelloworldprivate.json\tnode1\t\t\tnode2\t\t\tnode3\n\n```\n\n\n\n.json\n\n```\n#init:Bootstrap and initialize a new genesis block\n$ geth --datadir node1 init helloworldprivate.json\n$ geth --datadir node1 --port 30000 --nodiscover --unlock '0' --password ./node1/password console\n#geth, --port: Network listening port \n#               --nodiscover: Disables the peer discovery mechanism (manual peer addition)\n#               --unlock: Comma separated list of accounts to unlock, \n#               console: consolegethgeth attach\nipc:node0/geth.ipc\n#               --rpc: http-rpc\n                --rpcport: http-rpc8545\n                --ws:\n                --wsport:\n                --allow-insecure-unlock\n\n\n```\n\n3\n\n```\n$ geth --datadir node2 init helloworldprivate.json\n$ geth --datadir node2 --port 30001 --nodiscover --unlock '0' --password ./node2/password console\n\n$ geth --datadir node3 init helloworldprivate.json\n$ geth --datadir node3 --port 30002 --nodiscover --unlock '0' --password ./node3/password console\n```\n\nunlock '0',  3\n\nconsoleJavaScriptJavaScriptJavaScript\n\n- eth\n- netp2p\n- admin\n- miner&\n- personal\n- txpool\n- web3\n\n\n\n\n\n- personal.newAccount()\n\n- personal.unlockAccount()\n\n- eth.accounts\n\n- eth.getBalance() WeiWei ``1 ether = 10^18 Wei `web3.fromWei(eth.getBalance(e), \"ether\") `\n\n  `web3.toWei('1', 'ether')`\n\n\n\n- eth.blockNumberblockNumbereth\n\n- eth.getTransaction()\n\n- eth.getBlock()eth.getBlock(\"pending\", true).transactions eth.getBlock(4)\n\n- miner.start()\n\n- miner.stop()\n\n- web3.fromWei()Wei \n\n- web3.toWei() Weiamount = web3.toWei(5,'ether')\n\n- txpool.status\n\n- admin.addPeer()\n\n\n\npeer\n\n```\n> admin.peers #\n> net.peerCount #\n```\n\nadmin.peers[]\n\n\n\n```\n> admin.nodeInfo.enode #encode://<id>@ip\n\"enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0\"\n```\n\nnode1node2, node3consoleadmin.addPeernode1node2,node3\n\n```\n> admin.addPeer(\"enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0\")\n\n```\n\nadmin.peersnode12node2, node3,node2node31node1\n\ndatadirstatic-node.json, \n\n```\n[\n\"enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0\",\n\"enode://79671ba7d09a4e6d16a64128e2cb24f544ec8740084e1ceb1abcac7b1c2b8a37dae812653360caf30ceff782265b124c1e6ce1d547dc6854bafb85596795751c@[::]:30001?discport=0\",\n\"enode://3237c4eaf0dbf55b459eef14c4ecffe987b5179e482399b282bc5ab3d1559dd8461a9d39460810bf0d8c276fb13a9950eca5c38890dbf11d9dccdb1b61231a78@[::]:30002?discport=0\"\n]\n```\n\ngeth - -bootnodes enode:.\n\ngeth\n\n\n\nminer.start()\n\n```\n> miner.start()\nINFO [04-10|17:59:10] Transaction pool price threshold updated price=18000000000\nINFO [04-10|17:59:10] Starting mining operation\nnull\n> INFO [04-10|17:59:10] Commit new mining work                   number=1 txs=2 uncles=0 elapsed=1.058ms\nINFO [04-10|17:59:10] Successfully sealed new block            number=1 hash=3b7e1038d85e\nINFO [04-10|17:59:10]  mined potential block                  number=1 hash=3b7e1038d85e\nINFO [04-10|17:59:10] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=285.156s\nINFO [04-10|17:59:15] Successfully sealed new block            number=2 hash=1bb861fbcb78\n```\n\n..  \n\n```\nWARN [04-10|17:55:49] Block sealing failed                     err=\"authentication needed: password or unlock\"\n> personal.unlockAccount(eth.accounts[0])\n```\n\n\n\n```\n> miner.start()\n\nnull\n```\n\nnull, ~\n\n```\n> miner.setEtherbase(eth.accounts[0])\ntrue\n> miner.start()\n```\n\n\n\n,  toeth.accounts\n\n```\n> eth.sendTransaction({from: eth.accounts[0], to: \"b6deeb049de5fb90345b5b84dd1faf2d56c6929e\", value: web3.toWei(200, \"ether\")})\n```\n\n\n\nminerblock,  txsblock\n\n```\nINFO [04-10|17:59:15] Imported new chain segment               blocks=2 txs=1 mgas=0.042 elapsed=1.348ms  mgasps=31.157 number=2 hash=1bb861fbcb78 cache=2.47kB\n```\n\n\n\n\n\n```\n> miner.start(1);admin.sleepBlocks(1);miner.stop();\n```\n\n \n\n\n\n\n\n\n\n```\nbrew install solc\n```\n\n..\n\n\n\n\n\n```\ngeth attach http://0.0.0.0:1112\n\n\n\n\"/Applications/Ethereum Wallet.app/Contents/MacOS/Ethereum Wallet\" --rpc http://localhost:8545\n\n\n\n    --rpcapi=\"db,eth,net,web3,personal,web3\" --rpc --rpcaddr 0.0.0.0 -rpcport 1112 --mine\n\n\n\neth.sendTransaction({from:eth.accounts[0], data:\"0x0100f862a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000809471562b71999873db5b286df957af199ec94617f78568656c6c6f80808080\"})\n\n\n\n```\n\n\n\n\n\nandroid\n\n```\nmake android\n\n./build/env.sh xgo --go=latest --dest=build/bin -v --targets=android-23/arm64 ./cmd/geth\n\nglide mirror set golang.org/x/text  /home/users/qiangmzsx/var/golang/golang.org/x/text\n\n\n\n```\n\n\n\n\n\n```\neth.sendTransaction({from: eth.accounts[0], to: \"0x71562b71999873DB5b286dF957af199Ec94617F7\", value: 200000})\n```\n","source":"_posts/eth-build.md","raw":"---\ntitle: eth_build\ncategories:\n  - eth\ndate: 2019-10-14 14:49:01\ntags:\n---\ngo-ethereumgethgethgo-ethereum..gethWhisperSwarmgethCLI\n\n\n\n\n\nmac\n\n[]( )go-ethereum\n\ngogo1.7.+,make geth..brew install gogo1.10.+make geth..1.9.+...\n\n\n\nmakemakemakefilemakefilemake all/make gethgocmd/cmd/bin\n\n\n\nmakecmd/bin\n\n\n\n33 datadir node1 Data directory for the databases and keystore3\n\n```\nxiaoxuez$ ls\nnode1\tnode2\tnode3\nxiaoxuez$ geth --datadir node1 account new\n```\n\n\n\n.jsonpuppethpuppethcmd/makemake etheruemethereummake all~  \n\n```\nbuild/env.sh go run build/ci.go install ./cmd/puppeth/\n```\n\npuppeth\n\n```\n$ puppeth\n+-----------------------------------------------------------+\n| Welcome to puppeth, your Ethereum private network manager |\n|                                                           |\n| This tool lets you create a new Ethereum network down to  |\n| the genesis block, bootnodes, miners and ethstats servers |\n| without the hassle that it would normally entail.         |\n|                                                           |\n| Puppeth uses SSH to dial in to remote servers, and builds |\n| its network components out of Docker containers using the |\n| docker-compose toolset.                                   |\n+-----------------------------------------------------------+\n\nPlease specify a network name to administer (no spaces or hyphens, please)\n> helloworldprivate\n\nSweet, you can set this via --network=helloworldprivate next time!\n\nINFO [04-10|13:45:58] Administering Ethereum network           name=helloworldprivate\nWARN [04-10|13:45:58] No previous configurations found         path=/Users/xiaoxuez/.puppeth/helloworldprivate\n\nWhat would you like to do? (default = stats)\n 1. Show network stats\n 2. Configure new genesis\n 3. Track new remote server\n 4. Deploy network components\n> 2\n\nWhich consensus engine to use? (default = clique) #pow,poa,(, )\n 1. Ethash - proof-of-work\n 2. Clique - proof-of-authority\n> 2\n\nHow many seconds should blocks take? (default = 15)  #5s\n> 5\n\nWhich accounts are allowed to seal? (mandatory at least one)  #\n> 0x1186c97871079e86e9adcf11f56b90caa3619ea4\n> 0x34c72adc7499cce01530dc27e67810a79fdbd8ea\n> 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74\n> 0x\n\nWhich accounts should be pre-funded? (advisable at least one)  #\n> 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74\n> 0x34c72adc7499cce01530dc27e67810a79fdbd8ea\n> 0x1186c97871079e86e9adcf11f56b90caa3619ea4\n> 0x\n\nSpecify your chain/network ID if you want an explicit one (default = random) #ID, ,ID\n>\nINFO [04-10|13:47:49] Configured new genesis block\n\nWhat would you like to do? (default = stats)\n 1. Show network stats\n 2. Manage existing genesis\n 3. Track new remote server\n 4. Deploy network components\n> 2\n\n 1. Modify existing fork rules\n 2. Export genesis configuration\n 3. Remove genesis configuration\n> 2\n\nWhich file to save the genesis into? (default = helloworldprivate.json)\n>\nINFO [04-10|13:48:00] Exported existing genesis block\n\nWhat would you like to do? (default = stats)\n 1. Show network stats\n 2. Manage existing genesis\n 3. Track new remote server\n 4. Deploy network components\n> ^C\n$ ls  #.json\nhelloworldprivate.json\tnode1\t\t\tnode2\t\t\tnode3\n\n```\n\n\n\n.json\n\n```\n#init:Bootstrap and initialize a new genesis block\n$ geth --datadir node1 init helloworldprivate.json\n$ geth --datadir node1 --port 30000 --nodiscover --unlock '0' --password ./node1/password console\n#geth, --port: Network listening port \n#               --nodiscover: Disables the peer discovery mechanism (manual peer addition)\n#               --unlock: Comma separated list of accounts to unlock, \n#               console: consolegethgeth attach\nipc:node0/geth.ipc\n#               --rpc: http-rpc\n                --rpcport: http-rpc8545\n                --ws:\n                --wsport:\n                --allow-insecure-unlock\n\n\n```\n\n3\n\n```\n$ geth --datadir node2 init helloworldprivate.json\n$ geth --datadir node2 --port 30001 --nodiscover --unlock '0' --password ./node2/password console\n\n$ geth --datadir node3 init helloworldprivate.json\n$ geth --datadir node3 --port 30002 --nodiscover --unlock '0' --password ./node3/password console\n```\n\nunlock '0',  3\n\nconsoleJavaScriptJavaScriptJavaScript\n\n- eth\n- netp2p\n- admin\n- miner&\n- personal\n- txpool\n- web3\n\n\n\n\n\n- personal.newAccount()\n\n- personal.unlockAccount()\n\n- eth.accounts\n\n- eth.getBalance() WeiWei ``1 ether = 10^18 Wei `web3.fromWei(eth.getBalance(e), \"ether\") `\n\n  `web3.toWei('1', 'ether')`\n\n\n\n- eth.blockNumberblockNumbereth\n\n- eth.getTransaction()\n\n- eth.getBlock()eth.getBlock(\"pending\", true).transactions eth.getBlock(4)\n\n- miner.start()\n\n- miner.stop()\n\n- web3.fromWei()Wei \n\n- web3.toWei() Weiamount = web3.toWei(5,'ether')\n\n- txpool.status\n\n- admin.addPeer()\n\n\n\npeer\n\n```\n> admin.peers #\n> net.peerCount #\n```\n\nadmin.peers[]\n\n\n\n```\n> admin.nodeInfo.enode #encode://<id>@ip\n\"enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0\"\n```\n\nnode1node2, node3consoleadmin.addPeernode1node2,node3\n\n```\n> admin.addPeer(\"enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0\")\n\n```\n\nadmin.peersnode12node2, node3,node2node31node1\n\ndatadirstatic-node.json, \n\n```\n[\n\"enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0\",\n\"enode://79671ba7d09a4e6d16a64128e2cb24f544ec8740084e1ceb1abcac7b1c2b8a37dae812653360caf30ceff782265b124c1e6ce1d547dc6854bafb85596795751c@[::]:30001?discport=0\",\n\"enode://3237c4eaf0dbf55b459eef14c4ecffe987b5179e482399b282bc5ab3d1559dd8461a9d39460810bf0d8c276fb13a9950eca5c38890dbf11d9dccdb1b61231a78@[::]:30002?discport=0\"\n]\n```\n\ngeth - -bootnodes enode:.\n\ngeth\n\n\n\nminer.start()\n\n```\n> miner.start()\nINFO [04-10|17:59:10] Transaction pool price threshold updated price=18000000000\nINFO [04-10|17:59:10] Starting mining operation\nnull\n> INFO [04-10|17:59:10] Commit new mining work                   number=1 txs=2 uncles=0 elapsed=1.058ms\nINFO [04-10|17:59:10] Successfully sealed new block            number=1 hash=3b7e1038d85e\nINFO [04-10|17:59:10]  mined potential block                  number=1 hash=3b7e1038d85e\nINFO [04-10|17:59:10] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=285.156s\nINFO [04-10|17:59:15] Successfully sealed new block            number=2 hash=1bb861fbcb78\n```\n\n..  \n\n```\nWARN [04-10|17:55:49] Block sealing failed                     err=\"authentication needed: password or unlock\"\n> personal.unlockAccount(eth.accounts[0])\n```\n\n\n\n```\n> miner.start()\n\nnull\n```\n\nnull, ~\n\n```\n> miner.setEtherbase(eth.accounts[0])\ntrue\n> miner.start()\n```\n\n\n\n,  toeth.accounts\n\n```\n> eth.sendTransaction({from: eth.accounts[0], to: \"b6deeb049de5fb90345b5b84dd1faf2d56c6929e\", value: web3.toWei(200, \"ether\")})\n```\n\n\n\nminerblock,  txsblock\n\n```\nINFO [04-10|17:59:15] Imported new chain segment               blocks=2 txs=1 mgas=0.042 elapsed=1.348ms  mgasps=31.157 number=2 hash=1bb861fbcb78 cache=2.47kB\n```\n\n\n\n\n\n```\n> miner.start(1);admin.sleepBlocks(1);miner.stop();\n```\n\n \n\n\n\n\n\n\n\n```\nbrew install solc\n```\n\n..\n\n\n\n\n\n```\ngeth attach http://0.0.0.0:1112\n\n\n\n\"/Applications/Ethereum Wallet.app/Contents/MacOS/Ethereum Wallet\" --rpc http://localhost:8545\n\n\n\n    --rpcapi=\"db,eth,net,web3,personal,web3\" --rpc --rpcaddr 0.0.0.0 -rpcport 1112 --mine\n\n\n\neth.sendTransaction({from:eth.accounts[0], data:\"0x0100f862a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000809471562b71999873db5b286df957af199ec94617f78568656c6c6f80808080\"})\n\n\n\n```\n\n\n\n\n\nandroid\n\n```\nmake android\n\n./build/env.sh xgo --go=latest --dest=build/bin -v --targets=android-23/arm64 ./cmd/geth\n\nglide mirror set golang.org/x/text  /home/users/qiangmzsx/var/golang/golang.org/x/text\n\n\n\n```\n\n\n\n\n\n```\neth.sendTransaction({from: eth.accounts[0], to: \"0x71562b71999873DB5b286dF957af199Ec94617F7\", value: 200000})\n```\n","slug":"eth-build","published":1,"updated":"2019-10-14T06:49:59.618Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ww0022t6xvema0rqo6","content":"<p>go-ethereumgethgethgo-ethereum..gethWhisperSwarmgethCLI</p>\n<p></p>\n<p>mac</p>\n<p><a href></a>go-ethereum</p>\n<p>gogo1.7.+,make geth..brew install gogo1.10.+make geth..1.9.+</p>\n<p>makemakemakefilemakefilemake all/make gethgocmd/cmd/bin</p>\n<p>makecmd/bin</p>\n<p>33 datadir node1 Data directory for the databases and keystore3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xiaoxuez$ ls</span><br><span class=\"line\">node1\tnode2\tnode3</span><br><span class=\"line\">xiaoxuez$ geth --datadir node1 account new</span><br></pre></td></tr></table></figure>\n\n<p>.jsonpuppethpuppethcmd/makemake etheruemethereummake all~  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">build/env.sh go run build/ci.go install ./cmd/puppeth/</span><br></pre></td></tr></table></figure>\n\n<p>puppeth</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ puppeth</span><br><span class=\"line\">+-----------------------------------------------------------+</span><br><span class=\"line\">| Welcome to puppeth, your Ethereum private network manager |</span><br><span class=\"line\">|                                                           |</span><br><span class=\"line\">| This tool lets you create a new Ethereum network down to  |</span><br><span class=\"line\">| the genesis block, bootnodes, miners and ethstats servers |</span><br><span class=\"line\">| without the hassle that it would normally entail.         |</span><br><span class=\"line\">|                                                           |</span><br><span class=\"line\">| Puppeth uses SSH to dial in to remote servers, and builds |</span><br><span class=\"line\">| its network components out of Docker containers using the |</span><br><span class=\"line\">| docker-compose toolset.                                   |</span><br><span class=\"line\">+-----------------------------------------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">Please specify a network name to administer (no spaces or hyphens, please)</span><br><span class=\"line\">&gt; helloworldprivate</span><br><span class=\"line\"></span><br><span class=\"line\">Sweet, you can set this via --network=helloworldprivate next time!</span><br><span class=\"line\"></span><br><span class=\"line\">INFO [04-10|13:45:58] Administering Ethereum network           name=helloworldprivate</span><br><span class=\"line\">WARN [04-10|13:45:58] No previous configurations found         path=/Users/xiaoxuez/.puppeth/helloworldprivate</span><br><span class=\"line\"></span><br><span class=\"line\">What would you like to do? (default = stats)</span><br><span class=\"line\"> 1. Show network stats</span><br><span class=\"line\"> 2. Configure new genesis</span><br><span class=\"line\"> 3. Track new remote server</span><br><span class=\"line\"> 4. Deploy network components</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\">Which consensus engine to use? (default = clique) #pow,poa,(, )</span><br><span class=\"line\"> 1. Ethash - proof-of-work</span><br><span class=\"line\"> 2. Clique - proof-of-authority</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\">How many seconds should blocks take? (default = 15)  #5s</span><br><span class=\"line\">&gt; 5</span><br><span class=\"line\"></span><br><span class=\"line\">Which accounts are allowed to seal? (mandatory at least one)  #</span><br><span class=\"line\">&gt; 0x1186c97871079e86e9adcf11f56b90caa3619ea4</span><br><span class=\"line\">&gt; 0x34c72adc7499cce01530dc27e67810a79fdbd8ea</span><br><span class=\"line\">&gt; 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74</span><br><span class=\"line\">&gt; 0x</span><br><span class=\"line\"></span><br><span class=\"line\">Which accounts should be pre-funded? (advisable at least one)  #</span><br><span class=\"line\">&gt; 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74</span><br><span class=\"line\">&gt; 0x34c72adc7499cce01530dc27e67810a79fdbd8ea</span><br><span class=\"line\">&gt; 0x1186c97871079e86e9adcf11f56b90caa3619ea4</span><br><span class=\"line\">&gt; 0x</span><br><span class=\"line\"></span><br><span class=\"line\">Specify your chain/network ID if you want an explicit one (default = random) #ID, ,ID</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">INFO [04-10|13:47:49] Configured new genesis block</span><br><span class=\"line\"></span><br><span class=\"line\">What would you like to do? (default = stats)</span><br><span class=\"line\"> 1. Show network stats</span><br><span class=\"line\"> 2. Manage existing genesis</span><br><span class=\"line\"> 3. Track new remote server</span><br><span class=\"line\"> 4. Deploy network components</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\"> 1. Modify existing fork rules</span><br><span class=\"line\"> 2. Export genesis configuration</span><br><span class=\"line\"> 3. Remove genesis configuration</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\">Which file to save the genesis into? (default = helloworldprivate.json)</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">INFO [04-10|13:48:00] Exported existing genesis block</span><br><span class=\"line\"></span><br><span class=\"line\">What would you like to do? (default = stats)</span><br><span class=\"line\"> 1. Show network stats</span><br><span class=\"line\"> 2. Manage existing genesis</span><br><span class=\"line\"> 3. Track new remote server</span><br><span class=\"line\"> 4. Deploy network components</span><br><span class=\"line\">&gt; ^C</span><br><span class=\"line\">$ ls  #.json</span><br><span class=\"line\">helloworldprivate.json\tnode1\t\t\tnode2\t\t\tnode3</span><br></pre></td></tr></table></figure>\n\n<p>.json</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#init:Bootstrap and initialize a new genesis block</span><br><span class=\"line\">$ geth --datadir node1 init helloworldprivate.json</span><br><span class=\"line\">$ geth --datadir node1 --port 30000 --nodiscover --unlock &apos;0&apos; --password ./node1/password console</span><br><span class=\"line\">#geth, --port: Network listening port </span><br><span class=\"line\">#               --nodiscover: Disables the peer discovery mechanism (manual peer addition)</span><br><span class=\"line\">#               --unlock: Comma separated list of accounts to unlock, </span><br><span class=\"line\">#               console: consolegethgeth attach</span><br><span class=\"line\">ipc:node0/geth.ipc</span><br><span class=\"line\">#               --rpc: http-rpc</span><br><span class=\"line\">                --rpcport: http-rpc8545</span><br><span class=\"line\">                --ws:</span><br><span class=\"line\">                --wsport:</span><br><span class=\"line\">                --allow-insecure-unlock</span><br></pre></td></tr></table></figure>\n\n<p>3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ geth --datadir node2 init helloworldprivate.json</span><br><span class=\"line\">$ geth --datadir node2 --port 30001 --nodiscover --unlock &apos;0&apos; --password ./node2/password console</span><br><span class=\"line\"></span><br><span class=\"line\">$ geth --datadir node3 init helloworldprivate.json</span><br><span class=\"line\">$ geth --datadir node3 --port 30002 --nodiscover --unlock &apos;0&apos; --password ./node3/password console</span><br></pre></td></tr></table></figure>\n\n<p>unlock 0,  3</p>\n<p>consoleJavaScriptJavaScriptJavaScript</p>\n<ul>\n<li>eth</li>\n<li>netp2p</li>\n<li>admin</li>\n<li>miner&amp;</li>\n<li>personal</li>\n<li>txpool</li>\n<li>web3</li>\n</ul>\n<p></p>\n<ul>\n<li><p>personal.newAccount()</p>\n</li>\n<li><p>personal.unlockAccount()</p>\n</li>\n<li><p>eth.accounts</p>\n</li>\n<li><p>eth.getBalance() WeiWei <code></code>1 ether = 10^18 Wei <code>web3.fromWei(eth.getBalance(e), &quot;ether&quot;)</code></p>\n<p><code>web3.toWei(&#39;1&#39;, &#39;ether&#39;)</code></p>\n</li>\n</ul>\n<ul>\n<li><p>eth.blockNumberblockNumbereth</p>\n</li>\n<li><p>eth.getTransaction()</p>\n</li>\n<li><p>eth.getBlock()eth.getBlock(pending, true).transactions eth.getBlock(4)</p>\n</li>\n<li><p>miner.start()</p>\n</li>\n<li><p>miner.stop()</p>\n</li>\n<li><p>web3.fromWei()Wei </p>\n</li>\n<li><p>web3.toWei() Weiamount = web3.toWei(5,ether)</p>\n</li>\n<li><p>txpool.status</p>\n</li>\n<li><p>admin.addPeer()</p>\n</li>\n</ul>\n<p>peer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; admin.peers #</span><br><span class=\"line\">&gt; net.peerCount #</span><br></pre></td></tr></table></figure>\n\n<p>admin.peers[]</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; admin.nodeInfo.enode #encode://&lt;id&gt;@ip</span><br><span class=\"line\">&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;</span><br></pre></td></tr></table></figure>\n\n<p>node1node2, node3consoleadmin.addPeernode1node2,node3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; admin.addPeer(&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;)</span><br></pre></td></tr></table></figure>\n\n<p>admin.peersnode12node2, node3,node2node31node1</p>\n<p>datadirstatic-node.json, </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;,</span><br><span class=\"line\">&quot;enode://79671ba7d09a4e6d16a64128e2cb24f544ec8740084e1ceb1abcac7b1c2b8a37dae812653360caf30ceff782265b124c1e6ce1d547dc6854bafb85596795751c@[::]:30001?discport=0&quot;,</span><br><span class=\"line\">&quot;enode://3237c4eaf0dbf55b459eef14c4ecffe987b5179e482399b282bc5ab3d1559dd8461a9d39460810bf0d8c276fb13a9950eca5c38890dbf11d9dccdb1b61231a78@[::]:30002?discport=0&quot;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n\n<p>geth - -bootnodes enode:.</p>\n<p>geth</p>\n<p>miner.start()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.start()</span><br><span class=\"line\">INFO [04-10|17:59:10] Transaction pool price threshold updated price=18000000000</span><br><span class=\"line\">INFO [04-10|17:59:10] Starting mining operation</span><br><span class=\"line\">null</span><br><span class=\"line\">&gt; INFO [04-10|17:59:10] Commit new mining work                   number=1 txs=2 uncles=0 elapsed=1.058ms</span><br><span class=\"line\">INFO [04-10|17:59:10] Successfully sealed new block            number=1 hash=3b7e1038d85e</span><br><span class=\"line\">INFO [04-10|17:59:10]  mined potential block                  number=1 hash=3b7e1038d85e</span><br><span class=\"line\">INFO [04-10|17:59:10] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=285.156s</span><br><span class=\"line\">INFO [04-10|17:59:15] Successfully sealed new block            number=2 hash=1bb861fbcb78</span><br></pre></td></tr></table></figure>\n\n<p>..  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARN [04-10|17:55:49] Block sealing failed                     err=&quot;authentication needed: password or unlock&quot;</span><br><span class=\"line\">&gt; personal.unlockAccount(eth.accounts[0])</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.start()</span><br><span class=\"line\"></span><br><span class=\"line\">null</span><br></pre></td></tr></table></figure>\n\n<p>null, ~</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.setEtherbase(eth.accounts[0])</span><br><span class=\"line\">true</span><br><span class=\"line\">&gt; miner.start()</span><br></pre></td></tr></table></figure>\n\n<p>,  toeth.accounts</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; eth.sendTransaction(&#123;from: eth.accounts[0], to: &quot;b6deeb049de5fb90345b5b84dd1faf2d56c6929e&quot;, value: web3.toWei(200, &quot;ether&quot;)&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>minerblock,  txsblock</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INFO [04-10|17:59:15] Imported new chain segment               blocks=2 txs=1 mgas=0.042 elapsed=1.348ms  mgasps=31.157 number=2 hash=1bb861fbcb78 cache=2.47kB</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.start(1);admin.sleepBlocks(1);miner.stop();</span><br></pre></td></tr></table></figure>\n\n<p> </p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install solc</span><br></pre></td></tr></table></figure>\n\n<p>..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">geth attach http://0.0.0.0:1112</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&quot;/Applications/Ethereum Wallet.app/Contents/MacOS/Ethereum Wallet&quot; --rpc http://localhost:8545</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    --rpcapi=&quot;db,eth,net,web3,personal,web3&quot; --rpc --rpcaddr 0.0.0.0 -rpcport 1112 --mine</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">eth.sendTransaction(&#123;from:eth.accounts[0], data:&quot;0x0100f862a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000809471562b71999873db5b286df957af199ec94617f78568656c6c6f80808080&quot;&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>android</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make android</span><br><span class=\"line\"></span><br><span class=\"line\">./build/env.sh xgo --go=latest --dest=build/bin -v --targets=android-23/arm64 ./cmd/geth</span><br><span class=\"line\"></span><br><span class=\"line\">glide mirror set golang.org/x/text  /home/users/qiangmzsx/var/golang/golang.org/x/text</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eth.sendTransaction(&#123;from: eth.accounts[0], to: &quot;0x71562b71999873DB5b286dF957af199Ec94617F7&quot;, value: 200000&#125;)</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<p>go-ethereumgethgethgo-ethereum..gethWhisperSwarmgethCLI</p>\n<p></p>\n<p>mac</p>\n<p><a href></a>go-ethereum</p>\n<p>gogo1.7.+,make geth..brew install gogo1.10.+make geth..1.9.+</p>\n<p>makemakemakefilemakefilemake all/make gethgocmd/cmd/bin</p>\n<p>makecmd/bin</p>\n<p>33 datadir node1 Data directory for the databases and keystore3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xiaoxuez$ ls</span><br><span class=\"line\">node1\tnode2\tnode3</span><br><span class=\"line\">xiaoxuez$ geth --datadir node1 account new</span><br></pre></td></tr></table></figure>\n\n<p>.jsonpuppethpuppethcmd/makemake etheruemethereummake all~  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">build/env.sh go run build/ci.go install ./cmd/puppeth/</span><br></pre></td></tr></table></figure>\n\n<p>puppeth</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ puppeth</span><br><span class=\"line\">+-----------------------------------------------------------+</span><br><span class=\"line\">| Welcome to puppeth, your Ethereum private network manager |</span><br><span class=\"line\">|                                                           |</span><br><span class=\"line\">| This tool lets you create a new Ethereum network down to  |</span><br><span class=\"line\">| the genesis block, bootnodes, miners and ethstats servers |</span><br><span class=\"line\">| without the hassle that it would normally entail.         |</span><br><span class=\"line\">|                                                           |</span><br><span class=\"line\">| Puppeth uses SSH to dial in to remote servers, and builds |</span><br><span class=\"line\">| its network components out of Docker containers using the |</span><br><span class=\"line\">| docker-compose toolset.                                   |</span><br><span class=\"line\">+-----------------------------------------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">Please specify a network name to administer (no spaces or hyphens, please)</span><br><span class=\"line\">&gt; helloworldprivate</span><br><span class=\"line\"></span><br><span class=\"line\">Sweet, you can set this via --network=helloworldprivate next time!</span><br><span class=\"line\"></span><br><span class=\"line\">INFO [04-10|13:45:58] Administering Ethereum network           name=helloworldprivate</span><br><span class=\"line\">WARN [04-10|13:45:58] No previous configurations found         path=/Users/xiaoxuez/.puppeth/helloworldprivate</span><br><span class=\"line\"></span><br><span class=\"line\">What would you like to do? (default = stats)</span><br><span class=\"line\"> 1. Show network stats</span><br><span class=\"line\"> 2. Configure new genesis</span><br><span class=\"line\"> 3. Track new remote server</span><br><span class=\"line\"> 4. Deploy network components</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\">Which consensus engine to use? (default = clique) #pow,poa,(, )</span><br><span class=\"line\"> 1. Ethash - proof-of-work</span><br><span class=\"line\"> 2. Clique - proof-of-authority</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\">How many seconds should blocks take? (default = 15)  #5s</span><br><span class=\"line\">&gt; 5</span><br><span class=\"line\"></span><br><span class=\"line\">Which accounts are allowed to seal? (mandatory at least one)  #</span><br><span class=\"line\">&gt; 0x1186c97871079e86e9adcf11f56b90caa3619ea4</span><br><span class=\"line\">&gt; 0x34c72adc7499cce01530dc27e67810a79fdbd8ea</span><br><span class=\"line\">&gt; 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74</span><br><span class=\"line\">&gt; 0x</span><br><span class=\"line\"></span><br><span class=\"line\">Which accounts should be pre-funded? (advisable at least one)  #</span><br><span class=\"line\">&gt; 0xb37fe8ba7afbeb5e57139e55e737a34574e91a74</span><br><span class=\"line\">&gt; 0x34c72adc7499cce01530dc27e67810a79fdbd8ea</span><br><span class=\"line\">&gt; 0x1186c97871079e86e9adcf11f56b90caa3619ea4</span><br><span class=\"line\">&gt; 0x</span><br><span class=\"line\"></span><br><span class=\"line\">Specify your chain/network ID if you want an explicit one (default = random) #ID, ,ID</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">INFO [04-10|13:47:49] Configured new genesis block</span><br><span class=\"line\"></span><br><span class=\"line\">What would you like to do? (default = stats)</span><br><span class=\"line\"> 1. Show network stats</span><br><span class=\"line\"> 2. Manage existing genesis</span><br><span class=\"line\"> 3. Track new remote server</span><br><span class=\"line\"> 4. Deploy network components</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\"> 1. Modify existing fork rules</span><br><span class=\"line\"> 2. Export genesis configuration</span><br><span class=\"line\"> 3. Remove genesis configuration</span><br><span class=\"line\">&gt; 2</span><br><span class=\"line\"></span><br><span class=\"line\">Which file to save the genesis into? (default = helloworldprivate.json)</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">INFO [04-10|13:48:00] Exported existing genesis block</span><br><span class=\"line\"></span><br><span class=\"line\">What would you like to do? (default = stats)</span><br><span class=\"line\"> 1. Show network stats</span><br><span class=\"line\"> 2. Manage existing genesis</span><br><span class=\"line\"> 3. Track new remote server</span><br><span class=\"line\"> 4. Deploy network components</span><br><span class=\"line\">&gt; ^C</span><br><span class=\"line\">$ ls  #.json</span><br><span class=\"line\">helloworldprivate.json\tnode1\t\t\tnode2\t\t\tnode3</span><br></pre></td></tr></table></figure>\n\n<p>.json</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#init:Bootstrap and initialize a new genesis block</span><br><span class=\"line\">$ geth --datadir node1 init helloworldprivate.json</span><br><span class=\"line\">$ geth --datadir node1 --port 30000 --nodiscover --unlock &apos;0&apos; --password ./node1/password console</span><br><span class=\"line\">#geth, --port: Network listening port </span><br><span class=\"line\">#               --nodiscover: Disables the peer discovery mechanism (manual peer addition)</span><br><span class=\"line\">#               --unlock: Comma separated list of accounts to unlock, </span><br><span class=\"line\">#               console: consolegethgeth attach</span><br><span class=\"line\">ipc:node0/geth.ipc</span><br><span class=\"line\">#               --rpc: http-rpc</span><br><span class=\"line\">                --rpcport: http-rpc8545</span><br><span class=\"line\">                --ws:</span><br><span class=\"line\">                --wsport:</span><br><span class=\"line\">                --allow-insecure-unlock</span><br></pre></td></tr></table></figure>\n\n<p>3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ geth --datadir node2 init helloworldprivate.json</span><br><span class=\"line\">$ geth --datadir node2 --port 30001 --nodiscover --unlock &apos;0&apos; --password ./node2/password console</span><br><span class=\"line\"></span><br><span class=\"line\">$ geth --datadir node3 init helloworldprivate.json</span><br><span class=\"line\">$ geth --datadir node3 --port 30002 --nodiscover --unlock &apos;0&apos; --password ./node3/password console</span><br></pre></td></tr></table></figure>\n\n<p>unlock 0,  3</p>\n<p>consoleJavaScriptJavaScriptJavaScript</p>\n<ul>\n<li>eth</li>\n<li>netp2p</li>\n<li>admin</li>\n<li>miner&amp;</li>\n<li>personal</li>\n<li>txpool</li>\n<li>web3</li>\n</ul>\n<p></p>\n<ul>\n<li><p>personal.newAccount()</p>\n</li>\n<li><p>personal.unlockAccount()</p>\n</li>\n<li><p>eth.accounts</p>\n</li>\n<li><p>eth.getBalance() WeiWei <code></code>1 ether = 10^18 Wei <code>web3.fromWei(eth.getBalance(e), &quot;ether&quot;)</code></p>\n<p><code>web3.toWei(&#39;1&#39;, &#39;ether&#39;)</code></p>\n</li>\n</ul>\n<ul>\n<li><p>eth.blockNumberblockNumbereth</p>\n</li>\n<li><p>eth.getTransaction()</p>\n</li>\n<li><p>eth.getBlock()eth.getBlock(pending, true).transactions eth.getBlock(4)</p>\n</li>\n<li><p>miner.start()</p>\n</li>\n<li><p>miner.stop()</p>\n</li>\n<li><p>web3.fromWei()Wei </p>\n</li>\n<li><p>web3.toWei() Weiamount = web3.toWei(5,ether)</p>\n</li>\n<li><p>txpool.status</p>\n</li>\n<li><p>admin.addPeer()</p>\n</li>\n</ul>\n<p>peer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; admin.peers #</span><br><span class=\"line\">&gt; net.peerCount #</span><br></pre></td></tr></table></figure>\n\n<p>admin.peers[]</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; admin.nodeInfo.enode #encode://&lt;id&gt;@ip</span><br><span class=\"line\">&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;</span><br></pre></td></tr></table></figure>\n\n<p>node1node2, node3consoleadmin.addPeernode1node2,node3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; admin.addPeer(&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;)</span><br></pre></td></tr></table></figure>\n\n<p>admin.peersnode12node2, node3,node2node31node1</p>\n<p>datadirstatic-node.json, </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">&quot;enode://0480c837fc76671a8d8ee78b74fd04f9439762cc2e2e668b8604dda964c679ec8dd10f8347d7066707a315db8ad5c141e9d5a5b98f3a790660792f4469086f21@[::]:30000?discport=0&quot;,</span><br><span class=\"line\">&quot;enode://79671ba7d09a4e6d16a64128e2cb24f544ec8740084e1ceb1abcac7b1c2b8a37dae812653360caf30ceff782265b124c1e6ce1d547dc6854bafb85596795751c@[::]:30001?discport=0&quot;,</span><br><span class=\"line\">&quot;enode://3237c4eaf0dbf55b459eef14c4ecffe987b5179e482399b282bc5ab3d1559dd8461a9d39460810bf0d8c276fb13a9950eca5c38890dbf11d9dccdb1b61231a78@[::]:30002?discport=0&quot;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n\n<p>geth - -bootnodes enode:.</p>\n<p>geth</p>\n<p>miner.start()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.start()</span><br><span class=\"line\">INFO [04-10|17:59:10] Transaction pool price threshold updated price=18000000000</span><br><span class=\"line\">INFO [04-10|17:59:10] Starting mining operation</span><br><span class=\"line\">null</span><br><span class=\"line\">&gt; INFO [04-10|17:59:10] Commit new mining work                   number=1 txs=2 uncles=0 elapsed=1.058ms</span><br><span class=\"line\">INFO [04-10|17:59:10] Successfully sealed new block            number=1 hash=3b7e1038d85e</span><br><span class=\"line\">INFO [04-10|17:59:10]  mined potential block                  number=1 hash=3b7e1038d85e</span><br><span class=\"line\">INFO [04-10|17:59:10] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=285.156s</span><br><span class=\"line\">INFO [04-10|17:59:15] Successfully sealed new block            number=2 hash=1bb861fbcb78</span><br></pre></td></tr></table></figure>\n\n<p>..  </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WARN [04-10|17:55:49] Block sealing failed                     err=&quot;authentication needed: password or unlock&quot;</span><br><span class=\"line\">&gt; personal.unlockAccount(eth.accounts[0])</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.start()</span><br><span class=\"line\"></span><br><span class=\"line\">null</span><br></pre></td></tr></table></figure>\n\n<p>null, ~</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.setEtherbase(eth.accounts[0])</span><br><span class=\"line\">true</span><br><span class=\"line\">&gt; miner.start()</span><br></pre></td></tr></table></figure>\n\n<p>,  toeth.accounts</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; eth.sendTransaction(&#123;from: eth.accounts[0], to: &quot;b6deeb049de5fb90345b5b84dd1faf2d56c6929e&quot;, value: web3.toWei(200, &quot;ether&quot;)&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>minerblock,  txsblock</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INFO [04-10|17:59:15] Imported new chain segment               blocks=2 txs=1 mgas=0.042 elapsed=1.348ms  mgasps=31.157 number=2 hash=1bb861fbcb78 cache=2.47kB</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; miner.start(1);admin.sleepBlocks(1);miner.stop();</span><br></pre></td></tr></table></figure>\n\n<p> </p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install solc</span><br></pre></td></tr></table></figure>\n\n<p>..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">geth attach http://0.0.0.0:1112</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&quot;/Applications/Ethereum Wallet.app/Contents/MacOS/Ethereum Wallet&quot; --rpc http://localhost:8545</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    --rpcapi=&quot;db,eth,net,web3,personal,web3&quot; --rpc --rpcaddr 0.0.0.0 -rpcport 1112 --mine</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">eth.sendTransaction(&#123;from:eth.accounts[0], data:&quot;0x0100f862a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000809471562b71999873db5b286df957af199ec94617f78568656c6c6f80808080&quot;&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>android</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make android</span><br><span class=\"line\"></span><br><span class=\"line\">./build/env.sh xgo --go=latest --dest=build/bin -v --targets=android-23/arm64 ./cmd/geth</span><br><span class=\"line\"></span><br><span class=\"line\">glide mirror set golang.org/x/text  /home/users/qiangmzsx/var/golang/golang.org/x/text</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eth.sendTransaction(&#123;from: eth.accounts[0], to: &quot;0x71562b71999873DB5b286dF957af199Ec94617F7&quot;, value: 200000&#125;)</span><br></pre></td></tr></table></figure>\n\n"},{"title":"eos_code","date":"2019-10-14T06:44:30.000Z","_content":"\n### EOS (plugins)\n\npluginslibraries\n\n**eos**\n\n\n\n#### \n\nprograms[eoswiki](https://github.com/EOSIO/eos/wiki/Programs-&-Tools)\n\n```\n.. eos/programs:\n\n CMakeLists.txt\n cleos //eoscleos  \n debug_node\n eosio-abigen\n eosio-applesedemo\n eosio-launcher\n genesis\n keosd  //\n nodeos  //\n snapshot\n```\n\nnodeoscleosREST APInodeosnodeos\n\nmain.cpp105main = =mainlogstartup\n\n```\nint main(int argc, char** argv)\n{\n   try {\n      app().set_version(eosio::nodeos::config::version);\n      auto root = fc::app_path();\n      app().set_default_data_dir(root / \"eosio/nodeos/data\" );\n      app().set_default_config_dir(root / \"eosio/nodeos/config\" );\n      if(!app().initialize<chain_plugin, http_plugin, net_plugin, producer_plugin>(argc, argv))\n         return -1;\n      initialize_logging();\n      ilog(\"nodeos version ${ver}\", (\"ver\", eosio::utilities::common::itoh(static_cast<uint32_t>(app().version()))));\n      ilog(\"eosio root is ${root}\", (\"root\", root.string()));\n      //!!!\n      app().startup();\n      app().exec();\n   } catch (const fc::exception& e) {\n   } .....(catch)\n   return 0;\n}\n```\n\napp()\n\n```\n./libraries/appbase/application.cpp\n//app()application(c++startup)\n```\n\napplication.cpp\n\n- initialize_..: app\n\n- startup:  startup\n- exec:  = =!!io..\n\n\n\n\n\n#### \n\neos\n\n```\n.. eos/plugins:\n\n CMakeLists.txt\n account_history_api_plugin\n account_history_plugin\n chain_api_plugin\n chain_plugin\n eosio-make_new_plugin.sh\n faucet_testnet_plugin\n http_plugin\n mongo_db_plugin\n net_api_plugin\n net_plugin\n producer_plugin\n template_plugin\n txn_test_gen_plugin\n wallet_api_plugin\n wallet_plugin\n```\n\nplugins..\n\n\n### eos/nodeos\n\n\n\n#### main.cpp\n\n```\n      //\n      app().set_version(eosio::nodeos::config::version);\n      auto root = fc::app_path();\n      //\n      app().set_default_data_dir(root / \"eosio/nodeos/data\" );\n      app().set_default_config_dir(root / \"eosio/nodeos/config\" );\n      //\n      if(!app().initialize<chain_plugin, http_plugin, net_plugin, producer_plugin>(argc, argv))\n         return -1;\n\n      initialize_logging();\n      ilog(\"nodeos version ${ver}\", (\"ver\", eosio::nodeos::config::itoh(static_cast<uint32_t>(app().version()))));\n      ilog(\"eosio root is ${root}\", (\"root\", root.string()));\n      app().startup();\n      app().exec();\n\n\n```\n\n\n\nappapp\n\n```\n./libraries/appbase/application.cpp\n```\n\n- app:  applicationc++application::method\n\n- initialize_..: app\n\n- startup:  startup\n\n- exec:  = =!!io..\n\n\n\n4\n\napplicationstart_upplugin..\n\n- set_program_options //\n\n- plugin_initialize //\n\n- plugin_startup  //\n\n- plugin_shutdown  //\n\n\n\n\n\n#### Chain_plugin\n\n\n\n\n\n#### Producer_plugin\n\n\n\n```\n // dpos   -> get_scheduled_producerchain_controller\n auto scheduled_producer = chain.get_scheduled_producer( slot );\n   // we must control the producer scheduled to produce the next block.\n   if( _producers.find( scheduled_producer ) == _producers.end() )\n   {\n      capture(\"scheduled_producer\", scheduled_producer);\n      return block_production_condition::not_my_turn;\n   }\n```\n\n\n\n\n\n```go\n//chain_controllerproducer\n\n//producer\nupdate_signing_producer(const producer_object& signing_producer, const signed_block& new_block)\n\n//producersdbcreate\nupdate_or_create_producers( const producer_schedule_type& producers)\n\n//mproducer,block_signing_keynullmproducer_count..\n_calculate_producer_schedule() {\n  //get_global_propertiesglobal_property_objectnew_active_producers\n  //new_active_producerswasmapinew_active_producersproducers..(_calculate_producer_schedule)mblock_signing_keynull\n   producer_schedule_type schedule = get_global_properties().new_active_producers;\n   const auto& hps = _head_producer_schedule();\n   schedule.version = hps.version;\n   if( hps != schedule )\n      ++schedule.version;\n   return schedule;\n}\n\n//..producers(_db)\n_update_producers_authority()\n\n//producer\nhead_block_producer()\n\n//account_name/ownernameproducer\nget_producer(const account_name& ownername)\n\n\n//slot_numproducer.slot_numslot_numslot_num == 1 producer, slot_num == 2producerslot_numproducer\nget_scheduled_producer(uint32_t slot_num) {\n   const dynamic_global_property_object& dpo = get_dynamic_global_properties();\n  //1 + slot_num  \n   uint64_t current_aslot = dpo.current_absolute_slot + slot_num;\n   ...\n  //producer*\n   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);\n}\n\n//producer\nproducer_participation_rate()\n\n\n\n//\n\nupdate_last_irreversible_block\n```\n\n\n\n\n### producer\n\n..eos/plugins/producer_plugin/\n\nproducer_plugin.hpp producer_plugin.cpp\n\n```\n CMakeLists.txt\n include\n  eosio\n      producer_plugin\n          producer_plugin.hpp\n producer_plugin.cpp\n\n```\n\n\n\nproducer_plugin.cpp400\n\n```\nplugin_startup -> schedule_production_loop(,) -> block_production_loop -> maybe_produce_block\n```\n\nmaybe_produce_blockmaybe_produce_block\n\n- \n\n- \n\n  ```\n   uint32_t slot = chain.get_slot_at_time( now );\n     if( slot == 0 )\n     {\n        capture(\"next_time\", chain.get_slot_time(1));\n        return block_production_condition::not_time_yet;\n     }\n  ```\n\n- producer\n\n  ```\n  auto scheduled_producer = chain.get_scheduled_producer( slot );\n  ```\n\nscheduled_producer()\n\nget_scheduled_producerget_scheduled_producerchain_controller.cpp./eos/libriaries/chain/chain_controller.cppchain_controller.cpp\n\nget_scheduled_producerdbglobal_property_objectgpogpo.active_producersproducersindexindexgpo.active_producersproducerindex= % producers * producerproducer(current_aslot)\n\n```\n//\n/*\n* 1. slot_num\n* 2.slot_num\n*     slot_num == 1 producer,\n*          slot_num == 2producerslot_num\n* 3.get_slot_timeget_slot_at_timeslot_num\n* 4.slot_num == 0EOS_NULL_PRODUCER\n*/\naccount_name chain_controller::get_scheduled_producer(uint32_t slot_num)const\n{\n   const dynamic_global_property_object& dpo = get_dynamic_global_properties(); //\n   uint64_t current_aslot = dpo.current_absolute_slot + slot_num; //\n   const auto& gpo = _db.get<global_property_object>(); //\n   auto number_of_active_producers = gpo.active_producers.producers.size();\n   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);  //\n   index /= config::producer_repetitions; //\n   FC_ASSERT( gpo.active_producers.producers.size() > 0, \"no producers defined\" );\n\n   return gpo.active_producers.producers[index].producer_name;\n}\n```\n\n\n\nglobal\\_property\\_objectactive\\_producersnew\\_active\\_producerspending\\_active\\_producers\n\nactive\\_producersproducers, pending\\_active\\_producersproducers, new\\_active\\_producers()producer\n\ncontroller_chain.cpp\n\n```\n//mproducer,block_signing_keynullmproducer_count.\n_calculate_producer_schedule() {...}\n\n//global_properties\nupdate_global_properties(){...}\n\n//active_producers\nupdate_last_irreversible_block(){...}\n\n /*\n *  After applying all transactions successfully we can update\n *  the current block time, block number, producer stats, etc\n */\n_finalize_block(){...}\n```\n\nactive\\_producersnew\\_active\\_producerspending\\_active\\_producersactive\\_producersnew\\_active\\_producerspending\\_active\\_producers\n\n\\_finalize\\_blockupdate\\_global\\_propertiesupdate\\_global\\_properties_calculate\\_producer\\_schedulecalculate\\_producer\\_schedule**new\\_active\\_producersproducers**update\\_global\\_properties**producers,pending\\_active\\_producers**\\_finalize\\_blockupdate\\_global\\_propertiesupdate_last_irreversible_block**pending_active_producersactive\\_producers**\n\nnew\\_active\\_producerswasmapinew\\_active\\_producersnew\\_active\\_producersblocker producers\n\nblocker producers?? \n\n\n\nproducer producer_plugin.cppdposchain_controller.cpp\n","source":"_posts/eos-code.md","raw":"---\ntitle: eos_code\ncategories:\n  - eos\ndate: 2019-10-14 14:44:30\ntags:\n---\n\n### EOS (plugins)\n\npluginslibraries\n\n**eos**\n\n\n\n#### \n\nprograms[eoswiki](https://github.com/EOSIO/eos/wiki/Programs-&-Tools)\n\n```\n.. eos/programs:\n\n CMakeLists.txt\n cleos //eoscleos  \n debug_node\n eosio-abigen\n eosio-applesedemo\n eosio-launcher\n genesis\n keosd  //\n nodeos  //\n snapshot\n```\n\nnodeoscleosREST APInodeosnodeos\n\nmain.cpp105main = =mainlogstartup\n\n```\nint main(int argc, char** argv)\n{\n   try {\n      app().set_version(eosio::nodeos::config::version);\n      auto root = fc::app_path();\n      app().set_default_data_dir(root / \"eosio/nodeos/data\" );\n      app().set_default_config_dir(root / \"eosio/nodeos/config\" );\n      if(!app().initialize<chain_plugin, http_plugin, net_plugin, producer_plugin>(argc, argv))\n         return -1;\n      initialize_logging();\n      ilog(\"nodeos version ${ver}\", (\"ver\", eosio::utilities::common::itoh(static_cast<uint32_t>(app().version()))));\n      ilog(\"eosio root is ${root}\", (\"root\", root.string()));\n      //!!!\n      app().startup();\n      app().exec();\n   } catch (const fc::exception& e) {\n   } .....(catch)\n   return 0;\n}\n```\n\napp()\n\n```\n./libraries/appbase/application.cpp\n//app()application(c++startup)\n```\n\napplication.cpp\n\n- initialize_..: app\n\n- startup:  startup\n- exec:  = =!!io..\n\n\n\n\n\n#### \n\neos\n\n```\n.. eos/plugins:\n\n CMakeLists.txt\n account_history_api_plugin\n account_history_plugin\n chain_api_plugin\n chain_plugin\n eosio-make_new_plugin.sh\n faucet_testnet_plugin\n http_plugin\n mongo_db_plugin\n net_api_plugin\n net_plugin\n producer_plugin\n template_plugin\n txn_test_gen_plugin\n wallet_api_plugin\n wallet_plugin\n```\n\nplugins..\n\n\n### eos/nodeos\n\n\n\n#### main.cpp\n\n```\n      //\n      app().set_version(eosio::nodeos::config::version);\n      auto root = fc::app_path();\n      //\n      app().set_default_data_dir(root / \"eosio/nodeos/data\" );\n      app().set_default_config_dir(root / \"eosio/nodeos/config\" );\n      //\n      if(!app().initialize<chain_plugin, http_plugin, net_plugin, producer_plugin>(argc, argv))\n         return -1;\n\n      initialize_logging();\n      ilog(\"nodeos version ${ver}\", (\"ver\", eosio::nodeos::config::itoh(static_cast<uint32_t>(app().version()))));\n      ilog(\"eosio root is ${root}\", (\"root\", root.string()));\n      app().startup();\n      app().exec();\n\n\n```\n\n\n\nappapp\n\n```\n./libraries/appbase/application.cpp\n```\n\n- app:  applicationc++application::method\n\n- initialize_..: app\n\n- startup:  startup\n\n- exec:  = =!!io..\n\n\n\n4\n\napplicationstart_upplugin..\n\n- set_program_options //\n\n- plugin_initialize //\n\n- plugin_startup  //\n\n- plugin_shutdown  //\n\n\n\n\n\n#### Chain_plugin\n\n\n\n\n\n#### Producer_plugin\n\n\n\n```\n // dpos   -> get_scheduled_producerchain_controller\n auto scheduled_producer = chain.get_scheduled_producer( slot );\n   // we must control the producer scheduled to produce the next block.\n   if( _producers.find( scheduled_producer ) == _producers.end() )\n   {\n      capture(\"scheduled_producer\", scheduled_producer);\n      return block_production_condition::not_my_turn;\n   }\n```\n\n\n\n\n\n```go\n//chain_controllerproducer\n\n//producer\nupdate_signing_producer(const producer_object& signing_producer, const signed_block& new_block)\n\n//producersdbcreate\nupdate_or_create_producers( const producer_schedule_type& producers)\n\n//mproducer,block_signing_keynullmproducer_count..\n_calculate_producer_schedule() {\n  //get_global_propertiesglobal_property_objectnew_active_producers\n  //new_active_producerswasmapinew_active_producersproducers..(_calculate_producer_schedule)mblock_signing_keynull\n   producer_schedule_type schedule = get_global_properties().new_active_producers;\n   const auto& hps = _head_producer_schedule();\n   schedule.version = hps.version;\n   if( hps != schedule )\n      ++schedule.version;\n   return schedule;\n}\n\n//..producers(_db)\n_update_producers_authority()\n\n//producer\nhead_block_producer()\n\n//account_name/ownernameproducer\nget_producer(const account_name& ownername)\n\n\n//slot_numproducer.slot_numslot_numslot_num == 1 producer, slot_num == 2producerslot_numproducer\nget_scheduled_producer(uint32_t slot_num) {\n   const dynamic_global_property_object& dpo = get_dynamic_global_properties();\n  //1 + slot_num  \n   uint64_t current_aslot = dpo.current_absolute_slot + slot_num;\n   ...\n  //producer*\n   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);\n}\n\n//producer\nproducer_participation_rate()\n\n\n\n//\n\nupdate_last_irreversible_block\n```\n\n\n\n\n### producer\n\n..eos/plugins/producer_plugin/\n\nproducer_plugin.hpp producer_plugin.cpp\n\n```\n CMakeLists.txt\n include\n  eosio\n      producer_plugin\n          producer_plugin.hpp\n producer_plugin.cpp\n\n```\n\n\n\nproducer_plugin.cpp400\n\n```\nplugin_startup -> schedule_production_loop(,) -> block_production_loop -> maybe_produce_block\n```\n\nmaybe_produce_blockmaybe_produce_block\n\n- \n\n- \n\n  ```\n   uint32_t slot = chain.get_slot_at_time( now );\n     if( slot == 0 )\n     {\n        capture(\"next_time\", chain.get_slot_time(1));\n        return block_production_condition::not_time_yet;\n     }\n  ```\n\n- producer\n\n  ```\n  auto scheduled_producer = chain.get_scheduled_producer( slot );\n  ```\n\nscheduled_producer()\n\nget_scheduled_producerget_scheduled_producerchain_controller.cpp./eos/libriaries/chain/chain_controller.cppchain_controller.cpp\n\nget_scheduled_producerdbglobal_property_objectgpogpo.active_producersproducersindexindexgpo.active_producersproducerindex= % producers * producerproducer(current_aslot)\n\n```\n//\n/*\n* 1. slot_num\n* 2.slot_num\n*     slot_num == 1 producer,\n*          slot_num == 2producerslot_num\n* 3.get_slot_timeget_slot_at_timeslot_num\n* 4.slot_num == 0EOS_NULL_PRODUCER\n*/\naccount_name chain_controller::get_scheduled_producer(uint32_t slot_num)const\n{\n   const dynamic_global_property_object& dpo = get_dynamic_global_properties(); //\n   uint64_t current_aslot = dpo.current_absolute_slot + slot_num; //\n   const auto& gpo = _db.get<global_property_object>(); //\n   auto number_of_active_producers = gpo.active_producers.producers.size();\n   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);  //\n   index /= config::producer_repetitions; //\n   FC_ASSERT( gpo.active_producers.producers.size() > 0, \"no producers defined\" );\n\n   return gpo.active_producers.producers[index].producer_name;\n}\n```\n\n\n\nglobal\\_property\\_objectactive\\_producersnew\\_active\\_producerspending\\_active\\_producers\n\nactive\\_producersproducers, pending\\_active\\_producersproducers, new\\_active\\_producers()producer\n\ncontroller_chain.cpp\n\n```\n//mproducer,block_signing_keynullmproducer_count.\n_calculate_producer_schedule() {...}\n\n//global_properties\nupdate_global_properties(){...}\n\n//active_producers\nupdate_last_irreversible_block(){...}\n\n /*\n *  After applying all transactions successfully we can update\n *  the current block time, block number, producer stats, etc\n */\n_finalize_block(){...}\n```\n\nactive\\_producersnew\\_active\\_producerspending\\_active\\_producersactive\\_producersnew\\_active\\_producerspending\\_active\\_producers\n\n\\_finalize\\_blockupdate\\_global\\_propertiesupdate\\_global\\_properties_calculate\\_producer\\_schedulecalculate\\_producer\\_schedule**new\\_active\\_producersproducers**update\\_global\\_properties**producers,pending\\_active\\_producers**\\_finalize\\_blockupdate\\_global\\_propertiesupdate_last_irreversible_block**pending_active_producersactive\\_producers**\n\nnew\\_active\\_producerswasmapinew\\_active\\_producersnew\\_active\\_producersblocker producers\n\nblocker producers?? \n\n\n\nproducer producer_plugin.cppdposchain_controller.cpp\n","slug":"eos-code","published":1,"updated":"2019-10-14T06:46:21.817Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69wy0024t6xv77mus96g","content":"<h3 id=\"EOS--plugins\"><a href=\"#EOS--plugins\" class=\"headerlink\" title=\"EOS (plugins)\"></a>EOS (plugins)</h3><p>pluginslibraries</p>\n<p><strong>eos</strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>programs<a href=\"https://github.com/EOSIO/eos/wiki/Programs-&-Tools\">eoswiki</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.. eos/programs:</span><br><span class=\"line\"></span><br><span class=\"line\"> CMakeLists.txt</span><br><span class=\"line\"> cleos //eoscleos  </span><br><span class=\"line\"> debug_node</span><br><span class=\"line\"> eosio-abigen</span><br><span class=\"line\"> eosio-applesedemo</span><br><span class=\"line\"> eosio-launcher</span><br><span class=\"line\"> genesis</span><br><span class=\"line\"> keosd  //</span><br><span class=\"line\"> nodeos  //</span><br><span class=\"line\"> snapshot</span><br></pre></td></tr></table></figure>\n\n<p>nodeoscleosREST APInodeosnodeos</p>\n<p>main.cpp105main = =mainlogstartup</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc, char** argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   try &#123;</span><br><span class=\"line\">      app().set_version(eosio::nodeos::config::version);</span><br><span class=\"line\">      auto root = fc::app_path();</span><br><span class=\"line\">      app().set_default_data_dir(root / &quot;eosio/nodeos/data&quot; );</span><br><span class=\"line\">      app().set_default_config_dir(root / &quot;eosio/nodeos/config&quot; );</span><br><span class=\"line\">      if(!app().initialize&lt;chain_plugin, http_plugin, net_plugin, producer_plugin&gt;(argc, argv))</span><br><span class=\"line\">         return -1;</span><br><span class=\"line\">      initialize_logging();</span><br><span class=\"line\">      ilog(&quot;nodeos version $&#123;ver&#125;&quot;, (&quot;ver&quot;, eosio::utilities::common::itoh(static_cast&lt;uint32_t&gt;(app().version()))));</span><br><span class=\"line\">      ilog(&quot;eosio root is $&#123;root&#125;&quot;, (&quot;root&quot;, root.string()));</span><br><span class=\"line\">      //!!!</span><br><span class=\"line\">      app().startup();</span><br><span class=\"line\">      app().exec();</span><br><span class=\"line\">   &#125; catch (const fc::exception&amp; e) &#123;</span><br><span class=\"line\">   &#125; .....(catch)</span><br><span class=\"line\">   return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>app()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./libraries/appbase/application.cpp</span><br><span class=\"line\">//app()application(c++startup)</span><br></pre></td></tr></table></figure>\n\n<p>application.cpp</p>\n<ul>\n<li><p>initialize_..: app</p>\n</li>\n<li><p>startup:  startup</p>\n</li>\n<li><p>exec:  = =!!io..</p>\n</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>eos</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.. eos/plugins:</span><br><span class=\"line\"></span><br><span class=\"line\"> CMakeLists.txt</span><br><span class=\"line\"> account_history_api_plugin</span><br><span class=\"line\"> account_history_plugin</span><br><span class=\"line\"> chain_api_plugin</span><br><span class=\"line\"> chain_plugin</span><br><span class=\"line\"> eosio-make_new_plugin.sh</span><br><span class=\"line\"> faucet_testnet_plugin</span><br><span class=\"line\"> http_plugin</span><br><span class=\"line\"> mongo_db_plugin</span><br><span class=\"line\"> net_api_plugin</span><br><span class=\"line\"> net_plugin</span><br><span class=\"line\"> producer_plugin</span><br><span class=\"line\"> template_plugin</span><br><span class=\"line\"> txn_test_gen_plugin</span><br><span class=\"line\"> wallet_api_plugin</span><br><span class=\"line\"> wallet_plugin</span><br></pre></td></tr></table></figure>\n\n<p>plugins..</p>\n<h3 id=\"eos-nodeos\"><a href=\"#eos-nodeos\" class=\"headerlink\" title=\"eos/nodeos\"></a>eos/nodeos</h3><h4 id=\"main-cpp\"><a href=\"#main-cpp\" class=\"headerlink\" title=\"main.cpp\"></a>main.cpp</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">app().set_version(eosio::nodeos::config::version);</span><br><span class=\"line\">auto root = fc::app_path();</span><br><span class=\"line\">//</span><br><span class=\"line\">app().set_default_data_dir(root / &quot;eosio/nodeos/data&quot; );</span><br><span class=\"line\">app().set_default_config_dir(root / &quot;eosio/nodeos/config&quot; );</span><br><span class=\"line\">//</span><br><span class=\"line\">if(!app().initialize&lt;chain_plugin, http_plugin, net_plugin, producer_plugin&gt;(argc, argv))</span><br><span class=\"line\">   return -1;</span><br><span class=\"line\"></span><br><span class=\"line\">initialize_logging();</span><br><span class=\"line\">ilog(&quot;nodeos version $&#123;ver&#125;&quot;, (&quot;ver&quot;, eosio::nodeos::config::itoh(static_cast&lt;uint32_t&gt;(app().version()))));</span><br><span class=\"line\">ilog(&quot;eosio root is $&#123;root&#125;&quot;, (&quot;root&quot;, root.string()));</span><br><span class=\"line\">app().startup();</span><br><span class=\"line\">app().exec();</span><br></pre></td></tr></table></figure>\n\n<p>appapp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./libraries/appbase/application.cpp</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>app:  applicationc++application::method</p>\n</li>\n<li><p>initialize_..: app</p>\n</li>\n<li><p>startup:  startup</p>\n</li>\n<li><p>exec:  = =!!io..</p>\n</li>\n</ul>\n<p>4</p>\n<p>applicationstart_upplugin..</p>\n<ul>\n<li><p>set_program_options //</p>\n</li>\n<li><p>plugin_initialize //</p>\n</li>\n<li><p>plugin_startup  //</p>\n</li>\n<li><p>plugin_shutdown  //</p>\n</li>\n</ul>\n<h4 id=\"Chain-plugin\"><a href=\"#Chain-plugin\" class=\"headerlink\" title=\"Chain_plugin\"></a>Chain_plugin</h4><h4 id=\"Producer-plugin\"><a href=\"#Producer-plugin\" class=\"headerlink\" title=\"Producer_plugin\"></a>Producer_plugin</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// dpos   -&gt; get_scheduled_producerchain_controller</span><br><span class=\"line\">auto scheduled_producer = chain.get_scheduled_producer( slot );</span><br><span class=\"line\">  // we must control the producer scheduled to produce the next block.</span><br><span class=\"line\">  if( _producers.find( scheduled_producer ) == _producers.end() )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     capture(&quot;scheduled_producer&quot;, scheduled_producer);</span><br><span class=\"line\">     return block_production_condition::not_my_turn;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//chain_controllerproducer</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producer</span></span><br><span class=\"line\">update_signing_producer(<span class=\"keyword\">const</span> producer_object&amp; signing_producer, <span class=\"keyword\">const</span> signed_block&amp; new_block)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producersdbcreate</span></span><br><span class=\"line\">update_or_create_producers( <span class=\"keyword\">const</span> producer_schedule_type&amp; producers)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//mproducer,block_signing_keynullmproducer_count..</span></span><br><span class=\"line\">_calculate_producer_schedule() &#123;</span><br><span class=\"line\">  <span class=\"comment\">//get_global_propertiesglobal_property_objectnew_active_producers</span></span><br><span class=\"line\">  <span class=\"comment\">//new_active_producerswasmapinew_active_producersproducers..(_calculate_producer_schedule)mblock_signing_keynull</span></span><br><span class=\"line\">   producer_schedule_type schedule = get_global_properties().new_active_producers;</span><br><span class=\"line\">   <span class=\"keyword\">const</span> auto&amp; hps = _head_producer_schedule();</span><br><span class=\"line\">   schedule.version = hps.version;</span><br><span class=\"line\">   <span class=\"keyword\">if</span>( hps != schedule )</span><br><span class=\"line\">      ++schedule.version;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> schedule;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//..producers(_db)</span></span><br><span class=\"line\">_update_producers_authority()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producer</span></span><br><span class=\"line\">head_block_producer()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//account_name/ownernameproducer</span></span><br><span class=\"line\">get_producer(<span class=\"keyword\">const</span> account_name&amp; ownername)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//slot_numproducer.slot_numslot_numslot_num == 1 producer, slot_num == 2producerslot_numproducer</span></span><br><span class=\"line\">get_scheduled_producer(uint32_t slot_num) &#123;</span><br><span class=\"line\">   <span class=\"keyword\">const</span> dynamic_global_property_object&amp; dpo = get_dynamic_global_properties();</span><br><span class=\"line\">  <span class=\"comment\">//1 + slot_num  </span></span><br><span class=\"line\">   uint64_t current_aslot = dpo.current_absolute_slot + slot_num;</span><br><span class=\"line\">   ...</span><br><span class=\"line\">  <span class=\"comment\">//producer*</span></span><br><span class=\"line\">   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producer</span></span><br><span class=\"line\">producer_participation_rate()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">update_last_irreversible_block</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"producer\"><a href=\"#producer\" class=\"headerlink\" title=\"producer\"></a>producer</h3><p>..eos/plugins/producer_plugin/</p>\n<p>producer_plugin.hpp producer_plugin.cpp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> CMakeLists.txt</span><br><span class=\"line\"> include</span><br><span class=\"line\">  eosio</span><br><span class=\"line\">      producer_plugin</span><br><span class=\"line\">          producer_plugin.hpp</span><br><span class=\"line\"> producer_plugin.cpp</span><br></pre></td></tr></table></figure>\n\n<p>producer_plugin.cpp400</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugin_startup -&gt; schedule_production_loop(,) -&gt; block_production_loop -&gt; maybe_produce_block</span><br></pre></td></tr></table></figure>\n\n<p>maybe_produce_blockmaybe_produce_block</p>\n<ul>\n<li><p></p>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uint32_t slot = chain.get_slot_at_time( now );</span><br><span class=\"line\">  if( slot == 0 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     capture(&quot;next_time&quot;, chain.get_slot_time(1));</span><br><span class=\"line\">     return block_production_condition::not_time_yet;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>producer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">auto scheduled_producer = chain.get_scheduled_producer( slot );</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>scheduled_producer()</p>\n<p>get_scheduled_producerget_scheduled_producerchain_controller.cpp./eos/libriaries/chain/chain_controller.cppchain_controller.cpp</p>\n<p>get_scheduled_producerdbglobal_property_objectgpogpo.active_producersproducersindexindexgpo.active_producersproducerindex= % producers * producerproducer(current_aslot)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">/*</span><br><span class=\"line\">* 1. slot_num</span><br><span class=\"line\">* 2.slot_num</span><br><span class=\"line\">*     slot_num == 1 producer,</span><br><span class=\"line\">*          slot_num == 2producerslot_num</span><br><span class=\"line\">* 3.get_slot_timeget_slot_at_timeslot_num</span><br><span class=\"line\">* 4.slot_num == 0EOS_NULL_PRODUCER</span><br><span class=\"line\">*/</span><br><span class=\"line\">account_name chain_controller::get_scheduled_producer(uint32_t slot_num)const</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   const dynamic_global_property_object&amp; dpo = get_dynamic_global_properties(); //</span><br><span class=\"line\">   uint64_t current_aslot = dpo.current_absolute_slot + slot_num; //</span><br><span class=\"line\">   const auto&amp; gpo = _db.get&lt;global_property_object&gt;(); //</span><br><span class=\"line\">   auto number_of_active_producers = gpo.active_producers.producers.size();</span><br><span class=\"line\">   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);  //</span><br><span class=\"line\">   index /= config::producer_repetitions; //</span><br><span class=\"line\">   FC_ASSERT( gpo.active_producers.producers.size() &gt; 0, &quot;no producers defined&quot; );</span><br><span class=\"line\"></span><br><span class=\"line\">   return gpo.active_producers.producers[index].producer_name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>global_property_objectactive_producersnew_active_producerspending_active_producers</p>\n<p>active_producersproducers, pending_active_producersproducers, new_active_producers()producer</p>\n<p>controller_chain.cpp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//mproducer,block_signing_keynullmproducer_count.</span><br><span class=\"line\">_calculate_producer_schedule() &#123;...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//global_properties</span><br><span class=\"line\">update_global_properties()&#123;...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//active_producers</span><br><span class=\"line\">update_last_irreversible_block()&#123;...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> /*</span><br><span class=\"line\"> *  After applying all transactions successfully we can update</span><br><span class=\"line\"> *  the current block time, block number, producer stats, etc</span><br><span class=\"line\"> */</span><br><span class=\"line\">_finalize_block()&#123;...&#125;</span><br></pre></td></tr></table></figure>\n\n<p>active_producersnew_active_producerspending_active_producersactive_producersnew_active_producerspending_active_producers</p>\n<p>_finalize_blockupdate_global_propertiesupdate_global_properties_calculate_producer_schedulecalculate_producer_schedule<strong>new_active_producersproducers</strong>update_global_properties<strong>producers,pending_active_producers</strong>_finalize_blockupdate_global_propertiesupdate_last_irreversible_block<strong>pending_active_producersactive_producers</strong></p>\n<p>new_active_producerswasmapinew_active_producersnew_active_producersblocker producers</p>\n<p>blocker producers?? </p>\n<p>producer producer_plugin.cppdposchain_controller.cpp</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h3 id=\"EOS--plugins\"><a href=\"#EOS--plugins\" class=\"headerlink\" title=\"EOS (plugins)\"></a>EOS (plugins)</h3><p>pluginslibraries</p>\n<p><strong>eos</strong></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>programs<a href=\"https://github.com/EOSIO/eos/wiki/Programs-&-Tools\">eoswiki</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.. eos/programs:</span><br><span class=\"line\"></span><br><span class=\"line\"> CMakeLists.txt</span><br><span class=\"line\"> cleos //eoscleos  </span><br><span class=\"line\"> debug_node</span><br><span class=\"line\"> eosio-abigen</span><br><span class=\"line\"> eosio-applesedemo</span><br><span class=\"line\"> eosio-launcher</span><br><span class=\"line\"> genesis</span><br><span class=\"line\"> keosd  //</span><br><span class=\"line\"> nodeos  //</span><br><span class=\"line\"> snapshot</span><br></pre></td></tr></table></figure>\n\n<p>nodeoscleosREST APInodeosnodeos</p>\n<p>main.cpp105main = =mainlogstartup</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc, char** argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   try &#123;</span><br><span class=\"line\">      app().set_version(eosio::nodeos::config::version);</span><br><span class=\"line\">      auto root = fc::app_path();</span><br><span class=\"line\">      app().set_default_data_dir(root / &quot;eosio/nodeos/data&quot; );</span><br><span class=\"line\">      app().set_default_config_dir(root / &quot;eosio/nodeos/config&quot; );</span><br><span class=\"line\">      if(!app().initialize&lt;chain_plugin, http_plugin, net_plugin, producer_plugin&gt;(argc, argv))</span><br><span class=\"line\">         return -1;</span><br><span class=\"line\">      initialize_logging();</span><br><span class=\"line\">      ilog(&quot;nodeos version $&#123;ver&#125;&quot;, (&quot;ver&quot;, eosio::utilities::common::itoh(static_cast&lt;uint32_t&gt;(app().version()))));</span><br><span class=\"line\">      ilog(&quot;eosio root is $&#123;root&#125;&quot;, (&quot;root&quot;, root.string()));</span><br><span class=\"line\">      //!!!</span><br><span class=\"line\">      app().startup();</span><br><span class=\"line\">      app().exec();</span><br><span class=\"line\">   &#125; catch (const fc::exception&amp; e) &#123;</span><br><span class=\"line\">   &#125; .....(catch)</span><br><span class=\"line\">   return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>app()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./libraries/appbase/application.cpp</span><br><span class=\"line\">//app()application(c++startup)</span><br></pre></td></tr></table></figure>\n\n<p>application.cpp</p>\n<ul>\n<li><p>initialize_..: app</p>\n</li>\n<li><p>startup:  startup</p>\n</li>\n<li><p>exec:  = =!!io..</p>\n</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>eos</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.. eos/plugins:</span><br><span class=\"line\"></span><br><span class=\"line\"> CMakeLists.txt</span><br><span class=\"line\"> account_history_api_plugin</span><br><span class=\"line\"> account_history_plugin</span><br><span class=\"line\"> chain_api_plugin</span><br><span class=\"line\"> chain_plugin</span><br><span class=\"line\"> eosio-make_new_plugin.sh</span><br><span class=\"line\"> faucet_testnet_plugin</span><br><span class=\"line\"> http_plugin</span><br><span class=\"line\"> mongo_db_plugin</span><br><span class=\"line\"> net_api_plugin</span><br><span class=\"line\"> net_plugin</span><br><span class=\"line\"> producer_plugin</span><br><span class=\"line\"> template_plugin</span><br><span class=\"line\"> txn_test_gen_plugin</span><br><span class=\"line\"> wallet_api_plugin</span><br><span class=\"line\"> wallet_plugin</span><br></pre></td></tr></table></figure>\n\n<p>plugins..</p>\n<h3 id=\"eos-nodeos\"><a href=\"#eos-nodeos\" class=\"headerlink\" title=\"eos/nodeos\"></a>eos/nodeos</h3><h4 id=\"main-cpp\"><a href=\"#main-cpp\" class=\"headerlink\" title=\"main.cpp\"></a>main.cpp</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">app().set_version(eosio::nodeos::config::version);</span><br><span class=\"line\">auto root = fc::app_path();</span><br><span class=\"line\">//</span><br><span class=\"line\">app().set_default_data_dir(root / &quot;eosio/nodeos/data&quot; );</span><br><span class=\"line\">app().set_default_config_dir(root / &quot;eosio/nodeos/config&quot; );</span><br><span class=\"line\">//</span><br><span class=\"line\">if(!app().initialize&lt;chain_plugin, http_plugin, net_plugin, producer_plugin&gt;(argc, argv))</span><br><span class=\"line\">   return -1;</span><br><span class=\"line\"></span><br><span class=\"line\">initialize_logging();</span><br><span class=\"line\">ilog(&quot;nodeos version $&#123;ver&#125;&quot;, (&quot;ver&quot;, eosio::nodeos::config::itoh(static_cast&lt;uint32_t&gt;(app().version()))));</span><br><span class=\"line\">ilog(&quot;eosio root is $&#123;root&#125;&quot;, (&quot;root&quot;, root.string()));</span><br><span class=\"line\">app().startup();</span><br><span class=\"line\">app().exec();</span><br></pre></td></tr></table></figure>\n\n<p>appapp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./libraries/appbase/application.cpp</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>app:  applicationc++application::method</p>\n</li>\n<li><p>initialize_..: app</p>\n</li>\n<li><p>startup:  startup</p>\n</li>\n<li><p>exec:  = =!!io..</p>\n</li>\n</ul>\n<p>4</p>\n<p>applicationstart_upplugin..</p>\n<ul>\n<li><p>set_program_options //</p>\n</li>\n<li><p>plugin_initialize //</p>\n</li>\n<li><p>plugin_startup  //</p>\n</li>\n<li><p>plugin_shutdown  //</p>\n</li>\n</ul>\n<h4 id=\"Chain-plugin\"><a href=\"#Chain-plugin\" class=\"headerlink\" title=\"Chain_plugin\"></a>Chain_plugin</h4><h4 id=\"Producer-plugin\"><a href=\"#Producer-plugin\" class=\"headerlink\" title=\"Producer_plugin\"></a>Producer_plugin</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// dpos   -&gt; get_scheduled_producerchain_controller</span><br><span class=\"line\">auto scheduled_producer = chain.get_scheduled_producer( slot );</span><br><span class=\"line\">  // we must control the producer scheduled to produce the next block.</span><br><span class=\"line\">  if( _producers.find( scheduled_producer ) == _producers.end() )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     capture(&quot;scheduled_producer&quot;, scheduled_producer);</span><br><span class=\"line\">     return block_production_condition::not_my_turn;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//chain_controllerproducer</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producer</span></span><br><span class=\"line\">update_signing_producer(<span class=\"keyword\">const</span> producer_object&amp; signing_producer, <span class=\"keyword\">const</span> signed_block&amp; new_block)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producersdbcreate</span></span><br><span class=\"line\">update_or_create_producers( <span class=\"keyword\">const</span> producer_schedule_type&amp; producers)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//mproducer,block_signing_keynullmproducer_count..</span></span><br><span class=\"line\">_calculate_producer_schedule() &#123;</span><br><span class=\"line\">  <span class=\"comment\">//get_global_propertiesglobal_property_objectnew_active_producers</span></span><br><span class=\"line\">  <span class=\"comment\">//new_active_producerswasmapinew_active_producersproducers..(_calculate_producer_schedule)mblock_signing_keynull</span></span><br><span class=\"line\">   producer_schedule_type schedule = get_global_properties().new_active_producers;</span><br><span class=\"line\">   <span class=\"keyword\">const</span> auto&amp; hps = _head_producer_schedule();</span><br><span class=\"line\">   schedule.version = hps.version;</span><br><span class=\"line\">   <span class=\"keyword\">if</span>( hps != schedule )</span><br><span class=\"line\">      ++schedule.version;</span><br><span class=\"line\">   <span class=\"keyword\">return</span> schedule;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//..producers(_db)</span></span><br><span class=\"line\">_update_producers_authority()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producer</span></span><br><span class=\"line\">head_block_producer()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//account_name/ownernameproducer</span></span><br><span class=\"line\">get_producer(<span class=\"keyword\">const</span> account_name&amp; ownername)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//slot_numproducer.slot_numslot_numslot_num == 1 producer, slot_num == 2producerslot_numproducer</span></span><br><span class=\"line\">get_scheduled_producer(uint32_t slot_num) &#123;</span><br><span class=\"line\">   <span class=\"keyword\">const</span> dynamic_global_property_object&amp; dpo = get_dynamic_global_properties();</span><br><span class=\"line\">  <span class=\"comment\">//1 + slot_num  </span></span><br><span class=\"line\">   uint64_t current_aslot = dpo.current_absolute_slot + slot_num;</span><br><span class=\"line\">   ...</span><br><span class=\"line\">  <span class=\"comment\">//producer*</span></span><br><span class=\"line\">   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//producer</span></span><br><span class=\"line\">producer_participation_rate()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">update_last_irreversible_block</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"producer\"><a href=\"#producer\" class=\"headerlink\" title=\"producer\"></a>producer</h3><p>..eos/plugins/producer_plugin/</p>\n<p>producer_plugin.hpp producer_plugin.cpp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> CMakeLists.txt</span><br><span class=\"line\"> include</span><br><span class=\"line\">  eosio</span><br><span class=\"line\">      producer_plugin</span><br><span class=\"line\">          producer_plugin.hpp</span><br><span class=\"line\"> producer_plugin.cpp</span><br></pre></td></tr></table></figure>\n\n<p>producer_plugin.cpp400</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plugin_startup -&gt; schedule_production_loop(,) -&gt; block_production_loop -&gt; maybe_produce_block</span><br></pre></td></tr></table></figure>\n\n<p>maybe_produce_blockmaybe_produce_block</p>\n<ul>\n<li><p></p>\n</li>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uint32_t slot = chain.get_slot_at_time( now );</span><br><span class=\"line\">  if( slot == 0 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">     capture(&quot;next_time&quot;, chain.get_slot_time(1));</span><br><span class=\"line\">     return block_production_condition::not_time_yet;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>producer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">auto scheduled_producer = chain.get_scheduled_producer( slot );</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>scheduled_producer()</p>\n<p>get_scheduled_producerget_scheduled_producerchain_controller.cpp./eos/libriaries/chain/chain_controller.cppchain_controller.cpp</p>\n<p>get_scheduled_producerdbglobal_property_objectgpogpo.active_producersproducersindexindexgpo.active_producersproducerindex= % producers * producerproducer(current_aslot)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">/*</span><br><span class=\"line\">* 1. slot_num</span><br><span class=\"line\">* 2.slot_num</span><br><span class=\"line\">*     slot_num == 1 producer,</span><br><span class=\"line\">*          slot_num == 2producerslot_num</span><br><span class=\"line\">* 3.get_slot_timeget_slot_at_timeslot_num</span><br><span class=\"line\">* 4.slot_num == 0EOS_NULL_PRODUCER</span><br><span class=\"line\">*/</span><br><span class=\"line\">account_name chain_controller::get_scheduled_producer(uint32_t slot_num)const</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   const dynamic_global_property_object&amp; dpo = get_dynamic_global_properties(); //</span><br><span class=\"line\">   uint64_t current_aslot = dpo.current_absolute_slot + slot_num; //</span><br><span class=\"line\">   const auto&amp; gpo = _db.get&lt;global_property_object&gt;(); //</span><br><span class=\"line\">   auto number_of_active_producers = gpo.active_producers.producers.size();</span><br><span class=\"line\">   auto index = current_aslot % (number_of_active_producers * config::producer_repetitions);  //</span><br><span class=\"line\">   index /= config::producer_repetitions; //</span><br><span class=\"line\">   FC_ASSERT( gpo.active_producers.producers.size() &gt; 0, &quot;no producers defined&quot; );</span><br><span class=\"line\"></span><br><span class=\"line\">   return gpo.active_producers.producers[index].producer_name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>global_property_objectactive_producersnew_active_producerspending_active_producers</p>\n<p>active_producersproducers, pending_active_producersproducers, new_active_producers()producer</p>\n<p>controller_chain.cpp</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//mproducer,block_signing_keynullmproducer_count.</span><br><span class=\"line\">_calculate_producer_schedule() &#123;...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//global_properties</span><br><span class=\"line\">update_global_properties()&#123;...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//active_producers</span><br><span class=\"line\">update_last_irreversible_block()&#123;...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> /*</span><br><span class=\"line\"> *  After applying all transactions successfully we can update</span><br><span class=\"line\"> *  the current block time, block number, producer stats, etc</span><br><span class=\"line\"> */</span><br><span class=\"line\">_finalize_block()&#123;...&#125;</span><br></pre></td></tr></table></figure>\n\n<p>active_producersnew_active_producerspending_active_producersactive_producersnew_active_producerspending_active_producers</p>\n<p>_finalize_blockupdate_global_propertiesupdate_global_properties_calculate_producer_schedulecalculate_producer_schedule<strong>new_active_producersproducers</strong>update_global_properties<strong>producers,pending_active_producers</strong>_finalize_blockupdate_global_propertiesupdate_last_irreversible_block<strong>pending_active_producersactive_producers</strong></p>\n<p>new_active_producerswasmapinew_active_producersnew_active_producersblocker producers</p>\n<p>blocker producers?? </p>\n<p>producer producer_plugin.cppdposchain_controller.cpp</p>\n"},{"title":"eth_erc","date":"2019-10-14T06:53:20.000Z","_content":"\n#### ERC\n\nERCEtuereum Request for Comment(EIP)EIPERC/Core\n\n[](https://eips.ethereum.org/erc)\n\n\n\n#### Final\n\n- ERC20\n\n  Ethereum`token`\n\n  - totalSupply()\n  - balanceOf(address _owner)_owner\n  - transfer(address _to,uint256 _value)_value_totransfer\n  - transferFrom(address _from,address _to,uint256_value)_from_value_to transfer\n  - approve(address _spender,uint256 _value)_spender_value\n  - allowance(address _owner,address _spender_spender_owner\n\n  \n\n  - transfer(address indexed _from,address indexed _to,uint256 _value)\n  - approval(address indexed _owner,address indexed _spender,uint256 _value)approve()\n\n\n\n- ERC20:\n\n  - ERC223\n  - ERC62,  increaseSupplydecreaseSupply, \n  - ERC827TokenToken Token ERC827ERC-20\n\n- ERC721\n\n  TokenTokenToken\n\n  CryptoKittes\n\n- ERC55\n\n  ****(checksum)\n\n- ERC137\n\n  Ethereum Domain Name Service (ENS)\n\n  -\n\n- ERC162\n\n  Initial ENS Hash Registrar(ENS: )137\n\n  > ENS; ENS\n  >\n  > \\- EIP 137\n\n  EIP 137ENS162\n\n- ERC165\n\n  ```\n  \n  ```\n\n  ERC165\n   1 \n   2 \n   3 ERC-165\n   4 \n\n- ERC181\n\n  ```\n  ENS support for reverse resolution of Ethereum addresses\n  ```\n\n  ENS\n\n- ERC190\n\n  , \n\n- ERC1167\n\n  \n\n  \n\n- 681\n\n  URL\n\n  EthersERC20URL\n\n\n\n#### Draft\n\n- 1046\n\n  ERC20ERC721\n\n- 1062\n\n  IPFSENS\n\n  > IPFS base58ENSBase58ENSIPFSIPFS Base58\n\n- 1066\n\n  `revert`/HTTPESC\n\n- 1077\n\n  Executable Signed Messages refunded by the contract\n\n  ..(apple pay)\n\n- 1078\n\n  ENS/\n\n  auth\n\n- 1080\n\n  ERC-20ERC-791API\n\n- 1081\n\n  ERC20ETH\n\n  StandardBounties(1081)\n\n- 1123\n\n  190()\n\n- 1129\n\n  DAPP\n\n- 1132\n\n  TokenERC20\n\n  ERC20Token\n\n- 1154\n\n  oracle\n\n- 1155\n\n  tokentokentoken(token)20token721token115520+721\n\n- 1175\n\n  erc20\n\n  \n\n- 1178\n\n  \n\n- 1185\n\n  ENSDNS\n\n  EIPENSDNSENSDNS\n\n- 1191\n\n  ID\n\n  EIPEIP-155IDEIP-55\n\n- 1202\n\n  \n\n- 1271\n\n  \n\n- 1261\n\n  Token\n\n  Token\n\n- 1207\n\n  DAuth\"OAuth\"\n\n- 1203\n\n  Token\n\n  1178\n\n- 1319\n\n  1123\n\n- 1328\n\n  WalletConnectURI831 URI\n\n- 1386\n\n  \n\n  (/)\n\n- 1387\n\n  Merkle Tree\n\n- 1388\n\n  \n\n  138613871388\n\n- 1417\n\n  \n\n  1261() \n\n- 1438\n\n  dapp()\n\n  \n\n- 1444\n\n  ERC-1066\n\n- 1450\n\n  SEC\n\n- 1462\n\n  Token\n\n- 1484\n\n  \n\n  \n\n- 173\n\n  \n\n  \n\n- 191\n\n  \n\n- 205\n\n  ENSabi\n\n  ENSABI\n\n- 725\n\n  \n\n  \n\n- 777\n\n  Token\n\n- 801\n\n  A standard interface for canary contracts.\n\n- **820**\n\n  \n\n  \n\n  165\n\n- 823\n\n  token\n\n  Tokentokentoken\n\n- 831\n\n  URI\n\n-\n\n------\n\n\n\n### Core\n\n- 158\n\n  state clear\n\n- 155\n\n  hash(ID)\n\n- 150\n\n  gas\n\n\n\n\n\n\n\nToken\n\n- /\n- ..\n- Token\n\nAuth\n\nENS\n","source":"_posts/eth-erc.md","raw":"---\ntitle: eth_erc\ncategories:\n  - eth\ndate: 2019-10-14 14:53:20\ntags:\n---\n\n#### ERC\n\nERCEtuereum Request for Comment(EIP)EIPERC/Core\n\n[](https://eips.ethereum.org/erc)\n\n\n\n#### Final\n\n- ERC20\n\n  Ethereum`token`\n\n  - totalSupply()\n  - balanceOf(address _owner)_owner\n  - transfer(address _to,uint256 _value)_value_totransfer\n  - transferFrom(address _from,address _to,uint256_value)_from_value_to transfer\n  - approve(address _spender,uint256 _value)_spender_value\n  - allowance(address _owner,address _spender_spender_owner\n\n  \n\n  - transfer(address indexed _from,address indexed _to,uint256 _value)\n  - approval(address indexed _owner,address indexed _spender,uint256 _value)approve()\n\n\n\n- ERC20:\n\n  - ERC223\n  - ERC62,  increaseSupplydecreaseSupply, \n  - ERC827TokenToken Token ERC827ERC-20\n\n- ERC721\n\n  TokenTokenToken\n\n  CryptoKittes\n\n- ERC55\n\n  ****(checksum)\n\n- ERC137\n\n  Ethereum Domain Name Service (ENS)\n\n  -\n\n- ERC162\n\n  Initial ENS Hash Registrar(ENS: )137\n\n  > ENS; ENS\n  >\n  > \\- EIP 137\n\n  EIP 137ENS162\n\n- ERC165\n\n  ```\n  \n  ```\n\n  ERC165\n   1 \n   2 \n   3 ERC-165\n   4 \n\n- ERC181\n\n  ```\n  ENS support for reverse resolution of Ethereum addresses\n  ```\n\n  ENS\n\n- ERC190\n\n  , \n\n- ERC1167\n\n  \n\n  \n\n- 681\n\n  URL\n\n  EthersERC20URL\n\n\n\n#### Draft\n\n- 1046\n\n  ERC20ERC721\n\n- 1062\n\n  IPFSENS\n\n  > IPFS base58ENSBase58ENSIPFSIPFS Base58\n\n- 1066\n\n  `revert`/HTTPESC\n\n- 1077\n\n  Executable Signed Messages refunded by the contract\n\n  ..(apple pay)\n\n- 1078\n\n  ENS/\n\n  auth\n\n- 1080\n\n  ERC-20ERC-791API\n\n- 1081\n\n  ERC20ETH\n\n  StandardBounties(1081)\n\n- 1123\n\n  190()\n\n- 1129\n\n  DAPP\n\n- 1132\n\n  TokenERC20\n\n  ERC20Token\n\n- 1154\n\n  oracle\n\n- 1155\n\n  tokentokentoken(token)20token721token115520+721\n\n- 1175\n\n  erc20\n\n  \n\n- 1178\n\n  \n\n- 1185\n\n  ENSDNS\n\n  EIPENSDNSENSDNS\n\n- 1191\n\n  ID\n\n  EIPEIP-155IDEIP-55\n\n- 1202\n\n  \n\n- 1271\n\n  \n\n- 1261\n\n  Token\n\n  Token\n\n- 1207\n\n  DAuth\"OAuth\"\n\n- 1203\n\n  Token\n\n  1178\n\n- 1319\n\n  1123\n\n- 1328\n\n  WalletConnectURI831 URI\n\n- 1386\n\n  \n\n  (/)\n\n- 1387\n\n  Merkle Tree\n\n- 1388\n\n  \n\n  138613871388\n\n- 1417\n\n  \n\n  1261() \n\n- 1438\n\n  dapp()\n\n  \n\n- 1444\n\n  ERC-1066\n\n- 1450\n\n  SEC\n\n- 1462\n\n  Token\n\n- 1484\n\n  \n\n  \n\n- 173\n\n  \n\n  \n\n- 191\n\n  \n\n- 205\n\n  ENSabi\n\n  ENSABI\n\n- 725\n\n  \n\n  \n\n- 777\n\n  Token\n\n- 801\n\n  A standard interface for canary contracts.\n\n- **820**\n\n  \n\n  \n\n  165\n\n- 823\n\n  token\n\n  Tokentokentoken\n\n- 831\n\n  URI\n\n-\n\n------\n\n\n\n### Core\n\n- 158\n\n  state clear\n\n- 155\n\n  hash(ID)\n\n- 150\n\n  gas\n\n\n\n\n\n\n\nToken\n\n- /\n- ..\n- Token\n\nAuth\n\nENS\n","slug":"eth-erc","published":1,"updated":"2019-10-14T06:53:37.089Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69x00026t6xvys3yxl6f","content":"<h4 id=\"ERC\"><a href=\"#ERC\" class=\"headerlink\" title=\"ERC\"></a>ERC</h4><p>ERCEtuereum Request for Comment(EIP)EIPERC/Core</p>\n<p><a href=\"https://eips.ethereum.org/erc\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h4 id=\"Final\"><a href=\"#Final\" class=\"headerlink\" title=\"Final\"></a>Final</h4><ul>\n<li><p>ERC20</p>\n<p>Ethereum<code>token</code></p>\n<ul>\n<li>totalSupply()</li>\n<li>balanceOf(address _owner)_owner</li>\n<li>transfer(address _to,uint256 _value)_value_totransfer</li>\n<li>transferFrom(address _from,address _to,uint256_value)_from_value_to transfer</li>\n<li>approve(address _spender,uint256 _value)_spender_value</li>\n<li>allowance(address _owner,address _spender_spender_owner</li>\n</ul>\n<p></p>\n<ul>\n<li>transfer(address indexed _from,address indexed _to,uint256 _value)</li>\n<li>approval(address indexed _owner,address indexed _spender,uint256 _value)approve()</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>ERC20:</p>\n<ul>\n<li>ERC223</li>\n<li>ERC62,  increaseSupplydecreaseSupply, </li>\n<li>ERC827TokenToken Token ERC827ERC-20</li>\n</ul>\n</li>\n<li><p>ERC721</p>\n<p>TokenTokenToken</p>\n<p>CryptoKittes</p>\n</li>\n<li><p>ERC55</p>\n<p><strong></strong>(checksum)</p>\n</li>\n<li><p>ERC137</p>\n<p>Ethereum Domain Name Service (ENS)</p>\n<p>-</p>\n</li>\n<li><p>ERC162</p>\n<p>Initial ENS Hash Registrar(ENS: )137</p>\n<blockquote>\n<p>ENS; ENS</p>\n<p>- EIP 137</p>\n</blockquote>\n<p>EIP 137ENS162</p>\n</li>\n<li><p>ERC165</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>ERC165<br> 1 <br> 2 <br> 3 ERC-165<br> 4 </p>\n</li>\n<li><p>ERC181</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ENS support for reverse resolution of Ethereum addresses</span><br></pre></td></tr></table></figure>\n\n<p>ENS</p>\n</li>\n<li><p>ERC190</p>\n<p>, </p>\n</li>\n<li><p>ERC1167</p>\n<p></p>\n<p></p>\n</li>\n<li><p>681</p>\n<p>URL</p>\n<p>EthersERC20URL</p>\n</li>\n</ul>\n<h4 id=\"Draft\"><a href=\"#Draft\" class=\"headerlink\" title=\"Draft\"></a>Draft</h4><ul>\n<li><p>1046</p>\n<p>ERC20ERC721</p>\n</li>\n<li><p>1062</p>\n<p>IPFSENS</p>\n<blockquote>\n<p>IPFS base58ENSBase58ENSIPFSIPFS Base58</p>\n</blockquote>\n</li>\n<li><p>1066</p>\n<p><code>revert</code>/HTTPESC</p>\n</li>\n<li><p>1077</p>\n<p>Executable Signed Messages refunded by the contract</p>\n<p>..(apple pay)</p>\n</li>\n<li><p>1078</p>\n<p>ENS/</p>\n<p>auth</p>\n</li>\n<li><p>1080</p>\n<p>ERC-20ERC-791API</p>\n</li>\n<li><p>1081</p>\n<p>ERC20ETH</p>\n<p>StandardBounties(1081)</p>\n</li>\n<li><p>1123</p>\n<p>190()</p>\n</li>\n<li><p>1129</p>\n<p>DAPP</p>\n</li>\n<li><p>1132</p>\n<p>TokenERC20</p>\n<p>ERC20Token</p>\n</li>\n<li><p>1154</p>\n<p>oracle</p>\n</li>\n<li><p>1155</p>\n<p>tokentokentoken(token)20token721token115520+721</p>\n</li>\n<li><p>1175</p>\n<p>erc20</p>\n<p></p>\n</li>\n<li><p>1178</p>\n<p></p>\n</li>\n<li><p>1185</p>\n<p>ENSDNS</p>\n<p>EIPENSDNSENSDNS</p>\n</li>\n<li><p>1191</p>\n<p>ID</p>\n<p>EIPEIP-155IDEIP-55</p>\n</li>\n<li><p>1202</p>\n<p></p>\n</li>\n<li><p>1271</p>\n<p></p>\n</li>\n<li><p>1261</p>\n<p>Token</p>\n<p>Token</p>\n</li>\n<li><p>1207</p>\n<p>DAuthOAuth</p>\n</li>\n<li><p>1203</p>\n<p>Token</p>\n<p>1178</p>\n</li>\n<li><p>1319</p>\n<p>1123</p>\n</li>\n<li><p>1328</p>\n<p>WalletConnectURI831 URI</p>\n</li>\n<li><p>1386</p>\n<p></p>\n<p>(/)</p>\n</li>\n<li><p>1387</p>\n<p>Merkle Tree</p>\n</li>\n<li><p>1388</p>\n<p></p>\n<p>138613871388</p>\n</li>\n<li><p>1417</p>\n<p></p>\n<p>1261() </p>\n</li>\n<li><p>1438</p>\n<p>dapp()</p>\n<p></p>\n</li>\n<li><p>1444</p>\n<p>ERC-1066</p>\n</li>\n<li><p>1450</p>\n<p>SEC</p>\n</li>\n<li><p>1462</p>\n<p>Token</p>\n</li>\n<li><p>1484</p>\n<p></p>\n<p></p>\n</li>\n<li><p>173</p>\n<p></p>\n<p></p>\n</li>\n<li><p>191</p>\n<p></p>\n</li>\n<li><p>205</p>\n<p>ENSabi</p>\n<p>ENSABI</p>\n</li>\n<li><p>725</p>\n<p></p>\n<p></p>\n</li>\n<li><p>777</p>\n<p>Token</p>\n</li>\n<li><p>801</p>\n<p>A standard interface for canary contracts.</p>\n</li>\n<li><p><strong>820</strong></p>\n<p></p>\n<p></p>\n<p>165</p>\n</li>\n<li><p>823</p>\n<p>token</p>\n<p>Tokentokentoken</p>\n</li>\n<li><p>831</p>\n<p>URI</p>\n</li>\n</ul>\n<p>-</p>\n<hr>\n<h3 id=\"Core\"><a href=\"#Core\" class=\"headerlink\" title=\"Core\"></a>Core</h3><ul>\n<li><p>158</p>\n<p>state clear</p>\n</li>\n<li><p>155</p>\n<p>hash(ID)</p>\n</li>\n<li><p>150</p>\n<p>gas</p>\n</li>\n</ul>\n<p></p>\n<p>Token</p>\n<ul>\n<li>/</li>\n<li>..</li>\n<li>Token</li>\n</ul>\n<p>Auth</p>\n<p>ENS</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h4 id=\"ERC\"><a href=\"#ERC\" class=\"headerlink\" title=\"ERC\"></a>ERC</h4><p>ERCEtuereum Request for Comment(EIP)EIPERC/Core</p>\n<p><a href=\"https://eips.ethereum.org/erc\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h4 id=\"Final\"><a href=\"#Final\" class=\"headerlink\" title=\"Final\"></a>Final</h4><ul>\n<li><p>ERC20</p>\n<p>Ethereum<code>token</code></p>\n<ul>\n<li>totalSupply()</li>\n<li>balanceOf(address _owner)_owner</li>\n<li>transfer(address _to,uint256 _value)_value_totransfer</li>\n<li>transferFrom(address _from,address _to,uint256_value)_from_value_to transfer</li>\n<li>approve(address _spender,uint256 _value)_spender_value</li>\n<li>allowance(address _owner,address _spender_spender_owner</li>\n</ul>\n<p></p>\n<ul>\n<li>transfer(address indexed _from,address indexed _to,uint256 _value)</li>\n<li>approval(address indexed _owner,address indexed _spender,uint256 _value)approve()</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>ERC20:</p>\n<ul>\n<li>ERC223</li>\n<li>ERC62,  increaseSupplydecreaseSupply, </li>\n<li>ERC827TokenToken Token ERC827ERC-20</li>\n</ul>\n</li>\n<li><p>ERC721</p>\n<p>TokenTokenToken</p>\n<p>CryptoKittes</p>\n</li>\n<li><p>ERC55</p>\n<p><strong></strong>(checksum)</p>\n</li>\n<li><p>ERC137</p>\n<p>Ethereum Domain Name Service (ENS)</p>\n<p>-</p>\n</li>\n<li><p>ERC162</p>\n<p>Initial ENS Hash Registrar(ENS: )137</p>\n<blockquote>\n<p>ENS; ENS</p>\n<p>- EIP 137</p>\n</blockquote>\n<p>EIP 137ENS162</p>\n</li>\n<li><p>ERC165</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>ERC165<br> 1 <br> 2 <br> 3 ERC-165<br> 4 </p>\n</li>\n<li><p>ERC181</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ENS support for reverse resolution of Ethereum addresses</span><br></pre></td></tr></table></figure>\n\n<p>ENS</p>\n</li>\n<li><p>ERC190</p>\n<p>, </p>\n</li>\n<li><p>ERC1167</p>\n<p></p>\n<p></p>\n</li>\n<li><p>681</p>\n<p>URL</p>\n<p>EthersERC20URL</p>\n</li>\n</ul>\n<h4 id=\"Draft\"><a href=\"#Draft\" class=\"headerlink\" title=\"Draft\"></a>Draft</h4><ul>\n<li><p>1046</p>\n<p>ERC20ERC721</p>\n</li>\n<li><p>1062</p>\n<p>IPFSENS</p>\n<blockquote>\n<p>IPFS base58ENSBase58ENSIPFSIPFS Base58</p>\n</blockquote>\n</li>\n<li><p>1066</p>\n<p><code>revert</code>/HTTPESC</p>\n</li>\n<li><p>1077</p>\n<p>Executable Signed Messages refunded by the contract</p>\n<p>..(apple pay)</p>\n</li>\n<li><p>1078</p>\n<p>ENS/</p>\n<p>auth</p>\n</li>\n<li><p>1080</p>\n<p>ERC-20ERC-791API</p>\n</li>\n<li><p>1081</p>\n<p>ERC20ETH</p>\n<p>StandardBounties(1081)</p>\n</li>\n<li><p>1123</p>\n<p>190()</p>\n</li>\n<li><p>1129</p>\n<p>DAPP</p>\n</li>\n<li><p>1132</p>\n<p>TokenERC20</p>\n<p>ERC20Token</p>\n</li>\n<li><p>1154</p>\n<p>oracle</p>\n</li>\n<li><p>1155</p>\n<p>tokentokentoken(token)20token721token115520+721</p>\n</li>\n<li><p>1175</p>\n<p>erc20</p>\n<p></p>\n</li>\n<li><p>1178</p>\n<p></p>\n</li>\n<li><p>1185</p>\n<p>ENSDNS</p>\n<p>EIPENSDNSENSDNS</p>\n</li>\n<li><p>1191</p>\n<p>ID</p>\n<p>EIPEIP-155IDEIP-55</p>\n</li>\n<li><p>1202</p>\n<p></p>\n</li>\n<li><p>1271</p>\n<p></p>\n</li>\n<li><p>1261</p>\n<p>Token</p>\n<p>Token</p>\n</li>\n<li><p>1207</p>\n<p>DAuthOAuth</p>\n</li>\n<li><p>1203</p>\n<p>Token</p>\n<p>1178</p>\n</li>\n<li><p>1319</p>\n<p>1123</p>\n</li>\n<li><p>1328</p>\n<p>WalletConnectURI831 URI</p>\n</li>\n<li><p>1386</p>\n<p></p>\n<p>(/)</p>\n</li>\n<li><p>1387</p>\n<p>Merkle Tree</p>\n</li>\n<li><p>1388</p>\n<p></p>\n<p>138613871388</p>\n</li>\n<li><p>1417</p>\n<p></p>\n<p>1261() </p>\n</li>\n<li><p>1438</p>\n<p>dapp()</p>\n<p></p>\n</li>\n<li><p>1444</p>\n<p>ERC-1066</p>\n</li>\n<li><p>1450</p>\n<p>SEC</p>\n</li>\n<li><p>1462</p>\n<p>Token</p>\n</li>\n<li><p>1484</p>\n<p></p>\n<p></p>\n</li>\n<li><p>173</p>\n<p></p>\n<p></p>\n</li>\n<li><p>191</p>\n<p></p>\n</li>\n<li><p>205</p>\n<p>ENSabi</p>\n<p>ENSABI</p>\n</li>\n<li><p>725</p>\n<p></p>\n<p></p>\n</li>\n<li><p>777</p>\n<p>Token</p>\n</li>\n<li><p>801</p>\n<p>A standard interface for canary contracts.</p>\n</li>\n<li><p><strong>820</strong></p>\n<p></p>\n<p></p>\n<p>165</p>\n</li>\n<li><p>823</p>\n<p>token</p>\n<p>Tokentokentoken</p>\n</li>\n<li><p>831</p>\n<p>URI</p>\n</li>\n</ul>\n<p>-</p>\n<hr>\n<h3 id=\"Core\"><a href=\"#Core\" class=\"headerlink\" title=\"Core\"></a>Core</h3><ul>\n<li><p>158</p>\n<p>state clear</p>\n</li>\n<li><p>155</p>\n<p>hash(ID)</p>\n</li>\n<li><p>150</p>\n<p>gas</p>\n</li>\n</ul>\n<p></p>\n<p>Token</p>\n<ul>\n<li>/</li>\n<li>..</li>\n<li>Token</li>\n</ul>\n<p>Auth</p>\n<p>ENS</p>\n"},{"title":"eth_p2p_udp","date":"2019-10-14T06:54:36.000Z","_content":"\n## p2p-udp\n\np2pdiscoverudpkademlia\n\n\n\n#### kademlia\n\n[kad](http://www.yeolar.com/note/2010/03/21/kademlia/)\n\nkadIDIDK\n\nIDIDKKnKn-1IDn-1ID3K3ID110K0(0xx1(10x),2(11x)K0xx11x111ID\n\n\n\nKademlia  RPC PINGSTOREFIND_NODEFIND_VALUE\n\n\n\n#### kad\n\nkadkad\n\n\n\n```\nbucketSize      = 16 // Kademlia bucket size\n// We keep buckets for the upper 1/15 of distances because\n// it's very unlikely we'll ever encounter a node that's closer.\nhashBits          = len(common.Hash{}) * 8\nnBuckets          = hashBits / 15       // Number of buckets\nbucketMinDistance = hashBits - nBuckets // Log distance of closest bucket\n```\n\nknBucketsID256(hash32byte * 8bit/byte)/ 15\n\nkbucketSizek\n\nID()\n\n```\n//encPubkeyhash\nfunc (e encPubkey) id() enode.ID {\n\treturn enode.ID(crypto.Keccak256Hash(e[:]))\n}\n//pubkey -> encpubkey\nfunc encodePubkey(key *ecdsa.PublicKey) encPubkey {\n\tvar e encPubkey\n\tmath.ReadBits(key.X, e[:len(e)/2])\n\tmath.ReadBits(key.Y, e[len(e)/2:])\n\treturn e\n}\n```\n\n\n\n- \n\n```\ntype Table struct {\n\tmutex   sync.Mutex        // protects buckets, bucket content, nursery, rand\n\tbuckets [nBuckets]*bucket // index of known nodes by distance\n\t...\n}\n\n```\n\n```\n// bucket contains nodes, ordered by their last activity. the entry\n// that was most recently active is the first element in entries.\ntype bucket struct {\n   entries      []*node // live entries, sorted by time of last contact\n   replacements []*node // recently seen nodes to be used if revalidation fails\n   ips          netutil.DistinctNetSet\n}\n```\n\nbuckets(0<index<nBuckets)indexindexidentriesentriesrevalidationreplacements..\n\n\n\n```\n//b, b.entriesentriesreplacements\nfunc (tab *Table) add(n *node) {\n   if n.ID() == tab.self.ID() {\n      return\n   }\n   tab.mutex.Lock()\n   defer tab.mutex.Unlock()\n   b := tab.bucket(n.ID())\n   if !tab.bumpOrAdd(b, n) {\n      // Node is not in table. Add it to the replacement list.\n      tab.addReplacement(b, n)\n   }\n}\n\n//node\nfunc (tab *Table) delete(node *node) {\n\ttab.mutex.Lock()\n\tdefer tab.mutex.Unlock()\n\n\ttab.deleteInBucket(tab.bucket(node.ID()), node)\n}\n\n//targetnresults\nfunc (tab *Table) closest(target enode.ID, nresults int) *nodesByDistance {\n\t// This is a very wasteful way to find the closest nodes but\n\t// obviously correct. I believe that tree-based buckets would make\n\t// this easier to implement efficiently.\n\tclose := &nodesByDistance{target: target}\n\tfor _, b := range &tab.buckets {\n\t\tfor _, n := range b.entries {\n\t\t\tclose.push(n, nresults)\n\t\t}\n\t}\n\treturn close\n}\n\n```\n\n\n\n- \n\n```\nfunc (tab *Table) loop() {\n  ...\n  loop:\n\tfor {\n\t\tselect {\n\t\tcase <-refresh.C:  //\n\t\t\ttab.seedRand() //\n\t\t\tif refreshDone == nil {\n\t\t\t\trefreshDone = make(chan struct{})\n\t\t\t\tgo tab.doRefresh(refreshDone)  //refreshDone\n\t\t\t}\n\t\tcase req := <-tab.refreshReq: //req\n\t\t\twaiting = append(waiting, req)  //\n\t\t\tif refreshDone == nil {\n\t\t\t\trefreshDone = make(chan struct{})\n\t\t\t\tgo tab.doRefresh(refreshDone)\n\t\t\t}\n\t\tcase <-refreshDone:  //\n\t\t\tfor _, ch := range waiting {\n\t\t\t\tclose(ch)\n\t\t\t}\n\t\t\twaiting, refreshDone = nil, nil //waitingrefreshDone\n\t\tcase <-revalidate.C:\n\t\t\tgo tab.doRevalidate(revalidateDone)\n\t\tcase <-revalidateDone:\n\t\t\trevalidate.Reset(tab.nextRevalidateTime())\n\t\tcase <-copyNodes.C:\n\t\t\tgo tab.copyLiveNodes()\n\t\tcase <-tab.closeReq:\n\t\t\tbreak loop\n\t\t}\n\t}\n  ...\n}\n\n\n\n//\nfunc (tab *Table) doRefresh(done chan struct{}) {\n  defer close(done)\n  ...\n\n  //targetneighborsecp256k1v4nodesecp256k1v4ifloadkeynode\n  var key ecdsa.PublicKey\n  if err := tab.self.Load((*enode.Secp256k1)(&key)); err == nil {\n\ttab.lookup(encodePubkey(&key), false)\n  }\n\n\n  //targetneighborkadfindnode taget512bit,512bit? (findnode target64byte/512bit) sha3kadnodeIDhashhashID\n// The Kademlia paper specifies that the bucket refresh should\n// perform a lookup in the least recently used bucket. We cannot\n// adhere to this because the findnode target is a 512bit value\n// (not hash-sized) and it is not easily possible to generate a\n// sha3 preimage that falls into a chosen bucket.\n// We perform a few lookups with a random target instead.\n  for i := 0; i < 3; i++ {\n\t var target encPubkey\n\t crand.Read(target[:])\n\t tab.lookup(target, false)\n  }\n}\n\n```\n\n\n\n\n\n```\n//lookup\nfunc (tab *Table) lookup(targetKey encPubkey, refreshIfEmpty bool) []*node {\n\tvar (\n\t\ttarget         = enode.ID(crypto.Keccak256Hash(targetKey[:]))  //targetidhash\n\t\tasked          = make(map[enode.ID]bool)  //\n\t\tseen           = make(map[enode.ID]bool)  //\n\t\treply          = make(chan []*node, alpha) //alpha\n\t\tpendingQueries = 0   // \n\t\tresult         *nodesByDistance  //\n\t)\n\t//\n\tasked[tab.self.ID()] = true\n\n    //kresult\n\tfor {\n\t\ttab.mutex.Lock()\n\t\t//targetbucketSize\n\t\tresult = tab.closest(target, bucketSize)\n\t\ttab.mutex.Unlock()\n\t\t//refreshIfEmptyfalse\n\t\tif len(result.entries) > 0 || !refreshIfEmpty {\n\t\t\tbreak\n\t\t}\n\t\t//k(doRefresh -> ..)\n\t\t<-tab.refresh()\n\t\t//refreshIfEmptyfalse,for\n\t\trefreshIfEmpty = false\n\t}\n\n\n\tfor {\n\t\t//<alpha,alphafor..pendingQueries++foralphareplyresult\n\t\tfor i := 0; i < len(result.entries) && pendingQueries < alpha; i++ {\n\t\t\tn := result.entries[i]\n\t\t\tif !asked[n.ID()] {\n\t\t\t\tasked[n.ID()] = true\n\t\t\t\tpendingQueries++\n\t\t\t\t//ntargetKey\n\t\t\t\tgo tab.findnode(n, targetKey, reply)\n\t\t\t}\n\t\t}\n\t\t//\n\t\tif pendingQueries == 0 {\n\t\t\t// we have asked all closest nodes, stop the search\n\t\t\tbreak\n\t\t}\n\n\t\t//<-replyreplyrange\n\t\t// wait for the next reply\n\t\tfor _, n := range <-reply {\n\t\t\tif n != nil && !seen[n.ID()] {\n\t\t\t\tseen[n.ID()] = true\n\t\t\t\t//result.pushresultbucketSizetarget..\n\t\t\t\tresult.push(n, bucketSize)\n\t\t\t}\n\t\t}\n\t\t//pendingQueries\n\t\tpendingQueries--\n\t}\n\n\treturn result.entries\n}\n```\n\n\n\n```\n//findnode\nfunc (tab *Table) findnode(n *node, targetKey encPubkey, reply chan<- []*node) {\n\t//dbn(n)\n\tfails := tab.db.FindFails(n.ID())\n\t//n\n\tr, err := tab.net.findnode(n.ID(), n.addr(), targetKey)\n\n\t//..tab.net.findnode..\n\t//0fails++dbfailstab\n\tif err != nil || len(r) == 0 {\n\t\tfails++\n\t\ttab.db.UpdateFindFails(n.ID(), fails)\n\t\tlog.Trace(\"Findnode failed\", \"id\", n.ID(), \"failcount\", fails, \"err\", err)\n\t\tif fails >= maxFindnodeFailures {\n\t\t\tlog.Trace(\"Too many findnode failures, dropping\", \"id\", n.ID(), \"failcount\", fails)\n\t\t\ttab.delete(n)\n\t\t}\n\t} else if fails > 0 {\n\t\t//\n\t\ttab.db.UpdateFindFails(n.ID(), fails-1)\n\t}\n\n\t// node,revalidation\n\tfor _, n := range r {\n\t\ttab.add(n)\n\t}\n\t//\n\treply <- r\n}\n```\n\n\n\nrevalidationping\n\n\n\nindextargettargettarget\n\n: 16\n\n\n\n\n\n##### udp\n\nkadudptab.nettab.net.findnode\n\n```\nfunc (t *udp) findnode(toid enode.ID, toaddr *net.UDPAddr, target encPubkey) ([]*node, error) {\n   // If we haven't seen a ping from the destination node for a while, it won't remember\n   // our endpoint proof and reject findnode. Solicit a ping first.\n   if time.Since(t.db.LastPingReceived(toid)) > bondExpiration {\n      t.ping(toid, toaddr)\n      t.waitping(toid)\n   }\n\n   nodes := make([]*node, 0, bucketSize)\n   nreceived := 0\n   errc := t.pending(toid, neighborsPacket, func(r interface{}) bool {\n      reply := r.(*neighbors)\n      for _, rn := range reply.Nodes {\n         nreceived++\n         n, err := t.nodeFromRPC(toaddr, rn)\n         if err != nil {\n            log.Trace(\"Invalid neighbor node received\", \"ip\", rn.IP, \"addr\", toaddr, \"err\", err)\n            continue\n         }\n         nodes = append(nodes, n)\n      }\n      return nreceived >= bucketSize\n   })\n   t.send(toaddr, findnodePacket, &findnode{\n      Target:     target,\n      Expiration: uint64(time.Now().Add(expiration).Unix()),\n   })\n   return nodes, <-errc\n}\n```\n\nfindnodefindnodependingcallbackcallbackerrc`return nodes, <-errc`errccallbackget\n\n\n\nudp(ping - pong)(findnode - neighbors)\n","source":"_posts/eth-p2p-udp.md","raw":"---\ntitle: eth_p2p_udp\ncategories:\n  - eth\ndate: 2019-10-14 14:54:36\ntags:\n---\n\n## p2p-udp\n\np2pdiscoverudpkademlia\n\n\n\n#### kademlia\n\n[kad](http://www.yeolar.com/note/2010/03/21/kademlia/)\n\nkadIDIDK\n\nIDIDKKnKn-1IDn-1ID3K3ID110K0(0xx1(10x),2(11x)K0xx11x111ID\n\n\n\nKademlia  RPC PINGSTOREFIND_NODEFIND_VALUE\n\n\n\n#### kad\n\nkadkad\n\n\n\n```\nbucketSize      = 16 // Kademlia bucket size\n// We keep buckets for the upper 1/15 of distances because\n// it's very unlikely we'll ever encounter a node that's closer.\nhashBits          = len(common.Hash{}) * 8\nnBuckets          = hashBits / 15       // Number of buckets\nbucketMinDistance = hashBits - nBuckets // Log distance of closest bucket\n```\n\nknBucketsID256(hash32byte * 8bit/byte)/ 15\n\nkbucketSizek\n\nID()\n\n```\n//encPubkeyhash\nfunc (e encPubkey) id() enode.ID {\n\treturn enode.ID(crypto.Keccak256Hash(e[:]))\n}\n//pubkey -> encpubkey\nfunc encodePubkey(key *ecdsa.PublicKey) encPubkey {\n\tvar e encPubkey\n\tmath.ReadBits(key.X, e[:len(e)/2])\n\tmath.ReadBits(key.Y, e[len(e)/2:])\n\treturn e\n}\n```\n\n\n\n- \n\n```\ntype Table struct {\n\tmutex   sync.Mutex        // protects buckets, bucket content, nursery, rand\n\tbuckets [nBuckets]*bucket // index of known nodes by distance\n\t...\n}\n\n```\n\n```\n// bucket contains nodes, ordered by their last activity. the entry\n// that was most recently active is the first element in entries.\ntype bucket struct {\n   entries      []*node // live entries, sorted by time of last contact\n   replacements []*node // recently seen nodes to be used if revalidation fails\n   ips          netutil.DistinctNetSet\n}\n```\n\nbuckets(0<index<nBuckets)indexindexidentriesentriesrevalidationreplacements..\n\n\n\n```\n//b, b.entriesentriesreplacements\nfunc (tab *Table) add(n *node) {\n   if n.ID() == tab.self.ID() {\n      return\n   }\n   tab.mutex.Lock()\n   defer tab.mutex.Unlock()\n   b := tab.bucket(n.ID())\n   if !tab.bumpOrAdd(b, n) {\n      // Node is not in table. Add it to the replacement list.\n      tab.addReplacement(b, n)\n   }\n}\n\n//node\nfunc (tab *Table) delete(node *node) {\n\ttab.mutex.Lock()\n\tdefer tab.mutex.Unlock()\n\n\ttab.deleteInBucket(tab.bucket(node.ID()), node)\n}\n\n//targetnresults\nfunc (tab *Table) closest(target enode.ID, nresults int) *nodesByDistance {\n\t// This is a very wasteful way to find the closest nodes but\n\t// obviously correct. I believe that tree-based buckets would make\n\t// this easier to implement efficiently.\n\tclose := &nodesByDistance{target: target}\n\tfor _, b := range &tab.buckets {\n\t\tfor _, n := range b.entries {\n\t\t\tclose.push(n, nresults)\n\t\t}\n\t}\n\treturn close\n}\n\n```\n\n\n\n- \n\n```\nfunc (tab *Table) loop() {\n  ...\n  loop:\n\tfor {\n\t\tselect {\n\t\tcase <-refresh.C:  //\n\t\t\ttab.seedRand() //\n\t\t\tif refreshDone == nil {\n\t\t\t\trefreshDone = make(chan struct{})\n\t\t\t\tgo tab.doRefresh(refreshDone)  //refreshDone\n\t\t\t}\n\t\tcase req := <-tab.refreshReq: //req\n\t\t\twaiting = append(waiting, req)  //\n\t\t\tif refreshDone == nil {\n\t\t\t\trefreshDone = make(chan struct{})\n\t\t\t\tgo tab.doRefresh(refreshDone)\n\t\t\t}\n\t\tcase <-refreshDone:  //\n\t\t\tfor _, ch := range waiting {\n\t\t\t\tclose(ch)\n\t\t\t}\n\t\t\twaiting, refreshDone = nil, nil //waitingrefreshDone\n\t\tcase <-revalidate.C:\n\t\t\tgo tab.doRevalidate(revalidateDone)\n\t\tcase <-revalidateDone:\n\t\t\trevalidate.Reset(tab.nextRevalidateTime())\n\t\tcase <-copyNodes.C:\n\t\t\tgo tab.copyLiveNodes()\n\t\tcase <-tab.closeReq:\n\t\t\tbreak loop\n\t\t}\n\t}\n  ...\n}\n\n\n\n//\nfunc (tab *Table) doRefresh(done chan struct{}) {\n  defer close(done)\n  ...\n\n  //targetneighborsecp256k1v4nodesecp256k1v4ifloadkeynode\n  var key ecdsa.PublicKey\n  if err := tab.self.Load((*enode.Secp256k1)(&key)); err == nil {\n\ttab.lookup(encodePubkey(&key), false)\n  }\n\n\n  //targetneighborkadfindnode taget512bit,512bit? (findnode target64byte/512bit) sha3kadnodeIDhashhashID\n// The Kademlia paper specifies that the bucket refresh should\n// perform a lookup in the least recently used bucket. We cannot\n// adhere to this because the findnode target is a 512bit value\n// (not hash-sized) and it is not easily possible to generate a\n// sha3 preimage that falls into a chosen bucket.\n// We perform a few lookups with a random target instead.\n  for i := 0; i < 3; i++ {\n\t var target encPubkey\n\t crand.Read(target[:])\n\t tab.lookup(target, false)\n  }\n}\n\n```\n\n\n\n\n\n```\n//lookup\nfunc (tab *Table) lookup(targetKey encPubkey, refreshIfEmpty bool) []*node {\n\tvar (\n\t\ttarget         = enode.ID(crypto.Keccak256Hash(targetKey[:]))  //targetidhash\n\t\tasked          = make(map[enode.ID]bool)  //\n\t\tseen           = make(map[enode.ID]bool)  //\n\t\treply          = make(chan []*node, alpha) //alpha\n\t\tpendingQueries = 0   // \n\t\tresult         *nodesByDistance  //\n\t)\n\t//\n\tasked[tab.self.ID()] = true\n\n    //kresult\n\tfor {\n\t\ttab.mutex.Lock()\n\t\t//targetbucketSize\n\t\tresult = tab.closest(target, bucketSize)\n\t\ttab.mutex.Unlock()\n\t\t//refreshIfEmptyfalse\n\t\tif len(result.entries) > 0 || !refreshIfEmpty {\n\t\t\tbreak\n\t\t}\n\t\t//k(doRefresh -> ..)\n\t\t<-tab.refresh()\n\t\t//refreshIfEmptyfalse,for\n\t\trefreshIfEmpty = false\n\t}\n\n\n\tfor {\n\t\t//<alpha,alphafor..pendingQueries++foralphareplyresult\n\t\tfor i := 0; i < len(result.entries) && pendingQueries < alpha; i++ {\n\t\t\tn := result.entries[i]\n\t\t\tif !asked[n.ID()] {\n\t\t\t\tasked[n.ID()] = true\n\t\t\t\tpendingQueries++\n\t\t\t\t//ntargetKey\n\t\t\t\tgo tab.findnode(n, targetKey, reply)\n\t\t\t}\n\t\t}\n\t\t//\n\t\tif pendingQueries == 0 {\n\t\t\t// we have asked all closest nodes, stop the search\n\t\t\tbreak\n\t\t}\n\n\t\t//<-replyreplyrange\n\t\t// wait for the next reply\n\t\tfor _, n := range <-reply {\n\t\t\tif n != nil && !seen[n.ID()] {\n\t\t\t\tseen[n.ID()] = true\n\t\t\t\t//result.pushresultbucketSizetarget..\n\t\t\t\tresult.push(n, bucketSize)\n\t\t\t}\n\t\t}\n\t\t//pendingQueries\n\t\tpendingQueries--\n\t}\n\n\treturn result.entries\n}\n```\n\n\n\n```\n//findnode\nfunc (tab *Table) findnode(n *node, targetKey encPubkey, reply chan<- []*node) {\n\t//dbn(n)\n\tfails := tab.db.FindFails(n.ID())\n\t//n\n\tr, err := tab.net.findnode(n.ID(), n.addr(), targetKey)\n\n\t//..tab.net.findnode..\n\t//0fails++dbfailstab\n\tif err != nil || len(r) == 0 {\n\t\tfails++\n\t\ttab.db.UpdateFindFails(n.ID(), fails)\n\t\tlog.Trace(\"Findnode failed\", \"id\", n.ID(), \"failcount\", fails, \"err\", err)\n\t\tif fails >= maxFindnodeFailures {\n\t\t\tlog.Trace(\"Too many findnode failures, dropping\", \"id\", n.ID(), \"failcount\", fails)\n\t\t\ttab.delete(n)\n\t\t}\n\t} else if fails > 0 {\n\t\t//\n\t\ttab.db.UpdateFindFails(n.ID(), fails-1)\n\t}\n\n\t// node,revalidation\n\tfor _, n := range r {\n\t\ttab.add(n)\n\t}\n\t//\n\treply <- r\n}\n```\n\n\n\nrevalidationping\n\n\n\nindextargettargettarget\n\n: 16\n\n\n\n\n\n##### udp\n\nkadudptab.nettab.net.findnode\n\n```\nfunc (t *udp) findnode(toid enode.ID, toaddr *net.UDPAddr, target encPubkey) ([]*node, error) {\n   // If we haven't seen a ping from the destination node for a while, it won't remember\n   // our endpoint proof and reject findnode. Solicit a ping first.\n   if time.Since(t.db.LastPingReceived(toid)) > bondExpiration {\n      t.ping(toid, toaddr)\n      t.waitping(toid)\n   }\n\n   nodes := make([]*node, 0, bucketSize)\n   nreceived := 0\n   errc := t.pending(toid, neighborsPacket, func(r interface{}) bool {\n      reply := r.(*neighbors)\n      for _, rn := range reply.Nodes {\n         nreceived++\n         n, err := t.nodeFromRPC(toaddr, rn)\n         if err != nil {\n            log.Trace(\"Invalid neighbor node received\", \"ip\", rn.IP, \"addr\", toaddr, \"err\", err)\n            continue\n         }\n         nodes = append(nodes, n)\n      }\n      return nreceived >= bucketSize\n   })\n   t.send(toaddr, findnodePacket, &findnode{\n      Target:     target,\n      Expiration: uint64(time.Now().Add(expiration).Unix()),\n   })\n   return nodes, <-errc\n}\n```\n\nfindnodefindnodependingcallbackcallbackerrc`return nodes, <-errc`errccallbackget\n\n\n\nudp(ping - pong)(findnode - neighbors)\n","slug":"eth-p2p-udp","published":1,"updated":"2019-10-14T06:54:45.669Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69x20028t6xvp0zgpc2l","content":"<h2 id=\"p2p-udp\"><a href=\"#p2p-udp\" class=\"headerlink\" title=\"p2p-udp\"></a>p2p-udp</h2><p>p2pdiscoverudpkademlia</p>\n<h4 id=\"kademlia\"><a href=\"#kademlia\" class=\"headerlink\" title=\"kademlia\"></a>kademlia</h4><p><a href=\"http://www.yeolar.com/note/2010/03/21/kademlia/\" target=\"_blank\" rel=\"noopener\">kad</a></p>\n<p>kadIDIDK</p>\n<p>IDIDKKnKn-1IDn-1ID3K3ID110K0(0xx1(10x),2(11x)K0xx11x111ID</p>\n<p>Kademlia  RPC PINGSTOREFIND_NODEFIND_VALUE</p>\n<h4 id=\"kad\"><a href=\"#kad\" class=\"headerlink\" title=\"kad\"></a>kad</h4><p>kadkad</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bucketSize      = 16 // Kademlia bucket size</span><br><span class=\"line\">// We keep buckets for the upper 1/15 of distances because</span><br><span class=\"line\">// it&apos;s very unlikely we&apos;ll ever encounter a node that&apos;s closer.</span><br><span class=\"line\">hashBits          = len(common.Hash&#123;&#125;) * 8</span><br><span class=\"line\">nBuckets          = hashBits / 15       // Number of buckets</span><br><span class=\"line\">bucketMinDistance = hashBits - nBuckets // Log distance of closest bucket</span><br></pre></td></tr></table></figure>\n\n<p>knBucketsID256(hash32byte * 8bit/byte)/ 15</p>\n<p>kbucketSizek</p>\n<p>ID()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//encPubkeyhash</span><br><span class=\"line\">func (e encPubkey) id() enode.ID &#123;</span><br><span class=\"line\">\treturn enode.ID(crypto.Keccak256Hash(e[:]))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//pubkey -&gt; encpubkey</span><br><span class=\"line\">func encodePubkey(key *ecdsa.PublicKey) encPubkey &#123;</span><br><span class=\"line\">\tvar e encPubkey</span><br><span class=\"line\">\tmath.ReadBits(key.X, e[:len(e)/2])</span><br><span class=\"line\">\tmath.ReadBits(key.Y, e[len(e)/2:])</span><br><span class=\"line\">\treturn e</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Table struct &#123;</span><br><span class=\"line\">\tmutex   sync.Mutex        // protects buckets, bucket content, nursery, rand</span><br><span class=\"line\">\tbuckets [nBuckets]*bucket // index of known nodes by distance</span><br><span class=\"line\">\t...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// bucket contains nodes, ordered by their last activity. the entry</span><br><span class=\"line\">// that was most recently active is the first element in entries.</span><br><span class=\"line\">type bucket struct &#123;</span><br><span class=\"line\">   entries      []*node // live entries, sorted by time of last contact</span><br><span class=\"line\">   replacements []*node // recently seen nodes to be used if revalidation fails</span><br><span class=\"line\">   ips          netutil.DistinctNetSet</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>buckets(0&lt;index&lt;nBuckets)indexindexidentriesentriesrevalidationreplacements..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//b, b.entriesentriesreplacements</span><br><span class=\"line\">func (tab *Table) add(n *node) &#123;</span><br><span class=\"line\">   if n.ID() == tab.self.ID() &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   tab.mutex.Lock()</span><br><span class=\"line\">   defer tab.mutex.Unlock()</span><br><span class=\"line\">   b := tab.bucket(n.ID())</span><br><span class=\"line\">   if !tab.bumpOrAdd(b, n) &#123;</span><br><span class=\"line\">      // Node is not in table. Add it to the replacement list.</span><br><span class=\"line\">      tab.addReplacement(b, n)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//node</span><br><span class=\"line\">func (tab *Table) delete(node *node) &#123;</span><br><span class=\"line\">\ttab.mutex.Lock()</span><br><span class=\"line\">\tdefer tab.mutex.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\ttab.deleteInBucket(tab.bucket(node.ID()), node)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//targetnresults</span><br><span class=\"line\">func (tab *Table) closest(target enode.ID, nresults int) *nodesByDistance &#123;</span><br><span class=\"line\">\t// This is a very wasteful way to find the closest nodes but</span><br><span class=\"line\">\t// obviously correct. I believe that tree-based buckets would make</span><br><span class=\"line\">\t// this easier to implement efficiently.</span><br><span class=\"line\">\tclose := &amp;nodesByDistance&#123;target: target&#125;</span><br><span class=\"line\">\tfor _, b := range &amp;tab.buckets &#123;</span><br><span class=\"line\">\t\tfor _, n := range b.entries &#123;</span><br><span class=\"line\">\t\t\tclose.push(n, nresults)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn close</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (tab *Table) loop() &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  loop:</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-refresh.C:  //</span><br><span class=\"line\">\t\t\ttab.seedRand() //</span><br><span class=\"line\">\t\t\tif refreshDone == nil &#123;</span><br><span class=\"line\">\t\t\t\trefreshDone = make(chan struct&#123;&#125;)</span><br><span class=\"line\">\t\t\t\tgo tab.doRefresh(refreshDone)  //refreshDone</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\tcase req := &lt;-tab.refreshReq: //req</span><br><span class=\"line\">\t\t\twaiting = append(waiting, req)  //</span><br><span class=\"line\">\t\t\tif refreshDone == nil &#123;</span><br><span class=\"line\">\t\t\t\trefreshDone = make(chan struct&#123;&#125;)</span><br><span class=\"line\">\t\t\t\tgo tab.doRefresh(refreshDone)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\tcase &lt;-refreshDone:  //</span><br><span class=\"line\">\t\t\tfor _, ch := range waiting &#123;</span><br><span class=\"line\">\t\t\t\tclose(ch)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\twaiting, refreshDone = nil, nil //waitingrefreshDone</span><br><span class=\"line\">\t\tcase &lt;-revalidate.C:</span><br><span class=\"line\">\t\t\tgo tab.doRevalidate(revalidateDone)</span><br><span class=\"line\">\t\tcase &lt;-revalidateDone:</span><br><span class=\"line\">\t\t\trevalidate.Reset(tab.nextRevalidateTime())</span><br><span class=\"line\">\t\tcase &lt;-copyNodes.C:</span><br><span class=\"line\">\t\t\tgo tab.copyLiveNodes()</span><br><span class=\"line\">\t\tcase &lt;-tab.closeReq:</span><br><span class=\"line\">\t\t\tbreak loop</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">func (tab *Table) doRefresh(done chan struct&#123;&#125;) &#123;</span><br><span class=\"line\">  defer close(done)</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  //targetneighborsecp256k1v4nodesecp256k1v4ifloadkeynode</span><br><span class=\"line\">  var key ecdsa.PublicKey</span><br><span class=\"line\">  if err := tab.self.Load((*enode.Secp256k1)(&amp;key)); err == nil &#123;</span><br><span class=\"line\">\ttab.lookup(encodePubkey(&amp;key), false)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  //targetneighborkadfindnode taget512bit,512bit? (findnode target64byte/512bit) sha3kadnodeIDhashhashID</span><br><span class=\"line\">// The Kademlia paper specifies that the bucket refresh should</span><br><span class=\"line\">// perform a lookup in the least recently used bucket. We cannot</span><br><span class=\"line\">// adhere to this because the findnode target is a 512bit value</span><br><span class=\"line\">// (not hash-sized) and it is not easily possible to generate a</span><br><span class=\"line\">// sha3 preimage that falls into a chosen bucket.</span><br><span class=\"line\">// We perform a few lookups with a random target instead.</span><br><span class=\"line\">  for i := 0; i &lt; 3; i++ &#123;</span><br><span class=\"line\">\t var target encPubkey</span><br><span class=\"line\">\t crand.Read(target[:])</span><br><span class=\"line\">\t tab.lookup(target, false)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//lookup</span><br><span class=\"line\">func (tab *Table) lookup(targetKey encPubkey, refreshIfEmpty bool) []*node &#123;</span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\ttarget         = enode.ID(crypto.Keccak256Hash(targetKey[:]))  //targetidhash</span><br><span class=\"line\">\t\tasked          = make(map[enode.ID]bool)  //</span><br><span class=\"line\">\t\tseen           = make(map[enode.ID]bool)  //</span><br><span class=\"line\">\t\treply          = make(chan []*node, alpha) //alpha</span><br><span class=\"line\">\t\tpendingQueries = 0   // </span><br><span class=\"line\">\t\tresult         *nodesByDistance  //</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t//</span><br><span class=\"line\">\tasked[tab.self.ID()] = true</span><br><span class=\"line\"></span><br><span class=\"line\">    //kresult</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\ttab.mutex.Lock()</span><br><span class=\"line\">\t\t//targetbucketSize</span><br><span class=\"line\">\t\tresult = tab.closest(target, bucketSize)</span><br><span class=\"line\">\t\ttab.mutex.Unlock()</span><br><span class=\"line\">\t\t//refreshIfEmptyfalse</span><br><span class=\"line\">\t\tif len(result.entries) &gt; 0 || !refreshIfEmpty &#123;</span><br><span class=\"line\">\t\t\tbreak</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//k(doRefresh -&gt; ..)</span><br><span class=\"line\">\t\t&lt;-tab.refresh()</span><br><span class=\"line\">\t\t//refreshIfEmptyfalse,for</span><br><span class=\"line\">\t\trefreshIfEmpty = false</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\t//&lt;alpha,alphafor..pendingQueries++foralphareplyresult</span><br><span class=\"line\">\t\tfor i := 0; i &lt; len(result.entries) &amp;&amp; pendingQueries &lt; alpha; i++ &#123;</span><br><span class=\"line\">\t\t\tn := result.entries[i]</span><br><span class=\"line\">\t\t\tif !asked[n.ID()] &#123;</span><br><span class=\"line\">\t\t\t\tasked[n.ID()] = true</span><br><span class=\"line\">\t\t\t\tpendingQueries++</span><br><span class=\"line\">\t\t\t\t//ntargetKey</span><br><span class=\"line\">\t\t\t\tgo tab.findnode(n, targetKey, reply)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//</span><br><span class=\"line\">\t\tif pendingQueries == 0 &#123;</span><br><span class=\"line\">\t\t\t// we have asked all closest nodes, stop the search</span><br><span class=\"line\">\t\t\tbreak</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t//&lt;-replyreplyrange</span><br><span class=\"line\">\t\t// wait for the next reply</span><br><span class=\"line\">\t\tfor _, n := range &lt;-reply &#123;</span><br><span class=\"line\">\t\t\tif n != nil &amp;&amp; !seen[n.ID()] &#123;</span><br><span class=\"line\">\t\t\t\tseen[n.ID()] = true</span><br><span class=\"line\">\t\t\t\t//result.pushresultbucketSizetarget..</span><br><span class=\"line\">\t\t\t\tresult.push(n, bucketSize)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//pendingQueries</span><br><span class=\"line\">\t\tpendingQueries--</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn result.entries</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//findnode</span><br><span class=\"line\">func (tab *Table) findnode(n *node, targetKey encPubkey, reply chan&lt;- []*node) &#123;</span><br><span class=\"line\">\t//dbn(n)</span><br><span class=\"line\">\tfails := tab.db.FindFails(n.ID())</span><br><span class=\"line\">\t//n</span><br><span class=\"line\">\tr, err := tab.net.findnode(n.ID(), n.addr(), targetKey)</span><br><span class=\"line\"></span><br><span class=\"line\">\t//..tab.net.findnode..</span><br><span class=\"line\">\t//0fails++dbfailstab</span><br><span class=\"line\">\tif err != nil || len(r) == 0 &#123;</span><br><span class=\"line\">\t\tfails++</span><br><span class=\"line\">\t\ttab.db.UpdateFindFails(n.ID(), fails)</span><br><span class=\"line\">\t\tlog.Trace(&quot;Findnode failed&quot;, &quot;id&quot;, n.ID(), &quot;failcount&quot;, fails, &quot;err&quot;, err)</span><br><span class=\"line\">\t\tif fails &gt;= maxFindnodeFailures &#123;</span><br><span class=\"line\">\t\t\tlog.Trace(&quot;Too many findnode failures, dropping&quot;, &quot;id&quot;, n.ID(), &quot;failcount&quot;, fails)</span><br><span class=\"line\">\t\t\ttab.delete(n)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; else if fails &gt; 0 &#123;</span><br><span class=\"line\">\t\t//</span><br><span class=\"line\">\t\ttab.db.UpdateFindFails(n.ID(), fails-1)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// node,revalidation</span><br><span class=\"line\">\tfor _, n := range r &#123;</span><br><span class=\"line\">\t\ttab.add(n)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t//</span><br><span class=\"line\">\treply &lt;- r</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>revalidationping</p>\n<p>indextargettargettarget</p>\n<p>: 16</p>\n<h5 id=\"udp\"><a href=\"#udp\" class=\"headerlink\" title=\"udp\"></a>udp</h5><p>kadudptab.nettab.net.findnode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (t *udp) findnode(toid enode.ID, toaddr *net.UDPAddr, target encPubkey) ([]*node, error) &#123;</span><br><span class=\"line\">   // If we haven&apos;t seen a ping from the destination node for a while, it won&apos;t remember</span><br><span class=\"line\">   // our endpoint proof and reject findnode. Solicit a ping first.</span><br><span class=\"line\">   if time.Since(t.db.LastPingReceived(toid)) &gt; bondExpiration &#123;</span><br><span class=\"line\">      t.ping(toid, toaddr)</span><br><span class=\"line\">      t.waitping(toid)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   nodes := make([]*node, 0, bucketSize)</span><br><span class=\"line\">   nreceived := 0</span><br><span class=\"line\">   errc := t.pending(toid, neighborsPacket, func(r interface&#123;&#125;) bool &#123;</span><br><span class=\"line\">      reply := r.(*neighbors)</span><br><span class=\"line\">      for _, rn := range reply.Nodes &#123;</span><br><span class=\"line\">         nreceived++</span><br><span class=\"line\">         n, err := t.nodeFromRPC(toaddr, rn)</span><br><span class=\"line\">         if err != nil &#123;</span><br><span class=\"line\">            log.Trace(&quot;Invalid neighbor node received&quot;, &quot;ip&quot;, rn.IP, &quot;addr&quot;, toaddr, &quot;err&quot;, err)</span><br><span class=\"line\">            continue</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         nodes = append(nodes, n)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      return nreceived &gt;= bucketSize</span><br><span class=\"line\">   &#125;)</span><br><span class=\"line\">   t.send(toaddr, findnodePacket, &amp;findnode&#123;</span><br><span class=\"line\">      Target:     target,</span><br><span class=\"line\">      Expiration: uint64(time.Now().Add(expiration).Unix()),</span><br><span class=\"line\">   &#125;)</span><br><span class=\"line\">   return nodes, &lt;-errc</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>findnodefindnodependingcallbackcallbackerrc<code>return nodes, &lt;-errc</code>errccallbackget</p>\n<p>udp(ping - pong)(findnode - neighbors)</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"p2p-udp\"><a href=\"#p2p-udp\" class=\"headerlink\" title=\"p2p-udp\"></a>p2p-udp</h2><p>p2pdiscoverudpkademlia</p>\n<h4 id=\"kademlia\"><a href=\"#kademlia\" class=\"headerlink\" title=\"kademlia\"></a>kademlia</h4><p><a href=\"http://www.yeolar.com/note/2010/03/21/kademlia/\" target=\"_blank\" rel=\"noopener\">kad</a></p>\n<p>kadIDIDK</p>\n<p>IDIDKKnKn-1IDn-1ID3K3ID110K0(0xx1(10x),2(11x)K0xx11x111ID</p>\n<p>Kademlia  RPC PINGSTOREFIND_NODEFIND_VALUE</p>\n<h4 id=\"kad\"><a href=\"#kad\" class=\"headerlink\" title=\"kad\"></a>kad</h4><p>kadkad</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bucketSize      = 16 // Kademlia bucket size</span><br><span class=\"line\">// We keep buckets for the upper 1/15 of distances because</span><br><span class=\"line\">// it&apos;s very unlikely we&apos;ll ever encounter a node that&apos;s closer.</span><br><span class=\"line\">hashBits          = len(common.Hash&#123;&#125;) * 8</span><br><span class=\"line\">nBuckets          = hashBits / 15       // Number of buckets</span><br><span class=\"line\">bucketMinDistance = hashBits - nBuckets // Log distance of closest bucket</span><br></pre></td></tr></table></figure>\n\n<p>knBucketsID256(hash32byte * 8bit/byte)/ 15</p>\n<p>kbucketSizek</p>\n<p>ID()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//encPubkeyhash</span><br><span class=\"line\">func (e encPubkey) id() enode.ID &#123;</span><br><span class=\"line\">\treturn enode.ID(crypto.Keccak256Hash(e[:]))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//pubkey -&gt; encpubkey</span><br><span class=\"line\">func encodePubkey(key *ecdsa.PublicKey) encPubkey &#123;</span><br><span class=\"line\">\tvar e encPubkey</span><br><span class=\"line\">\tmath.ReadBits(key.X, e[:len(e)/2])</span><br><span class=\"line\">\tmath.ReadBits(key.Y, e[len(e)/2:])</span><br><span class=\"line\">\treturn e</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Table struct &#123;</span><br><span class=\"line\">\tmutex   sync.Mutex        // protects buckets, bucket content, nursery, rand</span><br><span class=\"line\">\tbuckets [nBuckets]*bucket // index of known nodes by distance</span><br><span class=\"line\">\t...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// bucket contains nodes, ordered by their last activity. the entry</span><br><span class=\"line\">// that was most recently active is the first element in entries.</span><br><span class=\"line\">type bucket struct &#123;</span><br><span class=\"line\">   entries      []*node // live entries, sorted by time of last contact</span><br><span class=\"line\">   replacements []*node // recently seen nodes to be used if revalidation fails</span><br><span class=\"line\">   ips          netutil.DistinctNetSet</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>buckets(0&lt;index&lt;nBuckets)indexindexidentriesentriesrevalidationreplacements..</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//b, b.entriesentriesreplacements</span><br><span class=\"line\">func (tab *Table) add(n *node) &#123;</span><br><span class=\"line\">   if n.ID() == tab.self.ID() &#123;</span><br><span class=\"line\">      return</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   tab.mutex.Lock()</span><br><span class=\"line\">   defer tab.mutex.Unlock()</span><br><span class=\"line\">   b := tab.bucket(n.ID())</span><br><span class=\"line\">   if !tab.bumpOrAdd(b, n) &#123;</span><br><span class=\"line\">      // Node is not in table. Add it to the replacement list.</span><br><span class=\"line\">      tab.addReplacement(b, n)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//node</span><br><span class=\"line\">func (tab *Table) delete(node *node) &#123;</span><br><span class=\"line\">\ttab.mutex.Lock()</span><br><span class=\"line\">\tdefer tab.mutex.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">\ttab.deleteInBucket(tab.bucket(node.ID()), node)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//targetnresults</span><br><span class=\"line\">func (tab *Table) closest(target enode.ID, nresults int) *nodesByDistance &#123;</span><br><span class=\"line\">\t// This is a very wasteful way to find the closest nodes but</span><br><span class=\"line\">\t// obviously correct. I believe that tree-based buckets would make</span><br><span class=\"line\">\t// this easier to implement efficiently.</span><br><span class=\"line\">\tclose := &amp;nodesByDistance&#123;target: target&#125;</span><br><span class=\"line\">\tfor _, b := range &amp;tab.buckets &#123;</span><br><span class=\"line\">\t\tfor _, n := range b.entries &#123;</span><br><span class=\"line\">\t\t\tclose.push(n, nresults)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn close</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (tab *Table) loop() &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  loop:</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\tselect &#123;</span><br><span class=\"line\">\t\tcase &lt;-refresh.C:  //</span><br><span class=\"line\">\t\t\ttab.seedRand() //</span><br><span class=\"line\">\t\t\tif refreshDone == nil &#123;</span><br><span class=\"line\">\t\t\t\trefreshDone = make(chan struct&#123;&#125;)</span><br><span class=\"line\">\t\t\t\tgo tab.doRefresh(refreshDone)  //refreshDone</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\tcase req := &lt;-tab.refreshReq: //req</span><br><span class=\"line\">\t\t\twaiting = append(waiting, req)  //</span><br><span class=\"line\">\t\t\tif refreshDone == nil &#123;</span><br><span class=\"line\">\t\t\t\trefreshDone = make(chan struct&#123;&#125;)</span><br><span class=\"line\">\t\t\t\tgo tab.doRefresh(refreshDone)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\tcase &lt;-refreshDone:  //</span><br><span class=\"line\">\t\t\tfor _, ch := range waiting &#123;</span><br><span class=\"line\">\t\t\t\tclose(ch)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\twaiting, refreshDone = nil, nil //waitingrefreshDone</span><br><span class=\"line\">\t\tcase &lt;-revalidate.C:</span><br><span class=\"line\">\t\t\tgo tab.doRevalidate(revalidateDone)</span><br><span class=\"line\">\t\tcase &lt;-revalidateDone:</span><br><span class=\"line\">\t\t\trevalidate.Reset(tab.nextRevalidateTime())</span><br><span class=\"line\">\t\tcase &lt;-copyNodes.C:</span><br><span class=\"line\">\t\t\tgo tab.copyLiveNodes()</span><br><span class=\"line\">\t\tcase &lt;-tab.closeReq:</span><br><span class=\"line\">\t\t\tbreak loop</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">func (tab *Table) doRefresh(done chan struct&#123;&#125;) &#123;</span><br><span class=\"line\">  defer close(done)</span><br><span class=\"line\">  ...</span><br><span class=\"line\"></span><br><span class=\"line\">  //targetneighborsecp256k1v4nodesecp256k1v4ifloadkeynode</span><br><span class=\"line\">  var key ecdsa.PublicKey</span><br><span class=\"line\">  if err := tab.self.Load((*enode.Secp256k1)(&amp;key)); err == nil &#123;</span><br><span class=\"line\">\ttab.lookup(encodePubkey(&amp;key), false)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  //targetneighborkadfindnode taget512bit,512bit? (findnode target64byte/512bit) sha3kadnodeIDhashhashID</span><br><span class=\"line\">// The Kademlia paper specifies that the bucket refresh should</span><br><span class=\"line\">// perform a lookup in the least recently used bucket. We cannot</span><br><span class=\"line\">// adhere to this because the findnode target is a 512bit value</span><br><span class=\"line\">// (not hash-sized) and it is not easily possible to generate a</span><br><span class=\"line\">// sha3 preimage that falls into a chosen bucket.</span><br><span class=\"line\">// We perform a few lookups with a random target instead.</span><br><span class=\"line\">  for i := 0; i &lt; 3; i++ &#123;</span><br><span class=\"line\">\t var target encPubkey</span><br><span class=\"line\">\t crand.Read(target[:])</span><br><span class=\"line\">\t tab.lookup(target, false)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//lookup</span><br><span class=\"line\">func (tab *Table) lookup(targetKey encPubkey, refreshIfEmpty bool) []*node &#123;</span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\ttarget         = enode.ID(crypto.Keccak256Hash(targetKey[:]))  //targetidhash</span><br><span class=\"line\">\t\tasked          = make(map[enode.ID]bool)  //</span><br><span class=\"line\">\t\tseen           = make(map[enode.ID]bool)  //</span><br><span class=\"line\">\t\treply          = make(chan []*node, alpha) //alpha</span><br><span class=\"line\">\t\tpendingQueries = 0   // </span><br><span class=\"line\">\t\tresult         *nodesByDistance  //</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t//</span><br><span class=\"line\">\tasked[tab.self.ID()] = true</span><br><span class=\"line\"></span><br><span class=\"line\">    //kresult</span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\ttab.mutex.Lock()</span><br><span class=\"line\">\t\t//targetbucketSize</span><br><span class=\"line\">\t\tresult = tab.closest(target, bucketSize)</span><br><span class=\"line\">\t\ttab.mutex.Unlock()</span><br><span class=\"line\">\t\t//refreshIfEmptyfalse</span><br><span class=\"line\">\t\tif len(result.entries) &gt; 0 || !refreshIfEmpty &#123;</span><br><span class=\"line\">\t\t\tbreak</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//k(doRefresh -&gt; ..)</span><br><span class=\"line\">\t\t&lt;-tab.refresh()</span><br><span class=\"line\">\t\t//refreshIfEmptyfalse,for</span><br><span class=\"line\">\t\trefreshIfEmpty = false</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\tfor &#123;</span><br><span class=\"line\">\t\t//&lt;alpha,alphafor..pendingQueries++foralphareplyresult</span><br><span class=\"line\">\t\tfor i := 0; i &lt; len(result.entries) &amp;&amp; pendingQueries &lt; alpha; i++ &#123;</span><br><span class=\"line\">\t\t\tn := result.entries[i]</span><br><span class=\"line\">\t\t\tif !asked[n.ID()] &#123;</span><br><span class=\"line\">\t\t\t\tasked[n.ID()] = true</span><br><span class=\"line\">\t\t\t\tpendingQueries++</span><br><span class=\"line\">\t\t\t\t//ntargetKey</span><br><span class=\"line\">\t\t\t\tgo tab.findnode(n, targetKey, reply)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//</span><br><span class=\"line\">\t\tif pendingQueries == 0 &#123;</span><br><span class=\"line\">\t\t\t// we have asked all closest nodes, stop the search</span><br><span class=\"line\">\t\t\tbreak</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t//&lt;-replyreplyrange</span><br><span class=\"line\">\t\t// wait for the next reply</span><br><span class=\"line\">\t\tfor _, n := range &lt;-reply &#123;</span><br><span class=\"line\">\t\t\tif n != nil &amp;&amp; !seen[n.ID()] &#123;</span><br><span class=\"line\">\t\t\t\tseen[n.ID()] = true</span><br><span class=\"line\">\t\t\t\t//result.pushresultbucketSizetarget..</span><br><span class=\"line\">\t\t\t\tresult.push(n, bucketSize)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t//pendingQueries</span><br><span class=\"line\">\t\tpendingQueries--</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn result.entries</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//findnode</span><br><span class=\"line\">func (tab *Table) findnode(n *node, targetKey encPubkey, reply chan&lt;- []*node) &#123;</span><br><span class=\"line\">\t//dbn(n)</span><br><span class=\"line\">\tfails := tab.db.FindFails(n.ID())</span><br><span class=\"line\">\t//n</span><br><span class=\"line\">\tr, err := tab.net.findnode(n.ID(), n.addr(), targetKey)</span><br><span class=\"line\"></span><br><span class=\"line\">\t//..tab.net.findnode..</span><br><span class=\"line\">\t//0fails++dbfailstab</span><br><span class=\"line\">\tif err != nil || len(r) == 0 &#123;</span><br><span class=\"line\">\t\tfails++</span><br><span class=\"line\">\t\ttab.db.UpdateFindFails(n.ID(), fails)</span><br><span class=\"line\">\t\tlog.Trace(&quot;Findnode failed&quot;, &quot;id&quot;, n.ID(), &quot;failcount&quot;, fails, &quot;err&quot;, err)</span><br><span class=\"line\">\t\tif fails &gt;= maxFindnodeFailures &#123;</span><br><span class=\"line\">\t\t\tlog.Trace(&quot;Too many findnode failures, dropping&quot;, &quot;id&quot;, n.ID(), &quot;failcount&quot;, fails)</span><br><span class=\"line\">\t\t\ttab.delete(n)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; else if fails &gt; 0 &#123;</span><br><span class=\"line\">\t\t//</span><br><span class=\"line\">\t\ttab.db.UpdateFindFails(n.ID(), fails-1)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// node,revalidation</span><br><span class=\"line\">\tfor _, n := range r &#123;</span><br><span class=\"line\">\t\ttab.add(n)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t//</span><br><span class=\"line\">\treply &lt;- r</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>revalidationping</p>\n<p>indextargettargettarget</p>\n<p>: 16</p>\n<h5 id=\"udp\"><a href=\"#udp\" class=\"headerlink\" title=\"udp\"></a>udp</h5><p>kadudptab.nettab.net.findnode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (t *udp) findnode(toid enode.ID, toaddr *net.UDPAddr, target encPubkey) ([]*node, error) &#123;</span><br><span class=\"line\">   // If we haven&apos;t seen a ping from the destination node for a while, it won&apos;t remember</span><br><span class=\"line\">   // our endpoint proof and reject findnode. Solicit a ping first.</span><br><span class=\"line\">   if time.Since(t.db.LastPingReceived(toid)) &gt; bondExpiration &#123;</span><br><span class=\"line\">      t.ping(toid, toaddr)</span><br><span class=\"line\">      t.waitping(toid)</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   nodes := make([]*node, 0, bucketSize)</span><br><span class=\"line\">   nreceived := 0</span><br><span class=\"line\">   errc := t.pending(toid, neighborsPacket, func(r interface&#123;&#125;) bool &#123;</span><br><span class=\"line\">      reply := r.(*neighbors)</span><br><span class=\"line\">      for _, rn := range reply.Nodes &#123;</span><br><span class=\"line\">         nreceived++</span><br><span class=\"line\">         n, err := t.nodeFromRPC(toaddr, rn)</span><br><span class=\"line\">         if err != nil &#123;</span><br><span class=\"line\">            log.Trace(&quot;Invalid neighbor node received&quot;, &quot;ip&quot;, rn.IP, &quot;addr&quot;, toaddr, &quot;err&quot;, err)</span><br><span class=\"line\">            continue</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         nodes = append(nodes, n)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      return nreceived &gt;= bucketSize</span><br><span class=\"line\">   &#125;)</span><br><span class=\"line\">   t.send(toaddr, findnodePacket, &amp;findnode&#123;</span><br><span class=\"line\">      Target:     target,</span><br><span class=\"line\">      Expiration: uint64(time.Now().Add(expiration).Unix()),</span><br><span class=\"line\">   &#125;)</span><br><span class=\"line\">   return nodes, &lt;-errc</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>findnodefindnodependingcallbackcallbackerrc<code>return nodes, &lt;-errc</code>errccallbackget</p>\n<p>udp(ping - pong)(findnode - neighbors)</p>\n"},{"title":"eth_rlp","date":"2019-10-14T06:48:31.000Z","_content":"####  RLP\n\n#### \n\njson\n\n```\ntype Student struct{\n    Name string `json:\"name\"`\n    Sex string `json:\"sex\"`\n}\ns := Student{Name:\"icattlecoder\",Sex:\"male\"}\nbs,_ := json.Marsal(&s)\n\n```\n\n`{\"name\":\"icattlecoder\",\"sex\":\"male\"}`,icattlecodermale16json RLP\n\n\n\n> RLPRecursive Length PrefixRLP\n\n\n\nRLP\n\n- byte\n- byte\n\n**1**[0, 127]\n\n1`a``97`\n\n**2**byte`l <= 55``128+l`\n\n2`128``128 = 128 + 0`\n\n3`abc``131 97 98 99``131=128+len(\"abc\")``97 98 99``a b c`\n\n**3**55 183byte\n\n55183+ ****\n\n\n\n```\nThe length of this sentence is more than 55 bytes, I know it because I pre-designed it\n```\n\n8686\n\n```\n184 86 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110 116101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101 11544 32 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114 101 45 100101 115 105 103 110 101 100 32 105 116\n```\n\n\n\n1. `184 = 183 + 1``86`\n2. `86``86`\n3. `84``T`\n\n\n\n1024\"a\"`185 4 0 97 97 97 97 97 97 ...`\n1024 big endian`004 0`2`185 = 183 + 2`\n\n1~3byte****\n\n\n\n**4**55192\n\n4\n6`[\"abc\", \"def\"]``200 131 97 98 99 131 100 101 102`\n`abc``131 97 98 99`,`def``131 100 101 102`8`192 + 8 = 200`\n\n\n\n**5**55247\n\n53\n\n7\n\n```\n[\"The length of this sentence is more than 55 bytes, \", \"I know it because I pre-designed it\"]\n```\n\n:\n\n```\n248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116\n```\n\n\n\n1. `248 = 247 +1`\n2. `88 = 86 + 2`**3**`86`12\n   3`179`**2**`179 = 128 + 51`\n\n55`163`**2**`163 = 128 + 35`\n\n\n\n8****\n\n```\n[\"abc\",[\"The length of this sentence is more than 55 bytes, \", \"I know it because I pre-designed it\"]]\n```\n\n\n\n```\n248 94 131 97 98 99 248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105115 32 115 101 110 116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 5332 98 121 116 101 115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 10132 73 32 112 114 101 45 100 101 115 105 103 110 101 100 32 105 116\n```\n\n`abc`**2**`131 97 98 99`,4\n\n\n```\n[\"The length of this sentence is more than 55 bytes, \", \"I know it because I pre-designed it\"]\n```\n\n**5**\n\n```\n248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116\n```\n\n90`90 + 4 = 94`, 1`247 + 1 = 248`\n\n5RPL\n\n\n\n#### \n\n`f`\n\n1. f [0,128),\n2. f[128,184)55byte `l=f-128`\n3. f[184,192)55`ll=f-183`,llbytesBigEndianll\n4. f(192,247]55`l=f-192`1~4\n5. f(247,256]55`ll=f-247`,llbytes,BigEndianll\n\n\n\n#### \n\nRLPbytegostruct`Student``[\"icattlecoder\",\"male\"]`\n\n```\ntype Student struct{\n    Name string\n    Sex string\n}\ns := Student{Name:\"icattlecoder\",Sex:\"male\"}\nbuff := bytes.Buffer{}\nrpl.Encode(&buff, &s)\nprint(buff.Bytes())\n// [210 140 105 99 97 116 116 108 101 99 111 100 101 114 132 109 97 108 101]\n```\n\nmap\n\n```\n[[\"\",\"\"],[\"\",\"\"],[\"\",\"\"]]\n```\n\n\n\n##### \n\n- bytes.Buffer\n\n  Buffer\n\n  buffer bytes Read Write  Buffer     buffer\n  Buffer \n\n  ```\n  b1 := new(bytes.Buffer)\n  b1.Write([]byte(\"asd\"))\n  b1.Bytes() --> asd\n  ```\n\n  Go+**,**JavaStringBuilder, gobytes.Buffer()\n\n\n\n- sync.Pool\n\n  Newnew\n\n  gc\n\n- \n\n  oogo\n\n  ```\n  type print func()\n  type A struct {\n  \tprint\n  }\n  func printString() {\n  \tfmt.Println(\"I am a string...\")\n  }\n  func printInt() {\n  \tfmt.Println(\"123456\")\n  }\n  func TestA_SetPrint(t *testing.T) {\n  \ta := &A{}\n  \ta.SetPrint(printString)\n  \ta.print()\n  \t//I am a string...\n  }\n  //printprintStringprintInt\n  ```\n\n\n\n  \n","source":"_posts/eth-rlp.md","raw":"---\ntitle: eth_rlp\ncategories:\n  - eth\ndate: 2019-10-14 14:48:31\ntags:\n---\n####  RLP\n\n#### \n\njson\n\n```\ntype Student struct{\n    Name string `json:\"name\"`\n    Sex string `json:\"sex\"`\n}\ns := Student{Name:\"icattlecoder\",Sex:\"male\"}\nbs,_ := json.Marsal(&s)\n\n```\n\n`{\"name\":\"icattlecoder\",\"sex\":\"male\"}`,icattlecodermale16json RLP\n\n\n\n> RLPRecursive Length PrefixRLP\n\n\n\nRLP\n\n- byte\n- byte\n\n**1**[0, 127]\n\n1`a``97`\n\n**2**byte`l <= 55``128+l`\n\n2`128``128 = 128 + 0`\n\n3`abc``131 97 98 99``131=128+len(\"abc\")``97 98 99``a b c`\n\n**3**55 183byte\n\n55183+ ****\n\n\n\n```\nThe length of this sentence is more than 55 bytes, I know it because I pre-designed it\n```\n\n8686\n\n```\n184 86 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110 116101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101 11544 32 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114 101 45 100101 115 105 103 110 101 100 32 105 116\n```\n\n\n\n1. `184 = 183 + 1``86`\n2. `86``86`\n3. `84``T`\n\n\n\n1024\"a\"`185 4 0 97 97 97 97 97 97 ...`\n1024 big endian`004 0`2`185 = 183 + 2`\n\n1~3byte****\n\n\n\n**4**55192\n\n4\n6`[\"abc\", \"def\"]``200 131 97 98 99 131 100 101 102`\n`abc``131 97 98 99`,`def``131 100 101 102`8`192 + 8 = 200`\n\n\n\n**5**55247\n\n53\n\n7\n\n```\n[\"The length of this sentence is more than 55 bytes, \", \"I know it because I pre-designed it\"]\n```\n\n:\n\n```\n248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116\n```\n\n\n\n1. `248 = 247 +1`\n2. `88 = 86 + 2`**3**`86`12\n   3`179`**2**`179 = 128 + 51`\n\n55`163`**2**`163 = 128 + 35`\n\n\n\n8****\n\n```\n[\"abc\",[\"The length of this sentence is more than 55 bytes, \", \"I know it because I pre-designed it\"]]\n```\n\n\n\n```\n248 94 131 97 98 99 248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105115 32 115 101 110 116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 5332 98 121 116 101 115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 10132 73 32 112 114 101 45 100 101 115 105 103 110 101 100 32 105 116\n```\n\n`abc`**2**`131 97 98 99`,4\n\n\n```\n[\"The length of this sentence is more than 55 bytes, \", \"I know it because I pre-designed it\"]\n```\n\n**5**\n\n```\n248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116\n```\n\n90`90 + 4 = 94`, 1`247 + 1 = 248`\n\n5RPL\n\n\n\n#### \n\n`f`\n\n1. f [0,128),\n2. f[128,184)55byte `l=f-128`\n3. f[184,192)55`ll=f-183`,llbytesBigEndianll\n4. f(192,247]55`l=f-192`1~4\n5. f(247,256]55`ll=f-247`,llbytes,BigEndianll\n\n\n\n#### \n\nRLPbytegostruct`Student``[\"icattlecoder\",\"male\"]`\n\n```\ntype Student struct{\n    Name string\n    Sex string\n}\ns := Student{Name:\"icattlecoder\",Sex:\"male\"}\nbuff := bytes.Buffer{}\nrpl.Encode(&buff, &s)\nprint(buff.Bytes())\n// [210 140 105 99 97 116 116 108 101 99 111 100 101 114 132 109 97 108 101]\n```\n\nmap\n\n```\n[[\"\",\"\"],[\"\",\"\"],[\"\",\"\"]]\n```\n\n\n\n##### \n\n- bytes.Buffer\n\n  Buffer\n\n  buffer bytes Read Write  Buffer     buffer\n  Buffer \n\n  ```\n  b1 := new(bytes.Buffer)\n  b1.Write([]byte(\"asd\"))\n  b1.Bytes() --> asd\n  ```\n\n  Go+**,**JavaStringBuilder, gobytes.Buffer()\n\n\n\n- sync.Pool\n\n  Newnew\n\n  gc\n\n- \n\n  oogo\n\n  ```\n  type print func()\n  type A struct {\n  \tprint\n  }\n  func printString() {\n  \tfmt.Println(\"I am a string...\")\n  }\n  func printInt() {\n  \tfmt.Println(\"123456\")\n  }\n  func TestA_SetPrint(t *testing.T) {\n  \ta := &A{}\n  \ta.SetPrint(printString)\n  \ta.print()\n  \t//I am a string...\n  }\n  //printprintStringprintInt\n  ```\n\n\n\n  \n","slug":"eth-rlp","published":1,"updated":"2019-10-14T06:48:50.308Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69x3002at6xviyz6j1kt","content":"<h4 id=\"-RLP\"><a href=\"#-RLP\" class=\"headerlink\" title=\" RLP\"></a> RLP</h4><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>json</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Student struct&#123;</span><br><span class=\"line\">    Name string `json:&quot;name&quot;`</span><br><span class=\"line\">    Sex string `json:&quot;sex&quot;`</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">s := Student&#123;Name:&quot;icattlecoder&quot;,Sex:&quot;male&quot;&#125;</span><br><span class=\"line\">bs,_ := json.Marsal(&amp;s)</span><br></pre></td></tr></table></figure>\n\n<p><code>{&quot;name&quot;:&quot;icattlecoder&quot;,&quot;sex&quot;:&quot;male&quot;}</code>,icattlecodermale16json RLP</p>\n<blockquote>\n<p>RLPRecursive Length PrefixRLP</p>\n</blockquote>\n<p>RLP</p>\n<ul>\n<li>byte</li>\n<li>byte</li>\n</ul>\n<p><strong>1</strong>[0, 127]</p>\n<p>1<code>a</code><code>97</code></p>\n<p><strong>2</strong>byte<code>l &lt;= 55</code><code>128+l</code></p>\n<p>2<code>128</code><code>128 = 128 + 0</code></p>\n<p>3<code>abc</code><code>131 97 98 99</code><code>131=128+len(&quot;abc&quot;)</code><code>97 98 99</code><code>a b c</code></p>\n<p><strong>3</strong>55 183byte</p>\n<p>55183+ <strong></strong></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The length of this sentence is more than 55 bytes, I know it because I pre-designed it</span><br></pre></td></tr></table></figure>\n\n<p>8686</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">184 86 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110 116101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101 11544 32 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114 101 45 100101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>184 = 183 + 1</code><code>86</code></li>\n<li><code>86</code><code>86</code></li>\n<li><code>84</code><code>T</code></li>\n</ol>\n<p>1024a<code>185 4 0 97 97 97 97 97 97 ...</code><br>1024 big endian<code>004 0</code>2<code>185 = 183 + 2</code></p>\n<p>1~3byte<strong></strong></p>\n<p><strong>4</strong>55192</p>\n<p>4<br>6<code>[&quot;abc&quot;, &quot;def&quot;]</code><code>200 131 97 98 99 131 100 101 102</code><br><code>abc</code><code>131 97 98 99</code>,<code>def</code><code>131 100 101 102</code>8<code>192 + 8 = 200</code></p>\n<p><strong>5</strong>55247</p>\n<p>53</p>\n<p>7</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]</span><br></pre></td></tr></table></figure>\n\n<p>:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>248 = 247 +1</code></li>\n<li><code>88 = 86 + 2</code><strong>3</strong><code>86</code>12<br>3<code>179</code><strong>2</strong><code>179 = 128 + 51</code></li>\n</ol>\n<p>55<code>163</code><strong>2</strong><code>163 = 128 + 35</code></p>\n<p>8<strong></strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&quot;abc&quot;,[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]]</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">248 94 131 97 98 99 248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105115 32 115 101 110 116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 5332 98 121 116 101 115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 10132 73 32 112 114 101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p><code>abc</code><strong>2</strong><code>131 97 98 99</code>,4<br></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]</span><br></pre></td></tr></table></figure>\n\n<p><strong>5</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p>90<code>90 + 4 = 94</code>, 1<code>247 + 1 = 248</code></p>\n<p>5RPL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>f</code></p>\n<ol>\n<li>f [0,128),</li>\n<li>f[128,184)55byte <code>l=f-128</code></li>\n<li>f[184,192)55<code>ll=f-183</code>,llbytesBigEndianll</li>\n<li>f(192,247]55<code>l=f-192</code>1~4</li>\n<li>f(247,256]55<code>ll=f-247</code>,llbytes,BigEndianll</li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>RLPbytegostruct<code>Student</code><code>[&quot;icattlecoder&quot;,&quot;male&quot;]</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Student struct&#123;</span><br><span class=\"line\">    Name string</span><br><span class=\"line\">    Sex string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">s := Student&#123;Name:&quot;icattlecoder&quot;,Sex:&quot;male&quot;&#125;</span><br><span class=\"line\">buff := bytes.Buffer&#123;&#125;</span><br><span class=\"line\">rpl.Encode(&amp;buff, &amp;s)</span><br><span class=\"line\">print(buff.Bytes())</span><br><span class=\"line\">// [210 140 105 99 97 116 116 108 101 99 111 100 101 114 132 109 97 108 101]</span><br></pre></td></tr></table></figure>\n\n<p>map</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[[&quot;&quot;,&quot;&quot;],[&quot;&quot;,&quot;&quot;],[&quot;&quot;,&quot;&quot;]]</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li><p>bytes.Buffer</p>\n<p>Buffer</p>\n<p>buffer bytes Read Write  Buffer     buffer<br>Buffer </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b1 := new(bytes.Buffer)</span><br><span class=\"line\">b1.Write([]byte(&quot;asd&quot;))</span><br><span class=\"line\">b1.Bytes() --&gt; asd</span><br></pre></td></tr></table></figure>\n\n<p>Go+<strong>,</strong>JavaStringBuilder, gobytes.Buffer()</p>\n</li>\n</ul>\n<ul>\n<li><p>sync.Pool</p>\n<p>Newnew</p>\n<p>gc</p>\n</li>\n<li><p></p>\n<p>oogo</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type print func()</span><br><span class=\"line\">type A struct &#123;</span><br><span class=\"line\">\tprint</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func printString() &#123;</span><br><span class=\"line\">\tfmt.Println(&quot;I am a string...&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func printInt() &#123;</span><br><span class=\"line\">\tfmt.Println(&quot;123456&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func TestA_SetPrint(t *testing.T) &#123;</span><br><span class=\"line\">\ta := &amp;A&#123;&#125;</span><br><span class=\"line\">\ta.SetPrint(printString)</span><br><span class=\"line\">\ta.print()</span><br><span class=\"line\">\t//I am a string...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//printprintStringprintInt</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h4 id=\"-RLP\"><a href=\"#-RLP\" class=\"headerlink\" title=\" RLP\"></a> RLP</h4><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>json</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Student struct&#123;</span><br><span class=\"line\">    Name string `json:&quot;name&quot;`</span><br><span class=\"line\">    Sex string `json:&quot;sex&quot;`</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">s := Student&#123;Name:&quot;icattlecoder&quot;,Sex:&quot;male&quot;&#125;</span><br><span class=\"line\">bs,_ := json.Marsal(&amp;s)</span><br></pre></td></tr></table></figure>\n\n<p><code>{&quot;name&quot;:&quot;icattlecoder&quot;,&quot;sex&quot;:&quot;male&quot;}</code>,icattlecodermale16json RLP</p>\n<blockquote>\n<p>RLPRecursive Length PrefixRLP</p>\n</blockquote>\n<p>RLP</p>\n<ul>\n<li>byte</li>\n<li>byte</li>\n</ul>\n<p><strong>1</strong>[0, 127]</p>\n<p>1<code>a</code><code>97</code></p>\n<p><strong>2</strong>byte<code>l &lt;= 55</code><code>128+l</code></p>\n<p>2<code>128</code><code>128 = 128 + 0</code></p>\n<p>3<code>abc</code><code>131 97 98 99</code><code>131=128+len(&quot;abc&quot;)</code><code>97 98 99</code><code>a b c</code></p>\n<p><strong>3</strong>55 183byte</p>\n<p>55183+ <strong></strong></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">The length of this sentence is more than 55 bytes, I know it because I pre-designed it</span><br></pre></td></tr></table></figure>\n\n<p>8686</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">184 86 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110 116101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101 11544 32 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114 101 45 100101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>184 = 183 + 1</code><code>86</code></li>\n<li><code>86</code><code>86</code></li>\n<li><code>84</code><code>T</code></li>\n</ol>\n<p>1024a<code>185 4 0 97 97 97 97 97 97 ...</code><br>1024 big endian<code>004 0</code>2<code>185 = 183 + 2</code></p>\n<p>1~3byte<strong></strong></p>\n<p><strong>4</strong>55192</p>\n<p>4<br>6<code>[&quot;abc&quot;, &quot;def&quot;]</code><code>200 131 97 98 99 131 100 101 102</code><br><code>abc</code><code>131 97 98 99</code>,<code>def</code><code>131 100 101 102</code>8<code>192 + 8 = 200</code></p>\n<p><strong>5</strong>55247</p>\n<p>53</p>\n<p>7</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]</span><br></pre></td></tr></table></figure>\n\n<p>:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>248 = 247 +1</code></li>\n<li><code>88 = 86 + 2</code><strong>3</strong><code>86</code>12<br>3<code>179</code><strong>2</strong><code>179 = 128 + 51</code></li>\n</ol>\n<p>55<code>163</code><strong>2</strong><code>163 = 128 + 35</code></p>\n<p>8<strong></strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&quot;abc&quot;,[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]]</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">248 94 131 97 98 99 248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105115 32 115 101 110 116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 5332 98 121 116 101 115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 10132 73 32 112 114 101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p><code>abc</code><strong>2</strong><code>131 97 98 99</code>,4<br></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&quot;The length of this sentence is more than 55 bytes, &quot;, &quot;I know it because I pre-designed it&quot;]</span><br></pre></td></tr></table></figure>\n\n<p><strong>5</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">248 88 179 84 104 101 32 108 101 110 103 116 104 32 111 102 32 116 104 105 115 32 115 101 110116 101 110 99 101 32 105 115 32 109 111 114 101 32 116 104 97 110 32 53 53 32 98 121 116 101115 44 32 163 73 32 107 110 111 119 32 105 116 32 98 101 99 97 117 115 101 32 73 32 112 114101 45 100 101 115 105 103 110 101 100 32 105 116</span><br></pre></td></tr></table></figure>\n\n<p>90<code>90 + 4 = 94</code>, 1<code>247 + 1 = 248</code></p>\n<p>5RPL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>f</code></p>\n<ol>\n<li>f [0,128),</li>\n<li>f[128,184)55byte <code>l=f-128</code></li>\n<li>f[184,192)55<code>ll=f-183</code>,llbytesBigEndianll</li>\n<li>f(192,247]55<code>l=f-192</code>1~4</li>\n<li>f(247,256]55<code>ll=f-247</code>,llbytes,BigEndianll</li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>RLPbytegostruct<code>Student</code><code>[&quot;icattlecoder&quot;,&quot;male&quot;]</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type Student struct&#123;</span><br><span class=\"line\">    Name string</span><br><span class=\"line\">    Sex string</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">s := Student&#123;Name:&quot;icattlecoder&quot;,Sex:&quot;male&quot;&#125;</span><br><span class=\"line\">buff := bytes.Buffer&#123;&#125;</span><br><span class=\"line\">rpl.Encode(&amp;buff, &amp;s)</span><br><span class=\"line\">print(buff.Bytes())</span><br><span class=\"line\">// [210 140 105 99 97 116 116 108 101 99 111 100 101 114 132 109 97 108 101]</span><br></pre></td></tr></table></figure>\n\n<p>map</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[[&quot;&quot;,&quot;&quot;],[&quot;&quot;,&quot;&quot;],[&quot;&quot;,&quot;&quot;]]</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li><p>bytes.Buffer</p>\n<p>Buffer</p>\n<p>buffer bytes Read Write  Buffer     buffer<br>Buffer </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b1 := new(bytes.Buffer)</span><br><span class=\"line\">b1.Write([]byte(&quot;asd&quot;))</span><br><span class=\"line\">b1.Bytes() --&gt; asd</span><br></pre></td></tr></table></figure>\n\n<p>Go+<strong>,</strong>JavaStringBuilder, gobytes.Buffer()</p>\n</li>\n</ul>\n<ul>\n<li><p>sync.Pool</p>\n<p>Newnew</p>\n<p>gc</p>\n</li>\n<li><p></p>\n<p>oogo</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type print func()</span><br><span class=\"line\">type A struct &#123;</span><br><span class=\"line\">\tprint</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func printString() &#123;</span><br><span class=\"line\">\tfmt.Println(&quot;I am a string...&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func printInt() &#123;</span><br><span class=\"line\">\tfmt.Println(&quot;123456&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">func TestA_SetPrint(t *testing.T) &#123;</span><br><span class=\"line\">\ta := &amp;A&#123;&#125;</span><br><span class=\"line\">\ta.SetPrint(printString)</span><br><span class=\"line\">\ta.print()</span><br><span class=\"line\">\t//I am a string...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//printprintStringprintInt</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n"},{"title":"eth","date":"2019-10-14T06:50:23.000Z","_content":"\n## \n\n\n\n#### \n\n..\n\n: \n\nSolidityEVMHTTP-RPCJSON-RPC\n\nDAppWeb3.jsJavaScript API\n\n\n\n#### \n\n##### ether\n\netherether\n\n- ether\n\n  1. ethereum\n  2. ethereum\n\n- etherbitcoin\n\n  > Ethereum would never be possible without bitcoinboth the technology and the currencyand we see ourselves not as a competing currency but as complementary within the digital ecosystem. Ether is to be treated as \"crypto-fuel\", a token whose purpose is to pay for computation, and is not intended to be used as or considered a currency, asset, share or anything else.\n\n         etheretherbitcoin\n\n\n\n##### gas\n\ngas1gas5gas,\n\netherSTARTGASGASPRICEgasether\n\nether10STARTGAS2000GASPRICE0.00164bytesether\\*=2000 \\* 0.001=2 \n\n1. \n\n2. 2000\\*0.001=2 ether, 2 ether\n\n3. 2000gas, 170bytes, bytes 5gas,8501150gas\n\n4. 10 ether, \n\n5. 187gas, 1150-187=963gas\n\n6. 963gasether, 0.001ether0.963\n\n\n\n##### \n\n 20byte\n\n- nonce, \n- ether\n- \n- \n\n \n\n\n\n##### \n\n\n\n- \n- \n- ether\n- \n- `STARTGAS`\n- `GASPRICE`\n\n\n\n- \n- \n- ether\n- \n- `STARTGAS`\n\n`CALL`\n\ngasgasAB1000gasBC600gasC300gasB100gas\n\nAGBAG`CREATE`; `CALL`\n\n\n\n##### \n\n`APPLY(S,TX) -> S'`\n\n1. noncenonce\n\n2. `STARTGAS * GASPRICE`nonce\n\n3. `GAS = STARTGAS`\n\n4. \n\n5. \n\n6. \n\n\n\n##### \n\nlow-level,\"\"\"EVM\"()1`STOP``RETURN`\n\n1. \n2. \n3. key/value\n\n\n\nEVM`(block_state, transaction, message, code, memory, stack, pc, gas)``block_state``pc``code`0 `pc >= len(code)`n`ADD``gas`1`pc`1`SSTORE`\n\n\n\n##### \n\n\n\n1. \n2. 15\n3. \n4. \n5. `S[0]`\n6. `TX``n``i``0...n-1``S[i+1] = APPLY(S[i],TX[i])``GASLIMIT`\n7. `S_FINAL``S[n]`\n8. Merkle`S_FINAL`; \n\nPatriciaMerkle5-20x\n\n`B``B`\n\n\n\n##### \n\n; \n\n[](https://github.com/ethereum/wiki/wiki/White-Paper)\n\n\n\n###### \n\nEthereumAXXB1AX2A\n\n\n\n###### \n\n; ETH / USD\n\n###### \n\n[Namecoin](http://namecoin.org/)[](http://namecoin.org/)[DNS](http://en.wikipedia.org/wiki/Domain_Name_System)bitcoin.orgNamecoinbitcoin.bitIP\n\n###### \n\n\n\nDropboxMerkleNMerkleX ether321szabo;\n\n\n\n###### \n\n67DAO\n\n\n\n1. http://baijiahao.baidu.com/s?id=1595831842043592716&wfr=spider&for=pc\n2. https://github.com/ethereum/wiki/wiki/White-Paper\n","source":"_posts/eth.md","raw":"---\ntitle: eth\ncategories:\n  - eth\ndate: 2019-10-14 14:50:23\ntags:\n---\n\n## \n\n\n\n#### \n\n..\n\n: \n\nSolidityEVMHTTP-RPCJSON-RPC\n\nDAppWeb3.jsJavaScript API\n\n\n\n#### \n\n##### ether\n\netherether\n\n- ether\n\n  1. ethereum\n  2. ethereum\n\n- etherbitcoin\n\n  > Ethereum would never be possible without bitcoinboth the technology and the currencyand we see ourselves not as a competing currency but as complementary within the digital ecosystem. Ether is to be treated as \"crypto-fuel\", a token whose purpose is to pay for computation, and is not intended to be used as or considered a currency, asset, share or anything else.\n\n         etheretherbitcoin\n\n\n\n##### gas\n\ngas1gas5gas,\n\netherSTARTGASGASPRICEgasether\n\nether10STARTGAS2000GASPRICE0.00164bytesether\\*=2000 \\* 0.001=2 \n\n1. \n\n2. 2000\\*0.001=2 ether, 2 ether\n\n3. 2000gas, 170bytes, bytes 5gas,8501150gas\n\n4. 10 ether, \n\n5. 187gas, 1150-187=963gas\n\n6. 963gasether, 0.001ether0.963\n\n\n\n##### \n\n 20byte\n\n- nonce, \n- ether\n- \n- \n\n \n\n\n\n##### \n\n\n\n- \n- \n- ether\n- \n- `STARTGAS`\n- `GASPRICE`\n\n\n\n- \n- \n- ether\n- \n- `STARTGAS`\n\n`CALL`\n\ngasgasAB1000gasBC600gasC300gasB100gas\n\nAGBAG`CREATE`; `CALL`\n\n\n\n##### \n\n`APPLY(S,TX) -> S'`\n\n1. noncenonce\n\n2. `STARTGAS * GASPRICE`nonce\n\n3. `GAS = STARTGAS`\n\n4. \n\n5. \n\n6. \n\n\n\n##### \n\nlow-level,\"\"\"EVM\"()1`STOP``RETURN`\n\n1. \n2. \n3. key/value\n\n\n\nEVM`(block_state, transaction, message, code, memory, stack, pc, gas)``block_state``pc``code`0 `pc >= len(code)`n`ADD``gas`1`pc`1`SSTORE`\n\n\n\n##### \n\n\n\n1. \n2. 15\n3. \n4. \n5. `S[0]`\n6. `TX``n``i``0...n-1``S[i+1] = APPLY(S[i],TX[i])``GASLIMIT`\n7. `S_FINAL``S[n]`\n8. Merkle`S_FINAL`; \n\nPatriciaMerkle5-20x\n\n`B``B`\n\n\n\n##### \n\n; \n\n[](https://github.com/ethereum/wiki/wiki/White-Paper)\n\n\n\n###### \n\nEthereumAXXB1AX2A\n\n\n\n###### \n\n; ETH / USD\n\n###### \n\n[Namecoin](http://namecoin.org/)[](http://namecoin.org/)[DNS](http://en.wikipedia.org/wiki/Domain_Name_System)bitcoin.orgNamecoinbitcoin.bitIP\n\n###### \n\n\n\nDropboxMerkleNMerkleX ether321szabo;\n\n\n\n###### \n\n67DAO\n\n\n\n1. http://baijiahao.baidu.com/s?id=1595831842043592716&wfr=spider&for=pc\n2. https://github.com/ethereum/wiki/wiki/White-Paper\n","slug":"eth","published":1,"updated":"2019-10-14T06:50:45.748Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69x5002ct6xve80e8m2u","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>..</p>\n<p>: </p>\n<p>SolidityEVMHTTP-RPCJSON-RPC</p>\n<p>DAppWeb3.jsJavaScript API</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"ether\"><a href=\"#ether\" class=\"headerlink\" title=\"ether\"></a>ether</h5><p>etherether</p>\n<ul>\n<li><p>ether</p>\n<ol>\n<li>ethereum</li>\n<li>ethereum</li>\n</ol>\n</li>\n<li><p>etherbitcoin</p>\n<blockquote>\n<p>Ethereum would never be possible without bitcoinboth the technology and the currencyand we see ourselves not as a competing currency but as complementary within the digital ecosystem. Ether is to be treated as crypto-fuel, a token whose purpose is to pay for computation, and is not intended to be used as or considered a currency, asset, share or anything else.</p>\n</blockquote>\n</li>\n</ul>\n<p>         etheretherbitcoin</p>\n<h5 id=\"gas\"><a href=\"#gas\" class=\"headerlink\" title=\"gas\"></a>gas</h5><p>gas1gas5gas,</p>\n<p>etherSTARTGASGASPRICEgasether</p>\n<p>ether10STARTGAS2000GASPRICE0.00164bytesether*=2000 * 0.001=2 </p>\n<ol>\n<li><p></p>\n</li>\n<li><p>2000*0.001=2 ether, 2 ether</p>\n</li>\n<li><p>2000gas, 170bytes, bytes 5gas,8501150gas</p>\n</li>\n<li><p>10 ether, </p>\n</li>\n<li><p>187gas, 1150-187=963gas</p>\n</li>\n<li><p>963gasether, 0.001ether0.963</p>\n</li>\n</ol>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p> 20byte</p>\n<ul>\n<li>nonce, </li>\n<li>ether</li>\n<li></li>\n<li></li>\n</ul>\n<p> </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<ul>\n<li></li>\n<li></li>\n<li>ether</li>\n<li></li>\n<li><code>STARTGAS</code></li>\n<li><code>GASPRICE</code></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li>ether</li>\n<li></li>\n<li><code>STARTGAS</code></li>\n</ul>\n<p><code>CALL</code></p>\n<p>gasgasAB1000gasBC600gasC300gasB100gas</p>\n<p>AGBAG<code>CREATE</code>; <code>CALL</code></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p><code>APPLY(S,TX) -&gt; S&#39;</code></p>\n<ol>\n<li><p>noncenonce</p>\n</li>\n<li><p><code>STARTGAS * GASPRICE</code>nonce</p>\n</li>\n<li><p><code>GAS = STARTGAS</code></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>low-level,EVM()1<code>STOP</code><code>RETURN</code></p>\n<ol>\n<li></li>\n<li></li>\n<li>key/value</li>\n</ol>\n<p></p>\n<p>EVM<code>(block_state, transaction, message, code, memory, stack, pc, gas)</code><code>block_state</code><code>pc</code><code>code</code>0 <code>pc &gt;= len(code)</code>n<code>ADD</code><code>gas</code>1<code>pc</code>1<code>SSTORE</code></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<ol>\n<li></li>\n<li>15</li>\n<li></li>\n<li></li>\n<li><code>S[0]</code></li>\n<li><code>TX</code><code>n</code><code>i</code><code>0...n-1</code><code>S[i+1] = APPLY(S[i],TX[i])</code><code>GASLIMIT</code></li>\n<li><code>S_FINAL</code><code>S[n]</code></li>\n<li>Merkle<code>S_FINAL</code>; </li>\n</ol>\n<p>PatriciaMerkle5-20x</p>\n<p><code>B</code><code>B</code></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>; </p>\n<p><a href=\"https://github.com/ethereum/wiki/wiki/White-Paper\"></a></p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p>EthereumAXXB1AX2A</p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p>; ETH / USD</p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p><a href=\"http://namecoin.org/\" target=\"_blank\" rel=\"noopener\">Namecoin</a><a href=\"http://namecoin.org/\" target=\"_blank\" rel=\"noopener\"></a><a href=\"http://en.wikipedia.org/wiki/Domain_Name_System\" target=\"_blank\" rel=\"noopener\">DNS</a>bitcoin.orgNamecoinbitcoin.bitIP</p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p></p>\n<p>DropboxMerkleNMerkleX ether321szabo;</p>\n<p></p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p>67DAO</p>\n<p></p>\n<ol>\n<li><a href=\"http://baijiahao.baidu.com/s?id=1595831842043592716&amp;wfr=spider&amp;for=pc\" target=\"_blank\" rel=\"noopener\">http://baijiahao.baidu.com/s?id=1595831842043592716&amp;wfr=spider&amp;for=pc</a></li>\n<li><a href=\"https://github.com/ethereum/wiki/wiki/White-Paper\">https://github.com/ethereum/wiki/wiki/White-Paper</a></li>\n</ol>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>..</p>\n<p>: </p>\n<p>SolidityEVMHTTP-RPCJSON-RPC</p>\n<p>DAppWeb3.jsJavaScript API</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"ether\"><a href=\"#ether\" class=\"headerlink\" title=\"ether\"></a>ether</h5><p>etherether</p>\n<ul>\n<li><p>ether</p>\n<ol>\n<li>ethereum</li>\n<li>ethereum</li>\n</ol>\n</li>\n<li><p>etherbitcoin</p>\n<blockquote>\n<p>Ethereum would never be possible without bitcoinboth the technology and the currencyand we see ourselves not as a competing currency but as complementary within the digital ecosystem. Ether is to be treated as crypto-fuel, a token whose purpose is to pay for computation, and is not intended to be used as or considered a currency, asset, share or anything else.</p>\n</blockquote>\n</li>\n</ul>\n<p>         etheretherbitcoin</p>\n<h5 id=\"gas\"><a href=\"#gas\" class=\"headerlink\" title=\"gas\"></a>gas</h5><p>gas1gas5gas,</p>\n<p>etherSTARTGASGASPRICEgasether</p>\n<p>ether10STARTGAS2000GASPRICE0.00164bytesether*=2000 * 0.001=2 </p>\n<ol>\n<li><p></p>\n</li>\n<li><p>2000*0.001=2 ether, 2 ether</p>\n</li>\n<li><p>2000gas, 170bytes, bytes 5gas,8501150gas</p>\n</li>\n<li><p>10 ether, </p>\n</li>\n<li><p>187gas, 1150-187=963gas</p>\n</li>\n<li><p>963gasether, 0.001ether0.963</p>\n</li>\n</ol>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p> 20byte</p>\n<ul>\n<li>nonce, </li>\n<li>ether</li>\n<li></li>\n<li></li>\n</ul>\n<p> </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<ul>\n<li></li>\n<li></li>\n<li>ether</li>\n<li></li>\n<li><code>STARTGAS</code></li>\n<li><code>GASPRICE</code></li>\n</ul>\n<p></p>\n<ul>\n<li></li>\n<li></li>\n<li>ether</li>\n<li></li>\n<li><code>STARTGAS</code></li>\n</ul>\n<p><code>CALL</code></p>\n<p>gasgasAB1000gasBC600gasC300gasB100gas</p>\n<p>AGBAG<code>CREATE</code>; <code>CALL</code></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p><code>APPLY(S,TX) -&gt; S&#39;</code></p>\n<ol>\n<li><p>noncenonce</p>\n</li>\n<li><p><code>STARTGAS * GASPRICE</code>nonce</p>\n</li>\n<li><p><code>GAS = STARTGAS</code></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>low-level,EVM()1<code>STOP</code><code>RETURN</code></p>\n<ol>\n<li></li>\n<li></li>\n<li>key/value</li>\n</ol>\n<p></p>\n<p>EVM<code>(block_state, transaction, message, code, memory, stack, pc, gas)</code><code>block_state</code><code>pc</code><code>code</code>0 <code>pc &gt;= len(code)</code>n<code>ADD</code><code>gas</code>1<code>pc</code>1<code>SSTORE</code></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p></p>\n<ol>\n<li></li>\n<li>15</li>\n<li></li>\n<li></li>\n<li><code>S[0]</code></li>\n<li><code>TX</code><code>n</code><code>i</code><code>0...n-1</code><code>S[i+1] = APPLY(S[i],TX[i])</code><code>GASLIMIT</code></li>\n<li><code>S_FINAL</code><code>S[n]</code></li>\n<li>Merkle<code>S_FINAL</code>; </li>\n</ol>\n<p>PatriciaMerkle5-20x</p>\n<p><code>B</code><code>B</code></p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>; </p>\n<p><a href=\"https://github.com/ethereum/wiki/wiki/White-Paper\"></a></p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p>EthereumAXXB1AX2A</p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p>; ETH / USD</p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p><a href=\"http://namecoin.org/\" target=\"_blank\" rel=\"noopener\">Namecoin</a><a href=\"http://namecoin.org/\" target=\"_blank\" rel=\"noopener\"></a><a href=\"http://en.wikipedia.org/wiki/Domain_Name_System\" target=\"_blank\" rel=\"noopener\">DNS</a>bitcoin.orgNamecoinbitcoin.bitIP</p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p></p>\n<p>DropboxMerkleNMerkleX ether321szabo;</p>\n<p></p>\n<h6 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h6><p>67DAO</p>\n<p></p>\n<ol>\n<li><a href=\"http://baijiahao.baidu.com/s?id=1595831842043592716&amp;wfr=spider&amp;for=pc\" target=\"_blank\" rel=\"noopener\">http://baijiahao.baidu.com/s?id=1595831842043592716&amp;wfr=spider&amp;for=pc</a></li>\n<li><a href=\"https://github.com/ethereum/wiki/wiki/White-Paper\">https://github.com/ethereum/wiki/wiki/White-Paper</a></li>\n</ol>\n"},{"title":"fabric_example","date":"2019-04-11T07:05:29.000Z","_content":"\nfabric-examples\n\ndocker images examples\n\nrelease-1.1\n\n\n\nchaincode\n\n- Example-01\n\n    func main() {\n    \terr := shim.Start(new(SimpleChaincode))\n    \tif err != nil {\n    \t\tfmt.Printf(\"Error starting Simple chaincode: %s\", err)\n    \t}\n    }\n\n\n\nmainshim.Start(new())\n\n-     Init(stub shim.ChaincodeStubInterface) pb.Response\n-     Invoke(stub shim.ChaincodeStubInterface) pb.Response\n\nInitInvokeABInitInvoke\n\n    func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {\n    \tfunction, args := stub.GetFunctionAndParameters() //\n    \tif function == \"invoke\" {\n    \t\t// Make payment of X units from A to B\n    \t\treturn t.invoke(stub, args)  //\n    \t} else if function == \"delete\" {\n    \t\t// Deletes an entity from its state\n    \t\treturn t.delete(stub, args)  //\n    \t} else if function == \"query\" {\n    \t\t// the old \"Query\" is now implemtned in invoke\n    \t\treturn t.query(stub, args)  //\n    \t}\n\n    \treturn shim.Error(\"Invalid invoke function name. Expecting \\\"invoke\\\" \\\"delete\\\" \\\"query\\\"\")\n    }\n\nexample-02  - . -\n\n\n\n- Example-02\n\n0102invokekey-value\n\n    //\n    err = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n    //\n    Avalbytes, err := stub.GetState(A)\n\nstubshim.ChaincodeStubInterface\n\n\n\n- Example -03\n\n\n\n    func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response {\n      \n      // Write the state to the ledger - this put is illegal within Run\n    \terr = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n      \n    }\n\nqueryputStateinvokeputStateinvoke\n\n\n\n- Example-04\n\nexampleapi\n\n    response := stub.InvokeChaincode(chainCodeToCall, invokeArgs, channelID)\n\n- Example-05\n\nchannelchannel\n\nInvokeChaincode () channel name\n\n45test4 5...\n\n\n\n- Test\n\n    \tscc := new(SimpleChaincode)\n    \tstub := shim.NewMockStub(\"ex03\", scc)\n    \tres := stub.MockInvoke(\"1\", [][]byte{[]byte(\"query\"), []byte(\"A\"), []byte(\"345\"))\n    \tif res.Status != shim.OK {\n    \t\tfmt.Println(\"Query failed\", string(res.Message))\n    \t\tt.FailNow()\n    \t}\n\n\n\n\n\n    \tscc := new(SimpleChaincode)\n    \tstub := shim.NewMockStub(\"ex05\", scc)\n\n    \tccEx2 := new(ex02.SimpleChaincode)\n    \tstubEx2 := shim.NewMockStub(chaincodeName, ccEx2)\n    \tcheckInit(t, stubEx2, [][]byte{[]byte(\"init\"), []byte(\"a\"), []byte(\"222\"), []byte(\"b\"), []byte(\"333\")})\n    \t//peerchaincode\n    \tstub.MockPeerChaincode(chaincodeName, stubEx2)\n\n\n\n\n\nTutorials4tutorialApplication(node sdk)~\n\n\n\n\n\n22peer1order\n\nclone fabric-exampledocker imagesdocker-imagescurl  | bash curl *.sh32docker images, 1binbin\n\n    $ ls\n    configtxgen\t\tconfigtxlator\t\tcryptogen\t\tget-docker-images.sh\torderer\t\t\tpeer\n\nbinfabric-example\n\n    $ cd first-network\n    $ ./byfn.sh -m generate\n\nbinfabric-example..\n\n    $ ./byfn.sh -m up\n\ncurl fabricscript/bootstrap.sh\n\n\n\nbyfn~\n\n$ ./byfn.sh -m generate\n\n- cryptogen/\n  - cryptogencrypto-config.yaml\n        OrdererOrgs:\n          - Name: Orderer\n            Domain: example.com\n            # ---------------------------------------------------------------------------\n            # \"Specs\" - See PeerOrgs below for complete description\n            # ---------------------------------------------------------------------------\n            Specs:\n              - Hostname: orderer\n        PeerOrgs:\n        # -----------------------------------------------------\n        # Org1\n        # ----------------------------------------------------\n        - Name: Org1\n          Domain: org1.example.com\n          Template:\n              Count: 2\n          Users:\n              Count: 1\n    cryptogen generate --config=./crypto-config.yamlcrypto-config,  /Domain/\n- configtxgen tool\n  - orderer genesis block, orderergensis.block\n  - channel configuration transaction, ordererchannelchannelchannel\n  - and two anchor peer transactions - one for each Peer Org. channelpeerpeer\n\n-  up... docker-compose -f $COMPOSE_FILE... docker-compose-cli.yaml6cli, ./scripts/script.shchannelchannelchaincodechaincode.....\n  \n\n  ,  \n\n  cli scriptscriptchannelpeer chaincode  \n","source":"_posts/fabric-example.md","raw":"---\ntitle: fabric_example\ncategories:\n  - fabric\ndate: 2019-4-11 15:05:29\ntags:\n---\n\nfabric-examples\n\ndocker images examples\n\nrelease-1.1\n\n\n\nchaincode\n\n- Example-01\n\n    func main() {\n    \terr := shim.Start(new(SimpleChaincode))\n    \tif err != nil {\n    \t\tfmt.Printf(\"Error starting Simple chaincode: %s\", err)\n    \t}\n    }\n\n\n\nmainshim.Start(new())\n\n-     Init(stub shim.ChaincodeStubInterface) pb.Response\n-     Invoke(stub shim.ChaincodeStubInterface) pb.Response\n\nInitInvokeABInitInvoke\n\n    func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {\n    \tfunction, args := stub.GetFunctionAndParameters() //\n    \tif function == \"invoke\" {\n    \t\t// Make payment of X units from A to B\n    \t\treturn t.invoke(stub, args)  //\n    \t} else if function == \"delete\" {\n    \t\t// Deletes an entity from its state\n    \t\treturn t.delete(stub, args)  //\n    \t} else if function == \"query\" {\n    \t\t// the old \"Query\" is now implemtned in invoke\n    \t\treturn t.query(stub, args)  //\n    \t}\n\n    \treturn shim.Error(\"Invalid invoke function name. Expecting \\\"invoke\\\" \\\"delete\\\" \\\"query\\\"\")\n    }\n\nexample-02  - . -\n\n\n\n- Example-02\n\n0102invokekey-value\n\n    //\n    err = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n    //\n    Avalbytes, err := stub.GetState(A)\n\nstubshim.ChaincodeStubInterface\n\n\n\n- Example -03\n\n\n\n    func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response {\n      \n      // Write the state to the ledger - this put is illegal within Run\n    \terr = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n      \n    }\n\nqueryputStateinvokeputStateinvoke\n\n\n\n- Example-04\n\nexampleapi\n\n    response := stub.InvokeChaincode(chainCodeToCall, invokeArgs, channelID)\n\n- Example-05\n\nchannelchannel\n\nInvokeChaincode () channel name\n\n45test4 5...\n\n\n\n- Test\n\n    \tscc := new(SimpleChaincode)\n    \tstub := shim.NewMockStub(\"ex03\", scc)\n    \tres := stub.MockInvoke(\"1\", [][]byte{[]byte(\"query\"), []byte(\"A\"), []byte(\"345\"))\n    \tif res.Status != shim.OK {\n    \t\tfmt.Println(\"Query failed\", string(res.Message))\n    \t\tt.FailNow()\n    \t}\n\n\n\n\n\n    \tscc := new(SimpleChaincode)\n    \tstub := shim.NewMockStub(\"ex05\", scc)\n\n    \tccEx2 := new(ex02.SimpleChaincode)\n    \tstubEx2 := shim.NewMockStub(chaincodeName, ccEx2)\n    \tcheckInit(t, stubEx2, [][]byte{[]byte(\"init\"), []byte(\"a\"), []byte(\"222\"), []byte(\"b\"), []byte(\"333\")})\n    \t//peerchaincode\n    \tstub.MockPeerChaincode(chaincodeName, stubEx2)\n\n\n\n\n\nTutorials4tutorialApplication(node sdk)~\n\n\n\n\n\n22peer1order\n\nclone fabric-exampledocker imagesdocker-imagescurl  | bash curl *.sh32docker images, 1binbin\n\n    $ ls\n    configtxgen\t\tconfigtxlator\t\tcryptogen\t\tget-docker-images.sh\torderer\t\t\tpeer\n\nbinfabric-example\n\n    $ cd first-network\n    $ ./byfn.sh -m generate\n\nbinfabric-example..\n\n    $ ./byfn.sh -m up\n\ncurl fabricscript/bootstrap.sh\n\n\n\nbyfn~\n\n$ ./byfn.sh -m generate\n\n- cryptogen/\n  - cryptogencrypto-config.yaml\n        OrdererOrgs:\n          - Name: Orderer\n            Domain: example.com\n            # ---------------------------------------------------------------------------\n            # \"Specs\" - See PeerOrgs below for complete description\n            # ---------------------------------------------------------------------------\n            Specs:\n              - Hostname: orderer\n        PeerOrgs:\n        # -----------------------------------------------------\n        # Org1\n        # ----------------------------------------------------\n        - Name: Org1\n          Domain: org1.example.com\n          Template:\n              Count: 2\n          Users:\n              Count: 1\n    cryptogen generate --config=./crypto-config.yamlcrypto-config,  /Domain/\n- configtxgen tool\n  - orderer genesis block, orderergensis.block\n  - channel configuration transaction, ordererchannelchannelchannel\n  - and two anchor peer transactions - one for each Peer Org. channelpeerpeer\n\n-  up... docker-compose -f $COMPOSE_FILE... docker-compose-cli.yaml6cli, ./scripts/script.shchannelchannelchaincodechaincode.....\n  \n\n  ,  \n\n  cli scriptscriptchannelpeer chaincode  \n","slug":"fabric-example","published":1,"updated":"2019-10-14T07:06:19.696Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69x7002et6xv66rijl73","content":"<p>fabric-examples</p>\n<p>docker images examples</p>\n<p>release-1.1</p>\n<p>chaincode</p>\n<ul>\n<li><p>Example-01</p>\n<p>  func main() {</p>\n<pre><code>err := shim.Start(new(SimpleChaincode))\nif err != nil {\n    fmt.Printf(&quot;Error starting Simple chaincode: %s&quot;, err)\n}</code></pre><p>  }</p>\n</li>\n</ul>\n<p></p>\n<p>mainshim.Start(new())</p>\n<ul>\n<li>Init(stub shim.ChaincodeStubInterface) pb.Response</li>\n<li>Invoke(stub shim.ChaincodeStubInterface) pb.Response</li>\n</ul>\n<p>InitInvokeABInitInvoke</p>\n<pre><code>func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {\n    function, args := stub.GetFunctionAndParameters() //\n    if function == &quot;invoke&quot; {\n        // Make payment of X units from A to B\n        return t.invoke(stub, args)  //\n    } else if function == &quot;delete&quot; {\n        // Deletes an entity from its state\n        return t.delete(stub, args)  //\n    } else if function == &quot;query&quot; {\n        // the old &quot;Query&quot; is now implemtned in invoke\n        return t.query(stub, args)  //\n    }\n\n    return shim.Error(&quot;Invalid invoke function name. Expecting \\&quot;invoke\\&quot; \\&quot;delete\\&quot; \\&quot;query\\&quot;&quot;)\n}</code></pre><p>example-02  - . -</p>\n<ul>\n<li>Example-02</li>\n</ul>\n<p>0102invokekey-value</p>\n<pre><code>//\nerr = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n//\nAvalbytes, err := stub.GetState(A)</code></pre><p>stubshim.ChaincodeStubInterface</p>\n<ul>\n<li>Example -03</li>\n</ul>\n<p></p>\n<pre><code>func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response {\n  \n  // Write the state to the ledger - this put is illegal within Run\n    err = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n  \n}</code></pre><p>queryputStateinvokeputStateinvoke</p>\n<ul>\n<li>Example-04</li>\n</ul>\n<p>exampleapi</p>\n<pre><code>response := stub.InvokeChaincode(chainCodeToCall, invokeArgs, channelID)</code></pre><ul>\n<li>Example-05</li>\n</ul>\n<p>channelchannel</p>\n<p>InvokeChaincode () channel name</p>\n<p>45test4 5</p>\n<ul>\n<li><p>Test</p>\n<pre><code>scc := new(SimpleChaincode)\nstub := shim.NewMockStub(&quot;ex03&quot;, scc)\nres := stub.MockInvoke(&quot;1&quot;, [][]byte{[]byte(&quot;query&quot;), []byte(&quot;A&quot;), []byte(&quot;345&quot;))\nif res.Status != shim.OK {\n    fmt.Println(&quot;Query failed&quot;, string(res.Message))\n    t.FailNow()\n}</code></pre></li>\n</ul>\n<p></p>\n<pre><code>scc := new(SimpleChaincode)\nstub := shim.NewMockStub(&quot;ex05&quot;, scc)\n\nccEx2 := new(ex02.SimpleChaincode)\nstubEx2 := shim.NewMockStub(chaincodeName, ccEx2)\ncheckInit(t, stubEx2, [][]byte{[]byte(&quot;init&quot;), []byte(&quot;a&quot;), []byte(&quot;222&quot;), []byte(&quot;b&quot;), []byte(&quot;333&quot;)})\n//peerchaincode\nstub.MockPeerChaincode(chaincodeName, stubEx2)</code></pre><p>Tutorials4tutorialApplication(node sdk)~</p>\n<p></p>\n<p>22peer1order</p>\n<p>clone fabric-exampledocker imagesdocker-imagescurl  | bash curl *.sh32docker images, 1binbin</p>\n<pre><code>$ ls\nconfigtxgen        configtxlator        cryptogen        get-docker-images.sh    orderer            peer</code></pre><p>binfabric-example</p>\n<pre><code>$ cd first-network\n$ ./byfn.sh -m generate</code></pre><p>binfabric-example..</p>\n<pre><code>$ ./byfn.sh -m up</code></pre><p>curl fabricscript/bootstrap.sh</p>\n<p>byfn~</p>\n<p>$ ./byfn.sh -m generate</p>\n<ul>\n<li><p>cryptogen/</p>\n<ul>\n<li>cryptogencrypto-config.yaml<pre><code>OrdererOrgs:\n  - Name: Orderer\n    Domain: example.com\n    # ---------------------------------------------------------------------------\n    # &quot;Specs&quot; - See PeerOrgs below for complete description\n    # ---------------------------------------------------------------------------\n    Specs:\n      - Hostname: orderer\nPeerOrgs:\n# -----------------------------------------------------\n# Org1\n# ----------------------------------------------------\n- Name: Org1\n  Domain: org1.example.com\n  Template:\n      Count: 2\n  Users:\n      Count: 1</code></pre>cryptogen generate config=./crypto-config.yamlcrypto-config,  /Domain/</li>\n</ul>\n</li>\n<li><p>configtxgen tool</p>\n<ul>\n<li>orderer genesis block, orderergensis.block</li>\n<li>channel configuration transaction, ordererchannelchannelchannel</li>\n<li>and two anchor peer transactions - one for each Peer Org. channelpeerpeer</li>\n</ul>\n</li>\n<li><p> up docker-compose -f $COMPOSE_FILE docker-compose-cli.yaml6cli, ./scripts/script.shchannelchannelchaincodechaincode..<br></p>\n<p>,  </p>\n<p>cli scriptscriptchannelpeer chaincode  </p>\n</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<p>fabric-examples</p>\n<p>docker images examples</p>\n<p>release-1.1</p>\n<p>chaincode</p>\n<ul>\n<li><p>Example-01</p>\n<p>  func main() {</p>\n<pre><code>err := shim.Start(new(SimpleChaincode))\nif err != nil {\n    fmt.Printf(&quot;Error starting Simple chaincode: %s&quot;, err)\n}</code></pre><p>  }</p>\n</li>\n</ul>\n<p></p>\n<p>mainshim.Start(new())</p>\n<ul>\n<li>Init(stub shim.ChaincodeStubInterface) pb.Response</li>\n<li>Invoke(stub shim.ChaincodeStubInterface) pb.Response</li>\n</ul>\n<p>InitInvokeABInitInvoke</p>\n<pre><code>func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {\n    function, args := stub.GetFunctionAndParameters() //\n    if function == &quot;invoke&quot; {\n        // Make payment of X units from A to B\n        return t.invoke(stub, args)  //\n    } else if function == &quot;delete&quot; {\n        // Deletes an entity from its state\n        return t.delete(stub, args)  //\n    } else if function == &quot;query&quot; {\n        // the old &quot;Query&quot; is now implemtned in invoke\n        return t.query(stub, args)  //\n    }\n\n    return shim.Error(&quot;Invalid invoke function name. Expecting \\&quot;invoke\\&quot; \\&quot;delete\\&quot; \\&quot;query\\&quot;&quot;)\n}</code></pre><p>example-02  - . -</p>\n<ul>\n<li>Example-02</li>\n</ul>\n<p>0102invokekey-value</p>\n<pre><code>//\nerr = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n//\nAvalbytes, err := stub.GetState(A)</code></pre><p>stubshim.ChaincodeStubInterface</p>\n<ul>\n<li>Example -03</li>\n</ul>\n<p></p>\n<pre><code>func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response {\n  \n  // Write the state to the ledger - this put is illegal within Run\n    err = stub.PutState(A, []byte(strconv.Itoa(Aval)))\n  \n}</code></pre><p>queryputStateinvokeputStateinvoke</p>\n<ul>\n<li>Example-04</li>\n</ul>\n<p>exampleapi</p>\n<pre><code>response := stub.InvokeChaincode(chainCodeToCall, invokeArgs, channelID)</code></pre><ul>\n<li>Example-05</li>\n</ul>\n<p>channelchannel</p>\n<p>InvokeChaincode () channel name</p>\n<p>45test4 5</p>\n<ul>\n<li><p>Test</p>\n<pre><code>scc := new(SimpleChaincode)\nstub := shim.NewMockStub(&quot;ex03&quot;, scc)\nres := stub.MockInvoke(&quot;1&quot;, [][]byte{[]byte(&quot;query&quot;), []byte(&quot;A&quot;), []byte(&quot;345&quot;))\nif res.Status != shim.OK {\n    fmt.Println(&quot;Query failed&quot;, string(res.Message))\n    t.FailNow()\n}</code></pre></li>\n</ul>\n<p></p>\n<pre><code>scc := new(SimpleChaincode)\nstub := shim.NewMockStub(&quot;ex05&quot;, scc)\n\nccEx2 := new(ex02.SimpleChaincode)\nstubEx2 := shim.NewMockStub(chaincodeName, ccEx2)\ncheckInit(t, stubEx2, [][]byte{[]byte(&quot;init&quot;), []byte(&quot;a&quot;), []byte(&quot;222&quot;), []byte(&quot;b&quot;), []byte(&quot;333&quot;)})\n//peerchaincode\nstub.MockPeerChaincode(chaincodeName, stubEx2)</code></pre><p>Tutorials4tutorialApplication(node sdk)~</p>\n<p></p>\n<p>22peer1order</p>\n<p>clone fabric-exampledocker imagesdocker-imagescurl  | bash curl *.sh32docker images, 1binbin</p>\n<pre><code>$ ls\nconfigtxgen        configtxlator        cryptogen        get-docker-images.sh    orderer            peer</code></pre><p>binfabric-example</p>\n<pre><code>$ cd first-network\n$ ./byfn.sh -m generate</code></pre><p>binfabric-example..</p>\n<pre><code>$ ./byfn.sh -m up</code></pre><p>curl fabricscript/bootstrap.sh</p>\n<p>byfn~</p>\n<p>$ ./byfn.sh -m generate</p>\n<ul>\n<li><p>cryptogen/</p>\n<ul>\n<li>cryptogencrypto-config.yaml<pre><code>OrdererOrgs:\n  - Name: Orderer\n    Domain: example.com\n    # ---------------------------------------------------------------------------\n    # &quot;Specs&quot; - See PeerOrgs below for complete description\n    # ---------------------------------------------------------------------------\n    Specs:\n      - Hostname: orderer\nPeerOrgs:\n# -----------------------------------------------------\n# Org1\n# ----------------------------------------------------\n- Name: Org1\n  Domain: org1.example.com\n  Template:\n      Count: 2\n  Users:\n      Count: 1</code></pre>cryptogen generate config=./crypto-config.yamlcrypto-config,  /Domain/</li>\n</ul>\n</li>\n<li><p>configtxgen tool</p>\n<ul>\n<li>orderer genesis block, orderergensis.block</li>\n<li>channel configuration transaction, ordererchannelchannelchannel</li>\n<li>and two anchor peer transactions - one for each Peer Org. channelpeerpeer</li>\n</ul>\n</li>\n<li><p> up docker-compose -f $COMPOSE_FILE docker-compose-cli.yaml6cli, ./scripts/script.shchannelchannelchaincodechaincode..<br></p>\n<p>,  </p>\n<p>cli scriptscriptchannelpeer chaincode  </p>\n</li>\n</ul>\n"},{"title":"zilliqa_network","date":"2019-10-14T06:40:49.000Z","_content":"\n## Zilliqa\n\n[](https://docs.zilliqa.com/whitepaper.pdf)\n\n\n\n### \n\nZILLIQA(TX-Block)DS-BlockTX-BlockDS-BlockTX-BlockDS-BlockDS-BlockTX-Blocks\n\n...\n\n\n\n### \n\nZILLIQA\n\n#### \n\nDS\n\n- Directory Service Committee(DS)DSDSDSproof-of-work1\n\n  ```\n  //Algorithm 1: PoW1 for DS committee election.\n  Input: i: Current DS-epoch, DSi1: Prev. DS committee\n  composition.\n  Output: header: DS-Block header.\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r1  GetEpochRand(DBi1)\n  // get epoch randomness from the transaction blockchain\n  // TBj : Most recent TX-Block before start of i-th epoch\n   r2  GetEpochRand(TBj )\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)\n   header  BuildHeader(nonce, mixHash, pk)\n  // header includes pk and nonce among other fields\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi1(IP, header)\n   return header\n  ```\n\n  DS-BlockPOW11DSDS2fDSDS\n\n   DSn0n0DS-BlockDS\n\n  DS-BlockDS-epochDS-eposhDS-epochDSDSDS<u>(is churned out..)</u>DS-eposhDSn0DSleader,  DS\n\n  DSn0800n01/3\n\n- DS   DSnonce iDSmax(n)\n\n  DSleaderheaderDS-         Block header max(n)<u>iDSheader</u> DS-Block\n\n- DS PoW2 DS 2PoW2\n\n  ```\n  Algorithm 2: PoW2 for shard membership.\n  Input: i: Current DS-epoch, DSi: Current DS committee\n  composition.\n  Output: nonce, mixHash: outputs of Ethash-PoW\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r  GetEpochRand(DBi)\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r)\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi(nonce, mixHash, pk, IP)\n   return nonce, mixHash\n\n  ```\n\n  PoW2DS DSPoWLn0DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2\n  Shardingn0n0n0leadern08001/3\n\n#### \n\nDSDSV-D    DS2/3\n\n#### ZILLIQA\n\nPoW1DSPoW2 PoW1PoW2 DS\n\n#### \n\n  A -->BABnZIL\n\n- A -->B L0L-1(logL + 1)bitA160(bit)L**logL + 1  160**100\n\n   TX-Block\n\n    nonce  \n\n- TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS\n\n  :\n\n  1. DSEC-Schnorr 2/3n0\n  2. hash header \n  3. dataTX \n  4.  \n\n\n\n\n\n### \n\n\n\nDSDSDS\n\n##### \n\nZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT\n\nPBFT PBFT\n\n- :  TX-Block\n- \n- 2/3\\*n2/3\\*n \n\nPBFT  PBFT  2/3\\*n\n\n /PBFTOn*n\n\n\n\n##### \n\nPBFTMAC MACOn*n 20PBFT\n\nByzCoin\n\n- MACOn\n-  EC-SchnorrO1 - \n\nPBFTEC-Schnorr  PBFT2/3\\*n B. iB [i] = 10  B\n\n\n\n##### Zilliqa\n\nZILLIQAPBFTEC-SchnorrPBFT PBFT\n\n- : PBFTTX-Block\n- TX2/3\\*n  EC-Schnorr TX\n- 2/3\\*n2/3\\*nTX-BlockEC-Schnorr \n\nTX-Block\n\n\n\n##### \n\n  DS  \n\n DS nDS-epochn11\n","source":"_posts/zilliqa-network.md","raw":"---\ntitle: zilliqa_network\ncategories:\n  - zilliqa\ndate: 2019-10-14 14:40:49\ntags:\n---\n\n## Zilliqa\n\n[](https://docs.zilliqa.com/whitepaper.pdf)\n\n\n\n### \n\nZILLIQA(TX-Block)DS-BlockTX-BlockDS-BlockTX-BlockDS-BlockDS-BlockTX-Blocks\n\n...\n\n\n\n### \n\nZILLIQA\n\n#### \n\nDS\n\n- Directory Service Committee(DS)DSDSDSproof-of-work1\n\n  ```\n  //Algorithm 1: PoW1 for DS committee election.\n  Input: i: Current DS-epoch, DSi1: Prev. DS committee\n  composition.\n  Output: header: DS-Block header.\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r1  GetEpochRand(DBi1)\n  // get epoch randomness from the transaction blockchain\n  // TBj : Most recent TX-Block before start of i-th epoch\n   r2  GetEpochRand(TBj )\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)\n   header  BuildHeader(nonce, mixHash, pk)\n  // header includes pk and nonce among other fields\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi1(IP, header)\n   return header\n  ```\n\n  DS-BlockPOW11DSDS2fDSDS\n\n   DSn0n0DS-BlockDS\n\n  DS-BlockDS-epochDS-eposhDS-epochDSDSDS<u>(is churned out..)</u>DS-eposhDSn0DSleader,  DS\n\n  DSn0800n01/3\n\n- DS   DSnonce iDSmax(n)\n\n  DSleaderheaderDS-         Block header max(n)<u>iDSheader</u> DS-Block\n\n- DS PoW2 DS 2PoW2\n\n  ```\n  Algorithm 2: PoW2 for shard membership.\n  Input: i: Current DS-epoch, DSi: Current DS committee\n  composition.\n  Output: nonce, mixHash: outputs of Ethash-PoW\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r  GetEpochRand(DBi)\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r)\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi(nonce, mixHash, pk, IP)\n   return nonce, mixHash\n\n  ```\n\n  PoW2DS DSPoWLn0DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2\n  Shardingn0n0n0leadern08001/3\n\n#### \n\nDSDSV-D    DS2/3\n\n#### ZILLIQA\n\nPoW1DSPoW2 PoW1PoW2 DS\n\n#### \n\n  A -->BABnZIL\n\n- A -->B L0L-1(logL + 1)bitA160(bit)L**logL + 1  160**100\n\n   TX-Block\n\n    nonce  \n\n- TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS\n\n  :\n\n  1. DSEC-Schnorr 2/3n0\n  2. hash header \n  3. dataTX \n  4.  \n\n\n\n\n\n### \n\n\n\nDSDSDS\n\n##### \n\nZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT\n\nPBFT PBFT\n\n- :  TX-Block\n- \n- 2/3\\*n2/3\\*n \n\nPBFT  PBFT  2/3\\*n\n\n /PBFTOn*n\n\n\n\n##### \n\nPBFTMAC MACOn*n 20PBFT\n\nByzCoin\n\n- MACOn\n-  EC-SchnorrO1 - \n\nPBFTEC-Schnorr  PBFT2/3\\*n B. iB [i] = 10  B\n\n\n\n##### Zilliqa\n\nZILLIQAPBFTEC-SchnorrPBFT PBFT\n\n- : PBFTTX-Block\n- TX2/3\\*n  EC-Schnorr TX\n- 2/3\\*n2/3\\*nTX-BlockEC-Schnorr \n\nTX-Block\n\n\n\n##### \n\n  DS  \n\n DS nDS-epochn11\n","slug":"zilliqa-network","published":1,"updated":"2019-10-14T06:41:19.167Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69x8002gt6xvkj9hogtu","content":"<h2 id=\"Zilliqa\"><a href=\"#Zilliqa\" class=\"headerlink\" title=\"Zilliqa\"></a>Zilliqa</h2><p><a href=\"https://docs.zilliqa.com/whitepaper.pdf\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ZILLIQA(TX-Block)DS-BlockTX-BlockDS-BlockTX-BlockDS-BlockDS-BlockTX-Blocks</p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ZILLIQA</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DS</p>\n<ul>\n<li><p>Directory Service Committee(DS)DSDSDSproof-of-work1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Algorithm 1: PoW1 for DS committee election.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi1: Prev. DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: header: DS-Block header.</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r1  GetEpochRand(DBi1)</span><br><span class=\"line\">// get epoch randomness from the transaction blockchain</span><br><span class=\"line\">// TBj : Most recent TX-Block before start of i-th epoch</span><br><span class=\"line\"> r2  GetEpochRand(TBj )</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)</span><br><span class=\"line\"> header  BuildHeader(nonce, mixHash, pk)</span><br><span class=\"line\">// header includes pk and nonce among other fields</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi1(IP, header)</span><br><span class=\"line\"> return header</span><br></pre></td></tr></table></figure>\n\n<p>DS-BlockPOW11DSDS2fDSDS</p>\n<p> DSn0n0DS-BlockDS</p>\n<p>DS-BlockDS-epochDS-eposhDS-epochDSDSDS<u>(is churned out..)</u>DS-eposhDSn0DSleader,  DS</p>\n<p>DSn0800n01/3</p>\n</li>\n<li><p>DS   DSnonce iDSmax(n)</p>\n<p>DSleaderheaderDS-         Block header max(n)<u>iDSheader</u> DS-Block</p>\n</li>\n<li><p>DS PoW2 DS 2PoW2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Algorithm 2: PoW2 for shard membership.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi: Current DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: nonce, mixHash: outputs of Ethash-PoW</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r  GetEpochRand(DBi)</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r)</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi(nonce, mixHash, pk, IP)</span><br><span class=\"line\"> return nonce, mixHash</span><br></pre></td></tr></table></figure>\n\n<p>PoW2DS DSPoWLn0DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2<br>Shardingn0n0n0leadern08001/3</p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DSDSV-D    DS2/3</p>\n<h4 id=\"ZILLIQA\"><a href=\"#ZILLIQA\" class=\"headerlink\" title=\"ZILLIQA\"></a>ZILLIQA</h4><p>PoW1DSPoW2 PoW1PoW2 DS</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>  A --&gt;BABnZIL</p>\n<ul>\n<li><p>A --&gt;B L0L-1(logL + 1)bitA160(bit)L<strong>logL + 1  160</strong>100</p>\n<p> TX-Block</p>\n<p>  nonce  </p>\n</li>\n<li><p>TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS</p>\n<p>:</p>\n<ol>\n<li>DSEC-Schnorr 2/3n0</li>\n<li>hash header </li>\n<li>dataTX </li>\n<li> </li>\n</ol>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DSDSDS</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>ZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT</p>\n<p>PBFT PBFT</p>\n<ul>\n<li>:  TX-Block</li>\n<li></li>\n<li>2/3*n2/3*n </li>\n</ul>\n<p>PBFT  PBFT  2/3*n</p>\n<p> /PBFTOn*n</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>PBFTMAC MACOn*n 20PBFT</p>\n<p>ByzCoin</p>\n<ul>\n<li>MACOn</li>\n<li> EC-SchnorrO1 - </li>\n</ul>\n<p>PBFTEC-Schnorr  PBFT2/3*n B. iB [i] = 10  B</p>\n<h5 id=\"Zilliqa\"><a href=\"#Zilliqa\" class=\"headerlink\" title=\"Zilliqa\"></a>Zilliqa</h5><p>ZILLIQAPBFTEC-SchnorrPBFT PBFT</p>\n<ul>\n<li>: PBFTTX-Block</li>\n<li>TX2/3*n  EC-Schnorr TX</li>\n<li>2/3*n2/3*nTX-BlockEC-Schnorr </li>\n</ul>\n<p>TX-Block</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>  DS  </p>\n<p> DS nDS-epochn11</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Zilliqa\"><a href=\"#Zilliqa\" class=\"headerlink\" title=\"Zilliqa\"></a>Zilliqa</h2><p><a href=\"https://docs.zilliqa.com/whitepaper.pdf\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ZILLIQA(TX-Block)DS-BlockTX-BlockDS-BlockTX-BlockDS-BlockDS-BlockTX-Blocks</p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ZILLIQA</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DS</p>\n<ul>\n<li><p>Directory Service Committee(DS)DSDSDSproof-of-work1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Algorithm 1: PoW1 for DS committee election.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi1: Prev. DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: header: DS-Block header.</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r1  GetEpochRand(DBi1)</span><br><span class=\"line\">// get epoch randomness from the transaction blockchain</span><br><span class=\"line\">// TBj : Most recent TX-Block before start of i-th epoch</span><br><span class=\"line\"> r2  GetEpochRand(TBj )</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)</span><br><span class=\"line\"> header  BuildHeader(nonce, mixHash, pk)</span><br><span class=\"line\">// header includes pk and nonce among other fields</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi1(IP, header)</span><br><span class=\"line\"> return header</span><br></pre></td></tr></table></figure>\n\n<p>DS-BlockPOW11DSDS2fDSDS</p>\n<p> DSn0n0DS-BlockDS</p>\n<p>DS-BlockDS-epochDS-eposhDS-epochDSDSDS<u>(is churned out..)</u>DS-eposhDSn0DSleader,  DS</p>\n<p>DSn0800n01/3</p>\n</li>\n<li><p>DS   DSnonce iDSmax(n)</p>\n<p>DSleaderheaderDS-         Block header max(n)<u>iDSheader</u> DS-Block</p>\n</li>\n<li><p>DS PoW2 DS 2PoW2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Algorithm 2: PoW2 for shard membership.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi: Current DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: nonce, mixHash: outputs of Ethash-PoW</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r  GetEpochRand(DBi)</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r)</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi(nonce, mixHash, pk, IP)</span><br><span class=\"line\"> return nonce, mixHash</span><br></pre></td></tr></table></figure>\n\n<p>PoW2DS DSPoWLn0DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2<br>Shardingn0n0n0leadern08001/3</p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DSDSV-D    DS2/3</p>\n<h4 id=\"ZILLIQA\"><a href=\"#ZILLIQA\" class=\"headerlink\" title=\"ZILLIQA\"></a>ZILLIQA</h4><p>PoW1DSPoW2 PoW1PoW2 DS</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>  A --&gt;BABnZIL</p>\n<ul>\n<li><p>A --&gt;B L0L-1(logL + 1)bitA160(bit)L<strong>logL + 1  160</strong>100</p>\n<p> TX-Block</p>\n<p>  nonce  </p>\n</li>\n<li><p>TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS</p>\n<p>:</p>\n<ol>\n<li>DSEC-Schnorr 2/3n0</li>\n<li>hash header </li>\n<li>dataTX </li>\n<li> </li>\n</ol>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DSDSDS</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>ZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT</p>\n<p>PBFT PBFT</p>\n<ul>\n<li>:  TX-Block</li>\n<li></li>\n<li>2/3*n2/3*n </li>\n</ul>\n<p>PBFT  PBFT  2/3*n</p>\n<p> /PBFTOn*n</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>PBFTMAC MACOn*n 20PBFT</p>\n<p>ByzCoin</p>\n<ul>\n<li>MACOn</li>\n<li> EC-SchnorrO1 - </li>\n</ul>\n<p>PBFTEC-Schnorr  PBFT2/3*n B. iB [i] = 10  B</p>\n<h5 id=\"Zilliqa\"><a href=\"#Zilliqa\" class=\"headerlink\" title=\"Zilliqa\"></a>Zilliqa</h5><p>ZILLIQAPBFTEC-SchnorrPBFT PBFT</p>\n<ul>\n<li>: PBFTTX-Block</li>\n<li>TX2/3*n  EC-Schnorr TX</li>\n<li>2/3*n2/3*nTX-BlockEC-Schnorr </li>\n</ul>\n<p>TX-Block</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>  DS  </p>\n<p> DS nDS-epochn11</p>\n"},{"title":"dai","date":"2019-10-14T06:52:04.000Z","_content":"\n## dai\n\n#### \n\n[github](https://github.com/makerdao/dss)\n\n```\nsrc\n     cat.sol   //CDP\n     dai.sol   //Dai\n     end.sol  //\n     flap.sol  //MKR\n     flip.sol\n     flop.sol  //MKR\n     join.sol  //DAI(DAI? ETH)\n     jug.sol\n     lib.sol\n     pot.sol\n     spot.sol\n     test\n     vat.sol  //CDPDAI\n     vow.sol\n```\n\n\n\n#### \n\n##### \n\n- `guy``usr`\n- `wad`10 ^ 18\n- `ray`10 ^ 27\n- `rad`10 ^ 45\n- `file`\n\n##### (auth)\n\n- `auth`\n- `ward`authed\n- `rely`authedward\n- `deny`authedward\n\n##### CDP vat\n\n- `CDP`\n\n- `gem`map(byte32)map(address)uint256, \n\n- `dai`\n\n- `sin`antioin`urn`\n\n- `ilk`\n\n  - `rate`\n  - `take`\n  - `Ink` ?\n  - `Art`\n  - `spot`\n  - `line`\n  - `dust`CDP\n\n- `Line`\n\n- `init`\n\n- `urn`CDP\n\n  - `ink`\n  - `art`\n\n- `debt`\n\n- `vice`\n\n- `slip`(gem)\n\n- `flux`(gem)\n\n- `move`stablecoin\n\n- `grab`CDP(()())\n\n  ```\n    function grab(bytes32 i, address u, address v, address w, int dink, int dart) external note auth {\n          Urn storage urn = urns[i][u];\n          Ilk storage ilk = ilks[i];\n\n          urn.ink = add(urn.ink, dink);\n          urn.art = add(urn.art, dart);\n          ilk.Art = add(ilk.Art, dart);\n\n          int dtab = mul(ilk.rate, dart);\n\n          gem[i][v] = sub(gem[i][v], dink);\n          sin[w]    = sub(sin[w],    dtab);\n          vice      = sub(vice,      dtab);\n      }\n  ```\n\n- `heal`/`vice`\n\n- `fold`/?\n\n  ```\n    function fold(bytes32 i, address u, int rate) external note auth {\n          require(live == 1);\n          Ilk storage ilk = ilks[i];\n          ilk.rate = add(ilk.rate, rate);\n          int rad  = mul(ilk.Art, rate);\n          dai[u]   = add(dai[u], rad);\n          debt     = add(debt,   rad);\n      }\n  ```\n\n- `toll`/\n\n- `suck``vice`\n\n- `frob`CDP\n\n  - `lock`CDP\n  - `free`CDP\n  - `draw`CDPDai\n  - `wipe`CDPDai\n  - `dink`\n  - `dart`\n  - `calm`CDP\n  - `cool`\n  - `firm`\n  - `safe`CDP\n\n- `fork`CDP - /CDP\n\n  - `dink`\n  - `dart`\n\n- `wish`gemdai\n\n  - `hope``wish`\n  - `nope``wish`\n\n#####  jug\n\n- `duty`\n- `base`\n- `rho`\n- `drip`\n\n#####  cat\n\n- `mat`\n- `chop`\n- `lump`\n- `bite`CDP\n- `flip`CDP\n\n#####  vow\n\n- `sin`\n- `Sin`\n- `Woe`\n- `Ash`\n- `Awe`\n- `Joy`\n- `fess`\n- `flog`\n- `wait`\n- `heal`\n- `kiss`\n- `sump`\n- `bump`\n- `hump`\n\n#####  flop flip flap\n\n- `flip`\n- `flop`MKR)(MKR)\n- `flap`MKR)MKR\n- `lot`\n- `bid` `lot`\n- `tab`dai`flip`\n- `guy`\n- `gal`\n- `ttl`\n- `beg`\n- `tau`\n- `end`\n- `kick`\n- `tick`\n- `tend`\n- `dent`\n- `deal`\n\n#####   end\n\n- `when`\n- `wait`CDP`skim`med\n- `debt`/\n- `tag`\n- `gap`CDP\n- `fix``ilk`\n- `bag`\n- `out`\n- `cage``flip`/ `flop`\n- `cage(ilk)`\n- `skim`CDP\n- `skip`\n- `free`CDP\n- `thaw`\n- `flow``fix``cage`/\n- `pack``bag``cash`\n- `cash``bag``gem``bag`\n\n#### \n\n##### \n\nMaker  user case DAI\n\n DAI \n\n MKR \n\n##### \n\n Maker  DAI DAI DAI  DAI  DAI  11 \n\n MKR MakerMKR  MKR  DAI MKR  MKR \n\n\n\n##### \n\n DAICDP DAI DAI  DAI DAI \n\n DAI  DAI  DAI \n\nCDP  DAI DAI  margin call()\n\n pooled-ETH\n\n\n\n ETH  ETH PETHPETH  ETH \n\n CDP  PETH PETH  PETH  ETH PETH DAI PETH\n\n\n\n DAI  PETH  DAI  DAI\n\n CDP  PETH MKR\n\n\n\n##### \n\n![img](https://img.chainnews.com/material/images/a527abfe7199a3eb00887ea7f13e8293.jpg)\n\n- \n\n   PETH  Maker Maker\n\n\n\n- \n\n   CDP   Dai Dai  Dai CDP CDP \n\n  - \n\n    PETH  Dai  PETH Dai CDP  CDP  Dai Dai PETH PETH  ETH  PETH \n\n  - \n\n     PETH  Dai  PETH PETH  PETH ETH  PETH \n\n  Maker  CDP  CDP CDP  Dai  CDP  MKR\n\n  CDP CDP  MKRMKR Dai  CDP  - CDP \n\n\n\n-  ()\n\n   Dai  CDPCDP \n\n  PETH  Dai  PETH Dai  CDP CDP  Dai Dai  PETH  PETH  ETH PETH \n\n   PETH  Dai  PETH PETH  PETH ETH  PETH \n\n\n\n- \n\n  Maker  CDP \n\n   CDP CDP  Dai  CDP  MKRCDP CDP  MKR  MKR Dai  CDP  -  CDP\n\n\n\n- \n\n   Keeper  CDP LPC LPC  Dai Dashboard  CDP PETH  CDP \n\n  \n\n  -  CDP \n  -  DAI \n  - LPC  PETH  Oracle \n  - CDP \n  -  PETH  dai.makerdao.com  Boom / Bust Spread \n  -  PETH  DAI  CDP \n  -  DAI  PETH  PETH \n  -  DAI  PETH \n\n\n\n- \n\n  \n\n  ```\n    Oracle   PETH / ETH  -    -  = Oracle  DAI\n\n  ```\n\n  \n\n  -  ETH  Oracle  350USD\n\n  -  PETH  10 ETH\n\n  - PETH / ETH  1.012\n\n  -  13\n\n  - CDP  1000 DAI\n\n    (10  350  1.012)  (13%  1000)  1000 = 2412 DAI  6.891428571 ETH\n\n\n\n- \n\n  \n\n  ```\n    /  PETH / ETH = \n  ```\n\n  \n\n  -  ETH  350 USD\n\n  -  PETH  12\n\n  - PETH / ETH  1.012\n\n  -  150\n\n  -  1000 DAI\n\n    (1000  1.5)  (12  1.012) = 123.51 USD\n\n     CDP ETH  123.51 \n\n\n\n- \n\n  \n\n  ```\n   PETH  ETH   PETH / ETH    100 = \n  ```\n\n  \n\n  -  ETH  350 USD\n  -  PETH  12\n  - PETH / ETH  1.012\n  -  1000 DAI\n\n  (12  350  1.012)  1000  100 = 425.04%\n\n  CDP  425.04\n\n\n\n- \n\n  CDP  CDP  DAI DAI CDP  DAI \n\n  \n\n  -  ETH  350 USD\n  -  PETH  12\n  - PETH / ETH  1.012\n  -  150\n  -  1000 DAI\n\n  \n\n  (1000  1.5 )  (12  1.012) = 123.51 USD\n\n   700 \n\n  (1000  1.5 )  (14  1.012) = 105.87 USD\n\n   700 \n\n  (300  1.5 )  (12  1.012) = 37.05 USD\n\n   DAI \n\n\n\n- \n\n   Keeper  CDP LPC Dai Dashboard Oracle Feed LPC  PETH  DAI  PETH \n","source":"_posts/dai.md","raw":"---\ntitle: dai\ncategories:\n  - eth\ndate: 2019-10-14 14:52:04\ntags:\n---\n\n## dai\n\n#### \n\n[github](https://github.com/makerdao/dss)\n\n```\nsrc\n     cat.sol   //CDP\n     dai.sol   //Dai\n     end.sol  //\n     flap.sol  //MKR\n     flip.sol\n     flop.sol  //MKR\n     join.sol  //DAI(DAI? ETH)\n     jug.sol\n     lib.sol\n     pot.sol\n     spot.sol\n     test\n     vat.sol  //CDPDAI\n     vow.sol\n```\n\n\n\n#### \n\n##### \n\n- `guy``usr`\n- `wad`10 ^ 18\n- `ray`10 ^ 27\n- `rad`10 ^ 45\n- `file`\n\n##### (auth)\n\n- `auth`\n- `ward`authed\n- `rely`authedward\n- `deny`authedward\n\n##### CDP vat\n\n- `CDP`\n\n- `gem`map(byte32)map(address)uint256, \n\n- `dai`\n\n- `sin`antioin`urn`\n\n- `ilk`\n\n  - `rate`\n  - `take`\n  - `Ink` ?\n  - `Art`\n  - `spot`\n  - `line`\n  - `dust`CDP\n\n- `Line`\n\n- `init`\n\n- `urn`CDP\n\n  - `ink`\n  - `art`\n\n- `debt`\n\n- `vice`\n\n- `slip`(gem)\n\n- `flux`(gem)\n\n- `move`stablecoin\n\n- `grab`CDP(()())\n\n  ```\n    function grab(bytes32 i, address u, address v, address w, int dink, int dart) external note auth {\n          Urn storage urn = urns[i][u];\n          Ilk storage ilk = ilks[i];\n\n          urn.ink = add(urn.ink, dink);\n          urn.art = add(urn.art, dart);\n          ilk.Art = add(ilk.Art, dart);\n\n          int dtab = mul(ilk.rate, dart);\n\n          gem[i][v] = sub(gem[i][v], dink);\n          sin[w]    = sub(sin[w],    dtab);\n          vice      = sub(vice,      dtab);\n      }\n  ```\n\n- `heal`/`vice`\n\n- `fold`/?\n\n  ```\n    function fold(bytes32 i, address u, int rate) external note auth {\n          require(live == 1);\n          Ilk storage ilk = ilks[i];\n          ilk.rate = add(ilk.rate, rate);\n          int rad  = mul(ilk.Art, rate);\n          dai[u]   = add(dai[u], rad);\n          debt     = add(debt,   rad);\n      }\n  ```\n\n- `toll`/\n\n- `suck``vice`\n\n- `frob`CDP\n\n  - `lock`CDP\n  - `free`CDP\n  - `draw`CDPDai\n  - `wipe`CDPDai\n  - `dink`\n  - `dart`\n  - `calm`CDP\n  - `cool`\n  - `firm`\n  - `safe`CDP\n\n- `fork`CDP - /CDP\n\n  - `dink`\n  - `dart`\n\n- `wish`gemdai\n\n  - `hope``wish`\n  - `nope``wish`\n\n#####  jug\n\n- `duty`\n- `base`\n- `rho`\n- `drip`\n\n#####  cat\n\n- `mat`\n- `chop`\n- `lump`\n- `bite`CDP\n- `flip`CDP\n\n#####  vow\n\n- `sin`\n- `Sin`\n- `Woe`\n- `Ash`\n- `Awe`\n- `Joy`\n- `fess`\n- `flog`\n- `wait`\n- `heal`\n- `kiss`\n- `sump`\n- `bump`\n- `hump`\n\n#####  flop flip flap\n\n- `flip`\n- `flop`MKR)(MKR)\n- `flap`MKR)MKR\n- `lot`\n- `bid` `lot`\n- `tab`dai`flip`\n- `guy`\n- `gal`\n- `ttl`\n- `beg`\n- `tau`\n- `end`\n- `kick`\n- `tick`\n- `tend`\n- `dent`\n- `deal`\n\n#####   end\n\n- `when`\n- `wait`CDP`skim`med\n- `debt`/\n- `tag`\n- `gap`CDP\n- `fix``ilk`\n- `bag`\n- `out`\n- `cage``flip`/ `flop`\n- `cage(ilk)`\n- `skim`CDP\n- `skip`\n- `free`CDP\n- `thaw`\n- `flow``fix``cage`/\n- `pack``bag``cash`\n- `cash``bag``gem``bag`\n\n#### \n\n##### \n\nMaker  user case DAI\n\n DAI \n\n MKR \n\n##### \n\n Maker  DAI DAI DAI  DAI  DAI  11 \n\n MKR MakerMKR  MKR  DAI MKR  MKR \n\n\n\n##### \n\n DAICDP DAI DAI  DAI DAI \n\n DAI  DAI  DAI \n\nCDP  DAI DAI  margin call()\n\n pooled-ETH\n\n\n\n ETH  ETH PETHPETH  ETH \n\n CDP  PETH PETH  PETH  ETH PETH DAI PETH\n\n\n\n DAI  PETH  DAI  DAI\n\n CDP  PETH MKR\n\n\n\n##### \n\n![img](https://img.chainnews.com/material/images/a527abfe7199a3eb00887ea7f13e8293.jpg)\n\n- \n\n   PETH  Maker Maker\n\n\n\n- \n\n   CDP   Dai Dai  Dai CDP CDP \n\n  - \n\n    PETH  Dai  PETH Dai CDP  CDP  Dai Dai PETH PETH  ETH  PETH \n\n  - \n\n     PETH  Dai  PETH PETH  PETH ETH  PETH \n\n  Maker  CDP  CDP CDP  Dai  CDP  MKR\n\n  CDP CDP  MKRMKR Dai  CDP  - CDP \n\n\n\n-  ()\n\n   Dai  CDPCDP \n\n  PETH  Dai  PETH Dai  CDP CDP  Dai Dai  PETH  PETH  ETH PETH \n\n   PETH  Dai  PETH PETH  PETH ETH  PETH \n\n\n\n- \n\n  Maker  CDP \n\n   CDP CDP  Dai  CDP  MKRCDP CDP  MKR  MKR Dai  CDP  -  CDP\n\n\n\n- \n\n   Keeper  CDP LPC LPC  Dai Dashboard  CDP PETH  CDP \n\n  \n\n  -  CDP \n  -  DAI \n  - LPC  PETH  Oracle \n  - CDP \n  -  PETH  dai.makerdao.com  Boom / Bust Spread \n  -  PETH  DAI  CDP \n  -  DAI  PETH  PETH \n  -  DAI  PETH \n\n\n\n- \n\n  \n\n  ```\n    Oracle   PETH / ETH  -    -  = Oracle  DAI\n\n  ```\n\n  \n\n  -  ETH  Oracle  350USD\n\n  -  PETH  10 ETH\n\n  - PETH / ETH  1.012\n\n  -  13\n\n  - CDP  1000 DAI\n\n    (10  350  1.012)  (13%  1000)  1000 = 2412 DAI  6.891428571 ETH\n\n\n\n- \n\n  \n\n  ```\n    /  PETH / ETH = \n  ```\n\n  \n\n  -  ETH  350 USD\n\n  -  PETH  12\n\n  - PETH / ETH  1.012\n\n  -  150\n\n  -  1000 DAI\n\n    (1000  1.5)  (12  1.012) = 123.51 USD\n\n     CDP ETH  123.51 \n\n\n\n- \n\n  \n\n  ```\n   PETH  ETH   PETH / ETH    100 = \n  ```\n\n  \n\n  -  ETH  350 USD\n  -  PETH  12\n  - PETH / ETH  1.012\n  -  1000 DAI\n\n  (12  350  1.012)  1000  100 = 425.04%\n\n  CDP  425.04\n\n\n\n- \n\n  CDP  CDP  DAI DAI CDP  DAI \n\n  \n\n  -  ETH  350 USD\n  -  PETH  12\n  - PETH / ETH  1.012\n  -  150\n  -  1000 DAI\n\n  \n\n  (1000  1.5 )  (12  1.012) = 123.51 USD\n\n   700 \n\n  (1000  1.5 )  (14  1.012) = 105.87 USD\n\n   700 \n\n  (300  1.5 )  (12  1.012) = 37.05 USD\n\n   DAI \n\n\n\n- \n\n   Keeper  CDP LPC Dai Dashboard Oracle Feed LPC  PETH  DAI  PETH \n","slug":"dai","published":1,"updated":"2019-10-14T06:52:45.726Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69xm002mt6xvlj9v35rq","content":"<h2 id=\"dai\"><a href=\"#dai\" class=\"headerlink\" title=\"dai\"></a>dai</h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://github.com/makerdao/dss\">github</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">src</span><br><span class=\"line\">     cat.sol   //CDP</span><br><span class=\"line\">     dai.sol   //Dai</span><br><span class=\"line\">     end.sol  //</span><br><span class=\"line\">     flap.sol  //MKR</span><br><span class=\"line\">     flip.sol</span><br><span class=\"line\">     flop.sol  //MKR</span><br><span class=\"line\">     join.sol  //DAI(DAI? ETH)</span><br><span class=\"line\">     jug.sol</span><br><span class=\"line\">     lib.sol</span><br><span class=\"line\">     pot.sol</span><br><span class=\"line\">     spot.sol</span><br><span class=\"line\">     test</span><br><span class=\"line\">     vat.sol  //CDPDAI</span><br><span class=\"line\">     vow.sol</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li><code>guy</code><code>usr</code></li>\n<li><code>wad</code>10 ^ 18</li>\n<li><code>ray</code>10 ^ 27</li>\n<li><code>rad</code>10 ^ 45</li>\n<li><code>file</code></li>\n</ul>\n<h5 id=\"-auth\"><a href=\"#-auth\" class=\"headerlink\" title=\"(auth)\"></a>(auth)</h5><ul>\n<li><code>auth</code></li>\n<li><code>ward</code>authed</li>\n<li><code>rely</code>authedward</li>\n<li><code>deny</code>authedward</li>\n</ul>\n<h5 id=\"CDP-vat\"><a href=\"#CDP-vat\" class=\"headerlink\" title=\"CDP vat\"></a>CDP vat</h5><ul>\n<li><p><code>CDP</code></p>\n</li>\n<li><p><code>gem</code>map(byte32)map(address)uint256, </p>\n</li>\n<li><p><code>dai</code></p>\n</li>\n<li><p><code>sin</code>antioin<code>urn</code></p>\n</li>\n<li><p><code>ilk</code></p>\n<ul>\n<li><code>rate</code></li>\n<li><code>take</code></li>\n<li><code>Ink</code> ?</li>\n<li><code>Art</code></li>\n<li><code>spot</code></li>\n<li><code>line</code></li>\n<li><code>dust</code>CDP</li>\n</ul>\n</li>\n<li><p><code>Line</code></p>\n</li>\n<li><p><code>init</code></p>\n</li>\n<li><p><code>urn</code>CDP</p>\n<ul>\n<li><code>ink</code></li>\n<li><code>art</code></li>\n</ul>\n</li>\n<li><p><code>debt</code></p>\n</li>\n<li><p><code>vice</code></p>\n</li>\n<li><p><code>slip</code>(gem)</p>\n</li>\n<li><p><code>flux</code>(gem)</p>\n</li>\n<li><p><code>move</code>stablecoin</p>\n</li>\n<li><p><code>grab</code>CDP(()())</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function grab(bytes32 i, address u, address v, address w, int dink, int dart) external note auth &#123;</span><br><span class=\"line\">      Urn storage urn = urns[i][u];</span><br><span class=\"line\">      Ilk storage ilk = ilks[i];</span><br><span class=\"line\"></span><br><span class=\"line\">      urn.ink = add(urn.ink, dink);</span><br><span class=\"line\">      urn.art = add(urn.art, dart);</span><br><span class=\"line\">      ilk.Art = add(ilk.Art, dart);</span><br><span class=\"line\"></span><br><span class=\"line\">      int dtab = mul(ilk.rate, dart);</span><br><span class=\"line\"></span><br><span class=\"line\">      gem[i][v] = sub(gem[i][v], dink);</span><br><span class=\"line\">      sin[w]    = sub(sin[w],    dtab);</span><br><span class=\"line\">      vice      = sub(vice,      dtab);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>heal</code>/<code>vice</code></p>\n</li>\n<li><p><code>fold</code>/?</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function fold(bytes32 i, address u, int rate) external note auth &#123;</span><br><span class=\"line\">      require(live == 1);</span><br><span class=\"line\">      Ilk storage ilk = ilks[i];</span><br><span class=\"line\">      ilk.rate = add(ilk.rate, rate);</span><br><span class=\"line\">      int rad  = mul(ilk.Art, rate);</span><br><span class=\"line\">      dai[u]   = add(dai[u], rad);</span><br><span class=\"line\">      debt     = add(debt,   rad);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>toll</code>/</p>\n</li>\n<li><p><code>suck</code><code>vice</code></p>\n</li>\n<li><p><code>frob</code>CDP</p>\n<ul>\n<li><code>lock</code>CDP</li>\n<li><code>free</code>CDP</li>\n<li><code>draw</code>CDPDai</li>\n<li><code>wipe</code>CDPDai</li>\n<li><code>dink</code></li>\n<li><code>dart</code></li>\n<li><code>calm</code>CDP</li>\n<li><code>cool</code></li>\n<li><code>firm</code></li>\n<li><code>safe</code>CDP</li>\n</ul>\n</li>\n<li><p><code>fork</code>CDP - /CDP</p>\n<ul>\n<li><code>dink</code></li>\n<li><code>dart</code></li>\n</ul>\n</li>\n<li><p><code>wish</code>gemdai</p>\n<ul>\n<li><code>hope</code><code>wish</code></li>\n<li><code>nope</code><code>wish</code></li>\n</ul>\n</li>\n</ul>\n<h5 id=\"-jug\"><a href=\"#-jug\" class=\"headerlink\" title=\" jug\"></a> jug</h5><ul>\n<li><code>duty</code></li>\n<li><code>base</code></li>\n<li><code>rho</code></li>\n<li><code>drip</code></li>\n</ul>\n<h5 id=\"-cat\"><a href=\"#-cat\" class=\"headerlink\" title=\" cat\"></a> cat</h5><ul>\n<li><code>mat</code></li>\n<li><code>chop</code></li>\n<li><code>lump</code></li>\n<li><code>bite</code>CDP</li>\n<li><code>flip</code>CDP</li>\n</ul>\n<h5 id=\"-vow\"><a href=\"#-vow\" class=\"headerlink\" title=\" vow\"></a> vow</h5><ul>\n<li><code>sin</code></li>\n<li><code>Sin</code></li>\n<li><code>Woe</code></li>\n<li><code>Ash</code></li>\n<li><code>Awe</code></li>\n<li><code>Joy</code></li>\n<li><code>fess</code></li>\n<li><code>flog</code></li>\n<li><code>wait</code></li>\n<li><code>heal</code></li>\n<li><code>kiss</code></li>\n<li><code>sump</code></li>\n<li><code>bump</code></li>\n<li><code>hump</code></li>\n</ul>\n<h5 id=\"-flop-flip-flap\"><a href=\"#-flop-flip-flap\" class=\"headerlink\" title=\" flop flip flap\"></a> flop flip flap</h5><ul>\n<li><code>flip</code></li>\n<li><code>flop</code>MKR)(MKR)</li>\n<li><code>flap</code>MKR)MKR</li>\n<li><code>lot</code></li>\n<li><code>bid</code> <code>lot</code></li>\n<li><code>tab</code>dai<code>flip</code></li>\n<li><code>guy</code></li>\n<li><code>gal</code></li>\n<li><code>ttl</code></li>\n<li><code>beg</code></li>\n<li><code>tau</code></li>\n<li><code>end</code></li>\n<li><code>kick</code></li>\n<li><code>tick</code></li>\n<li><code>tend</code></li>\n<li><code>dent</code></li>\n<li><code>deal</code></li>\n</ul>\n<h5 id=\"-end\"><a href=\"#-end\" class=\"headerlink\" title=\"  end\"></a>  end</h5><ul>\n<li><code>when</code></li>\n<li><code>wait</code>CDP<code>skim</code>med</li>\n<li><code>debt</code>/</li>\n<li><code>tag</code></li>\n<li><code>gap</code>CDP</li>\n<li><code>fix</code><code>ilk</code></li>\n<li><code>bag</code></li>\n<li><code>out</code></li>\n<li><code>cage</code><code>flip</code>/ <code>flop</code></li>\n<li><code>cage(ilk)</code></li>\n<li><code>skim</code>CDP</li>\n<li><code>skip</code></li>\n<li><code>free</code>CDP</li>\n<li><code>thaw</code></li>\n<li><code>flow</code><code>fix</code><code>cage</code>/</li>\n<li><code>pack</code><code>bag</code><code>cash</code></li>\n<li><code>cash</code><code>bag</code><code>gem</code><code>bag</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>Maker  user case DAI</p>\n<p> DAI </p>\n<p> MKR </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p> Maker  DAI DAI DAI  DAI  DAI  11 </p>\n<p> MKR MakerMKR  MKR  DAI MKR  MKR </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p> DAICDP DAI DAI  DAI DAI </p>\n<p> DAI  DAI  DAI </p>\n<p>CDP  DAI DAI  margin call()</p>\n<p> pooled-ETH</p>\n<p> ETH  ETH PETHPETH  ETH </p>\n<p> CDP  PETH PETH  PETH  ETH PETH DAI PETH</p>\n<p> DAI  PETH  DAI  DAI</p>\n<p> CDP  PETH MKR</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p><img src=\"https://img.chainnews.com/material/images/a527abfe7199a3eb00887ea7f13e8293.jpg\" alt=\"img\"></p>\n<ul>\n<li><p></p>\n<p> PETH  Maker Maker</p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p> CDP   Dai Dai  Dai CDP CDP </p>\n<ul>\n<li><p></p>\n<p>PETH  Dai  PETH Dai CDP  CDP  Dai Dai PETH PETH  ETH  PETH </p>\n</li>\n<li><p></p>\n<p> PETH  Dai  PETH PETH  PETH ETH  PETH </p>\n</li>\n</ul>\n<p>Maker  CDP  CDP CDP  Dai  CDP  MKR</p>\n<p>CDP CDP  MKRMKR Dai  CDP  - CDP </p>\n</li>\n</ul>\n<ul>\n<li><p> ()</p>\n<p> Dai  CDPCDP </p>\n<p>PETH  Dai  PETH Dai  CDP CDP  Dai Dai  PETH  PETH  ETH PETH </p>\n<p> PETH  Dai  PETH PETH  PETH ETH  PETH </p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p>Maker  CDP </p>\n<p> CDP CDP  Dai  CDP  MKRCDP CDP  MKR  MKR Dai  CDP  -  CDP</p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p> Keeper  CDP LPC LPC  Dai Dashboard  CDP PETH  CDP </p>\n<p></p>\n<ul>\n<li> CDP </li>\n<li> DAI </li>\n<li>LPC  PETH  Oracle </li>\n<li>CDP </li>\n<li> PETH  dai.makerdao.com  Boom / Bust Spread </li>\n<li> PETH  DAI  CDP </li>\n<li> DAI  PETH  PETH </li>\n<li> DAI  PETH </li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  Oracle   PETH / ETH  -    -  = Oracle  DAI</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p> ETH  Oracle  350USD</p>\n</li>\n<li><p> PETH  10 ETH</p>\n</li>\n<li><p>PETH / ETH  1.012</p>\n</li>\n<li><p> 13</p>\n</li>\n<li><p>CDP  1000 DAI</p>\n<p>(10  350  1.012)  (13%  1000)  1000 = 2412 DAI  6.891428571 ETH</p>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  /  PETH / ETH = </span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p> ETH  350 USD</p>\n</li>\n<li><p> PETH  12</p>\n</li>\n<li><p>PETH / ETH  1.012</p>\n</li>\n<li><p> 150</p>\n</li>\n<li><p> 1000 DAI</p>\n<p>(1000  1.5)  (12  1.012) = 123.51 USD</p>\n<p> CDP ETH  123.51 </p>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> PETH  ETH   PETH / ETH    100 = </span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li> ETH  350 USD</li>\n<li> PETH  12</li>\n<li>PETH / ETH  1.012</li>\n<li> 1000 DAI</li>\n</ul>\n<p>(12  350  1.012)  1000  100 = 425.04%</p>\n<p>CDP  425.04</p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p>CDP  CDP  DAI DAI CDP  DAI </p>\n<p></p>\n<ul>\n<li> ETH  350 USD</li>\n<li> PETH  12</li>\n<li>PETH / ETH  1.012</li>\n<li> 150</li>\n<li> 1000 DAI</li>\n</ul>\n<p></p>\n<p>(1000  1.5 )  (12  1.012) = 123.51 USD</p>\n<p> 700 </p>\n<p>(1000  1.5 )  (14  1.012) = 105.87 USD</p>\n<p> 700 </p>\n<p>(300  1.5 )  (12  1.012) = 37.05 USD</p>\n<p> DAI </p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p> Keeper  CDP LPC Dai Dashboard Oracle Feed LPC  PETH  DAI  PETH </p>\n</li>\n</ul>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"dai\"><a href=\"#dai\" class=\"headerlink\" title=\"dai\"></a>dai</h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://github.com/makerdao/dss\">github</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">src</span><br><span class=\"line\">     cat.sol   //CDP</span><br><span class=\"line\">     dai.sol   //Dai</span><br><span class=\"line\">     end.sol  //</span><br><span class=\"line\">     flap.sol  //MKR</span><br><span class=\"line\">     flip.sol</span><br><span class=\"line\">     flop.sol  //MKR</span><br><span class=\"line\">     join.sol  //DAI(DAI? ETH)</span><br><span class=\"line\">     jug.sol</span><br><span class=\"line\">     lib.sol</span><br><span class=\"line\">     pot.sol</span><br><span class=\"line\">     spot.sol</span><br><span class=\"line\">     test</span><br><span class=\"line\">     vat.sol  //CDPDAI</span><br><span class=\"line\">     vow.sol</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><ul>\n<li><code>guy</code><code>usr</code></li>\n<li><code>wad</code>10 ^ 18</li>\n<li><code>ray</code>10 ^ 27</li>\n<li><code>rad</code>10 ^ 45</li>\n<li><code>file</code></li>\n</ul>\n<h5 id=\"-auth\"><a href=\"#-auth\" class=\"headerlink\" title=\"(auth)\"></a>(auth)</h5><ul>\n<li><code>auth</code></li>\n<li><code>ward</code>authed</li>\n<li><code>rely</code>authedward</li>\n<li><code>deny</code>authedward</li>\n</ul>\n<h5 id=\"CDP-vat\"><a href=\"#CDP-vat\" class=\"headerlink\" title=\"CDP vat\"></a>CDP vat</h5><ul>\n<li><p><code>CDP</code></p>\n</li>\n<li><p><code>gem</code>map(byte32)map(address)uint256, </p>\n</li>\n<li><p><code>dai</code></p>\n</li>\n<li><p><code>sin</code>antioin<code>urn</code></p>\n</li>\n<li><p><code>ilk</code></p>\n<ul>\n<li><code>rate</code></li>\n<li><code>take</code></li>\n<li><code>Ink</code> ?</li>\n<li><code>Art</code></li>\n<li><code>spot</code></li>\n<li><code>line</code></li>\n<li><code>dust</code>CDP</li>\n</ul>\n</li>\n<li><p><code>Line</code></p>\n</li>\n<li><p><code>init</code></p>\n</li>\n<li><p><code>urn</code>CDP</p>\n<ul>\n<li><code>ink</code></li>\n<li><code>art</code></li>\n</ul>\n</li>\n<li><p><code>debt</code></p>\n</li>\n<li><p><code>vice</code></p>\n</li>\n<li><p><code>slip</code>(gem)</p>\n</li>\n<li><p><code>flux</code>(gem)</p>\n</li>\n<li><p><code>move</code>stablecoin</p>\n</li>\n<li><p><code>grab</code>CDP(()())</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function grab(bytes32 i, address u, address v, address w, int dink, int dart) external note auth &#123;</span><br><span class=\"line\">      Urn storage urn = urns[i][u];</span><br><span class=\"line\">      Ilk storage ilk = ilks[i];</span><br><span class=\"line\"></span><br><span class=\"line\">      urn.ink = add(urn.ink, dink);</span><br><span class=\"line\">      urn.art = add(urn.art, dart);</span><br><span class=\"line\">      ilk.Art = add(ilk.Art, dart);</span><br><span class=\"line\"></span><br><span class=\"line\">      int dtab = mul(ilk.rate, dart);</span><br><span class=\"line\"></span><br><span class=\"line\">      gem[i][v] = sub(gem[i][v], dink);</span><br><span class=\"line\">      sin[w]    = sub(sin[w],    dtab);</span><br><span class=\"line\">      vice      = sub(vice,      dtab);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>heal</code>/<code>vice</code></p>\n</li>\n<li><p><code>fold</code>/?</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function fold(bytes32 i, address u, int rate) external note auth &#123;</span><br><span class=\"line\">      require(live == 1);</span><br><span class=\"line\">      Ilk storage ilk = ilks[i];</span><br><span class=\"line\">      ilk.rate = add(ilk.rate, rate);</span><br><span class=\"line\">      int rad  = mul(ilk.Art, rate);</span><br><span class=\"line\">      dai[u]   = add(dai[u], rad);</span><br><span class=\"line\">      debt     = add(debt,   rad);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>toll</code>/</p>\n</li>\n<li><p><code>suck</code><code>vice</code></p>\n</li>\n<li><p><code>frob</code>CDP</p>\n<ul>\n<li><code>lock</code>CDP</li>\n<li><code>free</code>CDP</li>\n<li><code>draw</code>CDPDai</li>\n<li><code>wipe</code>CDPDai</li>\n<li><code>dink</code></li>\n<li><code>dart</code></li>\n<li><code>calm</code>CDP</li>\n<li><code>cool</code></li>\n<li><code>firm</code></li>\n<li><code>safe</code>CDP</li>\n</ul>\n</li>\n<li><p><code>fork</code>CDP - /CDP</p>\n<ul>\n<li><code>dink</code></li>\n<li><code>dart</code></li>\n</ul>\n</li>\n<li><p><code>wish</code>gemdai</p>\n<ul>\n<li><code>hope</code><code>wish</code></li>\n<li><code>nope</code><code>wish</code></li>\n</ul>\n</li>\n</ul>\n<h5 id=\"-jug\"><a href=\"#-jug\" class=\"headerlink\" title=\" jug\"></a> jug</h5><ul>\n<li><code>duty</code></li>\n<li><code>base</code></li>\n<li><code>rho</code></li>\n<li><code>drip</code></li>\n</ul>\n<h5 id=\"-cat\"><a href=\"#-cat\" class=\"headerlink\" title=\" cat\"></a> cat</h5><ul>\n<li><code>mat</code></li>\n<li><code>chop</code></li>\n<li><code>lump</code></li>\n<li><code>bite</code>CDP</li>\n<li><code>flip</code>CDP</li>\n</ul>\n<h5 id=\"-vow\"><a href=\"#-vow\" class=\"headerlink\" title=\" vow\"></a> vow</h5><ul>\n<li><code>sin</code></li>\n<li><code>Sin</code></li>\n<li><code>Woe</code></li>\n<li><code>Ash</code></li>\n<li><code>Awe</code></li>\n<li><code>Joy</code></li>\n<li><code>fess</code></li>\n<li><code>flog</code></li>\n<li><code>wait</code></li>\n<li><code>heal</code></li>\n<li><code>kiss</code></li>\n<li><code>sump</code></li>\n<li><code>bump</code></li>\n<li><code>hump</code></li>\n</ul>\n<h5 id=\"-flop-flip-flap\"><a href=\"#-flop-flip-flap\" class=\"headerlink\" title=\" flop flip flap\"></a> flop flip flap</h5><ul>\n<li><code>flip</code></li>\n<li><code>flop</code>MKR)(MKR)</li>\n<li><code>flap</code>MKR)MKR</li>\n<li><code>lot</code></li>\n<li><code>bid</code> <code>lot</code></li>\n<li><code>tab</code>dai<code>flip</code></li>\n<li><code>guy</code></li>\n<li><code>gal</code></li>\n<li><code>ttl</code></li>\n<li><code>beg</code></li>\n<li><code>tau</code></li>\n<li><code>end</code></li>\n<li><code>kick</code></li>\n<li><code>tick</code></li>\n<li><code>tend</code></li>\n<li><code>dent</code></li>\n<li><code>deal</code></li>\n</ul>\n<h5 id=\"-end\"><a href=\"#-end\" class=\"headerlink\" title=\"  end\"></a>  end</h5><ul>\n<li><code>when</code></li>\n<li><code>wait</code>CDP<code>skim</code>med</li>\n<li><code>debt</code>/</li>\n<li><code>tag</code></li>\n<li><code>gap</code>CDP</li>\n<li><code>fix</code><code>ilk</code></li>\n<li><code>bag</code></li>\n<li><code>out</code></li>\n<li><code>cage</code><code>flip</code>/ <code>flop</code></li>\n<li><code>cage(ilk)</code></li>\n<li><code>skim</code>CDP</li>\n<li><code>skip</code></li>\n<li><code>free</code>CDP</li>\n<li><code>thaw</code></li>\n<li><code>flow</code><code>fix</code><code>cage</code>/</li>\n<li><code>pack</code><code>bag</code><code>cash</code></li>\n<li><code>cash</code><code>bag</code><code>gem</code><code>bag</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>Maker  user case DAI</p>\n<p> DAI </p>\n<p> MKR </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p> Maker  DAI DAI DAI  DAI  DAI  11 </p>\n<p> MKR MakerMKR  MKR  DAI MKR  MKR </p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p> DAICDP DAI DAI  DAI DAI </p>\n<p> DAI  DAI  DAI </p>\n<p>CDP  DAI DAI  margin call()</p>\n<p> pooled-ETH</p>\n<p> ETH  ETH PETHPETH  ETH </p>\n<p> CDP  PETH PETH  PETH  ETH PETH DAI PETH</p>\n<p> DAI  PETH  DAI  DAI</p>\n<p> CDP  PETH MKR</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p><img src=\"https://img.chainnews.com/material/images/a527abfe7199a3eb00887ea7f13e8293.jpg\" alt=\"img\"></p>\n<ul>\n<li><p></p>\n<p> PETH  Maker Maker</p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p> CDP   Dai Dai  Dai CDP CDP </p>\n<ul>\n<li><p></p>\n<p>PETH  Dai  PETH Dai CDP  CDP  Dai Dai PETH PETH  ETH  PETH </p>\n</li>\n<li><p></p>\n<p> PETH  Dai  PETH PETH  PETH ETH  PETH </p>\n</li>\n</ul>\n<p>Maker  CDP  CDP CDP  Dai  CDP  MKR</p>\n<p>CDP CDP  MKRMKR Dai  CDP  - CDP </p>\n</li>\n</ul>\n<ul>\n<li><p> ()</p>\n<p> Dai  CDPCDP </p>\n<p>PETH  Dai  PETH Dai  CDP CDP  Dai Dai  PETH  PETH  ETH PETH </p>\n<p> PETH  Dai  PETH PETH  PETH ETH  PETH </p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p>Maker  CDP </p>\n<p> CDP CDP  Dai  CDP  MKRCDP CDP  MKR  MKR Dai  CDP  -  CDP</p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p> Keeper  CDP LPC LPC  Dai Dashboard  CDP PETH  CDP </p>\n<p></p>\n<ul>\n<li> CDP </li>\n<li> DAI </li>\n<li>LPC  PETH  Oracle </li>\n<li>CDP </li>\n<li> PETH  dai.makerdao.com  Boom / Bust Spread </li>\n<li> PETH  DAI  CDP </li>\n<li> DAI  PETH  PETH </li>\n<li> DAI  PETH </li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  Oracle   PETH / ETH  -    -  = Oracle  DAI</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p> ETH  Oracle  350USD</p>\n</li>\n<li><p> PETH  10 ETH</p>\n</li>\n<li><p>PETH / ETH  1.012</p>\n</li>\n<li><p> 13</p>\n</li>\n<li><p>CDP  1000 DAI</p>\n<p>(10  350  1.012)  (13%  1000)  1000 = 2412 DAI  6.891428571 ETH</p>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  /  PETH / ETH = </span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p> ETH  350 USD</p>\n</li>\n<li><p> PETH  12</p>\n</li>\n<li><p>PETH / ETH  1.012</p>\n</li>\n<li><p> 150</p>\n</li>\n<li><p> 1000 DAI</p>\n<p>(1000  1.5)  (12  1.012) = 123.51 USD</p>\n<p> CDP ETH  123.51 </p>\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> PETH  ETH   PETH / ETH    100 = </span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li> ETH  350 USD</li>\n<li> PETH  12</li>\n<li>PETH / ETH  1.012</li>\n<li> 1000 DAI</li>\n</ul>\n<p>(12  350  1.012)  1000  100 = 425.04%</p>\n<p>CDP  425.04</p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p>CDP  CDP  DAI DAI CDP  DAI </p>\n<p></p>\n<ul>\n<li> ETH  350 USD</li>\n<li> PETH  12</li>\n<li>PETH / ETH  1.012</li>\n<li> 150</li>\n<li> 1000 DAI</li>\n</ul>\n<p></p>\n<p>(1000  1.5 )  (12  1.012) = 123.51 USD</p>\n<p> 700 </p>\n<p>(1000  1.5 )  (14  1.012) = 105.87 USD</p>\n<p> 700 </p>\n<p>(300  1.5 )  (12  1.012) = 37.05 USD</p>\n<p> DAI </p>\n</li>\n</ul>\n<ul>\n<li><p></p>\n<p> Keeper  CDP LPC Dai Dashboard Oracle Feed LPC  PETH  DAI  PETH </p>\n</li>\n</ul>\n"},{"title":"eth_contract","date":"2019-10-14T06:51:05.000Z","_content":"\n## \n\n\n\n- (Solidity)\n- EVMbytecode(binary code)ABI\n- bytecode(transaction)\n- transactionfunction\n\n\n\n#### \n\n#### ABI\n\napiABIapplication binary interfacebinary\n\nABI\n\n##### Function\n\n- `name`a string, \n- `type`:  a string\"function\", \"constructor\", or \"fallback\"\n- `inputs`:  an array\n  - `name`a string\n  - `type`a string data type(e.g. uint256)\n  - `components`an array tuple(struct) type  struct \n- `outputs`an array  `inputs`  `[]`\n- `payable``true`function  Ether `false`\n- `constant``true`function  `false`\n- `stateMutability`a string\"pure\"\"view\"\"payable\" and \"nonpayable\" Ether  \"payable\" \"nonpayable\"\n\n `payable`  `constant`  `stateMutability` \n\n##### Event\n\n- `name`: a stringevent \n- `type`: a stringalways \"event\"\n- `inputs`: an array\n  - `name`: a string\n  - `type`: a string data type(e.g. uint256)\n  - `components`: an array tuple(struct) type  struct \n  - `indexed`: `true` indexed  `false`\n- `anonymous`: `true` event  anonymous\n\n transactiontransaction  Event  Log Event  DApp  transaction  Log\n\nEvent 1.  function  2. \n\nEvent  `indexed` `indexed`  `indexed`  filter Event address  Log Topics 4  array  Data `anonymous`  Log  Topics Data\n\n##### \n\n```\npragma solidity ^0.4.20;\ncontract SimpleStorage {\n    uint public data;\n    event Set(address indexed _from, uint value);\n    function set(uint x) public {\n        data = x;\n        Set(msg.sender, x);\n    }\n}\n\n```\n\nABI\n\n```\n[{\t\t//datadata,\"stateMutabTility\": \"view\"\n        \"constant\": true,  \n        \"inputs\": [],\n        \"name\": \"data\",\n        \"outputs\": [{\"name\": \"\",\"type\": \"uint256\"}],\n        \"payable\": false,\n        \"stateMutabTility\": \"view\",\n        \"type\": \"function\"\n    },\n    {  //set \"stateMutability\": \"nonpayable\",Ether,uint256\n        \"constant\": false,\n        \"inputs\": [{\"name\": \"x\",\"type\": \"uint256\"}],\n        \"name\": \"set\",\n        \"outputs\": [],\n        \"payable\": false,\n        \"stateMutability\": \"nonpayable\",\n        \"type\": \"function\"\n\t},\n    {\n        \"anonymous\": false,\n        \"inputs\": [{\"indexed\": true,\"name\": \"_from\",\"type\": \"address\"},{\"indexed\": false,\"name\": \"value\",\"type\": \"uint256\"}],\n        \"name\": \"Set\",\n        \"type\": \"event\"\n}]\n```\n\neventweb3\n\n### web3\n\nbinaryweb3\n\n\n\n```\ncontract hello {\n    function say() constant public returns (string) {\n        return \"Hello World\";\n    }\n}\n```\n\n0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51\n\nabiabi\n\n```\nvar contract = web3.eth.contract(info.abi).at(\"0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51\");\nvar account_one = web3.eth.accounts[0];\nvar result = contract.say({from: account_one})\nconsole.log(result); //Hello World\n```\n\ncontract\n\n\n\n```\n//callsendTransactioncallsendTransactionparam\nmyContractInstance.myMethod(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);\n\n//call\nmyContractInstance.myMethod.call(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);\n\n//\nmyContractInstance.myMethod.sendTransaction(param1 [, param2, ...] [, transactionObject] [, callback]);\n\n//\n// Get the call data, so you can call the contract through some other means\n// var myCallData = myContractInstance.myMethod.request(param1 [, param2, ...]);\nvar myCallData = myContractInstance.myMethod.getData(param1 [, param2, ...]);\n// myCallData = '0x45ff3ff6000000000004545345345345..'\n\n```\n\nevent\n\n\n\n```\npragma solidity ^0.4.18;\ncontract hello {\n    string public greeting;\n    event Set(address indexed _from, string value);\n\n    function set(string g) public {\n        greeting = g;\n        Set(msg.sender, g);\n    }\n\n    function get() constant public returns (string) {\n        return greeting;\n    }\n}\n```\n\n\n\n```\nvar Web3 = require(\"web3\");\nvar web3 = new Web3();\nweb3.setProvider(new Web3.providers.HttpProvider(\"http://localhost:8545\"));\nif (web3.isConnected()) {\n  console.log(\"connection success!\");\n} else {\n  console.log(\"fail to connection!\");\n  return\n}\n\n\nvar contract = web3.eth.contract(abi).at(address);\nvar account_one = web3.eth.accounts[0];\nvar my_event = contract.Set();\nvar getStr = function() {\n  var str = contract.greeting({from: account_one})\n  console.log(\"the str is: \" + str);\n}\n\ngetStr()\nmy_event.watch(function(err, result) {\n    if (!err) {\n        console.log(result);\n        getStr()\n    } else {\n        console.log(err);\n    }\n    my_event.stopWatching();\n});\n\ncontract.set(\"I am Changed!\",{from: account_one})\n```\n\n\n\n```\n// connection success!\n// the str is:\n// { address: '0x8321a32f8b7bbc00a65c9e21df64948cf40bbeba',\n//   blockNumber: 785,\n//   transactionHash: '0xa90e35845cd844907f251660bce78f5cde2c968876f3a6321fbf38589d7fb476',\n//   transactionIndex: 0,\n//   blockHash: '0x742eecc3ae508b33ca5dde2ae2a32b8c0c87d321c6ab13a0cc8ad3909e579275',\n//   logIndex: 0,\n//   removed: false,\n//   event: 'Set',\n//   args:\n//    { _from: '0xc6e1feafcc44ebb1a7b0ecc06770566845eac7ac',\n//      value: 'I am Changed!' } }\n// the str is: I am Changed!\n```\n\n\n\n\n\n\n\n#### Event\n\n\n\n```\nevent SendMsg(string sender, string receiver, string detail, address indexed reth);\n```\n\nindexedevent\n\neventaddressaddressevent\n\nweb3jevent\n\n```\n   public static void test() {\n        Web3j web3j = Web3j.build(new HttpService(\"http://localhost:8545\"));\n        Event event = new Event(\"SendMsg\",\n                Arrays.<TypeReference<?>>asList(\n                        new TypeReference<Utf8String>(){},\n                        new TypeReference<Utf8String>(){},\n                        new TypeReference<Utf8String>(){},\n                        new TypeReference<Address>(true){}\n                ));\n        EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST,\n                DefaultBlockParameterName.LATEST, \"0x495feebd99f645a43aa63edb32d46e057e44e286\");\n        //event\n        filter.addSingleTopic(EventEncoder.encode(event));\n\n        web3j.ethLogObservable(filter).subscribe(log -> {\n            System.out.println(log);\n            //data\n            List<Type> results = FunctionReturnDecoder.decode(log.getData(), event.getNonIndexedParameters());\n            for (Type type : results) {\n                System.out.println(type);\n            }\n\n        });\n\n    }\n\n    // SendMsg(\"susan\", \"tom\", \"hi\", \"0x11a857e4d069d963c0676c53b68e9d571a3e2b26\")\n    //logLog{removed=false, logIndex='0x0', transactionIndex='0x0', transactionHash='0x31aa0a485f5595fb5b5c959e94dfb511c3512e94589dfd51205c5bd07c6ba4e2', blockHash='0xc68dcd25600857642199f9ebb354b62532f8468191a85ca923c0e03e958c6398', blockNumber='0x157c', address='0x495feebd99f645a43aa63edb32d46e057e44e286', data='...', type='null', topics=[0x444f124b164dc796e3a81a1d90ea60c96a815eac0a67ad1d3d550d30afda9e1f, 0x00000000000000000000000011a857e4d069d963c0676c53b68e9d571a3e2b26]\n    //topicSendMsgSendMsgaddress,\n    //datasusantomhi\n```\n\n\n\n#### Remix\n\nremixide\n\n- \n\n  ```\n  npm install -g remixd\n  remixd -s <absolute-path-to-the-shared-folder>\n  //ws\n  ```\n\n  remix\n\n\n\n#### bytes32string\n\nbytes1 ~bytes32stringbytes\n\n\n\npubkey(pubkey0x64bytes32)\n\n```\nbytes32 pubkey_half_pre;\nbytes32 pubkey_half_after;\n```\n\n\n\n#### \n\n[](https://solidity-cn.readthedocs.io/zh/develop/contracts.html#fallback)\n\n,payable\n\n```\nfunction () payable {}\n```\n\nicotoken\n\n\n\npayableether, msg.valuethis.balance\n\n\n\nether, address.transferaddress.send\n\n\n\n#### \n\n\n\n```\npragma solidity ^0.4.18;\n\ncontract UserTest {\n    struct User {\n        string name;\n        address addr;\n        string pubkey;\n        bool isValue;\n    }\n    mapping(string => User)  users;\n    event UserChange(string uname, address addr, uint value);\n\n    function addUser(string uname, address addr, string pubkey)  public {\n         require(\n           !users[uname].isValue,\n           \"name already exist\"\n       );\n       users[uname] = User({\n           name: uname,\n           addr: addr,\n           pubkey: pubkey,\n           isValue: true\n       });\n       UserChange(uname, addr, msg.value);\n    }\n\n    function userExist(string uname) constant external returns (bool) {\n        return users[uname].isValue;\n    }\n\n}\n```\n\nuserExist,0x123456789\n\n```\npragma solidity ^0.4.18;\n\ncontract UserTest {\n\t//\n    function userExist(string uname) constant external returns (bool);\n}\ncontract ExternalTest {\n\n    address userInstance = 0x123456789;\n    UserTest user = UserTest(userInstance); //\n\n    function userCheck(string uname) public returns (bool){\n        return user.userExist(uname);\n    }\n}\n```\n\n\n\n#### mapping\n\nmapping\n\n```\nlibrary IterableMapping\n{\n  struct itmap\n  {\n    mapping(uint => IndexValue) data;\n    KeyFlag[] keys;\n    uint size;\n  }\n  struct IndexValue { uint keyIndex; uint value; }\n  struct KeyFlag { uint key; bool deleted; }\n  function insert(itmap storage self, uint key, uint value) returns (bool replaced)\n  {\n    uint keyIndex = self.data[key].keyIndex;\n    self.data[key].value = value;\n    if (keyIndex > 0)\n      return true;\n    else\n    {\n      keyIndex = self.keys.length++;\n      self.data[key].keyIndex = keyIndex + 1;\n      self.keys[keyIndex].key = key;\n      self.size++;\n      return false;\n    }\n  }\n  function remove(itmap storage self, uint key) returns (bool success)\n  {\n    uint keyIndex = self.data[key].keyIndex;\n    if (keyIndex == 0)\n      return false;\n    delete self.data[key];\n    self.keys[keyIndex - 1].deleted = true;\n    self.size --;\n  }\n  function contains(itmap storage self, uint key) returns (bool)\n  {\n    return self.data[key].keyIndex > 0;\n  }\n  function iterate_start(itmap storage self) returns (uint keyIndex)\n  {\n    return iterate_next(self, uint(-1));\n  }\n  function iterate_valid(itmap storage self, uint keyIndex) returns (bool)\n  {\n    return keyIndex < self.keys.length;\n  }\n  function iterate_next(itmap storage self, uint keyIndex) returns (uint r_keyIndex)\n  {\n    keyIndex++;\n    while (keyIndex < self.keys.length && self.keys[keyIndex].deleted)\n      keyIndex++;\n    return keyIndex;\n  }\n  function iterate_get(itmap storage self, uint keyIndex) returns (uint key, uint value)\n  {\n    key = self.keys[keyIndex].key;\n    value = self.data[key].value;\n  }\n}\n\n// How to use it:\ncontract User\n{\n  // Just a struct holding our data.\n  IterableMapping.itmap data;\n  // Insert something\n  function insert(uint k, uint v) returns (uint size)\n  {\n    // Actually calls itmap_impl.insert, auto-supplying the first parameter for us.\n    IterableMapping.insert(data, k, v);\n    // We can still access members of the struct - but we should take care not to mess with them.\n    return data.size;\n  }\n  // Computes the sum of all stored data.\n  function sum() returns (uint s)\n  {\n    for (var i = IterableMapping.iterate_start(data); IterableMapping.iterate_valid(data, i); i = IterableMapping.iterate_next(data, i))\n    {\n        var (key, value) = IterableMapping.iterate_get(data, i);\n        s += value;\n    }\n  }  \n}\n```\n\n\n\n\n\n\n\n#### (EVM)\n\n(EVM)EVM\n\n#### \n\n- ````\n- hashnonce\n- EVM\n- key-value256key256value\n- Wei(balance)\n\n#### \n\n- special zero-account Ether\n- \n- 0`zero-account`, 0zero-accountEVM\n  \n\n#### gas\n\n- gasDDoSEVMgas\n- `gas_price * gas`\n- `out-of-gas`\n\ngas[](http://bitshuo.com/topic/5857774a2a482b0d339aab99/)\n\n#### storage,memory,stack\n\n- `storage`,`storage`key-value256key256value`storage`()`storage`( It is not possible to enumerate storage from within a contract and it is comparatively costly to read and even more so, to modify storage. ) `storage`\n- `memory`,`memory`2568256`memory`gas`memory`gas\n- EVM`stack``stack`1024256`stack`16`stack`16`stack`push`stack``stack``memory``storage``stack`\n\n#### \n\n- EVM256\n\n#### \n\n- data payload`Ether`,\n- `out-of-gas``stack``Solidity``stack`\n- `memory``calldata`\n- 1024\n\n#### /\n\n- `delegatecall`which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.\n- \n- Solidity:`storage`\n\n#### \n\nIt is possible to store data in a specially indexed data structure that maps all the way up to the block level. This feature called logs is used by Solidity in order to implement events. Contracts cannot access log data after it has been created, but they can be efficiently accessed from outside the blockchain. Since some part of the log data is stored in bloom filters, it is possible to search for this data in an efficient and cryptographically secure way, so network peers that do not download the whole blockchain (light clients) can still find these logs.\n\n#### Create\n\n- `opcode`,`create``create`datastack\n\n\n- \n\n```\npragma solidity ^0.4.18;\n\ncontract ClassifyStorage {\n    mapping(address => string) details;\n    event AddDetailEvent(address classify, string detail);\n\n    function addDetail(address classify, string detail) public {\n        details[classify] = strConcat(details[classify], detail);\n        AddDetailEvent(classify, detail);\n    }\n\n    function getSpecificDetails(address classify) constant public returns (string) {\n        return details[classify];\n    }\n\n    function strConcat(string _a, string _b) internal returns (string){\n        bytes memory _ba = bytes(_a);\n        if(_ba.length == 0) {\n            return _b;\n        }\n        bytes memory _bb = bytes(_b);\n        string memory ret = new string(_ba.length + _bb.length + 1);\n        bytes memory bret = bytes(ret);\n        uint k = 0;\n        for (uint i = 0; i < _ba.length; i++)bret[k++] = _ba[i];\n        bret[k++] = \",\";\n        for (i = 0; i < _bb.length; i++) bret[k++] = _bb[i];\n        return string(ret);\n   }  \n}\n\n```\n","source":"_posts/eth-contract.md","raw":"---\ntitle: eth_contract\ncategories:\n  - eth\ndate: 2019-10-14 14:51:05\ntags:\n---\n\n## \n\n\n\n- (Solidity)\n- EVMbytecode(binary code)ABI\n- bytecode(transaction)\n- transactionfunction\n\n\n\n#### \n\n#### ABI\n\napiABIapplication binary interfacebinary\n\nABI\n\n##### Function\n\n- `name`a string, \n- `type`:  a string\"function\", \"constructor\", or \"fallback\"\n- `inputs`:  an array\n  - `name`a string\n  - `type`a string data type(e.g. uint256)\n  - `components`an array tuple(struct) type  struct \n- `outputs`an array  `inputs`  `[]`\n- `payable``true`function  Ether `false`\n- `constant``true`function  `false`\n- `stateMutability`a string\"pure\"\"view\"\"payable\" and \"nonpayable\" Ether  \"payable\" \"nonpayable\"\n\n `payable`  `constant`  `stateMutability` \n\n##### Event\n\n- `name`: a stringevent \n- `type`: a stringalways \"event\"\n- `inputs`: an array\n  - `name`: a string\n  - `type`: a string data type(e.g. uint256)\n  - `components`: an array tuple(struct) type  struct \n  - `indexed`: `true` indexed  `false`\n- `anonymous`: `true` event  anonymous\n\n transactiontransaction  Event  Log Event  DApp  transaction  Log\n\nEvent 1.  function  2. \n\nEvent  `indexed` `indexed`  `indexed`  filter Event address  Log Topics 4  array  Data `anonymous`  Log  Topics Data\n\n##### \n\n```\npragma solidity ^0.4.20;\ncontract SimpleStorage {\n    uint public data;\n    event Set(address indexed _from, uint value);\n    function set(uint x) public {\n        data = x;\n        Set(msg.sender, x);\n    }\n}\n\n```\n\nABI\n\n```\n[{\t\t//datadata,\"stateMutabTility\": \"view\"\n        \"constant\": true,  \n        \"inputs\": [],\n        \"name\": \"data\",\n        \"outputs\": [{\"name\": \"\",\"type\": \"uint256\"}],\n        \"payable\": false,\n        \"stateMutabTility\": \"view\",\n        \"type\": \"function\"\n    },\n    {  //set \"stateMutability\": \"nonpayable\",Ether,uint256\n        \"constant\": false,\n        \"inputs\": [{\"name\": \"x\",\"type\": \"uint256\"}],\n        \"name\": \"set\",\n        \"outputs\": [],\n        \"payable\": false,\n        \"stateMutability\": \"nonpayable\",\n        \"type\": \"function\"\n\t},\n    {\n        \"anonymous\": false,\n        \"inputs\": [{\"indexed\": true,\"name\": \"_from\",\"type\": \"address\"},{\"indexed\": false,\"name\": \"value\",\"type\": \"uint256\"}],\n        \"name\": \"Set\",\n        \"type\": \"event\"\n}]\n```\n\neventweb3\n\n### web3\n\nbinaryweb3\n\n\n\n```\ncontract hello {\n    function say() constant public returns (string) {\n        return \"Hello World\";\n    }\n}\n```\n\n0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51\n\nabiabi\n\n```\nvar contract = web3.eth.contract(info.abi).at(\"0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51\");\nvar account_one = web3.eth.accounts[0];\nvar result = contract.say({from: account_one})\nconsole.log(result); //Hello World\n```\n\ncontract\n\n\n\n```\n//callsendTransactioncallsendTransactionparam\nmyContractInstance.myMethod(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);\n\n//call\nmyContractInstance.myMethod.call(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);\n\n//\nmyContractInstance.myMethod.sendTransaction(param1 [, param2, ...] [, transactionObject] [, callback]);\n\n//\n// Get the call data, so you can call the contract through some other means\n// var myCallData = myContractInstance.myMethod.request(param1 [, param2, ...]);\nvar myCallData = myContractInstance.myMethod.getData(param1 [, param2, ...]);\n// myCallData = '0x45ff3ff6000000000004545345345345..'\n\n```\n\nevent\n\n\n\n```\npragma solidity ^0.4.18;\ncontract hello {\n    string public greeting;\n    event Set(address indexed _from, string value);\n\n    function set(string g) public {\n        greeting = g;\n        Set(msg.sender, g);\n    }\n\n    function get() constant public returns (string) {\n        return greeting;\n    }\n}\n```\n\n\n\n```\nvar Web3 = require(\"web3\");\nvar web3 = new Web3();\nweb3.setProvider(new Web3.providers.HttpProvider(\"http://localhost:8545\"));\nif (web3.isConnected()) {\n  console.log(\"connection success!\");\n} else {\n  console.log(\"fail to connection!\");\n  return\n}\n\n\nvar contract = web3.eth.contract(abi).at(address);\nvar account_one = web3.eth.accounts[0];\nvar my_event = contract.Set();\nvar getStr = function() {\n  var str = contract.greeting({from: account_one})\n  console.log(\"the str is: \" + str);\n}\n\ngetStr()\nmy_event.watch(function(err, result) {\n    if (!err) {\n        console.log(result);\n        getStr()\n    } else {\n        console.log(err);\n    }\n    my_event.stopWatching();\n});\n\ncontract.set(\"I am Changed!\",{from: account_one})\n```\n\n\n\n```\n// connection success!\n// the str is:\n// { address: '0x8321a32f8b7bbc00a65c9e21df64948cf40bbeba',\n//   blockNumber: 785,\n//   transactionHash: '0xa90e35845cd844907f251660bce78f5cde2c968876f3a6321fbf38589d7fb476',\n//   transactionIndex: 0,\n//   blockHash: '0x742eecc3ae508b33ca5dde2ae2a32b8c0c87d321c6ab13a0cc8ad3909e579275',\n//   logIndex: 0,\n//   removed: false,\n//   event: 'Set',\n//   args:\n//    { _from: '0xc6e1feafcc44ebb1a7b0ecc06770566845eac7ac',\n//      value: 'I am Changed!' } }\n// the str is: I am Changed!\n```\n\n\n\n\n\n\n\n#### Event\n\n\n\n```\nevent SendMsg(string sender, string receiver, string detail, address indexed reth);\n```\n\nindexedevent\n\neventaddressaddressevent\n\nweb3jevent\n\n```\n   public static void test() {\n        Web3j web3j = Web3j.build(new HttpService(\"http://localhost:8545\"));\n        Event event = new Event(\"SendMsg\",\n                Arrays.<TypeReference<?>>asList(\n                        new TypeReference<Utf8String>(){},\n                        new TypeReference<Utf8String>(){},\n                        new TypeReference<Utf8String>(){},\n                        new TypeReference<Address>(true){}\n                ));\n        EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST,\n                DefaultBlockParameterName.LATEST, \"0x495feebd99f645a43aa63edb32d46e057e44e286\");\n        //event\n        filter.addSingleTopic(EventEncoder.encode(event));\n\n        web3j.ethLogObservable(filter).subscribe(log -> {\n            System.out.println(log);\n            //data\n            List<Type> results = FunctionReturnDecoder.decode(log.getData(), event.getNonIndexedParameters());\n            for (Type type : results) {\n                System.out.println(type);\n            }\n\n        });\n\n    }\n\n    // SendMsg(\"susan\", \"tom\", \"hi\", \"0x11a857e4d069d963c0676c53b68e9d571a3e2b26\")\n    //logLog{removed=false, logIndex='0x0', transactionIndex='0x0', transactionHash='0x31aa0a485f5595fb5b5c959e94dfb511c3512e94589dfd51205c5bd07c6ba4e2', blockHash='0xc68dcd25600857642199f9ebb354b62532f8468191a85ca923c0e03e958c6398', blockNumber='0x157c', address='0x495feebd99f645a43aa63edb32d46e057e44e286', data='...', type='null', topics=[0x444f124b164dc796e3a81a1d90ea60c96a815eac0a67ad1d3d550d30afda9e1f, 0x00000000000000000000000011a857e4d069d963c0676c53b68e9d571a3e2b26]\n    //topicSendMsgSendMsgaddress,\n    //datasusantomhi\n```\n\n\n\n#### Remix\n\nremixide\n\n- \n\n  ```\n  npm install -g remixd\n  remixd -s <absolute-path-to-the-shared-folder>\n  //ws\n  ```\n\n  remix\n\n\n\n#### bytes32string\n\nbytes1 ~bytes32stringbytes\n\n\n\npubkey(pubkey0x64bytes32)\n\n```\nbytes32 pubkey_half_pre;\nbytes32 pubkey_half_after;\n```\n\n\n\n#### \n\n[](https://solidity-cn.readthedocs.io/zh/develop/contracts.html#fallback)\n\n,payable\n\n```\nfunction () payable {}\n```\n\nicotoken\n\n\n\npayableether, msg.valuethis.balance\n\n\n\nether, address.transferaddress.send\n\n\n\n#### \n\n\n\n```\npragma solidity ^0.4.18;\n\ncontract UserTest {\n    struct User {\n        string name;\n        address addr;\n        string pubkey;\n        bool isValue;\n    }\n    mapping(string => User)  users;\n    event UserChange(string uname, address addr, uint value);\n\n    function addUser(string uname, address addr, string pubkey)  public {\n         require(\n           !users[uname].isValue,\n           \"name already exist\"\n       );\n       users[uname] = User({\n           name: uname,\n           addr: addr,\n           pubkey: pubkey,\n           isValue: true\n       });\n       UserChange(uname, addr, msg.value);\n    }\n\n    function userExist(string uname) constant external returns (bool) {\n        return users[uname].isValue;\n    }\n\n}\n```\n\nuserExist,0x123456789\n\n```\npragma solidity ^0.4.18;\n\ncontract UserTest {\n\t//\n    function userExist(string uname) constant external returns (bool);\n}\ncontract ExternalTest {\n\n    address userInstance = 0x123456789;\n    UserTest user = UserTest(userInstance); //\n\n    function userCheck(string uname) public returns (bool){\n        return user.userExist(uname);\n    }\n}\n```\n\n\n\n#### mapping\n\nmapping\n\n```\nlibrary IterableMapping\n{\n  struct itmap\n  {\n    mapping(uint => IndexValue) data;\n    KeyFlag[] keys;\n    uint size;\n  }\n  struct IndexValue { uint keyIndex; uint value; }\n  struct KeyFlag { uint key; bool deleted; }\n  function insert(itmap storage self, uint key, uint value) returns (bool replaced)\n  {\n    uint keyIndex = self.data[key].keyIndex;\n    self.data[key].value = value;\n    if (keyIndex > 0)\n      return true;\n    else\n    {\n      keyIndex = self.keys.length++;\n      self.data[key].keyIndex = keyIndex + 1;\n      self.keys[keyIndex].key = key;\n      self.size++;\n      return false;\n    }\n  }\n  function remove(itmap storage self, uint key) returns (bool success)\n  {\n    uint keyIndex = self.data[key].keyIndex;\n    if (keyIndex == 0)\n      return false;\n    delete self.data[key];\n    self.keys[keyIndex - 1].deleted = true;\n    self.size --;\n  }\n  function contains(itmap storage self, uint key) returns (bool)\n  {\n    return self.data[key].keyIndex > 0;\n  }\n  function iterate_start(itmap storage self) returns (uint keyIndex)\n  {\n    return iterate_next(self, uint(-1));\n  }\n  function iterate_valid(itmap storage self, uint keyIndex) returns (bool)\n  {\n    return keyIndex < self.keys.length;\n  }\n  function iterate_next(itmap storage self, uint keyIndex) returns (uint r_keyIndex)\n  {\n    keyIndex++;\n    while (keyIndex < self.keys.length && self.keys[keyIndex].deleted)\n      keyIndex++;\n    return keyIndex;\n  }\n  function iterate_get(itmap storage self, uint keyIndex) returns (uint key, uint value)\n  {\n    key = self.keys[keyIndex].key;\n    value = self.data[key].value;\n  }\n}\n\n// How to use it:\ncontract User\n{\n  // Just a struct holding our data.\n  IterableMapping.itmap data;\n  // Insert something\n  function insert(uint k, uint v) returns (uint size)\n  {\n    // Actually calls itmap_impl.insert, auto-supplying the first parameter for us.\n    IterableMapping.insert(data, k, v);\n    // We can still access members of the struct - but we should take care not to mess with them.\n    return data.size;\n  }\n  // Computes the sum of all stored data.\n  function sum() returns (uint s)\n  {\n    for (var i = IterableMapping.iterate_start(data); IterableMapping.iterate_valid(data, i); i = IterableMapping.iterate_next(data, i))\n    {\n        var (key, value) = IterableMapping.iterate_get(data, i);\n        s += value;\n    }\n  }  \n}\n```\n\n\n\n\n\n\n\n#### (EVM)\n\n(EVM)EVM\n\n#### \n\n- ````\n- hashnonce\n- EVM\n- key-value256key256value\n- Wei(balance)\n\n#### \n\n- special zero-account Ether\n- \n- 0`zero-account`, 0zero-accountEVM\n  \n\n#### gas\n\n- gasDDoSEVMgas\n- `gas_price * gas`\n- `out-of-gas`\n\ngas[](http://bitshuo.com/topic/5857774a2a482b0d339aab99/)\n\n#### storage,memory,stack\n\n- `storage`,`storage`key-value256key256value`storage`()`storage`( It is not possible to enumerate storage from within a contract and it is comparatively costly to read and even more so, to modify storage. ) `storage`\n- `memory`,`memory`2568256`memory`gas`memory`gas\n- EVM`stack``stack`1024256`stack`16`stack`16`stack`push`stack``stack``memory``storage``stack`\n\n#### \n\n- EVM256\n\n#### \n\n- data payload`Ether`,\n- `out-of-gas``stack``Solidity``stack`\n- `memory``calldata`\n- 1024\n\n#### /\n\n- `delegatecall`which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.\n- \n- Solidity:`storage`\n\n#### \n\nIt is possible to store data in a specially indexed data structure that maps all the way up to the block level. This feature called logs is used by Solidity in order to implement events. Contracts cannot access log data after it has been created, but they can be efficiently accessed from outside the blockchain. Since some part of the log data is stored in bloom filters, it is possible to search for this data in an efficient and cryptographically secure way, so network peers that do not download the whole blockchain (light clients) can still find these logs.\n\n#### Create\n\n- `opcode`,`create``create`datastack\n\n\n- \n\n```\npragma solidity ^0.4.18;\n\ncontract ClassifyStorage {\n    mapping(address => string) details;\n    event AddDetailEvent(address classify, string detail);\n\n    function addDetail(address classify, string detail) public {\n        details[classify] = strConcat(details[classify], detail);\n        AddDetailEvent(classify, detail);\n    }\n\n    function getSpecificDetails(address classify) constant public returns (string) {\n        return details[classify];\n    }\n\n    function strConcat(string _a, string _b) internal returns (string){\n        bytes memory _ba = bytes(_a);\n        if(_ba.length == 0) {\n            return _b;\n        }\n        bytes memory _bb = bytes(_b);\n        string memory ret = new string(_ba.length + _bb.length + 1);\n        bytes memory bret = bytes(ret);\n        uint k = 0;\n        for (uint i = 0; i < _ba.length; i++)bret[k++] = _ba[i];\n        bret[k++] = \",\";\n        for (i = 0; i < _bb.length; i++) bret[k++] = _bb[i];\n        return string(ret);\n   }  \n}\n\n```\n","slug":"eth-contract","published":1,"updated":"2019-10-14T06:51:35.621Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69xn002nt6xv9knrcw58","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<ul>\n<li>(Solidity)</li>\n<li>EVMbytecode(binary code)ABI</li>\n<li>bytecode(transaction)</li>\n<li>transactionfunction</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h4 id=\"ABI\"><a href=\"#ABI\" class=\"headerlink\" title=\"ABI\"></a>ABI</h4><p>apiABIapplication binary interfacebinary</p>\n<p>ABI</p>\n<h5 id=\"Function\"><a href=\"#Function\" class=\"headerlink\" title=\"Function\"></a>Function</h5><ul>\n<li><code>name</code>a string, </li>\n<li><code>type</code>:  a stringfunction, constructor, or fallback</li>\n<li><code>inputs</code>:  an array<ul>\n<li><code>name</code>a string</li>\n<li><code>type</code>a string data type(e.g. uint256)</li>\n<li><code>components</code>an array tuple(struct) type  struct </li>\n</ul>\n</li>\n<li><code>outputs</code>an array  <code>inputs</code>  <code>[]</code></li>\n<li><code>payable</code><code>true</code>function  Ether <code>false</code></li>\n<li><code>constant</code><code>true</code>function  <code>false</code></li>\n<li><code>stateMutability</code>a stringpureviewpayable and nonpayable Ether  payable nonpayable</li>\n</ul>\n<p> <code>payable</code>  <code>constant</code>  <code>stateMutability</code> </p>\n<h5 id=\"Event\"><a href=\"#Event\" class=\"headerlink\" title=\"Event\"></a>Event</h5><ul>\n<li><code>name</code>: a stringevent </li>\n<li><code>type</code>: a stringalways event</li>\n<li><code>inputs</code>: an array<ul>\n<li><code>name</code>: a string</li>\n<li><code>type</code>: a string data type(e.g. uint256)</li>\n<li><code>components</code>: an array tuple(struct) type  struct </li>\n<li><code>indexed</code>: <code>true</code> indexed  <code>false</code></li>\n</ul>\n</li>\n<li><code>anonymous</code>: <code>true</code> event  anonymous</li>\n</ul>\n<p> transactiontransaction  Event  Log Event  DApp  transaction  Log</p>\n<p>Event 1.  function  2. </p>\n<p>Event  <code>indexed</code> <code>indexed</code>  <code>indexed</code>  filter Event address  Log Topics 4  array  Data <code>anonymous</code>  Log  Topics Data</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.20;</span><br><span class=\"line\">contract SimpleStorage &#123;</span><br><span class=\"line\">    uint public data;</span><br><span class=\"line\">    event Set(address indexed _from, uint value);</span><br><span class=\"line\">    function set(uint x) public &#123;</span><br><span class=\"line\">        data = x;</span><br><span class=\"line\">        Set(msg.sender, x);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ABI</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&#123;\t\t//datadata,&quot;stateMutabTility&quot;: &quot;view&quot;</span><br><span class=\"line\">        &quot;constant&quot;: true,  </span><br><span class=\"line\">        &quot;inputs&quot;: [],</span><br><span class=\"line\">        &quot;name&quot;: &quot;data&quot;,</span><br><span class=\"line\">        &quot;outputs&quot;: [&#123;&quot;name&quot;: &quot;&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class=\"line\">        &quot;payable&quot;: false,</span><br><span class=\"line\">        &quot;stateMutabTility&quot;: &quot;view&quot;,</span><br><span class=\"line\">        &quot;type&quot;: &quot;function&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;  //set &quot;stateMutability&quot;: &quot;nonpayable&quot;,Ether,uint256</span><br><span class=\"line\">        &quot;constant&quot;: false,</span><br><span class=\"line\">        &quot;inputs&quot;: [&#123;&quot;name&quot;: &quot;x&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class=\"line\">        &quot;name&quot;: &quot;set&quot;,</span><br><span class=\"line\">        &quot;outputs&quot;: [],</span><br><span class=\"line\">        &quot;payable&quot;: false,</span><br><span class=\"line\">        &quot;stateMutability&quot;: &quot;nonpayable&quot;,</span><br><span class=\"line\">        &quot;type&quot;: &quot;function&quot;</span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;anonymous&quot;: false,</span><br><span class=\"line\">        &quot;inputs&quot;: [&#123;&quot;indexed&quot;: true,&quot;name&quot;: &quot;_from&quot;,&quot;type&quot;: &quot;address&quot;&#125;,&#123;&quot;indexed&quot;: false,&quot;name&quot;: &quot;value&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class=\"line\">        &quot;name&quot;: &quot;Set&quot;,</span><br><span class=\"line\">        &quot;type&quot;: &quot;event&quot;</span><br><span class=\"line\">&#125;]</span><br></pre></td></tr></table></figure>\n\n<p>eventweb3</p>\n<h3 id=\"web3\"><a href=\"#web3\" class=\"headerlink\" title=\"web3\"></a>web3</h3><p>binaryweb3</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract hello &#123;</span><br><span class=\"line\">    function say() constant public returns (string) &#123;</span><br><span class=\"line\">        return &quot;Hello World&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51</p>\n<p>abiabi</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var contract = web3.eth.contract(info.abi).at(&quot;0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51&quot;);</span><br><span class=\"line\">var account_one = web3.eth.accounts[0];</span><br><span class=\"line\">var result = contract.say(&#123;from: account_one&#125;)</span><br><span class=\"line\">console.log(result); //Hello World</span><br></pre></td></tr></table></figure>\n\n<p>contract</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//callsendTransactioncallsendTransactionparam</span><br><span class=\"line\">myContractInstance.myMethod(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class=\"line\"></span><br><span class=\"line\">//call</span><br><span class=\"line\">myContractInstance.myMethod.call(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">myContractInstance.myMethod.sendTransaction(param1 [, param2, ...] [, transactionObject] [, callback]);</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">// Get the call data, so you can call the contract through some other means</span><br><span class=\"line\">// var myCallData = myContractInstance.myMethod.request(param1 [, param2, ...]);</span><br><span class=\"line\">var myCallData = myContractInstance.myMethod.getData(param1 [, param2, ...]);</span><br><span class=\"line\">// myCallData = &apos;0x45ff3ff6000000000004545345345345..&apos;</span><br></pre></td></tr></table></figure>\n\n<p>event</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\">contract hello &#123;</span><br><span class=\"line\">    string public greeting;</span><br><span class=\"line\">    event Set(address indexed _from, string value);</span><br><span class=\"line\"></span><br><span class=\"line\">    function set(string g) public &#123;</span><br><span class=\"line\">        greeting = g;</span><br><span class=\"line\">        Set(msg.sender, g);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function get() constant public returns (string) &#123;</span><br><span class=\"line\">        return greeting;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var Web3 = require(&quot;web3&quot;);</span><br><span class=\"line\">var web3 = new Web3();</span><br><span class=\"line\">web3.setProvider(new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;));</span><br><span class=\"line\">if (web3.isConnected()) &#123;</span><br><span class=\"line\">  console.log(&quot;connection success!&quot;);</span><br><span class=\"line\">&#125; else &#123;</span><br><span class=\"line\">  console.log(&quot;fail to connection!&quot;);</span><br><span class=\"line\">  return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">var contract = web3.eth.contract(abi).at(address);</span><br><span class=\"line\">var account_one = web3.eth.accounts[0];</span><br><span class=\"line\">var my_event = contract.Set();</span><br><span class=\"line\">var getStr = function() &#123;</span><br><span class=\"line\">  var str = contract.greeting(&#123;from: account_one&#125;)</span><br><span class=\"line\">  console.log(&quot;the str is: &quot; + str);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getStr()</span><br><span class=\"line\">my_event.watch(function(err, result) &#123;</span><br><span class=\"line\">    if (!err) &#123;</span><br><span class=\"line\">        console.log(result);</span><br><span class=\"line\">        getStr()</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        console.log(err);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    my_event.stopWatching();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">contract.set(&quot;I am Changed!&quot;,&#123;from: account_one&#125;)</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// connection success!</span><br><span class=\"line\">// the str is:</span><br><span class=\"line\">// &#123; address: &apos;0x8321a32f8b7bbc00a65c9e21df64948cf40bbeba&apos;,</span><br><span class=\"line\">//   blockNumber: 785,</span><br><span class=\"line\">//   transactionHash: &apos;0xa90e35845cd844907f251660bce78f5cde2c968876f3a6321fbf38589d7fb476&apos;,</span><br><span class=\"line\">//   transactionIndex: 0,</span><br><span class=\"line\">//   blockHash: &apos;0x742eecc3ae508b33ca5dde2ae2a32b8c0c87d321c6ab13a0cc8ad3909e579275&apos;,</span><br><span class=\"line\">//   logIndex: 0,</span><br><span class=\"line\">//   removed: false,</span><br><span class=\"line\">//   event: &apos;Set&apos;,</span><br><span class=\"line\">//   args:</span><br><span class=\"line\">//    &#123; _from: &apos;0xc6e1feafcc44ebb1a7b0ecc06770566845eac7ac&apos;,</span><br><span class=\"line\">//      value: &apos;I am Changed!&apos; &#125; &#125;</span><br><span class=\"line\">// the str is: I am Changed!</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h4 id=\"Event-1\"><a href=\"#Event-1\" class=\"headerlink\" title=\"Event\"></a>Event</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">event SendMsg(string sender, string receiver, string detail, address indexed reth);</span><br></pre></td></tr></table></figure>\n\n<p>indexedevent</p>\n<p>eventaddressaddressevent</p>\n<p>web3jevent</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static void test() &#123;</span><br><span class=\"line\">     Web3j web3j = Web3j.build(new HttpService(&quot;http://localhost:8545&quot;));</span><br><span class=\"line\">     Event event = new Event(&quot;SendMsg&quot;,</span><br><span class=\"line\">             Arrays.&lt;TypeReference&lt;?&gt;&gt;asList(</span><br><span class=\"line\">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class=\"line\">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class=\"line\">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class=\"line\">                     new TypeReference&lt;Address&gt;(true)&#123;&#125;</span><br><span class=\"line\">             ));</span><br><span class=\"line\">     EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST,</span><br><span class=\"line\">             DefaultBlockParameterName.LATEST, &quot;0x495feebd99f645a43aa63edb32d46e057e44e286&quot;);</span><br><span class=\"line\">     //event</span><br><span class=\"line\">     filter.addSingleTopic(EventEncoder.encode(event));</span><br><span class=\"line\"></span><br><span class=\"line\">     web3j.ethLogObservable(filter).subscribe(log -&gt; &#123;</span><br><span class=\"line\">         System.out.println(log);</span><br><span class=\"line\">         //data</span><br><span class=\"line\">         List&lt;Type&gt; results = FunctionReturnDecoder.decode(log.getData(), event.getNonIndexedParameters());</span><br><span class=\"line\">         for (Type type : results) &#123;</span><br><span class=\"line\">             System.out.println(type);</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> // SendMsg(&quot;susan&quot;, &quot;tom&quot;, &quot;hi&quot;, &quot;0x11a857e4d069d963c0676c53b68e9d571a3e2b26&quot;)</span><br><span class=\"line\"> //logLog&#123;removed=false, logIndex=&apos;0x0&apos;, transactionIndex=&apos;0x0&apos;, transactionHash=&apos;0x31aa0a485f5595fb5b5c959e94dfb511c3512e94589dfd51205c5bd07c6ba4e2&apos;, blockHash=&apos;0xc68dcd25600857642199f9ebb354b62532f8468191a85ca923c0e03e958c6398&apos;, blockNumber=&apos;0x157c&apos;, address=&apos;0x495feebd99f645a43aa63edb32d46e057e44e286&apos;, data=&apos;...&apos;, type=&apos;null&apos;, topics=[0x444f124b164dc796e3a81a1d90ea60c96a815eac0a67ad1d3d550d30afda9e1f, 0x00000000000000000000000011a857e4d069d963c0676c53b68e9d571a3e2b26]</span><br><span class=\"line\"> //topicSendMsgSendMsgaddress,</span><br><span class=\"line\"> //datasusantomhi</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Remix\"><a href=\"#Remix\" class=\"headerlink\" title=\"Remix\"></a>Remix</h4><p>remixide</p>\n<ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g remixd</span><br><span class=\"line\">remixd -s &lt;absolute-path-to-the-shared-folder&gt;</span><br><span class=\"line\">//ws</span><br></pre></td></tr></table></figure>\n\n<p>remix</p>\n</li>\n</ul>\n<h4 id=\"bytes32string\"><a href=\"#bytes32string\" class=\"headerlink\" title=\"bytes32string\"></a>bytes32string</h4><p>bytes1 ~bytes32stringbytes</p>\n<p>pubkey(pubkey0x64bytes32)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bytes32 pubkey_half_pre;</span><br><span class=\"line\">bytes32 pubkey_half_after;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://solidity-cn.readthedocs.io/zh/develop/contracts.html#fallback\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>,payable</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function () payable &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>icotoken</p>\n<p>payableether, msg.valuethis.balance</p>\n<p>ether, address.transferaddress.send</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\"></span><br><span class=\"line\">contract UserTest &#123;</span><br><span class=\"line\">    struct User &#123;</span><br><span class=\"line\">        string name;</span><br><span class=\"line\">        address addr;</span><br><span class=\"line\">        string pubkey;</span><br><span class=\"line\">        bool isValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mapping(string =&gt; User)  users;</span><br><span class=\"line\">    event UserChange(string uname, address addr, uint value);</span><br><span class=\"line\"></span><br><span class=\"line\">    function addUser(string uname, address addr, string pubkey)  public &#123;</span><br><span class=\"line\">         require(</span><br><span class=\"line\">           !users[uname].isValue,</span><br><span class=\"line\">           &quot;name already exist&quot;</span><br><span class=\"line\">       );</span><br><span class=\"line\">       users[uname] = User(&#123;</span><br><span class=\"line\">           name: uname,</span><br><span class=\"line\">           addr: addr,</span><br><span class=\"line\">           pubkey: pubkey,</span><br><span class=\"line\">           isValue: true</span><br><span class=\"line\">       &#125;);</span><br><span class=\"line\">       UserChange(uname, addr, msg.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function userExist(string uname) constant external returns (bool) &#123;</span><br><span class=\"line\">        return users[uname].isValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>userExist,0x123456789</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\"></span><br><span class=\"line\">contract UserTest &#123;</span><br><span class=\"line\">\t//</span><br><span class=\"line\">    function userExist(string uname) constant external returns (bool);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">contract ExternalTest &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    address userInstance = 0x123456789;</span><br><span class=\"line\">    UserTest user = UserTest(userInstance); //</span><br><span class=\"line\"></span><br><span class=\"line\">    function userCheck(string uname) public returns (bool)&#123;</span><br><span class=\"line\">        return user.userExist(uname);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mapping\"><a href=\"#mapping\" class=\"headerlink\" title=\"mapping\"></a>mapping</h4><p>mapping</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library IterableMapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  struct itmap</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    mapping(uint =&gt; IndexValue) data;</span><br><span class=\"line\">    KeyFlag[] keys;</span><br><span class=\"line\">    uint size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  struct IndexValue &#123; uint keyIndex; uint value; &#125;</span><br><span class=\"line\">  struct KeyFlag &#123; uint key; bool deleted; &#125;</span><br><span class=\"line\">  function insert(itmap storage self, uint key, uint value) returns (bool replaced)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    uint keyIndex = self.data[key].keyIndex;</span><br><span class=\"line\">    self.data[key].value = value;</span><br><span class=\"line\">    if (keyIndex &gt; 0)</span><br><span class=\"line\">      return true;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      keyIndex = self.keys.length++;</span><br><span class=\"line\">      self.data[key].keyIndex = keyIndex + 1;</span><br><span class=\"line\">      self.keys[keyIndex].key = key;</span><br><span class=\"line\">      self.size++;</span><br><span class=\"line\">      return false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function remove(itmap storage self, uint key) returns (bool success)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    uint keyIndex = self.data[key].keyIndex;</span><br><span class=\"line\">    if (keyIndex == 0)</span><br><span class=\"line\">      return false;</span><br><span class=\"line\">    delete self.data[key];</span><br><span class=\"line\">    self.keys[keyIndex - 1].deleted = true;</span><br><span class=\"line\">    self.size --;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function contains(itmap storage self, uint key) returns (bool)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return self.data[key].keyIndex &gt; 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_start(itmap storage self) returns (uint keyIndex)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return iterate_next(self, uint(-1));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_valid(itmap storage self, uint keyIndex) returns (bool)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return keyIndex &lt; self.keys.length;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_next(itmap storage self, uint keyIndex) returns (uint r_keyIndex)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    keyIndex++;</span><br><span class=\"line\">    while (keyIndex &lt; self.keys.length &amp;&amp; self.keys[keyIndex].deleted)</span><br><span class=\"line\">      keyIndex++;</span><br><span class=\"line\">    return keyIndex;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_get(itmap storage self, uint keyIndex) returns (uint key, uint value)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    key = self.keys[keyIndex].key;</span><br><span class=\"line\">    value = self.data[key].value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// How to use it:</span><br><span class=\"line\">contract User</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  // Just a struct holding our data.</span><br><span class=\"line\">  IterableMapping.itmap data;</span><br><span class=\"line\">  // Insert something</span><br><span class=\"line\">  function insert(uint k, uint v) returns (uint size)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    // Actually calls itmap_impl.insert, auto-supplying the first parameter for us.</span><br><span class=\"line\">    IterableMapping.insert(data, k, v);</span><br><span class=\"line\">    // We can still access members of the struct - but we should take care not to mess with them.</span><br><span class=\"line\">    return data.size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // Computes the sum of all stored data.</span><br><span class=\"line\">  function sum() returns (uint s)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    for (var i = IterableMapping.iterate_start(data); IterableMapping.iterate_valid(data, i); i = IterableMapping.iterate_next(data, i))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        var (key, value) = IterableMapping.iterate_get(data, i);</span><br><span class=\"line\">        s += value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"-EVM\"><a href=\"#-EVM\" class=\"headerlink\" title=\"(EVM)\"></a>(EVM)</h4><p>(EVM)EVM</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><code></code><code></code></li>\n<li>hashnonce</li>\n<li>EVM</li>\n<li>key-value256key256value</li>\n<li>Wei(balance)</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>special zero-account Ether</li>\n<li></li>\n<li>0<code>zero-account</code>, 0zero-accountEVM<br></li>\n</ul>\n<h4 id=\"gas\"><a href=\"#gas\" class=\"headerlink\" title=\"gas\"></a>gas</h4><ul>\n<li>gasDDoSEVMgas</li>\n<li><code>gas_price * gas</code></li>\n<li><code>out-of-gas</code></li>\n</ul>\n<p>gas<a href=\"http://bitshuo.com/topic/5857774a2a482b0d339aab99/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h4 id=\"storage-memory-stack\"><a href=\"#storage-memory-stack\" class=\"headerlink\" title=\"storage,memory,stack\"></a>storage,memory,stack</h4><ul>\n<li><code>storage</code>,<code>storage</code>key-value256key256value<code>storage</code>()<code>storage</code>( It is not possible to enumerate storage from within a contract and it is comparatively costly to read and even more so, to modify storage. ) <code>storage</code></li>\n<li><code>memory</code>,<code>memory</code>2568256<code>memory</code>gas<code>memory</code>gas</li>\n<li>EVM<code>stack</code><code>stack</code>1024256<code>stack</code>16<code>stack</code>16<code>stack</code>push<code>stack</code><code>stack</code><code>memory</code><code>storage</code><code>stack</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>EVM256</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>data payload<code>Ether</code>,</li>\n<li><code>out-of-gas</code><code>stack</code><code>Solidity</code><code>stack</code></li>\n<li><code>memory</code><code>calldata</code></li>\n<li>1024</li>\n</ul>\n<h4 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h4><ul>\n<li><code>delegatecall</code>which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.</li>\n<li></li>\n<li>Solidity:<code>storage</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>It is possible to store data in a specially indexed data structure that maps all the way up to the block level. This feature called logs is used by Solidity in order to implement events. Contracts cannot access log data after it has been created, but they can be efficiently accessed from outside the blockchain. Since some part of the log data is stored in bloom filters, it is possible to search for this data in an efficient and cryptographically secure way, so network peers that do not download the whole blockchain (light clients) can still find these logs.</p>\n<h4 id=\"Create\"><a href=\"#Create\" class=\"headerlink\" title=\"Create\"></a>Create</h4><ul>\n<li><code>opcode</code>,<code>create</code><code>create</code>datastack</li>\n</ul>\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ClassifyStorage &#123;</span><br><span class=\"line\">    mapping(address =&gt; string) details;</span><br><span class=\"line\">    event AddDetailEvent(address classify, string detail);</span><br><span class=\"line\"></span><br><span class=\"line\">    function addDetail(address classify, string detail) public &#123;</span><br><span class=\"line\">        details[classify] = strConcat(details[classify], detail);</span><br><span class=\"line\">        AddDetailEvent(classify, detail);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function getSpecificDetails(address classify) constant public returns (string) &#123;</span><br><span class=\"line\">        return details[classify];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function strConcat(string _a, string _b) internal returns (string)&#123;</span><br><span class=\"line\">        bytes memory _ba = bytes(_a);</span><br><span class=\"line\">        if(_ba.length == 0) &#123;</span><br><span class=\"line\">            return _b;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        bytes memory _bb = bytes(_b);</span><br><span class=\"line\">        string memory ret = new string(_ba.length + _bb.length + 1);</span><br><span class=\"line\">        bytes memory bret = bytes(ret);</span><br><span class=\"line\">        uint k = 0;</span><br><span class=\"line\">        for (uint i = 0; i &lt; _ba.length; i++)bret[k++] = _ba[i];</span><br><span class=\"line\">        bret[k++] = &quot;,&quot;;</span><br><span class=\"line\">        for (i = 0; i &lt; _bb.length; i++) bret[k++] = _bb[i];</span><br><span class=\"line\">        return string(ret);</span><br><span class=\"line\">   &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<ul>\n<li>(Solidity)</li>\n<li>EVMbytecode(binary code)ABI</li>\n<li>bytecode(transaction)</li>\n<li>transactionfunction</li>\n</ul>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h4 id=\"ABI\"><a href=\"#ABI\" class=\"headerlink\" title=\"ABI\"></a>ABI</h4><p>apiABIapplication binary interfacebinary</p>\n<p>ABI</p>\n<h5 id=\"Function\"><a href=\"#Function\" class=\"headerlink\" title=\"Function\"></a>Function</h5><ul>\n<li><code>name</code>a string, </li>\n<li><code>type</code>:  a stringfunction, constructor, or fallback</li>\n<li><code>inputs</code>:  an array<ul>\n<li><code>name</code>a string</li>\n<li><code>type</code>a string data type(e.g. uint256)</li>\n<li><code>components</code>an array tuple(struct) type  struct </li>\n</ul>\n</li>\n<li><code>outputs</code>an array  <code>inputs</code>  <code>[]</code></li>\n<li><code>payable</code><code>true</code>function  Ether <code>false</code></li>\n<li><code>constant</code><code>true</code>function  <code>false</code></li>\n<li><code>stateMutability</code>a stringpureviewpayable and nonpayable Ether  payable nonpayable</li>\n</ul>\n<p> <code>payable</code>  <code>constant</code>  <code>stateMutability</code> </p>\n<h5 id=\"Event\"><a href=\"#Event\" class=\"headerlink\" title=\"Event\"></a>Event</h5><ul>\n<li><code>name</code>: a stringevent </li>\n<li><code>type</code>: a stringalways event</li>\n<li><code>inputs</code>: an array<ul>\n<li><code>name</code>: a string</li>\n<li><code>type</code>: a string data type(e.g. uint256)</li>\n<li><code>components</code>: an array tuple(struct) type  struct </li>\n<li><code>indexed</code>: <code>true</code> indexed  <code>false</code></li>\n</ul>\n</li>\n<li><code>anonymous</code>: <code>true</code> event  anonymous</li>\n</ul>\n<p> transactiontransaction  Event  Log Event  DApp  transaction  Log</p>\n<p>Event 1.  function  2. </p>\n<p>Event  <code>indexed</code> <code>indexed</code>  <code>indexed</code>  filter Event address  Log Topics 4  array  Data <code>anonymous</code>  Log  Topics Data</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.20;</span><br><span class=\"line\">contract SimpleStorage &#123;</span><br><span class=\"line\">    uint public data;</span><br><span class=\"line\">    event Set(address indexed _from, uint value);</span><br><span class=\"line\">    function set(uint x) public &#123;</span><br><span class=\"line\">        data = x;</span><br><span class=\"line\">        Set(msg.sender, x);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>ABI</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[&#123;\t\t//datadata,&quot;stateMutabTility&quot;: &quot;view&quot;</span><br><span class=\"line\">        &quot;constant&quot;: true,  </span><br><span class=\"line\">        &quot;inputs&quot;: [],</span><br><span class=\"line\">        &quot;name&quot;: &quot;data&quot;,</span><br><span class=\"line\">        &quot;outputs&quot;: [&#123;&quot;name&quot;: &quot;&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class=\"line\">        &quot;payable&quot;: false,</span><br><span class=\"line\">        &quot;stateMutabTility&quot;: &quot;view&quot;,</span><br><span class=\"line\">        &quot;type&quot;: &quot;function&quot;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;  //set &quot;stateMutability&quot;: &quot;nonpayable&quot;,Ether,uint256</span><br><span class=\"line\">        &quot;constant&quot;: false,</span><br><span class=\"line\">        &quot;inputs&quot;: [&#123;&quot;name&quot;: &quot;x&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class=\"line\">        &quot;name&quot;: &quot;set&quot;,</span><br><span class=\"line\">        &quot;outputs&quot;: [],</span><br><span class=\"line\">        &quot;payable&quot;: false,</span><br><span class=\"line\">        &quot;stateMutability&quot;: &quot;nonpayable&quot;,</span><br><span class=\"line\">        &quot;type&quot;: &quot;function&quot;</span><br><span class=\"line\">\t&#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;anonymous&quot;: false,</span><br><span class=\"line\">        &quot;inputs&quot;: [&#123;&quot;indexed&quot;: true,&quot;name&quot;: &quot;_from&quot;,&quot;type&quot;: &quot;address&quot;&#125;,&#123;&quot;indexed&quot;: false,&quot;name&quot;: &quot;value&quot;,&quot;type&quot;: &quot;uint256&quot;&#125;],</span><br><span class=\"line\">        &quot;name&quot;: &quot;Set&quot;,</span><br><span class=\"line\">        &quot;type&quot;: &quot;event&quot;</span><br><span class=\"line\">&#125;]</span><br></pre></td></tr></table></figure>\n\n<p>eventweb3</p>\n<h3 id=\"web3\"><a href=\"#web3\" class=\"headerlink\" title=\"web3\"></a>web3</h3><p>binaryweb3</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">contract hello &#123;</span><br><span class=\"line\">    function say() constant public returns (string) &#123;</span><br><span class=\"line\">        return &quot;Hello World&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51</p>\n<p>abiabi</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var contract = web3.eth.contract(info.abi).at(&quot;0x43d03aaeb07e518cd975c2d67b83a7ffea3a5a51&quot;);</span><br><span class=\"line\">var account_one = web3.eth.accounts[0];</span><br><span class=\"line\">var result = contract.say(&#123;from: account_one&#125;)</span><br><span class=\"line\">console.log(result); //Hello World</span><br></pre></td></tr></table></figure>\n\n<p>contract</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//callsendTransactioncallsendTransactionparam</span><br><span class=\"line\">myContractInstance.myMethod(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class=\"line\"></span><br><span class=\"line\">//call</span><br><span class=\"line\">myContractInstance.myMethod.call(param1 [, param2, ...] [, transactionObject] [, defaultBlock] [, callback]);</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">myContractInstance.myMethod.sendTransaction(param1 [, param2, ...] [, transactionObject] [, callback]);</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">// Get the call data, so you can call the contract through some other means</span><br><span class=\"line\">// var myCallData = myContractInstance.myMethod.request(param1 [, param2, ...]);</span><br><span class=\"line\">var myCallData = myContractInstance.myMethod.getData(param1 [, param2, ...]);</span><br><span class=\"line\">// myCallData = &apos;0x45ff3ff6000000000004545345345345..&apos;</span><br></pre></td></tr></table></figure>\n\n<p>event</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\">contract hello &#123;</span><br><span class=\"line\">    string public greeting;</span><br><span class=\"line\">    event Set(address indexed _from, string value);</span><br><span class=\"line\"></span><br><span class=\"line\">    function set(string g) public &#123;</span><br><span class=\"line\">        greeting = g;</span><br><span class=\"line\">        Set(msg.sender, g);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function get() constant public returns (string) &#123;</span><br><span class=\"line\">        return greeting;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var Web3 = require(&quot;web3&quot;);</span><br><span class=\"line\">var web3 = new Web3();</span><br><span class=\"line\">web3.setProvider(new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;));</span><br><span class=\"line\">if (web3.isConnected()) &#123;</span><br><span class=\"line\">  console.log(&quot;connection success!&quot;);</span><br><span class=\"line\">&#125; else &#123;</span><br><span class=\"line\">  console.log(&quot;fail to connection!&quot;);</span><br><span class=\"line\">  return</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">var contract = web3.eth.contract(abi).at(address);</span><br><span class=\"line\">var account_one = web3.eth.accounts[0];</span><br><span class=\"line\">var my_event = contract.Set();</span><br><span class=\"line\">var getStr = function() &#123;</span><br><span class=\"line\">  var str = contract.greeting(&#123;from: account_one&#125;)</span><br><span class=\"line\">  console.log(&quot;the str is: &quot; + str);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getStr()</span><br><span class=\"line\">my_event.watch(function(err, result) &#123;</span><br><span class=\"line\">    if (!err) &#123;</span><br><span class=\"line\">        console.log(result);</span><br><span class=\"line\">        getStr()</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        console.log(err);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    my_event.stopWatching();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">contract.set(&quot;I am Changed!&quot;,&#123;from: account_one&#125;)</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// connection success!</span><br><span class=\"line\">// the str is:</span><br><span class=\"line\">// &#123; address: &apos;0x8321a32f8b7bbc00a65c9e21df64948cf40bbeba&apos;,</span><br><span class=\"line\">//   blockNumber: 785,</span><br><span class=\"line\">//   transactionHash: &apos;0xa90e35845cd844907f251660bce78f5cde2c968876f3a6321fbf38589d7fb476&apos;,</span><br><span class=\"line\">//   transactionIndex: 0,</span><br><span class=\"line\">//   blockHash: &apos;0x742eecc3ae508b33ca5dde2ae2a32b8c0c87d321c6ab13a0cc8ad3909e579275&apos;,</span><br><span class=\"line\">//   logIndex: 0,</span><br><span class=\"line\">//   removed: false,</span><br><span class=\"line\">//   event: &apos;Set&apos;,</span><br><span class=\"line\">//   args:</span><br><span class=\"line\">//    &#123; _from: &apos;0xc6e1feafcc44ebb1a7b0ecc06770566845eac7ac&apos;,</span><br><span class=\"line\">//      value: &apos;I am Changed!&apos; &#125; &#125;</span><br><span class=\"line\">// the str is: I am Changed!</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h4 id=\"Event-1\"><a href=\"#Event-1\" class=\"headerlink\" title=\"Event\"></a>Event</h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">event SendMsg(string sender, string receiver, string detail, address indexed reth);</span><br></pre></td></tr></table></figure>\n\n<p>indexedevent</p>\n<p>eventaddressaddressevent</p>\n<p>web3jevent</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static void test() &#123;</span><br><span class=\"line\">     Web3j web3j = Web3j.build(new HttpService(&quot;http://localhost:8545&quot;));</span><br><span class=\"line\">     Event event = new Event(&quot;SendMsg&quot;,</span><br><span class=\"line\">             Arrays.&lt;TypeReference&lt;?&gt;&gt;asList(</span><br><span class=\"line\">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class=\"line\">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class=\"line\">                     new TypeReference&lt;Utf8String&gt;()&#123;&#125;,</span><br><span class=\"line\">                     new TypeReference&lt;Address&gt;(true)&#123;&#125;</span><br><span class=\"line\">             ));</span><br><span class=\"line\">     EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST,</span><br><span class=\"line\">             DefaultBlockParameterName.LATEST, &quot;0x495feebd99f645a43aa63edb32d46e057e44e286&quot;);</span><br><span class=\"line\">     //event</span><br><span class=\"line\">     filter.addSingleTopic(EventEncoder.encode(event));</span><br><span class=\"line\"></span><br><span class=\"line\">     web3j.ethLogObservable(filter).subscribe(log -&gt; &#123;</span><br><span class=\"line\">         System.out.println(log);</span><br><span class=\"line\">         //data</span><br><span class=\"line\">         List&lt;Type&gt; results = FunctionReturnDecoder.decode(log.getData(), event.getNonIndexedParameters());</span><br><span class=\"line\">         for (Type type : results) &#123;</span><br><span class=\"line\">             System.out.println(type);</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> // SendMsg(&quot;susan&quot;, &quot;tom&quot;, &quot;hi&quot;, &quot;0x11a857e4d069d963c0676c53b68e9d571a3e2b26&quot;)</span><br><span class=\"line\"> //logLog&#123;removed=false, logIndex=&apos;0x0&apos;, transactionIndex=&apos;0x0&apos;, transactionHash=&apos;0x31aa0a485f5595fb5b5c959e94dfb511c3512e94589dfd51205c5bd07c6ba4e2&apos;, blockHash=&apos;0xc68dcd25600857642199f9ebb354b62532f8468191a85ca923c0e03e958c6398&apos;, blockNumber=&apos;0x157c&apos;, address=&apos;0x495feebd99f645a43aa63edb32d46e057e44e286&apos;, data=&apos;...&apos;, type=&apos;null&apos;, topics=[0x444f124b164dc796e3a81a1d90ea60c96a815eac0a67ad1d3d550d30afda9e1f, 0x00000000000000000000000011a857e4d069d963c0676c53b68e9d571a3e2b26]</span><br><span class=\"line\"> //topicSendMsgSendMsgaddress,</span><br><span class=\"line\"> //datasusantomhi</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Remix\"><a href=\"#Remix\" class=\"headerlink\" title=\"Remix\"></a>Remix</h4><p>remixide</p>\n<ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g remixd</span><br><span class=\"line\">remixd -s &lt;absolute-path-to-the-shared-folder&gt;</span><br><span class=\"line\">//ws</span><br></pre></td></tr></table></figure>\n\n<p>remix</p>\n</li>\n</ul>\n<h4 id=\"bytes32string\"><a href=\"#bytes32string\" class=\"headerlink\" title=\"bytes32string\"></a>bytes32string</h4><p>bytes1 ~bytes32stringbytes</p>\n<p>pubkey(pubkey0x64bytes32)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bytes32 pubkey_half_pre;</span><br><span class=\"line\">bytes32 pubkey_half_after;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://solidity-cn.readthedocs.io/zh/develop/contracts.html#fallback\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p>,payable</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function () payable &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p>icotoken</p>\n<p>payableether, msg.valuethis.balance</p>\n<p>ether, address.transferaddress.send</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\"></span><br><span class=\"line\">contract UserTest &#123;</span><br><span class=\"line\">    struct User &#123;</span><br><span class=\"line\">        string name;</span><br><span class=\"line\">        address addr;</span><br><span class=\"line\">        string pubkey;</span><br><span class=\"line\">        bool isValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mapping(string =&gt; User)  users;</span><br><span class=\"line\">    event UserChange(string uname, address addr, uint value);</span><br><span class=\"line\"></span><br><span class=\"line\">    function addUser(string uname, address addr, string pubkey)  public &#123;</span><br><span class=\"line\">         require(</span><br><span class=\"line\">           !users[uname].isValue,</span><br><span class=\"line\">           &quot;name already exist&quot;</span><br><span class=\"line\">       );</span><br><span class=\"line\">       users[uname] = User(&#123;</span><br><span class=\"line\">           name: uname,</span><br><span class=\"line\">           addr: addr,</span><br><span class=\"line\">           pubkey: pubkey,</span><br><span class=\"line\">           isValue: true</span><br><span class=\"line\">       &#125;);</span><br><span class=\"line\">       UserChange(uname, addr, msg.value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function userExist(string uname) constant external returns (bool) &#123;</span><br><span class=\"line\">        return users[uname].isValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>userExist,0x123456789</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\"></span><br><span class=\"line\">contract UserTest &#123;</span><br><span class=\"line\">\t//</span><br><span class=\"line\">    function userExist(string uname) constant external returns (bool);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">contract ExternalTest &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    address userInstance = 0x123456789;</span><br><span class=\"line\">    UserTest user = UserTest(userInstance); //</span><br><span class=\"line\"></span><br><span class=\"line\">    function userCheck(string uname) public returns (bool)&#123;</span><br><span class=\"line\">        return user.userExist(uname);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mapping\"><a href=\"#mapping\" class=\"headerlink\" title=\"mapping\"></a>mapping</h4><p>mapping</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library IterableMapping</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  struct itmap</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    mapping(uint =&gt; IndexValue) data;</span><br><span class=\"line\">    KeyFlag[] keys;</span><br><span class=\"line\">    uint size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  struct IndexValue &#123; uint keyIndex; uint value; &#125;</span><br><span class=\"line\">  struct KeyFlag &#123; uint key; bool deleted; &#125;</span><br><span class=\"line\">  function insert(itmap storage self, uint key, uint value) returns (bool replaced)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    uint keyIndex = self.data[key].keyIndex;</span><br><span class=\"line\">    self.data[key].value = value;</span><br><span class=\"line\">    if (keyIndex &gt; 0)</span><br><span class=\"line\">      return true;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      keyIndex = self.keys.length++;</span><br><span class=\"line\">      self.data[key].keyIndex = keyIndex + 1;</span><br><span class=\"line\">      self.keys[keyIndex].key = key;</span><br><span class=\"line\">      self.size++;</span><br><span class=\"line\">      return false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function remove(itmap storage self, uint key) returns (bool success)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    uint keyIndex = self.data[key].keyIndex;</span><br><span class=\"line\">    if (keyIndex == 0)</span><br><span class=\"line\">      return false;</span><br><span class=\"line\">    delete self.data[key];</span><br><span class=\"line\">    self.keys[keyIndex - 1].deleted = true;</span><br><span class=\"line\">    self.size --;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function contains(itmap storage self, uint key) returns (bool)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return self.data[key].keyIndex &gt; 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_start(itmap storage self) returns (uint keyIndex)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return iterate_next(self, uint(-1));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_valid(itmap storage self, uint keyIndex) returns (bool)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    return keyIndex &lt; self.keys.length;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_next(itmap storage self, uint keyIndex) returns (uint r_keyIndex)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    keyIndex++;</span><br><span class=\"line\">    while (keyIndex &lt; self.keys.length &amp;&amp; self.keys[keyIndex].deleted)</span><br><span class=\"line\">      keyIndex++;</span><br><span class=\"line\">    return keyIndex;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  function iterate_get(itmap storage self, uint keyIndex) returns (uint key, uint value)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    key = self.keys[keyIndex].key;</span><br><span class=\"line\">    value = self.data[key].value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// How to use it:</span><br><span class=\"line\">contract User</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  // Just a struct holding our data.</span><br><span class=\"line\">  IterableMapping.itmap data;</span><br><span class=\"line\">  // Insert something</span><br><span class=\"line\">  function insert(uint k, uint v) returns (uint size)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    // Actually calls itmap_impl.insert, auto-supplying the first parameter for us.</span><br><span class=\"line\">    IterableMapping.insert(data, k, v);</span><br><span class=\"line\">    // We can still access members of the struct - but we should take care not to mess with them.</span><br><span class=\"line\">    return data.size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  // Computes the sum of all stored data.</span><br><span class=\"line\">  function sum() returns (uint s)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    for (var i = IterableMapping.iterate_start(data); IterableMapping.iterate_valid(data, i); i = IterableMapping.iterate_next(data, i))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        var (key, value) = IterableMapping.iterate_get(data, i);</span><br><span class=\"line\">        s += value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"-EVM\"><a href=\"#-EVM\" class=\"headerlink\" title=\"(EVM)\"></a>(EVM)</h4><p>(EVM)EVM</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><code></code><code></code></li>\n<li>hashnonce</li>\n<li>EVM</li>\n<li>key-value256key256value</li>\n<li>Wei(balance)</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>special zero-account Ether</li>\n<li></li>\n<li>0<code>zero-account</code>, 0zero-accountEVM<br></li>\n</ul>\n<h4 id=\"gas\"><a href=\"#gas\" class=\"headerlink\" title=\"gas\"></a>gas</h4><ul>\n<li>gasDDoSEVMgas</li>\n<li><code>gas_price * gas</code></li>\n<li><code>out-of-gas</code></li>\n</ul>\n<p>gas<a href=\"http://bitshuo.com/topic/5857774a2a482b0d339aab99/\" target=\"_blank\" rel=\"noopener\"></a></p>\n<h4 id=\"storage-memory-stack\"><a href=\"#storage-memory-stack\" class=\"headerlink\" title=\"storage,memory,stack\"></a>storage,memory,stack</h4><ul>\n<li><code>storage</code>,<code>storage</code>key-value256key256value<code>storage</code>()<code>storage</code>( It is not possible to enumerate storage from within a contract and it is comparatively costly to read and even more so, to modify storage. ) <code>storage</code></li>\n<li><code>memory</code>,<code>memory</code>2568256<code>memory</code>gas<code>memory</code>gas</li>\n<li>EVM<code>stack</code><code>stack</code>1024256<code>stack</code>16<code>stack</code>16<code>stack</code>push<code>stack</code><code>stack</code><code>memory</code><code>storage</code><code>stack</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>EVM256</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>data payload<code>Ether</code>,</li>\n<li><code>out-of-gas</code><code>stack</code><code>Solidity</code><code>stack</code></li>\n<li><code>memory</code><code>calldata</code></li>\n<li>1024</li>\n</ul>\n<h4 id=\"-\"><a href=\"#-\" class=\"headerlink\" title=\"/\"></a>/</h4><ul>\n<li><code>delegatecall</code>which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.</li>\n<li></li>\n<li>Solidity:<code>storage</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>It is possible to store data in a specially indexed data structure that maps all the way up to the block level. This feature called logs is used by Solidity in order to implement events. Contracts cannot access log data after it has been created, but they can be efficiently accessed from outside the blockchain. Since some part of the log data is stored in bloom filters, it is possible to search for this data in an efficient and cryptographically secure way, so network peers that do not download the whole blockchain (light clients) can still find these logs.</p>\n<h4 id=\"Create\"><a href=\"#Create\" class=\"headerlink\" title=\"Create\"></a>Create</h4><ul>\n<li><code>opcode</code>,<code>create</code><code>create</code>datastack</li>\n</ul>\n<ul>\n<li></li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^0.4.18;</span><br><span class=\"line\"></span><br><span class=\"line\">contract ClassifyStorage &#123;</span><br><span class=\"line\">    mapping(address =&gt; string) details;</span><br><span class=\"line\">    event AddDetailEvent(address classify, string detail);</span><br><span class=\"line\"></span><br><span class=\"line\">    function addDetail(address classify, string detail) public &#123;</span><br><span class=\"line\">        details[classify] = strConcat(details[classify], detail);</span><br><span class=\"line\">        AddDetailEvent(classify, detail);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function getSpecificDetails(address classify) constant public returns (string) &#123;</span><br><span class=\"line\">        return details[classify];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function strConcat(string _a, string _b) internal returns (string)&#123;</span><br><span class=\"line\">        bytes memory _ba = bytes(_a);</span><br><span class=\"line\">        if(_ba.length == 0) &#123;</span><br><span class=\"line\">            return _b;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        bytes memory _bb = bytes(_b);</span><br><span class=\"line\">        string memory ret = new string(_ba.length + _bb.length + 1);</span><br><span class=\"line\">        bytes memory bret = bytes(ret);</span><br><span class=\"line\">        uint k = 0;</span><br><span class=\"line\">        for (uint i = 0; i &lt; _ba.length; i++)bret[k++] = _ba[i];</span><br><span class=\"line\">        bret[k++] = &quot;,&quot;;</span><br><span class=\"line\">        for (i = 0; i &lt; _bb.length; i++) bret[k++] = _bb[i];</span><br><span class=\"line\">        return string(ret);</span><br><span class=\"line\">   &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n"},{"title":"fabric","date":"2019-10-14T06:56:49.000Z","_content":"\n## Fabric\n\n\n\n### \n\n\n\n[](http://hyperledger-fabric.readthedocs.io/en/master/arch-deep-dive.html)\n\n\n\n![](./fabric_macro.jpg)\n\nfabric\n\n- application: SDK\n- membership fabric-ca\n- peer: \n  - Endorser()peeryes/no\n  - Committer\n  - Ledger\n  - chaincodefabric\n  - Eventfabric\n- o-service\n\n\n\nchaincodeendorsedendorsed\n\n****\n\n- \n- invokechaincodechaincode - \n\n\n\n**State**stateKVSapplicationsKVSput,get..StatepeersordersclientsKVSKeyskeyskeys\n\n\n\n**Ledger, **1peerordersordersOrdererLedger()peersPeerLedgerpeerspeersordersorderingpeersstate,state\n\n\n\n****3\n\n- Client  submitting-client: endorsersordering\n- Peerstatepeersendorser\n- Ordering-service-nodeorder -> order\n\n\n\nclientspeers, clientpeerspeers\n\n\n\n#### \n\n\n\n1. Applicationpeer\n2. Peerendorse\n3. orderersorderersblockblockpeerlerdger\n\n\n\n![](./fabric_peer.jpg)\n\n\n\n#### channel\n\nchannelFabricchannelpeer\n\nchannelpeer\n\n\n\nFabricfirst-network<u>demo</u>! ~ fabric~\n\n.. ...\n\nfirst-networkpeerpeerpeerpeer\n\n\n\n### fabric \n\n#### \n\n```\nPolicy for [Groups] /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required [Admins]...\n```\n\n\n\n/or1.adminorg2.admin(..)\n\nSigningIdentity`fmt.Println(string(identity.EnrollmentCertificate()))`\n\ngo-sdktmpcaadmin..caadminadminorg1.admin(x;)..  admin...\n\n\n\n\n\n`peer chaincode instantiate -p git.wokoworks.com/blockchain/fabric-thread/multipeer/chaincode/go/test  -n mytest -v 0`\n\npeer`/var/hyperledger/production/chaincodes``mycc.0`\n\n?  peer\n\n\n\n\n```\n  cli:\n    container_name: cli\n    image: hyperledger/fabric-tools\n    tty: true\n    environment:\n      - GOPATH=/opt/gopath\n      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock\n      - FABRIC_LOGGING_SPEC=DEBUG\n      - CORE_PEER_ID=cli\n      - CORE_PEER_ADDRESS=peer:7051\n      - CORE_PEER_LOCALMSPID=DEFAULT\n      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp\n    working_dir: /opt/gopath/src/chaincodedev\n#    command: /bin/bash -c './script.sh'\n    volumes:\n      - /var/run/:/host/var/run/\n      - ./nodes/peer1/msp:/etc/hyperledger/msp\n      - /Users/xiaoxuez/go/src/github.com/hyperledger/fabric/examples/chaincode/go:/opt/gopath/src/chaincodedev/chaincode\n      - ./:/opt/gopath/src/chaincodedev/\n    depends_on:\n      - orderer\n      - peer1\n```\n\n\n\n```\nCORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0\n```\n\n\n\n```\nconfigure.sh \"mychannel\" \"channel.tx anchor.tx\" \"peer1 peer2 peer3 peer4\" false\n```\n\n\n\n------\n\n#### 1. \n\n```\ncryptogen generate  --config ./crypto-config.yaml --output crypto-config\n```\n\noutput \n\ncrypto-config.yaml\n\n```\nOrdererOrgs:\n  - Name: Orderer\n    Domain: orderer.net\n    CA:\n      Country: US\n      Province: California\n      Locality: San Francisco\n    Specs:\n      - Hostname: orderer\n\nPeerOrgs:\n  - Name: Org1\n    Domain: org1.net\n    CA:\n      Country: US\n      Province: California\n      Locality: San Francisco\n    Template:\n      Count: 4\n      Start: 1\n    Users:\n      Count: 1\n\n```\n\nOrdererOrg1\n\n```\ncrypto-config\n ordererOrganizations\n  orderer.net\n      ca\n      msp\n      orderers\n      tlsca\n      users\n peerOrganizations\n     org1.net\n         ca\n         msp\n         peers //count4peers4\n         tlsca\n         users\n\n```\n\n\n\n\n\ncryptogen\n\n\n\n1. \n2. root caroot caconfigcaroot ca()root ca()ca\n3. fabrictls.. ()catlsca\n4. mspcatlsca()admin()\n5. userspeerspeeruserroot catlscadroot catlsca\n\ncaroot caca serverx509fabric-sdk-goenrollpeerpeer.. peerroot ca(root ca)a -> b -> c\n\n\n\n#### 2. \n\n```\nconfigtxgen -profile SampleOrg -outputBlock ./channel-artifacts/genesis.block\n```\n\n`configtx.yaml`\n\n\n\n```\nCORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0\n//-p  Path to chaincode,\n//  \tgopathgopath/chaincodedev/chaincode/sacc, sacc\n//-n, --name string                    Name of the chaincode\n```\n\n\n\n```\npeer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C $CHANNEL_NAME -n mycc -v 1.0 -c '{\"Args\":[\"init\",\"a\", \"100\", \"b\",\"200\"]}' -P \"OR ('Org1MSP.admin','Org1MSP.member')\"\n```\n\n\n\n\n\n```\npeer chaincode instantiate -o orderer.example.com:7050  --tls true --cafile  /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n marbles02 -v 0 -c '{\"Args\":[\"\"]}' -P \"OR ('Org1MSP.admin','Org1MSP.member')\"\n//tsl--tls true --cafile  -oorderer.example.com:7050  -P\n```\n\n\n\n\n\nconfigtx.yamlProfilesgenesis(order(Consortiums = =))channel(ConsortiumApplication)\n\nconfigtx.yamlOneOrgOrdererGenesisProfiles\n\n```\nconfigtxgen -profile OneOrgOrdererGenesis -outputBlock ./config/genesis.block\n```\n\n\n\nOneOrgChannelProfiles\n\n```\nconfigtxgen -profile  OneOrgChannel -outputCreateChannelTx ./config/channel.tx -channelID $CHANNEL_NAME\n```\n\n\n\n.tx\n\n\n\n### go-sdk\n\n#### config.yaml\n\nsdkconfig.yaml\n\n\n\n- clientmsp(keyscerts)BCCSPtls\n- channel, peer(peer_name)peer` could not get chConfig reference`\n- organizations,(org -> peer_name  orderorg)\n- orderers, orderernamerpctls\n- peerspeersnamerpctls\n- certificateAuthorities canamerpctls\n- entityMatchersname(peerordererca)url..\n\n#### \n\n- fabsdk.New(config)\n\n  - defPkgSuiteconfigdefaultPkgSuiteconfig\n    - Core(corefactory)BCCSPsigning managerfabric primitives\n      - BCCSPswpkcs11\n        - swsoftware-basedBCCSPgokeystore\n        - pkcs11pkcs11ecdsarsaaespkcs11pin\n    - MSP(..)msppvdr\n    - Servicechanneldiscovery..\n    - Logger\n\n  fabsdk.newprovide\n\n  ```\n  //update sdk providers list since all required providers are initialized\n  \tsdk.provider = context.NewProvider(context.WithCryptoSuiteConfig(cfg.cryptoSuiteConfig),\n  \t\tcontext.WithEndpointConfig(cfg.endpointConfig),\n  \t\tcontext.WithIdentityConfig(cfg.identityConfig),\n  \t\tcontext.WithCryptoSuite(sdk.cryptoSuite),\n  \t\tcontext.WithSigningManager(signingManager),\n  \t\tcontext.WithUserStore(userStore),\n  \t\tcontext.WithLocalDiscoveryProvider(localDiscoveryProvider),\n  \t\tcontext.WithIdentityManagerProvider(identityManagerProvider),\n  \t\tcontext.WithInfraProvider(infraProvider),\n  \t\tcontext.WithChannelProvider(channelProvider),\n  \t\tcontext.WithClientMetrics(sdk.clientMetrics),\n  \t)\n  \t...\n  ```\n\n\n\ngo-sdkrpcsdkrpc clientpkgclient\n\n```\n channel   //rpc\n common\n event\t//\n ledger\t//rpc,\n msp\t\t//rpc,caapi\n resmgmt\t//resouce manager clinet\n```\n\n\n\n#### msp\n\nmspcarpcidentify(msppvdr)\n\nrpc\n\n```\n1. \n2. (ECerts)\n3. (TCerts)\n4. \n```\n\n\n\n- Enroll(config.credentialStore.cryptoStore/)httpcaca(config.credentialStore.path/)\n  - name@Org1MSP-cert.pemnameOrg1MSPpubKeynamepubKey.SKI()\n\n        Enroll\n\n- Register()\n\n  - \n\n    ```\n    attributes:\n            - name: hf.Revoker\n            value: true\n            ECert: true\n            - name: anotherAttrName\n            value: anotherAttrValue\n    ```\n\n    LDAP..\n\n\n\n#### channel\n\napi\n\n\n\nchannel`Query``Execute`\n\n(handlersopts..)`chclinet.InvokeHandler``InvokeHandler`handlerscompletereqCtx.Done()handlerscomplete()reqCtx.Done()HandlerHandlera -> b ->c\n\n- Query\n\n  - ProposalProcessorHandler\n\n    targets0targetstargetsoptsfilter(...)\n\n  - EndorsementHandler\n\n    proposaltargetsresponses\n\n  - EndorsementValidationHandler\n\n    targetreponse\n\n  - SignatureValidationHandler\n\n    response/\n\n  queryreponse\n\n- Execute\n\n  - SelectAndEndorseHandler\n\n    targetsEndorsementHandlerproposalpeerproposalresponses\n\n  - EndorsementValidationHandler\n\n    \n\n  - SignatureValidationHandler\n\n    \n\n  - CommitHandler\n\n    peerorder\n\nresponsePayloadChaincodeStatusTxValidationCode\n\ngithub.com/hyperledger/fabric/protos/peerTxValidationCode\n\n```\nswitch pb.TxValidationCode(response.TxValidationCode) {\n\tcase pb.TxValidationCode_VALID:\n\t\tcliconfig.Config().Logger().Debugf(\"(%s) - Successfully committed transaction [%s] ...\\n\", t.id, response.TransactionID)\n\t\treturn nil\n\tcase pb.TxValidationCode_DUPLICATE_TXID, pb.TxValidationCode_MVCC_READ_CONFLICT, pb.TxValidationCode_PHANTOM_READ_CONFLICT:\n\t\tcliconfig.Config().Logger().Debugf(\"(%s) - Transaction commit failed for [%s] with code [%s]. This is most likely a transient error.\\n\", t.id, response.TransactionID, response.TxValidationCode)\n\t\treturn invokeerror.Wrapf(invokeerror.TransientError, errors.New(\"Duplicate TxID\"), \"invoke Error received from eventhub for TxID [%s]. Code: %s\", response.TransactionID, response.TxValidationCode)\n\tdefault:\n\t\tcliconfig.Config().Logger().Debugf(\"(%s) - Transaction commit failed for [%s] with code [%s].\\n\", t.id, response.TransactionID, response.TxValidationCode)\n\t\treturn invokeerror.Wrapf(invokeerror.PersistentError, errors.New(\"error\"), \"invoke Error received from eventhub for TxID [%s]. Code: %s\", response.TransactionID, response.TxValidationCode)\n\t}\n```\n\n#### sdk example\n\n[Sdk example ](https://github.com/securekey/fabric-examples/tree/master/fabric-cli)\n\n\n\n\n\n## couchdb\n\n#### \n\n```\nhttp://localhost:5984/mychannel_mycc/_index\n```\n\n\n\n```\n{\n    \"total_rows\":2,\n    \"indexes\":[\n        {\n            \"ddoc\":null,\n            \"name\":\"_all_docs\",\n            \"type\":\"special\",\n            \"def\":{\n                \"fields\":[\n                    {\n                        \"_id\":\"asc\"\n                    }\n                ]\n            }\n        },\n        {\n            \"ddoc\":\"_design/indexOwnerDoc\",\n            \"name\":\"indexOwner\",\n            \"type\":\"json\",\n            \"def\":{\n                \"fields\":[\n                    {\n                        \"docType\":\"asc\"\n                    },\n                    {\n                        \"owner\":\"asc\"\n                    }\n                ]\n            }\n        }\n    ]\n}\n```\n\n\n\n.\n\n()\n\n```\n{\n    \"_id\":\"_design/indexOwnerDoc\",\n    \"_rev\":\"1-56c3e9386cb19531f6731afa88281caa\",\n    \"language\":\"query\",\n    \"views\":{\n        \"indexOwner\":{\n            \"map\":{\n                \"fields\":{\n                    \"docType\":\"asc\",\n                    \"owner\":\"asc\"\n                },\n                \"partial_filter_selector\":{\n\n                }\n            },\n            \"reduce\":\"_count\",\n            \"options\":{\n                \"def\":{\n                    \"fields\":[\n                        \"docType\",\n                        \"owner\"\n                    ]\n                }\n            }\n        }\n    }\n}\n```\n\n\n\nMETA-INF\n\njson\n\n```\n{\n\t\"index\":{\"fields\":[\"docType\",\"owner\"]},\n\t\"ddoc\":\"indexOwnerDoc\",\n\t\"name\":\"indexOwner\",\n\t\"type\":\"json\"\n}\n```\n\n\n\n()\n\nid\n\n```\n{\n \"type\": \"special\",\n \"def\": {\n  \"fields\": [\n   {\n    \"_id\": \"asc\"\n   }\n  ]\n }\n}\n```\n\n\n\n\n\n```\ncurl -i -X POST -H \"Content-Type: application/json\" -d \"{\\\"index\\\":{\\\"fields\\\":[\\\"size\\\",\\\"docType\\\",\\\"owner\\\"]},\\\"ddoc\\\":\\\"indexSizeSortDoc1\\\", \\\"name\\\":\\\"indexSizeSortDesc1\\\",\\\"type\\\":\\\"json\\\"}\" http://localhost:5984/mychannel_mycc/_index\n```\n\n\n\n\n\n```\n{\n    \"total_rows\":3,\n    \"indexes\":[\n        {\n         ...\n        },\n        {\n         ...\n        },\n        {\n            \"ddoc\":\"_design/indexSizeSortDoc\",\n            \"name\":\"indexSizeSortDesc\",\n            \"type\":\"json\",\n            \"def\":{\n                \"fields\":[\n                    {\n                        \"size\":\"desc\"\n                    },\n                    {\n                        \"docType\":\"desc\"\n                    },\n                    {\n                        \"owner\":\"desc\"\n                    }\n                ]\n            }\n        }\n    ]\n}\n```\n\nsize\n\n```\n\"{\\\"selector\\\":{\\\"docType\\\":{\\\"$eq\\\":\\\"marble\\\"},\\\"owner\\\":{\\\"$eq\\\":\\\"tom\\\"},\\\"size\\\":{\\\"$gt\\\":0}},\\\"fields\\\":[\\\"docType\\\",\\\"owner\\\",\\\"size\\\"],\\\"sort\\\":[{\\\"size\\\":\\\"desc\\\"}],\\\"use_index\\\":\\\"_design/indexSizeSortDoc\\\"}\"\n```\n\n****sizedocTypeownerdocTypesize`Error running query. Reason: (no_usable_index) No index exists for this sort, try indexing by the sort fields.`\n\n\n\n1. sortselectorfieldindex(id asc)\n2. sortindex selectorfield + sortfieldfield indexfieldselectorfield + sortfieldfieldindexselectorsortsortindex\n","source":"_posts/fabric.md","raw":"---\ntitle: fabric\ncategories:\n  - fabric\ndate: 2019-10-14 14:56:49\ntags:\n---\n\n## Fabric\n\n\n\n### \n\n\n\n[](http://hyperledger-fabric.readthedocs.io/en/master/arch-deep-dive.html)\n\n\n\n![](./fabric_macro.jpg)\n\nfabric\n\n- application: SDK\n- membership fabric-ca\n- peer: \n  - Endorser()peeryes/no\n  - Committer\n  - Ledger\n  - chaincodefabric\n  - Eventfabric\n- o-service\n\n\n\nchaincodeendorsedendorsed\n\n****\n\n- \n- invokechaincodechaincode - \n\n\n\n**State**stateKVSapplicationsKVSput,get..StatepeersordersclientsKVSKeyskeyskeys\n\n\n\n**Ledger, **1peerordersordersOrdererLedger()peersPeerLedgerpeerspeersordersorderingpeersstate,state\n\n\n\n****3\n\n- Client  submitting-client: endorsersordering\n- Peerstatepeersendorser\n- Ordering-service-nodeorder -> order\n\n\n\nclientspeers, clientpeerspeers\n\n\n\n#### \n\n\n\n1. Applicationpeer\n2. Peerendorse\n3. orderersorderersblockblockpeerlerdger\n\n\n\n![](./fabric_peer.jpg)\n\n\n\n#### channel\n\nchannelFabricchannelpeer\n\nchannelpeer\n\n\n\nFabricfirst-network<u>demo</u>! ~ fabric~\n\n.. ...\n\nfirst-networkpeerpeerpeerpeer\n\n\n\n### fabric \n\n#### \n\n```\nPolicy for [Groups] /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required [Admins]...\n```\n\n\n\n/or1.adminorg2.admin(..)\n\nSigningIdentity`fmt.Println(string(identity.EnrollmentCertificate()))`\n\ngo-sdktmpcaadmin..caadminadminorg1.admin(x;)..  admin...\n\n\n\n\n\n`peer chaincode instantiate -p git.wokoworks.com/blockchain/fabric-thread/multipeer/chaincode/go/test  -n mytest -v 0`\n\npeer`/var/hyperledger/production/chaincodes``mycc.0`\n\n?  peer\n\n\n\n\n```\n  cli:\n    container_name: cli\n    image: hyperledger/fabric-tools\n    tty: true\n    environment:\n      - GOPATH=/opt/gopath\n      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock\n      - FABRIC_LOGGING_SPEC=DEBUG\n      - CORE_PEER_ID=cli\n      - CORE_PEER_ADDRESS=peer:7051\n      - CORE_PEER_LOCALMSPID=DEFAULT\n      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp\n    working_dir: /opt/gopath/src/chaincodedev\n#    command: /bin/bash -c './script.sh'\n    volumes:\n      - /var/run/:/host/var/run/\n      - ./nodes/peer1/msp:/etc/hyperledger/msp\n      - /Users/xiaoxuez/go/src/github.com/hyperledger/fabric/examples/chaincode/go:/opt/gopath/src/chaincodedev/chaincode\n      - ./:/opt/gopath/src/chaincodedev/\n    depends_on:\n      - orderer\n      - peer1\n```\n\n\n\n```\nCORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0\n```\n\n\n\n```\nconfigure.sh \"mychannel\" \"channel.tx anchor.tx\" \"peer1 peer2 peer3 peer4\" false\n```\n\n\n\n------\n\n#### 1. \n\n```\ncryptogen generate  --config ./crypto-config.yaml --output crypto-config\n```\n\noutput \n\ncrypto-config.yaml\n\n```\nOrdererOrgs:\n  - Name: Orderer\n    Domain: orderer.net\n    CA:\n      Country: US\n      Province: California\n      Locality: San Francisco\n    Specs:\n      - Hostname: orderer\n\nPeerOrgs:\n  - Name: Org1\n    Domain: org1.net\n    CA:\n      Country: US\n      Province: California\n      Locality: San Francisco\n    Template:\n      Count: 4\n      Start: 1\n    Users:\n      Count: 1\n\n```\n\nOrdererOrg1\n\n```\ncrypto-config\n ordererOrganizations\n  orderer.net\n      ca\n      msp\n      orderers\n      tlsca\n      users\n peerOrganizations\n     org1.net\n         ca\n         msp\n         peers //count4peers4\n         tlsca\n         users\n\n```\n\n\n\n\n\ncryptogen\n\n\n\n1. \n2. root caroot caconfigcaroot ca()root ca()ca\n3. fabrictls.. ()catlsca\n4. mspcatlsca()admin()\n5. userspeerspeeruserroot catlscadroot catlsca\n\ncaroot caca serverx509fabric-sdk-goenrollpeerpeer.. peerroot ca(root ca)a -> b -> c\n\n\n\n#### 2. \n\n```\nconfigtxgen -profile SampleOrg -outputBlock ./channel-artifacts/genesis.block\n```\n\n`configtx.yaml`\n\n\n\n```\nCORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0\n//-p  Path to chaincode,\n//  \tgopathgopath/chaincodedev/chaincode/sacc, sacc\n//-n, --name string                    Name of the chaincode\n```\n\n\n\n```\npeer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C $CHANNEL_NAME -n mycc -v 1.0 -c '{\"Args\":[\"init\",\"a\", \"100\", \"b\",\"200\"]}' -P \"OR ('Org1MSP.admin','Org1MSP.member')\"\n```\n\n\n\n\n\n```\npeer chaincode instantiate -o orderer.example.com:7050  --tls true --cafile  /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n marbles02 -v 0 -c '{\"Args\":[\"\"]}' -P \"OR ('Org1MSP.admin','Org1MSP.member')\"\n//tsl--tls true --cafile  -oorderer.example.com:7050  -P\n```\n\n\n\n\n\nconfigtx.yamlProfilesgenesis(order(Consortiums = =))channel(ConsortiumApplication)\n\nconfigtx.yamlOneOrgOrdererGenesisProfiles\n\n```\nconfigtxgen -profile OneOrgOrdererGenesis -outputBlock ./config/genesis.block\n```\n\n\n\nOneOrgChannelProfiles\n\n```\nconfigtxgen -profile  OneOrgChannel -outputCreateChannelTx ./config/channel.tx -channelID $CHANNEL_NAME\n```\n\n\n\n.tx\n\n\n\n### go-sdk\n\n#### config.yaml\n\nsdkconfig.yaml\n\n\n\n- clientmsp(keyscerts)BCCSPtls\n- channel, peer(peer_name)peer` could not get chConfig reference`\n- organizations,(org -> peer_name  orderorg)\n- orderers, orderernamerpctls\n- peerspeersnamerpctls\n- certificateAuthorities canamerpctls\n- entityMatchersname(peerordererca)url..\n\n#### \n\n- fabsdk.New(config)\n\n  - defPkgSuiteconfigdefaultPkgSuiteconfig\n    - Core(corefactory)BCCSPsigning managerfabric primitives\n      - BCCSPswpkcs11\n        - swsoftware-basedBCCSPgokeystore\n        - pkcs11pkcs11ecdsarsaaespkcs11pin\n    - MSP(..)msppvdr\n    - Servicechanneldiscovery..\n    - Logger\n\n  fabsdk.newprovide\n\n  ```\n  //update sdk providers list since all required providers are initialized\n  \tsdk.provider = context.NewProvider(context.WithCryptoSuiteConfig(cfg.cryptoSuiteConfig),\n  \t\tcontext.WithEndpointConfig(cfg.endpointConfig),\n  \t\tcontext.WithIdentityConfig(cfg.identityConfig),\n  \t\tcontext.WithCryptoSuite(sdk.cryptoSuite),\n  \t\tcontext.WithSigningManager(signingManager),\n  \t\tcontext.WithUserStore(userStore),\n  \t\tcontext.WithLocalDiscoveryProvider(localDiscoveryProvider),\n  \t\tcontext.WithIdentityManagerProvider(identityManagerProvider),\n  \t\tcontext.WithInfraProvider(infraProvider),\n  \t\tcontext.WithChannelProvider(channelProvider),\n  \t\tcontext.WithClientMetrics(sdk.clientMetrics),\n  \t)\n  \t...\n  ```\n\n\n\ngo-sdkrpcsdkrpc clientpkgclient\n\n```\n channel   //rpc\n common\n event\t//\n ledger\t//rpc,\n msp\t\t//rpc,caapi\n resmgmt\t//resouce manager clinet\n```\n\n\n\n#### msp\n\nmspcarpcidentify(msppvdr)\n\nrpc\n\n```\n1. \n2. (ECerts)\n3. (TCerts)\n4. \n```\n\n\n\n- Enroll(config.credentialStore.cryptoStore/)httpcaca(config.credentialStore.path/)\n  - name@Org1MSP-cert.pemnameOrg1MSPpubKeynamepubKey.SKI()\n\n        Enroll\n\n- Register()\n\n  - \n\n    ```\n    attributes:\n            - name: hf.Revoker\n            value: true\n            ECert: true\n            - name: anotherAttrName\n            value: anotherAttrValue\n    ```\n\n    LDAP..\n\n\n\n#### channel\n\napi\n\n\n\nchannel`Query``Execute`\n\n(handlersopts..)`chclinet.InvokeHandler``InvokeHandler`handlerscompletereqCtx.Done()handlerscomplete()reqCtx.Done()HandlerHandlera -> b ->c\n\n- Query\n\n  - ProposalProcessorHandler\n\n    targets0targetstargetsoptsfilter(...)\n\n  - EndorsementHandler\n\n    proposaltargetsresponses\n\n  - EndorsementValidationHandler\n\n    targetreponse\n\n  - SignatureValidationHandler\n\n    response/\n\n  queryreponse\n\n- Execute\n\n  - SelectAndEndorseHandler\n\n    targetsEndorsementHandlerproposalpeerproposalresponses\n\n  - EndorsementValidationHandler\n\n    \n\n  - SignatureValidationHandler\n\n    \n\n  - CommitHandler\n\n    peerorder\n\nresponsePayloadChaincodeStatusTxValidationCode\n\ngithub.com/hyperledger/fabric/protos/peerTxValidationCode\n\n```\nswitch pb.TxValidationCode(response.TxValidationCode) {\n\tcase pb.TxValidationCode_VALID:\n\t\tcliconfig.Config().Logger().Debugf(\"(%s) - Successfully committed transaction [%s] ...\\n\", t.id, response.TransactionID)\n\t\treturn nil\n\tcase pb.TxValidationCode_DUPLICATE_TXID, pb.TxValidationCode_MVCC_READ_CONFLICT, pb.TxValidationCode_PHANTOM_READ_CONFLICT:\n\t\tcliconfig.Config().Logger().Debugf(\"(%s) - Transaction commit failed for [%s] with code [%s]. This is most likely a transient error.\\n\", t.id, response.TransactionID, response.TxValidationCode)\n\t\treturn invokeerror.Wrapf(invokeerror.TransientError, errors.New(\"Duplicate TxID\"), \"invoke Error received from eventhub for TxID [%s]. Code: %s\", response.TransactionID, response.TxValidationCode)\n\tdefault:\n\t\tcliconfig.Config().Logger().Debugf(\"(%s) - Transaction commit failed for [%s] with code [%s].\\n\", t.id, response.TransactionID, response.TxValidationCode)\n\t\treturn invokeerror.Wrapf(invokeerror.PersistentError, errors.New(\"error\"), \"invoke Error received from eventhub for TxID [%s]. Code: %s\", response.TransactionID, response.TxValidationCode)\n\t}\n```\n\n#### sdk example\n\n[Sdk example ](https://github.com/securekey/fabric-examples/tree/master/fabric-cli)\n\n\n\n\n\n## couchdb\n\n#### \n\n```\nhttp://localhost:5984/mychannel_mycc/_index\n```\n\n\n\n```\n{\n    \"total_rows\":2,\n    \"indexes\":[\n        {\n            \"ddoc\":null,\n            \"name\":\"_all_docs\",\n            \"type\":\"special\",\n            \"def\":{\n                \"fields\":[\n                    {\n                        \"_id\":\"asc\"\n                    }\n                ]\n            }\n        },\n        {\n            \"ddoc\":\"_design/indexOwnerDoc\",\n            \"name\":\"indexOwner\",\n            \"type\":\"json\",\n            \"def\":{\n                \"fields\":[\n                    {\n                        \"docType\":\"asc\"\n                    },\n                    {\n                        \"owner\":\"asc\"\n                    }\n                ]\n            }\n        }\n    ]\n}\n```\n\n\n\n.\n\n()\n\n```\n{\n    \"_id\":\"_design/indexOwnerDoc\",\n    \"_rev\":\"1-56c3e9386cb19531f6731afa88281caa\",\n    \"language\":\"query\",\n    \"views\":{\n        \"indexOwner\":{\n            \"map\":{\n                \"fields\":{\n                    \"docType\":\"asc\",\n                    \"owner\":\"asc\"\n                },\n                \"partial_filter_selector\":{\n\n                }\n            },\n            \"reduce\":\"_count\",\n            \"options\":{\n                \"def\":{\n                    \"fields\":[\n                        \"docType\",\n                        \"owner\"\n                    ]\n                }\n            }\n        }\n    }\n}\n```\n\n\n\nMETA-INF\n\njson\n\n```\n{\n\t\"index\":{\"fields\":[\"docType\",\"owner\"]},\n\t\"ddoc\":\"indexOwnerDoc\",\n\t\"name\":\"indexOwner\",\n\t\"type\":\"json\"\n}\n```\n\n\n\n()\n\nid\n\n```\n{\n \"type\": \"special\",\n \"def\": {\n  \"fields\": [\n   {\n    \"_id\": \"asc\"\n   }\n  ]\n }\n}\n```\n\n\n\n\n\n```\ncurl -i -X POST -H \"Content-Type: application/json\" -d \"{\\\"index\\\":{\\\"fields\\\":[\\\"size\\\",\\\"docType\\\",\\\"owner\\\"]},\\\"ddoc\\\":\\\"indexSizeSortDoc1\\\", \\\"name\\\":\\\"indexSizeSortDesc1\\\",\\\"type\\\":\\\"json\\\"}\" http://localhost:5984/mychannel_mycc/_index\n```\n\n\n\n\n\n```\n{\n    \"total_rows\":3,\n    \"indexes\":[\n        {\n         ...\n        },\n        {\n         ...\n        },\n        {\n            \"ddoc\":\"_design/indexSizeSortDoc\",\n            \"name\":\"indexSizeSortDesc\",\n            \"type\":\"json\",\n            \"def\":{\n                \"fields\":[\n                    {\n                        \"size\":\"desc\"\n                    },\n                    {\n                        \"docType\":\"desc\"\n                    },\n                    {\n                        \"owner\":\"desc\"\n                    }\n                ]\n            }\n        }\n    ]\n}\n```\n\nsize\n\n```\n\"{\\\"selector\\\":{\\\"docType\\\":{\\\"$eq\\\":\\\"marble\\\"},\\\"owner\\\":{\\\"$eq\\\":\\\"tom\\\"},\\\"size\\\":{\\\"$gt\\\":0}},\\\"fields\\\":[\\\"docType\\\",\\\"owner\\\",\\\"size\\\"],\\\"sort\\\":[{\\\"size\\\":\\\"desc\\\"}],\\\"use_index\\\":\\\"_design/indexSizeSortDoc\\\"}\"\n```\n\n****sizedocTypeownerdocTypesize`Error running query. Reason: (no_usable_index) No index exists for this sort, try indexing by the sort fields.`\n\n\n\n1. sortselectorfieldindex(id asc)\n2. sortindex selectorfield + sortfieldfield indexfieldselectorfield + sortfieldfieldindexselectorsortsortindex\n","slug":"fabric","published":1,"updated":"2019-10-14T07:04:57.064Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69xv002qt6xvqekde64h","content":"<h2 id=\"Fabric\"><a href=\"#Fabric\" class=\"headerlink\" title=\"Fabric\"></a>Fabric</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"http://hyperledger-fabric.readthedocs.io/en/master/arch-deep-dive.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p><img src=\"./fabric_macro.jpg\" alt=\"\"></p>\n<p>fabric</p>\n<ul>\n<li>application: SDK</li>\n<li>membership fabric-ca</li>\n<li>peer: <ul>\n<li>Endorser()peeryes/no</li>\n<li>Committer</li>\n<li>Ledger</li>\n<li>chaincodefabric</li>\n<li>Eventfabric</li>\n</ul>\n</li>\n<li>o-service</li>\n</ul>\n<p>chaincodeendorsedendorsed</p>\n<p><strong></strong></p>\n<ul>\n<li></li>\n<li>invokechaincodechaincode - </li>\n</ul>\n<p></p>\n<p><strong>State</strong>stateKVSapplicationsKVSput,get..StatepeersordersclientsKVSKeyskeyskeys</p>\n<p><strong>Ledger, </strong>1peerordersordersOrdererLedger()peersPeerLedgerpeerspeersordersorderingpeersstate,state</p>\n<p><strong></strong>3</p>\n<ul>\n<li>Client  submitting-client: endorsersordering</li>\n<li>Peerstatepeersendorser</li>\n<li>Ordering-service-nodeorder -&gt; order</li>\n</ul>\n<p>clientspeers, clientpeerspeers</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ol>\n<li>Applicationpeer</li>\n<li>Peerendorse</li>\n<li>orderersorderersblockblockpeerlerdger</li>\n</ol>\n<p></p>\n<p><img src=\"./fabric_peer.jpg\" alt=\"\"></p>\n<h4 id=\"channel\"><a href=\"#channel\" class=\"headerlink\" title=\"channel\"></a>channel</h4><p>channelFabricchannelpeer</p>\n<p>channelpeer</p>\n<p>Fabricfirst-network<u>demo</u>! <del> fabric</del></p>\n<p>.. </p>\n<p>first-networkpeerpeerpeerpeer</p>\n<h3 id=\"fabric-\"><a href=\"#fabric-\" class=\"headerlink\" title=\"fabric \"></a>fabric </h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Policy for [Groups] /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required [Admins]...</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>/or1.adminorg2.admin(..)</p>\n<p>SigningIdentity<code>fmt.Println(string(identity.EnrollmentCertificate()))</code></p>\n<p>go-sdktmpcaadmin..caadminadminorg1.admin(x;)..  admin</p>\n<p><code>peer chaincode instantiate -p git.wokoworks.com/blockchain/fabric-thread/multipeer/chaincode/go/test  -n mytest -v 0</code></p>\n<p>peer<code>/var/hyperledger/production/chaincodes</code><code>mycc.0</code></p>\n<p>?  peer</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  cli:</span><br><span class=\"line\">    container_name: cli</span><br><span class=\"line\">    image: hyperledger/fabric-tools</span><br><span class=\"line\">    tty: true</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - GOPATH=/opt/gopath</span><br><span class=\"line\">      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br><span class=\"line\">      - FABRIC_LOGGING_SPEC=DEBUG</span><br><span class=\"line\">      - CORE_PEER_ID=cli</span><br><span class=\"line\">      - CORE_PEER_ADDRESS=peer:7051</span><br><span class=\"line\">      - CORE_PEER_LOCALMSPID=DEFAULT</span><br><span class=\"line\">      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp</span><br><span class=\"line\">    working_dir: /opt/gopath/src/chaincodedev</span><br><span class=\"line\">#    command: /bin/bash -c &apos;./script.sh&apos;</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /var/run/:/host/var/run/</span><br><span class=\"line\">      - ./nodes/peer1/msp:/etc/hyperledger/msp</span><br><span class=\"line\">      - /Users/xiaoxuez/go/src/github.com/hyperledger/fabric/examples/chaincode/go:/opt/gopath/src/chaincodedev/chaincode</span><br><span class=\"line\">      - ./:/opt/gopath/src/chaincodedev/</span><br><span class=\"line\">    depends_on:</span><br><span class=\"line\">      - orderer</span><br><span class=\"line\">      - peer1</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure.sh &quot;mychannel&quot; &quot;channel.tx anchor.tx&quot; &quot;peer1 peer2 peer3 peer4&quot; false</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h4 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cryptogen generate  --config ./crypto-config.yaml --output crypto-config</span><br></pre></td></tr></table></figure>\n\n<p>output </p>\n<p>crypto-config.yaml</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OrdererOrgs:</span><br><span class=\"line\">  - Name: Orderer</span><br><span class=\"line\">    Domain: orderer.net</span><br><span class=\"line\">    CA:</span><br><span class=\"line\">      Country: US</span><br><span class=\"line\">      Province: California</span><br><span class=\"line\">      Locality: San Francisco</span><br><span class=\"line\">    Specs:</span><br><span class=\"line\">      - Hostname: orderer</span><br><span class=\"line\"></span><br><span class=\"line\">PeerOrgs:</span><br><span class=\"line\">  - Name: Org1</span><br><span class=\"line\">    Domain: org1.net</span><br><span class=\"line\">    CA:</span><br><span class=\"line\">      Country: US</span><br><span class=\"line\">      Province: California</span><br><span class=\"line\">      Locality: San Francisco</span><br><span class=\"line\">    Template:</span><br><span class=\"line\">      Count: 4</span><br><span class=\"line\">      Start: 1</span><br><span class=\"line\">    Users:</span><br><span class=\"line\">      Count: 1</span><br></pre></td></tr></table></figure>\n\n<p>OrdererOrg1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crypto-config</span><br><span class=\"line\"> ordererOrganizations</span><br><span class=\"line\">  orderer.net</span><br><span class=\"line\">      ca</span><br><span class=\"line\">      msp</span><br><span class=\"line\">      orderers</span><br><span class=\"line\">      tlsca</span><br><span class=\"line\">      users</span><br><span class=\"line\"> peerOrganizations</span><br><span class=\"line\">     org1.net</span><br><span class=\"line\">         ca</span><br><span class=\"line\">         msp</span><br><span class=\"line\">         peers //count4peers4</span><br><span class=\"line\">         tlsca</span><br><span class=\"line\">         users</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>cryptogen</p>\n<p></p>\n<ol>\n<li></li>\n<li>root caroot caconfigcaroot ca()root ca()ca</li>\n<li>fabrictls.. ()catlsca</li>\n<li>mspcatlsca()admin()</li>\n<li>userspeerspeeruserroot catlscadroot catlsca</li>\n</ol>\n<p>caroot caca serverx509fabric-sdk-goenrollpeerpeer.. peerroot ca(root ca)a -&gt; b -&gt; c</p>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configtxgen -profile SampleOrg -outputBlock ./channel-artifacts/genesis.block</span><br></pre></td></tr></table></figure>\n\n<p><code>configtx.yaml</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0</span><br><span class=\"line\">//-p  Path to chaincode,</span><br><span class=\"line\">//  \tgopathgopath/chaincodedev/chaincode/sacc, sacc</span><br><span class=\"line\">//-n, --name string                    Name of the chaincode</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C $CHANNEL_NAME -n mycc -v 1.0 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&apos; -P &quot;OR (&apos;Org1MSP.admin&apos;,&apos;Org1MSP.member&apos;)&quot;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer chaincode instantiate -o orderer.example.com:7050  --tls true --cafile  /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n marbles02 -v 0 -c &apos;&#123;&quot;Args&quot;:[&quot;&quot;]&#125;&apos; -P &quot;OR (&apos;Org1MSP.admin&apos;,&apos;Org1MSP.member&apos;)&quot;</span><br><span class=\"line\">//tsl--tls true --cafile  -oorderer.example.com:7050  -P</span><br></pre></td></tr></table></figure>\n\n<p>configtx.yamlProfilesgenesis(order(Consortiums = =))channel(ConsortiumApplication)</p>\n<p>configtx.yamlOneOrgOrdererGenesisProfiles</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configtxgen -profile OneOrgOrdererGenesis -outputBlock ./config/genesis.block</span><br></pre></td></tr></table></figure>\n\n<p>OneOrgChannelProfiles</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configtxgen -profile  OneOrgChannel -outputCreateChannelTx ./config/channel.tx -channelID $CHANNEL_NAME</span><br></pre></td></tr></table></figure>\n\n<p>.tx</p>\n<h3 id=\"go-sdk\"><a href=\"#go-sdk\" class=\"headerlink\" title=\"go-sdk\"></a>go-sdk</h3><h4 id=\"config-yaml\"><a href=\"#config-yaml\" class=\"headerlink\" title=\"config.yaml\"></a>config.yaml</h4><p>sdkconfig.yaml</p>\n<p></p>\n<ul>\n<li>clientmsp(keyscerts)BCCSPtls</li>\n<li>channel, peer(peer_name)peer<code>could not get chConfig reference</code></li>\n<li>organizations,(org -&gt; peer_name  orderorg)</li>\n<li>orderers, orderernamerpctls</li>\n<li>peerspeersnamerpctls</li>\n<li>certificateAuthorities canamerpctls</li>\n<li>entityMatchersname(peerordererca)url..</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><p>fabsdk.New(config)</p>\n<ul>\n<li>defPkgSuiteconfigdefaultPkgSuiteconfig<ul>\n<li>Core(corefactory)BCCSPsigning managerfabric primitives<ul>\n<li>BCCSPswpkcs11<ul>\n<li>swsoftware-basedBCCSPgokeystore</li>\n<li>pkcs11pkcs11ecdsarsaaespkcs11pin</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>MSP(..)msppvdr</li>\n<li>Servicechanneldiscovery..</li>\n<li>Logger</li>\n</ul>\n</li>\n</ul>\n<p>fabsdk.newprovide</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//update sdk providers list since all required providers are initialized</span><br><span class=\"line\">\tsdk.provider = context.NewProvider(context.WithCryptoSuiteConfig(cfg.cryptoSuiteConfig),</span><br><span class=\"line\">\t\tcontext.WithEndpointConfig(cfg.endpointConfig),</span><br><span class=\"line\">\t\tcontext.WithIdentityConfig(cfg.identityConfig),</span><br><span class=\"line\">\t\tcontext.WithCryptoSuite(sdk.cryptoSuite),</span><br><span class=\"line\">\t\tcontext.WithSigningManager(signingManager),</span><br><span class=\"line\">\t\tcontext.WithUserStore(userStore),</span><br><span class=\"line\">\t\tcontext.WithLocalDiscoveryProvider(localDiscoveryProvider),</span><br><span class=\"line\">\t\tcontext.WithIdentityManagerProvider(identityManagerProvider),</span><br><span class=\"line\">\t\tcontext.WithInfraProvider(infraProvider),</span><br><span class=\"line\">\t\tcontext.WithChannelProvider(channelProvider),</span><br><span class=\"line\">\t\tcontext.WithClientMetrics(sdk.clientMetrics),</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t...</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>go-sdkrpcsdkrpc clientpkgclient</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> channel   //rpc</span><br><span class=\"line\"> common</span><br><span class=\"line\"> event\t//</span><br><span class=\"line\"> ledger\t//rpc,</span><br><span class=\"line\"> msp\t\t//rpc,caapi</span><br><span class=\"line\"> resmgmt\t//resouce manager clinet</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"msp\"><a href=\"#msp\" class=\"headerlink\" title=\"msp\"></a>msp</h4><p>mspcarpcidentify(msppvdr)</p>\n<p>rpc</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. </span><br><span class=\"line\">2. (ECerts)</span><br><span class=\"line\">3. (TCerts)</span><br><span class=\"line\">4. </span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li>Enroll(config.credentialStore.cryptoStore/)httpcaca(config.credentialStore.path/)<ul>\n<li><a href=\"mailto:name@Org1MSP-cert.pem\" target=\"_blank\" rel=\"noopener\">name@Org1MSP-cert.pem</a>nameOrg1MSPpubKeynamepubKey.SKI()</li>\n</ul>\n</li>\n</ul>\n<p>        Enroll</p>\n<ul>\n<li><p>Register()</p>\n<ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">attributes:</span><br><span class=\"line\">        - name: hf.Revoker</span><br><span class=\"line\">        value: true</span><br><span class=\"line\">        ECert: true</span><br><span class=\"line\">        - name: anotherAttrName</span><br><span class=\"line\">        value: anotherAttrValue</span><br></pre></td></tr></table></figure>\n\n<p>LDAP..</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"channel-1\"><a href=\"#channel-1\" class=\"headerlink\" title=\"channel\"></a>channel</h4><p>api</p>\n<p></p>\n<p>channel<code>Query</code><code>Execute</code></p>\n<p>(handlersopts..)<code>chclinet.InvokeHandler</code><code>InvokeHandler</code>handlerscompletereqCtx.Done()handlerscomplete()reqCtx.Done()HandlerHandlera -&gt; b -&gt;c</p>\n<ul>\n<li><p>Query</p>\n<ul>\n<li><p>ProposalProcessorHandler</p>\n<p>targets0targetstargetsoptsfilter()</p>\n</li>\n<li><p>EndorsementHandler</p>\n<p>proposaltargetsresponses</p>\n</li>\n<li><p>EndorsementValidationHandler</p>\n<p>targetreponse</p>\n</li>\n<li><p>SignatureValidationHandler</p>\n<p>response/</p>\n</li>\n</ul>\n<p>queryreponse</p>\n</li>\n<li><p>Execute</p>\n<ul>\n<li><p>SelectAndEndorseHandler</p>\n<p>targetsEndorsementHandlerproposalpeerproposalresponses</p>\n</li>\n<li><p>EndorsementValidationHandler</p>\n<p></p>\n</li>\n<li><p>SignatureValidationHandler</p>\n<p></p>\n</li>\n<li><p>CommitHandler</p>\n<p>peerorder</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>responsePayloadChaincodeStatusTxValidationCode</p>\n<p>github.com/hyperledger/fabric/protos/peerTxValidationCode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">switch pb.TxValidationCode(response.TxValidationCode) &#123;</span><br><span class=\"line\">\tcase pb.TxValidationCode_VALID:</span><br><span class=\"line\">\t\tcliconfig.Config().Logger().Debugf(&quot;(%s) - Successfully committed transaction [%s] ...\\n&quot;, t.id, response.TransactionID)</span><br><span class=\"line\">\t\treturn nil</span><br><span class=\"line\">\tcase pb.TxValidationCode_DUPLICATE_TXID, pb.TxValidationCode_MVCC_READ_CONFLICT, pb.TxValidationCode_PHANTOM_READ_CONFLICT:</span><br><span class=\"line\">\t\tcliconfig.Config().Logger().Debugf(&quot;(%s) - Transaction commit failed for [%s] with code [%s]. This is most likely a transient error.\\n&quot;, t.id, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\t\treturn invokeerror.Wrapf(invokeerror.TransientError, errors.New(&quot;Duplicate TxID&quot;), &quot;invoke Error received from eventhub for TxID [%s]. Code: %s&quot;, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\tcliconfig.Config().Logger().Debugf(&quot;(%s) - Transaction commit failed for [%s] with code [%s].\\n&quot;, t.id, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\t\treturn invokeerror.Wrapf(invokeerror.PersistentError, errors.New(&quot;error&quot;), &quot;invoke Error received from eventhub for TxID [%s]. Code: %s&quot;, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"sdk-example\"><a href=\"#sdk-example\" class=\"headerlink\" title=\"sdk example\"></a>sdk example</h4><p><a href=\"https://github.com/securekey/fabric-examples/tree/master/fabric-cli\">Sdk example </a></p>\n<h2 id=\"couchdb\"><a href=\"#couchdb\" class=\"headerlink\" title=\"couchdb\"></a>couchdb</h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:5984/mychannel_mycc/_index</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;total_rows&quot;:2,</span><br><span class=\"line\">    &quot;indexes&quot;:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &quot;ddoc&quot;:null,</span><br><span class=\"line\">            &quot;name&quot;:&quot;_all_docs&quot;,</span><br><span class=\"line\">            &quot;type&quot;:&quot;special&quot;,</span><br><span class=\"line\">            &quot;def&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:[</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;_id&quot;:&quot;asc&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &quot;ddoc&quot;:&quot;_design/indexOwnerDoc&quot;,</span><br><span class=\"line\">            &quot;name&quot;:&quot;indexOwner&quot;,</span><br><span class=\"line\">            &quot;type&quot;:&quot;json&quot;,</span><br><span class=\"line\">            &quot;def&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:[</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;docType&quot;:&quot;asc&quot;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;owner&quot;:&quot;asc&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>.</p>\n<p>()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;_id&quot;:&quot;_design/indexOwnerDoc&quot;,</span><br><span class=\"line\">    &quot;_rev&quot;:&quot;1-56c3e9386cb19531f6731afa88281caa&quot;,</span><br><span class=\"line\">    &quot;language&quot;:&quot;query&quot;,</span><br><span class=\"line\">    &quot;views&quot;:&#123;</span><br><span class=\"line\">        &quot;indexOwner&quot;:&#123;</span><br><span class=\"line\">            &quot;map&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:&#123;</span><br><span class=\"line\">                    &quot;docType&quot;:&quot;asc&quot;,</span><br><span class=\"line\">                    &quot;owner&quot;:&quot;asc&quot;</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                &quot;partial_filter_selector&quot;:&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;reduce&quot;:&quot;_count&quot;,</span><br><span class=\"line\">            &quot;options&quot;:&#123;</span><br><span class=\"line\">                &quot;def&quot;:&#123;</span><br><span class=\"line\">                    &quot;fields&quot;:[</span><br><span class=\"line\">                        &quot;docType&quot;,</span><br><span class=\"line\">                        &quot;owner&quot;</span><br><span class=\"line\">                    ]</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>META-INF</p>\n<p>json</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t&quot;index&quot;:&#123;&quot;fields&quot;:[&quot;docType&quot;,&quot;owner&quot;]&#125;,</span><br><span class=\"line\">\t&quot;ddoc&quot;:&quot;indexOwnerDoc&quot;,</span><br><span class=\"line\">\t&quot;name&quot;:&quot;indexOwner&quot;,</span><br><span class=\"line\">\t&quot;type&quot;:&quot;json&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>()</p>\n<p>id</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;type&quot;: &quot;special&quot;,</span><br><span class=\"line\"> &quot;def&quot;: &#123;</span><br><span class=\"line\">  &quot;fields&quot;: [</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">    &quot;_id&quot;: &quot;asc&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d &quot;&#123;\\&quot;index\\&quot;:&#123;\\&quot;fields\\&quot;:[\\&quot;size\\&quot;,\\&quot;docType\\&quot;,\\&quot;owner\\&quot;]&#125;,\\&quot;ddoc\\&quot;:\\&quot;indexSizeSortDoc1\\&quot;, \\&quot;name\\&quot;:\\&quot;indexSizeSortDesc1\\&quot;,\\&quot;type\\&quot;:\\&quot;json\\&quot;&#125;&quot; http://localhost:5984/mychannel_mycc/_index</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;total_rows&quot;:3,</span><br><span class=\"line\">    &quot;indexes&quot;:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">         ...</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">         ...</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &quot;ddoc&quot;:&quot;_design/indexSizeSortDoc&quot;,</span><br><span class=\"line\">            &quot;name&quot;:&quot;indexSizeSortDesc&quot;,</span><br><span class=\"line\">            &quot;type&quot;:&quot;json&quot;,</span><br><span class=\"line\">            &quot;def&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:[</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;size&quot;:&quot;desc&quot;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;docType&quot;:&quot;desc&quot;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;owner&quot;:&quot;desc&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>size</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&#123;\\&quot;selector\\&quot;:&#123;\\&quot;docType\\&quot;:&#123;\\&quot;$eq\\&quot;:\\&quot;marble\\&quot;&#125;,\\&quot;owner\\&quot;:&#123;\\&quot;$eq\\&quot;:\\&quot;tom\\&quot;&#125;,\\&quot;size\\&quot;:&#123;\\&quot;$gt\\&quot;:0&#125;&#125;,\\&quot;fields\\&quot;:[\\&quot;docType\\&quot;,\\&quot;owner\\&quot;,\\&quot;size\\&quot;],\\&quot;sort\\&quot;:[&#123;\\&quot;size\\&quot;:\\&quot;desc\\&quot;&#125;],\\&quot;use_index\\&quot;:\\&quot;_design/indexSizeSortDoc\\&quot;&#125;&quot;</span><br></pre></td></tr></table></figure>\n\n<p><strong></strong>sizedocTypeownerdocTypesize<code>Error running query. Reason: (no_usable_index) No index exists for this sort, try indexing by the sort fields.</code></p>\n<p></p>\n<ol>\n<li>sortselectorfieldindex(id asc)</li>\n<li>sortindex selectorfield + sortfieldfield indexfieldselectorfield + sortfieldfieldindexselectorsortsortindex</li>\n</ol>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Fabric\"><a href=\"#Fabric\" class=\"headerlink\" title=\"Fabric\"></a>Fabric</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><a href=\"http://hyperledger-fabric.readthedocs.io/en/master/arch-deep-dive.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<p><img src=\"./fabric_macro.jpg\" alt=\"\"></p>\n<p>fabric</p>\n<ul>\n<li>application: SDK</li>\n<li>membership fabric-ca</li>\n<li>peer: <ul>\n<li>Endorser()peeryes/no</li>\n<li>Committer</li>\n<li>Ledger</li>\n<li>chaincodefabric</li>\n<li>Eventfabric</li>\n</ul>\n</li>\n<li>o-service</li>\n</ul>\n<p>chaincodeendorsedendorsed</p>\n<p><strong></strong></p>\n<ul>\n<li></li>\n<li>invokechaincodechaincode - </li>\n</ul>\n<p></p>\n<p><strong>State</strong>stateKVSapplicationsKVSput,get..StatepeersordersclientsKVSKeyskeyskeys</p>\n<p><strong>Ledger, </strong>1peerordersordersOrdererLedger()peersPeerLedgerpeerspeersordersorderingpeersstate,state</p>\n<p><strong></strong>3</p>\n<ul>\n<li>Client  submitting-client: endorsersordering</li>\n<li>Peerstatepeersendorser</li>\n<li>Ordering-service-nodeorder -&gt; order</li>\n</ul>\n<p>clientspeers, clientpeerspeers</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p></p>\n<ol>\n<li>Applicationpeer</li>\n<li>Peerendorse</li>\n<li>orderersorderersblockblockpeerlerdger</li>\n</ol>\n<p></p>\n<p><img src=\"./fabric_peer.jpg\" alt=\"\"></p>\n<h4 id=\"channel\"><a href=\"#channel\" class=\"headerlink\" title=\"channel\"></a>channel</h4><p>channelFabricchannelpeer</p>\n<p>channelpeer</p>\n<p>Fabricfirst-network<u>demo</u>! <del> fabric</del></p>\n<p>.. </p>\n<p>first-networkpeerpeerpeerpeer</p>\n<h3 id=\"fabric-\"><a href=\"#fabric-\" class=\"headerlink\" title=\"fabric \"></a>fabric </h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Policy for [Groups] /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required [Admins]...</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>/or1.adminorg2.admin(..)</p>\n<p>SigningIdentity<code>fmt.Println(string(identity.EnrollmentCertificate()))</code></p>\n<p>go-sdktmpcaadmin..caadminadminorg1.admin(x;)..  admin</p>\n<p><code>peer chaincode instantiate -p git.wokoworks.com/blockchain/fabric-thread/multipeer/chaincode/go/test  -n mytest -v 0</code></p>\n<p>peer<code>/var/hyperledger/production/chaincodes</code><code>mycc.0</code></p>\n<p>?  peer</p>\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  cli:</span><br><span class=\"line\">    container_name: cli</span><br><span class=\"line\">    image: hyperledger/fabric-tools</span><br><span class=\"line\">    tty: true</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - GOPATH=/opt/gopath</span><br><span class=\"line\">      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br><span class=\"line\">      - FABRIC_LOGGING_SPEC=DEBUG</span><br><span class=\"line\">      - CORE_PEER_ID=cli</span><br><span class=\"line\">      - CORE_PEER_ADDRESS=peer:7051</span><br><span class=\"line\">      - CORE_PEER_LOCALMSPID=DEFAULT</span><br><span class=\"line\">      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp</span><br><span class=\"line\">    working_dir: /opt/gopath/src/chaincodedev</span><br><span class=\"line\">#    command: /bin/bash -c &apos;./script.sh&apos;</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /var/run/:/host/var/run/</span><br><span class=\"line\">      - ./nodes/peer1/msp:/etc/hyperledger/msp</span><br><span class=\"line\">      - /Users/xiaoxuez/go/src/github.com/hyperledger/fabric/examples/chaincode/go:/opt/gopath/src/chaincodedev/chaincode</span><br><span class=\"line\">      - ./:/opt/gopath/src/chaincodedev/</span><br><span class=\"line\">    depends_on:</span><br><span class=\"line\">      - orderer</span><br><span class=\"line\">      - peer1</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure.sh &quot;mychannel&quot; &quot;channel.tx anchor.tx&quot; &quot;peer1 peer2 peer3 peer4&quot; false</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h4 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1. \"></a>1. </h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cryptogen generate  --config ./crypto-config.yaml --output crypto-config</span><br></pre></td></tr></table></figure>\n\n<p>output </p>\n<p>crypto-config.yaml</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OrdererOrgs:</span><br><span class=\"line\">  - Name: Orderer</span><br><span class=\"line\">    Domain: orderer.net</span><br><span class=\"line\">    CA:</span><br><span class=\"line\">      Country: US</span><br><span class=\"line\">      Province: California</span><br><span class=\"line\">      Locality: San Francisco</span><br><span class=\"line\">    Specs:</span><br><span class=\"line\">      - Hostname: orderer</span><br><span class=\"line\"></span><br><span class=\"line\">PeerOrgs:</span><br><span class=\"line\">  - Name: Org1</span><br><span class=\"line\">    Domain: org1.net</span><br><span class=\"line\">    CA:</span><br><span class=\"line\">      Country: US</span><br><span class=\"line\">      Province: California</span><br><span class=\"line\">      Locality: San Francisco</span><br><span class=\"line\">    Template:</span><br><span class=\"line\">      Count: 4</span><br><span class=\"line\">      Start: 1</span><br><span class=\"line\">    Users:</span><br><span class=\"line\">      Count: 1</span><br></pre></td></tr></table></figure>\n\n<p>OrdererOrg1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crypto-config</span><br><span class=\"line\"> ordererOrganizations</span><br><span class=\"line\">  orderer.net</span><br><span class=\"line\">      ca</span><br><span class=\"line\">      msp</span><br><span class=\"line\">      orderers</span><br><span class=\"line\">      tlsca</span><br><span class=\"line\">      users</span><br><span class=\"line\"> peerOrganizations</span><br><span class=\"line\">     org1.net</span><br><span class=\"line\">         ca</span><br><span class=\"line\">         msp</span><br><span class=\"line\">         peers //count4peers4</span><br><span class=\"line\">         tlsca</span><br><span class=\"line\">         users</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>cryptogen</p>\n<p></p>\n<ol>\n<li></li>\n<li>root caroot caconfigcaroot ca()root ca()ca</li>\n<li>fabrictls.. ()catlsca</li>\n<li>mspcatlsca()admin()</li>\n<li>userspeerspeeruserroot catlscadroot catlsca</li>\n</ol>\n<p>caroot caca serverx509fabric-sdk-goenrollpeerpeer.. peerroot ca(root ca)a -&gt; b -&gt; c</p>\n<h4 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2. \"></a>2. </h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configtxgen -profile SampleOrg -outputBlock ./channel-artifacts/genesis.block</span><br></pre></td></tr></table></figure>\n\n<p><code>configtx.yaml</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CORE_PEER_ADDRESS=peer1:7051 peer chaincode install -p chaincodedev/chaincode/sacc -n mycc -v 0</span><br><span class=\"line\">//-p  Path to chaincode,</span><br><span class=\"line\">//  \tgopathgopath/chaincodedev/chaincode/sacc, sacc</span><br><span class=\"line\">//-n, --name string                    Name of the chaincode</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C $CHANNEL_NAME -n mycc -v 1.0 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&apos; -P &quot;OR (&apos;Org1MSP.admin&apos;,&apos;Org1MSP.member&apos;)&quot;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer chaincode instantiate -o orderer.example.com:7050  --tls true --cafile  /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n marbles02 -v 0 -c &apos;&#123;&quot;Args&quot;:[&quot;&quot;]&#125;&apos; -P &quot;OR (&apos;Org1MSP.admin&apos;,&apos;Org1MSP.member&apos;)&quot;</span><br><span class=\"line\">//tsl--tls true --cafile  -oorderer.example.com:7050  -P</span><br></pre></td></tr></table></figure>\n\n<p>configtx.yamlProfilesgenesis(order(Consortiums = =))channel(ConsortiumApplication)</p>\n<p>configtx.yamlOneOrgOrdererGenesisProfiles</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configtxgen -profile OneOrgOrdererGenesis -outputBlock ./config/genesis.block</span><br></pre></td></tr></table></figure>\n\n<p>OneOrgChannelProfiles</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configtxgen -profile  OneOrgChannel -outputCreateChannelTx ./config/channel.tx -channelID $CHANNEL_NAME</span><br></pre></td></tr></table></figure>\n\n<p>.tx</p>\n<h3 id=\"go-sdk\"><a href=\"#go-sdk\" class=\"headerlink\" title=\"go-sdk\"></a>go-sdk</h3><h4 id=\"config-yaml\"><a href=\"#config-yaml\" class=\"headerlink\" title=\"config.yaml\"></a>config.yaml</h4><p>sdkconfig.yaml</p>\n<p></p>\n<ul>\n<li>clientmsp(keyscerts)BCCSPtls</li>\n<li>channel, peer(peer_name)peer<code>could not get chConfig reference</code></li>\n<li>organizations,(org -&gt; peer_name  orderorg)</li>\n<li>orderers, orderernamerpctls</li>\n<li>peerspeersnamerpctls</li>\n<li>certificateAuthorities canamerpctls</li>\n<li>entityMatchersname(peerordererca)url..</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li><p>fabsdk.New(config)</p>\n<ul>\n<li>defPkgSuiteconfigdefaultPkgSuiteconfig<ul>\n<li>Core(corefactory)BCCSPsigning managerfabric primitives<ul>\n<li>BCCSPswpkcs11<ul>\n<li>swsoftware-basedBCCSPgokeystore</li>\n<li>pkcs11pkcs11ecdsarsaaespkcs11pin</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>MSP(..)msppvdr</li>\n<li>Servicechanneldiscovery..</li>\n<li>Logger</li>\n</ul>\n</li>\n</ul>\n<p>fabsdk.newprovide</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//update sdk providers list since all required providers are initialized</span><br><span class=\"line\">\tsdk.provider = context.NewProvider(context.WithCryptoSuiteConfig(cfg.cryptoSuiteConfig),</span><br><span class=\"line\">\t\tcontext.WithEndpointConfig(cfg.endpointConfig),</span><br><span class=\"line\">\t\tcontext.WithIdentityConfig(cfg.identityConfig),</span><br><span class=\"line\">\t\tcontext.WithCryptoSuite(sdk.cryptoSuite),</span><br><span class=\"line\">\t\tcontext.WithSigningManager(signingManager),</span><br><span class=\"line\">\t\tcontext.WithUserStore(userStore),</span><br><span class=\"line\">\t\tcontext.WithLocalDiscoveryProvider(localDiscoveryProvider),</span><br><span class=\"line\">\t\tcontext.WithIdentityManagerProvider(identityManagerProvider),</span><br><span class=\"line\">\t\tcontext.WithInfraProvider(infraProvider),</span><br><span class=\"line\">\t\tcontext.WithChannelProvider(channelProvider),</span><br><span class=\"line\">\t\tcontext.WithClientMetrics(sdk.clientMetrics),</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t...</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>go-sdkrpcsdkrpc clientpkgclient</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> channel   //rpc</span><br><span class=\"line\"> common</span><br><span class=\"line\"> event\t//</span><br><span class=\"line\"> ledger\t//rpc,</span><br><span class=\"line\"> msp\t\t//rpc,caapi</span><br><span class=\"line\"> resmgmt\t//resouce manager clinet</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"msp\"><a href=\"#msp\" class=\"headerlink\" title=\"msp\"></a>msp</h4><p>mspcarpcidentify(msppvdr)</p>\n<p>rpc</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. </span><br><span class=\"line\">2. (ECerts)</span><br><span class=\"line\">3. (TCerts)</span><br><span class=\"line\">4. </span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li>Enroll(config.credentialStore.cryptoStore/)httpcaca(config.credentialStore.path/)<ul>\n<li><a href=\"mailto:name@Org1MSP-cert.pem\" target=\"_blank\" rel=\"noopener\">name@Org1MSP-cert.pem</a>nameOrg1MSPpubKeynamepubKey.SKI()</li>\n</ul>\n</li>\n</ul>\n<p>        Enroll</p>\n<ul>\n<li><p>Register()</p>\n<ul>\n<li><p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">attributes:</span><br><span class=\"line\">        - name: hf.Revoker</span><br><span class=\"line\">        value: true</span><br><span class=\"line\">        ECert: true</span><br><span class=\"line\">        - name: anotherAttrName</span><br><span class=\"line\">        value: anotherAttrValue</span><br></pre></td></tr></table></figure>\n\n<p>LDAP..</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"channel-1\"><a href=\"#channel-1\" class=\"headerlink\" title=\"channel\"></a>channel</h4><p>api</p>\n<p></p>\n<p>channel<code>Query</code><code>Execute</code></p>\n<p>(handlersopts..)<code>chclinet.InvokeHandler</code><code>InvokeHandler</code>handlerscompletereqCtx.Done()handlerscomplete()reqCtx.Done()HandlerHandlera -&gt; b -&gt;c</p>\n<ul>\n<li><p>Query</p>\n<ul>\n<li><p>ProposalProcessorHandler</p>\n<p>targets0targetstargetsoptsfilter()</p>\n</li>\n<li><p>EndorsementHandler</p>\n<p>proposaltargetsresponses</p>\n</li>\n<li><p>EndorsementValidationHandler</p>\n<p>targetreponse</p>\n</li>\n<li><p>SignatureValidationHandler</p>\n<p>response/</p>\n</li>\n</ul>\n<p>queryreponse</p>\n</li>\n<li><p>Execute</p>\n<ul>\n<li><p>SelectAndEndorseHandler</p>\n<p>targetsEndorsementHandlerproposalpeerproposalresponses</p>\n</li>\n<li><p>EndorsementValidationHandler</p>\n<p></p>\n</li>\n<li><p>SignatureValidationHandler</p>\n<p></p>\n</li>\n<li><p>CommitHandler</p>\n<p>peerorder</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>responsePayloadChaincodeStatusTxValidationCode</p>\n<p>github.com/hyperledger/fabric/protos/peerTxValidationCode</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">switch pb.TxValidationCode(response.TxValidationCode) &#123;</span><br><span class=\"line\">\tcase pb.TxValidationCode_VALID:</span><br><span class=\"line\">\t\tcliconfig.Config().Logger().Debugf(&quot;(%s) - Successfully committed transaction [%s] ...\\n&quot;, t.id, response.TransactionID)</span><br><span class=\"line\">\t\treturn nil</span><br><span class=\"line\">\tcase pb.TxValidationCode_DUPLICATE_TXID, pb.TxValidationCode_MVCC_READ_CONFLICT, pb.TxValidationCode_PHANTOM_READ_CONFLICT:</span><br><span class=\"line\">\t\tcliconfig.Config().Logger().Debugf(&quot;(%s) - Transaction commit failed for [%s] with code [%s]. This is most likely a transient error.\\n&quot;, t.id, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\t\treturn invokeerror.Wrapf(invokeerror.TransientError, errors.New(&quot;Duplicate TxID&quot;), &quot;invoke Error received from eventhub for TxID [%s]. Code: %s&quot;, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\tdefault:</span><br><span class=\"line\">\t\tcliconfig.Config().Logger().Debugf(&quot;(%s) - Transaction commit failed for [%s] with code [%s].\\n&quot;, t.id, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\t\treturn invokeerror.Wrapf(invokeerror.PersistentError, errors.New(&quot;error&quot;), &quot;invoke Error received from eventhub for TxID [%s]. Code: %s&quot;, response.TransactionID, response.TxValidationCode)</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"sdk-example\"><a href=\"#sdk-example\" class=\"headerlink\" title=\"sdk example\"></a>sdk example</h4><p><a href=\"https://github.com/securekey/fabric-examples/tree/master/fabric-cli\">Sdk example </a></p>\n<h2 id=\"couchdb\"><a href=\"#couchdb\" class=\"headerlink\" title=\"couchdb\"></a>couchdb</h2><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:5984/mychannel_mycc/_index</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;total_rows&quot;:2,</span><br><span class=\"line\">    &quot;indexes&quot;:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &quot;ddoc&quot;:null,</span><br><span class=\"line\">            &quot;name&quot;:&quot;_all_docs&quot;,</span><br><span class=\"line\">            &quot;type&quot;:&quot;special&quot;,</span><br><span class=\"line\">            &quot;def&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:[</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;_id&quot;:&quot;asc&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &quot;ddoc&quot;:&quot;_design/indexOwnerDoc&quot;,</span><br><span class=\"line\">            &quot;name&quot;:&quot;indexOwner&quot;,</span><br><span class=\"line\">            &quot;type&quot;:&quot;json&quot;,</span><br><span class=\"line\">            &quot;def&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:[</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;docType&quot;:&quot;asc&quot;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;owner&quot;:&quot;asc&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>.</p>\n<p>()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;_id&quot;:&quot;_design/indexOwnerDoc&quot;,</span><br><span class=\"line\">    &quot;_rev&quot;:&quot;1-56c3e9386cb19531f6731afa88281caa&quot;,</span><br><span class=\"line\">    &quot;language&quot;:&quot;query&quot;,</span><br><span class=\"line\">    &quot;views&quot;:&#123;</span><br><span class=\"line\">        &quot;indexOwner&quot;:&#123;</span><br><span class=\"line\">            &quot;map&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:&#123;</span><br><span class=\"line\">                    &quot;docType&quot;:&quot;asc&quot;,</span><br><span class=\"line\">                    &quot;owner&quot;:&quot;asc&quot;</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                &quot;partial_filter_selector&quot;:&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;reduce&quot;:&quot;_count&quot;,</span><br><span class=\"line\">            &quot;options&quot;:&#123;</span><br><span class=\"line\">                &quot;def&quot;:&#123;</span><br><span class=\"line\">                    &quot;fields&quot;:[</span><br><span class=\"line\">                        &quot;docType&quot;,</span><br><span class=\"line\">                        &quot;owner&quot;</span><br><span class=\"line\">                    ]</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>META-INF</p>\n<p>json</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">\t&quot;index&quot;:&#123;&quot;fields&quot;:[&quot;docType&quot;,&quot;owner&quot;]&#125;,</span><br><span class=\"line\">\t&quot;ddoc&quot;:&quot;indexOwnerDoc&quot;,</span><br><span class=\"line\">\t&quot;name&quot;:&quot;indexOwner&quot;,</span><br><span class=\"line\">\t&quot;type&quot;:&quot;json&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>()</p>\n<p>id</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;type&quot;: &quot;special&quot;,</span><br><span class=\"line\"> &quot;def&quot;: &#123;</span><br><span class=\"line\">  &quot;fields&quot;: [</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">    &quot;_id&quot;: &quot;asc&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d &quot;&#123;\\&quot;index\\&quot;:&#123;\\&quot;fields\\&quot;:[\\&quot;size\\&quot;,\\&quot;docType\\&quot;,\\&quot;owner\\&quot;]&#125;,\\&quot;ddoc\\&quot;:\\&quot;indexSizeSortDoc1\\&quot;, \\&quot;name\\&quot;:\\&quot;indexSizeSortDesc1\\&quot;,\\&quot;type\\&quot;:\\&quot;json\\&quot;&#125;&quot; http://localhost:5984/mychannel_mycc/_index</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;total_rows&quot;:3,</span><br><span class=\"line\">    &quot;indexes&quot;:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">         ...</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">         ...</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            &quot;ddoc&quot;:&quot;_design/indexSizeSortDoc&quot;,</span><br><span class=\"line\">            &quot;name&quot;:&quot;indexSizeSortDesc&quot;,</span><br><span class=\"line\">            &quot;type&quot;:&quot;json&quot;,</span><br><span class=\"line\">            &quot;def&quot;:&#123;</span><br><span class=\"line\">                &quot;fields&quot;:[</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;size&quot;:&quot;desc&quot;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;docType&quot;:&quot;desc&quot;</span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        &quot;owner&quot;:&quot;desc&quot;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                ]</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>size</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&#123;\\&quot;selector\\&quot;:&#123;\\&quot;docType\\&quot;:&#123;\\&quot;$eq\\&quot;:\\&quot;marble\\&quot;&#125;,\\&quot;owner\\&quot;:&#123;\\&quot;$eq\\&quot;:\\&quot;tom\\&quot;&#125;,\\&quot;size\\&quot;:&#123;\\&quot;$gt\\&quot;:0&#125;&#125;,\\&quot;fields\\&quot;:[\\&quot;docType\\&quot;,\\&quot;owner\\&quot;,\\&quot;size\\&quot;],\\&quot;sort\\&quot;:[&#123;\\&quot;size\\&quot;:\\&quot;desc\\&quot;&#125;],\\&quot;use_index\\&quot;:\\&quot;_design/indexSizeSortDoc\\&quot;&#125;&quot;</span><br></pre></td></tr></table></figure>\n\n<p><strong></strong>sizedocTypeownerdocTypesize<code>Error running query. Reason: (no_usable_index) No index exists for this sort, try indexing by the sort fields.</code></p>\n<p></p>\n<ol>\n<li>sortselectorfieldindex(id asc)</li>\n<li>sortindex selectorfield + sortfieldfield indexfieldselectorfield + sortfieldfieldindexselectorsortsortindex</li>\n</ol>\n"},{"title":"kibana-plugin","date":"2017-10-14T05:54:55.000Z","_content":"## Kibana\n\n### Kibana\n\n- visTypes Visualize\n- app timeline\n- hacks, Any module that should be included in every application\n- chromeNavControls,\n- [](https://www.elastic.co/guide/en/kibana/current/development-uiexports.html)...\n\n#### visTypes\n\n------\n\n### \n\n- git clone kibanaes\n\n- npm install,\n\n  - git http\n\n  ```\n  git config --global url.\"https://\".insteadOf \"git://\"\n  ```\n\n  - chromedriver\n\n  ```\n  npm ERR! chromedriver@2.32.3 install: `node install.js`\n  ```\n\n   \n\n  ```\n  npm install chromedriver --chromedriver_cdnurl=https://npm.taobao.org/mirrors/chromedriver\n  ```\n\n  - dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js\n\n  ```\n    if (opts.dev) {\n      set('env', 'development');\n      set('optimize.lazy', true);\n\n      // if (opts.ssl) {\n      //   set('server.ssl.enabled', true);\n      // }\n\n      // if (opts.ssl && !has('server.ssl.certificate') && !has('server.ssl.key')) {\n      //   set('server.ssl.certificate', DEV_SSL_CERT_PATH);\n      //   set('server.ssl.key', DEV_SSL_KEY_PATH);\n      // }\n    }\n\n  ```\n\n- npm start\n\n### First Blood\n\nvisTypeskibana/plugins\n\n```\nsao kibana-plugin\n```\n\nvisTypesapp componenttranslation filesan hack component a server APIno\n\n- new TemplateVisType\n\n```\nreturn new TemplateVisType({\n    name: 'extended_metric',\n    title: 'Extended Metric',\n    description: 'Based on the core Metric-Plugin but gives you the ability' +\n      'to output custom aggregates on metric-results.',\n    icon: 'fa-calculator',\n    template: extendedMetricVisTemplate, //\n    params: { //Options\n      defaults: {\n        handleNoResults: true,\n        fontSize: 60,\n        outputs: [\n          {\n            formula: 'metrics[0].value * metrics[0].value',\n            label: 'Count squared',\n            enabled: true\n          }\n        ]\n      },\n      editor: metricVisParamsTemplate //Options\n    },\n    schemas: new Schemas([ //Data\n      {\n        group: 'metrics',\n        name: 'metric',\n        title: 'Metric',\n        min: 1,\n        defaults: [\n          { type: 'count', schema: 'metric' }\n        ]\n      }\n    ])\n  });\n```\n\n[](https://github.com/ommsolutions/kibana_ext_metrics_vis)vis\n\nAngularJS\n\nvis\n\n- schema, Datametric  Y bucket  X Kibana4  bucket  Schema  segment(), group  split group\n- Options(params),Optionshtml\n- html\n- controller, html, V <-> C\n\nesviewvis[](https://sunyonggang.gitbooks.io/elkstack-guide-cn/content/kibana/v4/source-code-analysis/visualize_app.html)\n\n- src/core\\_plugins/kbn\\_vislib\\_vis\\_types\n- src/ui/public/vislibvisviscontrollerhtmlcontroller,d3\n\n..\n\nTemplateVisType\n\n```\nexport default function TemplateVisTypeFactory(Private) {\n  const VisType = Private(VisVisTypeProvider);\n  const TemplateRenderbot = Private(TemplateVisTypeTemplateRenderbotProvider);\n\n\t// VisTypetemplate\n  _.class(TemplateVisType).inherits(VisType);\n  function TemplateVisType(opts = {}) {\n    TemplateVisType.Super.call(this, opts);\n\n    this.template = opts.template;\n    if (!this.template) {\n      throw new Error('Missing template for TemplateVisType');\n    }\n  }\n\t// createRenderbot\n  TemplateVisType.prototype.createRenderbot = function (vis, $el, uiState) {\n    return new TemplateRenderbot(vis, $el, uiState);\n  };\n\n  return TemplateVisType;\n}\n\n```\n\nVislibVisTypevisTemplateVisType\n\n```\nexport default function VislibVisTypeFactory(Private) {\n\t...\n\tconst updateParams = function (params) {\n\t\tconst updateIfSet = (from, to, prop, func) => {\n\t      if (from[prop]) {\n\t        to[prop] = func ? func(from[prop]) : from[prop];\n\t      }\n\t    };\n\t    ...\n\t})\n\t...\n\t// VisTyperesponseConverter\n\t_.class(VislibVisType).inherits(VisType);\n   function VislibVisType(opts = {}) {\n     VislibVisType.Super.call(this, opts);\n\n     if (this.responseConverter == null) {\n       this.responseConverter = pointSeries;\n     }\n\n     this.listeners = opts.listeners || {};\n   }\n\t// createRenderbot\n\t   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) {\n\t   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]\n\t    updateParams(vis.params);\n\t    return new VislibRenderbot(vis, $el, uiState);\n\t};\n}\n```\n\nVisType\n\n```\nexport default function VisTypeFactory(Private) {\n  /**\n   * Provides the visualizations for the vislib angular module,visclass\n   *\n   * @module vislib\n   * @submodule VisTypeFactory\n   * @param Private {Object} Loads any function as an angular module\n   * @return {Function} Returns an Object of Visualization classes\n   */\n  return {\n    pie: Private(VislibVisualizationsPieChartProvider),\n    point_series: Private(VislibVisualizationsPointSeriesProvider)\n  };\n}\n\n```\n\n...angular modulevisclassVislibRenderbot\n\n```\n\t//\n\tVislibRenderbot.prototype._createVis\n\tVislibRenderbot.prototype._getVislibParams\n\tVislibRenderbot.prototype.destroy\n\tVislibRenderbot.prototype.updateParams\n\t//renderbuildChartDatavislibVis\n\tVislibRenderbot.prototype.render = function (esResponse) {\n\t    this.chartData = this.buildChartData(esResponse);\n\t    return AngularPromise.delay(1).then(() => {\n\t      this.vislibVis.render(this.chartData, this.uiState);\n\t      this.refreshLegend++;\n\t    });\n\t  };\n\n```\n\n....vislibVissrc/ui/visualization_chart.js,_chart.jsrenderdraw_chartdrawgithubvis\n\nVisrenderdata -> {Object} Elasticsearch query results, datavis.renderVislibRenderbot\\_createVisVislibRenderbotvislibrenderbotsrc/ui/public/visualize/visualize.js\n\n```\n  $scope.$watch('esResp', prereq(function (resp) {\n    if (!resp) return;\n    $scope.renderbot.render(resp); //esrenderbot\n  }));\n```\n\nVislibRenderbot\n\n```\n  VislibRenderbot.prototype.render = function (esResponse) {\n    this.chartData = this.buildChartData(esResponse);\n    return AngularPromise.delay(1).then(() => {\n      this.vislibVis.render(this.chartData, this.uiState);\n      this.refreshLegend++;\n    });\n  };\n```\n\n! renderesrenderbotrenderbotbuildChartDatachartDatavis.renderdata\n\n! VislibVisTypecreateRenderbotVislibRenderbot,VislibRenderbotvisualizevisualizeVislibRenderbotvislibVishtmlesdata,VislibRenderbotVislibRenderbotdatabuildChartData\n\n#### extended_metric\n\nTemplateVisType, VislibVisTyperenderbotTemplateRenderbot,render$scope\n\n```\n  TemplateRenderbot.prototype.render = function (esResponse) {\n    this.$scope.esResponse = esResponse;\n  };\n```\n\nextended_metriccontroller\n\n```\n  // watches\n  $scope.$watch('esResponse', function (resp) {\n    if (resp) {\n      calcOutputs.length = 0;\n      metrics.length = 0;\n      for (let key in metrics) {\n        if (metrics.hasOwnProperty(key)) {\n          delete metrics[key];\n        }\n      }\n      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));\n    }\n  });\n\n```\n\nAngular.. Angular...extended_metric\n\n```\n  $scope.processTableGroups = function (tableGroups) {\n    tableGroups.tables.forEach(function (table) {\n      table.columns.forEach(function (column, i) {\n        const fieldFormatter = table.aggConfig(column).fieldFormatter();\n        let value = table.rows[0][i]; //estable.rows\n        let formattedValue = isInvalid(value) ? '?' : fieldFormatter(value);     //label, formattedValue\n        const metric = {\n          label: column.title,\n          value: value,\n          formattedValue: formattedValue\n        };\n        metrics.push(metric);\n        metrics[column.title] = metric;\n      });\n    });\n    updateOutputs();\n  };\n```\n\nprocessTableGroupstabifyAggResponse($scope.vis, resp)tabifyAggResponseestable,linepoint_series.jsvis,eslabel\n\n#### line\\_sg\n\n[](https://github.com/sbeyn/kibana-plugin-line-sg)\n\n\n\nline\\_sg.jsTemplateVisTypeparamsschemas\n\nline\\_sg.html,c3controller\\_params.html,Optioncontroller,controller\n\n```\n  $scope.$watch('esResponse', function (resp) {\n      if (resp) {\n        console.log(resp);\n        metrics.length = 0; //metricslength,emmm\n        $scope.processTableGroups(tabifyAggResponse($scope.vis, resp)); //..metrics\n        $scope.showGraph(); //metrics\n      }\n    });\n```\n\nc3pluginskibana,chart_types=step\n\nparams\n\nc3kibanalinestep.....lineparams..$scope.$watch$watchControllerwatch\n\n\n\n\n\n\n\n\n\n------\n\n\n\n```\n                                                 /===-_---~~~~~~~~~------____\n                                                |===-~___                _,-'\n                 -==\\\\                         `//~\\\\   ~~~~`---.___.-~~\n             ______-==|                         | |  \\\\           _-~`\n       __--~~~  ,-/-==\\\\                        | |   `\\        ,'\n    _-~       /'    |  \\\\                      / /      \\      /\n  .'        /       |   \\\\                   /' /        \\   /'\n /  ____  /         |    \\`\\.__/-~~ ~ \\ _ _/'  /          \\/'\n/-'~    ~~~~~---__  |     ~-/~         ( )   /'        _--~`\n                  \\_|      /        _)   ;  ),   __--~~\n                    '~~--_/      _-~/-  / \\   '-~ \\\n                   {\\__--_/}    / \\\\_>- )<__\\      \\\n                   /'   (_/  _-~  | |__>--<__|      |\n                  |0  0 _/) )-~     | |__>--<__|      |\n                  / /~ ,_/       / /__>---<__/      |\n                 o o _//        /-~_>---<__-~      /\n                 (^(~          /~_>---<__-      _-~\n                ,/|           /__>--<__/     _-~\n             ,//('(          |__>--<__|     /                  .----_\n            ( ( '))          |__>--<__|    |                 /' _---_~\\\n         `-)) )) (           |__>--<__|    |               /'  /     ~\\`\\\n        ,/,'//( (             \\__>--<__\\    \\            /'  //        ||\n      ,( ( ((, ))              ~-__>--<_~-_  ~--____---~' _/'/        /'\n    `~/  )` ) ,/|                 ~-_~>--<_/-__       __-~ _/\n  ._-~//( )/ )) `                    ~~-'_/_/ /~~~~~~~__--~\n   ;'( ')/ ,)(                              ~~~~~~~~~~\n  ' ') '( (/\n    '   '  `\n\n\n```\n\n\n\n------\n\n\n\n[sao](https://github.com/saojs/sao),[](https://github.com/elastic/template-kibana-plugin)[](https://www.gitbook.com/book/trumandu/kibana-plugin-development-tutorial/details)..\n\n### visTypes\n\nVisualizees6,angular(angular12kibanaangular1)kibanaVisualize[d3](https://d3js.org/)\n\n#### \n\nvis[](https://github.com/ommsolutions/kibana_ext_metrics_vis)()gifmetric(kibana(*10))\n\nextended\\_metric\\_vis.js\n\n```\n\treturn new TemplateVisType({\n\t    name: 'extended_metric',\n\t    title: 'Extended Metric',\n\t    description: 'Based on the core Metric-Plugin but gives you the ability' +\n\t      'to output custom aggregates on metric-results.',\n\t    icon: 'fa-calculator',\n\t    template: extendedMetricVisTemplate, //.html\n\t    params: { //OptionsOptions\n\t      defaults: {\n\t        handleNoResults: true,\n\t        fontSize: 60,\n\t        outputs: [\n\t          {\n\t            formula: 'metrics[0].value * metrics[0].value',\n\t            label: 'Count squared',\n\t            enabled: true\n\t          }\n\t        ]\n\t      },\n\t      editor: metricVisParamsTemplate //Options.html\n\t    },\n\t    schemas: new Schemas([ //Data\n\t    \t\t\t\t\t//metricbucketmetric  Y bucket  X \n\t      {           // bucket  Schema  segment(), group  split\n\t        group: 'metrics',\n\t        name: 'metric',\n\t        title: 'Metric',\n\t        min: 1,\n\t        defaults: [\n\t          { type: 'count', schema: 'metric' }\n\t        ]\n\t      }\n\t    ])\n\t  });\n\n```\n\nvisTemplateVisType\n\nhtmlextended\\_metric\\_vis.htmlextended\\_metric\\_vis\\_params.html, view,angularmvcc => extended\\_metric\\_vis\\_controller.jsangular\n\n```\n$scope.$watch('esResponse', function (resp) {\n    if (resp) {\n      calcOutputs.length = 0;\n      metrics.length = 0;\n      //metrics\n      for (let key in metrics) {\n        if (metrics.hasOwnProperty(key)) {\n          delete metrics[key];\n        }\n      }\n      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));\n    }\n  });\n\n```\n\nesesesResponseprocessTableGroupstabifyAggResponsees(data)tabifyAggResponsecolumnsrowsdatametric, columnsmetrictitle(label)indexrowsmetricprocessTableGroupscolumnstitlemetricmetrics()\n\nviewjs\n\n```\n  try {\n    const func = Function(\"metrics\", \"return \" + output.formula); //<<<<=\n    output.value = func(metrics) || \"?\";\n  } catch (e) {\n    output.value = '?';\n  }\n\n```\n\noutput.formulastringstring\n\ndata/option\n\n```\n\t//updateOutputs\n\t$scope.$watchCollection('vis.params.outputs', updateOutputs);\n\n```\n\n#### \n\nTemplateVisType\n\n- src/core\\_plugins/kbn\\_vislib\\_vis\\_types\n\n  visoptionshtml,jsline.js\n\n  ```\n  return new VislibVisType({\n    name: 'line',\n    title: 'Line',\n    image,\n    description: 'Emphasize trends',\n    category: VisType.CATEGORY.BASIC,\n    params: {\n      defaults: {\n        grid: {\n          categoryLines: false,\n          style: {\n            color: '#eee'\n          }\n        },\n        ...\n      },\n      positions: ['top', 'left', 'right', 'bottom'],\n      ...\n      editor: pointSeriesTemplate,\n      ...\n      schemas: new Schemas([\n      {\n        group: 'metrics',\n        name: 'metric',\n        title: 'Y-Axis',\n        min: 1,\n        aggFilter: ['!geo_centroid'],\n        defaults: [\n          { schema: 'metric', type: 'count' }\n        ]\n      },\n     \t....\n    ])\n\n\n  ```\n\n extended\\_metric\\_vis.jsTemplateVisTypeVislibVisTypevis\\_typevis()visTemplateVisTypetemplate\n\n- src/public/ui/vis/vis\\_type\n\n  createRenderbotcreateRenderbotRenderbot\n\n- src/public/ui/vislib\\_vis\\_type/vislib\\_vis\\_type\n\n  vis_type\n\n  ```\n  \t...\n  \tconst updateParams = function (params) {\n  \t\tconst updateIfSet = (from, to, prop, func) => {\n  \t      if (from[prop]) {\n  \t        to[prop] = func ? func(from[prop]) : from[prop];\n  \t      }\n  \t    };\n  \t    ...\n  \t})\n  \t...\n  \t// VisTyperesponseConverter\n  \t_.class(VislibVisType).inherits(VisType);\n     function VislibVisType(opts = {}) {\n       VislibVisType.Super.call(this, opts);\n\n       if (this.responseConverter == null) {\n         this.responseConverter = pointSeries;\n       }\n\n       this.listeners = opts.listeners || {};\n     }\n  \t// createRenderbot\n  \t   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) {\n  \t   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]\n  \t    updateParams(vis.params);\n  \t    return new VislibRenderbot(vis, $el, uiState);\n  \t};\n\n\n  ```\n\n  paramsVislibRenderbotRenderbotRenderbot..\n\n- src/public/ui/vislib\\_vis\\_type/vislib\\_renderbot\n\n  RenderbotVislibRenderbotRenderbotVislibRenderbot\n\n  ```\n    VislibRenderbot.prototype.render = function (esResponse) {\n      this.chartData = this.buildChartData(esResponse);\n      return AngularPromise.delay(1).then(() => {\n        this.vislibVis.render(this.chartData, this.uiState); //\n        this.refreshLegend++;\n      });\n    };\n\n\n  ```\n\n  render,vislibRenderbot.render\n  this.vislibVisthis.vislibVis\n\n  ```\n  this.vislibVis = new vislib.Vis(this.$el[0], this.vislibParams);\n\n  ```\n\n  VisvisConfighandler, handlervisConfigvisConfig\n\n  ```\n  //src/public/ui/vislib/vis_config.js\n  const visType = visTypes[visConfigArgs.type];\n  const typeDefaults = visType(visConfigArgs, this.data); // <= \n\n  //visTypes => src/public/ui/vislib/types\n    return {\n      histogram: pointSeries.column,\n      horizontal_bar: pointSeries.column,\n      line: pointSeries.line,\n      pie: Private(VislibLibTypesPieProvider),\n      area: pointSeries.area,\n      point_series: pointSeries.line,\n      heatmap: pointSeries.heatmap,\n    };\n\n  ```\n\n  handler,handlerrender,chart.render\n\n  ```\n  // render in handler\n  render() {\n  \t...\n  \tconst chart = new self.ChartClass(self, this, chartData);\n  \t...\n  \tchart.render();\n  }\n\n  //ChartClass in handler\n  this.ChartClass = chartTypes[visConfig.get('type')];\n\n  //chartTypes from src/public/ui/vislib/visualizations/vis_types\n  //Chartcomponents/vislib/visualizations/_chart\n    Chart.prototype.render = function () {\n        var selection = d3.select(this.chartEl);\n        selection.selectAll('*').remove();\n        selection.call(this.draw());\n     };\n    // d3.js  draw() \n\n  ```\n\n- src/public/visualize/visualize\n\n  ```\n    $scope.$watch('esResp', prereq(function (resp) {\n        if (!resp) return;\n        $scope.renderbot.render(resp);\n      }));\n\n  ```\n\n   visualize.jsVisualizationBossvisualizevis_typesrenderbotrender\n\nvisVislibVisTypeTemplateVisTyperenderbotvisualizerenderbotTemplateVisTypetemplate(html), ()visualizerenderbot.renderVisRenderbotrender..TemplateRenderbotrenderesResponseesResponseesResponse\n\n\n","source":"_posts/kibana-plugin.md","raw":"---\ntitle: kibana-plugin\ndate: 2017-10-14 13:54:55\ncategories:\n- elk\n---\n## Kibana\n\n### Kibana\n\n- visTypes Visualize\n- app timeline\n- hacks, Any module that should be included in every application\n- chromeNavControls,\n- [](https://www.elastic.co/guide/en/kibana/current/development-uiexports.html)...\n\n#### visTypes\n\n------\n\n### \n\n- git clone kibanaes\n\n- npm install,\n\n  - git http\n\n  ```\n  git config --global url.\"https://\".insteadOf \"git://\"\n  ```\n\n  - chromedriver\n\n  ```\n  npm ERR! chromedriver@2.32.3 install: `node install.js`\n  ```\n\n   \n\n  ```\n  npm install chromedriver --chromedriver_cdnurl=https://npm.taobao.org/mirrors/chromedriver\n  ```\n\n  - dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js\n\n  ```\n    if (opts.dev) {\n      set('env', 'development');\n      set('optimize.lazy', true);\n\n      // if (opts.ssl) {\n      //   set('server.ssl.enabled', true);\n      // }\n\n      // if (opts.ssl && !has('server.ssl.certificate') && !has('server.ssl.key')) {\n      //   set('server.ssl.certificate', DEV_SSL_CERT_PATH);\n      //   set('server.ssl.key', DEV_SSL_KEY_PATH);\n      // }\n    }\n\n  ```\n\n- npm start\n\n### First Blood\n\nvisTypeskibana/plugins\n\n```\nsao kibana-plugin\n```\n\nvisTypesapp componenttranslation filesan hack component a server APIno\n\n- new TemplateVisType\n\n```\nreturn new TemplateVisType({\n    name: 'extended_metric',\n    title: 'Extended Metric',\n    description: 'Based on the core Metric-Plugin but gives you the ability' +\n      'to output custom aggregates on metric-results.',\n    icon: 'fa-calculator',\n    template: extendedMetricVisTemplate, //\n    params: { //Options\n      defaults: {\n        handleNoResults: true,\n        fontSize: 60,\n        outputs: [\n          {\n            formula: 'metrics[0].value * metrics[0].value',\n            label: 'Count squared',\n            enabled: true\n          }\n        ]\n      },\n      editor: metricVisParamsTemplate //Options\n    },\n    schemas: new Schemas([ //Data\n      {\n        group: 'metrics',\n        name: 'metric',\n        title: 'Metric',\n        min: 1,\n        defaults: [\n          { type: 'count', schema: 'metric' }\n        ]\n      }\n    ])\n  });\n```\n\n[](https://github.com/ommsolutions/kibana_ext_metrics_vis)vis\n\nAngularJS\n\nvis\n\n- schema, Datametric  Y bucket  X Kibana4  bucket  Schema  segment(), group  split group\n- Options(params),Optionshtml\n- html\n- controller, html, V <-> C\n\nesviewvis[](https://sunyonggang.gitbooks.io/elkstack-guide-cn/content/kibana/v4/source-code-analysis/visualize_app.html)\n\n- src/core\\_plugins/kbn\\_vislib\\_vis\\_types\n- src/ui/public/vislibvisviscontrollerhtmlcontroller,d3\n\n..\n\nTemplateVisType\n\n```\nexport default function TemplateVisTypeFactory(Private) {\n  const VisType = Private(VisVisTypeProvider);\n  const TemplateRenderbot = Private(TemplateVisTypeTemplateRenderbotProvider);\n\n\t// VisTypetemplate\n  _.class(TemplateVisType).inherits(VisType);\n  function TemplateVisType(opts = {}) {\n    TemplateVisType.Super.call(this, opts);\n\n    this.template = opts.template;\n    if (!this.template) {\n      throw new Error('Missing template for TemplateVisType');\n    }\n  }\n\t// createRenderbot\n  TemplateVisType.prototype.createRenderbot = function (vis, $el, uiState) {\n    return new TemplateRenderbot(vis, $el, uiState);\n  };\n\n  return TemplateVisType;\n}\n\n```\n\nVislibVisTypevisTemplateVisType\n\n```\nexport default function VislibVisTypeFactory(Private) {\n\t...\n\tconst updateParams = function (params) {\n\t\tconst updateIfSet = (from, to, prop, func) => {\n\t      if (from[prop]) {\n\t        to[prop] = func ? func(from[prop]) : from[prop];\n\t      }\n\t    };\n\t    ...\n\t})\n\t...\n\t// VisTyperesponseConverter\n\t_.class(VislibVisType).inherits(VisType);\n   function VislibVisType(opts = {}) {\n     VislibVisType.Super.call(this, opts);\n\n     if (this.responseConverter == null) {\n       this.responseConverter = pointSeries;\n     }\n\n     this.listeners = opts.listeners || {};\n   }\n\t// createRenderbot\n\t   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) {\n\t   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]\n\t    updateParams(vis.params);\n\t    return new VislibRenderbot(vis, $el, uiState);\n\t};\n}\n```\n\nVisType\n\n```\nexport default function VisTypeFactory(Private) {\n  /**\n   * Provides the visualizations for the vislib angular module,visclass\n   *\n   * @module vislib\n   * @submodule VisTypeFactory\n   * @param Private {Object} Loads any function as an angular module\n   * @return {Function} Returns an Object of Visualization classes\n   */\n  return {\n    pie: Private(VislibVisualizationsPieChartProvider),\n    point_series: Private(VislibVisualizationsPointSeriesProvider)\n  };\n}\n\n```\n\n...angular modulevisclassVislibRenderbot\n\n```\n\t//\n\tVislibRenderbot.prototype._createVis\n\tVislibRenderbot.prototype._getVislibParams\n\tVislibRenderbot.prototype.destroy\n\tVislibRenderbot.prototype.updateParams\n\t//renderbuildChartDatavislibVis\n\tVislibRenderbot.prototype.render = function (esResponse) {\n\t    this.chartData = this.buildChartData(esResponse);\n\t    return AngularPromise.delay(1).then(() => {\n\t      this.vislibVis.render(this.chartData, this.uiState);\n\t      this.refreshLegend++;\n\t    });\n\t  };\n\n```\n\n....vislibVissrc/ui/visualization_chart.js,_chart.jsrenderdraw_chartdrawgithubvis\n\nVisrenderdata -> {Object} Elasticsearch query results, datavis.renderVislibRenderbot\\_createVisVislibRenderbotvislibrenderbotsrc/ui/public/visualize/visualize.js\n\n```\n  $scope.$watch('esResp', prereq(function (resp) {\n    if (!resp) return;\n    $scope.renderbot.render(resp); //esrenderbot\n  }));\n```\n\nVislibRenderbot\n\n```\n  VislibRenderbot.prototype.render = function (esResponse) {\n    this.chartData = this.buildChartData(esResponse);\n    return AngularPromise.delay(1).then(() => {\n      this.vislibVis.render(this.chartData, this.uiState);\n      this.refreshLegend++;\n    });\n  };\n```\n\n! renderesrenderbotrenderbotbuildChartDatachartDatavis.renderdata\n\n! VislibVisTypecreateRenderbotVislibRenderbot,VislibRenderbotvisualizevisualizeVislibRenderbotvislibVishtmlesdata,VislibRenderbotVislibRenderbotdatabuildChartData\n\n#### extended_metric\n\nTemplateVisType, VislibVisTyperenderbotTemplateRenderbot,render$scope\n\n```\n  TemplateRenderbot.prototype.render = function (esResponse) {\n    this.$scope.esResponse = esResponse;\n  };\n```\n\nextended_metriccontroller\n\n```\n  // watches\n  $scope.$watch('esResponse', function (resp) {\n    if (resp) {\n      calcOutputs.length = 0;\n      metrics.length = 0;\n      for (let key in metrics) {\n        if (metrics.hasOwnProperty(key)) {\n          delete metrics[key];\n        }\n      }\n      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));\n    }\n  });\n\n```\n\nAngular.. Angular...extended_metric\n\n```\n  $scope.processTableGroups = function (tableGroups) {\n    tableGroups.tables.forEach(function (table) {\n      table.columns.forEach(function (column, i) {\n        const fieldFormatter = table.aggConfig(column).fieldFormatter();\n        let value = table.rows[0][i]; //estable.rows\n        let formattedValue = isInvalid(value) ? '?' : fieldFormatter(value);     //label, formattedValue\n        const metric = {\n          label: column.title,\n          value: value,\n          formattedValue: formattedValue\n        };\n        metrics.push(metric);\n        metrics[column.title] = metric;\n      });\n    });\n    updateOutputs();\n  };\n```\n\nprocessTableGroupstabifyAggResponse($scope.vis, resp)tabifyAggResponseestable,linepoint_series.jsvis,eslabel\n\n#### line\\_sg\n\n[](https://github.com/sbeyn/kibana-plugin-line-sg)\n\n\n\nline\\_sg.jsTemplateVisTypeparamsschemas\n\nline\\_sg.html,c3controller\\_params.html,Optioncontroller,controller\n\n```\n  $scope.$watch('esResponse', function (resp) {\n      if (resp) {\n        console.log(resp);\n        metrics.length = 0; //metricslength,emmm\n        $scope.processTableGroups(tabifyAggResponse($scope.vis, resp)); //..metrics\n        $scope.showGraph(); //metrics\n      }\n    });\n```\n\nc3pluginskibana,chart_types=step\n\nparams\n\nc3kibanalinestep.....lineparams..$scope.$watch$watchControllerwatch\n\n\n\n\n\n\n\n\n\n------\n\n\n\n```\n                                                 /===-_---~~~~~~~~~------____\n                                                |===-~___                _,-'\n                 -==\\\\                         `//~\\\\   ~~~~`---.___.-~~\n             ______-==|                         | |  \\\\           _-~`\n       __--~~~  ,-/-==\\\\                        | |   `\\        ,'\n    _-~       /'    |  \\\\                      / /      \\      /\n  .'        /       |   \\\\                   /' /        \\   /'\n /  ____  /         |    \\`\\.__/-~~ ~ \\ _ _/'  /          \\/'\n/-'~    ~~~~~---__  |     ~-/~         ( )   /'        _--~`\n                  \\_|      /        _)   ;  ),   __--~~\n                    '~~--_/      _-~/-  / \\   '-~ \\\n                   {\\__--_/}    / \\\\_>- )<__\\      \\\n                   /'   (_/  _-~  | |__>--<__|      |\n                  |0  0 _/) )-~     | |__>--<__|      |\n                  / /~ ,_/       / /__>---<__/      |\n                 o o _//        /-~_>---<__-~      /\n                 (^(~          /~_>---<__-      _-~\n                ,/|           /__>--<__/     _-~\n             ,//('(          |__>--<__|     /                  .----_\n            ( ( '))          |__>--<__|    |                 /' _---_~\\\n         `-)) )) (           |__>--<__|    |               /'  /     ~\\`\\\n        ,/,'//( (             \\__>--<__\\    \\            /'  //        ||\n      ,( ( ((, ))              ~-__>--<_~-_  ~--____---~' _/'/        /'\n    `~/  )` ) ,/|                 ~-_~>--<_/-__       __-~ _/\n  ._-~//( )/ )) `                    ~~-'_/_/ /~~~~~~~__--~\n   ;'( ')/ ,)(                              ~~~~~~~~~~\n  ' ') '( (/\n    '   '  `\n\n\n```\n\n\n\n------\n\n\n\n[sao](https://github.com/saojs/sao),[](https://github.com/elastic/template-kibana-plugin)[](https://www.gitbook.com/book/trumandu/kibana-plugin-development-tutorial/details)..\n\n### visTypes\n\nVisualizees6,angular(angular12kibanaangular1)kibanaVisualize[d3](https://d3js.org/)\n\n#### \n\nvis[](https://github.com/ommsolutions/kibana_ext_metrics_vis)()gifmetric(kibana(*10))\n\nextended\\_metric\\_vis.js\n\n```\n\treturn new TemplateVisType({\n\t    name: 'extended_metric',\n\t    title: 'Extended Metric',\n\t    description: 'Based on the core Metric-Plugin but gives you the ability' +\n\t      'to output custom aggregates on metric-results.',\n\t    icon: 'fa-calculator',\n\t    template: extendedMetricVisTemplate, //.html\n\t    params: { //OptionsOptions\n\t      defaults: {\n\t        handleNoResults: true,\n\t        fontSize: 60,\n\t        outputs: [\n\t          {\n\t            formula: 'metrics[0].value * metrics[0].value',\n\t            label: 'Count squared',\n\t            enabled: true\n\t          }\n\t        ]\n\t      },\n\t      editor: metricVisParamsTemplate //Options.html\n\t    },\n\t    schemas: new Schemas([ //Data\n\t    \t\t\t\t\t//metricbucketmetric  Y bucket  X \n\t      {           // bucket  Schema  segment(), group  split\n\t        group: 'metrics',\n\t        name: 'metric',\n\t        title: 'Metric',\n\t        min: 1,\n\t        defaults: [\n\t          { type: 'count', schema: 'metric' }\n\t        ]\n\t      }\n\t    ])\n\t  });\n\n```\n\nvisTemplateVisType\n\nhtmlextended\\_metric\\_vis.htmlextended\\_metric\\_vis\\_params.html, view,angularmvcc => extended\\_metric\\_vis\\_controller.jsangular\n\n```\n$scope.$watch('esResponse', function (resp) {\n    if (resp) {\n      calcOutputs.length = 0;\n      metrics.length = 0;\n      //metrics\n      for (let key in metrics) {\n        if (metrics.hasOwnProperty(key)) {\n          delete metrics[key];\n        }\n      }\n      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));\n    }\n  });\n\n```\n\nesesesResponseprocessTableGroupstabifyAggResponsees(data)tabifyAggResponsecolumnsrowsdatametric, columnsmetrictitle(label)indexrowsmetricprocessTableGroupscolumnstitlemetricmetrics()\n\nviewjs\n\n```\n  try {\n    const func = Function(\"metrics\", \"return \" + output.formula); //<<<<=\n    output.value = func(metrics) || \"?\";\n  } catch (e) {\n    output.value = '?';\n  }\n\n```\n\noutput.formulastringstring\n\ndata/option\n\n```\n\t//updateOutputs\n\t$scope.$watchCollection('vis.params.outputs', updateOutputs);\n\n```\n\n#### \n\nTemplateVisType\n\n- src/core\\_plugins/kbn\\_vislib\\_vis\\_types\n\n  visoptionshtml,jsline.js\n\n  ```\n  return new VislibVisType({\n    name: 'line',\n    title: 'Line',\n    image,\n    description: 'Emphasize trends',\n    category: VisType.CATEGORY.BASIC,\n    params: {\n      defaults: {\n        grid: {\n          categoryLines: false,\n          style: {\n            color: '#eee'\n          }\n        },\n        ...\n      },\n      positions: ['top', 'left', 'right', 'bottom'],\n      ...\n      editor: pointSeriesTemplate,\n      ...\n      schemas: new Schemas([\n      {\n        group: 'metrics',\n        name: 'metric',\n        title: 'Y-Axis',\n        min: 1,\n        aggFilter: ['!geo_centroid'],\n        defaults: [\n          { schema: 'metric', type: 'count' }\n        ]\n      },\n     \t....\n    ])\n\n\n  ```\n\n extended\\_metric\\_vis.jsTemplateVisTypeVislibVisTypevis\\_typevis()visTemplateVisTypetemplate\n\n- src/public/ui/vis/vis\\_type\n\n  createRenderbotcreateRenderbotRenderbot\n\n- src/public/ui/vislib\\_vis\\_type/vislib\\_vis\\_type\n\n  vis_type\n\n  ```\n  \t...\n  \tconst updateParams = function (params) {\n  \t\tconst updateIfSet = (from, to, prop, func) => {\n  \t      if (from[prop]) {\n  \t        to[prop] = func ? func(from[prop]) : from[prop];\n  \t      }\n  \t    };\n  \t    ...\n  \t})\n  \t...\n  \t// VisTyperesponseConverter\n  \t_.class(VislibVisType).inherits(VisType);\n     function VislibVisType(opts = {}) {\n       VislibVisType.Super.call(this, opts);\n\n       if (this.responseConverter == null) {\n         this.responseConverter = pointSeries;\n       }\n\n       this.listeners = opts.listeners || {};\n     }\n  \t// createRenderbot\n  \t   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) {\n  \t   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]\n  \t    updateParams(vis.params);\n  \t    return new VislibRenderbot(vis, $el, uiState);\n  \t};\n\n\n  ```\n\n  paramsVislibRenderbotRenderbotRenderbot..\n\n- src/public/ui/vislib\\_vis\\_type/vislib\\_renderbot\n\n  RenderbotVislibRenderbotRenderbotVislibRenderbot\n\n  ```\n    VislibRenderbot.prototype.render = function (esResponse) {\n      this.chartData = this.buildChartData(esResponse);\n      return AngularPromise.delay(1).then(() => {\n        this.vislibVis.render(this.chartData, this.uiState); //\n        this.refreshLegend++;\n      });\n    };\n\n\n  ```\n\n  render,vislibRenderbot.render\n  this.vislibVisthis.vislibVis\n\n  ```\n  this.vislibVis = new vislib.Vis(this.$el[0], this.vislibParams);\n\n  ```\n\n  VisvisConfighandler, handlervisConfigvisConfig\n\n  ```\n  //src/public/ui/vislib/vis_config.js\n  const visType = visTypes[visConfigArgs.type];\n  const typeDefaults = visType(visConfigArgs, this.data); // <= \n\n  //visTypes => src/public/ui/vislib/types\n    return {\n      histogram: pointSeries.column,\n      horizontal_bar: pointSeries.column,\n      line: pointSeries.line,\n      pie: Private(VislibLibTypesPieProvider),\n      area: pointSeries.area,\n      point_series: pointSeries.line,\n      heatmap: pointSeries.heatmap,\n    };\n\n  ```\n\n  handler,handlerrender,chart.render\n\n  ```\n  // render in handler\n  render() {\n  \t...\n  \tconst chart = new self.ChartClass(self, this, chartData);\n  \t...\n  \tchart.render();\n  }\n\n  //ChartClass in handler\n  this.ChartClass = chartTypes[visConfig.get('type')];\n\n  //chartTypes from src/public/ui/vislib/visualizations/vis_types\n  //Chartcomponents/vislib/visualizations/_chart\n    Chart.prototype.render = function () {\n        var selection = d3.select(this.chartEl);\n        selection.selectAll('*').remove();\n        selection.call(this.draw());\n     };\n    // d3.js  draw() \n\n  ```\n\n- src/public/visualize/visualize\n\n  ```\n    $scope.$watch('esResp', prereq(function (resp) {\n        if (!resp) return;\n        $scope.renderbot.render(resp);\n      }));\n\n  ```\n\n   visualize.jsVisualizationBossvisualizevis_typesrenderbotrender\n\nvisVislibVisTypeTemplateVisTyperenderbotvisualizerenderbotTemplateVisTypetemplate(html), ()visualizerenderbot.renderVisRenderbotrender..TemplateRenderbotrenderesResponseesResponseesResponse\n\n\n","slug":"kibana-plugin","published":1,"updated":"2019-10-14T06:22:04.369Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69xw002rt6xvusmkhjt4","content":"<h2 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h2><h3 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h3><ul>\n<li>visTypes Visualize</li>\n<li>app timeline</li>\n<li>hacks, Any module that should be included in every application</li>\n<li>chromeNavControls,</li>\n<li><a href=\"https://www.elastic.co/guide/en/kibana/current/development-uiexports.html\" target=\"_blank\" rel=\"noopener\"></a></li>\n</ul>\n<h4 id=\"visTypes\"><a href=\"#visTypes\" class=\"headerlink\" title=\"visTypes\"></a>visTypes</h4><hr>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>git clone kibanaes</p>\n</li>\n<li><p>npm install,</p>\n<ul>\n<li>git http</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global url.&quot;https://&quot;.insteadOf &quot;git://&quot;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>chromedriver</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm ERR! chromedriver@2.32.3 install: `node install.js`</span><br></pre></td></tr></table></figure>\n\n<p> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install chromedriver --chromedriver_cdnurl=https://npm.taobao.org/mirrors/chromedriver</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (opts.dev) &#123;</span><br><span class=\"line\">  set(&apos;env&apos;, &apos;development&apos;);</span><br><span class=\"line\">  set(&apos;optimize.lazy&apos;, true);</span><br><span class=\"line\"></span><br><span class=\"line\">  // if (opts.ssl) &#123;</span><br><span class=\"line\">  //   set(&apos;server.ssl.enabled&apos;, true);</span><br><span class=\"line\">  // &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // if (opts.ssl &amp;&amp; !has(&apos;server.ssl.certificate&apos;) &amp;&amp; !has(&apos;server.ssl.key&apos;)) &#123;</span><br><span class=\"line\">  //   set(&apos;server.ssl.certificate&apos;, DEV_SSL_CERT_PATH);</span><br><span class=\"line\">  //   set(&apos;server.ssl.key&apos;, DEV_SSL_KEY_PATH);</span><br><span class=\"line\">  // &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>npm start</p>\n</li>\n</ul>\n<h3 id=\"First-Blood\"><a href=\"#First-Blood\" class=\"headerlink\" title=\"First Blood\"></a>First Blood</h3><p>visTypeskibana/plugins</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sao kibana-plugin</span><br></pre></td></tr></table></figure>\n\n<p>visTypesapp componenttranslation filesan hack component a server APIno</p>\n<ul>\n<li>new TemplateVisType</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return new TemplateVisType(&#123;</span><br><span class=\"line\">    name: &apos;extended_metric&apos;,</span><br><span class=\"line\">    title: &apos;Extended Metric&apos;,</span><br><span class=\"line\">    description: &apos;Based on the core Metric-Plugin but gives you the ability&apos; +</span><br><span class=\"line\">      &apos;to output custom aggregates on metric-results.&apos;,</span><br><span class=\"line\">    icon: &apos;fa-calculator&apos;,</span><br><span class=\"line\">    template: extendedMetricVisTemplate, //</span><br><span class=\"line\">    params: &#123; //Options</span><br><span class=\"line\">      defaults: &#123;</span><br><span class=\"line\">        handleNoResults: true,</span><br><span class=\"line\">        fontSize: 60,</span><br><span class=\"line\">        outputs: [</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            formula: &apos;metrics[0].value * metrics[0].value&apos;,</span><br><span class=\"line\">            label: &apos;Count squared&apos;,</span><br><span class=\"line\">            enabled: true</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      editor: metricVisParamsTemplate //Options</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    schemas: new Schemas([ //Data</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        group: &apos;metrics&apos;,</span><br><span class=\"line\">        name: &apos;metric&apos;,</span><br><span class=\"line\">        title: &apos;Metric&apos;,</span><br><span class=\"line\">        min: 1,</span><br><span class=\"line\">        defaults: [</span><br><span class=\"line\">          &#123; type: &apos;count&apos;, schema: &apos;metric&apos; &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ])</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/ommsolutions/kibana_ext_metrics_vis\"></a>vis</p>\n<p>AngularJS</p>\n<p>vis</p>\n<ul>\n<li>schema, Datametric  Y bucket  X Kibana4  bucket  Schema  segment(), group  split group</li>\n<li>Options(params),Optionshtml</li>\n<li>html</li>\n<li>controller, html, V &lt;-&gt; C</li>\n</ul>\n<p>esviewvis<a href=\"https://sunyonggang.gitbooks.io/elkstack-guide-cn/content/kibana/v4/source-code-analysis/visualize_app.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li>src/core_plugins/kbn_vislib_vis_types</li>\n<li>src/ui/public/vislibvisviscontrollerhtmlcontroller,d3</li>\n</ul>\n<p>..</p>\n<p>TemplateVisType</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export default function TemplateVisTypeFactory(Private) &#123;</span><br><span class=\"line\">  const VisType = Private(VisVisTypeProvider);</span><br><span class=\"line\">  const TemplateRenderbot = Private(TemplateVisTypeTemplateRenderbotProvider);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// VisTypetemplate</span><br><span class=\"line\">  _.class(TemplateVisType).inherits(VisType);</span><br><span class=\"line\">  function TemplateVisType(opts = &#123;&#125;) &#123;</span><br><span class=\"line\">    TemplateVisType.Super.call(this, opts);</span><br><span class=\"line\"></span><br><span class=\"line\">    this.template = opts.template;</span><br><span class=\"line\">    if (!this.template) &#123;</span><br><span class=\"line\">      throw new Error(&apos;Missing template for TemplateVisType&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t// createRenderbot</span><br><span class=\"line\">  TemplateVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class=\"line\">    return new TemplateRenderbot(vis, $el, uiState);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  return TemplateVisType;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>VislibVisTypevisTemplateVisType</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export default function VislibVisTypeFactory(Private) &#123;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\tconst updateParams = function (params) &#123;</span><br><span class=\"line\">\t\tconst updateIfSet = (from, to, prop, func) =&gt; &#123;</span><br><span class=\"line\">\t      if (from[prop]) &#123;</span><br><span class=\"line\">\t        to[prop] = func ? func(from[prop]) : from[prop];</span><br><span class=\"line\">\t      &#125;</span><br><span class=\"line\">\t    &#125;;</span><br><span class=\"line\">\t    ...</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t// VisTyperesponseConverter</span><br><span class=\"line\">\t_.class(VislibVisType).inherits(VisType);</span><br><span class=\"line\">   function VislibVisType(opts = &#123;&#125;) &#123;</span><br><span class=\"line\">     VislibVisType.Super.call(this, opts);</span><br><span class=\"line\"></span><br><span class=\"line\">     if (this.responseConverter == null) &#123;</span><br><span class=\"line\">       this.responseConverter = pointSeries;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     this.listeners = opts.listeners || &#123;&#125;;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">\t// createRenderbot</span><br><span class=\"line\">\t   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class=\"line\">\t   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]</span><br><span class=\"line\">\t    updateParams(vis.params);</span><br><span class=\"line\">\t    return new VislibRenderbot(vis, $el, uiState);</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>VisType</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export default function VisTypeFactory(Private) &#123;</span><br><span class=\"line\">  /**</span><br><span class=\"line\">   * Provides the visualizations for the vislib angular module,visclass</span><br><span class=\"line\">   *</span><br><span class=\"line\">   * @module vislib</span><br><span class=\"line\">   * @submodule VisTypeFactory</span><br><span class=\"line\">   * @param Private &#123;Object&#125; Loads any function as an angular module</span><br><span class=\"line\">   * @return &#123;Function&#125; Returns an Object of Visualization classes</span><br><span class=\"line\">   */</span><br><span class=\"line\">  return &#123;</span><br><span class=\"line\">    pie: Private(VislibVisualizationsPieChartProvider),</span><br><span class=\"line\">    point_series: Private(VislibVisualizationsPointSeriesProvider)</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>angular modulevisclassVislibRenderbot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">VislibRenderbot.prototype._createVis</span><br><span class=\"line\">VislibRenderbot.prototype._getVislibParams</span><br><span class=\"line\">VislibRenderbot.prototype.destroy</span><br><span class=\"line\">VislibRenderbot.prototype.updateParams</span><br><span class=\"line\">//renderbuildChartDatavislibVis</span><br><span class=\"line\">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">    this.chartData = this.buildChartData(esResponse);</span><br><span class=\"line\">    return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class=\"line\">      this.vislibVis.render(this.chartData, this.uiState);</span><br><span class=\"line\">      this.refreshLegend++;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;;</span><br></pre></td></tr></table></figure>\n\n<p>....vislibVissrc/ui/visualization_chart.js,_chart.jsrenderdraw_chartdrawgithubvis</p>\n<p>Visrenderdata -&gt; {Object} Elasticsearch query results, datavis.renderVislibRenderbot_createVisVislibRenderbotvislibrenderbotsrc/ui/public/visualize/visualize.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResp&apos;, prereq(function (resp) &#123;</span><br><span class=\"line\">  if (!resp) return;</span><br><span class=\"line\">  $scope.renderbot.render(resp); //esrenderbot</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure>\n\n<p>VislibRenderbot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">  this.chartData = this.buildChartData(esResponse);</span><br><span class=\"line\">  return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class=\"line\">    this.vislibVis.render(this.chartData, this.uiState);</span><br><span class=\"line\">    this.refreshLegend++;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>! renderesrenderbotrenderbotbuildChartDatachartDatavis.renderdata</p>\n<p>! VislibVisTypecreateRenderbotVislibRenderbot,VislibRenderbotvisualizevisualizeVislibRenderbotvislibVishtmlesdata,VislibRenderbotVislibRenderbotdatabuildChartData</p>\n<h4 id=\"extended-metric\"><a href=\"#extended-metric\" class=\"headerlink\" title=\"extended_metric\"></a>extended_metric</h4><p>TemplateVisType, VislibVisTyperenderbotTemplateRenderbot,render$scope</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TemplateRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">  this.$scope.esResponse = esResponse;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>extended_metriccontroller</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// watches</span><br><span class=\"line\">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class=\"line\">  if (resp) &#123;</span><br><span class=\"line\">    calcOutputs.length = 0;</span><br><span class=\"line\">    metrics.length = 0;</span><br><span class=\"line\">    for (let key in metrics) &#123;</span><br><span class=\"line\">      if (metrics.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">        delete metrics[key];</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Angular.. Angularextended_metric</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.processTableGroups = function (tableGroups) &#123;</span><br><span class=\"line\">  tableGroups.tables.forEach(function (table) &#123;</span><br><span class=\"line\">    table.columns.forEach(function (column, i) &#123;</span><br><span class=\"line\">      const fieldFormatter = table.aggConfig(column).fieldFormatter();</span><br><span class=\"line\">      let value = table.rows[0][i]; //estable.rows</span><br><span class=\"line\">      let formattedValue = isInvalid(value) ? &apos;?&apos; : fieldFormatter(value);     //label, formattedValue</span><br><span class=\"line\">      const metric = &#123;</span><br><span class=\"line\">        label: column.title,</span><br><span class=\"line\">        value: value,</span><br><span class=\"line\">        formattedValue: formattedValue</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      metrics.push(metric);</span><br><span class=\"line\">      metrics[column.title] = metric;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  updateOutputs();</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>processTableGroupstabifyAggResponse($scope.vis, resp)tabifyAggResponseestable,linepoint_series.jsvis,eslabel</p>\n<h4 id=\"line-sg\"><a href=\"#line-sg\" class=\"headerlink\" title=\"line_sg\"></a>line_sg</h4><p><a href=\"https://github.com/sbeyn/kibana-plugin-line-sg\"></a></p>\n<p></p>\n<p>line_sg.jsTemplateVisTypeparamsschemas</p>\n<p>line_sg.html,c3controller_params.html,Optioncontroller,controller</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class=\"line\">    if (resp) &#123;</span><br><span class=\"line\">      console.log(resp);</span><br><span class=\"line\">      metrics.length = 0; //metricslength,emmm</span><br><span class=\"line\">      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp)); //..metrics</span><br><span class=\"line\">      $scope.showGraph(); //metrics</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>c3pluginskibana,chart_types=step</p>\n<p>params</p>\n<p>c3kibanalinestep..lineparams..$scope.$watch$watchControllerwatch</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                                 /===-_---~~~~~~~~~------____</span><br><span class=\"line\">                                                |===-~___                _,-&apos;</span><br><span class=\"line\">                 -==\\\\                         `//~\\\\   ~~~~`---.___.-~~</span><br><span class=\"line\">             ______-==|                         | |  \\\\           _-~`</span><br><span class=\"line\">       __--~~~  ,-/-==\\\\                        | |   `\\        ,&apos;</span><br><span class=\"line\">    _-~       /&apos;    |  \\\\                      / /      \\      /</span><br><span class=\"line\">  .&apos;        /       |   \\\\                   /&apos; /        \\   /&apos;</span><br><span class=\"line\"> /  ____  /         |    \\`\\.__/-~~ ~ \\ _ _/&apos;  /          \\/&apos;</span><br><span class=\"line\">/-&apos;~    ~~~~~---__  |     ~-/~         ( )   /&apos;        _--~`</span><br><span class=\"line\">                  \\_|      /        _)   ;  ),   __--~~</span><br><span class=\"line\">                    &apos;~~--_/      _-~/-  / \\   &apos;-~ \\</span><br><span class=\"line\">                   &#123;\\__--_/&#125;    / \\\\_&gt;- )&lt;__\\      \\</span><br><span class=\"line\">                   /&apos;   (_/  _-~  | |__&gt;--&lt;__|      |</span><br><span class=\"line\">                  |0  0 _/) )-~     | |__&gt;--&lt;__|      |</span><br><span class=\"line\">                  / /~ ,_/       / /__&gt;---&lt;__/      |</span><br><span class=\"line\">                 o o _//        /-~_&gt;---&lt;__-~      /</span><br><span class=\"line\">                 (^(~          /~_&gt;---&lt;__-      _-~</span><br><span class=\"line\">                ,/|           /__&gt;--&lt;__/     _-~</span><br><span class=\"line\">             ,//(&apos;(          |__&gt;--&lt;__|     /                  .----_</span><br><span class=\"line\">            ( ( &apos;))          |__&gt;--&lt;__|    |                 /&apos; _---_~\\</span><br><span class=\"line\">         `-)) )) (           |__&gt;--&lt;__|    |               /&apos;  /     ~\\`\\</span><br><span class=\"line\">        ,/,&apos;//( (             \\__&gt;--&lt;__\\    \\            /&apos;  //        ||</span><br><span class=\"line\">      ,( ( ((, ))              ~-__&gt;--&lt;_~-_  ~--____---~&apos; _/&apos;/        /&apos;</span><br><span class=\"line\">    `~/  )` ) ,/|                 ~-_~&gt;--&lt;_/-__       __-~ _/</span><br><span class=\"line\">  ._-~//( )/ )) `                    ~~-&apos;_/_/ /~~~~~~~__--~</span><br><span class=\"line\">   ;&apos;( &apos;)/ ,)(                              ~~~~~~~~~~</span><br><span class=\"line\">  &apos; &apos;) &apos;( (/</span><br><span class=\"line\">    &apos;   &apos;  `</span><br></pre></td></tr></table></figure>\n\n<hr>\n<p></p>\n<p><a href=\"https://github.com/saojs/sao\">sao</a>,<a href=\"https://github.com/elastic/template-kibana-plugin\"></a><a href=\"https://www.gitbook.com/book/trumandu/kibana-plugin-development-tutorial/details\" target=\"_blank\" rel=\"noopener\"></a>..</p>\n<h3 id=\"visTypes\"><a href=\"#visTypes\" class=\"headerlink\" title=\"visTypes\"></a>visTypes</h3><p>Visualizees6,angular(angular12kibanaangular1)kibanaVisualize<a href=\"https://d3js.org/\" target=\"_blank\" rel=\"noopener\">d3</a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>vis<a href=\"https://github.com/ommsolutions/kibana_ext_metrics_vis\"></a>()gifmetric(kibana(*10))</p>\n<p>extended_metric_vis.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return new TemplateVisType(&#123;</span><br><span class=\"line\">    name: &apos;extended_metric&apos;,</span><br><span class=\"line\">    title: &apos;Extended Metric&apos;,</span><br><span class=\"line\">    description: &apos;Based on the core Metric-Plugin but gives you the ability&apos; +</span><br><span class=\"line\">      &apos;to output custom aggregates on metric-results.&apos;,</span><br><span class=\"line\">    icon: &apos;fa-calculator&apos;,</span><br><span class=\"line\">    template: extendedMetricVisTemplate, //.html</span><br><span class=\"line\">    params: &#123; //OptionsOptions</span><br><span class=\"line\">      defaults: &#123;</span><br><span class=\"line\">        handleNoResults: true,</span><br><span class=\"line\">        fontSize: 60,</span><br><span class=\"line\">        outputs: [</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            formula: &apos;metrics[0].value * metrics[0].value&apos;,</span><br><span class=\"line\">            label: &apos;Count squared&apos;,</span><br><span class=\"line\">            enabled: true</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      editor: metricVisParamsTemplate //Options.html</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    schemas: new Schemas([ //Data</span><br><span class=\"line\">    \t\t\t\t\t//metricbucketmetric  Y bucket  X </span><br><span class=\"line\">      &#123;           // bucket  Schema  segment(), group  split</span><br><span class=\"line\">        group: &apos;metrics&apos;,</span><br><span class=\"line\">        name: &apos;metric&apos;,</span><br><span class=\"line\">        title: &apos;Metric&apos;,</span><br><span class=\"line\">        min: 1,</span><br><span class=\"line\">        defaults: [</span><br><span class=\"line\">          &#123; type: &apos;count&apos;, schema: &apos;metric&apos; &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ])</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>visTemplateVisType</p>\n<p>htmlextended_metric_vis.htmlextended_metric_vis_params.html, view,angularmvcc =&gt; extended_metric_vis_controller.jsangular</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class=\"line\">    if (resp) &#123;</span><br><span class=\"line\">      calcOutputs.length = 0;</span><br><span class=\"line\">      metrics.length = 0;</span><br><span class=\"line\">      //metrics</span><br><span class=\"line\">      for (let key in metrics) &#123;</span><br><span class=\"line\">        if (metrics.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">          delete metrics[key];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>esesesResponseprocessTableGroupstabifyAggResponsees(data)tabifyAggResponsecolumnsrowsdatametric, columnsmetrictitle(label)indexrowsmetricprocessTableGroupscolumnstitlemetricmetrics()</p>\n<p>viewjs</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try &#123;</span><br><span class=\"line\">  const func = Function(&quot;metrics&quot;, &quot;return &quot; + output.formula); //&lt;&lt;&lt;&lt;=</span><br><span class=\"line\">  output.value = func(metrics) || &quot;?&quot;;</span><br><span class=\"line\">&#125; catch (e) &#123;</span><br><span class=\"line\">  output.value = &apos;?&apos;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>output.formulastringstring</p>\n<p>data/option</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//updateOutputs</span><br><span class=\"line\">$scope.$watchCollection(&apos;vis.params.outputs&apos;, updateOutputs);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>TemplateVisType</p>\n<ul>\n<li><p>src/core_plugins/kbn_vislib_vis_types</p>\n<p>visoptionshtml,jsline.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return new VislibVisType(&#123;</span><br><span class=\"line\">  name: &apos;line&apos;,</span><br><span class=\"line\">  title: &apos;Line&apos;,</span><br><span class=\"line\">  image,</span><br><span class=\"line\">  description: &apos;Emphasize trends&apos;,</span><br><span class=\"line\">  category: VisType.CATEGORY.BASIC,</span><br><span class=\"line\">  params: &#123;</span><br><span class=\"line\">    defaults: &#123;</span><br><span class=\"line\">      grid: &#123;</span><br><span class=\"line\">        categoryLines: false,</span><br><span class=\"line\">        style: &#123;</span><br><span class=\"line\">          color: &apos;#eee&apos;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      ...</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    positions: [&apos;top&apos;, &apos;left&apos;, &apos;right&apos;, &apos;bottom&apos;],</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    editor: pointSeriesTemplate,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    schemas: new Schemas([</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      group: &apos;metrics&apos;,</span><br><span class=\"line\">      name: &apos;metric&apos;,</span><br><span class=\"line\">      title: &apos;Y-Axis&apos;,</span><br><span class=\"line\">      min: 1,</span><br><span class=\"line\">      aggFilter: [&apos;!geo_centroid&apos;],</span><br><span class=\"line\">      defaults: [</span><br><span class=\"line\">        &#123; schema: &apos;metric&apos;, type: &apos;count&apos; &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">   \t....</span><br><span class=\"line\">  ])</span><br></pre></td></tr></table></figure>\n\n<p>extended_metric_vis.jsTemplateVisTypeVislibVisTypevis_typevis()visTemplateVisTypetemplate</p>\n</li>\n<li><p>src/public/ui/vis/vis_type</p>\n<p>createRenderbotcreateRenderbotRenderbot</p>\n</li>\n<li><p>src/public/ui/vislib_vis_type/vislib_vis_type</p>\n<p>vis_type</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">const updateParams = function (params) &#123;</span><br><span class=\"line\">\tconst updateIfSet = (from, to, prop, func) =&gt; &#123;</span><br><span class=\"line\">      if (from[prop]) &#123;</span><br><span class=\"line\">        to[prop] = func ? func(from[prop]) : from[prop];</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">...</span><br><span class=\"line\">// VisTyperesponseConverter</span><br><span class=\"line\">_.class(VislibVisType).inherits(VisType);</span><br><span class=\"line\">  function VislibVisType(opts = &#123;&#125;) &#123;</span><br><span class=\"line\">    VislibVisType.Super.call(this, opts);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (this.responseConverter == null) &#123;</span><br><span class=\"line\">      this.responseConverter = pointSeries;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    this.listeners = opts.listeners || &#123;&#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">// createRenderbot</span><br><span class=\"line\">   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class=\"line\">   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]</span><br><span class=\"line\">    updateParams(vis.params);</span><br><span class=\"line\">    return new VislibRenderbot(vis, $el, uiState);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>paramsVislibRenderbotRenderbotRenderbot..</p>\n</li>\n<li><p>src/public/ui/vislib_vis_type/vislib_renderbot</p>\n<p>RenderbotVislibRenderbotRenderbotVislibRenderbot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">  this.chartData = this.buildChartData(esResponse);</span><br><span class=\"line\">  return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class=\"line\">    this.vislibVis.render(this.chartData, this.uiState); //</span><br><span class=\"line\">    this.refreshLegend++;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>render,vislibRenderbot.render<br>this.vislibVisthis.vislibVis</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.vislibVis = new vislib.Vis(this.$el[0], this.vislibParams);</span><br></pre></td></tr></table></figure>\n\n<p>VisvisConfighandler, handlervisConfigvisConfig</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//src/public/ui/vislib/vis_config.js</span><br><span class=\"line\">const visType = visTypes[visConfigArgs.type];</span><br><span class=\"line\">const typeDefaults = visType(visConfigArgs, this.data); // &lt;= </span><br><span class=\"line\"></span><br><span class=\"line\">//visTypes =&gt; src/public/ui/vislib/types</span><br><span class=\"line\">  return &#123;</span><br><span class=\"line\">    histogram: pointSeries.column,</span><br><span class=\"line\">    horizontal_bar: pointSeries.column,</span><br><span class=\"line\">    line: pointSeries.line,</span><br><span class=\"line\">    pie: Private(VislibLibTypesPieProvider),</span><br><span class=\"line\">    area: pointSeries.area,</span><br><span class=\"line\">    point_series: pointSeries.line,</span><br><span class=\"line\">    heatmap: pointSeries.heatmap,</span><br><span class=\"line\">  &#125;;</span><br></pre></td></tr></table></figure>\n\n<p>handler,handlerrender,chart.render</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// render in handler</span><br><span class=\"line\">render() &#123;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\tconst chart = new self.ChartClass(self, this, chartData);</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\tchart.render();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//ChartClass in handler</span><br><span class=\"line\">this.ChartClass = chartTypes[visConfig.get(&apos;type&apos;)];</span><br><span class=\"line\"></span><br><span class=\"line\">//chartTypes from src/public/ui/vislib/visualizations/vis_types</span><br><span class=\"line\">//Chartcomponents/vislib/visualizations/_chart</span><br><span class=\"line\">  Chart.prototype.render = function () &#123;</span><br><span class=\"line\">      var selection = d3.select(this.chartEl);</span><br><span class=\"line\">      selection.selectAll(&apos;*&apos;).remove();</span><br><span class=\"line\">      selection.call(this.draw());</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\">  // d3.js  draw() </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>src/public/visualize/visualize</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResp&apos;, prereq(function (resp) &#123;</span><br><span class=\"line\">    if (!resp) return;</span><br><span class=\"line\">    $scope.renderbot.render(resp);</span><br><span class=\"line\">  &#125;));</span><br></pre></td></tr></table></figure>\n\n<p> visualize.jsVisualizationBossvisualizevis_typesrenderbotrender</p>\n</li>\n</ul>\n<p>visVislibVisTypeTemplateVisTyperenderbotvisualizerenderbotTemplateVisTypetemplate(html), ()visualizerenderbot.renderVisRenderbotrender..TemplateRenderbotrenderesResponseesResponseesResponse</p>\n<p></p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h2><h3 id=\"Kibana\"><a href=\"#Kibana\" class=\"headerlink\" title=\"Kibana\"></a>Kibana</h3><ul>\n<li>visTypes Visualize</li>\n<li>app timeline</li>\n<li>hacks, Any module that should be included in every application</li>\n<li>chromeNavControls,</li>\n<li><a href=\"https://www.elastic.co/guide/en/kibana/current/development-uiexports.html\" target=\"_blank\" rel=\"noopener\"></a></li>\n</ul>\n<h4 id=\"visTypes\"><a href=\"#visTypes\" class=\"headerlink\" title=\"visTypes\"></a>visTypes</h4><hr>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ul>\n<li><p>git clone kibanaes</p>\n</li>\n<li><p>npm install,</p>\n<ul>\n<li>git http</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global url.&quot;https://&quot;.insteadOf &quot;git://&quot;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>chromedriver</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm ERR! chromedriver@2.32.3 install: `node install.js`</span><br></pre></td></tr></table></figure>\n\n<p> </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install chromedriver --chromedriver_cdnurl=https://npm.taobao.org/mirrors/chromedriver</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>dev ssl,https,\\kibana\\src\\cli\\serve\\serve.js</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (opts.dev) &#123;</span><br><span class=\"line\">  set(&apos;env&apos;, &apos;development&apos;);</span><br><span class=\"line\">  set(&apos;optimize.lazy&apos;, true);</span><br><span class=\"line\"></span><br><span class=\"line\">  // if (opts.ssl) &#123;</span><br><span class=\"line\">  //   set(&apos;server.ssl.enabled&apos;, true);</span><br><span class=\"line\">  // &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // if (opts.ssl &amp;&amp; !has(&apos;server.ssl.certificate&apos;) &amp;&amp; !has(&apos;server.ssl.key&apos;)) &#123;</span><br><span class=\"line\">  //   set(&apos;server.ssl.certificate&apos;, DEV_SSL_CERT_PATH);</span><br><span class=\"line\">  //   set(&apos;server.ssl.key&apos;, DEV_SSL_KEY_PATH);</span><br><span class=\"line\">  // &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>npm start</p>\n</li>\n</ul>\n<h3 id=\"First-Blood\"><a href=\"#First-Blood\" class=\"headerlink\" title=\"First Blood\"></a>First Blood</h3><p>visTypeskibana/plugins</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sao kibana-plugin</span><br></pre></td></tr></table></figure>\n\n<p>visTypesapp componenttranslation filesan hack component a server APIno</p>\n<ul>\n<li>new TemplateVisType</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return new TemplateVisType(&#123;</span><br><span class=\"line\">    name: &apos;extended_metric&apos;,</span><br><span class=\"line\">    title: &apos;Extended Metric&apos;,</span><br><span class=\"line\">    description: &apos;Based on the core Metric-Plugin but gives you the ability&apos; +</span><br><span class=\"line\">      &apos;to output custom aggregates on metric-results.&apos;,</span><br><span class=\"line\">    icon: &apos;fa-calculator&apos;,</span><br><span class=\"line\">    template: extendedMetricVisTemplate, //</span><br><span class=\"line\">    params: &#123; //Options</span><br><span class=\"line\">      defaults: &#123;</span><br><span class=\"line\">        handleNoResults: true,</span><br><span class=\"line\">        fontSize: 60,</span><br><span class=\"line\">        outputs: [</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            formula: &apos;metrics[0].value * metrics[0].value&apos;,</span><br><span class=\"line\">            label: &apos;Count squared&apos;,</span><br><span class=\"line\">            enabled: true</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      editor: metricVisParamsTemplate //Options</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    schemas: new Schemas([ //Data</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        group: &apos;metrics&apos;,</span><br><span class=\"line\">        name: &apos;metric&apos;,</span><br><span class=\"line\">        title: &apos;Metric&apos;,</span><br><span class=\"line\">        min: 1,</span><br><span class=\"line\">        defaults: [</span><br><span class=\"line\">          &#123; type: &apos;count&apos;, schema: &apos;metric&apos; &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ])</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p><a href=\"https://github.com/ommsolutions/kibana_ext_metrics_vis\"></a>vis</p>\n<p>AngularJS</p>\n<p>vis</p>\n<ul>\n<li>schema, Datametric  Y bucket  X Kibana4  bucket  Schema  segment(), group  split group</li>\n<li>Options(params),Optionshtml</li>\n<li>html</li>\n<li>controller, html, V &lt;-&gt; C</li>\n</ul>\n<p>esviewvis<a href=\"https://sunyonggang.gitbooks.io/elkstack-guide-cn/content/kibana/v4/source-code-analysis/visualize_app.html\" target=\"_blank\" rel=\"noopener\"></a></p>\n<ul>\n<li>src/core_plugins/kbn_vislib_vis_types</li>\n<li>src/ui/public/vislibvisviscontrollerhtmlcontroller,d3</li>\n</ul>\n<p>..</p>\n<p>TemplateVisType</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export default function TemplateVisTypeFactory(Private) &#123;</span><br><span class=\"line\">  const VisType = Private(VisVisTypeProvider);</span><br><span class=\"line\">  const TemplateRenderbot = Private(TemplateVisTypeTemplateRenderbotProvider);</span><br><span class=\"line\"></span><br><span class=\"line\">\t// VisTypetemplate</span><br><span class=\"line\">  _.class(TemplateVisType).inherits(VisType);</span><br><span class=\"line\">  function TemplateVisType(opts = &#123;&#125;) &#123;</span><br><span class=\"line\">    TemplateVisType.Super.call(this, opts);</span><br><span class=\"line\"></span><br><span class=\"line\">    this.template = opts.template;</span><br><span class=\"line\">    if (!this.template) &#123;</span><br><span class=\"line\">      throw new Error(&apos;Missing template for TemplateVisType&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">\t// createRenderbot</span><br><span class=\"line\">  TemplateVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class=\"line\">    return new TemplateRenderbot(vis, $el, uiState);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  return TemplateVisType;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>VislibVisTypevisTemplateVisType</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export default function VislibVisTypeFactory(Private) &#123;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\tconst updateParams = function (params) &#123;</span><br><span class=\"line\">\t\tconst updateIfSet = (from, to, prop, func) =&gt; &#123;</span><br><span class=\"line\">\t      if (from[prop]) &#123;</span><br><span class=\"line\">\t        to[prop] = func ? func(from[prop]) : from[prop];</span><br><span class=\"line\">\t      &#125;</span><br><span class=\"line\">\t    &#125;;</span><br><span class=\"line\">\t    ...</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t// VisTyperesponseConverter</span><br><span class=\"line\">\t_.class(VislibVisType).inherits(VisType);</span><br><span class=\"line\">   function VislibVisType(opts = &#123;&#125;) &#123;</span><br><span class=\"line\">     VislibVisType.Super.call(this, opts);</span><br><span class=\"line\"></span><br><span class=\"line\">     if (this.responseConverter == null) &#123;</span><br><span class=\"line\">       this.responseConverter = pointSeries;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     this.listeners = opts.listeners || &#123;&#125;;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">\t// createRenderbot</span><br><span class=\"line\">\t   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class=\"line\">\t   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]</span><br><span class=\"line\">\t    updateParams(vis.params);</span><br><span class=\"line\">\t    return new VislibRenderbot(vis, $el, uiState);</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>VisType</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export default function VisTypeFactory(Private) &#123;</span><br><span class=\"line\">  /**</span><br><span class=\"line\">   * Provides the visualizations for the vislib angular module,visclass</span><br><span class=\"line\">   *</span><br><span class=\"line\">   * @module vislib</span><br><span class=\"line\">   * @submodule VisTypeFactory</span><br><span class=\"line\">   * @param Private &#123;Object&#125; Loads any function as an angular module</span><br><span class=\"line\">   * @return &#123;Function&#125; Returns an Object of Visualization classes</span><br><span class=\"line\">   */</span><br><span class=\"line\">  return &#123;</span><br><span class=\"line\">    pie: Private(VislibVisualizationsPieChartProvider),</span><br><span class=\"line\">    point_series: Private(VislibVisualizationsPointSeriesProvider)</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>angular modulevisclassVislibRenderbot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//</span><br><span class=\"line\">VislibRenderbot.prototype._createVis</span><br><span class=\"line\">VislibRenderbot.prototype._getVislibParams</span><br><span class=\"line\">VislibRenderbot.prototype.destroy</span><br><span class=\"line\">VislibRenderbot.prototype.updateParams</span><br><span class=\"line\">//renderbuildChartDatavislibVis</span><br><span class=\"line\">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">    this.chartData = this.buildChartData(esResponse);</span><br><span class=\"line\">    return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class=\"line\">      this.vislibVis.render(this.chartData, this.uiState);</span><br><span class=\"line\">      this.refreshLegend++;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;;</span><br></pre></td></tr></table></figure>\n\n<p>....vislibVissrc/ui/visualization_chart.js,_chart.jsrenderdraw_chartdrawgithubvis</p>\n<p>Visrenderdata -&gt; {Object} Elasticsearch query results, datavis.renderVislibRenderbot_createVisVislibRenderbotvislibrenderbotsrc/ui/public/visualize/visualize.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResp&apos;, prereq(function (resp) &#123;</span><br><span class=\"line\">  if (!resp) return;</span><br><span class=\"line\">  $scope.renderbot.render(resp); //esrenderbot</span><br><span class=\"line\">&#125;));</span><br></pre></td></tr></table></figure>\n\n<p>VislibRenderbot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">  this.chartData = this.buildChartData(esResponse);</span><br><span class=\"line\">  return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class=\"line\">    this.vislibVis.render(this.chartData, this.uiState);</span><br><span class=\"line\">    this.refreshLegend++;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>! renderesrenderbotrenderbotbuildChartDatachartDatavis.renderdata</p>\n<p>! VislibVisTypecreateRenderbotVislibRenderbot,VislibRenderbotvisualizevisualizeVislibRenderbotvislibVishtmlesdata,VislibRenderbotVislibRenderbotdatabuildChartData</p>\n<h4 id=\"extended-metric\"><a href=\"#extended-metric\" class=\"headerlink\" title=\"extended_metric\"></a>extended_metric</h4><p>TemplateVisType, VislibVisTyperenderbotTemplateRenderbot,render$scope</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TemplateRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">  this.$scope.esResponse = esResponse;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>extended_metriccontroller</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// watches</span><br><span class=\"line\">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class=\"line\">  if (resp) &#123;</span><br><span class=\"line\">    calcOutputs.length = 0;</span><br><span class=\"line\">    metrics.length = 0;</span><br><span class=\"line\">    for (let key in metrics) &#123;</span><br><span class=\"line\">      if (metrics.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">        delete metrics[key];</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>Angular.. Angularextended_metric</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.processTableGroups = function (tableGroups) &#123;</span><br><span class=\"line\">  tableGroups.tables.forEach(function (table) &#123;</span><br><span class=\"line\">    table.columns.forEach(function (column, i) &#123;</span><br><span class=\"line\">      const fieldFormatter = table.aggConfig(column).fieldFormatter();</span><br><span class=\"line\">      let value = table.rows[0][i]; //estable.rows</span><br><span class=\"line\">      let formattedValue = isInvalid(value) ? &apos;?&apos; : fieldFormatter(value);     //label, formattedValue</span><br><span class=\"line\">      const metric = &#123;</span><br><span class=\"line\">        label: column.title,</span><br><span class=\"line\">        value: value,</span><br><span class=\"line\">        formattedValue: formattedValue</span><br><span class=\"line\">      &#125;;</span><br><span class=\"line\">      metrics.push(metric);</span><br><span class=\"line\">      metrics[column.title] = metric;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  updateOutputs();</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>processTableGroupstabifyAggResponse($scope.vis, resp)tabifyAggResponseestable,linepoint_series.jsvis,eslabel</p>\n<h4 id=\"line-sg\"><a href=\"#line-sg\" class=\"headerlink\" title=\"line_sg\"></a>line_sg</h4><p><a href=\"https://github.com/sbeyn/kibana-plugin-line-sg\"></a></p>\n<p></p>\n<p>line_sg.jsTemplateVisTypeparamsschemas</p>\n<p>line_sg.html,c3controller_params.html,Optioncontroller,controller</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class=\"line\">    if (resp) &#123;</span><br><span class=\"line\">      console.log(resp);</span><br><span class=\"line\">      metrics.length = 0; //metricslength,emmm</span><br><span class=\"line\">      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp)); //..metrics</span><br><span class=\"line\">      $scope.showGraph(); //metrics</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>c3pluginskibana,chart_types=step</p>\n<p>params</p>\n<p>c3kibanalinestep..lineparams..$scope.$watch$watchControllerwatch</p>\n<hr>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                                 /===-_---~~~~~~~~~------____</span><br><span class=\"line\">                                                |===-~___                _,-&apos;</span><br><span class=\"line\">                 -==\\\\                         `//~\\\\   ~~~~`---.___.-~~</span><br><span class=\"line\">             ______-==|                         | |  \\\\           _-~`</span><br><span class=\"line\">       __--~~~  ,-/-==\\\\                        | |   `\\        ,&apos;</span><br><span class=\"line\">    _-~       /&apos;    |  \\\\                      / /      \\      /</span><br><span class=\"line\">  .&apos;        /       |   \\\\                   /&apos; /        \\   /&apos;</span><br><span class=\"line\"> /  ____  /         |    \\`\\.__/-~~ ~ \\ _ _/&apos;  /          \\/&apos;</span><br><span class=\"line\">/-&apos;~    ~~~~~---__  |     ~-/~         ( )   /&apos;        _--~`</span><br><span class=\"line\">                  \\_|      /        _)   ;  ),   __--~~</span><br><span class=\"line\">                    &apos;~~--_/      _-~/-  / \\   &apos;-~ \\</span><br><span class=\"line\">                   &#123;\\__--_/&#125;    / \\\\_&gt;- )&lt;__\\      \\</span><br><span class=\"line\">                   /&apos;   (_/  _-~  | |__&gt;--&lt;__|      |</span><br><span class=\"line\">                  |0  0 _/) )-~     | |__&gt;--&lt;__|      |</span><br><span class=\"line\">                  / /~ ,_/       / /__&gt;---&lt;__/      |</span><br><span class=\"line\">                 o o _//        /-~_&gt;---&lt;__-~      /</span><br><span class=\"line\">                 (^(~          /~_&gt;---&lt;__-      _-~</span><br><span class=\"line\">                ,/|           /__&gt;--&lt;__/     _-~</span><br><span class=\"line\">             ,//(&apos;(          |__&gt;--&lt;__|     /                  .----_</span><br><span class=\"line\">            ( ( &apos;))          |__&gt;--&lt;__|    |                 /&apos; _---_~\\</span><br><span class=\"line\">         `-)) )) (           |__&gt;--&lt;__|    |               /&apos;  /     ~\\`\\</span><br><span class=\"line\">        ,/,&apos;//( (             \\__&gt;--&lt;__\\    \\            /&apos;  //        ||</span><br><span class=\"line\">      ,( ( ((, ))              ~-__&gt;--&lt;_~-_  ~--____---~&apos; _/&apos;/        /&apos;</span><br><span class=\"line\">    `~/  )` ) ,/|                 ~-_~&gt;--&lt;_/-__       __-~ _/</span><br><span class=\"line\">  ._-~//( )/ )) `                    ~~-&apos;_/_/ /~~~~~~~__--~</span><br><span class=\"line\">   ;&apos;( &apos;)/ ,)(                              ~~~~~~~~~~</span><br><span class=\"line\">  &apos; &apos;) &apos;( (/</span><br><span class=\"line\">    &apos;   &apos;  `</span><br></pre></td></tr></table></figure>\n\n<hr>\n<p></p>\n<p><a href=\"https://github.com/saojs/sao\">sao</a>,<a href=\"https://github.com/elastic/template-kibana-plugin\"></a><a href=\"https://www.gitbook.com/book/trumandu/kibana-plugin-development-tutorial/details\" target=\"_blank\" rel=\"noopener\"></a>..</p>\n<h3 id=\"visTypes\"><a href=\"#visTypes\" class=\"headerlink\" title=\"visTypes\"></a>visTypes</h3><p>Visualizees6,angular(angular12kibanaangular1)kibanaVisualize<a href=\"https://d3js.org/\" target=\"_blank\" rel=\"noopener\">d3</a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>vis<a href=\"https://github.com/ommsolutions/kibana_ext_metrics_vis\"></a>()gifmetric(kibana(*10))</p>\n<p>extended_metric_vis.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return new TemplateVisType(&#123;</span><br><span class=\"line\">    name: &apos;extended_metric&apos;,</span><br><span class=\"line\">    title: &apos;Extended Metric&apos;,</span><br><span class=\"line\">    description: &apos;Based on the core Metric-Plugin but gives you the ability&apos; +</span><br><span class=\"line\">      &apos;to output custom aggregates on metric-results.&apos;,</span><br><span class=\"line\">    icon: &apos;fa-calculator&apos;,</span><br><span class=\"line\">    template: extendedMetricVisTemplate, //.html</span><br><span class=\"line\">    params: &#123; //OptionsOptions</span><br><span class=\"line\">      defaults: &#123;</span><br><span class=\"line\">        handleNoResults: true,</span><br><span class=\"line\">        fontSize: 60,</span><br><span class=\"line\">        outputs: [</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            formula: &apos;metrics[0].value * metrics[0].value&apos;,</span><br><span class=\"line\">            label: &apos;Count squared&apos;,</span><br><span class=\"line\">            enabled: true</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      editor: metricVisParamsTemplate //Options.html</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    schemas: new Schemas([ //Data</span><br><span class=\"line\">    \t\t\t\t\t//metricbucketmetric  Y bucket  X </span><br><span class=\"line\">      &#123;           // bucket  Schema  segment(), group  split</span><br><span class=\"line\">        group: &apos;metrics&apos;,</span><br><span class=\"line\">        name: &apos;metric&apos;,</span><br><span class=\"line\">        title: &apos;Metric&apos;,</span><br><span class=\"line\">        min: 1,</span><br><span class=\"line\">        defaults: [</span><br><span class=\"line\">          &#123; type: &apos;count&apos;, schema: &apos;metric&apos; &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ])</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>visTemplateVisType</p>\n<p>htmlextended_metric_vis.htmlextended_metric_vis_params.html, view,angularmvcc =&gt; extended_metric_vis_controller.jsangular</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResponse&apos;, function (resp) &#123;</span><br><span class=\"line\">    if (resp) &#123;</span><br><span class=\"line\">      calcOutputs.length = 0;</span><br><span class=\"line\">      metrics.length = 0;</span><br><span class=\"line\">      //metrics</span><br><span class=\"line\">      for (let key in metrics) &#123;</span><br><span class=\"line\">        if (metrics.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">          delete metrics[key];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      $scope.processTableGroups(tabifyAggResponse($scope.vis, resp));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>esesesResponseprocessTableGroupstabifyAggResponsees(data)tabifyAggResponsecolumnsrowsdatametric, columnsmetrictitle(label)indexrowsmetricprocessTableGroupscolumnstitlemetricmetrics()</p>\n<p>viewjs</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try &#123;</span><br><span class=\"line\">  const func = Function(&quot;metrics&quot;, &quot;return &quot; + output.formula); //&lt;&lt;&lt;&lt;=</span><br><span class=\"line\">  output.value = func(metrics) || &quot;?&quot;;</span><br><span class=\"line\">&#125; catch (e) &#123;</span><br><span class=\"line\">  output.value = &apos;?&apos;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>output.formulastringstring</p>\n<p>data/option</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//updateOutputs</span><br><span class=\"line\">$scope.$watchCollection(&apos;vis.params.outputs&apos;, updateOutputs);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>TemplateVisType</p>\n<ul>\n<li><p>src/core_plugins/kbn_vislib_vis_types</p>\n<p>visoptionshtml,jsline.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">return new VislibVisType(&#123;</span><br><span class=\"line\">  name: &apos;line&apos;,</span><br><span class=\"line\">  title: &apos;Line&apos;,</span><br><span class=\"line\">  image,</span><br><span class=\"line\">  description: &apos;Emphasize trends&apos;,</span><br><span class=\"line\">  category: VisType.CATEGORY.BASIC,</span><br><span class=\"line\">  params: &#123;</span><br><span class=\"line\">    defaults: &#123;</span><br><span class=\"line\">      grid: &#123;</span><br><span class=\"line\">        categoryLines: false,</span><br><span class=\"line\">        style: &#123;</span><br><span class=\"line\">          color: &apos;#eee&apos;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      ...</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    positions: [&apos;top&apos;, &apos;left&apos;, &apos;right&apos;, &apos;bottom&apos;],</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    editor: pointSeriesTemplate,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    schemas: new Schemas([</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      group: &apos;metrics&apos;,</span><br><span class=\"line\">      name: &apos;metric&apos;,</span><br><span class=\"line\">      title: &apos;Y-Axis&apos;,</span><br><span class=\"line\">      min: 1,</span><br><span class=\"line\">      aggFilter: [&apos;!geo_centroid&apos;],</span><br><span class=\"line\">      defaults: [</span><br><span class=\"line\">        &#123; schema: &apos;metric&apos;, type: &apos;count&apos; &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">   \t....</span><br><span class=\"line\">  ])</span><br></pre></td></tr></table></figure>\n\n<p>extended_metric_vis.jsTemplateVisTypeVislibVisTypevis_typevis()visTemplateVisTypetemplate</p>\n</li>\n<li><p>src/public/ui/vis/vis_type</p>\n<p>createRenderbotcreateRenderbotRenderbot</p>\n</li>\n<li><p>src/public/ui/vislib_vis_type/vislib_vis_type</p>\n<p>vis_type</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">const updateParams = function (params) &#123;</span><br><span class=\"line\">\tconst updateIfSet = (from, to, prop, func) =&gt; &#123;</span><br><span class=\"line\">      if (from[prop]) &#123;</span><br><span class=\"line\">        to[prop] = func ? func(from[prop]) : from[prop];</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">...</span><br><span class=\"line\">// VisTyperesponseConverter</span><br><span class=\"line\">_.class(VislibVisType).inherits(VisType);</span><br><span class=\"line\">  function VislibVisType(opts = &#123;&#125;) &#123;</span><br><span class=\"line\">    VislibVisType.Super.call(this, opts);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (this.responseConverter == null) &#123;</span><br><span class=\"line\">      this.responseConverter = pointSeries;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    this.listeners = opts.listeners || &#123;&#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">// createRenderbot</span><br><span class=\"line\">   VislibVisType.prototype.createRenderbot = function (vis, $el, uiState) &#123;</span><br><span class=\"line\">   // VislibRenderbotvis.paramsparamsparams.seriesParams[0]params.valueAxes[0]params.categoryAxes[0]</span><br><span class=\"line\">    updateParams(vis.params);</span><br><span class=\"line\">    return new VislibRenderbot(vis, $el, uiState);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>paramsVislibRenderbotRenderbotRenderbot..</p>\n</li>\n<li><p>src/public/ui/vislib_vis_type/vislib_renderbot</p>\n<p>RenderbotVislibRenderbotRenderbotVislibRenderbot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VislibRenderbot.prototype.render = function (esResponse) &#123;</span><br><span class=\"line\">  this.chartData = this.buildChartData(esResponse);</span><br><span class=\"line\">  return AngularPromise.delay(1).then(() =&gt; &#123;</span><br><span class=\"line\">    this.vislibVis.render(this.chartData, this.uiState); //</span><br><span class=\"line\">    this.refreshLegend++;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>render,vislibRenderbot.render<br>this.vislibVisthis.vislibVis</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">this.vislibVis = new vislib.Vis(this.$el[0], this.vislibParams);</span><br></pre></td></tr></table></figure>\n\n<p>VisvisConfighandler, handlervisConfigvisConfig</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//src/public/ui/vislib/vis_config.js</span><br><span class=\"line\">const visType = visTypes[visConfigArgs.type];</span><br><span class=\"line\">const typeDefaults = visType(visConfigArgs, this.data); // &lt;= </span><br><span class=\"line\"></span><br><span class=\"line\">//visTypes =&gt; src/public/ui/vislib/types</span><br><span class=\"line\">  return &#123;</span><br><span class=\"line\">    histogram: pointSeries.column,</span><br><span class=\"line\">    horizontal_bar: pointSeries.column,</span><br><span class=\"line\">    line: pointSeries.line,</span><br><span class=\"line\">    pie: Private(VislibLibTypesPieProvider),</span><br><span class=\"line\">    area: pointSeries.area,</span><br><span class=\"line\">    point_series: pointSeries.line,</span><br><span class=\"line\">    heatmap: pointSeries.heatmap,</span><br><span class=\"line\">  &#125;;</span><br></pre></td></tr></table></figure>\n\n<p>handler,handlerrender,chart.render</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// render in handler</span><br><span class=\"line\">render() &#123;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\tconst chart = new self.ChartClass(self, this, chartData);</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\tchart.render();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//ChartClass in handler</span><br><span class=\"line\">this.ChartClass = chartTypes[visConfig.get(&apos;type&apos;)];</span><br><span class=\"line\"></span><br><span class=\"line\">//chartTypes from src/public/ui/vislib/visualizations/vis_types</span><br><span class=\"line\">//Chartcomponents/vislib/visualizations/_chart</span><br><span class=\"line\">  Chart.prototype.render = function () &#123;</span><br><span class=\"line\">      var selection = d3.select(this.chartEl);</span><br><span class=\"line\">      selection.selectAll(&apos;*&apos;).remove();</span><br><span class=\"line\">      selection.call(this.draw());</span><br><span class=\"line\">   &#125;;</span><br><span class=\"line\">  // d3.js  draw() </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>src/public/visualize/visualize</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$scope.$watch(&apos;esResp&apos;, prereq(function (resp) &#123;</span><br><span class=\"line\">    if (!resp) return;</span><br><span class=\"line\">    $scope.renderbot.render(resp);</span><br><span class=\"line\">  &#125;));</span><br></pre></td></tr></table></figure>\n\n<p> visualize.jsVisualizationBossvisualizevis_typesrenderbotrender</p>\n</li>\n</ul>\n<p>visVislibVisTypeTemplateVisTyperenderbotvisualizerenderbotTemplateVisTypetemplate(html), ()visualizerenderbot.renderVisRenderbotrender..TemplateRenderbotrenderesResponseesResponseesResponse</p>\n<p></p>\n"},{"title":"zilliqa","date":"2019-10-14T06:39:28.000Z","_content":"\n## Zil\n\n\n\n\n\n\n\n#### \n\nZILLIQA ZILLIQAPoW SHA3 [6] SHA3Keccak [7] Keccak\n\n- \n\n  ZILLIQASchnorrEC-Schnorr[8]secp256k1[9]ECDSAECDSAECSchnorr\n\n  1. ECDSAEC Schnorr[10]\n  2. EC-Schnorr[11]ECDSAZILLIQAEC-Schnorr\n  3. EC-SchnorrECDSA EC-Schnorr\n\n  EC-SchnorrAEC-Schnorr\n\n\n\n- POW\n\n  ZILLIQAPoWSybilPoW ZILLIQAEthash Ethereum 1.0PoW EthashGPUASICEthashGBI / OEthash64256\n\n  1. SHA3-2563000032SHA3-256SHA3-256\n  2. SHA3-51216 MB\n  3. 1 GB\n  4. \n\n\n\n#### \n\nZILLIQA ZILLIQA\n\n- \n\n  ZILLIQA  ECSchnorr   skAnormal160\n\n  ```\n  Anormal = LSB160(SHA3-256(PubKey(sk))),\n  ```\n\n  LSB160160PubKey \n\n  ```\n  Acontract = LSB160(SHA3-256(address||nonce)),\n  ```\n\n  addressnonce\n\n  1640\n\n  2128tokentoken\n\n  3256SHA3-256SHA3-256\n\n  4256key-value256256SHA3-256trietrie\n\n  ZILLIQAtrie\n\n- \n\n  ZILLIQA\n  132\n  2nonce64\n  3160160SHA3-256\n  4128\n  5gas128gasgasgas\n  6gas128gas\n  7\n  8data\n  9264EC-Schnorr pubkey\n  10512EC-SchnorrID - SHA3-256\n\n\n\n#### \n\nZILLIQATXDS TXDS\n\n- DSDS DS\n\n\t132\n\t2256SHA3-256\n\t3264PoW\n\t464PoW\n\t52560\n\t664Unix\n\t7mixHash256nonceDoS\n\t8nonce64PoW\n\n DS\n\t1512DSDSEC-Schnorr\n\t21024DSBB [i] = 0, iB [i] = 1\n\nDSDS\n\n- \n\n  DS TXDSDSTX TX\n  18TX-Block0x000x01V-D\n  232\n  3256SHA3-256\n  4gas128gas\n  5gas128gas\n  6256genesis0\n  764Unix\n  8256SHA3-256trietrie\n  9256SHA3-256Merkle\n  10tx256SHA3-256\n  11264EC-Schnorr\n  12pubkeyECSchnorr264final\n  13256SHA3-256\n  14DS256DS-BlockSHA3-256\n  15DS256DS\n\n   TX\n  1tx32\n  2tx listunlimited\n\n   TX-BlockECSchnorr\n\n  1. 512EC-SchnorrTX-BlocV-D\n\n  21024BiB [i] = 1B [i] = 0\n\n  final\n\n\n\n### \n\nZILLIQA\n\n#### \n\nDS\n\n- Directory Service Committee(DS)**DSDSDSproof-of-work1**\n\n  ```\n  //Algorithm 1: PoW1 for DS committee election.\n  Input: i: Current DS-epoch, DSi1: Prev. DS committee\n  composition.\n  Output: header: DS-Block header.\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r1  GetEpochRand(DBi1)\n  // get epoch randomness from the transaction blockchain\n  // TBj : Most recent TX-Block before start of i-th epoch\n   r2  GetEpochRand(TBj )\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)\n   header  BuildHeader(nonce, mixHash, pk)\n  // header includes pk and nonce among other fields\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi1(IP, header)\n   return header\n  ```\n\n  DS-BlockPOW11DSDS2fDSDS\n\n   DSn0n0DS-BlockDS\n\n  DS-BlockDS-epochDS-eposhDS-epochDSDSDSDS-eposhDSn0**DSleader, ** DS\n\n  DSn0800n01/3\n\n- DS   DSnonce iDSmax(n)\n\n  DSleaderheaderDS-         Block header max(n)iDSheader DS-Block\n\n- DS PoW2 DS 2PoW2\n\n  ```\n  Algorithm 2: PoW2 for shard membership.\n  Input: i: Current DS-epoch, DSi: Current DS committee\n  composition.\n  Output: nonce, mixHash: outputs of Ethash-PoW\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r  GetEpochRand(DBi)\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r)\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi(nonce, mixHash, pk, IP)\n   return nonce, mixHash\n\n  ```\n\n  **PoW2DS DSPoWLn0**DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2\n  Shardingn0n0n0**leader**n08001/3\n\n#### \n\nDSDSV-D    DS2/3\n\n#### ZILLIQA\n\nPoW1DSPoW2 PoW1PoW2 DS\n\n#### \n\n  A -->BABnZIL\n\n- A -->B L0L-1(logL + 1)bitA160(bit)L**logL + 1  160**100\n\n   TX-Block\n\n  ****  nonce  \n\n- TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS(DStx)\n\n  :\n\n  1. DSEC-Schnorr 2/3n0\n  2. hash header \n  3. dataTX \n  4.  \n\n\n\n### \n\nDSDSDS\n\n##### \n\nZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT\n\nPBFT PBFT\n\n- :  TX-Block\n- \n- 2/3\\*n2/3\\*n \n\nPBFT  PBFT  2/3\\*n\n\n /PBFTOn*n\n\n\n\n##### \n\nPBFTMAC MACOn*n 20PBFT\n\nByzCoin\n\n- MACOn\n-  EC-SchnorrO1 - \n\nPBFTEC-Schnorr  PBFT2/3\\*n B. iB [i] = 10  B\n\n\n\n##### Zilliqa\n\nZILLIQAPBFTEC-SchnorrPBFT PBFT\n\n- : PBFTTX-Block\n- TX2/3\\*n  EC-Schnorr TX\n- 2/3\\*n2/3\\*nTX-BlockEC-Schnorr \n\nTX-Block\n\n\n\n##### \n\n  DS  \n\n DS nDS-epochn11\n\n\n\n\n\n#### A\n\n##### EC-Schnorr\n\nEC-Schnorr[8][24][25] ZILLIQAsecp256k1 C :=pGnpFpGn GEC-SchnorrHSHA3-256 [6]\n\n EC-SchnorrKeyGenSignVerify xQ[x] Q\n\n- KeyGen(C): Cpksk\n- Sign(C, pk, sk, m) Cpksk \n- Verify(C, , pk, m):  Cpkm pkm10\n\n#####  \n\n##### EC-Schnorr\n\n- EC-Schnorr[11]TP1...   PTmPiEC-Schnorrpkiski\n\n  P = {pk1   pkT}mpmpIDXXXX[26]\n\n- 2\n\n  1. PimpEC-SchnorriPiipki\n\n     - pkiP.\n     - VerifyCipkimpipkimpEC-Schnorr0\n\n     PpkiiPiZ [1...   | P |] .\n\n  2. commitment Piki $[1n-1]Qi = [ki] GGnG.PiQi\n\n  3. Challenge PQirHQ || pk || mmod nrQpkPi\n\n  4. PirHQ || pk || mrPisiki -rskimod nsi\n\n  5. s = Pi si mod n=rsm\n\n  6. Verifier\n\n     - Ppk0\n     - mpk0EC-Schnorr\n\n\n\n\n\n\n\n= _1 + _2 + +_n\n\n\n\ninteractive protocol\n\n**1Commit phase**cryptographic commitment\n\n**2Challenge phase**\n\n**3Response phase**\n\n\n\n\n\nHmRSRRiSSi\n\nall-or-nothing\n","source":"_posts/zilliqa.md","raw":"---\ntitle: zilliqa\ncategories:\n  - zilliqa\ndate: 2019-10-14 14:39:28\ntags:\n---\n\n## Zil\n\n\n\n\n\n\n\n#### \n\nZILLIQA ZILLIQAPoW SHA3 [6] SHA3Keccak [7] Keccak\n\n- \n\n  ZILLIQASchnorrEC-Schnorr[8]secp256k1[9]ECDSAECDSAECSchnorr\n\n  1. ECDSAEC Schnorr[10]\n  2. EC-Schnorr[11]ECDSAZILLIQAEC-Schnorr\n  3. EC-SchnorrECDSA EC-Schnorr\n\n  EC-SchnorrAEC-Schnorr\n\n\n\n- POW\n\n  ZILLIQAPoWSybilPoW ZILLIQAEthash Ethereum 1.0PoW EthashGPUASICEthashGBI / OEthash64256\n\n  1. SHA3-2563000032SHA3-256SHA3-256\n  2. SHA3-51216 MB\n  3. 1 GB\n  4. \n\n\n\n#### \n\nZILLIQA ZILLIQA\n\n- \n\n  ZILLIQA  ECSchnorr   skAnormal160\n\n  ```\n  Anormal = LSB160(SHA3-256(PubKey(sk))),\n  ```\n\n  LSB160160PubKey \n\n  ```\n  Acontract = LSB160(SHA3-256(address||nonce)),\n  ```\n\n  addressnonce\n\n  1640\n\n  2128tokentoken\n\n  3256SHA3-256SHA3-256\n\n  4256key-value256256SHA3-256trietrie\n\n  ZILLIQAtrie\n\n- \n\n  ZILLIQA\n  132\n  2nonce64\n  3160160SHA3-256\n  4128\n  5gas128gasgasgas\n  6gas128gas\n  7\n  8data\n  9264EC-Schnorr pubkey\n  10512EC-SchnorrID - SHA3-256\n\n\n\n#### \n\nZILLIQATXDS TXDS\n\n- DSDS DS\n\n\t132\n\t2256SHA3-256\n\t3264PoW\n\t464PoW\n\t52560\n\t664Unix\n\t7mixHash256nonceDoS\n\t8nonce64PoW\n\n DS\n\t1512DSDSEC-Schnorr\n\t21024DSBB [i] = 0, iB [i] = 1\n\nDSDS\n\n- \n\n  DS TXDSDSTX TX\n  18TX-Block0x000x01V-D\n  232\n  3256SHA3-256\n  4gas128gas\n  5gas128gas\n  6256genesis0\n  764Unix\n  8256SHA3-256trietrie\n  9256SHA3-256Merkle\n  10tx256SHA3-256\n  11264EC-Schnorr\n  12pubkeyECSchnorr264final\n  13256SHA3-256\n  14DS256DS-BlockSHA3-256\n  15DS256DS\n\n   TX\n  1tx32\n  2tx listunlimited\n\n   TX-BlockECSchnorr\n\n  1. 512EC-SchnorrTX-BlocV-D\n\n  21024BiB [i] = 1B [i] = 0\n\n  final\n\n\n\n### \n\nZILLIQA\n\n#### \n\nDS\n\n- Directory Service Committee(DS)**DSDSDSproof-of-work1**\n\n  ```\n  //Algorithm 1: PoW1 for DS committee election.\n  Input: i: Current DS-epoch, DSi1: Prev. DS committee\n  composition.\n  Output: header: DS-Block header.\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r1  GetEpochRand(DBi1)\n  // get epoch randomness from the transaction blockchain\n  // TBj : Most recent TX-Block before start of i-th epoch\n   r2  GetEpochRand(TBj )\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)\n   header  BuildHeader(nonce, mixHash, pk)\n  // header includes pk and nonce among other fields\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi1(IP, header)\n   return header\n  ```\n\n  DS-BlockPOW11DSDS2fDSDS\n\n   DSn0n0DS-BlockDS\n\n  DS-BlockDS-epochDS-eposhDS-epochDSDSDSDS-eposhDSn0**DSleader, ** DS\n\n  DSn0800n01/3\n\n- DS   DSnonce iDSmax(n)\n\n  DSleaderheaderDS-         Block header max(n)iDSheader DS-Block\n\n- DS PoW2 DS 2PoW2\n\n  ```\n  Algorithm 2: PoW2 for shard membership.\n  Input: i: Current DS-epoch, DSi: Current DS committee\n  composition.\n  Output: nonce, mixHash: outputs of Ethash-PoW\n   On each competing node:\n  // get epoch randomness from the DS blockchain\n  // DBi1: Most recent DS-Block before start of i-th epoch\n   r  GetEpochRand(DBi)\n  // pk: nodes public key, IP = nodes IP address\n   nonce, mixHash  Ethash-PoW(pk, IP, r)\n  // IP, header is multicast to members in the DS committee\n   MulticastToDSi(nonce, mixHash, pk, IP)\n   return nonce, mixHash\n\n  ```\n\n  **PoW2DS DSPoWLn0**DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2\n  Shardingn0n0n0**leader**n08001/3\n\n#### \n\nDSDSV-D    DS2/3\n\n#### ZILLIQA\n\nPoW1DSPoW2 PoW1PoW2 DS\n\n#### \n\n  A -->BABnZIL\n\n- A -->B L0L-1(logL + 1)bitA160(bit)L**logL + 1  160**100\n\n   TX-Block\n\n  ****  nonce  \n\n- TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS(DStx)\n\n  :\n\n  1. DSEC-Schnorr 2/3n0\n  2. hash header \n  3. dataTX \n  4.  \n\n\n\n### \n\nDSDSDS\n\n##### \n\nZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT\n\nPBFT PBFT\n\n- :  TX-Block\n- \n- 2/3\\*n2/3\\*n \n\nPBFT  PBFT  2/3\\*n\n\n /PBFTOn*n\n\n\n\n##### \n\nPBFTMAC MACOn*n 20PBFT\n\nByzCoin\n\n- MACOn\n-  EC-SchnorrO1 - \n\nPBFTEC-Schnorr  PBFT2/3\\*n B. iB [i] = 10  B\n\n\n\n##### Zilliqa\n\nZILLIQAPBFTEC-SchnorrPBFT PBFT\n\n- : PBFTTX-Block\n- TX2/3\\*n  EC-Schnorr TX\n- 2/3\\*n2/3\\*nTX-BlockEC-Schnorr \n\nTX-Block\n\n\n\n##### \n\n  DS  \n\n DS nDS-epochn11\n\n\n\n\n\n#### A\n\n##### EC-Schnorr\n\nEC-Schnorr[8][24][25] ZILLIQAsecp256k1 C :=pGnpFpGn GEC-SchnorrHSHA3-256 [6]\n\n EC-SchnorrKeyGenSignVerify xQ[x] Q\n\n- KeyGen(C): Cpksk\n- Sign(C, pk, sk, m) Cpksk \n- Verify(C, , pk, m):  Cpkm pkm10\n\n#####  \n\n##### EC-Schnorr\n\n- EC-Schnorr[11]TP1...   PTmPiEC-Schnorrpkiski\n\n  P = {pk1   pkT}mpmpIDXXXX[26]\n\n- 2\n\n  1. PimpEC-SchnorriPiipki\n\n     - pkiP.\n     - VerifyCipkimpipkimpEC-Schnorr0\n\n     PpkiiPiZ [1...   | P |] .\n\n  2. commitment Piki $[1n-1]Qi = [ki] GGnG.PiQi\n\n  3. Challenge PQirHQ || pk || mmod nrQpkPi\n\n  4. PirHQ || pk || mrPisiki -rskimod nsi\n\n  5. s = Pi si mod n=rsm\n\n  6. Verifier\n\n     - Ppk0\n     - mpk0EC-Schnorr\n\n\n\n\n\n\n\n= _1 + _2 + +_n\n\n\n\ninteractive protocol\n\n**1Commit phase**cryptographic commitment\n\n**2Challenge phase**\n\n**3Response phase**\n\n\n\n\n\nHmRSRRiSSi\n\nall-or-nothing\n","slug":"zilliqa","published":1,"updated":"2019-10-14T06:40:25.020Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69xy002st6xvbwt6358n","content":"<h2 id=\"Zil\"><a href=\"#Zil\" class=\"headerlink\" title=\"Zil\"></a>Zil</h2><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ZILLIQA ZILLIQAPoW SHA3 [6] SHA3Keccak [7] Keccak</p>\n<ul>\n<li><p></p>\n<p>ZILLIQASchnorrEC-Schnorr[8]secp256k1[9]ECDSAECDSAECSchnorr</p>\n<ol>\n<li>ECDSAEC Schnorr[10]</li>\n<li>EC-Schnorr[11]ECDSAZILLIQAEC-Schnorr</li>\n<li>EC-SchnorrECDSA EC-Schnorr</li>\n</ol>\n<p>EC-SchnorrAEC-Schnorr</p>\n</li>\n</ul>\n<ul>\n<li><p>POW</p>\n<p>ZILLIQAPoWSybilPoW ZILLIQAEthash Ethereum 1.0PoW EthashGPUASICEthashGBI / OEthash64256</p>\n<ol>\n<li>SHA3-2563000032SHA3-256SHA3-256</li>\n<li>SHA3-51216 MB</li>\n<li>1 GB</li>\n<li></li>\n</ol>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ZILLIQA ZILLIQA</p>\n<ul>\n<li><p></p>\n<p>ZILLIQA  ECSchnorr   skAnormal160</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Anormal = LSB160(SHA3-256(PubKey(sk))),</span><br></pre></td></tr></table></figure>\n\n<p>LSB160160PubKey </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Acontract = LSB160(SHA3-256(address||nonce)),</span><br></pre></td></tr></table></figure>\n\n<p>addressnonce</p>\n<p>1640</p>\n<p>2128tokentoken</p>\n<p>3256SHA3-256SHA3-256</p>\n<p>4256key-value256256SHA3-256trietrie</p>\n<p>ZILLIQAtrie</p>\n</li>\n<li><p></p>\n<p>ZILLIQA<br>132<br>2nonce64<br>3160160SHA3-256<br>4128<br>5gas128gasgasgas<br>6gas128gas<br>7<br>8data<br>9264EC-Schnorr pubkey<br>10512EC-SchnorrID - SHA3-256</p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ZILLIQATXDS TXDS</p>\n<ul>\n<li>DSDS DS</li>\n</ul>\n<p>    132<br>    2256SHA3-256<br>    3264PoW<br>    464PoW<br>    52560<br>    664Unix<br>    7mixHash256nonceDoS<br>    8nonce64PoW</p>\n<p> DS<br>    1512DSDSEC-Schnorr<br>    21024DSBB [i] = 0, iB [i] = 1</p>\n<p>DSDS</p>\n<ul>\n<li><p></p>\n<p>DS TXDSDSTX TX<br>18TX-Block0x000x01V-D<br>232<br>3256SHA3-256<br>4gas128gas<br>5gas128gas<br>6256genesis0<br>764Unix<br>8256SHA3-256trietrie<br>9256SHA3-256Merkle<br>10tx256SHA3-256<br>11264EC-Schnorr<br>12pubkeyECSchnorr264final<br>13256SHA3-256<br>14DS256DS-BlockSHA3-256<br>15DS256DS</p>\n<p> TX<br>1tx32<br>2tx listunlimited</p>\n<p> TX-BlockECSchnorr</p>\n<ol>\n<li>512EC-SchnorrTX-BlocV-D</li>\n</ol>\n<p>21024BiB [i] = 1B [i] = 0</p>\n<p>final</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ZILLIQA</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DS</p>\n<ul>\n<li><p>Directory Service Committee(DS)<strong>DSDSDSproof-of-work1</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Algorithm 1: PoW1 for DS committee election.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi1: Prev. DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: header: DS-Block header.</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r1  GetEpochRand(DBi1)</span><br><span class=\"line\">// get epoch randomness from the transaction blockchain</span><br><span class=\"line\">// TBj : Most recent TX-Block before start of i-th epoch</span><br><span class=\"line\"> r2  GetEpochRand(TBj )</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)</span><br><span class=\"line\"> header  BuildHeader(nonce, mixHash, pk)</span><br><span class=\"line\">// header includes pk and nonce among other fields</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi1(IP, header)</span><br><span class=\"line\"> return header</span><br></pre></td></tr></table></figure>\n\n<p>DS-BlockPOW11DSDS2fDSDS</p>\n<p> DSn0n0DS-BlockDS</p>\n<p>DS-BlockDS-epochDS-eposhDS-epochDSDSDSDS-eposhDSn0<strong>DSleader, </strong> DS</p>\n<p>DSn0800n01/3</p>\n</li>\n<li><p>DS   DSnonce iDSmax(n)</p>\n<p>DSleaderheaderDS-         Block header max(n)iDSheader DS-Block</p>\n</li>\n<li><p>DS PoW2 DS 2PoW2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Algorithm 2: PoW2 for shard membership.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi: Current DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: nonce, mixHash: outputs of Ethash-PoW</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r  GetEpochRand(DBi)</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r)</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi(nonce, mixHash, pk, IP)</span><br><span class=\"line\"> return nonce, mixHash</span><br></pre></td></tr></table></figure>\n\n<p><strong>PoW2DS DSPoWLn0</strong>DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2<br>Shardingn0n0n0<strong>leader</strong>n08001/3</p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DSDSV-D    DS2/3</p>\n<h4 id=\"ZILLIQA\"><a href=\"#ZILLIQA\" class=\"headerlink\" title=\"ZILLIQA\"></a>ZILLIQA</h4><p>PoW1DSPoW2 PoW1PoW2 DS</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>  A --&gt;BABnZIL</p>\n<ul>\n<li><p>A --&gt;B L0L-1(logL + 1)bitA160(bit)L<strong>logL + 1  160</strong>100</p>\n<p> TX-Block</p>\n<p><strong></strong>  nonce  </p>\n</li>\n<li><p>TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS(DStx)</p>\n<p>:</p>\n<ol>\n<li>DSEC-Schnorr 2/3n0</li>\n<li>hash header </li>\n<li>dataTX </li>\n<li> </li>\n</ol>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DSDSDS</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>ZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT</p>\n<p>PBFT PBFT</p>\n<ul>\n<li>:  TX-Block</li>\n<li></li>\n<li>2/3*n2/3*n </li>\n</ul>\n<p>PBFT  PBFT  2/3*n</p>\n<p> /PBFTOn*n</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>PBFTMAC MACOn*n 20PBFT</p>\n<p>ByzCoin</p>\n<ul>\n<li>MACOn</li>\n<li> EC-SchnorrO1 - </li>\n</ul>\n<p>PBFTEC-Schnorr  PBFT2/3*n B. iB [i] = 10  B</p>\n<h5 id=\"Zilliqa\"><a href=\"#Zilliqa\" class=\"headerlink\" title=\"Zilliqa\"></a>Zilliqa</h5><p>ZILLIQAPBFTEC-SchnorrPBFT PBFT</p>\n<ul>\n<li>: PBFTTX-Block</li>\n<li>TX2/3*n  EC-Schnorr TX</li>\n<li>2/3*n2/3*nTX-BlockEC-Schnorr </li>\n</ul>\n<p>TX-Block</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>  DS  </p>\n<p> DS nDS-epochn11</p>\n<h4 id=\"A\"><a href=\"#A\" class=\"headerlink\" title=\"A\"></a>A</h4><h5 id=\"EC-Schnorr\"><a href=\"#EC-Schnorr\" class=\"headerlink\" title=\"EC-Schnorr\"></a>EC-Schnorr</h5><p>EC-Schnorr[8][24][25] ZILLIQAsecp256k1 C :=pGnpFpGn GEC-SchnorrHSHA3-256 [6]</p>\n<p> EC-SchnorrKeyGenSignVerify xQ[x] Q</p>\n<ul>\n<li>KeyGen(C): Cpksk</li>\n<li>Sign(C, pk, sk, m) Cpksk </li>\n<li>Verify(C, , pk, m):  Cpkm pkm10</li>\n</ul>\n<h5 id><a href=\"#\" class=\"headerlink\" title></a></h5><h5 id=\"EC-Schnorr\"><a href=\"#EC-Schnorr\" class=\"headerlink\" title=\"EC-Schnorr\"></a>EC-Schnorr</h5><ul>\n<li><p>EC-Schnorr[11]TP1   PTmPiEC-Schnorrpkiski</p>\n<p>P = {pk1   pkT}mpmpIDXXXX[26]</p>\n</li>\n<li><p>2</p>\n<ol>\n<li><p>PimpEC-SchnorriPiipki</p>\n<ul>\n<li>pkiP.</li>\n<li>VerifyCipkimpipkimpEC-Schnorr0</li>\n</ul>\n<p>PpkiiPiZ [1   | P |] .</p>\n</li>\n<li><p>commitment Piki $[1n-1]Qi = [ki] GGnG.PiQi</p>\n</li>\n<li><p>Challenge PQirHQ || pk || mmod nrQpkPi</p>\n</li>\n<li><p>PirHQ || pk || mrPisiki -rskimod nsi</p>\n</li>\n<li><p>s = Pi si mod n=rsm</p>\n</li>\n<li><p>Verifier</p>\n<ul>\n<li>Ppk0</li>\n<li>mpk0EC-Schnorr</li>\n</ul>\n</li>\n</ol>\n</li>\n</ul>\n<p></p>\n<p></p>\n<p>= _1 + _2 + +_n</p>\n<p></p>\n<p>interactive protocol</p>\n<p><strong>1Commit phase</strong>cryptographic commitment</p>\n<p><strong>2Challenge phase</strong></p>\n<p><strong>3Response phase</strong></p>\n<p></p>\n<p></p>\n<p>HmRSRRiSSi</p>\n<p>all-or-nothing</p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h2 id=\"Zil\"><a href=\"#Zil\" class=\"headerlink\" title=\"Zil\"></a>Zil</h2><p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ZILLIQA ZILLIQAPoW SHA3 [6] SHA3Keccak [7] Keccak</p>\n<ul>\n<li><p></p>\n<p>ZILLIQASchnorrEC-Schnorr[8]secp256k1[9]ECDSAECDSAECSchnorr</p>\n<ol>\n<li>ECDSAEC Schnorr[10]</li>\n<li>EC-Schnorr[11]ECDSAZILLIQAEC-Schnorr</li>\n<li>EC-SchnorrECDSA EC-Schnorr</li>\n</ol>\n<p>EC-SchnorrAEC-Schnorr</p>\n</li>\n</ul>\n<ul>\n<li><p>POW</p>\n<p>ZILLIQAPoWSybilPoW ZILLIQAEthash Ethereum 1.0PoW EthashGPUASICEthashGBI / OEthash64256</p>\n<ol>\n<li>SHA3-2563000032SHA3-256SHA3-256</li>\n<li>SHA3-51216 MB</li>\n<li>1 GB</li>\n<li></li>\n</ol>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ZILLIQA ZILLIQA</p>\n<ul>\n<li><p></p>\n<p>ZILLIQA  ECSchnorr   skAnormal160</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Anormal = LSB160(SHA3-256(PubKey(sk))),</span><br></pre></td></tr></table></figure>\n\n<p>LSB160160PubKey </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Acontract = LSB160(SHA3-256(address||nonce)),</span><br></pre></td></tr></table></figure>\n\n<p>addressnonce</p>\n<p>1640</p>\n<p>2128tokentoken</p>\n<p>3256SHA3-256SHA3-256</p>\n<p>4256key-value256256SHA3-256trietrie</p>\n<p>ZILLIQAtrie</p>\n</li>\n<li><p></p>\n<p>ZILLIQA<br>132<br>2nonce64<br>3160160SHA3-256<br>4128<br>5gas128gasgasgas<br>6gas128gas<br>7<br>8data<br>9264EC-Schnorr pubkey<br>10512EC-SchnorrID - SHA3-256</p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>ZILLIQATXDS TXDS</p>\n<ul>\n<li>DSDS DS</li>\n</ul>\n<p>    132<br>    2256SHA3-256<br>    3264PoW<br>    464PoW<br>    52560<br>    664Unix<br>    7mixHash256nonceDoS<br>    8nonce64PoW</p>\n<p> DS<br>    1512DSDSEC-Schnorr<br>    21024DSBB [i] = 0, iB [i] = 1</p>\n<p>DSDS</p>\n<ul>\n<li><p></p>\n<p>DS TXDSDSTX TX<br>18TX-Block0x000x01V-D<br>232<br>3256SHA3-256<br>4gas128gas<br>5gas128gas<br>6256genesis0<br>764Unix<br>8256SHA3-256trietrie<br>9256SHA3-256Merkle<br>10tx256SHA3-256<br>11264EC-Schnorr<br>12pubkeyECSchnorr264final<br>13256SHA3-256<br>14DS256DS-BlockSHA3-256<br>15DS256DS</p>\n<p> TX<br>1tx32<br>2tx listunlimited</p>\n<p> TX-BlockECSchnorr</p>\n<ol>\n<li>512EC-SchnorrTX-BlocV-D</li>\n</ol>\n<p>21024BiB [i] = 1B [i] = 0</p>\n<p>final</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ZILLIQA</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DS</p>\n<ul>\n<li><p>Directory Service Committee(DS)<strong>DSDSDSproof-of-work1</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//Algorithm 1: PoW1 for DS committee election.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi1: Prev. DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: header: DS-Block header.</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r1  GetEpochRand(DBi1)</span><br><span class=\"line\">// get epoch randomness from the transaction blockchain</span><br><span class=\"line\">// TBj : Most recent TX-Block before start of i-th epoch</span><br><span class=\"line\"> r2  GetEpochRand(TBj )</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r1, r2)</span><br><span class=\"line\"> header  BuildHeader(nonce, mixHash, pk)</span><br><span class=\"line\">// header includes pk and nonce among other fields</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi1(IP, header)</span><br><span class=\"line\"> return header</span><br></pre></td></tr></table></figure>\n\n<p>DS-BlockPOW11DSDS2fDSDS</p>\n<p> DSn0n0DS-BlockDS</p>\n<p>DS-BlockDS-epochDS-eposhDS-epochDSDSDSDS-eposhDSn0<strong>DSleader, </strong> DS</p>\n<p>DSn0800n01/3</p>\n</li>\n<li><p>DS   DSnonce iDSmax(n)</p>\n<p>DSleaderheaderDS-         Block header max(n)iDSheader DS-Block</p>\n</li>\n<li><p>DS PoW2 DS 2PoW2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Algorithm 2: PoW2 for shard membership.</span><br><span class=\"line\">Input: i: Current DS-epoch, DSi: Current DS committee</span><br><span class=\"line\">composition.</span><br><span class=\"line\">Output: nonce, mixHash: outputs of Ethash-PoW</span><br><span class=\"line\"> On each competing node:</span><br><span class=\"line\">// get epoch randomness from the DS blockchain</span><br><span class=\"line\">// DBi1: Most recent DS-Block before start of i-th epoch</span><br><span class=\"line\"> r  GetEpochRand(DBi)</span><br><span class=\"line\">// pk: nodes public key, IP = nodes IP address</span><br><span class=\"line\"> nonce, mixHash  Ethash-PoW(pk, IP, r)</span><br><span class=\"line\">// IP, header is multicast to members in the DS committee</span><br><span class=\"line\"> MulticastToDSi(nonce, mixHash, pk, IP)</span><br><span class=\"line\"> return nonce, mixHash</span><br></pre></td></tr></table></figure>\n\n<p><strong>PoW2DS DSPoWLn0</strong>DSPoW2PoW2leaderDSEC-Schnorr2/3DSPoW2<br>Shardingn0n0n0<strong>leader</strong>n08001/3</p>\n</li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>DSDSV-D    DS2/3</p>\n<h4 id=\"ZILLIQA\"><a href=\"#ZILLIQA\" class=\"headerlink\" title=\"ZILLIQA\"></a>ZILLIQA</h4><p>PoW1DSPoW2 PoW1PoW2 DS</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>  A --&gt;BABnZIL</p>\n<ul>\n<li><p>A --&gt;B L0L-1(logL + 1)bitA160(bit)L<strong>logL + 1  160</strong>100</p>\n<p> TX-Block</p>\n<p><strong></strong>  nonce  </p>\n</li>\n<li><p>TX0x00EC-Schnorr2/3leaderBiTX-BlockB [i] = 1TXDS DSDS DS0x01TXDS2/3n0EC-Schnorr DSleaderBDSiTX-BlockB [i] = 1TXDS(DStx)</p>\n<p>:</p>\n<ol>\n<li>DSEC-Schnorr 2/3n0</li>\n<li>hash header </li>\n<li>dataTX </li>\n<li> </li>\n</ol>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DSDSDS</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>ZILLIQA(PBFT)PBFTEC-SchnorrEC-SchnorrO(n*n)O(n)O(n)O(1)n PBFT</p>\n<p>PBFT PBFT</p>\n<ul>\n<li>:  TX-Block</li>\n<li></li>\n<li>2/3*n2/3*n </li>\n</ul>\n<p>PBFT  PBFT  2/3*n</p>\n<p> /PBFTOn*n</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>PBFTMAC MACOn*n 20PBFT</p>\n<p>ByzCoin</p>\n<ul>\n<li>MACOn</li>\n<li> EC-SchnorrO1 - </li>\n</ul>\n<p>PBFTEC-Schnorr  PBFT2/3*n B. iB [i] = 10  B</p>\n<h5 id=\"Zilliqa\"><a href=\"#Zilliqa\" class=\"headerlink\" title=\"Zilliqa\"></a>Zilliqa</h5><p>ZILLIQAPBFTEC-SchnorrPBFT PBFT</p>\n<ul>\n<li>: PBFTTX-Block</li>\n<li>TX2/3*n  EC-Schnorr TX</li>\n<li>2/3*n2/3*nTX-BlockEC-Schnorr </li>\n</ul>\n<p>TX-Block</p>\n<h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h5><p>  DS  </p>\n<p> DS nDS-epochn11</p>\n<h4 id=\"A\"><a href=\"#A\" class=\"headerlink\" title=\"A\"></a>A</h4><h5 id=\"EC-Schnorr\"><a href=\"#EC-Schnorr\" class=\"headerlink\" title=\"EC-Schnorr\"></a>EC-Schnorr</h5><p>EC-Schnorr[8][24][25] ZILLIQAsecp256k1 C :=pGnpFpGn GEC-SchnorrHSHA3-256 [6]</p>\n<p> EC-SchnorrKeyGenSignVerify xQ[x] Q</p>\n<ul>\n<li>KeyGen(C): Cpksk</li>\n<li>Sign(C, pk, sk, m) Cpksk </li>\n<li>Verify(C, , pk, m):  Cpkm pkm10</li>\n</ul>\n<h5 id><a href=\"#\" class=\"headerlink\" title></a></h5><h5 id=\"EC-Schnorr\"><a href=\"#EC-Schnorr\" class=\"headerlink\" title=\"EC-Schnorr\"></a>EC-Schnorr</h5><ul>\n<li><p>EC-Schnorr[11]TP1   PTmPiEC-Schnorrpkiski</p>\n<p>P = {pk1   pkT}mpmpIDXXXX[26]</p>\n</li>\n<li><p>2</p>\n<ol>\n<li><p>PimpEC-SchnorriPiipki</p>\n<ul>\n<li>pkiP.</li>\n<li>VerifyCipkimpipkimpEC-Schnorr0</li>\n</ul>\n<p>PpkiiPiZ [1   | P |] .</p>\n</li>\n<li><p>commitment Piki $[1n-1]Qi = [ki] GGnG.PiQi</p>\n</li>\n<li><p>Challenge PQirHQ || pk || mmod nrQpkPi</p>\n</li>\n<li><p>PirHQ || pk || mrPisiki -rskimod nsi</p>\n</li>\n<li><p>s = Pi si mod n=rsm</p>\n</li>\n<li><p>Verifier</p>\n<ul>\n<li>Ppk0</li>\n<li>mpk0EC-Schnorr</li>\n</ul>\n</li>\n</ol>\n</li>\n</ul>\n<p></p>\n<p></p>\n<p>= _1 + _2 + +_n</p>\n<p></p>\n<p>interactive protocol</p>\n<p><strong>1Commit phase</strong>cryptographic commitment</p>\n<p><strong>2Challenge phase</strong></p>\n<p><strong>3Response phase</strong></p>\n<p></p>\n<p></p>\n<p>HmRSRRiSSi</p>\n<p>all-or-nothing</p>\n"},{"title":"eth_code_tx_event","date":"2019-10-14T06:47:58.000Z","_content":"\n#### ApplyTransaction\n\n```\n// ApplyTransaction attempts to apply a transaction to the given state database\n// and uses the input parameters for its environment. It returns the receipt\n// for the transaction, gas used and an error if the transaction failed,\n// indicating the block was invalid.\n//state database\nfunc ApplyTransaction(config *params.ChainConfig, bc ChainContext, author *common.Address, gp *GasPool, statedb *state.StateDB, header *types.Header, tx *types.Transaction, usedGas *uint64, cfg vm.Config) (*types.Receipt, uint64, error) {\n\t//\n\tmsg, err := tx.AsMessage(types.MakeSigner(config, header.Number))\n\tif err != nil {\n\t\treturn nil, 0, err\n\t}\n\n\t//EVMgaserrlogsevm\n\t// Create a new context to be used in the EVM environment\n\tcontext := NewEVMContext(msg, header, bc, author)\n\t// Create a new environment which holds all relevant information\n\t// about the transaction and calling mechanisms.\n\tvmenv := vm.NewEVM(context, statedb, config, cfg)\n\t// Apply the transaction to the current state (included in the env)\n\t_, gas, failed, err := ApplyMessage(vmenv, msg, gp)\n\tif err != nil {\n\t\treturn nil, 0, err\n\t}\n\n\n\t//\n\t// Update the state with pending changes\n\tvar root []byte\n\tif config.IsByzantium(header.Number) {\n\t\tstatedb.Finalise(true)\n\t} else {\n\t\troot = statedb.IntermediateRoot(config.IsEIP158(header.Number)).Bytes()\n\t}\n\t*usedGas += gas\n\n\t// Create a new receipt for the transaction, storing the intermediate root and gas used by the tx\n\t// based on the eip phase, we're passing whether the root touch-delete accounts.\n\treceipt := types.NewReceipt(root, failed, *usedGas)\n\treceipt.TxHash = tx.Hash()\n\treceipt.GasUsed = gas\n\t// if the transaction created a contract, store the creation address in the receipt.\n\tif msg.To() == nil {\n\t\treceipt.ContractAddress = crypto.CreateAddress(vmenv.Context.Origin, tx.Nonce())\n\t}\n\t// Set the receipt logs and create a bloom for filtering\n\treceipt.Logs = statedb.GetLogs(tx.Hash())\n\treceipt.Bloom = types.CreateBloom(types.Receipts{receipt})\n\n\treturn receipt, gas, err\n}\n\n```\n\n\n\n```\nfunc (evm *EVM) Call(caller ContractRef, addr common.Address, input []byte, gas uint64, value *big.Int) (ret []byte, leftOverGas uint64, err error) {\n\tif evm.vmConfig.NoRecursion && evm.depth > 0 {\n\t\treturn nil, gas, nil\n\t}\n\n\t// Fail if we're trying to execute above the call depth limit\n\tif evm.depth > int(params.CallCreateDepth) {\n\t\treturn nil, gas, ErrDepth\n\t}\n\t// Fail if we're trying to transfer more than the available balance\n\tif !evm.Context.CanTransfer(evm.StateDB, caller.Address(), value) {\n\t\treturn nil, gas, ErrInsufficientBalance\n\t}\n\n\tvar (\n\t\tto       = AccountRef(addr)\n\t\tsnapshot = evm.StateDB.Snapshot()\n\t)\n\tif !evm.StateDB.Exist(addr) {\n\t\tprecompiles := PrecompiledContractsHomestead\n\t\tif evm.ChainConfig().IsByzantium(evm.BlockNumber) {\n\t\t\tprecompiles = PrecompiledContractsByzantium\n\t\t}\n\t\tif precompiles[addr] == nil && evm.ChainConfig().IsEIP158(evm.BlockNumber) && value.Sign() == 0 {\n\t\t\t// Calling a non existing account, don't do anything, but ping the tracer\n\t\t\tif evm.vmConfig.Debug && evm.depth == 0 {\n\t\t\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)\n\t\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, 0, 0, nil)\n\t\t\t}\n\t\t\treturn nil, gas, nil\n\t\t}\n\t\tevm.StateDB.CreateAccount(addr)\n\t}\n\tevm.Transfer(evm.StateDB, caller.Address(), to.Address(), value)\n\t// Initialise a new contract and set the code that is to be used by the EVM.\n\t// The contract is a scoped environment for this execution context only.\n\tcontract := NewContract(caller, to, value, gas)\n\tcontract.SetCallCode(&addr, evm.StateDB.GetCodeHash(addr), evm.StateDB.GetCode(addr))\n\n\t// Even if the account has no code, we need to continue because it might be a precompile\n\tstart := time.Now()\n\n\t// Capture the tracer start/end events in debug mode\n\tif evm.vmConfig.Debug && evm.depth == 0 {\n\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)\n\n\t\tdefer func() { // Lazy evaluation of the parameters\n\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, gas-contract.Gas, time.Since(start), err)\n\t\t}()\n\t}\n\tret, err = run(evm, contract, input, false)\n\n\t// When an error was returned by the EVM or when setting the creation code\n\t// above we revert to the snapshot and consume any gas remaining. Additionally\n\t// when we're in homestead this also counts for code storage gas errors.\n\tif err != nil {\n\t\tevm.StateDB.RevertToSnapshot(snapshot)\n\t\tif err != errExecutionReverted {\n\t\t\tcontract.UseGas(contract.Gas)\n\t\t}\n\t}\n\treturn ret, contract.Gas, err\n}\n```\n\n\n\n\n\n\n\n\n\n#### handleMsg\n\n\n\n- ```\n  StatusMsg\n  ```\n\n  \n\n- ```\n  GetBlockHeadersMsg\n  ```\n\n  \n\n  ```\n  BlockHeadersMsg\n  ```\n\n  \n\n- ```\n  GetBlockBodiesMsg\n  ```\n\n  \n\n  ```\n  BlockBodiesMsg\n  ```\n\n  \n\n- ```\n  GetNodeDataMsg\n  ```\n\n- ```\n  NodeDataMsg\n  ```\n\n- ```\n  GetReceiptsMsg\n  ```\n\n- ```\n  ReceiptsMsg\n  ```\n\n- ```\n  NewBlockHashesMsg\n  ```\n\n- ```\n  NewBlockMsg\n  ```\n\n- ```\n  TxMsg\n  ```\n\n\n\n#### Start\n\ngoroutine \n\n- txBroadcastLoop\n\n  ```\n  func (self *ProtocolManager) txBroadcastLoop() {\n      for {\n          select {\n          case event := <-self.txCh:\n              self.BroadcastTx(event.Tx.Hash(), event.Tx)\n\n          // Err() channel will be closed when unsubscribing.\n          case <-self.txSub.Err():\n              return\n          }\n      }\n  }\n  ```\n\n  core/tx_pool.go send self.txCh\n  self.BroadcastTx(event.Tx.Hash(), event.Tx)\n\n  ```\n  func (pm *ProtocolManager) BroadcastTx(hash common.Hash, tx *types.Transaction) {\n      // Broadcast transaction to a batch of peers not knowing about it\n      peers := pm.peers.PeersWithoutTx(hash)\n      //FIXME include this again: peers = peers[:int(math.Sqrt(float64(len(peers))))]\n      for _, peer := range peers {\n          peer.SendTransactions(types.Transactions{tx})\n      }\n      log.Trace(\"Broadcast transaction\", \"hash\", hash, \"recipients\", len(peers))\n  }\n\n  ```\n\n  hash\n\n- minedBroadcastLoop\n\n  miner.go NewMinedBlockEvent self.BroadcastBlock(ev.Block, true)\n\n  ```\n  // Mined broadcast loop\n  func (self *ProtocolManager) minedBroadcastLoop() {\n      // automatically stops if unsubscribe\n      for obj := range self.minedBlockSub.Chan() {\n          switch ev := obj.Data.(type) {\n          case core.NewMinedBlockEvent:\n              self.BroadcastBlock(ev.Block, true)  // First propagate block to peers\n              self.BroadcastBlock(ev.Block, false) // Only then announce to the rest\n          }\n      }\n  }\n\n  ```\n\n  ```\n  func (pm *ProtocolManager) BroadcastBlock(block *types.Block, propagate bool) {\n      hash := block.Hash()\n      peers := pm.peers.PeersWithoutBlock(hash)\n\n      // If propagation is requested, send to a subset of the peer\n      if propagate {\n          // Calculate the TD of the block (it's not imported yet, so block.Td is not valid)\n          var td *big.Int\n          if parent := pm.blockchain.GetBlock(block.ParentHash(), block.NumberU64()-1); parent != nil {\n              td = new(big.Int).Add(block.Difficulty(), pm.blockchain.GetTd(block.ParentHash(), block.NumberU64()-1))\n          } else {\n              log.Error(\"Propagating dangling block\", \"number\", block.Number(), \"hash\", hash)\n              return\n          }\n          // Send the block to a subset of our peers\n          transfer := peers[:int(math.Sqrt(float64(len(peers))))]\n          for _, peer := range transfer {\n              peer.SendNewBlock(block, td)\n          }\n          log.Trace(\"Propagated block\", \"hash\", hash, \"recipients\", len(transfer), \"duration\", common.PrettyDuration(time.Since(block.ReceivedAt)))\n          return\n      }\n      // Otherwise if the block is indeed in out own chain, announce it\n      if pm.blockchain.HasBlock(hash, block.NumberU64()) {\n          for _, peer := range peers {\n              peer.SendNewBlockHashes([]common.Hash{hash}, []uint64{block.NumberU64()})\n          }\n          log.Trace(\"Announced block\", \"hash\", hash, \"recipients\", len(peers), \"duration\", common.PrettyDuration(time.Since(block.ReceivedAt)))\n      }\n  }\n\n  ```\n\n  propagatetrue blockfalse hashnumber\n\n- syncer\n\n  ```\n  func (pm *ProtocolManager) syncer() {\n      // Start and ensure cleanup of sync mechanisms\n      pm.fetcher.Start()\n      defer pm.fetcher.Stop()\n      defer pm.downloader.Terminate()\n\n      // Wait for different events to fire synchronisation operations\n      forceSync := time.NewTicker(forceSyncCycle)\n      defer forceSync.Stop()\n\n      for {\n          select {\n          case <-pm.newPeerCh:\n              // Make sure we have peers to select from, then sync\n              if pm.peers.Len() < minDesiredPeerCount {\n                  break\n              }\n              go pm.synchronise(pm.peers.BestPeer())\n\n          case <-forceSync.C:\n              // Force a sync even if not enough peers are present\n              go pm.synchronise(pm.peers.BestPeer())\n\n          case <-pm.noMorePeers:\n              return\n          }\n      }\n  }\n\n\n  ```\n\n  pm.fetcher.Start() fetcher\n\n  P2P server ProtocolManager p2p.Protocol Runsend pm.newPeerChTD pm.synchronise(pm.peers.BestPeer()) goroutine\n\n  ```\n  // synchronise tries to sync up our local block chain with a remote peer.\n  func (pm *ProtocolManager) synchronise(peer *peer) {\n      // Short circuit if no peers are available\n      if peer == nil {\n          return\n      }\n      // Make sure the peer's TD is higher than our own\n      currentBlock := pm.blockchain.CurrentBlock()\n      td := pm.blockchain.GetTd(currentBlock.Hash(), currentBlock.NumberU64())\n\n      pHead, pTd := peer.Head()\n      if pTd.Cmp(td) <= 0 {\n          return\n      }\n      // Otherwise try to sync with the downloader\n      mode := downloader.FullSync\n      if atomic.LoadUint32(&pm.fastSync) == 1 {\n          // Fast sync was explicitly requested, and explicitly granted\n          mode = downloader.FastSync\n      } else if currentBlock.NumberU64() == 0 && pm.blockchain.CurrentFastBlock().NumberU64() > 0 {\n          // The database seems empty as the current block is the genesis. Yet the fast\n          // block is ahead, so fast sync was enabled for this node at a certain point.\n          // The only scenario where this can happen is if the user manually (or via a\n          // bad block) rolled back a fast sync node below the sync point. In this case\n          // however it's safe to reenable fast sync.\n          atomic.StoreUint32(&pm.fastSync, 1)\n          mode = downloader.FastSync\n      }\n      // Run the sync cycle, and disable fast sync if we've went past the pivot block\n      if err := pm.downloader.Synchronise(peer.id, pHead, pTd, mode); err != nil {\n          return\n      }\n      if atomic.LoadUint32(&pm.fastSync) == 1 {\n          log.Info(\"Fast sync complete, auto disabling\")\n          atomic.StoreUint32(&pm.fastSync, 0)\n      }\n      atomic.StoreUint32(&pm.acceptTxs, 1) // Mark initial sync done\n      if head := pm.blockchain.CurrentBlock(); head.NumberU64() > 0 {\n          // We've completed a sync cycle, notify all peers of new state. This path is\n          // essential in star-topology networks where a gateway node needs to notify\n          // all its out-of-date peers of the availability of a new block. This failure\n          // scenario will most often crop up in private and hackathon networks with\n          // degenerate connectivity, but it should be healthy for the mainnet too to\n          // more reliably update peers or the local TD state.\n          go pm.BroadcastBlock(head, false)\n      }\n  }\n\n\n  ```\n\n  TDTDpm.downloader.Synchronise(peer.id, pHead, pTd, mode)go pm.BroadcastBlock(head, false)\n\n- txsyncLoop\n\n  ```\n  func (pm *ProtocolManager) txsyncLoop() {\n      var (\n          pending = make(map[discover.NodeID]*txsync)\n          sending = false               // whether a send is active\n          pack    = new(txsync)         // the pack that is being sent\n          done    = make(chan error, 1) // result of the send\n      )\n\n      // send starts a sending a pack of transactions from the sync.\n      send := func(s *txsync) {\n          // Fill pack with transactions up to the target size.\n          size := common.StorageSize(0)\n          pack.p = s.p\n          pack.txs = pack.txs[:0]\n          for i := 0; i < len(s.txs) && size < txsyncPackSize; i++ {\n              pack.txs = append(pack.txs, s.txs[i])\n              size += s.txs[i].Size()\n          }\n          // Remove the transactions that will be sent.\n          s.txs = s.txs[:copy(s.txs, s.txs[len(pack.txs):])]\n          if len(s.txs) == 0 {\n              delete(pending, s.p.ID())\n          }\n          // Send the pack in the background.\n          s.p.Log().Trace(\"Sending batch of transactions\", \"count\", len(pack.txs), \"bytes\", size)\n          sending = true\n          go func() { done <- pack.p.SendTransactions(pack.txs) }()\n      }\n\n      // pick chooses the next pending sync.\n      pick := func() *txsync {\n          if len(pending) == 0 {\n              return nil\n          }\n          n := rand.Intn(len(pending)) + 1\n          for _, s := range pending {\n              if n--; n == 0 {\n                  return s\n              }\n          }\n          return nil\n      }\n\n      for {\n          select {\n          case s := <-pm.txsyncCh:\n              pending[s.p.ID()] = s\n              if !sending {\n                  send(s)\n              }\n          case err := <-done:\n              sending = false\n              // Stop tracking peers that cause send failures.\n              if err != nil {\n                  pack.p.Log().Debug(\"Transaction send failed\", \"err\", err)\n                  delete(pending, pack.p.ID())\n              }\n              // Schedule the next send.\n              if s := pick(); s != nil {\n                  send(s)\n              }\n          case <-pm.quitSync:\n              return\n          }\n      }\n  }\n\n  ```\n\n  \n\n\n\n#### fetch\n\nfetcherdownloaderfetcher\npm.handleMsg  NewBlockHashesMsg\n\n```\ncase msg.Code == NewBlockHashesMsg:\n        var announces newBlockHashesData\n        if err := msg.Decode(&announces); err != nil {\n            return errResp(ErrDecode, \"%v: %v\", msg, err)\n        }\n        // Mark the hashes as present at the remote node\n        for _, block := range announces {\n            p.MarkBlock(block.Hash)\n        }\n        // Schedule all the unknown hashes for retrieval\n        unknown := make(newBlockHashesData, 0, len(announces))\n        for _, block := range announces {\n            if !pm.blockchain.HasBlock(block.Hash, block.Number) {\n                unknown = append(unknown, block)\n            }\n        }\n        for _, block := range unknown {\n            pm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)\n        }\n\n\n```\n\nnewBlockHashesDatanewBlockHashesDatablockhashblocknumber\nnewBlockHashesDatapm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)blockhashblocknumberpeer.go\n\n```\nfunc (f *Fetcher) Notify(peer string, hash common.Hash, number uint64, time time.Time,\n    headerFetcher headerRequesterFn, bodyFetcher bodyRequesterFn) error {\n    block := &announce{\n        hash:        hash,\n        number:      number,\n        time:        time,\n        origin:      peer,\n        fetchHeader: headerFetcher,\n        fetchBodies: bodyFetcher,\n    }\n    select {\n    case f.notify <- block:\n        return nil\n    case <-f.quit:\n        return errTerminated\n    }\n}\n\n\n```\n\nNotify()announcesendf.notifyfetcherloop()f.notify receive notification, \n\n```\ncase notification := <-f.notify:\n            // A block was announced, make sure the peer isn't DOSing us\n            propAnnounceInMeter.Mark(1)\n\n            count := f.announces[notification.origin] + 1\n            if count > hashLimit {\n                log.Debug(\"Peer exceeded outstanding announces\", \"peer\", notification.origin, \"limit\", hashLimit)\n                propAnnounceDOSMeter.Mark(1)\n                break\n            }\n            // If we have a valid block number, check that it's potentially useful\n            if notification.number > 0 {\n                if dist := int64(notification.number) - int64(f.chainHeight()); dist < -maxUncleDist || dist > maxQueueDist {\n                    log.Debug(\"Peer discarded announcement\", \"peer\", notification.origin, \"number\", notification.number, \"hash\", notification.hash, \"distance\", dist)\n                    propAnnounceDropMeter.Mark(1)\n                    break\n                }\n            }\n            // All is well, schedule the announce if block's not yet downloading\n            if _, ok := f.fetching[notification.hash]; ok {\n                break\n            }\n            if _, ok := f.completing[notification.hash]; ok {\n                break\n            }\n            f.announces[notification.origin] = count\n            f.announced[notification.hash] = append(f.announced[notification.hash], notification)\n            if f.announceChangeHook != nil && len(f.announced[notification.hash]) == 1 {\n                f.announceChangeHook(notification.hash, true)\n            }\n            if len(f.announced) == 1 {\n                f.rescheduleFetch(fetchTimer)\n            }\n\n\n```\n\n1f.fetching f.completing notification.origin announces f.announced fetch\n2len(f.announced[notification.hash]) == 1 f.announcedf.announceChangeHook\n3len(f.announced) == 1 fetchTimer\n\n```\ncase <-fetchTimer.C:\n            // At least one block's timer ran out, check for needing retrieval\n            request := make(map[string][]common.Hash)\n\n            for hash, announces := range f.announced {\n                if time.Since(announces[0].time) > arriveTimeout-gatherSlack {\n                    // Pick a random peer to retrieve from, reset all others\n                    announce := announces[rand.Intn(len(announces))]\n                    f.forgetHash(hash)\n\n                    // If the block still didn't arrive, queue for fetching\n                    if f.getBlock(hash) == nil {\n                        request[announce.origin] = append(request[announce.origin], hash)\n                        f.fetching[hash] = announce\n                    }\n                }\n            }\n            // Send out all block header requests\n            for peer, hashes := range request {\n                log.Trace(\"Fetching scheduled headers\", \"peer\", peer, \"list\", hashes)\n\n                // Create a closure of the fetch and schedule in on a new thread\n                fetchHeader, hashes := f.fetching[hashes[0]].fetchHeader, hashes\n                go func() {\n                    if f.fetchingHook != nil {\n                        f.fetchingHook(hashes)\n                    }\n                    for _, hash := range hashes {\n                        headerFetchMeter.Mark(1)\n                        fetchHeader(hash) // Suboptimal, but protocol doesn't allow batch header retrievals\n                    }\n                }()\n            }\n            // Schedule the next fetch if blocks are still pending\n            f.rescheduleFetch(fetchTimer)\n\n\n```\n\n1f.announcedarriveTimeout-gatherSlackhashfetcher\nannouncesannounceblockhashhashannounce\nhashblockannouncerequestannouncef.fetching\n2requestrequestblockhashfetchHeader(hash)header\nfetchHeader(hash)pm.fetcher.Notifypeer.go\n\n3 NewBlockHashesMsg fetcherfetchTimer\n\nFetcher FilterHeaders()\nfetchHeader(hash)peer.go RequestOneHeader(hash common.Hash)  SendGetBlockHeadersMsg \npm.handleMsg  BlockHashesMsg\n\n```\ncase msg.Code == BlockHeadersMsg:\n        // A batch of headers arrived to one of our previous requests\n        var headers []*types.Header\n        if err := msg.Decode(&headers); err != nil {\n            return errResp(ErrDecode, \"msg %v: %v\", msg, err)\n        }\n        // If no headers were received, but we're expending a DAO fork check, maybe it's that\n        if len(headers) == 0 && p.forkDrop != nil {\n            // Possibly an empty reply to the fork header checks, sanity check TDs\n            verifyDAO := true\n\n            // If we already have a DAO header, we can check the peer's TD against it. If\n            // the peer's ahead of this, it too must have a reply to the DAO check\n            if daoHeader := pm.blockchain.GetHeaderByNumber(pm.chainconfig.DAOForkBlock.Uint64()); daoHeader != nil {\n                if _, td := p.Head(); td.Cmp(pm.blockchain.GetTd(daoHeader.Hash(), daoHeader.Number.Uint64())) >= 0 {\n                    verifyDAO = false\n                }\n            }\n            // If we're seemingly on the same chain, disable the drop timer\n            if verifyDAO {\n                p.Log().Debug(\"Seems to be on the same side of the DAO fork\")\n                p.forkDrop.Stop()\n                p.forkDrop = nil\n                return nil\n            }\n        }\n        // Filter out any explicitly requested headers, deliver the rest to the downloader\n        filter := len(headers) == 1\n        if filter {\n            // If it's a potential DAO fork check, validate against the rules\n            if p.forkDrop != nil && pm.chainconfig.DAOForkBlock.Cmp(headers[0].Number) == 0 {\n                // Disable the fork drop timer\n                p.forkDrop.Stop()\n                p.forkDrop = nil\n\n                // Validate the header and either drop the peer or continue\n                if err := misc.VerifyDAOHeaderExtraData(pm.chainconfig, headers[0]); err != nil {\n                    p.Log().Debug(\"Verified to be on the other side of the DAO fork, dropping\")\n                    return err\n                }\n                p.Log().Debug(\"Verified to be on the same side of the DAO fork\")\n                return nil\n            }\n            // Irrelevant of the fork checks, send the header to the fetcher just in case\n            headers = pm.fetcher.FilterHeaders(p.id, headers, time.Now())\n        }\n        if len(headers) > 0 || !filter {\n            err := pm.downloader.DeliverHeaders(p.id, headers)\n            if err != nil {\n                log.Debug(\"Failed to deliver headers\", \"err\", err)\n            }\n        }\n\n\n```\n\ndaoHeaderlen(headers) == 1pm.fetcher.FilterHeaders(p.id, headers, time.Now())\n\n```\nfunc (f *Fetcher) FilterHeaders(peer string, headers []*types.Header, time time.Time) []*types.Header {\n    log.Trace(\"Filtering headers\", \"peer\", peer, \"headers\", len(headers))\n\n    // Send the filter channel to the fetcher\n    filter := make(chan *headerFilterTask)\n\n    select {\n    case f.headerFilter <- filter:\n    case <-f.quit:\n        return nil\n    }\n    // Request the filtering of the header list\n    select {\n    case filter <- &headerFilterTask{peer: peer, headers: headers, time: time}:\n    case <-f.quit:\n        return nil\n    }\n    // Retrieve the headers remaining after filtering\n    select {\n    case task := <-filter:\n        return task.headers\n    case <-f.quit:\n        return nil\n    }\n}\n\n\n```\n\nsend filter f.headerFilterfetcherloop()f.headerFilter receive filter\n\n```\ncase filter := <-f.headerFilter:\n            // Headers arrived from a remote peer. Extract those that were explicitly\n            // requested by the fetcher, and return everything else so it's delivered\n            // to other parts of the system.\n            var task *headerFilterTask\n            select {\n            case task = <-filter:\n            case <-f.quit:\n                return\n            }\n            headerFilterInMeter.Mark(int64(len(task.headers)))\n\n            // Split the batch of headers into unknown ones (to return to the caller),\n            // known incomplete ones (requiring body retrievals) and completed blocks.\n            unknown, incomplete, complete := []*types.Header{}, []*announce{}, []*types.Block{}\n            for _, header := range task.headers {\n                hash := header.Hash()\n\n                // Filter fetcher-requested headers from other synchronisation algorithms\n                if announce := f.fetching[hash]; announce != nil && announce.origin == task.peer && f.fetched[hash] == nil && f.completing[hash] == nil && f.queued[hash] == nil {\n                    // If the delivered header does not match the promised number, drop the announcer\n                    if header.Number.Uint64() != announce.number {\n                        log.Trace(\"Invalid block number fetched\", \"peer\", announce.origin, \"hash\", header.Hash(), \"announced\", announce.number, \"provided\", header.Number)\n                        f.dropPeer(announce.origin)\n                        f.forgetHash(hash)\n                        continue\n                    }\n                    // Only keep if not imported by other means\n                    if f.getBlock(hash) == nil {\n                        announce.header = header\n                        announce.time = task.time\n\n                        // If the block is empty (header only), short circuit into the final import queue\n                        if header.TxHash == types.DeriveSha(types.Transactions{}) && header.UncleHash == types.CalcUncleHash([]*types.Header{}) {\n                            log.Trace(\"Block empty, skipping body retrieval\", \"peer\", announce.origin, \"number\", header.Number, \"hash\", header.Hash())\n\n                            block := types.NewBlockWithHeader(header)\n                            block.ReceivedAt = task.time\n\n                            complete = append(complete, block)\n                            f.completing[hash] = announce\n                            continue\n                        }\n                        // Otherwise add to the list of blocks needing completion\n                        incomplete = append(incomplete, announce)\n                    } else {\n                        log.Trace(\"Block already imported, discarding header\", \"peer\", announce.origin, \"number\", header.Number, \"hash\", header.Hash())\n                        f.forgetHash(hash)\n                    }\n                } else {\n                    // Fetcher doesn't know about it, add to the return list\n                    unknown = append(unknown, header)\n                }\n            }\n            headerFilterOutMeter.Mark(int64(len(unknown)))\n            select {\n            case filter <- &headerFilterTask{headers: unknown, time: task.time}:\n            case <-f.quit:\n                return\n            }\n            // Schedule the retrieved headers for body completion\n            for _, announce := range incomplete {\n                hash := announce.header.Hash()\n                if _, ok := f.completing[hash]; ok {\n                    continue\n                }\n                f.fetched[hash] = append(f.fetched[hash], announce)\n                if len(f.fetched) == 1 {\n                    f.rescheduleComplete(completeTimer)\n                }\n            }\n            // Schedule the header-only blocks for import\n            for _, block := range complete {\n                if announce := f.completing[block.Hash()]; announce != nil {\n                    f.enqueue(announce.origin, block)\n                }\n            }\n\n\n```\n\n1headerFilterheader f.fetchingf.fetched f.completingunknown filterFilterHeaderstask filterFilterHeaders\n2headernumberf.fetchingannouncenumberhash\n3hashblockhashblockhashcompletef.completingincomplete\n4incompletef.completingf.fetchedcompleteTimer\n5completef.completingf.enqueue(announce.origin, block)\n\n```\ncase <-completeTimer.C:\n            // At least one header's timer ran out, retrieve everything\n            request := make(map[string][]common.Hash)\n\n            for hash, announces := range f.fetched {\n                // Pick a random peer to retrieve from, reset all others\n                announce := announces[rand.Intn(len(announces))]\n                f.forgetHash(hash)\n\n                // If the block still didn't arrive, queue for completion\n                if f.getBlock(hash) == nil {\n                    request[announce.origin] = append(request[announce.origin], hash)\n                    f.completing[hash] = announce\n                }\n            }\n            // Send out all block body requests\n            for peer, hashes := range request {\n                log.Trace(\"Fetching scheduled bodies\", \"peer\", peer, \"list\", hashes)\n\n                // Create a closure of the fetch and schedule in on a new thread\n                if f.completingHook != nil {\n                    f.completingHook(hashes)\n                }\n                bodyFetchMeter.Mark(int64(len(hashes)))\n                go f.completing[hashes[0]].fetchBodies(hashes)\n            }\n            // Schedule the next fetch if blocks are still pending\n            f.rescheduleComplete(completeTimer)\n\n```\n\n1f.fetchedhashfetcher\nhashblockannouncerequestannouncef.completing\n2requestrequestblockhashfetchBodies(hashes)bodyfetchBodies(hashes)peer.go\n3 BlockHashesMsg fetchercompleteTimer\n\nFetcher FilterBodies() Enqueue(\n1fetchBodies(hash)peer.go RequestBodies(hashes []common.Hash) SendGetBlockBodiesMsg \n2pm.handleMsg  BlockBodiesMsg\n3 pm.fetcher.FilterBodies(p.id, trasactions, uncles, time.Now())\nFilterHeaders()\n4FilterBodies()timer\n5FilterHeaders()FilterBodies()f.enqueue(announce.origin, block)\n\n```\nfunc (f *Fetcher) enqueue(peer string, block *types.Block) {\n    hash := block.Hash()\n\n    // Ensure the peer isn't DOSing us\n    count := f.queues[peer] + 1\n    if count > blockLimit {\n        log.Debug(\"Discarded propagated block, exceeded allowance\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"limit\", blockLimit)\n        propBroadcastDOSMeter.Mark(1)\n        f.forgetHash(hash)\n        return\n    }\n    // Discard any past or too distant blocks\n    if dist := int64(block.NumberU64()) - int64(f.chainHeight()); dist < -maxUncleDist || dist > maxQueueDist {\n        log.Debug(\"Discarded propagated block, too far away\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"distance\", dist)\n        propBroadcastDropMeter.Mark(1)\n        f.forgetHash(hash)\n        return\n    }\n    // Schedule the block for future importing\n    if _, ok := f.queued[hash]; !ok {\n        op := &inject{\n            origin: peer,\n            block:  block,\n        }\n        f.queues[peer] = count\n        f.queued[hash] = op\n        f.queue.Push(op, -float32(block.NumberU64()))\n        if f.queueChangeHook != nil {\n            f.queueChangeHook(op.block.Hash(), true)\n        }\n        log.Debug(\"Queued propagated block\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"queued\", f.queue.Size())\n    }\n}\n\n```\n\nhashf.queue\nloopf.queueblock insertblock chain\n\n```\nfunc (f *Fetcher) insert(peer string, block *types.Block) {\n    hash := block.Hash()\n\n    // Run the import on a new thread\n    log.Debug(\"Importing propagated block\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash)\n    go func() {\n        defer func() { f.done <- hash }()\n\n        // If the parent's unknown, abort insertion\n        parent := f.getBlock(block.ParentHash())\n        if parent == nil {\n            log.Debug(\"Unknown parent of propagated block\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"parent\", block.ParentHash())\n            return\n        }\n        // Quickly validate the header and propagate the block if it passes\n        switch err := f.verifyHeader(block.Header()); err {\n        case nil:\n            // All ok, quickly propagate to our peers\n            propBroadcastOutTimer.UpdateSince(block.ReceivedAt)\n            go f.broadcastBlock(block, true)\n\n        case consensus.ErrFutureBlock:\n            // Weird future block, don't fail, but neither propagate\n\n        default:\n            // Something went very wrong, drop the peer\n            log.Debug(\"Propagated block verification failed\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"err\", err)\n            f.dropPeer(peer)\n            return\n        }\n        // Run the actual import and log any issues\n        if _, err := f.insertChain(types.Blocks{block}); err != nil {\n            log.Debug(\"Propagated block import failed\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"err\", err)\n            return\n        }\n        // If import succeeded, broadcast the block\n        propAnnounceOutTimer.UpdateSince(block.ReceivedAt)\n        go f.broadcastBlock(block, false)\n\n        // Invoke the testing hook if needed\n        if f.importedHook != nil {\n            f.importedHook(block)\n        }\n    }()\n}\n\n\n```\n\nf.verifyHeader(block.Header())blockHeader\n\nf.insertChain(types.Blocks{block}) \n()blockhash\n\n\nfetcher.go \n\n\n\n\n\n#### Downloader\n\nDownloader\nProtocolManagerDownloader\n\n```\nfunc New(mode SyncMode, stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn) *Downloader {\n    if lightchain == nil {\n        lightchain = chain\n    }\n\n    dl := &Downloader{\n        mode:           mode,\n        stateDB:        stateDb,\n        mux:            mux,\n        queue:          newQueue(),\n        peers:          newPeerSet(),\n        rttEstimate:    uint64(rttMaxEstimate),\n        rttConfidence:  uint64(1000000),\n        blockchain:     chain,\n        lightchain:     lightchain,\n        dropPeer:       dropPeer,\n        headerCh:       make(chan dataPack, 1),\n        bodyCh:         make(chan dataPack, 1),\n        receiptCh:      make(chan dataPack, 1),\n        bodyWakeCh:     make(chan bool, 1),\n        receiptWakeCh:  make(chan bool, 1),\n        headerProcCh:   make(chan []*types.Header, 1),\n        quitCh:         make(chan struct{}),\n        stateCh:        make(chan dataPack),\n        stateSyncStart: make(chan *stateSync),\n        trackStateReq:  make(chan *stateReq),\n    }\n    go dl.qosTuner()\n    go dl.stateFetcher()\n    return dl\n}\n\n```\n\nDownloaderdl.qosTuner() goroutinedl.stateFetcher() goroutine Downloader\n\nProtocolManagerP2PProtocolManager synchronise(peer *peer)DownloaderSynchronise(peer.id, pHead, pTd, mode)\n\nSynchronised.queued.peersd.bodyWakeCh, d.receiptWakeChd.headerCh, d.bodyCh, d.receiptChd.headerProcChd.syncWithPeer(p, hash, td)\n\n```\nfunc (d *Downloader) syncWithPeer(p *peerConnection, hash common.Hash, td *big.Int) (err error) {\n    d.mux.Post(StartEvent{})\n    defer func() {\n        // reset on error\n        if err != nil {\n            d.mux.Post(FailedEvent{err})\n        } else {\n            d.mux.Post(DoneEvent{})\n        }\n    }()\n    if p.version < 62 {\n        return errTooOld\n    }\n\n    log.Debug(\"Synchronising with the network\", \"peer\", p.id, \"eth\", p.version, \"head\", hash, \"td\", td, \"mode\", d.mode)\n    defer func(start time.Time) {\n        log.Debug(\"Synchronisation terminated\", \"elapsed\", time.Since(start))\n    }(time.Now())\n\n    // Look up the sync boundaries: the common ancestor and the target block\n    latest, err := d.fetchHeight(p)\n    if err != nil {\n        return err\n    }\n    height := latest.Number.Uint64()\n\n    origin, err := d.findAncestor(p, height)\n    if err != nil {\n        return err\n    }\n    d.syncStatsLock.Lock()\n    if d.syncStatsChainHeight <= origin || d.syncStatsChainOrigin > origin {\n        d.syncStatsChainOrigin = origin\n    }\n    d.syncStatsChainHeight = height\n    d.syncStatsLock.Unlock()\n\n    // Ensure our origin point is below any fast sync pivot point\n    pivot := uint64(0)\n    if d.mode == FastSync {\n        if height <= uint64(fsMinFullBlocks) {\n            origin = 0\n        } else {\n            pivot = height - uint64(fsMinFullBlocks)\n            if pivot <= origin {\n                origin = pivot - 1\n            }\n        }\n    }\n    d.committed = 1\n    if d.mode == FastSync && pivot != 0 {\n        d.committed = 0\n    }\n    // Initiate the sync using a concurrent header and content retrieval algorithm\n    d.queue.Prepare(origin+1, d.mode)\n    if d.syncInitHook != nil {\n        d.syncInitHook(origin, height)\n    }\n\n    fetchers := []func() error{\n        func() error { return d.fetchHeaders(p, origin+1, pivot) }, // Headers are always retrieved\n        func() error { return d.fetchBodies(origin + 1) },          // Bodies are retrieved during normal and fast sync\n        func() error { return d.fetchReceipts(origin + 1) },        // Receipts are retrieved during fast sync\n        func() error { return d.processHeaders(origin+1, pivot, td) },\n    }\n    if d.mode == FastSync {\n        fetchers = append(fetchers, func() error { return d.processFastSyncContent(latest) })\n    } else if d.mode == FullSync {\n        fetchers = append(fetchers, d.processFullSyncContent)\n    }\n    return d.spawnSync(fetchers)\n}\n\n```\n\nlatest, err := d.fetchHeight(p)peer,\n\n```\nfunc (d *Downloader) fetchHeight(p *peerConnection) (*types.Header, error) {\n    p.log.Debug(\"Retrieving remote chain height\")\n\n    // Request the advertised remote head block and wait for the response\n    head, _ := p.peer.Head()\n    go p.peer.RequestHeadersByHash(head, 1, 0, false)\n\n    ttl := d.requestTTL()\n    timeout := time.After(ttl)\n    for {\n        select {\n        case <-d.cancelCh:\n            return nil, errCancelBlockFetch\n\n        case packet := <-d.headerCh:\n            // Discard anything not from the origin peer\n            if packet.PeerId() != p.id {\n                log.Debug(\"Received headers from incorrect peer\", \"peer\", packet.PeerId())\n                break\n            }\n            // Make sure the peer actually gave something valid\n            headers := packet.(*headerPack).headers\n            if len(headers) != 1 {\n                p.log.Debug(\"Multiple headers for single request\", \"headers\", len(headers))\n                return nil, errBadPeer\n            }\n            head := headers[0]\n            p.log.Debug(\"Remote head header identified\", \"number\", head.Number, \"hash\", head.Hash())\n            return head, nil\n\n        case <-timeout:\n            p.log.Debug(\"Waiting for head header timed out\", \"elapsed\", ttl)\n            return nil, errTimeout\n\n        case <-d.bodyCh:\n        case <-d.receiptCh:\n            // Out of bounds delivery, ignore\n        }\n    }\n}\n\n\n```\n\n1peer.RequestHeadersByHash(head, 1, 0, false)GetBlockHeadersMsg\n2d.headerChtimeout\n3BlockHeadersMsg\n4downloader.DeliverHeaders(p.id, headers)\n5p.idheadersd.headerCh\n6selectd.headerChheader\n\nsyncWithPeer()  d.findAncestor(p, height)\n\n```\nfunc (d *Downloader) findAncestor(p *peerConnection, height uint64) (uint64, error) {\n    // Figure out the valid ancestor range to prevent rewrite attacks\n    floor, ceil := int64(-1), d.lightchain.CurrentHeader().Number.Uint64()\n\n    if d.mode == FullSync {\n        ceil = d.blockchain.CurrentBlock().NumberU64()\n    } else if d.mode == FastSync {\n        ceil = d.blockchain.CurrentFastBlock().NumberU64()\n    }\n    if ceil >= MaxForkAncestry {\n        floor = int64(ceil - MaxForkAncestry)\n    }\n    p.log.Debug(\"Looking for common ancestor\", \"local\", ceil, \"remote\", height)\n\n    // Request the topmost blocks to short circuit binary ancestor lookup\n    head := ceil\n    if head > height {\n        head = height\n    }\n    from := int64(head) - int64(MaxHeaderFetch)\n    if from < 0 {\n        from = 0\n    }\n    // Span out with 15 block gaps into the future to catch bad head reports\n    limit := 2 * MaxHeaderFetch / 16\n    count := 1 + int((int64(ceil)-from)/16)\n    if count > limit {\n        count = limit\n    }\n    go p.peer.RequestHeadersByNumber(uint64(from), count, 15, false)\n\n    // Wait for the remote response to the head fetch\n    number, hash := uint64(0), common.Hash{}\n\n    ttl := d.requestTTL()\n    timeout := time.After(ttl)\n\n    for finished := false; !finished; {\n        select {\n        case <-d.cancelCh:\n            return 0, errCancelHeaderFetch\n\n        case packet := <-d.headerCh:\n            // Discard anything not from the origin peer\n            if packet.PeerId() != p.id {\n                log.Debug(\"Received headers from incorrect peer\", \"peer\", packet.PeerId())\n                break\n            }\n            // Make sure the peer actually gave something valid\n            headers := packet.(*headerPack).headers\n            if len(headers) == 0 {\n                p.log.Warn(\"Empty head header set\")\n                return 0, errEmptyHeaderSet\n            }\n            // Make sure the peer's reply conforms to the request\n            for i := 0; i < len(headers); i++ {\n                if number := headers[i].Number.Int64(); number != from+int64(i)*16 {\n                    p.log.Warn(\"Head headers broke chain ordering\", \"index\", i, \"requested\", from+int64(i)*16, \"received\", number)\n                    return 0, errInvalidChain\n                }\n            }\n            // Check if a common ancestor was found\n            finished = true\n            for i := len(headers) - 1; i >= 0; i-- {\n                // Skip any headers that underflow/overflow our requested set\n                if headers[i].Number.Int64() < from || headers[i].Number.Uint64() > ceil {\n                    continue\n                }\n                // Otherwise check if we already know the header or not\n                if (d.mode == FullSync && d.blockchain.HasBlock(headers[i].Hash(), headers[i].Number.Uint64())) || (d.mode != FullSync && d.lightchain.HasHeader(headers[i].Hash(), headers[i].Number.Uint64())) {\n                    number, hash = headers[i].Number.Uint64(), headers[i].Hash()\n\n                    // If every header is known, even future ones, the peer straight out lied about its head\n                    if number > height && i == limit-1 {\n                        p.log.Warn(\"Lied about chain head\", \"reported\", height, \"found\", number)\n                        return 0, errStallingPeer\n                    }\n                    break\n                }\n            }\n\n        case <-timeout:\n            p.log.Debug(\"Waiting for head header timed out\", \"elapsed\", ttl)\n            return 0, errTimeout\n\n        case <-d.bodyCh:\n        case <-d.receiptCh:\n            // Out of bounds delivery, ignore\n        }\n    }\n    // If the head fetch already found an ancestor, return\n    if !common.EmptyHash(hash) {\n        if int64(number) <= floor {\n            p.log.Warn(\"Ancestor below allowance\", \"number\", number, \"hash\", hash, \"allowance\", floor)\n            return 0, errInvalidAncestor\n        }\n        p.log.Debug(\"Found common ancestor\", \"number\", number, \"hash\", hash)\n        return number, nil\n    }\n    // Ancestor not found, we need to binary search over our chain\n    start, end := uint64(0), head\n    if floor > 0 {\n        start = uint64(floor)\n    }\n    for start+1 < end {\n        // Split our chain interval in two, and request the hash to cross check\n        check := (start + end) / 2\n\n        ttl := d.requestTTL()\n        timeout := time.After(ttl)\n\n        go p.peer.RequestHeadersByNumber(check, 1, 0, false)\n\n        // Wait until a reply arrives to this request\n        for arrived := false; !arrived; {\n            select {\n            case <-d.cancelCh:\n                return 0, errCancelHeaderFetch\n\n            case packer := <-d.headerCh:\n                // Discard anything not from the origin peer\n                if packer.PeerId() != p.id {\n                    log.Debug(\"Received headers from incorrect peer\", \"peer\", packer.PeerId())\n                    break\n                }\n                // Make sure the peer actually gave something valid\n                headers := packer.(*headerPack).headers\n                if len(headers) != 1 {\n                    p.log.Debug(\"Multiple headers for single request\", \"headers\", len(headers))\n                    return 0, errBadPeer\n                }\n                arrived = true\n\n                // Modify the search interval based on the response\n                if (d.mode == FullSync && !d.blockchain.HasBlock(headers[0].Hash(), headers[0].Number.Uint64())) || (d.mode != FullSync && !d.lightchain.HasHeader(headers[0].Hash(), headers[0].Number.Uint64())) {\n                    end = check\n                    break\n                }\n                header := d.lightchain.GetHeaderByHash(headers[0].Hash()) // Independent of sync mode, header surely exists\n                if header.Number.Uint64() != check {\n                    p.log.Debug(\"Received non requested header\", \"number\", header.Number, \"hash\", header.Hash(), \"request\", check)\n                    return 0, errBadPeer\n                }\n                start = check\n\n            case <-timeout:\n                p.log.Debug(\"Waiting for search header timed out\", \"elapsed\", ttl)\n                return 0, errTimeout\n\n            case <-d.bodyCh:\n            case <-d.receiptCh:\n                // Out of bounds delivery, ignore\n            }\n        }\n    }\n    // Ensure valid ancestry and return\n    if int64(start) <= floor {\n        p.log.Warn(\"Ancestor below allowance\", \"number\", start, \"hash\", hash, \"allowance\", floor)\n        return 0, errInvalidAncestor\n    }\n    p.log.Debug(\"Found common ancestor\", \"number\", start, \"hash\", hash)\n    return start, nil\n}\n\n```\n\n1peer.RequestHeadersByNumber(uint64(from), count, 15, false)header count 15header19216selectd.headerCh\n2selectheadersheaderheadernumber\n3MaxForkAncestryheader0.\n\nsyncWithPeer()pivotd.spawnSync(fetchers)d.spawnSync(fetchers)\n\nDownloader\nfetchHeaders()fetchBodies() , fetchReceipts()\n\n```\nfunc (d *Downloader) fetchHeaders(p *peerConnection, from uint64, pivot uint64) error {\n    p.log.Debug(\"Directing header downloads\", \"origin\", from)\n    defer p.log.Debug(\"Header download terminated\")\n\n    // Create a timeout timer, and the associated header fetcher\n    skeleton := true            // Skeleton assembly phase or finishing up\n    request := time.Now()       // time of the last skeleton fetch request\n    timeout := time.NewTimer(0) // timer to dump a non-responsive active peer\n    <-timeout.C                 // timeout channel should be initially empty\n    defer timeout.Stop()\n\n    var ttl time.Duration\n    getHeaders := func(from uint64) {\n        request = time.Now()\n\n        ttl = d.requestTTL()\n        timeout.Reset(ttl)\n\n        if skeleton {\n            p.log.Trace(\"Fetching skeleton headers\", \"count\", MaxHeaderFetch, \"from\", from)\n            go p.peer.RequestHeadersByNumber(from+uint64(MaxHeaderFetch)-1, MaxSkeletonSize, MaxHeaderFetch-1, false)\n        } else {\n            p.log.Trace(\"Fetching full headers\", \"count\", MaxHeaderFetch, \"from\", from)\n            go p.peer.RequestHeadersByNumber(from, MaxHeaderFetch, 0, false)\n        }\n    }\n    // Start pulling the header chain skeleton until all is done\n    getHeaders(from)\n\n    for {\n        select {\n        case <-d.cancelCh:\n            return errCancelHeaderFetch\n\n        case packet := <-d.headerCh:\n            // Make sure the active peer is giving us the skeleton headers\n            if packet.PeerId() != p.id {\n                log.Debug(\"Received skeleton from incorrect peer\", \"peer\", packet.PeerId())\n                break\n            }\n            headerReqTimer.UpdateSince(request)\n            timeout.Stop()\n\n            // If the skeleton's finished, pull any remaining head headers directly from the origin\n            if packet.Items() == 0 && skeleton {\n                skeleton = false\n                getHeaders(from)\n                continue\n            }\n            // If no more headers are inbound, notify the content fetchers and return\n            if packet.Items() == 0 {\n                // Don't abort header fetches while the pivot is downloading\n                if atomic.LoadInt32(&d.committed) == 0 && pivot <= from {\n                    p.log.Debug(\"No headers, waiting for pivot commit\")\n                    select {\n                    case <-time.After(fsHeaderContCheck):\n                        getHeaders(from)\n                        continue\n                    case <-d.cancelCh:\n                        return errCancelHeaderFetch\n                    }\n                }\n                // Pivot done (or not in fast sync) and no more headers, terminate the process\n                p.log.Debug(\"No more headers available\")\n                select {\n                case d.headerProcCh <- nil:\n                    return nil\n                case <-d.cancelCh:\n                    return errCancelHeaderFetch\n                }\n            }\n            headers := packet.(*headerPack).headers\n\n            // If we received a skeleton batch, resolve internals concurrently\n            if skeleton {\n                filled, proced, err := d.fillHeaderSkeleton(from, headers)\n                if err != nil {\n                    p.log.Debug(\"Skeleton chain invalid\", \"err\", err)\n                    return errInvalidChain\n                }\n                headers = filled[proced:]\n                from += uint64(proced)\n            }\n            // Insert all the new headers and fetch the next batch\n            if len(headers) > 0 {\n                p.log.Trace(\"Scheduling new headers\", \"count\", len(headers), \"from\", from)\n                select {\n                case d.headerProcCh <- headers:\n                case <-d.cancelCh:\n                    return errCancelHeaderFetch\n                }\n                from += uint64(len(headers))\n            }\n            getHeaders(from)\n\n        case <-timeout.C:\n            if d.dropPeer == nil {\n                // The dropPeer method is nil when `--copydb` is used for a local copy.\n                // Timeouts can occur if e.g. compaction hits at the wrong time, and can be ignored\n                p.log.Warn(\"Downloader wants to drop peer, but peerdrop-function is not set\", \"peer\", p.id)\n                break\n            }\n            // Header retrieval timed out, consider the peer bad and drop\n            p.log.Debug(\"Header request timed out\", \"elapsed\", ttl)\n            headerTimeoutMeter.Mark(1)\n            d.dropPeer(p.id)\n\n            // Finish the sync gracefully instead of dumping the gathered data though\n            for _, ch := range []chan bool{d.bodyWakeCh, d.receiptWakeCh} {\n                select {\n                case ch <- false:\n                case <-d.cancelCh:\n                }\n            }\n            select {\n            case d.headerProcCh <- nil:\n            case <-d.cancelCh:\n            }\n            return errBadPeer\n        }\n    }\n}\n\n```\n\n1getHeaders()peer.RequestHeadersByNumber() headers\n2skeleton+192192128skeleton192\n3\n4skeletonfillHeaderSkeleton()skeleton header chain\n5fromgetHeaders()\n\n```\nfunc (d *Downloader) fillHeaderSkeleton(from uint64, skeleton []*types.Header) ([]*types.Header, int, error) {\n    log.Debug(\"Filling up skeleton\", \"from\", from)\n    d.queue.ScheduleSkeleton(from, skeleton)\n\n    var (\n        deliver = func(packet dataPack) (int, error) {\n            pack := packet.(*headerPack)\n            return d.queue.DeliverHeaders(pack.peerId, pack.headers, d.headerProcCh)\n        }\n        expire   = func() map[string]int { return d.queue.ExpireHeaders(d.requestTTL()) }\n        throttle = func() bool { return false }\n        reserve  = func(p *peerConnection, count int) (*fetchRequest, bool, error) {\n            return d.queue.ReserveHeaders(p, count), false, nil\n        }\n        fetch    = func(p *peerConnection, req *fetchRequest) error { return p.FetchHeaders(req.From, MaxHeaderFetch) }\n        capacity = func(p *peerConnection) int { return p.HeaderCapacity(d.requestRTT()) }\n        setIdle  = func(p *peerConnection, accepted int) { p.SetHeadersIdle(accepted) }\n    )\n    err := d.fetchParts(errCancelHeaderFetch, d.headerCh, deliver, d.queue.headerContCh, expire,\n        d.queue.PendingHeaders, d.queue.InFlightHeaders, throttle, reserve,\n        nil, fetch, d.queue.CancelHeaders, capacity, d.peers.HeaderIdlePeers, setIdle, \"headers\")\n\n    log.Debug(\"Skeleton fill terminated\", \"err\", err)\n\n    filled, proced := d.queue.RetrieveHeaders()\n    return filled, proced, err\n}\n\n\n```\n\na) skeletonheadersqueue.ScheduleSkeleton\nb) d.fetchParts()\nd.fetchParts()\n1headersd.queue.DeliverHeaders()\n2d.queue.PendingHeaderspendingheadersd.peers.HeaderIdlePeersidlepeers\n3d.queue.ReserveHeaderspendingheadersidlepeers\n4idlepeersp.FetchHeaders(req.From, MaxHeaderFetch)headers\nc) d.queue.RetrieveHeaders()filledheaders\n\nd.fetchBodies() , d.fetchReceipts() fetchHeaders()\n\nDownloader\nd.processHeaders(), d.processFastSyncContent(latest) , d.processFullSyncContent\n1d.processHeaders() \n\n```\nfunc (d *Downloader) processHeaders(origin uint64, pivot uint64, td *big.Int) error {\n    // Keep a count of uncertain headers to roll back\n    rollback := []*types.Header{}\n    defer func() {\n        if len(rollback) > 0 {\n            // Flatten the headers and roll them back\n            hashes := make([]common.Hash, len(rollback))\n            for i, header := range rollback {\n                hashes[i] = header.Hash()\n            }\n            lastHeader, lastFastBlock, lastBlock := d.lightchain.CurrentHeader().Number, common.Big0, common.Big0\n            if d.mode != LightSync {\n                lastFastBlock = d.blockchain.CurrentFastBlock().Number()\n                lastBlock = d.blockchain.CurrentBlock().Number()\n            }\n            d.lightchain.Rollback(hashes)\n            curFastBlock, curBlock := common.Big0, common.Big0\n            if d.mode != LightSync {\n                curFastBlock = d.blockchain.CurrentFastBlock().Number()\n                curBlock = d.blockchain.CurrentBlock().Number()\n            }\n            log.Warn(\"Rolled back headers\", \"count\", len(hashes),\n                \"header\", fmt.Sprintf(\"%d->%d\", lastHeader, d.lightchain.CurrentHeader().Number),\n                \"fast\", fmt.Sprintf(\"%d->%d\", lastFastBlock, curFastBlock),\n                \"block\", fmt.Sprintf(\"%d->%d\", lastBlock, curBlock))\n        }\n    }()\n\n    // Wait for batches of headers to process\n    gotHeaders := false\n\n    for {\n        select {\n        case <-d.cancelCh:\n            return errCancelHeaderProcessing\n\n        case headers := <-d.headerProcCh:\n            // Terminate header processing if we synced up\n            if len(headers) == 0 {\n                // Notify everyone that headers are fully processed\n                for _, ch := range []chan bool{d.bodyWakeCh, d.receiptWakeCh} {\n                    select {\n                    case ch <- false:\n                    case <-d.cancelCh:\n                    }\n                }\n                if d.mode != LightSync {\n                    head := d.blockchain.CurrentBlock()\n                    if !gotHeaders && td.Cmp(d.blockchain.GetTd(head.Hash(), head.NumberU64())) > 0 {\n                        return errStallingPeer\n                    }\n                }\n                if d.mode == FastSync || d.mode == LightSync {\n                    head := d.lightchain.CurrentHeader()\n                    if td.Cmp(d.lightchain.GetTd(head.Hash(), head.Number.Uint64())) > 0 {\n                        return errStallingPeer\n                    }\n                }\n                // Disable any rollback and return\n                rollback = nil\n                return nil\n            }\n            // Otherwise split the chunk of headers into batches and process them\n            gotHeaders = true\n\n            for len(headers) > 0 {\n                // Terminate if something failed in between processing chunks\n                select {\n                case <-d.cancelCh:\n                    return errCancelHeaderProcessing\n                default:\n                }\n                // Select the next chunk of headers to import\n                limit := maxHeadersProcess\n                if limit > len(headers) {\n                    limit = len(headers)\n                }\n                chunk := headers[:limit]\n\n                // In case of header only syncing, validate the chunk immediately\n                if d.mode == FastSync || d.mode == LightSync {\n                    // Collect the yet unknown headers to mark them as uncertain\n                    unknown := make([]*types.Header, 0, len(headers))\n                    for _, header := range chunk {\n                        if !d.lightchain.HasHeader(header.Hash(), header.Number.Uint64()) {\n                            unknown = append(unknown, header)\n                        }\n                    }\n                    // If we're importing pure headers, verify based on their recentness\n                    frequency := fsHeaderCheckFrequency\n                    if chunk[len(chunk)-1].Number.Uint64()+uint64(fsHeaderForceVerify) > pivot {\n                        frequency = 1\n                    }\n                    if n, err := d.lightchain.InsertHeaderChain(chunk, frequency); err != nil {\n                        // If some headers were inserted, add them too to the rollback list\n                        if n > 0 {\n                            rollback = append(rollback, chunk[:n]...)\n                        }\n                        log.Debug(\"Invalid header encountered\", \"number\", chunk[n].Number, \"hash\", chunk[n].Hash(), \"err\", err)\n                        return errInvalidChain\n                    }\n                    // All verifications passed, store newly found uncertain headers\n                    rollback = append(rollback, unknown...)\n                    if len(rollback) > fsHeaderSafetyNet {\n                        rollback = append(rollback[:0], rollback[len(rollback)-fsHeaderSafetyNet:]...)\n                    }\n                }\n                // Unless we're doing light chains, schedule the headers for associated content retrieval\n                if d.mode == FullSync || d.mode == FastSync {\n                    // If we've reached the allowed number of pending headers, stall a bit\n                    for d.queue.PendingBlocks() >= maxQueuedHeaders || d.queue.PendingReceipts() >= maxQueuedHeaders {\n                        select {\n                        case <-d.cancelCh:\n                            return errCancelHeaderProcessing\n                        case <-time.After(time.Second):\n                        }\n                    }\n                    // Otherwise insert the headers for content retrieval\n                    inserts := d.queue.Schedule(chunk, origin)\n                    if len(inserts) != len(chunk) {\n                        log.Debug(\"Stale headers\")\n                        return errBadPeer\n                    }\n                }\n                headers = headers[limit:]\n                origin += uint64(limit)\n            }\n            // Signal the content downloaders of the availablility of new tasks\n            for _, ch := range []chan bool{d.bodyWakeCh, d.receiptWakeCh} {\n                select {\n                case ch <- true:\n                default:\n                }\n            }\n        }\n    }\n}\n\n```\n\n1fetchHeaders() d.headerProcChheaders\n2FastSyncLightSynclightchain.InsertHeaderChain(chunk, frequency)headerChain\n3FullSyncFastSynd.queue.Schedule(chunk, origin)downloader.queue\n\n2processFastSyncContent() \n\n```\nfunc (d *Downloader) processFastSyncContent(latest *types.Header) error {\n    // Start syncing state of the reported head block. This should get us most of\n    // the state of the pivot block.\n    stateSync := d.syncState(latest.Root)\n    defer stateSync.Cancel()\n    go func() {\n        if err := stateSync.Wait(); err != nil && err != errCancelStateFetch {\n            d.queue.Close() // wake up WaitResults\n        }\n    }()\n    // Figure out the ideal pivot block. Note, that this goalpost may move if the\n    // sync takes long enough for the chain head to move significantly.\n    pivot := uint64(0)\n    if height := latest.Number.Uint64(); height > uint64(fsMinFullBlocks) {\n        pivot = height - uint64(fsMinFullBlocks)\n    }\n    // To cater for moving pivot points, track the pivot block and subsequently\n    // accumulated download results separatey.\n    var (\n        oldPivot *fetchResult   // Locked in pivot block, might change eventually\n        oldTail  []*fetchResult // Downloaded content after the pivot\n    )\n    for {\n        // Wait for the next batch of downloaded data to be available, and if the pivot\n        // block became stale, move the goalpost\n        results := d.queue.Results(oldPivot == nil) // Block if we're not monitoring pivot staleness\n        if len(results) == 0 {\n            // If pivot sync is done, stop\n            if oldPivot == nil {\n                return stateSync.Cancel()\n            }\n            // If sync failed, stop\n            select {\n            case <-d.cancelCh:\n                return stateSync.Cancel()\n            default:\n            }\n        }\n        if d.chainInsertHook != nil {\n            d.chainInsertHook(results)\n        }\n        if oldPivot != nil {\n            results = append(append([]*fetchResult{oldPivot}, oldTail...), results...)\n        }\n        // Split around the pivot block and process the two sides via fast/full sync\n        if atomic.LoadInt32(&d.committed) == 0 {\n            latest = results[len(results)-1].Header\n            if height := latest.Number.Uint64(); height > pivot+2*uint64(fsMinFullBlocks) {\n                log.Warn(\"Pivot became stale, moving\", \"old\", pivot, \"new\", height-uint64(fsMinFullBlocks))\n                pivot = height - uint64(fsMinFullBlocks)\n            }\n        }\n        P, beforeP, afterP := splitAroundPivot(pivot, results)\n        if err := d.commitFastSyncData(beforeP, stateSync); err != nil {\n            return err\n        }\n        if P != nil {\n            // If new pivot block found, cancel old state retrieval and restart\n            if oldPivot != P {\n                stateSync.Cancel()\n\n                stateSync = d.syncState(P.Header.Root)\n                defer stateSync.Cancel()\n                go func() {\n                    if err := stateSync.Wait(); err != nil && err != errCancelStateFetch {\n                        d.queue.Close() // wake up WaitResults\n                    }\n                }()\n                oldPivot = P\n            }\n            // Wait for completion, occasionally checking for pivot staleness\n            select {\n            case <-stateSync.done:\n                if stateSync.err != nil {\n                    return stateSync.err\n                }\n                if err := d.commitPivotBlock(P); err != nil {\n                    return err\n                }\n                oldPivot = nil\n\n            case <-time.After(time.Second):\n                oldTail = afterP\n                continue\n            }\n        }\n        // Fast sync done, pivot commit done, full import\n        if err := d.importBlockResults(afterP); err != nil {\n            return err\n        }\n    }\n}\n\n```\n\n1pivot\n2d.queue resultresult\n3resultspivot\n4pivotresultspivotresultpivotresultspivotresults\n5commitFastSyncDatapivotresults \n6pivotresult commitPivotBlockFastSyncCommitHeadpivothash\n7d.importBlockResultspivotresults\n\n3processFullSyncContent()\n\n```\nfunc (d *Downloader) processFullSyncContent() error {\n    for {\n        results := d.queue.Results(true)\n        if len(results) == 0 {\n            return nil\n        }\n        if d.chainInsertHook != nil {\n            d.chainInsertHook(results)\n        }\n        if err := d.importBlockResults(results); err != nil {\n            return err\n        }\n    }\n}\n\nfunc (d *Downloader) importBlockResults(results []*fetchResult) error {\n    // Check for any early termination requests\n    if len(results) == 0 {\n        return nil\n    }\n    select {\n    case <-d.quitCh:\n        return errCancelContentProcessing\n    default:\n    }\n    // Retrieve the a batch of results to import\n    first, last := results[0].Header, results[len(results)-1].Header\n    log.Debug(\"Inserting downloaded chain\", \"items\", len(results),\n        \"firstnum\", first.Number, \"firsthash\", first.Hash(),\n        \"lastnum\", last.Number, \"lasthash\", last.Hash(),\n    )\n    blocks := make([]*types.Block, len(results))\n    for i, result := range results {\n        blocks[i] = types.NewBlockWithHeader(result.Header).WithBody(result.Transactions, result.Uncles)\n    }\n    if index, err := d.blockchain.InsertChain(blocks); err != nil {\n        log.Debug(\"Downloaded item processing failed\", \"number\", results[index].Header.Number, \"hash\", results[index].Header.Hash(), \"err\", err)\n        return errInvalidChain\n    }\n    return nil\n}\n\n```\n\nprocessFullSyncContentresults\n\n\nDownloaderlightlightfastfullpivotfastfastfast[](https://github.com/ethereum/go-ethereum/pull/1889)\n","source":"_posts/eth-code-tx-event.md","raw":"---\ntitle: eth_code_tx_event\ncategories:\n  - eth\ndate: 2019-10-14 14:47:58\ntags:\n---\n\n#### ApplyTransaction\n\n```\n// ApplyTransaction attempts to apply a transaction to the given state database\n// and uses the input parameters for its environment. It returns the receipt\n// for the transaction, gas used and an error if the transaction failed,\n// indicating the block was invalid.\n//state database\nfunc ApplyTransaction(config *params.ChainConfig, bc ChainContext, author *common.Address, gp *GasPool, statedb *state.StateDB, header *types.Header, tx *types.Transaction, usedGas *uint64, cfg vm.Config) (*types.Receipt, uint64, error) {\n\t//\n\tmsg, err := tx.AsMessage(types.MakeSigner(config, header.Number))\n\tif err != nil {\n\t\treturn nil, 0, err\n\t}\n\n\t//EVMgaserrlogsevm\n\t// Create a new context to be used in the EVM environment\n\tcontext := NewEVMContext(msg, header, bc, author)\n\t// Create a new environment which holds all relevant information\n\t// about the transaction and calling mechanisms.\n\tvmenv := vm.NewEVM(context, statedb, config, cfg)\n\t// Apply the transaction to the current state (included in the env)\n\t_, gas, failed, err := ApplyMessage(vmenv, msg, gp)\n\tif err != nil {\n\t\treturn nil, 0, err\n\t}\n\n\n\t//\n\t// Update the state with pending changes\n\tvar root []byte\n\tif config.IsByzantium(header.Number) {\n\t\tstatedb.Finalise(true)\n\t} else {\n\t\troot = statedb.IntermediateRoot(config.IsEIP158(header.Number)).Bytes()\n\t}\n\t*usedGas += gas\n\n\t// Create a new receipt for the transaction, storing the intermediate root and gas used by the tx\n\t// based on the eip phase, we're passing whether the root touch-delete accounts.\n\treceipt := types.NewReceipt(root, failed, *usedGas)\n\treceipt.TxHash = tx.Hash()\n\treceipt.GasUsed = gas\n\t// if the transaction created a contract, store the creation address in the receipt.\n\tif msg.To() == nil {\n\t\treceipt.ContractAddress = crypto.CreateAddress(vmenv.Context.Origin, tx.Nonce())\n\t}\n\t// Set the receipt logs and create a bloom for filtering\n\treceipt.Logs = statedb.GetLogs(tx.Hash())\n\treceipt.Bloom = types.CreateBloom(types.Receipts{receipt})\n\n\treturn receipt, gas, err\n}\n\n```\n\n\n\n```\nfunc (evm *EVM) Call(caller ContractRef, addr common.Address, input []byte, gas uint64, value *big.Int) (ret []byte, leftOverGas uint64, err error) {\n\tif evm.vmConfig.NoRecursion && evm.depth > 0 {\n\t\treturn nil, gas, nil\n\t}\n\n\t// Fail if we're trying to execute above the call depth limit\n\tif evm.depth > int(params.CallCreateDepth) {\n\t\treturn nil, gas, ErrDepth\n\t}\n\t// Fail if we're trying to transfer more than the available balance\n\tif !evm.Context.CanTransfer(evm.StateDB, caller.Address(), value) {\n\t\treturn nil, gas, ErrInsufficientBalance\n\t}\n\n\tvar (\n\t\tto       = AccountRef(addr)\n\t\tsnapshot = evm.StateDB.Snapshot()\n\t)\n\tif !evm.StateDB.Exist(addr) {\n\t\tprecompiles := PrecompiledContractsHomestead\n\t\tif evm.ChainConfig().IsByzantium(evm.BlockNumber) {\n\t\t\tprecompiles = PrecompiledContractsByzantium\n\t\t}\n\t\tif precompiles[addr] == nil && evm.ChainConfig().IsEIP158(evm.BlockNumber) && value.Sign() == 0 {\n\t\t\t// Calling a non existing account, don't do anything, but ping the tracer\n\t\t\tif evm.vmConfig.Debug && evm.depth == 0 {\n\t\t\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)\n\t\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, 0, 0, nil)\n\t\t\t}\n\t\t\treturn nil, gas, nil\n\t\t}\n\t\tevm.StateDB.CreateAccount(addr)\n\t}\n\tevm.Transfer(evm.StateDB, caller.Address(), to.Address(), value)\n\t// Initialise a new contract and set the code that is to be used by the EVM.\n\t// The contract is a scoped environment for this execution context only.\n\tcontract := NewContract(caller, to, value, gas)\n\tcontract.SetCallCode(&addr, evm.StateDB.GetCodeHash(addr), evm.StateDB.GetCode(addr))\n\n\t// Even if the account has no code, we need to continue because it might be a precompile\n\tstart := time.Now()\n\n\t// Capture the tracer start/end events in debug mode\n\tif evm.vmConfig.Debug && evm.depth == 0 {\n\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)\n\n\t\tdefer func() { // Lazy evaluation of the parameters\n\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, gas-contract.Gas, time.Since(start), err)\n\t\t}()\n\t}\n\tret, err = run(evm, contract, input, false)\n\n\t// When an error was returned by the EVM or when setting the creation code\n\t// above we revert to the snapshot and consume any gas remaining. Additionally\n\t// when we're in homestead this also counts for code storage gas errors.\n\tif err != nil {\n\t\tevm.StateDB.RevertToSnapshot(snapshot)\n\t\tif err != errExecutionReverted {\n\t\t\tcontract.UseGas(contract.Gas)\n\t\t}\n\t}\n\treturn ret, contract.Gas, err\n}\n```\n\n\n\n\n\n\n\n\n\n#### handleMsg\n\n\n\n- ```\n  StatusMsg\n  ```\n\n  \n\n- ```\n  GetBlockHeadersMsg\n  ```\n\n  \n\n  ```\n  BlockHeadersMsg\n  ```\n\n  \n\n- ```\n  GetBlockBodiesMsg\n  ```\n\n  \n\n  ```\n  BlockBodiesMsg\n  ```\n\n  \n\n- ```\n  GetNodeDataMsg\n  ```\n\n- ```\n  NodeDataMsg\n  ```\n\n- ```\n  GetReceiptsMsg\n  ```\n\n- ```\n  ReceiptsMsg\n  ```\n\n- ```\n  NewBlockHashesMsg\n  ```\n\n- ```\n  NewBlockMsg\n  ```\n\n- ```\n  TxMsg\n  ```\n\n\n\n#### Start\n\ngoroutine \n\n- txBroadcastLoop\n\n  ```\n  func (self *ProtocolManager) txBroadcastLoop() {\n      for {\n          select {\n          case event := <-self.txCh:\n              self.BroadcastTx(event.Tx.Hash(), event.Tx)\n\n          // Err() channel will be closed when unsubscribing.\n          case <-self.txSub.Err():\n              return\n          }\n      }\n  }\n  ```\n\n  core/tx_pool.go send self.txCh\n  self.BroadcastTx(event.Tx.Hash(), event.Tx)\n\n  ```\n  func (pm *ProtocolManager) BroadcastTx(hash common.Hash, tx *types.Transaction) {\n      // Broadcast transaction to a batch of peers not knowing about it\n      peers := pm.peers.PeersWithoutTx(hash)\n      //FIXME include this again: peers = peers[:int(math.Sqrt(float64(len(peers))))]\n      for _, peer := range peers {\n          peer.SendTransactions(types.Transactions{tx})\n      }\n      log.Trace(\"Broadcast transaction\", \"hash\", hash, \"recipients\", len(peers))\n  }\n\n  ```\n\n  hash\n\n- minedBroadcastLoop\n\n  miner.go NewMinedBlockEvent self.BroadcastBlock(ev.Block, true)\n\n  ```\n  // Mined broadcast loop\n  func (self *ProtocolManager) minedBroadcastLoop() {\n      // automatically stops if unsubscribe\n      for obj := range self.minedBlockSub.Chan() {\n          switch ev := obj.Data.(type) {\n          case core.NewMinedBlockEvent:\n              self.BroadcastBlock(ev.Block, true)  // First propagate block to peers\n              self.BroadcastBlock(ev.Block, false) // Only then announce to the rest\n          }\n      }\n  }\n\n  ```\n\n  ```\n  func (pm *ProtocolManager) BroadcastBlock(block *types.Block, propagate bool) {\n      hash := block.Hash()\n      peers := pm.peers.PeersWithoutBlock(hash)\n\n      // If propagation is requested, send to a subset of the peer\n      if propagate {\n          // Calculate the TD of the block (it's not imported yet, so block.Td is not valid)\n          var td *big.Int\n          if parent := pm.blockchain.GetBlock(block.ParentHash(), block.NumberU64()-1); parent != nil {\n              td = new(big.Int).Add(block.Difficulty(), pm.blockchain.GetTd(block.ParentHash(), block.NumberU64()-1))\n          } else {\n              log.Error(\"Propagating dangling block\", \"number\", block.Number(), \"hash\", hash)\n              return\n          }\n          // Send the block to a subset of our peers\n          transfer := peers[:int(math.Sqrt(float64(len(peers))))]\n          for _, peer := range transfer {\n              peer.SendNewBlock(block, td)\n          }\n          log.Trace(\"Propagated block\", \"hash\", hash, \"recipients\", len(transfer), \"duration\", common.PrettyDuration(time.Since(block.ReceivedAt)))\n          return\n      }\n      // Otherwise if the block is indeed in out own chain, announce it\n      if pm.blockchain.HasBlock(hash, block.NumberU64()) {\n          for _, peer := range peers {\n              peer.SendNewBlockHashes([]common.Hash{hash}, []uint64{block.NumberU64()})\n          }\n          log.Trace(\"Announced block\", \"hash\", hash, \"recipients\", len(peers), \"duration\", common.PrettyDuration(time.Since(block.ReceivedAt)))\n      }\n  }\n\n  ```\n\n  propagatetrue blockfalse hashnumber\n\n- syncer\n\n  ```\n  func (pm *ProtocolManager) syncer() {\n      // Start and ensure cleanup of sync mechanisms\n      pm.fetcher.Start()\n      defer pm.fetcher.Stop()\n      defer pm.downloader.Terminate()\n\n      // Wait for different events to fire synchronisation operations\n      forceSync := time.NewTicker(forceSyncCycle)\n      defer forceSync.Stop()\n\n      for {\n          select {\n          case <-pm.newPeerCh:\n              // Make sure we have peers to select from, then sync\n              if pm.peers.Len() < minDesiredPeerCount {\n                  break\n              }\n              go pm.synchronise(pm.peers.BestPeer())\n\n          case <-forceSync.C:\n              // Force a sync even if not enough peers are present\n              go pm.synchronise(pm.peers.BestPeer())\n\n          case <-pm.noMorePeers:\n              return\n          }\n      }\n  }\n\n\n  ```\n\n  pm.fetcher.Start() fetcher\n\n  P2P server ProtocolManager p2p.Protocol Runsend pm.newPeerChTD pm.synchronise(pm.peers.BestPeer()) goroutine\n\n  ```\n  // synchronise tries to sync up our local block chain with a remote peer.\n  func (pm *ProtocolManager) synchronise(peer *peer) {\n      // Short circuit if no peers are available\n      if peer == nil {\n          return\n      }\n      // Make sure the peer's TD is higher than our own\n      currentBlock := pm.blockchain.CurrentBlock()\n      td := pm.blockchain.GetTd(currentBlock.Hash(), currentBlock.NumberU64())\n\n      pHead, pTd := peer.Head()\n      if pTd.Cmp(td) <= 0 {\n          return\n      }\n      // Otherwise try to sync with the downloader\n      mode := downloader.FullSync\n      if atomic.LoadUint32(&pm.fastSync) == 1 {\n          // Fast sync was explicitly requested, and explicitly granted\n          mode = downloader.FastSync\n      } else if currentBlock.NumberU64() == 0 && pm.blockchain.CurrentFastBlock().NumberU64() > 0 {\n          // The database seems empty as the current block is the genesis. Yet the fast\n          // block is ahead, so fast sync was enabled for this node at a certain point.\n          // The only scenario where this can happen is if the user manually (or via a\n          // bad block) rolled back a fast sync node below the sync point. In this case\n          // however it's safe to reenable fast sync.\n          atomic.StoreUint32(&pm.fastSync, 1)\n          mode = downloader.FastSync\n      }\n      // Run the sync cycle, and disable fast sync if we've went past the pivot block\n      if err := pm.downloader.Synchronise(peer.id, pHead, pTd, mode); err != nil {\n          return\n      }\n      if atomic.LoadUint32(&pm.fastSync) == 1 {\n          log.Info(\"Fast sync complete, auto disabling\")\n          atomic.StoreUint32(&pm.fastSync, 0)\n      }\n      atomic.StoreUint32(&pm.acceptTxs, 1) // Mark initial sync done\n      if head := pm.blockchain.CurrentBlock(); head.NumberU64() > 0 {\n          // We've completed a sync cycle, notify all peers of new state. This path is\n          // essential in star-topology networks where a gateway node needs to notify\n          // all its out-of-date peers of the availability of a new block. This failure\n          // scenario will most often crop up in private and hackathon networks with\n          // degenerate connectivity, but it should be healthy for the mainnet too to\n          // more reliably update peers or the local TD state.\n          go pm.BroadcastBlock(head, false)\n      }\n  }\n\n\n  ```\n\n  TDTDpm.downloader.Synchronise(peer.id, pHead, pTd, mode)go pm.BroadcastBlock(head, false)\n\n- txsyncLoop\n\n  ```\n  func (pm *ProtocolManager) txsyncLoop() {\n      var (\n          pending = make(map[discover.NodeID]*txsync)\n          sending = false               // whether a send is active\n          pack    = new(txsync)         // the pack that is being sent\n          done    = make(chan error, 1) // result of the send\n      )\n\n      // send starts a sending a pack of transactions from the sync.\n      send := func(s *txsync) {\n          // Fill pack with transactions up to the target size.\n          size := common.StorageSize(0)\n          pack.p = s.p\n          pack.txs = pack.txs[:0]\n          for i := 0; i < len(s.txs) && size < txsyncPackSize; i++ {\n              pack.txs = append(pack.txs, s.txs[i])\n              size += s.txs[i].Size()\n          }\n          // Remove the transactions that will be sent.\n          s.txs = s.txs[:copy(s.txs, s.txs[len(pack.txs):])]\n          if len(s.txs) == 0 {\n              delete(pending, s.p.ID())\n          }\n          // Send the pack in the background.\n          s.p.Log().Trace(\"Sending batch of transactions\", \"count\", len(pack.txs), \"bytes\", size)\n          sending = true\n          go func() { done <- pack.p.SendTransactions(pack.txs) }()\n      }\n\n      // pick chooses the next pending sync.\n      pick := func() *txsync {\n          if len(pending) == 0 {\n              return nil\n          }\n          n := rand.Intn(len(pending)) + 1\n          for _, s := range pending {\n              if n--; n == 0 {\n                  return s\n              }\n          }\n          return nil\n      }\n\n      for {\n          select {\n          case s := <-pm.txsyncCh:\n              pending[s.p.ID()] = s\n              if !sending {\n                  send(s)\n              }\n          case err := <-done:\n              sending = false\n              // Stop tracking peers that cause send failures.\n              if err != nil {\n                  pack.p.Log().Debug(\"Transaction send failed\", \"err\", err)\n                  delete(pending, pack.p.ID())\n              }\n              // Schedule the next send.\n              if s := pick(); s != nil {\n                  send(s)\n              }\n          case <-pm.quitSync:\n              return\n          }\n      }\n  }\n\n  ```\n\n  \n\n\n\n#### fetch\n\nfetcherdownloaderfetcher\npm.handleMsg  NewBlockHashesMsg\n\n```\ncase msg.Code == NewBlockHashesMsg:\n        var announces newBlockHashesData\n        if err := msg.Decode(&announces); err != nil {\n            return errResp(ErrDecode, \"%v: %v\", msg, err)\n        }\n        // Mark the hashes as present at the remote node\n        for _, block := range announces {\n            p.MarkBlock(block.Hash)\n        }\n        // Schedule all the unknown hashes for retrieval\n        unknown := make(newBlockHashesData, 0, len(announces))\n        for _, block := range announces {\n            if !pm.blockchain.HasBlock(block.Hash, block.Number) {\n                unknown = append(unknown, block)\n            }\n        }\n        for _, block := range unknown {\n            pm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)\n        }\n\n\n```\n\nnewBlockHashesDatanewBlockHashesDatablockhashblocknumber\nnewBlockHashesDatapm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)blockhashblocknumberpeer.go\n\n```\nfunc (f *Fetcher) Notify(peer string, hash common.Hash, number uint64, time time.Time,\n    headerFetcher headerRequesterFn, bodyFetcher bodyRequesterFn) error {\n    block := &announce{\n        hash:        hash,\n        number:      number,\n        time:        time,\n        origin:      peer,\n        fetchHeader: headerFetcher,\n        fetchBodies: bodyFetcher,\n    }\n    select {\n    case f.notify <- block:\n        return nil\n    case <-f.quit:\n        return errTerminated\n    }\n}\n\n\n```\n\nNotify()announcesendf.notifyfetcherloop()f.notify receive notification, \n\n```\ncase notification := <-f.notify:\n            // A block was announced, make sure the peer isn't DOSing us\n            propAnnounceInMeter.Mark(1)\n\n            count := f.announces[notification.origin] + 1\n            if count > hashLimit {\n                log.Debug(\"Peer exceeded outstanding announces\", \"peer\", notification.origin, \"limit\", hashLimit)\n                propAnnounceDOSMeter.Mark(1)\n                break\n            }\n            // If we have a valid block number, check that it's potentially useful\n            if notification.number > 0 {\n                if dist := int64(notification.number) - int64(f.chainHeight()); dist < -maxUncleDist || dist > maxQueueDist {\n                    log.Debug(\"Peer discarded announcement\", \"peer\", notification.origin, \"number\", notification.number, \"hash\", notification.hash, \"distance\", dist)\n                    propAnnounceDropMeter.Mark(1)\n                    break\n                }\n            }\n            // All is well, schedule the announce if block's not yet downloading\n            if _, ok := f.fetching[notification.hash]; ok {\n                break\n            }\n            if _, ok := f.completing[notification.hash]; ok {\n                break\n            }\n            f.announces[notification.origin] = count\n            f.announced[notification.hash] = append(f.announced[notification.hash], notification)\n            if f.announceChangeHook != nil && len(f.announced[notification.hash]) == 1 {\n                f.announceChangeHook(notification.hash, true)\n            }\n            if len(f.announced) == 1 {\n                f.rescheduleFetch(fetchTimer)\n            }\n\n\n```\n\n1f.fetching f.completing notification.origin announces f.announced fetch\n2len(f.announced[notification.hash]) == 1 f.announcedf.announceChangeHook\n3len(f.announced) == 1 fetchTimer\n\n```\ncase <-fetchTimer.C:\n            // At least one block's timer ran out, check for needing retrieval\n            request := make(map[string][]common.Hash)\n\n            for hash, announces := range f.announced {\n                if time.Since(announces[0].time) > arriveTimeout-gatherSlack {\n                    // Pick a random peer to retrieve from, reset all others\n                    announce := announces[rand.Intn(len(announces))]\n                    f.forgetHash(hash)\n\n                    // If the block still didn't arrive, queue for fetching\n                    if f.getBlock(hash) == nil {\n                        request[announce.origin] = append(request[announce.origin], hash)\n                        f.fetching[hash] = announce\n                    }\n                }\n            }\n            // Send out all block header requests\n            for peer, hashes := range request {\n                log.Trace(\"Fetching scheduled headers\", \"peer\", peer, \"list\", hashes)\n\n                // Create a closure of the fetch and schedule in on a new thread\n                fetchHeader, hashes := f.fetching[hashes[0]].fetchHeader, hashes\n                go func() {\n                    if f.fetchingHook != nil {\n                        f.fetchingHook(hashes)\n                    }\n                    for _, hash := range hashes {\n                        headerFetchMeter.Mark(1)\n                        fetchHeader(hash) // Suboptimal, but protocol doesn't allow batch header retrievals\n                    }\n                }()\n            }\n            // Schedule the next fetch if blocks are still pending\n            f.rescheduleFetch(fetchTimer)\n\n\n```\n\n1f.announcedarriveTimeout-gatherSlackhashfetcher\nannouncesannounceblockhashhashannounce\nhashblockannouncerequestannouncef.fetching\n2requestrequestblockhashfetchHeader(hash)header\nfetchHeader(hash)pm.fetcher.Notifypeer.go\n\n3 NewBlockHashesMsg fetcherfetchTimer\n\nFetcher FilterHeaders()\nfetchHeader(hash)peer.go RequestOneHeader(hash common.Hash)  SendGetBlockHeadersMsg \npm.handleMsg  BlockHashesMsg\n\n```\ncase msg.Code == BlockHeadersMsg:\n        // A batch of headers arrived to one of our previous requests\n        var headers []*types.Header\n        if err := msg.Decode(&headers); err != nil {\n            return errResp(ErrDecode, \"msg %v: %v\", msg, err)\n        }\n        // If no headers were received, but we're expending a DAO fork check, maybe it's that\n        if len(headers) == 0 && p.forkDrop != nil {\n            // Possibly an empty reply to the fork header checks, sanity check TDs\n            verifyDAO := true\n\n            // If we already have a DAO header, we can check the peer's TD against it. If\n            // the peer's ahead of this, it too must have a reply to the DAO check\n            if daoHeader := pm.blockchain.GetHeaderByNumber(pm.chainconfig.DAOForkBlock.Uint64()); daoHeader != nil {\n                if _, td := p.Head(); td.Cmp(pm.blockchain.GetTd(daoHeader.Hash(), daoHeader.Number.Uint64())) >= 0 {\n                    verifyDAO = false\n                }\n            }\n            // If we're seemingly on the same chain, disable the drop timer\n            if verifyDAO {\n                p.Log().Debug(\"Seems to be on the same side of the DAO fork\")\n                p.forkDrop.Stop()\n                p.forkDrop = nil\n                return nil\n            }\n        }\n        // Filter out any explicitly requested headers, deliver the rest to the downloader\n        filter := len(headers) == 1\n        if filter {\n            // If it's a potential DAO fork check, validate against the rules\n            if p.forkDrop != nil && pm.chainconfig.DAOForkBlock.Cmp(headers[0].Number) == 0 {\n                // Disable the fork drop timer\n                p.forkDrop.Stop()\n                p.forkDrop = nil\n\n                // Validate the header and either drop the peer or continue\n                if err := misc.VerifyDAOHeaderExtraData(pm.chainconfig, headers[0]); err != nil {\n                    p.Log().Debug(\"Verified to be on the other side of the DAO fork, dropping\")\n                    return err\n                }\n                p.Log().Debug(\"Verified to be on the same side of the DAO fork\")\n                return nil\n            }\n            // Irrelevant of the fork checks, send the header to the fetcher just in case\n            headers = pm.fetcher.FilterHeaders(p.id, headers, time.Now())\n        }\n        if len(headers) > 0 || !filter {\n            err := pm.downloader.DeliverHeaders(p.id, headers)\n            if err != nil {\n                log.Debug(\"Failed to deliver headers\", \"err\", err)\n            }\n        }\n\n\n```\n\ndaoHeaderlen(headers) == 1pm.fetcher.FilterHeaders(p.id, headers, time.Now())\n\n```\nfunc (f *Fetcher) FilterHeaders(peer string, headers []*types.Header, time time.Time) []*types.Header {\n    log.Trace(\"Filtering headers\", \"peer\", peer, \"headers\", len(headers))\n\n    // Send the filter channel to the fetcher\n    filter := make(chan *headerFilterTask)\n\n    select {\n    case f.headerFilter <- filter:\n    case <-f.quit:\n        return nil\n    }\n    // Request the filtering of the header list\n    select {\n    case filter <- &headerFilterTask{peer: peer, headers: headers, time: time}:\n    case <-f.quit:\n        return nil\n    }\n    // Retrieve the headers remaining after filtering\n    select {\n    case task := <-filter:\n        return task.headers\n    case <-f.quit:\n        return nil\n    }\n}\n\n\n```\n\nsend filter f.headerFilterfetcherloop()f.headerFilter receive filter\n\n```\ncase filter := <-f.headerFilter:\n            // Headers arrived from a remote peer. Extract those that were explicitly\n            // requested by the fetcher, and return everything else so it's delivered\n            // to other parts of the system.\n            var task *headerFilterTask\n            select {\n            case task = <-filter:\n            case <-f.quit:\n                return\n            }\n            headerFilterInMeter.Mark(int64(len(task.headers)))\n\n            // Split the batch of headers into unknown ones (to return to the caller),\n            // known incomplete ones (requiring body retrievals) and completed blocks.\n            unknown, incomplete, complete := []*types.Header{}, []*announce{}, []*types.Block{}\n            for _, header := range task.headers {\n                hash := header.Hash()\n\n                // Filter fetcher-requested headers from other synchronisation algorithms\n                if announce := f.fetching[hash]; announce != nil && announce.origin == task.peer && f.fetched[hash] == nil && f.completing[hash] == nil && f.queued[hash] == nil {\n                    // If the delivered header does not match the promised number, drop the announcer\n                    if header.Number.Uint64() != announce.number {\n                        log.Trace(\"Invalid block number fetched\", \"peer\", announce.origin, \"hash\", header.Hash(), \"announced\", announce.number, \"provided\", header.Number)\n                        f.dropPeer(announce.origin)\n                        f.forgetHash(hash)\n                        continue\n                    }\n                    // Only keep if not imported by other means\n                    if f.getBlock(hash) == nil {\n                        announce.header = header\n                        announce.time = task.time\n\n                        // If the block is empty (header only), short circuit into the final import queue\n                        if header.TxHash == types.DeriveSha(types.Transactions{}) && header.UncleHash == types.CalcUncleHash([]*types.Header{}) {\n                            log.Trace(\"Block empty, skipping body retrieval\", \"peer\", announce.origin, \"number\", header.Number, \"hash\", header.Hash())\n\n                            block := types.NewBlockWithHeader(header)\n                            block.ReceivedAt = task.time\n\n                            complete = append(complete, block)\n                            f.completing[hash] = announce\n                            continue\n                        }\n                        // Otherwise add to the list of blocks needing completion\n                        incomplete = append(incomplete, announce)\n                    } else {\n                        log.Trace(\"Block already imported, discarding header\", \"peer\", announce.origin, \"number\", header.Number, \"hash\", header.Hash())\n                        f.forgetHash(hash)\n                    }\n                } else {\n                    // Fetcher doesn't know about it, add to the return list\n                    unknown = append(unknown, header)\n                }\n            }\n            headerFilterOutMeter.Mark(int64(len(unknown)))\n            select {\n            case filter <- &headerFilterTask{headers: unknown, time: task.time}:\n            case <-f.quit:\n                return\n            }\n            // Schedule the retrieved headers for body completion\n            for _, announce := range incomplete {\n                hash := announce.header.Hash()\n                if _, ok := f.completing[hash]; ok {\n                    continue\n                }\n                f.fetched[hash] = append(f.fetched[hash], announce)\n                if len(f.fetched) == 1 {\n                    f.rescheduleComplete(completeTimer)\n                }\n            }\n            // Schedule the header-only blocks for import\n            for _, block := range complete {\n                if announce := f.completing[block.Hash()]; announce != nil {\n                    f.enqueue(announce.origin, block)\n                }\n            }\n\n\n```\n\n1headerFilterheader f.fetchingf.fetched f.completingunknown filterFilterHeaderstask filterFilterHeaders\n2headernumberf.fetchingannouncenumberhash\n3hashblockhashblockhashcompletef.completingincomplete\n4incompletef.completingf.fetchedcompleteTimer\n5completef.completingf.enqueue(announce.origin, block)\n\n```\ncase <-completeTimer.C:\n            // At least one header's timer ran out, retrieve everything\n            request := make(map[string][]common.Hash)\n\n            for hash, announces := range f.fetched {\n                // Pick a random peer to retrieve from, reset all others\n                announce := announces[rand.Intn(len(announces))]\n                f.forgetHash(hash)\n\n                // If the block still didn't arrive, queue for completion\n                if f.getBlock(hash) == nil {\n                    request[announce.origin] = append(request[announce.origin], hash)\n                    f.completing[hash] = announce\n                }\n            }\n            // Send out all block body requests\n            for peer, hashes := range request {\n                log.Trace(\"Fetching scheduled bodies\", \"peer\", peer, \"list\", hashes)\n\n                // Create a closure of the fetch and schedule in on a new thread\n                if f.completingHook != nil {\n                    f.completingHook(hashes)\n                }\n                bodyFetchMeter.Mark(int64(len(hashes)))\n                go f.completing[hashes[0]].fetchBodies(hashes)\n            }\n            // Schedule the next fetch if blocks are still pending\n            f.rescheduleComplete(completeTimer)\n\n```\n\n1f.fetchedhashfetcher\nhashblockannouncerequestannouncef.completing\n2requestrequestblockhashfetchBodies(hashes)bodyfetchBodies(hashes)peer.go\n3 BlockHashesMsg fetchercompleteTimer\n\nFetcher FilterBodies() Enqueue(\n1fetchBodies(hash)peer.go RequestBodies(hashes []common.Hash) SendGetBlockBodiesMsg \n2pm.handleMsg  BlockBodiesMsg\n3 pm.fetcher.FilterBodies(p.id, trasactions, uncles, time.Now())\nFilterHeaders()\n4FilterBodies()timer\n5FilterHeaders()FilterBodies()f.enqueue(announce.origin, block)\n\n```\nfunc (f *Fetcher) enqueue(peer string, block *types.Block) {\n    hash := block.Hash()\n\n    // Ensure the peer isn't DOSing us\n    count := f.queues[peer] + 1\n    if count > blockLimit {\n        log.Debug(\"Discarded propagated block, exceeded allowance\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"limit\", blockLimit)\n        propBroadcastDOSMeter.Mark(1)\n        f.forgetHash(hash)\n        return\n    }\n    // Discard any past or too distant blocks\n    if dist := int64(block.NumberU64()) - int64(f.chainHeight()); dist < -maxUncleDist || dist > maxQueueDist {\n        log.Debug(\"Discarded propagated block, too far away\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"distance\", dist)\n        propBroadcastDropMeter.Mark(1)\n        f.forgetHash(hash)\n        return\n    }\n    // Schedule the block for future importing\n    if _, ok := f.queued[hash]; !ok {\n        op := &inject{\n            origin: peer,\n            block:  block,\n        }\n        f.queues[peer] = count\n        f.queued[hash] = op\n        f.queue.Push(op, -float32(block.NumberU64()))\n        if f.queueChangeHook != nil {\n            f.queueChangeHook(op.block.Hash(), true)\n        }\n        log.Debug(\"Queued propagated block\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"queued\", f.queue.Size())\n    }\n}\n\n```\n\nhashf.queue\nloopf.queueblock insertblock chain\n\n```\nfunc (f *Fetcher) insert(peer string, block *types.Block) {\n    hash := block.Hash()\n\n    // Run the import on a new thread\n    log.Debug(\"Importing propagated block\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash)\n    go func() {\n        defer func() { f.done <- hash }()\n\n        // If the parent's unknown, abort insertion\n        parent := f.getBlock(block.ParentHash())\n        if parent == nil {\n            log.Debug(\"Unknown parent of propagated block\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"parent\", block.ParentHash())\n            return\n        }\n        // Quickly validate the header and propagate the block if it passes\n        switch err := f.verifyHeader(block.Header()); err {\n        case nil:\n            // All ok, quickly propagate to our peers\n            propBroadcastOutTimer.UpdateSince(block.ReceivedAt)\n            go f.broadcastBlock(block, true)\n\n        case consensus.ErrFutureBlock:\n            // Weird future block, don't fail, but neither propagate\n\n        default:\n            // Something went very wrong, drop the peer\n            log.Debug(\"Propagated block verification failed\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"err\", err)\n            f.dropPeer(peer)\n            return\n        }\n        // Run the actual import and log any issues\n        if _, err := f.insertChain(types.Blocks{block}); err != nil {\n            log.Debug(\"Propagated block import failed\", \"peer\", peer, \"number\", block.Number(), \"hash\", hash, \"err\", err)\n            return\n        }\n        // If import succeeded, broadcast the block\n        propAnnounceOutTimer.UpdateSince(block.ReceivedAt)\n        go f.broadcastBlock(block, false)\n\n        // Invoke the testing hook if needed\n        if f.importedHook != nil {\n            f.importedHook(block)\n        }\n    }()\n}\n\n\n```\n\nf.verifyHeader(block.Header())blockHeader\n\nf.insertChain(types.Blocks{block}) \n()blockhash\n\n\nfetcher.go \n\n\n\n\n\n#### Downloader\n\nDownloader\nProtocolManagerDownloader\n\n```\nfunc New(mode SyncMode, stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn) *Downloader {\n    if lightchain == nil {\n        lightchain = chain\n    }\n\n    dl := &Downloader{\n        mode:           mode,\n        stateDB:        stateDb,\n        mux:            mux,\n        queue:          newQueue(),\n        peers:          newPeerSet(),\n        rttEstimate:    uint64(rttMaxEstimate),\n        rttConfidence:  uint64(1000000),\n        blockchain:     chain,\n        lightchain:     lightchain,\n        dropPeer:       dropPeer,\n        headerCh:       make(chan dataPack, 1),\n        bodyCh:         make(chan dataPack, 1),\n        receiptCh:      make(chan dataPack, 1),\n        bodyWakeCh:     make(chan bool, 1),\n        receiptWakeCh:  make(chan bool, 1),\n        headerProcCh:   make(chan []*types.Header, 1),\n        quitCh:         make(chan struct{}),\n        stateCh:        make(chan dataPack),\n        stateSyncStart: make(chan *stateSync),\n        trackStateReq:  make(chan *stateReq),\n    }\n    go dl.qosTuner()\n    go dl.stateFetcher()\n    return dl\n}\n\n```\n\nDownloaderdl.qosTuner() goroutinedl.stateFetcher() goroutine Downloader\n\nProtocolManagerP2PProtocolManager synchronise(peer *peer)DownloaderSynchronise(peer.id, pHead, pTd, mode)\n\nSynchronised.queued.peersd.bodyWakeCh, d.receiptWakeChd.headerCh, d.bodyCh, d.receiptChd.headerProcChd.syncWithPeer(p, hash, td)\n\n```\nfunc (d *Downloader) syncWithPeer(p *peerConnection, hash common.Hash, td *big.Int) (err error) {\n    d.mux.Post(StartEvent{})\n    defer func() {\n        // reset on error\n        if err != nil {\n            d.mux.Post(FailedEvent{err})\n        } else {\n            d.mux.Post(DoneEvent{})\n        }\n    }()\n    if p.version < 62 {\n        return errTooOld\n    }\n\n    log.Debug(\"Synchronising with the network\", \"peer\", p.id, \"eth\", p.version, \"head\", hash, \"td\", td, \"mode\", d.mode)\n    defer func(start time.Time) {\n        log.Debug(\"Synchronisation terminated\", \"elapsed\", time.Since(start))\n    }(time.Now())\n\n    // Look up the sync boundaries: the common ancestor and the target block\n    latest, err := d.fetchHeight(p)\n    if err != nil {\n        return err\n    }\n    height := latest.Number.Uint64()\n\n    origin, err := d.findAncestor(p, height)\n    if err != nil {\n        return err\n    }\n    d.syncStatsLock.Lock()\n    if d.syncStatsChainHeight <= origin || d.syncStatsChainOrigin > origin {\n        d.syncStatsChainOrigin = origin\n    }\n    d.syncStatsChainHeight = height\n    d.syncStatsLock.Unlock()\n\n    // Ensure our origin point is below any fast sync pivot point\n    pivot := uint64(0)\n    if d.mode == FastSync {\n        if height <= uint64(fsMinFullBlocks) {\n            origin = 0\n        } else {\n            pivot = height - uint64(fsMinFullBlocks)\n            if pivot <= origin {\n                origin = pivot - 1\n            }\n        }\n    }\n    d.committed = 1\n    if d.mode == FastSync && pivot != 0 {\n        d.committed = 0\n    }\n    // Initiate the sync using a concurrent header and content retrieval algorithm\n    d.queue.Prepare(origin+1, d.mode)\n    if d.syncInitHook != nil {\n        d.syncInitHook(origin, height)\n    }\n\n    fetchers := []func() error{\n        func() error { return d.fetchHeaders(p, origin+1, pivot) }, // Headers are always retrieved\n        func() error { return d.fetchBodies(origin + 1) },          // Bodies are retrieved during normal and fast sync\n        func() error { return d.fetchReceipts(origin + 1) },        // Receipts are retrieved during fast sync\n        func() error { return d.processHeaders(origin+1, pivot, td) },\n    }\n    if d.mode == FastSync {\n        fetchers = append(fetchers, func() error { return d.processFastSyncContent(latest) })\n    } else if d.mode == FullSync {\n        fetchers = append(fetchers, d.processFullSyncContent)\n    }\n    return d.spawnSync(fetchers)\n}\n\n```\n\nlatest, err := d.fetchHeight(p)peer,\n\n```\nfunc (d *Downloader) fetchHeight(p *peerConnection) (*types.Header, error) {\n    p.log.Debug(\"Retrieving remote chain height\")\n\n    // Request the advertised remote head block and wait for the response\n    head, _ := p.peer.Head()\n    go p.peer.RequestHeadersByHash(head, 1, 0, false)\n\n    ttl := d.requestTTL()\n    timeout := time.After(ttl)\n    for {\n        select {\n        case <-d.cancelCh:\n            return nil, errCancelBlockFetch\n\n        case packet := <-d.headerCh:\n            // Discard anything not from the origin peer\n            if packet.PeerId() != p.id {\n                log.Debug(\"Received headers from incorrect peer\", \"peer\", packet.PeerId())\n                break\n            }\n            // Make sure the peer actually gave something valid\n            headers := packet.(*headerPack).headers\n            if len(headers) != 1 {\n                p.log.Debug(\"Multiple headers for single request\", \"headers\", len(headers))\n                return nil, errBadPeer\n            }\n            head := headers[0]\n            p.log.Debug(\"Remote head header identified\", \"number\", head.Number, \"hash\", head.Hash())\n            return head, nil\n\n        case <-timeout:\n            p.log.Debug(\"Waiting for head header timed out\", \"elapsed\", ttl)\n            return nil, errTimeout\n\n        case <-d.bodyCh:\n        case <-d.receiptCh:\n            // Out of bounds delivery, ignore\n        }\n    }\n}\n\n\n```\n\n1peer.RequestHeadersByHash(head, 1, 0, false)GetBlockHeadersMsg\n2d.headerChtimeout\n3BlockHeadersMsg\n4downloader.DeliverHeaders(p.id, headers)\n5p.idheadersd.headerCh\n6selectd.headerChheader\n\nsyncWithPeer()  d.findAncestor(p, height)\n\n```\nfunc (d *Downloader) findAncestor(p *peerConnection, height uint64) (uint64, error) {\n    // Figure out the valid ancestor range to prevent rewrite attacks\n    floor, ceil := int64(-1), d.lightchain.CurrentHeader().Number.Uint64()\n\n    if d.mode == FullSync {\n        ceil = d.blockchain.CurrentBlock().NumberU64()\n    } else if d.mode == FastSync {\n        ceil = d.blockchain.CurrentFastBlock().NumberU64()\n    }\n    if ceil >= MaxForkAncestry {\n        floor = int64(ceil - MaxForkAncestry)\n    }\n    p.log.Debug(\"Looking for common ancestor\", \"local\", ceil, \"remote\", height)\n\n    // Request the topmost blocks to short circuit binary ancestor lookup\n    head := ceil\n    if head > height {\n        head = height\n    }\n    from := int64(head) - int64(MaxHeaderFetch)\n    if from < 0 {\n        from = 0\n    }\n    // Span out with 15 block gaps into the future to catch bad head reports\n    limit := 2 * MaxHeaderFetch / 16\n    count := 1 + int((int64(ceil)-from)/16)\n    if count > limit {\n        count = limit\n    }\n    go p.peer.RequestHeadersByNumber(uint64(from), count, 15, false)\n\n    // Wait for the remote response to the head fetch\n    number, hash := uint64(0), common.Hash{}\n\n    ttl := d.requestTTL()\n    timeout := time.After(ttl)\n\n    for finished := false; !finished; {\n        select {\n        case <-d.cancelCh:\n            return 0, errCancelHeaderFetch\n\n        case packet := <-d.headerCh:\n            // Discard anything not from the origin peer\n            if packet.PeerId() != p.id {\n                log.Debug(\"Received headers from incorrect peer\", \"peer\", packet.PeerId())\n                break\n            }\n            // Make sure the peer actually gave something valid\n            headers := packet.(*headerPack).headers\n            if len(headers) == 0 {\n                p.log.Warn(\"Empty head header set\")\n                return 0, errEmptyHeaderSet\n            }\n            // Make sure the peer's reply conforms to the request\n            for i := 0; i < len(headers); i++ {\n                if number := headers[i].Number.Int64(); number != from+int64(i)*16 {\n                    p.log.Warn(\"Head headers broke chain ordering\", \"index\", i, \"requested\", from+int64(i)*16, \"received\", number)\n                    return 0, errInvalidChain\n                }\n            }\n            // Check if a common ancestor was found\n            finished = true\n            for i := len(headers) - 1; i >= 0; i-- {\n                // Skip any headers that underflow/overflow our requested set\n                if headers[i].Number.Int64() < from || headers[i].Number.Uint64() > ceil {\n                    continue\n                }\n                // Otherwise check if we already know the header or not\n                if (d.mode == FullSync && d.blockchain.HasBlock(headers[i].Hash(), headers[i].Number.Uint64())) || (d.mode != FullSync && d.lightchain.HasHeader(headers[i].Hash(), headers[i].Number.Uint64())) {\n                    number, hash = headers[i].Number.Uint64(), headers[i].Hash()\n\n                    // If every header is known, even future ones, the peer straight out lied about its head\n                    if number > height && i == limit-1 {\n                        p.log.Warn(\"Lied about chain head\", \"reported\", height, \"found\", number)\n                        return 0, errStallingPeer\n                    }\n                    break\n                }\n            }\n\n        case <-timeout:\n            p.log.Debug(\"Waiting for head header timed out\", \"elapsed\", ttl)\n            return 0, errTimeout\n\n        case <-d.bodyCh:\n        case <-d.receiptCh:\n            // Out of bounds delivery, ignore\n        }\n    }\n    // If the head fetch already found an ancestor, return\n    if !common.EmptyHash(hash) {\n        if int64(number) <= floor {\n            p.log.Warn(\"Ancestor below allowance\", \"number\", number, \"hash\", hash, \"allowance\", floor)\n            return 0, errInvalidAncestor\n        }\n        p.log.Debug(\"Found common ancestor\", \"number\", number, \"hash\", hash)\n        return number, nil\n    }\n    // Ancestor not found, we need to binary search over our chain\n    start, end := uint64(0), head\n    if floor > 0 {\n        start = uint64(floor)\n    }\n    for start+1 < end {\n        // Split our chain interval in two, and request the hash to cross check\n        check := (start + end) / 2\n\n        ttl := d.requestTTL()\n        timeout := time.After(ttl)\n\n        go p.peer.RequestHeadersByNumber(check, 1, 0, false)\n\n        // Wait until a reply arrives to this request\n        for arrived := false; !arrived; {\n            select {\n            case <-d.cancelCh:\n                return 0, errCancelHeaderFetch\n\n            case packer := <-d.headerCh:\n                // Discard anything not from the origin peer\n                if packer.PeerId() != p.id {\n                    log.Debug(\"Received headers from incorrect peer\", \"peer\", packer.PeerId())\n                    break\n                }\n                // Make sure the peer actually gave something valid\n                headers := packer.(*headerPack).headers\n                if len(headers) != 1 {\n                    p.log.Debug(\"Multiple headers for single request\", \"headers\", len(headers))\n                    return 0, errBadPeer\n                }\n                arrived = true\n\n                // Modify the search interval based on the response\n                if (d.mode == FullSync && !d.blockchain.HasBlock(headers[0].Hash(), headers[0].Number.Uint64())) || (d.mode != FullSync && !d.lightchain.HasHeader(headers[0].Hash(), headers[0].Number.Uint64())) {\n                    end = check\n                    break\n                }\n                header := d.lightchain.GetHeaderByHash(headers[0].Hash()) // Independent of sync mode, header surely exists\n                if header.Number.Uint64() != check {\n                    p.log.Debug(\"Received non requested header\", \"number\", header.Number, \"hash\", header.Hash(), \"request\", check)\n                    return 0, errBadPeer\n                }\n                start = check\n\n            case <-timeout:\n                p.log.Debug(\"Waiting for search header timed out\", \"elapsed\", ttl)\n                return 0, errTimeout\n\n            case <-d.bodyCh:\n            case <-d.receiptCh:\n                // Out of bounds delivery, ignore\n            }\n        }\n    }\n    // Ensure valid ancestry and return\n    if int64(start) <= floor {\n        p.log.Warn(\"Ancestor below allowance\", \"number\", start, \"hash\", hash, \"allowance\", floor)\n        return 0, errInvalidAncestor\n    }\n    p.log.Debug(\"Found common ancestor\", \"number\", start, \"hash\", hash)\n    return start, nil\n}\n\n```\n\n1peer.RequestHeadersByNumber(uint64(from), count, 15, false)header count 15header19216selectd.headerCh\n2selectheadersheaderheadernumber\n3MaxForkAncestryheader0.\n\nsyncWithPeer()pivotd.spawnSync(fetchers)d.spawnSync(fetchers)\n\nDownloader\nfetchHeaders()fetchBodies() , fetchReceipts()\n\n```\nfunc (d *Downloader) fetchHeaders(p *peerConnection, from uint64, pivot uint64) error {\n    p.log.Debug(\"Directing header downloads\", \"origin\", from)\n    defer p.log.Debug(\"Header download terminated\")\n\n    // Create a timeout timer, and the associated header fetcher\n    skeleton := true            // Skeleton assembly phase or finishing up\n    request := time.Now()       // time of the last skeleton fetch request\n    timeout := time.NewTimer(0) // timer to dump a non-responsive active peer\n    <-timeout.C                 // timeout channel should be initially empty\n    defer timeout.Stop()\n\n    var ttl time.Duration\n    getHeaders := func(from uint64) {\n        request = time.Now()\n\n        ttl = d.requestTTL()\n        timeout.Reset(ttl)\n\n        if skeleton {\n            p.log.Trace(\"Fetching skeleton headers\", \"count\", MaxHeaderFetch, \"from\", from)\n            go p.peer.RequestHeadersByNumber(from+uint64(MaxHeaderFetch)-1, MaxSkeletonSize, MaxHeaderFetch-1, false)\n        } else {\n            p.log.Trace(\"Fetching full headers\", \"count\", MaxHeaderFetch, \"from\", from)\n            go p.peer.RequestHeadersByNumber(from, MaxHeaderFetch, 0, false)\n        }\n    }\n    // Start pulling the header chain skeleton until all is done\n    getHeaders(from)\n\n    for {\n        select {\n        case <-d.cancelCh:\n            return errCancelHeaderFetch\n\n        case packet := <-d.headerCh:\n            // Make sure the active peer is giving us the skeleton headers\n            if packet.PeerId() != p.id {\n                log.Debug(\"Received skeleton from incorrect peer\", \"peer\", packet.PeerId())\n                break\n            }\n            headerReqTimer.UpdateSince(request)\n            timeout.Stop()\n\n            // If the skeleton's finished, pull any remaining head headers directly from the origin\n            if packet.Items() == 0 && skeleton {\n                skeleton = false\n                getHeaders(from)\n                continue\n            }\n            // If no more headers are inbound, notify the content fetchers and return\n            if packet.Items() == 0 {\n                // Don't abort header fetches while the pivot is downloading\n                if atomic.LoadInt32(&d.committed) == 0 && pivot <= from {\n                    p.log.Debug(\"No headers, waiting for pivot commit\")\n                    select {\n                    case <-time.After(fsHeaderContCheck):\n                        getHeaders(from)\n                        continue\n                    case <-d.cancelCh:\n                        return errCancelHeaderFetch\n                    }\n                }\n                // Pivot done (or not in fast sync) and no more headers, terminate the process\n                p.log.Debug(\"No more headers available\")\n                select {\n                case d.headerProcCh <- nil:\n                    return nil\n                case <-d.cancelCh:\n                    return errCancelHeaderFetch\n                }\n            }\n            headers := packet.(*headerPack).headers\n\n            // If we received a skeleton batch, resolve internals concurrently\n            if skeleton {\n                filled, proced, err := d.fillHeaderSkeleton(from, headers)\n                if err != nil {\n                    p.log.Debug(\"Skeleton chain invalid\", \"err\", err)\n                    return errInvalidChain\n                }\n                headers = filled[proced:]\n                from += uint64(proced)\n            }\n            // Insert all the new headers and fetch the next batch\n            if len(headers) > 0 {\n                p.log.Trace(\"Scheduling new headers\", \"count\", len(headers), \"from\", from)\n                select {\n                case d.headerProcCh <- headers:\n                case <-d.cancelCh:\n                    return errCancelHeaderFetch\n                }\n                from += uint64(len(headers))\n            }\n            getHeaders(from)\n\n        case <-timeout.C:\n            if d.dropPeer == nil {\n                // The dropPeer method is nil when `--copydb` is used for a local copy.\n                // Timeouts can occur if e.g. compaction hits at the wrong time, and can be ignored\n                p.log.Warn(\"Downloader wants to drop peer, but peerdrop-function is not set\", \"peer\", p.id)\n                break\n            }\n            // Header retrieval timed out, consider the peer bad and drop\n            p.log.Debug(\"Header request timed out\", \"elapsed\", ttl)\n            headerTimeoutMeter.Mark(1)\n            d.dropPeer(p.id)\n\n            // Finish the sync gracefully instead of dumping the gathered data though\n            for _, ch := range []chan bool{d.bodyWakeCh, d.receiptWakeCh} {\n                select {\n                case ch <- false:\n                case <-d.cancelCh:\n                }\n            }\n            select {\n            case d.headerProcCh <- nil:\n            case <-d.cancelCh:\n            }\n            return errBadPeer\n        }\n    }\n}\n\n```\n\n1getHeaders()peer.RequestHeadersByNumber() headers\n2skeleton+192192128skeleton192\n3\n4skeletonfillHeaderSkeleton()skeleton header chain\n5fromgetHeaders()\n\n```\nfunc (d *Downloader) fillHeaderSkeleton(from uint64, skeleton []*types.Header) ([]*types.Header, int, error) {\n    log.Debug(\"Filling up skeleton\", \"from\", from)\n    d.queue.ScheduleSkeleton(from, skeleton)\n\n    var (\n        deliver = func(packet dataPack) (int, error) {\n            pack := packet.(*headerPack)\n            return d.queue.DeliverHeaders(pack.peerId, pack.headers, d.headerProcCh)\n        }\n        expire   = func() map[string]int { return d.queue.ExpireHeaders(d.requestTTL()) }\n        throttle = func() bool { return false }\n        reserve  = func(p *peerConnection, count int) (*fetchRequest, bool, error) {\n            return d.queue.ReserveHeaders(p, count), false, nil\n        }\n        fetch    = func(p *peerConnection, req *fetchRequest) error { return p.FetchHeaders(req.From, MaxHeaderFetch) }\n        capacity = func(p *peerConnection) int { return p.HeaderCapacity(d.requestRTT()) }\n        setIdle  = func(p *peerConnection, accepted int) { p.SetHeadersIdle(accepted) }\n    )\n    err := d.fetchParts(errCancelHeaderFetch, d.headerCh, deliver, d.queue.headerContCh, expire,\n        d.queue.PendingHeaders, d.queue.InFlightHeaders, throttle, reserve,\n        nil, fetch, d.queue.CancelHeaders, capacity, d.peers.HeaderIdlePeers, setIdle, \"headers\")\n\n    log.Debug(\"Skeleton fill terminated\", \"err\", err)\n\n    filled, proced := d.queue.RetrieveHeaders()\n    return filled, proced, err\n}\n\n\n```\n\na) skeletonheadersqueue.ScheduleSkeleton\nb) d.fetchParts()\nd.fetchParts()\n1headersd.queue.DeliverHeaders()\n2d.queue.PendingHeaderspendingheadersd.peers.HeaderIdlePeersidlepeers\n3d.queue.ReserveHeaderspendingheadersidlepeers\n4idlepeersp.FetchHeaders(req.From, MaxHeaderFetch)headers\nc) d.queue.RetrieveHeaders()filledheaders\n\nd.fetchBodies() , d.fetchReceipts() fetchHeaders()\n\nDownloader\nd.processHeaders(), d.processFastSyncContent(latest) , d.processFullSyncContent\n1d.processHeaders() \n\n```\nfunc (d *Downloader) processHeaders(origin uint64, pivot uint64, td *big.Int) error {\n    // Keep a count of uncertain headers to roll back\n    rollback := []*types.Header{}\n    defer func() {\n        if len(rollback) > 0 {\n            // Flatten the headers and roll them back\n            hashes := make([]common.Hash, len(rollback))\n            for i, header := range rollback {\n                hashes[i] = header.Hash()\n            }\n            lastHeader, lastFastBlock, lastBlock := d.lightchain.CurrentHeader().Number, common.Big0, common.Big0\n            if d.mode != LightSync {\n                lastFastBlock = d.blockchain.CurrentFastBlock().Number()\n                lastBlock = d.blockchain.CurrentBlock().Number()\n            }\n            d.lightchain.Rollback(hashes)\n            curFastBlock, curBlock := common.Big0, common.Big0\n            if d.mode != LightSync {\n                curFastBlock = d.blockchain.CurrentFastBlock().Number()\n                curBlock = d.blockchain.CurrentBlock().Number()\n            }\n            log.Warn(\"Rolled back headers\", \"count\", len(hashes),\n                \"header\", fmt.Sprintf(\"%d->%d\", lastHeader, d.lightchain.CurrentHeader().Number),\n                \"fast\", fmt.Sprintf(\"%d->%d\", lastFastBlock, curFastBlock),\n                \"block\", fmt.Sprintf(\"%d->%d\", lastBlock, curBlock))\n        }\n    }()\n\n    // Wait for batches of headers to process\n    gotHeaders := false\n\n    for {\n        select {\n        case <-d.cancelCh:\n            return errCancelHeaderProcessing\n\n        case headers := <-d.headerProcCh:\n            // Terminate header processing if we synced up\n            if len(headers) == 0 {\n                // Notify everyone that headers are fully processed\n                for _, ch := range []chan bool{d.bodyWakeCh, d.receiptWakeCh} {\n                    select {\n                    case ch <- false:\n                    case <-d.cancelCh:\n                    }\n                }\n                if d.mode != LightSync {\n                    head := d.blockchain.CurrentBlock()\n                    if !gotHeaders && td.Cmp(d.blockchain.GetTd(head.Hash(), head.NumberU64())) > 0 {\n                        return errStallingPeer\n                    }\n                }\n                if d.mode == FastSync || d.mode == LightSync {\n                    head := d.lightchain.CurrentHeader()\n                    if td.Cmp(d.lightchain.GetTd(head.Hash(), head.Number.Uint64())) > 0 {\n                        return errStallingPeer\n                    }\n                }\n                // Disable any rollback and return\n                rollback = nil\n                return nil\n            }\n            // Otherwise split the chunk of headers into batches and process them\n            gotHeaders = true\n\n            for len(headers) > 0 {\n                // Terminate if something failed in between processing chunks\n                select {\n                case <-d.cancelCh:\n                    return errCancelHeaderProcessing\n                default:\n                }\n                // Select the next chunk of headers to import\n                limit := maxHeadersProcess\n                if limit > len(headers) {\n                    limit = len(headers)\n                }\n                chunk := headers[:limit]\n\n                // In case of header only syncing, validate the chunk immediately\n                if d.mode == FastSync || d.mode == LightSync {\n                    // Collect the yet unknown headers to mark them as uncertain\n                    unknown := make([]*types.Header, 0, len(headers))\n                    for _, header := range chunk {\n                        if !d.lightchain.HasHeader(header.Hash(), header.Number.Uint64()) {\n                            unknown = append(unknown, header)\n                        }\n                    }\n                    // If we're importing pure headers, verify based on their recentness\n                    frequency := fsHeaderCheckFrequency\n                    if chunk[len(chunk)-1].Number.Uint64()+uint64(fsHeaderForceVerify) > pivot {\n                        frequency = 1\n                    }\n                    if n, err := d.lightchain.InsertHeaderChain(chunk, frequency); err != nil {\n                        // If some headers were inserted, add them too to the rollback list\n                        if n > 0 {\n                            rollback = append(rollback, chunk[:n]...)\n                        }\n                        log.Debug(\"Invalid header encountered\", \"number\", chunk[n].Number, \"hash\", chunk[n].Hash(), \"err\", err)\n                        return errInvalidChain\n                    }\n                    // All verifications passed, store newly found uncertain headers\n                    rollback = append(rollback, unknown...)\n                    if len(rollback) > fsHeaderSafetyNet {\n                        rollback = append(rollback[:0], rollback[len(rollback)-fsHeaderSafetyNet:]...)\n                    }\n                }\n                // Unless we're doing light chains, schedule the headers for associated content retrieval\n                if d.mode == FullSync || d.mode == FastSync {\n                    // If we've reached the allowed number of pending headers, stall a bit\n                    for d.queue.PendingBlocks() >= maxQueuedHeaders || d.queue.PendingReceipts() >= maxQueuedHeaders {\n                        select {\n                        case <-d.cancelCh:\n                            return errCancelHeaderProcessing\n                        case <-time.After(time.Second):\n                        }\n                    }\n                    // Otherwise insert the headers for content retrieval\n                    inserts := d.queue.Schedule(chunk, origin)\n                    if len(inserts) != len(chunk) {\n                        log.Debug(\"Stale headers\")\n                        return errBadPeer\n                    }\n                }\n                headers = headers[limit:]\n                origin += uint64(limit)\n            }\n            // Signal the content downloaders of the availablility of new tasks\n            for _, ch := range []chan bool{d.bodyWakeCh, d.receiptWakeCh} {\n                select {\n                case ch <- true:\n                default:\n                }\n            }\n        }\n    }\n}\n\n```\n\n1fetchHeaders() d.headerProcChheaders\n2FastSyncLightSynclightchain.InsertHeaderChain(chunk, frequency)headerChain\n3FullSyncFastSynd.queue.Schedule(chunk, origin)downloader.queue\n\n2processFastSyncContent() \n\n```\nfunc (d *Downloader) processFastSyncContent(latest *types.Header) error {\n    // Start syncing state of the reported head block. This should get us most of\n    // the state of the pivot block.\n    stateSync := d.syncState(latest.Root)\n    defer stateSync.Cancel()\n    go func() {\n        if err := stateSync.Wait(); err != nil && err != errCancelStateFetch {\n            d.queue.Close() // wake up WaitResults\n        }\n    }()\n    // Figure out the ideal pivot block. Note, that this goalpost may move if the\n    // sync takes long enough for the chain head to move significantly.\n    pivot := uint64(0)\n    if height := latest.Number.Uint64(); height > uint64(fsMinFullBlocks) {\n        pivot = height - uint64(fsMinFullBlocks)\n    }\n    // To cater for moving pivot points, track the pivot block and subsequently\n    // accumulated download results separatey.\n    var (\n        oldPivot *fetchResult   // Locked in pivot block, might change eventually\n        oldTail  []*fetchResult // Downloaded content after the pivot\n    )\n    for {\n        // Wait for the next batch of downloaded data to be available, and if the pivot\n        // block became stale, move the goalpost\n        results := d.queue.Results(oldPivot == nil) // Block if we're not monitoring pivot staleness\n        if len(results) == 0 {\n            // If pivot sync is done, stop\n            if oldPivot == nil {\n                return stateSync.Cancel()\n            }\n            // If sync failed, stop\n            select {\n            case <-d.cancelCh:\n                return stateSync.Cancel()\n            default:\n            }\n        }\n        if d.chainInsertHook != nil {\n            d.chainInsertHook(results)\n        }\n        if oldPivot != nil {\n            results = append(append([]*fetchResult{oldPivot}, oldTail...), results...)\n        }\n        // Split around the pivot block and process the two sides via fast/full sync\n        if atomic.LoadInt32(&d.committed) == 0 {\n            latest = results[len(results)-1].Header\n            if height := latest.Number.Uint64(); height > pivot+2*uint64(fsMinFullBlocks) {\n                log.Warn(\"Pivot became stale, moving\", \"old\", pivot, \"new\", height-uint64(fsMinFullBlocks))\n                pivot = height - uint64(fsMinFullBlocks)\n            }\n        }\n        P, beforeP, afterP := splitAroundPivot(pivot, results)\n        if err := d.commitFastSyncData(beforeP, stateSync); err != nil {\n            return err\n        }\n        if P != nil {\n            // If new pivot block found, cancel old state retrieval and restart\n            if oldPivot != P {\n                stateSync.Cancel()\n\n                stateSync = d.syncState(P.Header.Root)\n                defer stateSync.Cancel()\n                go func() {\n                    if err := stateSync.Wait(); err != nil && err != errCancelStateFetch {\n                        d.queue.Close() // wake up WaitResults\n                    }\n                }()\n                oldPivot = P\n            }\n            // Wait for completion, occasionally checking for pivot staleness\n            select {\n            case <-stateSync.done:\n                if stateSync.err != nil {\n                    return stateSync.err\n                }\n                if err := d.commitPivotBlock(P); err != nil {\n                    return err\n                }\n                oldPivot = nil\n\n            case <-time.After(time.Second):\n                oldTail = afterP\n                continue\n            }\n        }\n        // Fast sync done, pivot commit done, full import\n        if err := d.importBlockResults(afterP); err != nil {\n            return err\n        }\n    }\n}\n\n```\n\n1pivot\n2d.queue resultresult\n3resultspivot\n4pivotresultspivotresultpivotresultspivotresults\n5commitFastSyncDatapivotresults \n6pivotresult commitPivotBlockFastSyncCommitHeadpivothash\n7d.importBlockResultspivotresults\n\n3processFullSyncContent()\n\n```\nfunc (d *Downloader) processFullSyncContent() error {\n    for {\n        results := d.queue.Results(true)\n        if len(results) == 0 {\n            return nil\n        }\n        if d.chainInsertHook != nil {\n            d.chainInsertHook(results)\n        }\n        if err := d.importBlockResults(results); err != nil {\n            return err\n        }\n    }\n}\n\nfunc (d *Downloader) importBlockResults(results []*fetchResult) error {\n    // Check for any early termination requests\n    if len(results) == 0 {\n        return nil\n    }\n    select {\n    case <-d.quitCh:\n        return errCancelContentProcessing\n    default:\n    }\n    // Retrieve the a batch of results to import\n    first, last := results[0].Header, results[len(results)-1].Header\n    log.Debug(\"Inserting downloaded chain\", \"items\", len(results),\n        \"firstnum\", first.Number, \"firsthash\", first.Hash(),\n        \"lastnum\", last.Number, \"lasthash\", last.Hash(),\n    )\n    blocks := make([]*types.Block, len(results))\n    for i, result := range results {\n        blocks[i] = types.NewBlockWithHeader(result.Header).WithBody(result.Transactions, result.Uncles)\n    }\n    if index, err := d.blockchain.InsertChain(blocks); err != nil {\n        log.Debug(\"Downloaded item processing failed\", \"number\", results[index].Header.Number, \"hash\", results[index].Header.Hash(), \"err\", err)\n        return errInvalidChain\n    }\n    return nil\n}\n\n```\n\nprocessFullSyncContentresults\n\n\nDownloaderlightlightfastfullpivotfastfastfast[](https://github.com/ethereum/go-ethereum/pull/1889)\n","slug":"eth-code-tx-event","published":1,"updated":"2019-10-14T06:48:21.961Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ck3fm69ys002wt6xvyonfly1j","content":"<h4 id=\"ApplyTransaction\"><a href=\"#ApplyTransaction\" class=\"headerlink\" title=\"ApplyTransaction\"></a>ApplyTransaction</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ApplyTransaction attempts to apply a transaction to the given state database</span><br><span class=\"line\">// and uses the input parameters for its environment. It returns the receipt</span><br><span class=\"line\">// for the transaction, gas used and an error if the transaction failed,</span><br><span class=\"line\">// indicating the block was invalid.</span><br><span class=\"line\">//state database</span><br><span class=\"line\">func ApplyTransaction(config *params.ChainConfig, bc ChainContext, author *common.Address, gp *GasPool, statedb *state.StateDB, header *types.Header, tx *types.Transaction, usedGas *uint64, cfg vm.Config) (*types.Receipt, uint64, error) &#123;</span><br><span class=\"line\">\t//</span><br><span class=\"line\">\tmsg, err := tx.AsMessage(types.MakeSigner(config, header.Number))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\treturn nil, 0, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//EVMgaserrlogsevm</span><br><span class=\"line\">\t// Create a new context to be used in the EVM environment</span><br><span class=\"line\">\tcontext := NewEVMContext(msg, header, bc, author)</span><br><span class=\"line\">\t// Create a new environment which holds all relevant information</span><br><span class=\"line\">\t// about the transaction and calling mechanisms.</span><br><span class=\"line\">\tvmenv := vm.NewEVM(context, statedb, config, cfg)</span><br><span class=\"line\">\t// Apply the transaction to the current state (included in the env)</span><br><span class=\"line\">\t_, gas, failed, err := ApplyMessage(vmenv, msg, gp)</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\treturn nil, 0, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t//</span><br><span class=\"line\">\t// Update the state with pending changes</span><br><span class=\"line\">\tvar root []byte</span><br><span class=\"line\">\tif config.IsByzantium(header.Number) &#123;</span><br><span class=\"line\">\t\tstatedb.Finalise(true)</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\troot = statedb.IntermediateRoot(config.IsEIP158(header.Number)).Bytes()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t*usedGas += gas</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Create a new receipt for the transaction, storing the intermediate root and gas used by the tx</span><br><span class=\"line\">\t// based on the eip phase, we&apos;re passing whether the root touch-delete accounts.</span><br><span class=\"line\">\treceipt := types.NewReceipt(root, failed, *usedGas)</span><br><span class=\"line\">\treceipt.TxHash = tx.Hash()</span><br><span class=\"line\">\treceipt.GasUsed = gas</span><br><span class=\"line\">\t// if the transaction created a contract, store the creation address in the receipt.</span><br><span class=\"line\">\tif msg.To() == nil &#123;</span><br><span class=\"line\">\t\treceipt.ContractAddress = crypto.CreateAddress(vmenv.Context.Origin, tx.Nonce())</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// Set the receipt logs and create a bloom for filtering</span><br><span class=\"line\">\treceipt.Logs = statedb.GetLogs(tx.Hash())</span><br><span class=\"line\">\treceipt.Bloom = types.CreateBloom(types.Receipts&#123;receipt&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn receipt, gas, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (evm *EVM) Call(caller ContractRef, addr common.Address, input []byte, gas uint64, value *big.Int) (ret []byte, leftOverGas uint64, err error) &#123;</span><br><span class=\"line\">\tif evm.vmConfig.NoRecursion &amp;&amp; evm.depth &gt; 0 &#123;</span><br><span class=\"line\">\t\treturn nil, gas, nil</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Fail if we&apos;re trying to execute above the call depth limit</span><br><span class=\"line\">\tif evm.depth &gt; int(params.CallCreateDepth) &#123;</span><br><span class=\"line\">\t\treturn nil, gas, ErrDepth</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// Fail if we&apos;re trying to transfer more than the available balance</span><br><span class=\"line\">\tif !evm.Context.CanTransfer(evm.StateDB, caller.Address(), value) &#123;</span><br><span class=\"line\">\t\treturn nil, gas, ErrInsufficientBalance</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\tto       = AccountRef(addr)</span><br><span class=\"line\">\t\tsnapshot = evm.StateDB.Snapshot()</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\tif !evm.StateDB.Exist(addr) &#123;</span><br><span class=\"line\">\t\tprecompiles := PrecompiledContractsHomestead</span><br><span class=\"line\">\t\tif evm.ChainConfig().IsByzantium(evm.BlockNumber) &#123;</span><br><span class=\"line\">\t\t\tprecompiles = PrecompiledContractsByzantium</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif precompiles[addr] == nil &amp;&amp; evm.ChainConfig().IsEIP158(evm.BlockNumber) &amp;&amp; value.Sign() == 0 &#123;</span><br><span class=\"line\">\t\t\t// Calling a non existing account, don&apos;t do anything, but ping the tracer</span><br><span class=\"line\">\t\t\tif evm.vmConfig.Debug &amp;&amp; evm.depth == 0 &#123;</span><br><span class=\"line\">\t\t\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)</span><br><span class=\"line\">\t\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, 0, 0, nil)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\treturn nil, gas, nil</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tevm.StateDB.CreateAccount(addr)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tevm.Transfer(evm.StateDB, caller.Address(), to.Address(), value)</span><br><span class=\"line\">\t// Initialise a new contract and set the code that is to be used by the EVM.</span><br><span class=\"line\">\t// The contract is a scoped environment for this execution context only.</span><br><span class=\"line\">\tcontract := NewContract(caller, to, value, gas)</span><br><span class=\"line\">\tcontract.SetCallCode(&amp;addr, evm.StateDB.GetCodeHash(addr), evm.StateDB.GetCode(addr))</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Even if the account has no code, we need to continue because it might be a precompile</span><br><span class=\"line\">\tstart := time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Capture the tracer start/end events in debug mode</span><br><span class=\"line\">\tif evm.vmConfig.Debug &amp;&amp; evm.depth == 0 &#123;</span><br><span class=\"line\">\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tdefer func() &#123; // Lazy evaluation of the parameters</span><br><span class=\"line\">\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, gas-contract.Gas, time.Since(start), err)</span><br><span class=\"line\">\t\t&#125;()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tret, err = run(evm, contract, input, false)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// When an error was returned by the EVM or when setting the creation code</span><br><span class=\"line\">\t// above we revert to the snapshot and consume any gas remaining. Additionally</span><br><span class=\"line\">\t// when we&apos;re in homestead this also counts for code storage gas errors.</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tevm.StateDB.RevertToSnapshot(snapshot)</span><br><span class=\"line\">\t\tif err != errExecutionReverted &#123;</span><br><span class=\"line\">\t\t\tcontract.UseGas(contract.Gas)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn ret, contract.Gas, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"handleMsg\"><a href=\"#handleMsg\" class=\"headerlink\" title=\"handleMsg\"></a>handleMsg</h4><p></p>\n<ul>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">StatusMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetBlockHeadersMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BlockHeadersMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetBlockBodiesMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BlockBodiesMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetNodeDataMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NodeDataMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetReceiptsMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ReceiptsMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NewBlockHashesMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NewBlockMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TxMsg</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Start\"><a href=\"#Start\" class=\"headerlink\" title=\"Start\"></a>Start</h4><p>goroutine </p>\n<ul>\n<li><p>txBroadcastLoop</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (self *ProtocolManager) txBroadcastLoop() &#123;</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case event := &lt;-self.txCh:</span><br><span class=\"line\">            self.BroadcastTx(event.Tx.Hash(), event.Tx)</span><br><span class=\"line\"></span><br><span class=\"line\">        // Err() channel will be closed when unsubscribing.</span><br><span class=\"line\">        case &lt;-self.txSub.Err():</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>core/tx_pool.go send self.txCh<br>self.BroadcastTx(event.Tx.Hash(), event.Tx)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) BroadcastTx(hash common.Hash, tx *types.Transaction) &#123;</span><br><span class=\"line\">    // Broadcast transaction to a batch of peers not knowing about it</span><br><span class=\"line\">    peers := pm.peers.PeersWithoutTx(hash)</span><br><span class=\"line\">    //FIXME include this again: peers = peers[:int(math.Sqrt(float64(len(peers))))]</span><br><span class=\"line\">    for _, peer := range peers &#123;</span><br><span class=\"line\">        peer.SendTransactions(types.Transactions&#123;tx&#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    log.Trace(&quot;Broadcast transaction&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(peers))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>hash</p>\n</li>\n<li><p>minedBroadcastLoop</p>\n<p>miner.go NewMinedBlockEvent self.BroadcastBlock(ev.Block, true)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Mined broadcast loop</span><br><span class=\"line\">func (self *ProtocolManager) minedBroadcastLoop() &#123;</span><br><span class=\"line\">    // automatically stops if unsubscribe</span><br><span class=\"line\">    for obj := range self.minedBlockSub.Chan() &#123;</span><br><span class=\"line\">        switch ev := obj.Data.(type) &#123;</span><br><span class=\"line\">        case core.NewMinedBlockEvent:</span><br><span class=\"line\">            self.BroadcastBlock(ev.Block, true)  // First propagate block to peers</span><br><span class=\"line\">            self.BroadcastBlock(ev.Block, false) // Only then announce to the rest</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) BroadcastBlock(block *types.Block, propagate bool) &#123;</span><br><span class=\"line\">    hash := block.Hash()</span><br><span class=\"line\">    peers := pm.peers.PeersWithoutBlock(hash)</span><br><span class=\"line\"></span><br><span class=\"line\">    // If propagation is requested, send to a subset of the peer</span><br><span class=\"line\">    if propagate &#123;</span><br><span class=\"line\">        // Calculate the TD of the block (it&apos;s not imported yet, so block.Td is not valid)</span><br><span class=\"line\">        var td *big.Int</span><br><span class=\"line\">        if parent := pm.blockchain.GetBlock(block.ParentHash(), block.NumberU64()-1); parent != nil &#123;</span><br><span class=\"line\">            td = new(big.Int).Add(block.Difficulty(), pm.blockchain.GetTd(block.ParentHash(), block.NumberU64()-1))</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            log.Error(&quot;Propagating dangling block&quot;, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash)</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Send the block to a subset of our peers</span><br><span class=\"line\">        transfer := peers[:int(math.Sqrt(float64(len(peers))))]</span><br><span class=\"line\">        for _, peer := range transfer &#123;</span><br><span class=\"line\">            peer.SendNewBlock(block, td)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.Trace(&quot;Propagated block&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(transfer), &quot;duration&quot;, common.PrettyDuration(time.Since(block.ReceivedAt)))</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Otherwise if the block is indeed in out own chain, announce it</span><br><span class=\"line\">    if pm.blockchain.HasBlock(hash, block.NumberU64()) &#123;</span><br><span class=\"line\">        for _, peer := range peers &#123;</span><br><span class=\"line\">            peer.SendNewBlockHashes([]common.Hash&#123;hash&#125;, []uint64&#123;block.NumberU64()&#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.Trace(&quot;Announced block&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(peers), &quot;duration&quot;, common.PrettyDuration(time.Since(block.ReceivedAt)))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>propagatetrue blockfalse hashnumber</p>\n</li>\n<li><p>syncer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) syncer() &#123;</span><br><span class=\"line\">    // Start and ensure cleanup of sync mechanisms</span><br><span class=\"line\">    pm.fetcher.Start()</span><br><span class=\"line\">    defer pm.fetcher.Stop()</span><br><span class=\"line\">    defer pm.downloader.Terminate()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Wait for different events to fire synchronisation operations</span><br><span class=\"line\">    forceSync := time.NewTicker(forceSyncCycle)</span><br><span class=\"line\">    defer forceSync.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-pm.newPeerCh:</span><br><span class=\"line\">            // Make sure we have peers to select from, then sync</span><br><span class=\"line\">            if pm.peers.Len() &lt; minDesiredPeerCount &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            go pm.synchronise(pm.peers.BestPeer())</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-forceSync.C:</span><br><span class=\"line\">            // Force a sync even if not enough peers are present</span><br><span class=\"line\">            go pm.synchronise(pm.peers.BestPeer())</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-pm.noMorePeers:</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>pm.fetcher.Start() fetcher</p>\n<p>P2P server ProtocolManager p2p.Protocol Runsend pm.newPeerChTD pm.synchronise(pm.peers.BestPeer()) goroutine</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// synchronise tries to sync up our local block chain with a remote peer.</span><br><span class=\"line\">func (pm *ProtocolManager) synchronise(peer *peer) &#123;</span><br><span class=\"line\">    // Short circuit if no peers are available</span><br><span class=\"line\">    if peer == nil &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Make sure the peer&apos;s TD is higher than our own</span><br><span class=\"line\">    currentBlock := pm.blockchain.CurrentBlock()</span><br><span class=\"line\">    td := pm.blockchain.GetTd(currentBlock.Hash(), currentBlock.NumberU64())</span><br><span class=\"line\"></span><br><span class=\"line\">    pHead, pTd := peer.Head()</span><br><span class=\"line\">    if pTd.Cmp(td) &lt;= 0 &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Otherwise try to sync with the downloader</span><br><span class=\"line\">    mode := downloader.FullSync</span><br><span class=\"line\">    if atomic.LoadUint32(&amp;pm.fastSync) == 1 &#123;</span><br><span class=\"line\">        // Fast sync was explicitly requested, and explicitly granted</span><br><span class=\"line\">        mode = downloader.FastSync</span><br><span class=\"line\">    &#125; else if currentBlock.NumberU64() == 0 &amp;&amp; pm.blockchain.CurrentFastBlock().NumberU64() &gt; 0 &#123;</span><br><span class=\"line\">        // The database seems empty as the current block is the genesis. Yet the fast</span><br><span class=\"line\">        // block is ahead, so fast sync was enabled for this node at a certain point.</span><br><span class=\"line\">        // The only scenario where this can happen is if the user manually (or via a</span><br><span class=\"line\">        // bad block) rolled back a fast sync node below the sync point. In this case</span><br><span class=\"line\">        // however it&apos;s safe to reenable fast sync.</span><br><span class=\"line\">        atomic.StoreUint32(&amp;pm.fastSync, 1)</span><br><span class=\"line\">        mode = downloader.FastSync</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Run the sync cycle, and disable fast sync if we&apos;ve went past the pivot block</span><br><span class=\"line\">    if err := pm.downloader.Synchronise(peer.id, pHead, pTd, mode); err != nil &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if atomic.LoadUint32(&amp;pm.fastSync) == 1 &#123;</span><br><span class=\"line\">        log.Info(&quot;Fast sync complete, auto disabling&quot;)</span><br><span class=\"line\">        atomic.StoreUint32(&amp;pm.fastSync, 0)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    atomic.StoreUint32(&amp;pm.acceptTxs, 1) // Mark initial sync done</span><br><span class=\"line\">    if head := pm.blockchain.CurrentBlock(); head.NumberU64() &gt; 0 &#123;</span><br><span class=\"line\">        // We&apos;ve completed a sync cycle, notify all peers of new state. This path is</span><br><span class=\"line\">        // essential in star-topology networks where a gateway node needs to notify</span><br><span class=\"line\">        // all its out-of-date peers of the availability of a new block. This failure</span><br><span class=\"line\">        // scenario will most often crop up in private and hackathon networks with</span><br><span class=\"line\">        // degenerate connectivity, but it should be healthy for the mainnet too to</span><br><span class=\"line\">        // more reliably update peers or the local TD state.</span><br><span class=\"line\">        go pm.BroadcastBlock(head, false)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>TDTDpm.downloader.Synchronise(peer.id, pHead, pTd, mode)go pm.BroadcastBlock(head, false)</p>\n</li>\n<li><p>txsyncLoop</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) txsyncLoop() &#123;</span><br><span class=\"line\">    var (</span><br><span class=\"line\">        pending = make(map[discover.NodeID]*txsync)</span><br><span class=\"line\">        sending = false               // whether a send is active</span><br><span class=\"line\">        pack    = new(txsync)         // the pack that is being sent</span><br><span class=\"line\">        done    = make(chan error, 1) // result of the send</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    // send starts a sending a pack of transactions from the sync.</span><br><span class=\"line\">    send := func(s *txsync) &#123;</span><br><span class=\"line\">        // Fill pack with transactions up to the target size.</span><br><span class=\"line\">        size := common.StorageSize(0)</span><br><span class=\"line\">        pack.p = s.p</span><br><span class=\"line\">        pack.txs = pack.txs[:0]</span><br><span class=\"line\">        for i := 0; i &lt; len(s.txs) &amp;&amp; size &lt; txsyncPackSize; i++ &#123;</span><br><span class=\"line\">            pack.txs = append(pack.txs, s.txs[i])</span><br><span class=\"line\">            size += s.txs[i].Size()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Remove the transactions that will be sent.</span><br><span class=\"line\">        s.txs = s.txs[:copy(s.txs, s.txs[len(pack.txs):])]</span><br><span class=\"line\">        if len(s.txs) == 0 &#123;</span><br><span class=\"line\">            delete(pending, s.p.ID())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Send the pack in the background.</span><br><span class=\"line\">        s.p.Log().Trace(&quot;Sending batch of transactions&quot;, &quot;count&quot;, len(pack.txs), &quot;bytes&quot;, size)</span><br><span class=\"line\">        sending = true</span><br><span class=\"line\">        go func() &#123; done &lt;- pack.p.SendTransactions(pack.txs) &#125;()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // pick chooses the next pending sync.</span><br><span class=\"line\">    pick := func() *txsync &#123;</span><br><span class=\"line\">        if len(pending) == 0 &#123;</span><br><span class=\"line\">            return nil</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        n := rand.Intn(len(pending)) + 1</span><br><span class=\"line\">        for _, s := range pending &#123;</span><br><span class=\"line\">            if n--; n == 0 &#123;</span><br><span class=\"line\">                return s</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case s := &lt;-pm.txsyncCh:</span><br><span class=\"line\">            pending[s.p.ID()] = s</span><br><span class=\"line\">            if !sending &#123;</span><br><span class=\"line\">                send(s)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        case err := &lt;-done:</span><br><span class=\"line\">            sending = false</span><br><span class=\"line\">            // Stop tracking peers that cause send failures.</span><br><span class=\"line\">            if err != nil &#123;</span><br><span class=\"line\">                pack.p.Log().Debug(&quot;Transaction send failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">                delete(pending, pack.p.ID())</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the next send.</span><br><span class=\"line\">            if s := pick(); s != nil &#123;</span><br><span class=\"line\">                send(s)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        case &lt;-pm.quitSync:</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n</ul>\n<h4 id=\"fetch\"><a href=\"#fetch\" class=\"headerlink\" title=\"fetch\"></a>fetch</h4><p>fetcherdownloaderfetcher<br>pm.handleMsg  NewBlockHashesMsg</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case msg.Code == NewBlockHashesMsg:</span><br><span class=\"line\">        var announces newBlockHashesData</span><br><span class=\"line\">        if err := msg.Decode(&amp;announces); err != nil &#123;</span><br><span class=\"line\">            return errResp(ErrDecode, &quot;%v: %v&quot;, msg, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Mark the hashes as present at the remote node</span><br><span class=\"line\">        for _, block := range announces &#123;</span><br><span class=\"line\">            p.MarkBlock(block.Hash)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Schedule all the unknown hashes for retrieval</span><br><span class=\"line\">        unknown := make(newBlockHashesData, 0, len(announces))</span><br><span class=\"line\">        for _, block := range announces &#123;</span><br><span class=\"line\">            if !pm.blockchain.HasBlock(block.Hash, block.Number) &#123;</span><br><span class=\"line\">                unknown = append(unknown, block)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        for _, block := range unknown &#123;</span><br><span class=\"line\">            pm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p>newBlockHashesDatanewBlockHashesDatablockhashblocknumber<br>newBlockHashesDatapm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)blockhashblocknumberpeer.go</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) Notify(peer string, hash common.Hash, number uint64, time time.Time,</span><br><span class=\"line\">    headerFetcher headerRequesterFn, bodyFetcher bodyRequesterFn) error &#123;</span><br><span class=\"line\">    block := &amp;announce&#123;</span><br><span class=\"line\">        hash:        hash,</span><br><span class=\"line\">        number:      number,</span><br><span class=\"line\">        time:        time,</span><br><span class=\"line\">        origin:      peer,</span><br><span class=\"line\">        fetchHeader: headerFetcher,</span><br><span class=\"line\">        fetchBodies: bodyFetcher,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case f.notify &lt;- block:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return errTerminated</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Notify()announcesendf.notifyfetcherloop()f.notify receive notification, </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case notification := &lt;-f.notify:</span><br><span class=\"line\">            // A block was announced, make sure the peer isn&apos;t DOSing us</span><br><span class=\"line\">            propAnnounceInMeter.Mark(1)</span><br><span class=\"line\"></span><br><span class=\"line\">            count := f.announces[notification.origin] + 1</span><br><span class=\"line\">            if count &gt; hashLimit &#123;</span><br><span class=\"line\">                log.Debug(&quot;Peer exceeded outstanding announces&quot;, &quot;peer&quot;, notification.origin, &quot;limit&quot;, hashLimit)</span><br><span class=\"line\">                propAnnounceDOSMeter.Mark(1)</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If we have a valid block number, check that it&apos;s potentially useful</span><br><span class=\"line\">            if notification.number &gt; 0 &#123;</span><br><span class=\"line\">                if dist := int64(notification.number) - int64(f.chainHeight()); dist &lt; -maxUncleDist || dist &gt; maxQueueDist &#123;</span><br><span class=\"line\">                    log.Debug(&quot;Peer discarded announcement&quot;, &quot;peer&quot;, notification.origin, &quot;number&quot;, notification.number, &quot;hash&quot;, notification.hash, &quot;distance&quot;, dist)</span><br><span class=\"line\">                    propAnnounceDropMeter.Mark(1)</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // All is well, schedule the announce if block&apos;s not yet downloading</span><br><span class=\"line\">            if _, ok := f.fetching[notification.hash]; ok &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            if _, ok := f.completing[notification.hash]; ok &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            f.announces[notification.origin] = count</span><br><span class=\"line\">            f.announced[notification.hash] = append(f.announced[notification.hash], notification)</span><br><span class=\"line\">            if f.announceChangeHook != nil &amp;&amp; len(f.announced[notification.hash]) == 1 &#123;</span><br><span class=\"line\">                f.announceChangeHook(notification.hash, true)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            if len(f.announced) == 1 &#123;</span><br><span class=\"line\">                f.rescheduleFetch(fetchTimer)</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n\n<p>1f.fetching f.completing notification.origin announces f.announced fetch<br>2len(f.announced[notification.hash]) == 1 f.announcedf.announceChangeHook<br>3len(f.announced) == 1 fetchTimer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case &lt;-fetchTimer.C:</span><br><span class=\"line\">            // At least one block&apos;s timer ran out, check for needing retrieval</span><br><span class=\"line\">            request := make(map[string][]common.Hash)</span><br><span class=\"line\"></span><br><span class=\"line\">            for hash, announces := range f.announced &#123;</span><br><span class=\"line\">                if time.Since(announces[0].time) &gt; arriveTimeout-gatherSlack &#123;</span><br><span class=\"line\">                    // Pick a random peer to retrieve from, reset all others</span><br><span class=\"line\">                    announce := announces[rand.Intn(len(announces))]</span><br><span class=\"line\">                    f.forgetHash(hash)</span><br><span class=\"line\"></span><br><span class=\"line\">                    // If the block still didn&apos;t arrive, queue for fetching</span><br><span class=\"line\">                    if f.getBlock(hash) == nil &#123;</span><br><span class=\"line\">                        request[announce.origin] = append(request[announce.origin], hash)</span><br><span class=\"line\">                        f.fetching[hash] = announce</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Send out all block header requests</span><br><span class=\"line\">            for peer, hashes := range request &#123;</span><br><span class=\"line\">                log.Trace(&quot;Fetching scheduled headers&quot;, &quot;peer&quot;, peer, &quot;list&quot;, hashes)</span><br><span class=\"line\"></span><br><span class=\"line\">                // Create a closure of the fetch and schedule in on a new thread</span><br><span class=\"line\">                fetchHeader, hashes := f.fetching[hashes[0]].fetchHeader, hashes</span><br><span class=\"line\">                go func() &#123;</span><br><span class=\"line\">                    if f.fetchingHook != nil &#123;</span><br><span class=\"line\">                        f.fetchingHook(hashes)</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    for _, hash := range hashes &#123;</span><br><span class=\"line\">                        headerFetchMeter.Mark(1)</span><br><span class=\"line\">                        fetchHeader(hash) // Suboptimal, but protocol doesn&apos;t allow batch header retrievals</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the next fetch if blocks are still pending</span><br><span class=\"line\">            f.rescheduleFetch(fetchTimer)</span><br></pre></td></tr></table></figure>\n\n<p>1f.announcedarriveTimeout-gatherSlackhashfetcher<br>announcesannounceblockhashhashannounce<br>hashblockannouncerequestannouncef.fetching<br>2requestrequestblockhashfetchHeader(hash)header<br>fetchHeader(hash)pm.fetcher.Notifypeer.go<br><br>3 NewBlockHashesMsg fetcherfetchTimer</p>\n<p>Fetcher FilterHeaders()<br>fetchHeader(hash)peer.go RequestOneHeader(hash common.Hash)  SendGetBlockHeadersMsg <br>pm.handleMsg  BlockHashesMsg</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case msg.Code == BlockHeadersMsg:</span><br><span class=\"line\">        // A batch of headers arrived to one of our previous requests</span><br><span class=\"line\">        var headers []*types.Header</span><br><span class=\"line\">        if err := msg.Decode(&amp;headers); err != nil &#123;</span><br><span class=\"line\">            return errResp(ErrDecode, &quot;msg %v: %v&quot;, msg, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // If no headers were received, but we&apos;re expending a DAO fork check, maybe it&apos;s that</span><br><span class=\"line\">        if len(headers) == 0 &amp;&amp; p.forkDrop != nil &#123;</span><br><span class=\"line\">            // Possibly an empty reply to the fork header checks, sanity check TDs</span><br><span class=\"line\">            verifyDAO := true</span><br><span class=\"line\"></span><br><span class=\"line\">            // If we already have a DAO header, we can check the peer&apos;s TD against it. If</span><br><span class=\"line\">            // the peer&apos;s ahead of this, it too must have a reply to the DAO check</span><br><span class=\"line\">            if daoHeader := pm.blockchain.GetHeaderByNumber(pm.chainconfig.DAOForkBlock.Uint64()); daoHeader != nil &#123;</span><br><span class=\"line\">                if _, td := p.Head(); td.Cmp(pm.blockchain.GetTd(daoHeader.Hash(), daoHeader.Number.Uint64())) &gt;= 0 &#123;</span><br><span class=\"line\">                    verifyDAO = false</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If we&apos;re seemingly on the same chain, disable the drop timer</span><br><span class=\"line\">            if verifyDAO &#123;</span><br><span class=\"line\">                p.Log().Debug(&quot;Seems to be on the same side of the DAO fork&quot;)</span><br><span class=\"line\">                p.forkDrop.Stop()</span><br><span class=\"line\">                p.forkDrop = nil</span><br><span class=\"line\">                return nil</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Filter out any explicitly requested headers, deliver the rest to the downloader</span><br><span class=\"line\">        filter := len(headers) == 1</span><br><span class=\"line\">        if filter &#123;</span><br><span class=\"line\">            // If it&apos;s a potential DAO fork check, validate against the rules</span><br><span class=\"line\">            if p.forkDrop != nil &amp;&amp; pm.chainconfig.DAOForkBlock.Cmp(headers[0].Number) == 0 &#123;</span><br><span class=\"line\">                // Disable the fork drop timer</span><br><span class=\"line\">                p.forkDrop.Stop()</span><br><span class=\"line\">                p.forkDrop = nil</span><br><span class=\"line\"></span><br><span class=\"line\">                // Validate the header and either drop the peer or continue</span><br><span class=\"line\">                if err := misc.VerifyDAOHeaderExtraData(pm.chainconfig, headers[0]); err != nil &#123;</span><br><span class=\"line\">                    p.Log().Debug(&quot;Verified to be on the other side of the DAO fork, dropping&quot;)</span><br><span class=\"line\">                    return err</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                p.Log().Debug(&quot;Verified to be on the same side of the DAO fork&quot;)</span><br><span class=\"line\">                return nil</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Irrelevant of the fork checks, send the header to the fetcher just in case</span><br><span class=\"line\">            headers = pm.fetcher.FilterHeaders(p.id, headers, time.Now())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if len(headers) &gt; 0 || !filter &#123;</span><br><span class=\"line\">            err := pm.downloader.DeliverHeaders(p.id, headers)</span><br><span class=\"line\">            if err != nil &#123;</span><br><span class=\"line\">                log.Debug(&quot;Failed to deliver headers&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p>daoHeaderlen(headers) == 1pm.fetcher.FilterHeaders(p.id, headers, time.Now())</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) FilterHeaders(peer string, headers []*types.Header, time time.Time) []*types.Header &#123;</span><br><span class=\"line\">    log.Trace(&quot;Filtering headers&quot;, &quot;peer&quot;, peer, &quot;headers&quot;, len(headers))</span><br><span class=\"line\"></span><br><span class=\"line\">    // Send the filter channel to the fetcher</span><br><span class=\"line\">    filter := make(chan *headerFilterTask)</span><br><span class=\"line\"></span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case f.headerFilter &lt;- filter:</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Request the filtering of the header list</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case filter &lt;- &amp;headerFilterTask&#123;peer: peer, headers: headers, time: time&#125;:</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Retrieve the headers remaining after filtering</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case task := &lt;-filter:</span><br><span class=\"line\">        return task.headers</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>send filter f.headerFilterfetcherloop()f.headerFilter receive filter</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case filter := &lt;-f.headerFilter:</span><br><span class=\"line\">            // Headers arrived from a remote peer. Extract those that were explicitly</span><br><span class=\"line\">            // requested by the fetcher, and return everything else so it&apos;s delivered</span><br><span class=\"line\">            // to other parts of the system.</span><br><span class=\"line\">            var task *headerFilterTask</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case task = &lt;-filter:</span><br><span class=\"line\">            case &lt;-f.quit:</span><br><span class=\"line\">                return</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headerFilterInMeter.Mark(int64(len(task.headers)))</span><br><span class=\"line\"></span><br><span class=\"line\">            // Split the batch of headers into unknown ones (to return to the caller),</span><br><span class=\"line\">            // known incomplete ones (requiring body retrievals) and completed blocks.</span><br><span class=\"line\">            unknown, incomplete, complete := []*types.Header&#123;&#125;, []*announce&#123;&#125;, []*types.Block&#123;&#125;</span><br><span class=\"line\">            for _, header := range task.headers &#123;</span><br><span class=\"line\">                hash := header.Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">                // Filter fetcher-requested headers from other synchronisation algorithms</span><br><span class=\"line\">                if announce := f.fetching[hash]; announce != nil &amp;&amp; announce.origin == task.peer &amp;&amp; f.fetched[hash] == nil &amp;&amp; f.completing[hash] == nil &amp;&amp; f.queued[hash] == nil &#123;</span><br><span class=\"line\">                    // If the delivered header does not match the promised number, drop the announcer</span><br><span class=\"line\">                    if header.Number.Uint64() != announce.number &#123;</span><br><span class=\"line\">                        log.Trace(&quot;Invalid block number fetched&quot;, &quot;peer&quot;, announce.origin, &quot;hash&quot;, header.Hash(), &quot;announced&quot;, announce.number, &quot;provided&quot;, header.Number)</span><br><span class=\"line\">                        f.dropPeer(announce.origin)</span><br><span class=\"line\">                        f.forgetHash(hash)</span><br><span class=\"line\">                        continue</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // Only keep if not imported by other means</span><br><span class=\"line\">                    if f.getBlock(hash) == nil &#123;</span><br><span class=\"line\">                        announce.header = header</span><br><span class=\"line\">                        announce.time = task.time</span><br><span class=\"line\"></span><br><span class=\"line\">                        // If the block is empty (header only), short circuit into the final import queue</span><br><span class=\"line\">                        if header.TxHash == types.DeriveSha(types.Transactions&#123;&#125;) &amp;&amp; header.UncleHash == types.CalcUncleHash([]*types.Header&#123;&#125;) &#123;</span><br><span class=\"line\">                            log.Trace(&quot;Block empty, skipping body retrieval&quot;, &quot;peer&quot;, announce.origin, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())</span><br><span class=\"line\"></span><br><span class=\"line\">                            block := types.NewBlockWithHeader(header)</span><br><span class=\"line\">                            block.ReceivedAt = task.time</span><br><span class=\"line\"></span><br><span class=\"line\">                            complete = append(complete, block)</span><br><span class=\"line\">                            f.completing[hash] = announce</span><br><span class=\"line\">                            continue</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        // Otherwise add to the list of blocks needing completion</span><br><span class=\"line\">                        incomplete = append(incomplete, announce)</span><br><span class=\"line\">                    &#125; else &#123;</span><br><span class=\"line\">                        log.Trace(&quot;Block already imported, discarding header&quot;, &quot;peer&quot;, announce.origin, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())</span><br><span class=\"line\">                        f.forgetHash(hash)</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; else &#123;</span><br><span class=\"line\">                    // Fetcher doesn&apos;t know about it, add to the return list</span><br><span class=\"line\">                    unknown = append(unknown, header)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headerFilterOutMeter.Mark(int64(len(unknown)))</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case filter &lt;- &amp;headerFilterTask&#123;headers: unknown, time: task.time&#125;:</span><br><span class=\"line\">            case &lt;-f.quit:</span><br><span class=\"line\">                return</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the retrieved headers for body completion</span><br><span class=\"line\">            for _, announce := range incomplete &#123;</span><br><span class=\"line\">                hash := announce.header.Hash()</span><br><span class=\"line\">                if _, ok := f.completing[hash]; ok &#123;</span><br><span class=\"line\">                    continue</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                f.fetched[hash] = append(f.fetched[hash], announce)</span><br><span class=\"line\">                if len(f.fetched) == 1 &#123;</span><br><span class=\"line\">                    f.rescheduleComplete(completeTimer)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the header-only blocks for import</span><br><span class=\"line\">            for _, block := range complete &#123;</span><br><span class=\"line\">                if announce := f.completing[block.Hash()]; announce != nil &#123;</span><br><span class=\"line\">                    f.enqueue(announce.origin, block)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n\n<p>1headerFilterheader f.fetchingf.fetched f.completingunknown filterFilterHeaderstask filterFilterHeaders<br>2headernumberf.fetchingannouncenumberhash<br>3hashblockhashblockhashcompletef.completingincomplete<br>4incompletef.completingf.fetchedcompleteTimer<br>5completef.completingf.enqueue(announce.origin, block)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case &lt;-completeTimer.C:</span><br><span class=\"line\">            // At least one header&apos;s timer ran out, retrieve everything</span><br><span class=\"line\">            request := make(map[string][]common.Hash)</span><br><span class=\"line\"></span><br><span class=\"line\">            for hash, announces := range f.fetched &#123;</span><br><span class=\"line\">                // Pick a random peer to retrieve from, reset all others</span><br><span class=\"line\">                announce := announces[rand.Intn(len(announces))]</span><br><span class=\"line\">                f.forgetHash(hash)</span><br><span class=\"line\"></span><br><span class=\"line\">                // If the block still didn&apos;t arrive, queue for completion</span><br><span class=\"line\">                if f.getBlock(hash) == nil &#123;</span><br><span class=\"line\">                    request[announce.origin] = append(request[announce.origin], hash)</span><br><span class=\"line\">                    f.completing[hash] = announce</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Send out all block body requests</span><br><span class=\"line\">            for peer, hashes := range request &#123;</span><br><span class=\"line\">                log.Trace(&quot;Fetching scheduled bodies&quot;, &quot;peer&quot;, peer, &quot;list&quot;, hashes)</span><br><span class=\"line\"></span><br><span class=\"line\">                // Create a closure of the fetch and schedule in on a new thread</span><br><span class=\"line\">                if f.completingHook != nil &#123;</span><br><span class=\"line\">                    f.completingHook(hashes)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                bodyFetchMeter.Mark(int64(len(hashes)))</span><br><span class=\"line\">                go f.completing[hashes[0]].fetchBodies(hashes)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the next fetch if blocks are still pending</span><br><span class=\"line\">            f.rescheduleComplete(completeTimer)</span><br></pre></td></tr></table></figure>\n\n<p>1f.fetchedhashfetcher<br>hashblockannouncerequestannouncef.completing<br>2requestrequestblockhashfetchBodies(hashes)bodyfetchBodies(hashes)peer.go<br>3 BlockHashesMsg fetchercompleteTimer</p>\n<p>Fetcher FilterBodies() Enqueue(<br>1fetchBodies(hash)peer.go RequestBodies(hashes []common.Hash) SendGetBlockBodiesMsg <br>2pm.handleMsg  BlockBodiesMsg<br>3 pm.fetcher.FilterBodies(p.id, trasactions, uncles, time.Now())<br>FilterHeaders()<br>4FilterBodies()timer<br>5FilterHeaders()FilterBodies()f.enqueue(announce.origin, block)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) enqueue(peer string, block *types.Block) &#123;</span><br><span class=\"line\">    hash := block.Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Ensure the peer isn&apos;t DOSing us</span><br><span class=\"line\">    count := f.queues[peer] + 1</span><br><span class=\"line\">    if count &gt; blockLimit &#123;</span><br><span class=\"line\">        log.Debug(&quot;Discarded propagated block, exceeded allowance&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;limit&quot;, blockLimit)</span><br><span class=\"line\">        propBroadcastDOSMeter.Mark(1)</span><br><span class=\"line\">        f.forgetHash(hash)</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Discard any past or too distant blocks</span><br><span class=\"line\">    if dist := int64(block.NumberU64()) - int64(f.chainHeight()); dist &lt; -maxUncleDist || dist &gt; maxQueueDist &#123;</span><br><span class=\"line\">        log.Debug(&quot;Discarded propagated block, too far away&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;distance&quot;, dist)</span><br><span class=\"line\">        propBroadcastDropMeter.Mark(1)</span><br><span class=\"line\">        f.forgetHash(hash)</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Schedule the block for future importing</span><br><span class=\"line\">    if _, ok := f.queued[hash]; !ok &#123;</span><br><span class=\"line\">        op := &amp;inject&#123;</span><br><span class=\"line\">            origin: peer,</span><br><span class=\"line\">            block:  block,</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        f.queues[peer] = count</span><br><span class=\"line\">        f.queued[hash] = op</span><br><span class=\"line\">        f.queue.Push(op, -float32(block.NumberU64()))</span><br><span class=\"line\">        if f.queueChangeHook != nil &#123;</span><br><span class=\"line\">            f.queueChangeHook(op.block.Hash(), true)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.Debug(&quot;Queued propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;queued&quot;, f.queue.Size())</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>hashf.queue<br>loopf.queueblock insertblock chain</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) insert(peer string, block *types.Block) &#123;</span><br><span class=\"line\">    hash := block.Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Run the import on a new thread</span><br><span class=\"line\">    log.Debug(&quot;Importing propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash)</span><br><span class=\"line\">    go func() &#123;</span><br><span class=\"line\">        defer func() &#123; f.done &lt;- hash &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">        // If the parent&apos;s unknown, abort insertion</span><br><span class=\"line\">        parent := f.getBlock(block.ParentHash())</span><br><span class=\"line\">        if parent == nil &#123;</span><br><span class=\"line\">            log.Debug(&quot;Unknown parent of propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;parent&quot;, block.ParentHash())</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Quickly validate the header and propagate the block if it passes</span><br><span class=\"line\">        switch err := f.verifyHeader(block.Header()); err &#123;</span><br><span class=\"line\">        case nil:</span><br><span class=\"line\">            // All ok, quickly propagate to our peers</span><br><span class=\"line\">            propBroadcastOutTimer.UpdateSince(block.ReceivedAt)</span><br><span class=\"line\">            go f.broadcastBlock(block, true)</span><br><span class=\"line\"></span><br><span class=\"line\">        case consensus.ErrFutureBlock:</span><br><span class=\"line\">            // Weird future block, don&apos;t fail, but neither propagate</span><br><span class=\"line\"></span><br><span class=\"line\">        default:</span><br><span class=\"line\">            // Something went very wrong, drop the peer</span><br><span class=\"line\">            log.Debug(&quot;Propagated block verification failed&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;err&quot;, err)</span><br><span class=\"line\">            f.dropPeer(peer)</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Run the actual import and log any issues</span><br><span class=\"line\">        if _, err := f.insertChain(types.Blocks&#123;block&#125;); err != nil &#123;</span><br><span class=\"line\">            log.Debug(&quot;Propagated block import failed&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;err&quot;, err)</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // If import succeeded, broadcast the block</span><br><span class=\"line\">        propAnnounceOutTimer.UpdateSince(block.ReceivedAt)</span><br><span class=\"line\">        go f.broadcastBlock(block, false)</span><br><span class=\"line\"></span><br><span class=\"line\">        // Invoke the testing hook if needed</span><br><span class=\"line\">        if f.importedHook != nil &#123;</span><br><span class=\"line\">            f.importedHook(block)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>f.verifyHeader(block.Header())blockHeader<br><br>f.insertChain(types.Blocks{block}) <br>()blockhash</p>\n<p><br>fetcher.go </p>\n<h4 id=\"Downloader\"><a href=\"#Downloader\" class=\"headerlink\" title=\"Downloader\"></a>Downloader</h4><p>Downloader<br>ProtocolManagerDownloader</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func New(mode SyncMode, stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn) *Downloader &#123;</span><br><span class=\"line\">    if lightchain == nil &#123;</span><br><span class=\"line\">        lightchain = chain</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    dl := &amp;Downloader&#123;</span><br><span class=\"line\">        mode:           mode,</span><br><span class=\"line\">        stateDB:        stateDb,</span><br><span class=\"line\">        mux:            mux,</span><br><span class=\"line\">        queue:          newQueue(),</span><br><span class=\"line\">        peers:          newPeerSet(),</span><br><span class=\"line\">        rttEstimate:    uint64(rttMaxEstimate),</span><br><span class=\"line\">        rttConfidence:  uint64(1000000),</span><br><span class=\"line\">        blockchain:     chain,</span><br><span class=\"line\">        lightchain:     lightchain,</span><br><span class=\"line\">        dropPeer:       dropPeer,</span><br><span class=\"line\">        headerCh:       make(chan dataPack, 1),</span><br><span class=\"line\">        bodyCh:         make(chan dataPack, 1),</span><br><span class=\"line\">        receiptCh:      make(chan dataPack, 1),</span><br><span class=\"line\">        bodyWakeCh:     make(chan bool, 1),</span><br><span class=\"line\">        receiptWakeCh:  make(chan bool, 1),</span><br><span class=\"line\">        headerProcCh:   make(chan []*types.Header, 1),</span><br><span class=\"line\">        quitCh:         make(chan struct&#123;&#125;),</span><br><span class=\"line\">        stateCh:        make(chan dataPack),</span><br><span class=\"line\">        stateSyncStart: make(chan *stateSync),</span><br><span class=\"line\">        trackStateReq:  make(chan *stateReq),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    go dl.qosTuner()</span><br><span class=\"line\">    go dl.stateFetcher()</span><br><span class=\"line\">    return dl</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Downloaderdl.qosTuner() goroutinedl.stateFetcher() goroutine Downloader</p>\n<p>ProtocolManagerP2PProtocolManager synchronise(peer *peer)DownloaderSynchronise(peer.id, pHead, pTd, mode)</p>\n<p>Synchronised.queued.peersd.bodyWakeCh, d.receiptWakeChd.headerCh, d.bodyCh, d.receiptChd.headerProcChd.syncWithPeer(p, hash, td)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) syncWithPeer(p *peerConnection, hash common.Hash, td *big.Int) (err error) &#123;</span><br><span class=\"line\">    d.mux.Post(StartEvent&#123;&#125;)</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        // reset on error</span><br><span class=\"line\">        if err != nil &#123;</span><br><span class=\"line\">            d.mux.Post(FailedEvent&#123;err&#125;)</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            d.mux.Post(DoneEvent&#123;&#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    if p.version &lt; 62 &#123;</span><br><span class=\"line\">        return errTooOld</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    log.Debug(&quot;Synchronising with the network&quot;, &quot;peer&quot;, p.id, &quot;eth&quot;, p.version, &quot;head&quot;, hash, &quot;td&quot;, td, &quot;mode&quot;, d.mode)</span><br><span class=\"line\">    defer func(start time.Time) &#123;</span><br><span class=\"line\">        log.Debug(&quot;Synchronisation terminated&quot;, &quot;elapsed&quot;, time.Since(start))</span><br><span class=\"line\">    &#125;(time.Now())</span><br><span class=\"line\"></span><br><span class=\"line\">    // Look up the sync boundaries: the common ancestor and the target block</span><br><span class=\"line\">    latest, err := d.fetchHeight(p)</span><br><span class=\"line\">    if err != nil &#123;</span><br><span class=\"line\">        return err</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    height := latest.Number.Uint64()</span><br><span class=\"line\"></span><br><span class=\"line\">    origin, err := d.findAncestor(p, height)</span><br><span class=\"line\">    if err != nil &#123;</span><br><span class=\"line\">        return err</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    d.syncStatsLock.Lock()</span><br><span class=\"line\">    if d.syncStatsChainHeight &lt;= origin || d.syncStatsChainOrigin &gt; origin &#123;</span><br><span class=\"line\">        d.syncStatsChainOrigin = origin</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    d.syncStatsChainHeight = height</span><br><span class=\"line\">    d.syncStatsLock.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Ensure our origin point is below any fast sync pivot point</span><br><span class=\"line\">    pivot := uint64(0)</span><br><span class=\"line\">    if d.mode == FastSync &#123;</span><br><span class=\"line\">        if height &lt;= uint64(fsMinFullBlocks) &#123;</span><br><span class=\"line\">            origin = 0</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            pivot = height - uint64(fsMinFullBlocks)</span><br><span class=\"line\">            if pivot &lt;= origin &#123;</span><br><span class=\"line\">                origin = pivot - 1</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    d.committed = 1</span><br><span class=\"line\">    if d.mode == FastSync &amp;&amp; pivot != 0 &#123;</span><br><span class=\"line\">        d.committed = 0</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Initiate the sync using a concurrent header and content retrieval algorithm</span><br><span class=\"line\">    d.queue.Prepare(origin+1, d.mode)</span><br><span class=\"line\">    if d.syncInitHook != nil &#123;</span><br><span class=\"line\">        d.syncInitHook(origin, height)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fetchers := []func() error&#123;</span><br><span class=\"line\">        func() error &#123; return d.fetchHeaders(p, origin+1, pivot) &#125;, // Headers are always retrieved</span><br><span class=\"line\">        func() error &#123; return d.fetchBodies(origin + 1) &#125;,          // Bodies are retrieved during normal and fast sync</span><br><span class=\"line\">        func() error &#123; return d.fetchReceipts(origin + 1) &#125;,        // Receipts are retrieved during fast sync</span><br><span class=\"line\">        func() error &#123; return d.processHeaders(origin+1, pivot, td) &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if d.mode == FastSync &#123;</span><br><span class=\"line\">        fetchers = append(fetchers, func() error &#123; return d.processFastSyncContent(latest) &#125;)</span><br><span class=\"line\">    &#125; else if d.mode == FullSync &#123;</span><br><span class=\"line\">        fetchers = append(fetchers, d.processFullSyncContent)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return d.spawnSync(fetchers)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>latest, err := d.fetchHeight(p)peer,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) fetchHeight(p *peerConnection) (*types.Header, error) &#123;</span><br><span class=\"line\">    p.log.Debug(&quot;Retrieving remote chain height&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Request the advertised remote head block and wait for the response</span><br><span class=\"line\">    head, _ := p.peer.Head()</span><br><span class=\"line\">    go p.peer.RequestHeadersByHash(head, 1, 0, false)</span><br><span class=\"line\"></span><br><span class=\"line\">    ttl := d.requestTTL()</span><br><span class=\"line\">    timeout := time.After(ttl)</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return nil, errCancelBlockFetch</span><br><span class=\"line\"></span><br><span class=\"line\">        case packet := &lt;-d.headerCh:</span><br><span class=\"line\">            // Discard anything not from the origin peer</span><br><span class=\"line\">            if packet.PeerId() != p.id &#123;</span><br><span class=\"line\">                log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Make sure the peer actually gave something valid</span><br><span class=\"line\">            headers := packet.(*headerPack).headers</span><br><span class=\"line\">            if len(headers) != 1 &#123;</span><br><span class=\"line\">                p.log.Debug(&quot;Multiple headers for single request&quot;, &quot;headers&quot;, len(headers))</span><br><span class=\"line\">                return nil, errBadPeer</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            head := headers[0]</span><br><span class=\"line\">            p.log.Debug(&quot;Remote head header identified&quot;, &quot;number&quot;, head.Number, &quot;hash&quot;, head.Hash())</span><br><span class=\"line\">            return head, nil</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-timeout:</span><br><span class=\"line\">            p.log.Debug(&quot;Waiting for head header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">            return nil, errTimeout</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-d.bodyCh:</span><br><span class=\"line\">        case &lt;-d.receiptCh:</span><br><span class=\"line\">            // Out of bounds delivery, ignore</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1peer.RequestHeadersByHash(head, 1, 0, false)GetBlockHeadersMsg<br>2d.headerChtimeout<br>3BlockHeadersMsg<br>4downloader.DeliverHeaders(p.id, headers)<br>5p.idheadersd.headerCh<br>6selectd.headerChheader</p>\n<p>syncWithPeer()  d.findAncestor(p, height)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) findAncestor(p *peerConnection, height uint64) (uint64, error) &#123;</span><br><span class=\"line\">    // Figure out the valid ancestor range to prevent rewrite attacks</span><br><span class=\"line\">    floor, ceil := int64(-1), d.lightchain.CurrentHeader().Number.Uint64()</span><br><span class=\"line\"></span><br><span class=\"line\">    if d.mode == FullSync &#123;</span><br><span class=\"line\">        ceil = d.blockchain.CurrentBlock().NumberU64()</span><br><span class=\"line\">    &#125; else if d.mode == FastSync &#123;</span><br><span class=\"line\">        ceil = d.blockchain.CurrentFastBlock().NumberU64()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if ceil &gt;= MaxForkAncestry &#123;</span><br><span class=\"line\">        floor = int64(ceil - MaxForkAncestry)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    p.log.Debug(&quot;Looking for common ancestor&quot;, &quot;local&quot;, ceil, &quot;remote&quot;, height)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Request the topmost blocks to short circuit binary ancestor lookup</span><br><span class=\"line\">    head := ceil</span><br><span class=\"line\">    if head &gt; height &#123;</span><br><span class=\"line\">        head = height</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    from := int64(head) - int64(MaxHeaderFetch)</span><br><span class=\"line\">    if from &lt; 0 &#123;</span><br><span class=\"line\">        from = 0</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Span out with 15 block gaps into the future to catch bad head reports</span><br><span class=\"line\">    limit := 2 * MaxHeaderFetch / 16</span><br><span class=\"line\">    count := 1 + int((int64(ceil)-from)/16)</span><br><span class=\"line\">    if count &gt; limit &#123;</span><br><span class=\"line\">        count = limit</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    go p.peer.RequestHeadersByNumber(uint64(from), count, 15, false)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Wait for the remote response to the head fetch</span><br><span class=\"line\">    number, hash := uint64(0), common.Hash&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ttl := d.requestTTL()</span><br><span class=\"line\">    timeout := time.After(ttl)</span><br><span class=\"line\"></span><br><span class=\"line\">    for finished := false; !finished; &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return 0, errCancelHeaderFetch</span><br><span class=\"line\"></span><br><span class=\"line\">        case packet := &lt;-d.headerCh:</span><br><span class=\"line\">            // Discard anything not from the origin peer</span><br><span class=\"line\">            if packet.PeerId() != p.id &#123;</span><br><span class=\"line\">                log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Make sure the peer actually gave something valid</span><br><span class=\"line\">            headers := packet.(*headerPack).headers</span><br><span class=\"line\">            if len(headers) == 0 &#123;</span><br><span class=\"line\">                p.log.Warn(&quot;Empty head header set&quot;)</span><br><span class=\"line\">                return 0, errEmptyHeaderSet</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Make sure the peer&apos;s reply conforms to the request</span><br><span class=\"line\">            for i := 0; i &lt; len(headers); i++ &#123;</span><br><span class=\"line\">                if number := headers[i].Number.Int64(); number != from+int64(i)*16 &#123;</span><br><span class=\"line\">                    p.log.Warn(&quot;Head headers broke chain ordering&quot;, &quot;index&quot;, i, &quot;requested&quot;, from+int64(i)*16, &quot;received&quot;, number)</span><br><span class=\"line\">                    return 0, errInvalidChain</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Check if a common ancestor was found</span><br><span class=\"line\">            finished = true</span><br><span class=\"line\">            for i := len(headers) - 1; i &gt;= 0; i-- &#123;</span><br><span class=\"line\">                // Skip any headers that underflow/overflow our requested set</span><br><span class=\"line\">                if headers[i].Number.Int64() &lt; from || headers[i].Number.Uint64() &gt; ceil &#123;</span><br><span class=\"line\">                    continue</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Otherwise check if we already know the header or not</span><br><span class=\"line\">                if (d.mode == FullSync &amp;&amp; d.blockchain.HasBlock(headers[i].Hash(), headers[i].Number.Uint64())) || (d.mode != FullSync &amp;&amp; d.lightchain.HasHeader(headers[i].Hash(), headers[i].Number.Uint64())) &#123;</span><br><span class=\"line\">                    number, hash = headers[i].Number.Uint64(), headers[i].Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">                    // If every header is known, even future ones, the peer straight out lied about its head</span><br><span class=\"line\">                    if number &gt; height &amp;&amp; i == limit-1 &#123;</span><br><span class=\"line\">                        p.log.Warn(&quot;Lied about chain head&quot;, &quot;reported&quot;, height, &quot;found&quot;, number)</span><br><span class=\"line\">                        return 0, errStallingPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-timeout:</span><br><span class=\"line\">            p.log.Debug(&quot;Waiting for head header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">            return 0, errTimeout</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-d.bodyCh:</span><br><span class=\"line\">        case &lt;-d.receiptCh:</span><br><span class=\"line\">            // Out of bounds delivery, ignore</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // If the head fetch already found an ancestor, return</span><br><span class=\"line\">    if !common.EmptyHash(hash) &#123;</span><br><span class=\"line\">        if int64(number) &lt;= floor &#123;</span><br><span class=\"line\">            p.log.Warn(&quot;Ancestor below allowance&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash, &quot;allowance&quot;, floor)</span><br><span class=\"line\">            return 0, errInvalidAncestor</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        p.log.Debug(&quot;Found common ancestor&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash)</span><br><span class=\"line\">        return number, nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Ancestor not found, we need to binary search over our chain</span><br><span class=\"line\">    start, end := uint64(0), head</span><br><span class=\"line\">    if floor &gt; 0 &#123;</span><br><span class=\"line\">        start = uint64(floor)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    for start+1 &lt; end &#123;</span><br><span class=\"line\">        // Split our chain interval in two, and request the hash to cross check</span><br><span class=\"line\">        check := (start + end) / 2</span><br><span class=\"line\"></span><br><span class=\"line\">        ttl := d.requestTTL()</span><br><span class=\"line\">        timeout := time.After(ttl)</span><br><span class=\"line\"></span><br><span class=\"line\">        go p.peer.RequestHeadersByNumber(check, 1, 0, false)</span><br><span class=\"line\"></span><br><span class=\"line\">        // Wait until a reply arrives to this request</span><br><span class=\"line\">        for arrived := false; !arrived; &#123;</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case &lt;-d.cancelCh:</span><br><span class=\"line\">                return 0, errCancelHeaderFetch</span><br><span class=\"line\"></span><br><span class=\"line\">            case packer := &lt;-d.headerCh:</span><br><span class=\"line\">                // Discard anything not from the origin peer</span><br><span class=\"line\">                if packer.PeerId() != p.id &#123;</span><br><span class=\"line\">                    log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packer.PeerId())</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Make sure the peer actually gave something valid</span><br><span class=\"line\">                headers := packer.(*headerPack).headers</span><br><span class=\"line\">                if len(headers) != 1 &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;Multiple headers for single request&quot;, &quot;headers&quot;, len(headers))</span><br><span class=\"line\">                    return 0, errBadPeer</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                arrived = true</span><br><span class=\"line\"></span><br><span class=\"line\">                // Modify the search interval based on the response</span><br><span class=\"line\">                if (d.mode == FullSync &amp;&amp; !d.blockchain.HasBlock(headers[0].Hash(), headers[0].Number.Uint64())) || (d.mode != FullSync &amp;&amp; !d.lightchain.HasHeader(headers[0].Hash(), headers[0].Number.Uint64())) &#123;</span><br><span class=\"line\">                    end = check</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                header := d.lightchain.GetHeaderByHash(headers[0].Hash()) // Independent of sync mode, header surely exists</span><br><span class=\"line\">                if header.Number.Uint64() != check &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;Received non requested header&quot;, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash(), &quot;request&quot;, check)</span><br><span class=\"line\">                    return 0, errBadPeer</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                start = check</span><br><span class=\"line\"></span><br><span class=\"line\">            case &lt;-timeout:</span><br><span class=\"line\">                p.log.Debug(&quot;Waiting for search header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">                return 0, errTimeout</span><br><span class=\"line\"></span><br><span class=\"line\">            case &lt;-d.bodyCh:</span><br><span class=\"line\">            case &lt;-d.receiptCh:</span><br><span class=\"line\">                // Out of bounds delivery, ignore</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Ensure valid ancestry and return</span><br><span class=\"line\">    if int64(start) &lt;= floor &#123;</span><br><span class=\"line\">        p.log.Warn(&quot;Ancestor below allowance&quot;, &quot;number&quot;, start, &quot;hash&quot;, hash, &quot;allowance&quot;, floor)</span><br><span class=\"line\">        return 0, errInvalidAncestor</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    p.log.Debug(&quot;Found common ancestor&quot;, &quot;number&quot;, start, &quot;hash&quot;, hash)</span><br><span class=\"line\">    return start, nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1peer.RequestHeadersByNumber(uint64(from), count, 15, false)header count 15header19216selectd.headerCh<br>2selectheadersheaderheadernumber<br>3MaxForkAncestryheader0.</p>\n<p>syncWithPeer()pivotd.spawnSync(fetchers)d.spawnSync(fetchers)</p>\n<p>Downloader<br>fetchHeaders()fetchBodies() , fetchReceipts()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) fetchHeaders(p *peerConnection, from uint64, pivot uint64) error &#123;</span><br><span class=\"line\">    p.log.Debug(&quot;Directing header downloads&quot;, &quot;origin&quot;, from)</span><br><span class=\"line\">    defer p.log.Debug(&quot;Header download terminated&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Create a timeout timer, and the associated header fetcher</span><br><span class=\"line\">    skeleton := true            // Skeleton assembly phase or finishing up</span><br><span class=\"line\">    request := time.Now()       // time of the last skeleton fetch request</span><br><span class=\"line\">    timeout := time.NewTimer(0) // timer to dump a non-responsive active peer</span><br><span class=\"line\">    &lt;-timeout.C                 // timeout channel should be initially empty</span><br><span class=\"line\">    defer timeout.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">    var ttl time.Duration</span><br><span class=\"line\">    getHeaders := func(from uint64) &#123;</span><br><span class=\"line\">        request = time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">        ttl = d.requestTTL()</span><br><span class=\"line\">        timeout.Reset(ttl)</span><br><span class=\"line\"></span><br><span class=\"line\">        if skeleton &#123;</span><br><span class=\"line\">            p.log.Trace(&quot;Fetching skeleton headers&quot;, &quot;count&quot;, MaxHeaderFetch, &quot;from&quot;, from)</span><br><span class=\"line\">            go p.peer.RequestHeadersByNumber(from+uint64(MaxHeaderFetch)-1, MaxSkeletonSize, MaxHeaderFetch-1, false)</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            p.log.Trace(&quot;Fetching full headers&quot;, &quot;count&quot;, MaxHeaderFetch, &quot;from&quot;, from)</span><br><span class=\"line\">            go p.peer.RequestHeadersByNumber(from, MaxHeaderFetch, 0, false)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Start pulling the header chain skeleton until all is done</span><br><span class=\"line\">    getHeaders(from)</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return errCancelHeaderFetch</span><br><span class=\"line\"></span><br><span class=\"line\">        case packet := &lt;-d.headerCh:</span><br><span class=\"line\">            // Make sure the active peer is giving us the skeleton headers</span><br><span class=\"line\">            if packet.PeerId() != p.id &#123;</span><br><span class=\"line\">                log.Debug(&quot;Received skeleton from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headerReqTimer.UpdateSince(request)</span><br><span class=\"line\">            timeout.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">            // If the skeleton&apos;s finished, pull any remaining head headers directly from the origin</span><br><span class=\"line\">            if packet.Items() == 0 &amp;&amp; skeleton &#123;</span><br><span class=\"line\">                skeleton = false</span><br><span class=\"line\">                getHeaders(from)</span><br><span class=\"line\">                continue</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If no more headers are inbound, notify the content fetchers and return</span><br><span class=\"line\">            if packet.Items() == 0 &#123;</span><br><span class=\"line\">                // Don&apos;t abort header fetches while the pivot is downloading</span><br><span class=\"line\">                if atomic.LoadInt32(&amp;d.committed) == 0 &amp;&amp; pivot &lt;= from &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;No headers, waiting for pivot commit&quot;)</span><br><span class=\"line\">                    select &#123;</span><br><span class=\"line\">                    case &lt;-time.After(fsHeaderContCheck):</span><br><span class=\"line\">                        getHeaders(from)</span><br><span class=\"line\">                        continue</span><br><span class=\"line\">                    case &lt;-d.cancelCh:</span><br><span class=\"line\">                        return errCancelHeaderFetch</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Pivot done (or not in fast sync) and no more headers, terminate the process</span><br><span class=\"line\">                p.log.Debug(&quot;No more headers available&quot;)</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case d.headerProcCh &lt;- nil:</span><br><span class=\"line\">                    return nil</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                    return errCancelHeaderFetch</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headers := packet.(*headerPack).headers</span><br><span class=\"line\"></span><br><span class=\"line\">            // If we received a skeleton batch, resolve internals concurrently</span><br><span class=\"line\">            if skeleton &#123;</span><br><span class=\"line\">                filled, proced, err := d.fillHeaderSkeleton(from, headers)</span><br><span class=\"line\">                if err != nil &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;Skeleton chain invalid&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">                    return errInvalidChain</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                headers = filled[proced:]</span><br><span class=\"line\">                from += uint64(proced)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Insert all the new headers and fetch the next batch</span><br><span class=\"line\">            if len(headers) &gt; 0 &#123;</span><br><span class=\"line\">                p.log.Trace(&quot;Scheduling new headers&quot;, &quot;count&quot;, len(headers), &quot;from&quot;, from)</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case d.headerProcCh &lt;- headers:</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                    return errCancelHeaderFetch</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                from += uint64(len(headers))</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            getHeaders(from)</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-timeout.C:</span><br><span class=\"line\">            if d.dropPeer == nil &#123;</span><br><span class=\"line\">                // The dropPeer method is nil when `--copydb` is used for a local copy.</span><br><span class=\"line\">                // Timeouts can occur if e.g. compaction hits at the wrong time, and can be ignored</span><br><span class=\"line\">                p.log.Warn(&quot;Downloader wants to drop peer, but peerdrop-function is not set&quot;, &quot;peer&quot;, p.id)</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Header retrieval timed out, consider the peer bad and drop</span><br><span class=\"line\">            p.log.Debug(&quot;Header request timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">            headerTimeoutMeter.Mark(1)</span><br><span class=\"line\">            d.dropPeer(p.id)</span><br><span class=\"line\"></span><br><span class=\"line\">            // Finish the sync gracefully instead of dumping the gathered data though</span><br><span class=\"line\">            for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case ch &lt;- false:</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case d.headerProcCh &lt;- nil:</span><br><span class=\"line\">            case &lt;-d.cancelCh:</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            return errBadPeer</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1getHeaders()peer.RequestHeadersByNumber() headers<br>2skeleton+192192128skeleton192<br>3<br>4skeletonfillHeaderSkeleton()skeleton header chain<br>5fromgetHeaders()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) fillHeaderSkeleton(from uint64, skeleton []*types.Header) ([]*types.Header, int, error) &#123;</span><br><span class=\"line\">    log.Debug(&quot;Filling up skeleton&quot;, &quot;from&quot;, from)</span><br><span class=\"line\">    d.queue.ScheduleSkeleton(from, skeleton)</span><br><span class=\"line\"></span><br><span class=\"line\">    var (</span><br><span class=\"line\">        deliver = func(packet dataPack) (int, error) &#123;</span><br><span class=\"line\">            pack := packet.(*headerPack)</span><br><span class=\"line\">            return d.queue.DeliverHeaders(pack.peerId, pack.headers, d.headerProcCh)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        expire   = func() map[string]int &#123; return d.queue.ExpireHeaders(d.requestTTL()) &#125;</span><br><span class=\"line\">        throttle = func() bool &#123; return false &#125;</span><br><span class=\"line\">        reserve  = func(p *peerConnection, count int) (*fetchRequest, bool, error) &#123;</span><br><span class=\"line\">            return d.queue.ReserveHeaders(p, count), false, nil</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        fetch    = func(p *peerConnection, req *fetchRequest) error &#123; return p.FetchHeaders(req.From, MaxHeaderFetch) &#125;</span><br><span class=\"line\">        capacity = func(p *peerConnection) int &#123; return p.HeaderCapacity(d.requestRTT()) &#125;</span><br><span class=\"line\">        setIdle  = func(p *peerConnection, accepted int) &#123; p.SetHeadersIdle(accepted) &#125;</span><br><span class=\"line\">    )</span><br><span class=\"line\">    err := d.fetchParts(errCancelHeaderFetch, d.headerCh, deliver, d.queue.headerContCh, expire,</span><br><span class=\"line\">        d.queue.PendingHeaders, d.queue.InFlightHeaders, throttle, reserve,</span><br><span class=\"line\">        nil, fetch, d.queue.CancelHeaders, capacity, d.peers.HeaderIdlePeers, setIdle, &quot;headers&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">    log.Debug(&quot;Skeleton fill terminated&quot;, &quot;err&quot;, err)</span><br><span class=\"line\"></span><br><span class=\"line\">    filled, proced := d.queue.RetrieveHeaders()</span><br><span class=\"line\">    return filled, proced, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>a) skeletonheadersqueue.ScheduleSkeleton<br>b) d.fetchParts()<br>d.fetchParts()<br>1headersd.queue.DeliverHeaders()<br>2d.queue.PendingHeaderspendingheadersd.peers.HeaderIdlePeersidlepeers<br>3d.queue.ReserveHeaderspendingheadersidlepeers<br>4idlepeersp.FetchHeaders(req.From, MaxHeaderFetch)headers<br>c) d.queue.RetrieveHeaders()filledheaders</p>\n<p>d.fetchBodies() , d.fetchReceipts() fetchHeaders()</p>\n<p>Downloader<br>d.processHeaders(), d.processFastSyncContent(latest) , d.processFullSyncContent<br>1d.processHeaders() </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) processHeaders(origin uint64, pivot uint64, td *big.Int) error &#123;</span><br><span class=\"line\">    // Keep a count of uncertain headers to roll back</span><br><span class=\"line\">    rollback := []*types.Header&#123;&#125;</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if len(rollback) &gt; 0 &#123;</span><br><span class=\"line\">            // Flatten the headers and roll them back</span><br><span class=\"line\">            hashes := make([]common.Hash, len(rollback))</span><br><span class=\"line\">            for i, header := range rollback &#123;</span><br><span class=\"line\">                hashes[i] = header.Hash()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            lastHeader, lastFastBlock, lastBlock := d.lightchain.CurrentHeader().Number, common.Big0, common.Big0</span><br><span class=\"line\">            if d.mode != LightSync &#123;</span><br><span class=\"line\">                lastFastBlock = d.blockchain.CurrentFastBlock().Number()</span><br><span class=\"line\">                lastBlock = d.blockchain.CurrentBlock().Number()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            d.lightchain.Rollback(hashes)</span><br><span class=\"line\">            curFastBlock, curBlock := common.Big0, common.Big0</span><br><span class=\"line\">            if d.mode != LightSync &#123;</span><br><span class=\"line\">                curFastBlock = d.blockchain.CurrentFastBlock().Number()</span><br><span class=\"line\">                curBlock = d.blockchain.CurrentBlock().Number()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.Warn(&quot;Rolled back headers&quot;, &quot;count&quot;, len(hashes),</span><br><span class=\"line\">                &quot;header&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastHeader, d.lightchain.CurrentHeader().Number),</span><br><span class=\"line\">                &quot;fast&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastFastBlock, curFastBlock),</span><br><span class=\"line\">                &quot;block&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastBlock, curBlock))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Wait for batches of headers to process</span><br><span class=\"line\">    gotHeaders := false</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return errCancelHeaderProcessing</span><br><span class=\"line\"></span><br><span class=\"line\">        case headers := &lt;-d.headerProcCh:</span><br><span class=\"line\">            // Terminate header processing if we synced up</span><br><span class=\"line\">            if len(headers) == 0 &#123;</span><br><span class=\"line\">                // Notify everyone that headers are fully processed</span><br><span class=\"line\">                for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class=\"line\">                    select &#123;</span><br><span class=\"line\">                    case ch &lt;- false:</span><br><span class=\"line\">                    case &lt;-d.cancelCh:</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                if d.mode != LightSync &#123;</span><br><span class=\"line\">                    head := d.blockchain.CurrentBlock()</span><br><span class=\"line\">                    if !gotHeaders &amp;&amp; td.Cmp(d.blockchain.GetTd(head.Hash(), head.NumberU64())) &gt; 0 &#123;</span><br><span class=\"line\">                        return errStallingPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                if d.mode == FastSync || d.mode == LightSync &#123;</span><br><span class=\"line\">                    head := d.lightchain.CurrentHeader()</span><br><span class=\"line\">                    if td.Cmp(d.lightchain.GetTd(head.Hash(), head.Number.Uint64())) &gt; 0 &#123;</span><br><span class=\"line\">                        return errStallingPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Disable any rollback and return</span><br><span class=\"line\">                rollback = nil</span><br><span class=\"line\">                return nil</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Otherwise split the chunk of headers into batches and process them</span><br><span class=\"line\">            gotHeaders = true</span><br><span class=\"line\"></span><br><span class=\"line\">            for len(headers) &gt; 0 &#123;</span><br><span class=\"line\">                // Terminate if something failed in between processing chunks</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                    return errCancelHeaderProcessing</span><br><span class=\"line\">                default:</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Select the next chunk of headers to import</span><br><span class=\"line\">                limit := maxHeadersProcess</span><br><span class=\"line\">                if limit &gt; len(headers) &#123;</span><br><span class=\"line\">                    limit = len(headers)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                chunk := headers[:limit]</span><br><span class=\"line\"></span><br><span class=\"line\">                // In case of header only syncing, validate the chunk immediately</span><br><span class=\"line\">                if d.mode == FastSync || d.mode == LightSync &#123;</span><br><span class=\"line\">                    // Collect the yet unknown headers to mark them as uncertain</span><br><span class=\"line\">                    unknown := make([]*types.Header, 0, len(headers))</span><br><span class=\"line\">                    for _, header := range chunk &#123;</span><br><span class=\"line\">                        if !d.lightchain.HasHeader(header.Hash(), header.Number.Uint64()) &#123;</span><br><span class=\"line\">                            unknown = append(unknown, header)</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // If we&apos;re importing pure headers, verify based on their recentness</span><br><span class=\"line\">                    frequency := fsHeaderCheckFrequency</span><br><span class=\"line\">                    if chunk[len(chunk)-1].Number.Uint64()+uint64(fsHeaderForceVerify) &gt; pivot &#123;</span><br><span class=\"line\">                        frequency = 1</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    if n, err := d.lightchain.InsertHeaderChain(chunk, frequency); err != nil &#123;</span><br><span class=\"line\">                        // If some headers were inserted, add them too to the rollback list</span><br><span class=\"line\">                        if n &gt; 0 &#123;</span><br><span class=\"line\">                            rollback = append(rollback, chunk[:n]...)</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        log.Debug(&quot;Invalid header encountered&quot;, &quot;number&quot;, chunk[n].Number, &quot;hash&quot;, chunk[n].Hash(), &quot;err&quot;, err)</span><br><span class=\"line\">                        return errInvalidChain</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // All verifications passed, store newly found uncertain headers</span><br><span class=\"line\">                    rollback = append(rollback, unknown...)</span><br><span class=\"line\">                    if len(rollback) &gt; fsHeaderSafetyNet &#123;</span><br><span class=\"line\">                        rollback = append(rollback[:0], rollback[len(rollback)-fsHeaderSafetyNet:]...)</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Unless we&apos;re doing light chains, schedule the headers for associated content retrieval</span><br><span class=\"line\">                if d.mode == FullSync || d.mode == FastSync &#123;</span><br><span class=\"line\">                    // If we&apos;ve reached the allowed number of pending headers, stall a bit</span><br><span class=\"line\">                    for d.queue.PendingBlocks() &gt;= maxQueuedHeaders || d.queue.PendingReceipts() &gt;= maxQueuedHeaders &#123;</span><br><span class=\"line\">                        select &#123;</span><br><span class=\"line\">                        case &lt;-d.cancelCh:</span><br><span class=\"line\">                            return errCancelHeaderProcessing</span><br><span class=\"line\">                        case &lt;-time.After(time.Second):</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // Otherwise insert the headers for content retrieval</span><br><span class=\"line\">                    inserts := d.queue.Schedule(chunk, origin)</span><br><span class=\"line\">                    if len(inserts) != len(chunk) &#123;</span><br><span class=\"line\">                        log.Debug(&quot;Stale headers&quot;)</span><br><span class=\"line\">                        return errBadPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                headers = headers[limit:]</span><br><span class=\"line\">                origin += uint64(limit)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Signal the content downloaders of the availablility of new tasks</span><br><span class=\"line\">            for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case ch &lt;- true:</span><br><span class=\"line\">                default:</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1fetchHeaders() d.headerProcChheaders<br>2FastSyncLightSynclightchain.InsertHeaderChain(chunk, frequency)headerChain<br>3FullSyncFastSynd.queue.Schedule(chunk, origin)downloader.queue</p>\n<p>2processFastSyncContent() </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) processFastSyncContent(latest *types.Header) error &#123;</span><br><span class=\"line\">    // Start syncing state of the reported head block. This should get us most of</span><br><span class=\"line\">    // the state of the pivot block.</span><br><span class=\"line\">    stateSync := d.syncState(latest.Root)</span><br><span class=\"line\">    defer stateSync.Cancel()</span><br><span class=\"line\">    go func() &#123;</span><br><span class=\"line\">        if err := stateSync.Wait(); err != nil &amp;&amp; err != errCancelStateFetch &#123;</span><br><span class=\"line\">            d.queue.Close() // wake up WaitResults</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    // Figure out the ideal pivot block. Note, that this goalpost may move if the</span><br><span class=\"line\">    // sync takes long enough for the chain head to move significantly.</span><br><span class=\"line\">    pivot := uint64(0)</span><br><span class=\"line\">    if height := latest.Number.Uint64(); height &gt; uint64(fsMinFullBlocks) &#123;</span><br><span class=\"line\">        pivot = height - uint64(fsMinFullBlocks)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // To cater for moving pivot points, track the pivot block and subsequently</span><br><span class=\"line\">    // accumulated download results separatey.</span><br><span class=\"line\">    var (</span><br><span class=\"line\">        oldPivot *fetchResult   // Locked in pivot block, might change eventually</span><br><span class=\"line\">        oldTail  []*fetchResult // Downloaded content after the pivot</span><br><span class=\"line\">    )</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        // Wait for the next batch of downloaded data to be available, and if the pivot</span><br><span class=\"line\">        // block became stale, move the goalpost</span><br><span class=\"line\">        results := d.queue.Results(oldPivot == nil) // Block if we&apos;re not monitoring pivot staleness</span><br><span class=\"line\">        if len(results) == 0 &#123;</span><br><span class=\"line\">            // If pivot sync is done, stop</span><br><span class=\"line\">            if oldPivot == nil &#123;</span><br><span class=\"line\">                return stateSync.Cancel()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If sync failed, stop</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case &lt;-d.cancelCh:</span><br><span class=\"line\">                return stateSync.Cancel()</span><br><span class=\"line\">            default:</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if d.chainInsertHook != nil &#123;</span><br><span class=\"line\">            d.chainInsertHook(results)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if oldPivot != nil &#123;</span><br><span class=\"line\">            results = append(append([]*fetchResult&#123;oldPivot&#125;, oldTail...), results...)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Split around the pivot block and process the two sides via fast/full sync</span><br><span class=\"line\">        if atomic.LoadInt32(&amp;d.committed) == 0 &#123;</span><br><span class=\"line\">            latest = results[len(results)-1].Header</span><br><span class=\"line\">            if height := latest.Number.Uint64(); height &gt; pivot+2*uint64(fsMinFullBlocks) &#123;</span><br><span class=\"line\">                log.Warn(&quot;Pivot became stale, moving&quot;, &quot;old&quot;, pivot, &quot;new&quot;, height-uint64(fsMinFullBlocks))</span><br><span class=\"line\">                pivot = height - uint64(fsMinFullBlocks)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        P, beforeP, afterP := splitAroundPivot(pivot, results)</span><br><span class=\"line\">        if err := d.commitFastSyncData(beforeP, stateSync); err != nil &#123;</span><br><span class=\"line\">            return err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if P != nil &#123;</span><br><span class=\"line\">            // If new pivot block found, cancel old state retrieval and restart</span><br><span class=\"line\">            if oldPivot != P &#123;</span><br><span class=\"line\">                stateSync.Cancel()</span><br><span class=\"line\"></span><br><span class=\"line\">                stateSync = d.syncState(P.Header.Root)</span><br><span class=\"line\">                defer stateSync.Cancel()</span><br><span class=\"line\">                go func() &#123;</span><br><span class=\"line\">                    if err := stateSync.Wait(); err != nil &amp;&amp; err != errCancelStateFetch &#123;</span><br><span class=\"line\">                        d.queue.Close() // wake up WaitResults</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;()</span><br><span class=\"line\">                oldPivot = P</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Wait for completion, occasionally checking for pivot staleness</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case &lt;-stateSync.done:</span><br><span class=\"line\">                if stateSync.err != nil &#123;</span><br><span class=\"line\">                    return stateSync.err</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                if err := d.commitPivotBlock(P); err != nil &#123;</span><br><span class=\"line\">                    return err</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                oldPivot = nil</span><br><span class=\"line\"></span><br><span class=\"line\">            case &lt;-time.After(time.Second):</span><br><span class=\"line\">                oldTail = afterP</span><br><span class=\"line\">                continue</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Fast sync done, pivot commit done, full import</span><br><span class=\"line\">        if err := d.importBlockResults(afterP); err != nil &#123;</span><br><span class=\"line\">            return err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1pivot<br>2d.queue resultresult<br>3resultspivot<br>4pivotresultspivotresultpivotresultspivotresults<br>5commitFastSyncDatapivotresults <br>6pivotresult commitPivotBlockFastSyncCommitHeadpivothash<br>7d.importBlockResultspivotresults</p>\n<p>3processFullSyncContent()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) processFullSyncContent() error &#123;</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        results := d.queue.Results(true)</span><br><span class=\"line\">        if len(results) == 0 &#123;</span><br><span class=\"line\">            return nil</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if d.chainInsertHook != nil &#123;</span><br><span class=\"line\">            d.chainInsertHook(results)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if err := d.importBlockResults(results); err != nil &#123;</span><br><span class=\"line\">            return err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (d *Downloader) importBlockResults(results []*fetchResult) error &#123;</span><br><span class=\"line\">    // Check for any early termination requests</span><br><span class=\"line\">    if len(results) == 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case &lt;-d.quitCh:</span><br><span class=\"line\">        return errCancelContentProcessing</span><br><span class=\"line\">    default:</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Retrieve the a batch of results to import</span><br><span class=\"line\">    first, last := results[0].Header, results[len(results)-1].Header</span><br><span class=\"line\">    log.Debug(&quot;Inserting downloaded chain&quot;, &quot;items&quot;, len(results),</span><br><span class=\"line\">        &quot;firstnum&quot;, first.Number, &quot;firsthash&quot;, first.Hash(),</span><br><span class=\"line\">        &quot;lastnum&quot;, last.Number, &quot;lasthash&quot;, last.Hash(),</span><br><span class=\"line\">    )</span><br><span class=\"line\">    blocks := make([]*types.Block, len(results))</span><br><span class=\"line\">    for i, result := range results &#123;</span><br><span class=\"line\">        blocks[i] = types.NewBlockWithHeader(result.Header).WithBody(result.Transactions, result.Uncles)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if index, err := d.blockchain.InsertChain(blocks); err != nil &#123;</span><br><span class=\"line\">        log.Debug(&quot;Downloaded item processing failed&quot;, &quot;number&quot;, results[index].Header.Number, &quot;hash&quot;, results[index].Header.Hash(), &quot;err&quot;, err)</span><br><span class=\"line\">        return errInvalidChain</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>processFullSyncContentresults</p>\n<p><br>Downloaderlightlightfastfullpivotfastfastfast<a href=\"https://github.com/ethereum/go-ethereum/pull/1889\"></a></p>\n","site":{"data":{"projects":[{"name":"","url":"https://github.com/xiaoxuez/xiaoxuez.github.io/tree/master","desc":"github, "},{"name":"","url":"https://github.com/xiaoxuez/note/tree/master/text","desc":"..2019"},{"name":"go-hello-world","url":"https://github.com/xiaoxuez/go-hello-world/tree/master/algorithm/","desc":""}]}},"excerpt":"","more":"<h4 id=\"ApplyTransaction\"><a href=\"#ApplyTransaction\" class=\"headerlink\" title=\"ApplyTransaction\"></a>ApplyTransaction</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// ApplyTransaction attempts to apply a transaction to the given state database</span><br><span class=\"line\">// and uses the input parameters for its environment. It returns the receipt</span><br><span class=\"line\">// for the transaction, gas used and an error if the transaction failed,</span><br><span class=\"line\">// indicating the block was invalid.</span><br><span class=\"line\">//state database</span><br><span class=\"line\">func ApplyTransaction(config *params.ChainConfig, bc ChainContext, author *common.Address, gp *GasPool, statedb *state.StateDB, header *types.Header, tx *types.Transaction, usedGas *uint64, cfg vm.Config) (*types.Receipt, uint64, error) &#123;</span><br><span class=\"line\">\t//</span><br><span class=\"line\">\tmsg, err := tx.AsMessage(types.MakeSigner(config, header.Number))</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\treturn nil, 0, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//EVMgaserrlogsevm</span><br><span class=\"line\">\t// Create a new context to be used in the EVM environment</span><br><span class=\"line\">\tcontext := NewEVMContext(msg, header, bc, author)</span><br><span class=\"line\">\t// Create a new environment which holds all relevant information</span><br><span class=\"line\">\t// about the transaction and calling mechanisms.</span><br><span class=\"line\">\tvmenv := vm.NewEVM(context, statedb, config, cfg)</span><br><span class=\"line\">\t// Apply the transaction to the current state (included in the env)</span><br><span class=\"line\">\t_, gas, failed, err := ApplyMessage(vmenv, msg, gp)</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\treturn nil, 0, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\t//</span><br><span class=\"line\">\t// Update the state with pending changes</span><br><span class=\"line\">\tvar root []byte</span><br><span class=\"line\">\tif config.IsByzantium(header.Number) &#123;</span><br><span class=\"line\">\t\tstatedb.Finalise(true)</span><br><span class=\"line\">\t&#125; else &#123;</span><br><span class=\"line\">\t\troot = statedb.IntermediateRoot(config.IsEIP158(header.Number)).Bytes()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t*usedGas += gas</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Create a new receipt for the transaction, storing the intermediate root and gas used by the tx</span><br><span class=\"line\">\t// based on the eip phase, we&apos;re passing whether the root touch-delete accounts.</span><br><span class=\"line\">\treceipt := types.NewReceipt(root, failed, *usedGas)</span><br><span class=\"line\">\treceipt.TxHash = tx.Hash()</span><br><span class=\"line\">\treceipt.GasUsed = gas</span><br><span class=\"line\">\t// if the transaction created a contract, store the creation address in the receipt.</span><br><span class=\"line\">\tif msg.To() == nil &#123;</span><br><span class=\"line\">\t\treceipt.ContractAddress = crypto.CreateAddress(vmenv.Context.Origin, tx.Nonce())</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// Set the receipt logs and create a bloom for filtering</span><br><span class=\"line\">\treceipt.Logs = statedb.GetLogs(tx.Hash())</span><br><span class=\"line\">\treceipt.Bloom = types.CreateBloom(types.Receipts&#123;receipt&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn receipt, gas, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (evm *EVM) Call(caller ContractRef, addr common.Address, input []byte, gas uint64, value *big.Int) (ret []byte, leftOverGas uint64, err error) &#123;</span><br><span class=\"line\">\tif evm.vmConfig.NoRecursion &amp;&amp; evm.depth &gt; 0 &#123;</span><br><span class=\"line\">\t\treturn nil, gas, nil</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Fail if we&apos;re trying to execute above the call depth limit</span><br><span class=\"line\">\tif evm.depth &gt; int(params.CallCreateDepth) &#123;</span><br><span class=\"line\">\t\treturn nil, gas, ErrDepth</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t// Fail if we&apos;re trying to transfer more than the available balance</span><br><span class=\"line\">\tif !evm.Context.CanTransfer(evm.StateDB, caller.Address(), value) &#123;</span><br><span class=\"line\">\t\treturn nil, gas, ErrInsufficientBalance</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tvar (</span><br><span class=\"line\">\t\tto       = AccountRef(addr)</span><br><span class=\"line\">\t\tsnapshot = evm.StateDB.Snapshot()</span><br><span class=\"line\">\t)</span><br><span class=\"line\">\tif !evm.StateDB.Exist(addr) &#123;</span><br><span class=\"line\">\t\tprecompiles := PrecompiledContractsHomestead</span><br><span class=\"line\">\t\tif evm.ChainConfig().IsByzantium(evm.BlockNumber) &#123;</span><br><span class=\"line\">\t\t\tprecompiles = PrecompiledContractsByzantium</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif precompiles[addr] == nil &amp;&amp; evm.ChainConfig().IsEIP158(evm.BlockNumber) &amp;&amp; value.Sign() == 0 &#123;</span><br><span class=\"line\">\t\t\t// Calling a non existing account, don&apos;t do anything, but ping the tracer</span><br><span class=\"line\">\t\t\tif evm.vmConfig.Debug &amp;&amp; evm.depth == 0 &#123;</span><br><span class=\"line\">\t\t\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)</span><br><span class=\"line\">\t\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, 0, 0, nil)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\treturn nil, gas, nil</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tevm.StateDB.CreateAccount(addr)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tevm.Transfer(evm.StateDB, caller.Address(), to.Address(), value)</span><br><span class=\"line\">\t// Initialise a new contract and set the code that is to be used by the EVM.</span><br><span class=\"line\">\t// The contract is a scoped environment for this execution context only.</span><br><span class=\"line\">\tcontract := NewContract(caller, to, value, gas)</span><br><span class=\"line\">\tcontract.SetCallCode(&amp;addr, evm.StateDB.GetCodeHash(addr), evm.StateDB.GetCode(addr))</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Even if the account has no code, we need to continue because it might be a precompile</span><br><span class=\"line\">\tstart := time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Capture the tracer start/end events in debug mode</span><br><span class=\"line\">\tif evm.vmConfig.Debug &amp;&amp; evm.depth == 0 &#123;</span><br><span class=\"line\">\t\tevm.vmConfig.Tracer.CaptureStart(caller.Address(), addr, false, input, gas, value)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tdefer func() &#123; // Lazy evaluation of the parameters</span><br><span class=\"line\">\t\t\tevm.vmConfig.Tracer.CaptureEnd(ret, gas-contract.Gas, time.Since(start), err)</span><br><span class=\"line\">\t\t&#125;()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tret, err = run(evm, contract, input, false)</span><br><span class=\"line\"></span><br><span class=\"line\">\t// When an error was returned by the EVM or when setting the creation code</span><br><span class=\"line\">\t// above we revert to the snapshot and consume any gas remaining. Additionally</span><br><span class=\"line\">\t// when we&apos;re in homestead this also counts for code storage gas errors.</span><br><span class=\"line\">\tif err != nil &#123;</span><br><span class=\"line\">\t\tevm.StateDB.RevertToSnapshot(snapshot)</span><br><span class=\"line\">\t\tif err != errExecutionReverted &#123;</span><br><span class=\"line\">\t\t\tcontract.UseGas(contract.Gas)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn ret, contract.Gas, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"handleMsg\"><a href=\"#handleMsg\" class=\"headerlink\" title=\"handleMsg\"></a>handleMsg</h4><p></p>\n<ul>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">StatusMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetBlockHeadersMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BlockHeadersMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetBlockBodiesMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BlockBodiesMsg</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetNodeDataMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NodeDataMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GetReceiptsMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ReceiptsMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NewBlockHashesMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NewBlockMsg</span><br></pre></td></tr></table></figure>\n</li>\n<li><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TxMsg</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Start\"><a href=\"#Start\" class=\"headerlink\" title=\"Start\"></a>Start</h4><p>goroutine </p>\n<ul>\n<li><p>txBroadcastLoop</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (self *ProtocolManager) txBroadcastLoop() &#123;</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case event := &lt;-self.txCh:</span><br><span class=\"line\">            self.BroadcastTx(event.Tx.Hash(), event.Tx)</span><br><span class=\"line\"></span><br><span class=\"line\">        // Err() channel will be closed when unsubscribing.</span><br><span class=\"line\">        case &lt;-self.txSub.Err():</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>core/tx_pool.go send self.txCh<br>self.BroadcastTx(event.Tx.Hash(), event.Tx)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) BroadcastTx(hash common.Hash, tx *types.Transaction) &#123;</span><br><span class=\"line\">    // Broadcast transaction to a batch of peers not knowing about it</span><br><span class=\"line\">    peers := pm.peers.PeersWithoutTx(hash)</span><br><span class=\"line\">    //FIXME include this again: peers = peers[:int(math.Sqrt(float64(len(peers))))]</span><br><span class=\"line\">    for _, peer := range peers &#123;</span><br><span class=\"line\">        peer.SendTransactions(types.Transactions&#123;tx&#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    log.Trace(&quot;Broadcast transaction&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(peers))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>hash</p>\n</li>\n<li><p>minedBroadcastLoop</p>\n<p>miner.go NewMinedBlockEvent self.BroadcastBlock(ev.Block, true)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Mined broadcast loop</span><br><span class=\"line\">func (self *ProtocolManager) minedBroadcastLoop() &#123;</span><br><span class=\"line\">    // automatically stops if unsubscribe</span><br><span class=\"line\">    for obj := range self.minedBlockSub.Chan() &#123;</span><br><span class=\"line\">        switch ev := obj.Data.(type) &#123;</span><br><span class=\"line\">        case core.NewMinedBlockEvent:</span><br><span class=\"line\">            self.BroadcastBlock(ev.Block, true)  // First propagate block to peers</span><br><span class=\"line\">            self.BroadcastBlock(ev.Block, false) // Only then announce to the rest</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) BroadcastBlock(block *types.Block, propagate bool) &#123;</span><br><span class=\"line\">    hash := block.Hash()</span><br><span class=\"line\">    peers := pm.peers.PeersWithoutBlock(hash)</span><br><span class=\"line\"></span><br><span class=\"line\">    // If propagation is requested, send to a subset of the peer</span><br><span class=\"line\">    if propagate &#123;</span><br><span class=\"line\">        // Calculate the TD of the block (it&apos;s not imported yet, so block.Td is not valid)</span><br><span class=\"line\">        var td *big.Int</span><br><span class=\"line\">        if parent := pm.blockchain.GetBlock(block.ParentHash(), block.NumberU64()-1); parent != nil &#123;</span><br><span class=\"line\">            td = new(big.Int).Add(block.Difficulty(), pm.blockchain.GetTd(block.ParentHash(), block.NumberU64()-1))</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            log.Error(&quot;Propagating dangling block&quot;, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash)</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Send the block to a subset of our peers</span><br><span class=\"line\">        transfer := peers[:int(math.Sqrt(float64(len(peers))))]</span><br><span class=\"line\">        for _, peer := range transfer &#123;</span><br><span class=\"line\">            peer.SendNewBlock(block, td)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.Trace(&quot;Propagated block&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(transfer), &quot;duration&quot;, common.PrettyDuration(time.Since(block.ReceivedAt)))</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Otherwise if the block is indeed in out own chain, announce it</span><br><span class=\"line\">    if pm.blockchain.HasBlock(hash, block.NumberU64()) &#123;</span><br><span class=\"line\">        for _, peer := range peers &#123;</span><br><span class=\"line\">            peer.SendNewBlockHashes([]common.Hash&#123;hash&#125;, []uint64&#123;block.NumberU64()&#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.Trace(&quot;Announced block&quot;, &quot;hash&quot;, hash, &quot;recipients&quot;, len(peers), &quot;duration&quot;, common.PrettyDuration(time.Since(block.ReceivedAt)))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>propagatetrue blockfalse hashnumber</p>\n</li>\n<li><p>syncer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) syncer() &#123;</span><br><span class=\"line\">    // Start and ensure cleanup of sync mechanisms</span><br><span class=\"line\">    pm.fetcher.Start()</span><br><span class=\"line\">    defer pm.fetcher.Stop()</span><br><span class=\"line\">    defer pm.downloader.Terminate()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Wait for different events to fire synchronisation operations</span><br><span class=\"line\">    forceSync := time.NewTicker(forceSyncCycle)</span><br><span class=\"line\">    defer forceSync.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-pm.newPeerCh:</span><br><span class=\"line\">            // Make sure we have peers to select from, then sync</span><br><span class=\"line\">            if pm.peers.Len() &lt; minDesiredPeerCount &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            go pm.synchronise(pm.peers.BestPeer())</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-forceSync.C:</span><br><span class=\"line\">            // Force a sync even if not enough peers are present</span><br><span class=\"line\">            go pm.synchronise(pm.peers.BestPeer())</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-pm.noMorePeers:</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>pm.fetcher.Start() fetcher</p>\n<p>P2P server ProtocolManager p2p.Protocol Runsend pm.newPeerChTD pm.synchronise(pm.peers.BestPeer()) goroutine</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// synchronise tries to sync up our local block chain with a remote peer.</span><br><span class=\"line\">func (pm *ProtocolManager) synchronise(peer *peer) &#123;</span><br><span class=\"line\">    // Short circuit if no peers are available</span><br><span class=\"line\">    if peer == nil &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Make sure the peer&apos;s TD is higher than our own</span><br><span class=\"line\">    currentBlock := pm.blockchain.CurrentBlock()</span><br><span class=\"line\">    td := pm.blockchain.GetTd(currentBlock.Hash(), currentBlock.NumberU64())</span><br><span class=\"line\"></span><br><span class=\"line\">    pHead, pTd := peer.Head()</span><br><span class=\"line\">    if pTd.Cmp(td) &lt;= 0 &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Otherwise try to sync with the downloader</span><br><span class=\"line\">    mode := downloader.FullSync</span><br><span class=\"line\">    if atomic.LoadUint32(&amp;pm.fastSync) == 1 &#123;</span><br><span class=\"line\">        // Fast sync was explicitly requested, and explicitly granted</span><br><span class=\"line\">        mode = downloader.FastSync</span><br><span class=\"line\">    &#125; else if currentBlock.NumberU64() == 0 &amp;&amp; pm.blockchain.CurrentFastBlock().NumberU64() &gt; 0 &#123;</span><br><span class=\"line\">        // The database seems empty as the current block is the genesis. Yet the fast</span><br><span class=\"line\">        // block is ahead, so fast sync was enabled for this node at a certain point.</span><br><span class=\"line\">        // The only scenario where this can happen is if the user manually (or via a</span><br><span class=\"line\">        // bad block) rolled back a fast sync node below the sync point. In this case</span><br><span class=\"line\">        // however it&apos;s safe to reenable fast sync.</span><br><span class=\"line\">        atomic.StoreUint32(&amp;pm.fastSync, 1)</span><br><span class=\"line\">        mode = downloader.FastSync</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Run the sync cycle, and disable fast sync if we&apos;ve went past the pivot block</span><br><span class=\"line\">    if err := pm.downloader.Synchronise(peer.id, pHead, pTd, mode); err != nil &#123;</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if atomic.LoadUint32(&amp;pm.fastSync) == 1 &#123;</span><br><span class=\"line\">        log.Info(&quot;Fast sync complete, auto disabling&quot;)</span><br><span class=\"line\">        atomic.StoreUint32(&amp;pm.fastSync, 0)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    atomic.StoreUint32(&amp;pm.acceptTxs, 1) // Mark initial sync done</span><br><span class=\"line\">    if head := pm.blockchain.CurrentBlock(); head.NumberU64() &gt; 0 &#123;</span><br><span class=\"line\">        // We&apos;ve completed a sync cycle, notify all peers of new state. This path is</span><br><span class=\"line\">        // essential in star-topology networks where a gateway node needs to notify</span><br><span class=\"line\">        // all its out-of-date peers of the availability of a new block. This failure</span><br><span class=\"line\">        // scenario will most often crop up in private and hackathon networks with</span><br><span class=\"line\">        // degenerate connectivity, but it should be healthy for the mainnet too to</span><br><span class=\"line\">        // more reliably update peers or the local TD state.</span><br><span class=\"line\">        go pm.BroadcastBlock(head, false)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>TDTDpm.downloader.Synchronise(peer.id, pHead, pTd, mode)go pm.BroadcastBlock(head, false)</p>\n</li>\n<li><p>txsyncLoop</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (pm *ProtocolManager) txsyncLoop() &#123;</span><br><span class=\"line\">    var (</span><br><span class=\"line\">        pending = make(map[discover.NodeID]*txsync)</span><br><span class=\"line\">        sending = false               // whether a send is active</span><br><span class=\"line\">        pack    = new(txsync)         // the pack that is being sent</span><br><span class=\"line\">        done    = make(chan error, 1) // result of the send</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    // send starts a sending a pack of transactions from the sync.</span><br><span class=\"line\">    send := func(s *txsync) &#123;</span><br><span class=\"line\">        // Fill pack with transactions up to the target size.</span><br><span class=\"line\">        size := common.StorageSize(0)</span><br><span class=\"line\">        pack.p = s.p</span><br><span class=\"line\">        pack.txs = pack.txs[:0]</span><br><span class=\"line\">        for i := 0; i &lt; len(s.txs) &amp;&amp; size &lt; txsyncPackSize; i++ &#123;</span><br><span class=\"line\">            pack.txs = append(pack.txs, s.txs[i])</span><br><span class=\"line\">            size += s.txs[i].Size()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Remove the transactions that will be sent.</span><br><span class=\"line\">        s.txs = s.txs[:copy(s.txs, s.txs[len(pack.txs):])]</span><br><span class=\"line\">        if len(s.txs) == 0 &#123;</span><br><span class=\"line\">            delete(pending, s.p.ID())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Send the pack in the background.</span><br><span class=\"line\">        s.p.Log().Trace(&quot;Sending batch of transactions&quot;, &quot;count&quot;, len(pack.txs), &quot;bytes&quot;, size)</span><br><span class=\"line\">        sending = true</span><br><span class=\"line\">        go func() &#123; done &lt;- pack.p.SendTransactions(pack.txs) &#125;()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // pick chooses the next pending sync.</span><br><span class=\"line\">    pick := func() *txsync &#123;</span><br><span class=\"line\">        if len(pending) == 0 &#123;</span><br><span class=\"line\">            return nil</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        n := rand.Intn(len(pending)) + 1</span><br><span class=\"line\">        for _, s := range pending &#123;</span><br><span class=\"line\">            if n--; n == 0 &#123;</span><br><span class=\"line\">                return s</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case s := &lt;-pm.txsyncCh:</span><br><span class=\"line\">            pending[s.p.ID()] = s</span><br><span class=\"line\">            if !sending &#123;</span><br><span class=\"line\">                send(s)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        case err := &lt;-done:</span><br><span class=\"line\">            sending = false</span><br><span class=\"line\">            // Stop tracking peers that cause send failures.</span><br><span class=\"line\">            if err != nil &#123;</span><br><span class=\"line\">                pack.p.Log().Debug(&quot;Transaction send failed&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">                delete(pending, pack.p.ID())</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the next send.</span><br><span class=\"line\">            if s := pick(); s != nil &#123;</span><br><span class=\"line\">                send(s)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        case &lt;-pm.quitSync:</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n</li>\n</ul>\n<h4 id=\"fetch\"><a href=\"#fetch\" class=\"headerlink\" title=\"fetch\"></a>fetch</h4><p>fetcherdownloaderfetcher<br>pm.handleMsg  NewBlockHashesMsg</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case msg.Code == NewBlockHashesMsg:</span><br><span class=\"line\">        var announces newBlockHashesData</span><br><span class=\"line\">        if err := msg.Decode(&amp;announces); err != nil &#123;</span><br><span class=\"line\">            return errResp(ErrDecode, &quot;%v: %v&quot;, msg, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Mark the hashes as present at the remote node</span><br><span class=\"line\">        for _, block := range announces &#123;</span><br><span class=\"line\">            p.MarkBlock(block.Hash)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Schedule all the unknown hashes for retrieval</span><br><span class=\"line\">        unknown := make(newBlockHashesData, 0, len(announces))</span><br><span class=\"line\">        for _, block := range announces &#123;</span><br><span class=\"line\">            if !pm.blockchain.HasBlock(block.Hash, block.Number) &#123;</span><br><span class=\"line\">                unknown = append(unknown, block)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        for _, block := range unknown &#123;</span><br><span class=\"line\">            pm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p>newBlockHashesDatanewBlockHashesDatablockhashblocknumber<br>newBlockHashesDatapm.fetcher.Notify(p.id, block.Hash, block.Number, time.Now(), p.RequestOneHeader, p.RequestBodies)blockhashblocknumberpeer.go</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) Notify(peer string, hash common.Hash, number uint64, time time.Time,</span><br><span class=\"line\">    headerFetcher headerRequesterFn, bodyFetcher bodyRequesterFn) error &#123;</span><br><span class=\"line\">    block := &amp;announce&#123;</span><br><span class=\"line\">        hash:        hash,</span><br><span class=\"line\">        number:      number,</span><br><span class=\"line\">        time:        time,</span><br><span class=\"line\">        origin:      peer,</span><br><span class=\"line\">        fetchHeader: headerFetcher,</span><br><span class=\"line\">        fetchBodies: bodyFetcher,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case f.notify &lt;- block:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return errTerminated</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Notify()announcesendf.notifyfetcherloop()f.notify receive notification, </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case notification := &lt;-f.notify:</span><br><span class=\"line\">            // A block was announced, make sure the peer isn&apos;t DOSing us</span><br><span class=\"line\">            propAnnounceInMeter.Mark(1)</span><br><span class=\"line\"></span><br><span class=\"line\">            count := f.announces[notification.origin] + 1</span><br><span class=\"line\">            if count &gt; hashLimit &#123;</span><br><span class=\"line\">                log.Debug(&quot;Peer exceeded outstanding announces&quot;, &quot;peer&quot;, notification.origin, &quot;limit&quot;, hashLimit)</span><br><span class=\"line\">                propAnnounceDOSMeter.Mark(1)</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If we have a valid block number, check that it&apos;s potentially useful</span><br><span class=\"line\">            if notification.number &gt; 0 &#123;</span><br><span class=\"line\">                if dist := int64(notification.number) - int64(f.chainHeight()); dist &lt; -maxUncleDist || dist &gt; maxQueueDist &#123;</span><br><span class=\"line\">                    log.Debug(&quot;Peer discarded announcement&quot;, &quot;peer&quot;, notification.origin, &quot;number&quot;, notification.number, &quot;hash&quot;, notification.hash, &quot;distance&quot;, dist)</span><br><span class=\"line\">                    propAnnounceDropMeter.Mark(1)</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // All is well, schedule the announce if block&apos;s not yet downloading</span><br><span class=\"line\">            if _, ok := f.fetching[notification.hash]; ok &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            if _, ok := f.completing[notification.hash]; ok &#123;</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            f.announces[notification.origin] = count</span><br><span class=\"line\">            f.announced[notification.hash] = append(f.announced[notification.hash], notification)</span><br><span class=\"line\">            if f.announceChangeHook != nil &amp;&amp; len(f.announced[notification.hash]) == 1 &#123;</span><br><span class=\"line\">                f.announceChangeHook(notification.hash, true)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            if len(f.announced) == 1 &#123;</span><br><span class=\"line\">                f.rescheduleFetch(fetchTimer)</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n\n<p>1f.fetching f.completing notification.origin announces f.announced fetch<br>2len(f.announced[notification.hash]) == 1 f.announcedf.announceChangeHook<br>3len(f.announced) == 1 fetchTimer</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case &lt;-fetchTimer.C:</span><br><span class=\"line\">            // At least one block&apos;s timer ran out, check for needing retrieval</span><br><span class=\"line\">            request := make(map[string][]common.Hash)</span><br><span class=\"line\"></span><br><span class=\"line\">            for hash, announces := range f.announced &#123;</span><br><span class=\"line\">                if time.Since(announces[0].time) &gt; arriveTimeout-gatherSlack &#123;</span><br><span class=\"line\">                    // Pick a random peer to retrieve from, reset all others</span><br><span class=\"line\">                    announce := announces[rand.Intn(len(announces))]</span><br><span class=\"line\">                    f.forgetHash(hash)</span><br><span class=\"line\"></span><br><span class=\"line\">                    // If the block still didn&apos;t arrive, queue for fetching</span><br><span class=\"line\">                    if f.getBlock(hash) == nil &#123;</span><br><span class=\"line\">                        request[announce.origin] = append(request[announce.origin], hash)</span><br><span class=\"line\">                        f.fetching[hash] = announce</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Send out all block header requests</span><br><span class=\"line\">            for peer, hashes := range request &#123;</span><br><span class=\"line\">                log.Trace(&quot;Fetching scheduled headers&quot;, &quot;peer&quot;, peer, &quot;list&quot;, hashes)</span><br><span class=\"line\"></span><br><span class=\"line\">                // Create a closure of the fetch and schedule in on a new thread</span><br><span class=\"line\">                fetchHeader, hashes := f.fetching[hashes[0]].fetchHeader, hashes</span><br><span class=\"line\">                go func() &#123;</span><br><span class=\"line\">                    if f.fetchingHook != nil &#123;</span><br><span class=\"line\">                        f.fetchingHook(hashes)</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    for _, hash := range hashes &#123;</span><br><span class=\"line\">                        headerFetchMeter.Mark(1)</span><br><span class=\"line\">                        fetchHeader(hash) // Suboptimal, but protocol doesn&apos;t allow batch header retrievals</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the next fetch if blocks are still pending</span><br><span class=\"line\">            f.rescheduleFetch(fetchTimer)</span><br></pre></td></tr></table></figure>\n\n<p>1f.announcedarriveTimeout-gatherSlackhashfetcher<br>announcesannounceblockhashhashannounce<br>hashblockannouncerequestannouncef.fetching<br>2requestrequestblockhashfetchHeader(hash)header<br>fetchHeader(hash)pm.fetcher.Notifypeer.go<br><br>3 NewBlockHashesMsg fetcherfetchTimer</p>\n<p>Fetcher FilterHeaders()<br>fetchHeader(hash)peer.go RequestOneHeader(hash common.Hash)  SendGetBlockHeadersMsg <br>pm.handleMsg  BlockHashesMsg</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case msg.Code == BlockHeadersMsg:</span><br><span class=\"line\">        // A batch of headers arrived to one of our previous requests</span><br><span class=\"line\">        var headers []*types.Header</span><br><span class=\"line\">        if err := msg.Decode(&amp;headers); err != nil &#123;</span><br><span class=\"line\">            return errResp(ErrDecode, &quot;msg %v: %v&quot;, msg, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // If no headers were received, but we&apos;re expending a DAO fork check, maybe it&apos;s that</span><br><span class=\"line\">        if len(headers) == 0 &amp;&amp; p.forkDrop != nil &#123;</span><br><span class=\"line\">            // Possibly an empty reply to the fork header checks, sanity check TDs</span><br><span class=\"line\">            verifyDAO := true</span><br><span class=\"line\"></span><br><span class=\"line\">            // If we already have a DAO header, we can check the peer&apos;s TD against it. If</span><br><span class=\"line\">            // the peer&apos;s ahead of this, it too must have a reply to the DAO check</span><br><span class=\"line\">            if daoHeader := pm.blockchain.GetHeaderByNumber(pm.chainconfig.DAOForkBlock.Uint64()); daoHeader != nil &#123;</span><br><span class=\"line\">                if _, td := p.Head(); td.Cmp(pm.blockchain.GetTd(daoHeader.Hash(), daoHeader.Number.Uint64())) &gt;= 0 &#123;</span><br><span class=\"line\">                    verifyDAO = false</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If we&apos;re seemingly on the same chain, disable the drop timer</span><br><span class=\"line\">            if verifyDAO &#123;</span><br><span class=\"line\">                p.Log().Debug(&quot;Seems to be on the same side of the DAO fork&quot;)</span><br><span class=\"line\">                p.forkDrop.Stop()</span><br><span class=\"line\">                p.forkDrop = nil</span><br><span class=\"line\">                return nil</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Filter out any explicitly requested headers, deliver the rest to the downloader</span><br><span class=\"line\">        filter := len(headers) == 1</span><br><span class=\"line\">        if filter &#123;</span><br><span class=\"line\">            // If it&apos;s a potential DAO fork check, validate against the rules</span><br><span class=\"line\">            if p.forkDrop != nil &amp;&amp; pm.chainconfig.DAOForkBlock.Cmp(headers[0].Number) == 0 &#123;</span><br><span class=\"line\">                // Disable the fork drop timer</span><br><span class=\"line\">                p.forkDrop.Stop()</span><br><span class=\"line\">                p.forkDrop = nil</span><br><span class=\"line\"></span><br><span class=\"line\">                // Validate the header and either drop the peer or continue</span><br><span class=\"line\">                if err := misc.VerifyDAOHeaderExtraData(pm.chainconfig, headers[0]); err != nil &#123;</span><br><span class=\"line\">                    p.Log().Debug(&quot;Verified to be on the other side of the DAO fork, dropping&quot;)</span><br><span class=\"line\">                    return err</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                p.Log().Debug(&quot;Verified to be on the same side of the DAO fork&quot;)</span><br><span class=\"line\">                return nil</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Irrelevant of the fork checks, send the header to the fetcher just in case</span><br><span class=\"line\">            headers = pm.fetcher.FilterHeaders(p.id, headers, time.Now())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if len(headers) &gt; 0 || !filter &#123;</span><br><span class=\"line\">            err := pm.downloader.DeliverHeaders(p.id, headers)</span><br><span class=\"line\">            if err != nil &#123;</span><br><span class=\"line\">                log.Debug(&quot;Failed to deliver headers&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p>daoHeaderlen(headers) == 1pm.fetcher.FilterHeaders(p.id, headers, time.Now())</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) FilterHeaders(peer string, headers []*types.Header, time time.Time) []*types.Header &#123;</span><br><span class=\"line\">    log.Trace(&quot;Filtering headers&quot;, &quot;peer&quot;, peer, &quot;headers&quot;, len(headers))</span><br><span class=\"line\"></span><br><span class=\"line\">    // Send the filter channel to the fetcher</span><br><span class=\"line\">    filter := make(chan *headerFilterTask)</span><br><span class=\"line\"></span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case f.headerFilter &lt;- filter:</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Request the filtering of the header list</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case filter &lt;- &amp;headerFilterTask&#123;peer: peer, headers: headers, time: time&#125;:</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Retrieve the headers remaining after filtering</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case task := &lt;-filter:</span><br><span class=\"line\">        return task.headers</span><br><span class=\"line\">    case &lt;-f.quit:</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>send filter f.headerFilterfetcherloop()f.headerFilter receive filter</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case filter := &lt;-f.headerFilter:</span><br><span class=\"line\">            // Headers arrived from a remote peer. Extract those that were explicitly</span><br><span class=\"line\">            // requested by the fetcher, and return everything else so it&apos;s delivered</span><br><span class=\"line\">            // to other parts of the system.</span><br><span class=\"line\">            var task *headerFilterTask</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case task = &lt;-filter:</span><br><span class=\"line\">            case &lt;-f.quit:</span><br><span class=\"line\">                return</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headerFilterInMeter.Mark(int64(len(task.headers)))</span><br><span class=\"line\"></span><br><span class=\"line\">            // Split the batch of headers into unknown ones (to return to the caller),</span><br><span class=\"line\">            // known incomplete ones (requiring body retrievals) and completed blocks.</span><br><span class=\"line\">            unknown, incomplete, complete := []*types.Header&#123;&#125;, []*announce&#123;&#125;, []*types.Block&#123;&#125;</span><br><span class=\"line\">            for _, header := range task.headers &#123;</span><br><span class=\"line\">                hash := header.Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">                // Filter fetcher-requested headers from other synchronisation algorithms</span><br><span class=\"line\">                if announce := f.fetching[hash]; announce != nil &amp;&amp; announce.origin == task.peer &amp;&amp; f.fetched[hash] == nil &amp;&amp; f.completing[hash] == nil &amp;&amp; f.queued[hash] == nil &#123;</span><br><span class=\"line\">                    // If the delivered header does not match the promised number, drop the announcer</span><br><span class=\"line\">                    if header.Number.Uint64() != announce.number &#123;</span><br><span class=\"line\">                        log.Trace(&quot;Invalid block number fetched&quot;, &quot;peer&quot;, announce.origin, &quot;hash&quot;, header.Hash(), &quot;announced&quot;, announce.number, &quot;provided&quot;, header.Number)</span><br><span class=\"line\">                        f.dropPeer(announce.origin)</span><br><span class=\"line\">                        f.forgetHash(hash)</span><br><span class=\"line\">                        continue</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // Only keep if not imported by other means</span><br><span class=\"line\">                    if f.getBlock(hash) == nil &#123;</span><br><span class=\"line\">                        announce.header = header</span><br><span class=\"line\">                        announce.time = task.time</span><br><span class=\"line\"></span><br><span class=\"line\">                        // If the block is empty (header only), short circuit into the final import queue</span><br><span class=\"line\">                        if header.TxHash == types.DeriveSha(types.Transactions&#123;&#125;) &amp;&amp; header.UncleHash == types.CalcUncleHash([]*types.Header&#123;&#125;) &#123;</span><br><span class=\"line\">                            log.Trace(&quot;Block empty, skipping body retrieval&quot;, &quot;peer&quot;, announce.origin, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())</span><br><span class=\"line\"></span><br><span class=\"line\">                            block := types.NewBlockWithHeader(header)</span><br><span class=\"line\">                            block.ReceivedAt = task.time</span><br><span class=\"line\"></span><br><span class=\"line\">                            complete = append(complete, block)</span><br><span class=\"line\">                            f.completing[hash] = announce</span><br><span class=\"line\">                            continue</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        // Otherwise add to the list of blocks needing completion</span><br><span class=\"line\">                        incomplete = append(incomplete, announce)</span><br><span class=\"line\">                    &#125; else &#123;</span><br><span class=\"line\">                        log.Trace(&quot;Block already imported, discarding header&quot;, &quot;peer&quot;, announce.origin, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())</span><br><span class=\"line\">                        f.forgetHash(hash)</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; else &#123;</span><br><span class=\"line\">                    // Fetcher doesn&apos;t know about it, add to the return list</span><br><span class=\"line\">                    unknown = append(unknown, header)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headerFilterOutMeter.Mark(int64(len(unknown)))</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case filter &lt;- &amp;headerFilterTask&#123;headers: unknown, time: task.time&#125;:</span><br><span class=\"line\">            case &lt;-f.quit:</span><br><span class=\"line\">                return</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the retrieved headers for body completion</span><br><span class=\"line\">            for _, announce := range incomplete &#123;</span><br><span class=\"line\">                hash := announce.header.Hash()</span><br><span class=\"line\">                if _, ok := f.completing[hash]; ok &#123;</span><br><span class=\"line\">                    continue</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                f.fetched[hash] = append(f.fetched[hash], announce)</span><br><span class=\"line\">                if len(f.fetched) == 1 &#123;</span><br><span class=\"line\">                    f.rescheduleComplete(completeTimer)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the header-only blocks for import</span><br><span class=\"line\">            for _, block := range complete &#123;</span><br><span class=\"line\">                if announce := f.completing[block.Hash()]; announce != nil &#123;</span><br><span class=\"line\">                    f.enqueue(announce.origin, block)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br></pre></td></tr></table></figure>\n\n<p>1headerFilterheader f.fetchingf.fetched f.completingunknown filterFilterHeaderstask filterFilterHeaders<br>2headernumberf.fetchingannouncenumberhash<br>3hashblockhashblockhashcompletef.completingincomplete<br>4incompletef.completingf.fetchedcompleteTimer<br>5completef.completingf.enqueue(announce.origin, block)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">case &lt;-completeTimer.C:</span><br><span class=\"line\">            // At least one header&apos;s timer ran out, retrieve everything</span><br><span class=\"line\">            request := make(map[string][]common.Hash)</span><br><span class=\"line\"></span><br><span class=\"line\">            for hash, announces := range f.fetched &#123;</span><br><span class=\"line\">                // Pick a random peer to retrieve from, reset all others</span><br><span class=\"line\">                announce := announces[rand.Intn(len(announces))]</span><br><span class=\"line\">                f.forgetHash(hash)</span><br><span class=\"line\"></span><br><span class=\"line\">                // If the block still didn&apos;t arrive, queue for completion</span><br><span class=\"line\">                if f.getBlock(hash) == nil &#123;</span><br><span class=\"line\">                    request[announce.origin] = append(request[announce.origin], hash)</span><br><span class=\"line\">                    f.completing[hash] = announce</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Send out all block body requests</span><br><span class=\"line\">            for peer, hashes := range request &#123;</span><br><span class=\"line\">                log.Trace(&quot;Fetching scheduled bodies&quot;, &quot;peer&quot;, peer, &quot;list&quot;, hashes)</span><br><span class=\"line\"></span><br><span class=\"line\">                // Create a closure of the fetch and schedule in on a new thread</span><br><span class=\"line\">                if f.completingHook != nil &#123;</span><br><span class=\"line\">                    f.completingHook(hashes)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                bodyFetchMeter.Mark(int64(len(hashes)))</span><br><span class=\"line\">                go f.completing[hashes[0]].fetchBodies(hashes)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Schedule the next fetch if blocks are still pending</span><br><span class=\"line\">            f.rescheduleComplete(completeTimer)</span><br></pre></td></tr></table></figure>\n\n<p>1f.fetchedhashfetcher<br>hashblockannouncerequestannouncef.completing<br>2requestrequestblockhashfetchBodies(hashes)bodyfetchBodies(hashes)peer.go<br>3 BlockHashesMsg fetchercompleteTimer</p>\n<p>Fetcher FilterBodies() Enqueue(<br>1fetchBodies(hash)peer.go RequestBodies(hashes []common.Hash) SendGetBlockBodiesMsg <br>2pm.handleMsg  BlockBodiesMsg<br>3 pm.fetcher.FilterBodies(p.id, trasactions, uncles, time.Now())<br>FilterHeaders()<br>4FilterBodies()timer<br>5FilterHeaders()FilterBodies()f.enqueue(announce.origin, block)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) enqueue(peer string, block *types.Block) &#123;</span><br><span class=\"line\">    hash := block.Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Ensure the peer isn&apos;t DOSing us</span><br><span class=\"line\">    count := f.queues[peer] + 1</span><br><span class=\"line\">    if count &gt; blockLimit &#123;</span><br><span class=\"line\">        log.Debug(&quot;Discarded propagated block, exceeded allowance&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;limit&quot;, blockLimit)</span><br><span class=\"line\">        propBroadcastDOSMeter.Mark(1)</span><br><span class=\"line\">        f.forgetHash(hash)</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Discard any past or too distant blocks</span><br><span class=\"line\">    if dist := int64(block.NumberU64()) - int64(f.chainHeight()); dist &lt; -maxUncleDist || dist &gt; maxQueueDist &#123;</span><br><span class=\"line\">        log.Debug(&quot;Discarded propagated block, too far away&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;distance&quot;, dist)</span><br><span class=\"line\">        propBroadcastDropMeter.Mark(1)</span><br><span class=\"line\">        f.forgetHash(hash)</span><br><span class=\"line\">        return</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Schedule the block for future importing</span><br><span class=\"line\">    if _, ok := f.queued[hash]; !ok &#123;</span><br><span class=\"line\">        op := &amp;inject&#123;</span><br><span class=\"line\">            origin: peer,</span><br><span class=\"line\">            block:  block,</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        f.queues[peer] = count</span><br><span class=\"line\">        f.queued[hash] = op</span><br><span class=\"line\">        f.queue.Push(op, -float32(block.NumberU64()))</span><br><span class=\"line\">        if f.queueChangeHook != nil &#123;</span><br><span class=\"line\">            f.queueChangeHook(op.block.Hash(), true)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.Debug(&quot;Queued propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;queued&quot;, f.queue.Size())</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>hashf.queue<br>loopf.queueblock insertblock chain</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (f *Fetcher) insert(peer string, block *types.Block) &#123;</span><br><span class=\"line\">    hash := block.Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Run the import on a new thread</span><br><span class=\"line\">    log.Debug(&quot;Importing propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash)</span><br><span class=\"line\">    go func() &#123;</span><br><span class=\"line\">        defer func() &#123; f.done &lt;- hash &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">        // If the parent&apos;s unknown, abort insertion</span><br><span class=\"line\">        parent := f.getBlock(block.ParentHash())</span><br><span class=\"line\">        if parent == nil &#123;</span><br><span class=\"line\">            log.Debug(&quot;Unknown parent of propagated block&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;parent&quot;, block.ParentHash())</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Quickly validate the header and propagate the block if it passes</span><br><span class=\"line\">        switch err := f.verifyHeader(block.Header()); err &#123;</span><br><span class=\"line\">        case nil:</span><br><span class=\"line\">            // All ok, quickly propagate to our peers</span><br><span class=\"line\">            propBroadcastOutTimer.UpdateSince(block.ReceivedAt)</span><br><span class=\"line\">            go f.broadcastBlock(block, true)</span><br><span class=\"line\"></span><br><span class=\"line\">        case consensus.ErrFutureBlock:</span><br><span class=\"line\">            // Weird future block, don&apos;t fail, but neither propagate</span><br><span class=\"line\"></span><br><span class=\"line\">        default:</span><br><span class=\"line\">            // Something went very wrong, drop the peer</span><br><span class=\"line\">            log.Debug(&quot;Propagated block verification failed&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;err&quot;, err)</span><br><span class=\"line\">            f.dropPeer(peer)</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Run the actual import and log any issues</span><br><span class=\"line\">        if _, err := f.insertChain(types.Blocks&#123;block&#125;); err != nil &#123;</span><br><span class=\"line\">            log.Debug(&quot;Propagated block import failed&quot;, &quot;peer&quot;, peer, &quot;number&quot;, block.Number(), &quot;hash&quot;, hash, &quot;err&quot;, err)</span><br><span class=\"line\">            return</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // If import succeeded, broadcast the block</span><br><span class=\"line\">        propAnnounceOutTimer.UpdateSince(block.ReceivedAt)</span><br><span class=\"line\">        go f.broadcastBlock(block, false)</span><br><span class=\"line\"></span><br><span class=\"line\">        // Invoke the testing hook if needed</span><br><span class=\"line\">        if f.importedHook != nil &#123;</span><br><span class=\"line\">            f.importedHook(block)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>f.verifyHeader(block.Header())blockHeader<br><br>f.insertChain(types.Blocks{block}) <br>()blockhash</p>\n<p><br>fetcher.go </p>\n<h4 id=\"Downloader\"><a href=\"#Downloader\" class=\"headerlink\" title=\"Downloader\"></a>Downloader</h4><p>Downloader<br>ProtocolManagerDownloader</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func New(mode SyncMode, stateDb ethdb.Database, mux *event.TypeMux, chain BlockChain, lightchain LightChain, dropPeer peerDropFn) *Downloader &#123;</span><br><span class=\"line\">    if lightchain == nil &#123;</span><br><span class=\"line\">        lightchain = chain</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    dl := &amp;Downloader&#123;</span><br><span class=\"line\">        mode:           mode,</span><br><span class=\"line\">        stateDB:        stateDb,</span><br><span class=\"line\">        mux:            mux,</span><br><span class=\"line\">        queue:          newQueue(),</span><br><span class=\"line\">        peers:          newPeerSet(),</span><br><span class=\"line\">        rttEstimate:    uint64(rttMaxEstimate),</span><br><span class=\"line\">        rttConfidence:  uint64(1000000),</span><br><span class=\"line\">        blockchain:     chain,</span><br><span class=\"line\">        lightchain:     lightchain,</span><br><span class=\"line\">        dropPeer:       dropPeer,</span><br><span class=\"line\">        headerCh:       make(chan dataPack, 1),</span><br><span class=\"line\">        bodyCh:         make(chan dataPack, 1),</span><br><span class=\"line\">        receiptCh:      make(chan dataPack, 1),</span><br><span class=\"line\">        bodyWakeCh:     make(chan bool, 1),</span><br><span class=\"line\">        receiptWakeCh:  make(chan bool, 1),</span><br><span class=\"line\">        headerProcCh:   make(chan []*types.Header, 1),</span><br><span class=\"line\">        quitCh:         make(chan struct&#123;&#125;),</span><br><span class=\"line\">        stateCh:        make(chan dataPack),</span><br><span class=\"line\">        stateSyncStart: make(chan *stateSync),</span><br><span class=\"line\">        trackStateReq:  make(chan *stateReq),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    go dl.qosTuner()</span><br><span class=\"line\">    go dl.stateFetcher()</span><br><span class=\"line\">    return dl</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Downloaderdl.qosTuner() goroutinedl.stateFetcher() goroutine Downloader</p>\n<p>ProtocolManagerP2PProtocolManager synchronise(peer *peer)DownloaderSynchronise(peer.id, pHead, pTd, mode)</p>\n<p>Synchronised.queued.peersd.bodyWakeCh, d.receiptWakeChd.headerCh, d.bodyCh, d.receiptChd.headerProcChd.syncWithPeer(p, hash, td)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) syncWithPeer(p *peerConnection, hash common.Hash, td *big.Int) (err error) &#123;</span><br><span class=\"line\">    d.mux.Post(StartEvent&#123;&#125;)</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        // reset on error</span><br><span class=\"line\">        if err != nil &#123;</span><br><span class=\"line\">            d.mux.Post(FailedEvent&#123;err&#125;)</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            d.mux.Post(DoneEvent&#123;&#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    if p.version &lt; 62 &#123;</span><br><span class=\"line\">        return errTooOld</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    log.Debug(&quot;Synchronising with the network&quot;, &quot;peer&quot;, p.id, &quot;eth&quot;, p.version, &quot;head&quot;, hash, &quot;td&quot;, td, &quot;mode&quot;, d.mode)</span><br><span class=\"line\">    defer func(start time.Time) &#123;</span><br><span class=\"line\">        log.Debug(&quot;Synchronisation terminated&quot;, &quot;elapsed&quot;, time.Since(start))</span><br><span class=\"line\">    &#125;(time.Now())</span><br><span class=\"line\"></span><br><span class=\"line\">    // Look up the sync boundaries: the common ancestor and the target block</span><br><span class=\"line\">    latest, err := d.fetchHeight(p)</span><br><span class=\"line\">    if err != nil &#123;</span><br><span class=\"line\">        return err</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    height := latest.Number.Uint64()</span><br><span class=\"line\"></span><br><span class=\"line\">    origin, err := d.findAncestor(p, height)</span><br><span class=\"line\">    if err != nil &#123;</span><br><span class=\"line\">        return err</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    d.syncStatsLock.Lock()</span><br><span class=\"line\">    if d.syncStatsChainHeight &lt;= origin || d.syncStatsChainOrigin &gt; origin &#123;</span><br><span class=\"line\">        d.syncStatsChainOrigin = origin</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    d.syncStatsChainHeight = height</span><br><span class=\"line\">    d.syncStatsLock.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Ensure our origin point is below any fast sync pivot point</span><br><span class=\"line\">    pivot := uint64(0)</span><br><span class=\"line\">    if d.mode == FastSync &#123;</span><br><span class=\"line\">        if height &lt;= uint64(fsMinFullBlocks) &#123;</span><br><span class=\"line\">            origin = 0</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            pivot = height - uint64(fsMinFullBlocks)</span><br><span class=\"line\">            if pivot &lt;= origin &#123;</span><br><span class=\"line\">                origin = pivot - 1</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    d.committed = 1</span><br><span class=\"line\">    if d.mode == FastSync &amp;&amp; pivot != 0 &#123;</span><br><span class=\"line\">        d.committed = 0</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Initiate the sync using a concurrent header and content retrieval algorithm</span><br><span class=\"line\">    d.queue.Prepare(origin+1, d.mode)</span><br><span class=\"line\">    if d.syncInitHook != nil &#123;</span><br><span class=\"line\">        d.syncInitHook(origin, height)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    fetchers := []func() error&#123;</span><br><span class=\"line\">        func() error &#123; return d.fetchHeaders(p, origin+1, pivot) &#125;, // Headers are always retrieved</span><br><span class=\"line\">        func() error &#123; return d.fetchBodies(origin + 1) &#125;,          // Bodies are retrieved during normal and fast sync</span><br><span class=\"line\">        func() error &#123; return d.fetchReceipts(origin + 1) &#125;,        // Receipts are retrieved during fast sync</span><br><span class=\"line\">        func() error &#123; return d.processHeaders(origin+1, pivot, td) &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if d.mode == FastSync &#123;</span><br><span class=\"line\">        fetchers = append(fetchers, func() error &#123; return d.processFastSyncContent(latest) &#125;)</span><br><span class=\"line\">    &#125; else if d.mode == FullSync &#123;</span><br><span class=\"line\">        fetchers = append(fetchers, d.processFullSyncContent)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return d.spawnSync(fetchers)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>latest, err := d.fetchHeight(p)peer,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) fetchHeight(p *peerConnection) (*types.Header, error) &#123;</span><br><span class=\"line\">    p.log.Debug(&quot;Retrieving remote chain height&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Request the advertised remote head block and wait for the response</span><br><span class=\"line\">    head, _ := p.peer.Head()</span><br><span class=\"line\">    go p.peer.RequestHeadersByHash(head, 1, 0, false)</span><br><span class=\"line\"></span><br><span class=\"line\">    ttl := d.requestTTL()</span><br><span class=\"line\">    timeout := time.After(ttl)</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return nil, errCancelBlockFetch</span><br><span class=\"line\"></span><br><span class=\"line\">        case packet := &lt;-d.headerCh:</span><br><span class=\"line\">            // Discard anything not from the origin peer</span><br><span class=\"line\">            if packet.PeerId() != p.id &#123;</span><br><span class=\"line\">                log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Make sure the peer actually gave something valid</span><br><span class=\"line\">            headers := packet.(*headerPack).headers</span><br><span class=\"line\">            if len(headers) != 1 &#123;</span><br><span class=\"line\">                p.log.Debug(&quot;Multiple headers for single request&quot;, &quot;headers&quot;, len(headers))</span><br><span class=\"line\">                return nil, errBadPeer</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            head := headers[0]</span><br><span class=\"line\">            p.log.Debug(&quot;Remote head header identified&quot;, &quot;number&quot;, head.Number, &quot;hash&quot;, head.Hash())</span><br><span class=\"line\">            return head, nil</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-timeout:</span><br><span class=\"line\">            p.log.Debug(&quot;Waiting for head header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">            return nil, errTimeout</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-d.bodyCh:</span><br><span class=\"line\">        case &lt;-d.receiptCh:</span><br><span class=\"line\">            // Out of bounds delivery, ignore</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1peer.RequestHeadersByHash(head, 1, 0, false)GetBlockHeadersMsg<br>2d.headerChtimeout<br>3BlockHeadersMsg<br>4downloader.DeliverHeaders(p.id, headers)<br>5p.idheadersd.headerCh<br>6selectd.headerChheader</p>\n<p>syncWithPeer()  d.findAncestor(p, height)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) findAncestor(p *peerConnection, height uint64) (uint64, error) &#123;</span><br><span class=\"line\">    // Figure out the valid ancestor range to prevent rewrite attacks</span><br><span class=\"line\">    floor, ceil := int64(-1), d.lightchain.CurrentHeader().Number.Uint64()</span><br><span class=\"line\"></span><br><span class=\"line\">    if d.mode == FullSync &#123;</span><br><span class=\"line\">        ceil = d.blockchain.CurrentBlock().NumberU64()</span><br><span class=\"line\">    &#125; else if d.mode == FastSync &#123;</span><br><span class=\"line\">        ceil = d.blockchain.CurrentFastBlock().NumberU64()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if ceil &gt;= MaxForkAncestry &#123;</span><br><span class=\"line\">        floor = int64(ceil - MaxForkAncestry)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    p.log.Debug(&quot;Looking for common ancestor&quot;, &quot;local&quot;, ceil, &quot;remote&quot;, height)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Request the topmost blocks to short circuit binary ancestor lookup</span><br><span class=\"line\">    head := ceil</span><br><span class=\"line\">    if head &gt; height &#123;</span><br><span class=\"line\">        head = height</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    from := int64(head) - int64(MaxHeaderFetch)</span><br><span class=\"line\">    if from &lt; 0 &#123;</span><br><span class=\"line\">        from = 0</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Span out with 15 block gaps into the future to catch bad head reports</span><br><span class=\"line\">    limit := 2 * MaxHeaderFetch / 16</span><br><span class=\"line\">    count := 1 + int((int64(ceil)-from)/16)</span><br><span class=\"line\">    if count &gt; limit &#123;</span><br><span class=\"line\">        count = limit</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    go p.peer.RequestHeadersByNumber(uint64(from), count, 15, false)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Wait for the remote response to the head fetch</span><br><span class=\"line\">    number, hash := uint64(0), common.Hash&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ttl := d.requestTTL()</span><br><span class=\"line\">    timeout := time.After(ttl)</span><br><span class=\"line\"></span><br><span class=\"line\">    for finished := false; !finished; &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return 0, errCancelHeaderFetch</span><br><span class=\"line\"></span><br><span class=\"line\">        case packet := &lt;-d.headerCh:</span><br><span class=\"line\">            // Discard anything not from the origin peer</span><br><span class=\"line\">            if packet.PeerId() != p.id &#123;</span><br><span class=\"line\">                log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Make sure the peer actually gave something valid</span><br><span class=\"line\">            headers := packet.(*headerPack).headers</span><br><span class=\"line\">            if len(headers) == 0 &#123;</span><br><span class=\"line\">                p.log.Warn(&quot;Empty head header set&quot;)</span><br><span class=\"line\">                return 0, errEmptyHeaderSet</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Make sure the peer&apos;s reply conforms to the request</span><br><span class=\"line\">            for i := 0; i &lt; len(headers); i++ &#123;</span><br><span class=\"line\">                if number := headers[i].Number.Int64(); number != from+int64(i)*16 &#123;</span><br><span class=\"line\">                    p.log.Warn(&quot;Head headers broke chain ordering&quot;, &quot;index&quot;, i, &quot;requested&quot;, from+int64(i)*16, &quot;received&quot;, number)</span><br><span class=\"line\">                    return 0, errInvalidChain</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Check if a common ancestor was found</span><br><span class=\"line\">            finished = true</span><br><span class=\"line\">            for i := len(headers) - 1; i &gt;= 0; i-- &#123;</span><br><span class=\"line\">                // Skip any headers that underflow/overflow our requested set</span><br><span class=\"line\">                if headers[i].Number.Int64() &lt; from || headers[i].Number.Uint64() &gt; ceil &#123;</span><br><span class=\"line\">                    continue</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Otherwise check if we already know the header or not</span><br><span class=\"line\">                if (d.mode == FullSync &amp;&amp; d.blockchain.HasBlock(headers[i].Hash(), headers[i].Number.Uint64())) || (d.mode != FullSync &amp;&amp; d.lightchain.HasHeader(headers[i].Hash(), headers[i].Number.Uint64())) &#123;</span><br><span class=\"line\">                    number, hash = headers[i].Number.Uint64(), headers[i].Hash()</span><br><span class=\"line\"></span><br><span class=\"line\">                    // If every header is known, even future ones, the peer straight out lied about its head</span><br><span class=\"line\">                    if number &gt; height &amp;&amp; i == limit-1 &#123;</span><br><span class=\"line\">                        p.log.Warn(&quot;Lied about chain head&quot;, &quot;reported&quot;, height, &quot;found&quot;, number)</span><br><span class=\"line\">                        return 0, errStallingPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-timeout:</span><br><span class=\"line\">            p.log.Debug(&quot;Waiting for head header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">            return 0, errTimeout</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-d.bodyCh:</span><br><span class=\"line\">        case &lt;-d.receiptCh:</span><br><span class=\"line\">            // Out of bounds delivery, ignore</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // If the head fetch already found an ancestor, return</span><br><span class=\"line\">    if !common.EmptyHash(hash) &#123;</span><br><span class=\"line\">        if int64(number) &lt;= floor &#123;</span><br><span class=\"line\">            p.log.Warn(&quot;Ancestor below allowance&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash, &quot;allowance&quot;, floor)</span><br><span class=\"line\">            return 0, errInvalidAncestor</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        p.log.Debug(&quot;Found common ancestor&quot;, &quot;number&quot;, number, &quot;hash&quot;, hash)</span><br><span class=\"line\">        return number, nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Ancestor not found, we need to binary search over our chain</span><br><span class=\"line\">    start, end := uint64(0), head</span><br><span class=\"line\">    if floor &gt; 0 &#123;</span><br><span class=\"line\">        start = uint64(floor)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    for start+1 &lt; end &#123;</span><br><span class=\"line\">        // Split our chain interval in two, and request the hash to cross check</span><br><span class=\"line\">        check := (start + end) / 2</span><br><span class=\"line\"></span><br><span class=\"line\">        ttl := d.requestTTL()</span><br><span class=\"line\">        timeout := time.After(ttl)</span><br><span class=\"line\"></span><br><span class=\"line\">        go p.peer.RequestHeadersByNumber(check, 1, 0, false)</span><br><span class=\"line\"></span><br><span class=\"line\">        // Wait until a reply arrives to this request</span><br><span class=\"line\">        for arrived := false; !arrived; &#123;</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case &lt;-d.cancelCh:</span><br><span class=\"line\">                return 0, errCancelHeaderFetch</span><br><span class=\"line\"></span><br><span class=\"line\">            case packer := &lt;-d.headerCh:</span><br><span class=\"line\">                // Discard anything not from the origin peer</span><br><span class=\"line\">                if packer.PeerId() != p.id &#123;</span><br><span class=\"line\">                    log.Debug(&quot;Received headers from incorrect peer&quot;, &quot;peer&quot;, packer.PeerId())</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Make sure the peer actually gave something valid</span><br><span class=\"line\">                headers := packer.(*headerPack).headers</span><br><span class=\"line\">                if len(headers) != 1 &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;Multiple headers for single request&quot;, &quot;headers&quot;, len(headers))</span><br><span class=\"line\">                    return 0, errBadPeer</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                arrived = true</span><br><span class=\"line\"></span><br><span class=\"line\">                // Modify the search interval based on the response</span><br><span class=\"line\">                if (d.mode == FullSync &amp;&amp; !d.blockchain.HasBlock(headers[0].Hash(), headers[0].Number.Uint64())) || (d.mode != FullSync &amp;&amp; !d.lightchain.HasHeader(headers[0].Hash(), headers[0].Number.Uint64())) &#123;</span><br><span class=\"line\">                    end = check</span><br><span class=\"line\">                    break</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                header := d.lightchain.GetHeaderByHash(headers[0].Hash()) // Independent of sync mode, header surely exists</span><br><span class=\"line\">                if header.Number.Uint64() != check &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;Received non requested header&quot;, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash(), &quot;request&quot;, check)</span><br><span class=\"line\">                    return 0, errBadPeer</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                start = check</span><br><span class=\"line\"></span><br><span class=\"line\">            case &lt;-timeout:</span><br><span class=\"line\">                p.log.Debug(&quot;Waiting for search header timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">                return 0, errTimeout</span><br><span class=\"line\"></span><br><span class=\"line\">            case &lt;-d.bodyCh:</span><br><span class=\"line\">            case &lt;-d.receiptCh:</span><br><span class=\"line\">                // Out of bounds delivery, ignore</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Ensure valid ancestry and return</span><br><span class=\"line\">    if int64(start) &lt;= floor &#123;</span><br><span class=\"line\">        p.log.Warn(&quot;Ancestor below allowance&quot;, &quot;number&quot;, start, &quot;hash&quot;, hash, &quot;allowance&quot;, floor)</span><br><span class=\"line\">        return 0, errInvalidAncestor</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    p.log.Debug(&quot;Found common ancestor&quot;, &quot;number&quot;, start, &quot;hash&quot;, hash)</span><br><span class=\"line\">    return start, nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1peer.RequestHeadersByNumber(uint64(from), count, 15, false)header count 15header19216selectd.headerCh<br>2selectheadersheaderheadernumber<br>3MaxForkAncestryheader0.</p>\n<p>syncWithPeer()pivotd.spawnSync(fetchers)d.spawnSync(fetchers)</p>\n<p>Downloader<br>fetchHeaders()fetchBodies() , fetchReceipts()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) fetchHeaders(p *peerConnection, from uint64, pivot uint64) error &#123;</span><br><span class=\"line\">    p.log.Debug(&quot;Directing header downloads&quot;, &quot;origin&quot;, from)</span><br><span class=\"line\">    defer p.log.Debug(&quot;Header download terminated&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">    // Create a timeout timer, and the associated header fetcher</span><br><span class=\"line\">    skeleton := true            // Skeleton assembly phase or finishing up</span><br><span class=\"line\">    request := time.Now()       // time of the last skeleton fetch request</span><br><span class=\"line\">    timeout := time.NewTimer(0) // timer to dump a non-responsive active peer</span><br><span class=\"line\">    &lt;-timeout.C                 // timeout channel should be initially empty</span><br><span class=\"line\">    defer timeout.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">    var ttl time.Duration</span><br><span class=\"line\">    getHeaders := func(from uint64) &#123;</span><br><span class=\"line\">        request = time.Now()</span><br><span class=\"line\"></span><br><span class=\"line\">        ttl = d.requestTTL()</span><br><span class=\"line\">        timeout.Reset(ttl)</span><br><span class=\"line\"></span><br><span class=\"line\">        if skeleton &#123;</span><br><span class=\"line\">            p.log.Trace(&quot;Fetching skeleton headers&quot;, &quot;count&quot;, MaxHeaderFetch, &quot;from&quot;, from)</span><br><span class=\"line\">            go p.peer.RequestHeadersByNumber(from+uint64(MaxHeaderFetch)-1, MaxSkeletonSize, MaxHeaderFetch-1, false)</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            p.log.Trace(&quot;Fetching full headers&quot;, &quot;count&quot;, MaxHeaderFetch, &quot;from&quot;, from)</span><br><span class=\"line\">            go p.peer.RequestHeadersByNumber(from, MaxHeaderFetch, 0, false)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Start pulling the header chain skeleton until all is done</span><br><span class=\"line\">    getHeaders(from)</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return errCancelHeaderFetch</span><br><span class=\"line\"></span><br><span class=\"line\">        case packet := &lt;-d.headerCh:</span><br><span class=\"line\">            // Make sure the active peer is giving us the skeleton headers</span><br><span class=\"line\">            if packet.PeerId() != p.id &#123;</span><br><span class=\"line\">                log.Debug(&quot;Received skeleton from incorrect peer&quot;, &quot;peer&quot;, packet.PeerId())</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headerReqTimer.UpdateSince(request)</span><br><span class=\"line\">            timeout.Stop()</span><br><span class=\"line\"></span><br><span class=\"line\">            // If the skeleton&apos;s finished, pull any remaining head headers directly from the origin</span><br><span class=\"line\">            if packet.Items() == 0 &amp;&amp; skeleton &#123;</span><br><span class=\"line\">                skeleton = false</span><br><span class=\"line\">                getHeaders(from)</span><br><span class=\"line\">                continue</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If no more headers are inbound, notify the content fetchers and return</span><br><span class=\"line\">            if packet.Items() == 0 &#123;</span><br><span class=\"line\">                // Don&apos;t abort header fetches while the pivot is downloading</span><br><span class=\"line\">                if atomic.LoadInt32(&amp;d.committed) == 0 &amp;&amp; pivot &lt;= from &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;No headers, waiting for pivot commit&quot;)</span><br><span class=\"line\">                    select &#123;</span><br><span class=\"line\">                    case &lt;-time.After(fsHeaderContCheck):</span><br><span class=\"line\">                        getHeaders(from)</span><br><span class=\"line\">                        continue</span><br><span class=\"line\">                    case &lt;-d.cancelCh:</span><br><span class=\"line\">                        return errCancelHeaderFetch</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Pivot done (or not in fast sync) and no more headers, terminate the process</span><br><span class=\"line\">                p.log.Debug(&quot;No more headers available&quot;)</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case d.headerProcCh &lt;- nil:</span><br><span class=\"line\">                    return nil</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                    return errCancelHeaderFetch</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            headers := packet.(*headerPack).headers</span><br><span class=\"line\"></span><br><span class=\"line\">            // If we received a skeleton batch, resolve internals concurrently</span><br><span class=\"line\">            if skeleton &#123;</span><br><span class=\"line\">                filled, proced, err := d.fillHeaderSkeleton(from, headers)</span><br><span class=\"line\">                if err != nil &#123;</span><br><span class=\"line\">                    p.log.Debug(&quot;Skeleton chain invalid&quot;, &quot;err&quot;, err)</span><br><span class=\"line\">                    return errInvalidChain</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                headers = filled[proced:]</span><br><span class=\"line\">                from += uint64(proced)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Insert all the new headers and fetch the next batch</span><br><span class=\"line\">            if len(headers) &gt; 0 &#123;</span><br><span class=\"line\">                p.log.Trace(&quot;Scheduling new headers&quot;, &quot;count&quot;, len(headers), &quot;from&quot;, from)</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case d.headerProcCh &lt;- headers:</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                    return errCancelHeaderFetch</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                from += uint64(len(headers))</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            getHeaders(from)</span><br><span class=\"line\"></span><br><span class=\"line\">        case &lt;-timeout.C:</span><br><span class=\"line\">            if d.dropPeer == nil &#123;</span><br><span class=\"line\">                // The dropPeer method is nil when `--copydb` is used for a local copy.</span><br><span class=\"line\">                // Timeouts can occur if e.g. compaction hits at the wrong time, and can be ignored</span><br><span class=\"line\">                p.log.Warn(&quot;Downloader wants to drop peer, but peerdrop-function is not set&quot;, &quot;peer&quot;, p.id)</span><br><span class=\"line\">                break</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Header retrieval timed out, consider the peer bad and drop</span><br><span class=\"line\">            p.log.Debug(&quot;Header request timed out&quot;, &quot;elapsed&quot;, ttl)</span><br><span class=\"line\">            headerTimeoutMeter.Mark(1)</span><br><span class=\"line\">            d.dropPeer(p.id)</span><br><span class=\"line\"></span><br><span class=\"line\">            // Finish the sync gracefully instead of dumping the gathered data though</span><br><span class=\"line\">            for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case ch &lt;- false:</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case d.headerProcCh &lt;- nil:</span><br><span class=\"line\">            case &lt;-d.cancelCh:</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            return errBadPeer</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1getHeaders()peer.RequestHeadersByNumber() headers<br>2skeleton+192192128skeleton192<br>3<br>4skeletonfillHeaderSkeleton()skeleton header chain<br>5fromgetHeaders()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) fillHeaderSkeleton(from uint64, skeleton []*types.Header) ([]*types.Header, int, error) &#123;</span><br><span class=\"line\">    log.Debug(&quot;Filling up skeleton&quot;, &quot;from&quot;, from)</span><br><span class=\"line\">    d.queue.ScheduleSkeleton(from, skeleton)</span><br><span class=\"line\"></span><br><span class=\"line\">    var (</span><br><span class=\"line\">        deliver = func(packet dataPack) (int, error) &#123;</span><br><span class=\"line\">            pack := packet.(*headerPack)</span><br><span class=\"line\">            return d.queue.DeliverHeaders(pack.peerId, pack.headers, d.headerProcCh)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        expire   = func() map[string]int &#123; return d.queue.ExpireHeaders(d.requestTTL()) &#125;</span><br><span class=\"line\">        throttle = func() bool &#123; return false &#125;</span><br><span class=\"line\">        reserve  = func(p *peerConnection, count int) (*fetchRequest, bool, error) &#123;</span><br><span class=\"line\">            return d.queue.ReserveHeaders(p, count), false, nil</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        fetch    = func(p *peerConnection, req *fetchRequest) error &#123; return p.FetchHeaders(req.From, MaxHeaderFetch) &#125;</span><br><span class=\"line\">        capacity = func(p *peerConnection) int &#123; return p.HeaderCapacity(d.requestRTT()) &#125;</span><br><span class=\"line\">        setIdle  = func(p *peerConnection, accepted int) &#123; p.SetHeadersIdle(accepted) &#125;</span><br><span class=\"line\">    )</span><br><span class=\"line\">    err := d.fetchParts(errCancelHeaderFetch, d.headerCh, deliver, d.queue.headerContCh, expire,</span><br><span class=\"line\">        d.queue.PendingHeaders, d.queue.InFlightHeaders, throttle, reserve,</span><br><span class=\"line\">        nil, fetch, d.queue.CancelHeaders, capacity, d.peers.HeaderIdlePeers, setIdle, &quot;headers&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">    log.Debug(&quot;Skeleton fill terminated&quot;, &quot;err&quot;, err)</span><br><span class=\"line\"></span><br><span class=\"line\">    filled, proced := d.queue.RetrieveHeaders()</span><br><span class=\"line\">    return filled, proced, err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>a) skeletonheadersqueue.ScheduleSkeleton<br>b) d.fetchParts()<br>d.fetchParts()<br>1headersd.queue.DeliverHeaders()<br>2d.queue.PendingHeaderspendingheadersd.peers.HeaderIdlePeersidlepeers<br>3d.queue.ReserveHeaderspendingheadersidlepeers<br>4idlepeersp.FetchHeaders(req.From, MaxHeaderFetch)headers<br>c) d.queue.RetrieveHeaders()filledheaders</p>\n<p>d.fetchBodies() , d.fetchReceipts() fetchHeaders()</p>\n<p>Downloader<br>d.processHeaders(), d.processFastSyncContent(latest) , d.processFullSyncContent<br>1d.processHeaders() </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) processHeaders(origin uint64, pivot uint64, td *big.Int) error &#123;</span><br><span class=\"line\">    // Keep a count of uncertain headers to roll back</span><br><span class=\"line\">    rollback := []*types.Header&#123;&#125;</span><br><span class=\"line\">    defer func() &#123;</span><br><span class=\"line\">        if len(rollback) &gt; 0 &#123;</span><br><span class=\"line\">            // Flatten the headers and roll them back</span><br><span class=\"line\">            hashes := make([]common.Hash, len(rollback))</span><br><span class=\"line\">            for i, header := range rollback &#123;</span><br><span class=\"line\">                hashes[i] = header.Hash()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            lastHeader, lastFastBlock, lastBlock := d.lightchain.CurrentHeader().Number, common.Big0, common.Big0</span><br><span class=\"line\">            if d.mode != LightSync &#123;</span><br><span class=\"line\">                lastFastBlock = d.blockchain.CurrentFastBlock().Number()</span><br><span class=\"line\">                lastBlock = d.blockchain.CurrentBlock().Number()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            d.lightchain.Rollback(hashes)</span><br><span class=\"line\">            curFastBlock, curBlock := common.Big0, common.Big0</span><br><span class=\"line\">            if d.mode != LightSync &#123;</span><br><span class=\"line\">                curFastBlock = d.blockchain.CurrentFastBlock().Number()</span><br><span class=\"line\">                curBlock = d.blockchain.CurrentBlock().Number()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            log.Warn(&quot;Rolled back headers&quot;, &quot;count&quot;, len(hashes),</span><br><span class=\"line\">                &quot;header&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastHeader, d.lightchain.CurrentHeader().Number),</span><br><span class=\"line\">                &quot;fast&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastFastBlock, curFastBlock),</span><br><span class=\"line\">                &quot;block&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastBlock, curBlock))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    // Wait for batches of headers to process</span><br><span class=\"line\">    gotHeaders := false</span><br><span class=\"line\"></span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        select &#123;</span><br><span class=\"line\">        case &lt;-d.cancelCh:</span><br><span class=\"line\">            return errCancelHeaderProcessing</span><br><span class=\"line\"></span><br><span class=\"line\">        case headers := &lt;-d.headerProcCh:</span><br><span class=\"line\">            // Terminate header processing if we synced up</span><br><span class=\"line\">            if len(headers) == 0 &#123;</span><br><span class=\"line\">                // Notify everyone that headers are fully processed</span><br><span class=\"line\">                for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class=\"line\">                    select &#123;</span><br><span class=\"line\">                    case ch &lt;- false:</span><br><span class=\"line\">                    case &lt;-d.cancelCh:</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                if d.mode != LightSync &#123;</span><br><span class=\"line\">                    head := d.blockchain.CurrentBlock()</span><br><span class=\"line\">                    if !gotHeaders &amp;&amp; td.Cmp(d.blockchain.GetTd(head.Hash(), head.NumberU64())) &gt; 0 &#123;</span><br><span class=\"line\">                        return errStallingPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                if d.mode == FastSync || d.mode == LightSync &#123;</span><br><span class=\"line\">                    head := d.lightchain.CurrentHeader()</span><br><span class=\"line\">                    if td.Cmp(d.lightchain.GetTd(head.Hash(), head.Number.Uint64())) &gt; 0 &#123;</span><br><span class=\"line\">                        return errStallingPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Disable any rollback and return</span><br><span class=\"line\">                rollback = nil</span><br><span class=\"line\">                return nil</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Otherwise split the chunk of headers into batches and process them</span><br><span class=\"line\">            gotHeaders = true</span><br><span class=\"line\"></span><br><span class=\"line\">            for len(headers) &gt; 0 &#123;</span><br><span class=\"line\">                // Terminate if something failed in between processing chunks</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case &lt;-d.cancelCh:</span><br><span class=\"line\">                    return errCancelHeaderProcessing</span><br><span class=\"line\">                default:</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Select the next chunk of headers to import</span><br><span class=\"line\">                limit := maxHeadersProcess</span><br><span class=\"line\">                if limit &gt; len(headers) &#123;</span><br><span class=\"line\">                    limit = len(headers)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                chunk := headers[:limit]</span><br><span class=\"line\"></span><br><span class=\"line\">                // In case of header only syncing, validate the chunk immediately</span><br><span class=\"line\">                if d.mode == FastSync || d.mode == LightSync &#123;</span><br><span class=\"line\">                    // Collect the yet unknown headers to mark them as uncertain</span><br><span class=\"line\">                    unknown := make([]*types.Header, 0, len(headers))</span><br><span class=\"line\">                    for _, header := range chunk &#123;</span><br><span class=\"line\">                        if !d.lightchain.HasHeader(header.Hash(), header.Number.Uint64()) &#123;</span><br><span class=\"line\">                            unknown = append(unknown, header)</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // If we&apos;re importing pure headers, verify based on their recentness</span><br><span class=\"line\">                    frequency := fsHeaderCheckFrequency</span><br><span class=\"line\">                    if chunk[len(chunk)-1].Number.Uint64()+uint64(fsHeaderForceVerify) &gt; pivot &#123;</span><br><span class=\"line\">                        frequency = 1</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    if n, err := d.lightchain.InsertHeaderChain(chunk, frequency); err != nil &#123;</span><br><span class=\"line\">                        // If some headers were inserted, add them too to the rollback list</span><br><span class=\"line\">                        if n &gt; 0 &#123;</span><br><span class=\"line\">                            rollback = append(rollback, chunk[:n]...)</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        log.Debug(&quot;Invalid header encountered&quot;, &quot;number&quot;, chunk[n].Number, &quot;hash&quot;, chunk[n].Hash(), &quot;err&quot;, err)</span><br><span class=\"line\">                        return errInvalidChain</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // All verifications passed, store newly found uncertain headers</span><br><span class=\"line\">                    rollback = append(rollback, unknown...)</span><br><span class=\"line\">                    if len(rollback) &gt; fsHeaderSafetyNet &#123;</span><br><span class=\"line\">                        rollback = append(rollback[:0], rollback[len(rollback)-fsHeaderSafetyNet:]...)</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                // Unless we&apos;re doing light chains, schedule the headers for associated content retrieval</span><br><span class=\"line\">                if d.mode == FullSync || d.mode == FastSync &#123;</span><br><span class=\"line\">                    // If we&apos;ve reached the allowed number of pending headers, stall a bit</span><br><span class=\"line\">                    for d.queue.PendingBlocks() &gt;= maxQueuedHeaders || d.queue.PendingReceipts() &gt;= maxQueuedHeaders &#123;</span><br><span class=\"line\">                        select &#123;</span><br><span class=\"line\">                        case &lt;-d.cancelCh:</span><br><span class=\"line\">                            return errCancelHeaderProcessing</span><br><span class=\"line\">                        case &lt;-time.After(time.Second):</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    // Otherwise insert the headers for content retrieval</span><br><span class=\"line\">                    inserts := d.queue.Schedule(chunk, origin)</span><br><span class=\"line\">                    if len(inserts) != len(chunk) &#123;</span><br><span class=\"line\">                        log.Debug(&quot;Stale headers&quot;)</span><br><span class=\"line\">                        return errBadPeer</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                headers = headers[limit:]</span><br><span class=\"line\">                origin += uint64(limit)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Signal the content downloaders of the availablility of new tasks</span><br><span class=\"line\">            for _, ch := range []chan bool&#123;d.bodyWakeCh, d.receiptWakeCh&#125; &#123;</span><br><span class=\"line\">                select &#123;</span><br><span class=\"line\">                case ch &lt;- true:</span><br><span class=\"line\">                default:</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1fetchHeaders() d.headerProcChheaders<br>2FastSyncLightSynclightchain.InsertHeaderChain(chunk, frequency)headerChain<br>3FullSyncFastSynd.queue.Schedule(chunk, origin)downloader.queue</p>\n<p>2processFastSyncContent() </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) processFastSyncContent(latest *types.Header) error &#123;</span><br><span class=\"line\">    // Start syncing state of the reported head block. This should get us most of</span><br><span class=\"line\">    // the state of the pivot block.</span><br><span class=\"line\">    stateSync := d.syncState(latest.Root)</span><br><span class=\"line\">    defer stateSync.Cancel()</span><br><span class=\"line\">    go func() &#123;</span><br><span class=\"line\">        if err := stateSync.Wait(); err != nil &amp;&amp; err != errCancelStateFetch &#123;</span><br><span class=\"line\">            d.queue.Close() // wake up WaitResults</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;()</span><br><span class=\"line\">    // Figure out the ideal pivot block. Note, that this goalpost may move if the</span><br><span class=\"line\">    // sync takes long enough for the chain head to move significantly.</span><br><span class=\"line\">    pivot := uint64(0)</span><br><span class=\"line\">    if height := latest.Number.Uint64(); height &gt; uint64(fsMinFullBlocks) &#123;</span><br><span class=\"line\">        pivot = height - uint64(fsMinFullBlocks)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // To cater for moving pivot points, track the pivot block and subsequently</span><br><span class=\"line\">    // accumulated download results separatey.</span><br><span class=\"line\">    var (</span><br><span class=\"line\">        oldPivot *fetchResult   // Locked in pivot block, might change eventually</span><br><span class=\"line\">        oldTail  []*fetchResult // Downloaded content after the pivot</span><br><span class=\"line\">    )</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        // Wait for the next batch of downloaded data to be available, and if the pivot</span><br><span class=\"line\">        // block became stale, move the goalpost</span><br><span class=\"line\">        results := d.queue.Results(oldPivot == nil) // Block if we&apos;re not monitoring pivot staleness</span><br><span class=\"line\">        if len(results) == 0 &#123;</span><br><span class=\"line\">            // If pivot sync is done, stop</span><br><span class=\"line\">            if oldPivot == nil &#123;</span><br><span class=\"line\">                return stateSync.Cancel()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // If sync failed, stop</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case &lt;-d.cancelCh:</span><br><span class=\"line\">                return stateSync.Cancel()</span><br><span class=\"line\">            default:</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if d.chainInsertHook != nil &#123;</span><br><span class=\"line\">            d.chainInsertHook(results)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if oldPivot != nil &#123;</span><br><span class=\"line\">            results = append(append([]*fetchResult&#123;oldPivot&#125;, oldTail...), results...)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Split around the pivot block and process the two sides via fast/full sync</span><br><span class=\"line\">        if atomic.LoadInt32(&amp;d.committed) == 0 &#123;</span><br><span class=\"line\">            latest = results[len(results)-1].Header</span><br><span class=\"line\">            if height := latest.Number.Uint64(); height &gt; pivot+2*uint64(fsMinFullBlocks) &#123;</span><br><span class=\"line\">                log.Warn(&quot;Pivot became stale, moving&quot;, &quot;old&quot;, pivot, &quot;new&quot;, height-uint64(fsMinFullBlocks))</span><br><span class=\"line\">                pivot = height - uint64(fsMinFullBlocks)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        P, beforeP, afterP := splitAroundPivot(pivot, results)</span><br><span class=\"line\">        if err := d.commitFastSyncData(beforeP, stateSync); err != nil &#123;</span><br><span class=\"line\">            return err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if P != nil &#123;</span><br><span class=\"line\">            // If new pivot block found, cancel old state retrieval and restart</span><br><span class=\"line\">            if oldPivot != P &#123;</span><br><span class=\"line\">                stateSync.Cancel()</span><br><span class=\"line\"></span><br><span class=\"line\">                stateSync = d.syncState(P.Header.Root)</span><br><span class=\"line\">                defer stateSync.Cancel()</span><br><span class=\"line\">                go func() &#123;</span><br><span class=\"line\">                    if err := stateSync.Wait(); err != nil &amp;&amp; err != errCancelStateFetch &#123;</span><br><span class=\"line\">                        d.queue.Close() // wake up WaitResults</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;()</span><br><span class=\"line\">                oldPivot = P</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            // Wait for completion, occasionally checking for pivot staleness</span><br><span class=\"line\">            select &#123;</span><br><span class=\"line\">            case &lt;-stateSync.done:</span><br><span class=\"line\">                if stateSync.err != nil &#123;</span><br><span class=\"line\">                    return stateSync.err</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                if err := d.commitPivotBlock(P); err != nil &#123;</span><br><span class=\"line\">                    return err</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                oldPivot = nil</span><br><span class=\"line\"></span><br><span class=\"line\">            case &lt;-time.After(time.Second):</span><br><span class=\"line\">                oldTail = afterP</span><br><span class=\"line\">                continue</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // Fast sync done, pivot commit done, full import</span><br><span class=\"line\">        if err := d.importBlockResults(afterP); err != nil &#123;</span><br><span class=\"line\">            return err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>1pivot<br>2d.queue resultresult<br>3resultspivot<br>4pivotresultspivotresultpivotresultspivotresults<br>5commitFastSyncDatapivotresults <br>6pivotresult commitPivotBlockFastSyncCommitHeadpivothash<br>7d.importBlockResultspivotresults</p>\n<p>3processFullSyncContent()</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (d *Downloader) processFullSyncContent() error &#123;</span><br><span class=\"line\">    for &#123;</span><br><span class=\"line\">        results := d.queue.Results(true)</span><br><span class=\"line\">        if len(results) == 0 &#123;</span><br><span class=\"line\">            return nil</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if d.chainInsertHook != nil &#123;</span><br><span class=\"line\">            d.chainInsertHook(results)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        if err := d.importBlockResults(results); err != nil &#123;</span><br><span class=\"line\">            return err</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (d *Downloader) importBlockResults(results []*fetchResult) error &#123;</span><br><span class=\"line\">    // Check for any early termination requests</span><br><span class=\"line\">    if len(results) == 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    select &#123;</span><br><span class=\"line\">    case &lt;-d.quitCh:</span><br><span class=\"line\">        return errCancelContentProcessing</span><br><span class=\"line\">    default:</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // Retrieve the a batch of results to import</span><br><span class=\"line\">    first, last := results[0].Header, results[len(results)-1].Header</span><br><span class=\"line\">    log.Debug(&quot;Inserting downloaded chain&quot;, &quot;items&quot;, len(results),</span><br><span class=\"line\">        &quot;firstnum&quot;, first.Number, &quot;firsthash&quot;, first.Hash(),</span><br><span class=\"line\">        &quot;lastnum&quot;, last.Number, &quot;lasthash&quot;, last.Hash(),</span><br><span class=\"line\">    )</span><br><span class=\"line\">    blocks := make([]*types.Block, len(results))</span><br><span class=\"line\">    for i, result := range results &#123;</span><br><span class=\"line\">        blocks[i] = types.NewBlockWithHeader(result.Header).WithBody(result.Transactions, result.Uncles)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if index, err := d.blockchain.InsertChain(blocks); err != nil &#123;</span><br><span class=\"line\">        log.Debug(&quot;Downloaded item processing failed&quot;, &quot;number&quot;, results[index].Header.Number, &quot;hash&quot;, results[index].Header.Hash(), &quot;err&quot;, err)</span><br><span class=\"line\">        return errInvalidChain</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>processFullSyncContentresults</p>\n<p><br>Downloaderlightlightfastfullpivotfastfastfast<a href=\"https://github.com/ethereum/go-ethereum/pull/1889\"></a></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ck3fm69s20001t6xv2z74fwdn","category_id":"ck3fm69sg0004t6xv1be7s3d4","_id":"ck3fm69t6000ct6xvtmvlpb3x"},{"post_id":"ck3fm69sa0003t6xv6cp9rp4p","category_id":"ck3fm69sw0009t6xvkndkd51t","_id":"ck3fm69tc000ht6xvwdh0l4o5"},{"post_id":"ck3fm69so0006t6xvnm6lw2hr","category_id":"ck3fm69sw0009t6xvkndkd51t","_id":"ck3fm69tg000kt6xveoc0u80x"},{"post_id":"ck3fm69ss0007t6xvswwfzn4s","category_id":"ck3fm69tc000gt6xv4i87p24p","_id":"ck3fm69tk000ot6xvbdpgnw1t"},{"post_id":"ck3fm69ti000mt6xv2flevczd","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69tp000st6xvfhridrjy"},{"post_id":"ck3fm69su0008t6xvxv3i6uc9","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69tx000ut6xvc27ox9tp"},{"post_id":"ck3fm69tm000qt6xvso7pmbeq","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69u1000xt6xv0m9b3f2s"},{"post_id":"ck3fm69to000rt6xvlnk8foeu","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69u4000zt6xvdqw16od2"},{"post_id":"ck3fm69sy000at6xvf53jnzum","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69u70012t6xvow94io6s"},{"post_id":"ck3fm69t3000bt6xv9zo3a3ma","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69u90015t6xv4ymtnw6x"},{"post_id":"ck3fm69t8000et6xvr1hw6pbw","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69ui0019t6xvjkvnowk3"},{"post_id":"ck3fm69ua0016t6xvqq43x12d","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69un001ct6xvqgp37ypg"},{"post_id":"ck3fm69ta000ft6xvjpqm06lj","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69ur001ft6xvry2ofijg"},{"post_id":"ck3fm69uf0017t6xvmp2qho78","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69us001gt6xvbd4kptu2"},{"post_id":"ck3fm69uk001at6xvky7tryyj","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69uu001it6xv7sdgfixc"},{"post_id":"ck3fm69td000it6xvndl9kj9z","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69uu001jt6xvqarsltbw"},{"post_id":"ck3fm69um001bt6xveobfk3fd","category_id":"ck3fm69tc000gt6xv4i87p24p","_id":"ck3fm69uv001lt6xvvlk25di3"},{"post_id":"ck3fm69tf000jt6xv8e6xhjer","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69uw001mt6xvc7xt4oql"},{"post_id":"ck3fm69tj000nt6xvp9nabogf","category_id":"ck3fm69ut001ht6xvwn2qjqlv","_id":"ck3fm69ux001ot6xv9blhs8dk"},{"post_id":"ck3fm69tt000tt6xvauuq95uf","category_id":"ck3fm69uv001kt6xvvpu3me62","_id":"ck3fm69uz001qt6xv669s93qj"},{"post_id":"ck3fm69tz000wt6xvsu6r1yui","category_id":"ck3fm69uv001kt6xvvpu3me62","_id":"ck3fm69v1001st6xvyajxxuqv"},{"post_id":"ck3fm69u3000yt6xvl3p0o8tn","category_id":"ck3fm69uv001kt6xvvpu3me62","_id":"ck3fm69v2001tt6xvs8cbn86r"},{"post_id":"ck3fm69u50011t6xvixx4owv1","category_id":"ck3fm69v1001rt6xvnah1dc9l","_id":"ck3fm69v4001vt6xvondsbd96"},{"post_id":"ck3fm69u70013t6xv76lf3sqm","category_id":"ck3fm69v3001ut6xvf3tlgbyy","_id":"ck3fm69v6001xt6xvdo81ytxz"},{"post_id":"ck3fm69up001et6xvze4lg28j","category_id":"ck3fm69v4001wt6xvaua0bvbr","_id":"ck3fm69v6001yt6xvnsmkg6ke"},{"post_id":"ck3fm69wr001zt6xv3i73t48z","category_id":"ck3fm69tc000gt6xv4i87p24p","_id":"ck3fm69wy0023t6xvmuu3hmoz"},{"post_id":"ck3fm69ws0020t6xvh0q0kffa","category_id":"ck3fm69sg0004t6xv1be7s3d4","_id":"ck3fm69wz0025t6xvlbz9d1as"},{"post_id":"ck3fm69wu0021t6xv33u3pm35","category_id":"ck3fm69sg0004t6xv1be7s3d4","_id":"ck3fm69x10027t6xvaxqwsxjr"},{"post_id":"ck3fm69ww0022t6xvema0rqo6","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69x30029t6xvvc1a2xqm"},{"post_id":"ck3fm69wy0024t6xv77mus96g","category_id":"ck3fm69ut001ht6xvwn2qjqlv","_id":"ck3fm69x4002bt6xvpt3qjzkh"},{"post_id":"ck3fm69x00026t6xvys3yxl6f","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69x6002dt6xvhtcmeflj"},{"post_id":"ck3fm69x20028t6xvp0zgpc2l","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69x8002ft6xv5dhcgrc8"},{"post_id":"ck3fm69x3002at6xviyz6j1kt","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69x9002ht6xvzb5n5hcg"},{"post_id":"ck3fm69x5002ct6xve80e8m2u","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69xa002it6xvz2dul3u0"},{"post_id":"ck3fm69x7002et6xv66rijl73","category_id":"ck3fm69uv001kt6xvvpu3me62","_id":"ck3fm69xb002kt6xvzpxinz69"},{"post_id":"ck3fm69x8002gt6xvkj9hogtu","category_id":"ck3fm69xa002jt6xvgdhxo4vu","_id":"ck3fm69xc002lt6xvmyqnk08k"},{"post_id":"ck3fm69xm002mt6xvlj9v35rq","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69xo002ot6xvxrsurvyz"},{"post_id":"ck3fm69xn002nt6xv9knrcw58","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69xo002pt6xv0r1w7yy6"},{"post_id":"ck3fm69xv002qt6xvqekde64h","category_id":"ck3fm69uv001kt6xvvpu3me62","_id":"ck3fm69y0002tt6xvg0upyhdv"},{"post_id":"ck3fm69xw002rt6xvusmkhjt4","category_id":"ck3fm69tl000pt6xvbnuymqxi","_id":"ck3fm69y0002ut6xv9zl8hhkt"},{"post_id":"ck3fm69xy002st6xvbwt6358n","category_id":"ck3fm69xa002jt6xvgdhxo4vu","_id":"ck3fm69y1002vt6xvzwhz82b9"},{"post_id":"ck3fm69ys002wt6xvyonfly1j","category_id":"ck3fm69tg000lt6xvu8visr1f","_id":"ck3fm69yu002xt6xvb6idi7z4"}],"PostTag":[],"Tag":[]}}